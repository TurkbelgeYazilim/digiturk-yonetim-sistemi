{
    "sourceFile": "views/Yonetim/VoIP/voip_operator_harcama.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1761061517922,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1761061660038,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-﻿<?php\r\n+<?php\r\n // Auth kontrolü\r\n require_once '../../../auth.php';\r\n $currentUser = checkAuth();\r\n checkUserStatus();\r\n"
                }
            ],
            "date": 1761061517922,
            "name": "Commit-0",
            "content": "<?php\r\n// Auth kontrolü\r\nrequire_once '../../../auth.php';\r\n$currentUser = checkAuth();\r\ncheckUserStatus();\r\nupdateLastActivity();\r\n\r\n// Sayfa yetkilendirme kontrolü\r\n$sayfaYetkileri = [\r\n    'gor' => false,\r\n    'kendi_kullanicini_gor' => false,\r\n    'ekle' => false,\r\n    'duzenle' => false,\r\n    'sil' => false\r\n];\r\n\r\n// Admin kontrolü (group_id = 1 ise tüm yetkilere sahip)\r\n$isAdmin = ($currentUser['group_id'] == 1);\r\n\r\nif ($isAdmin) {\r\n    $sayfaYetkileri = [\r\n        'gor' => 1,\r\n        'kendi_kullanicini_gor' => 0,\r\n        'ekle' => 1,\r\n        'duzenle' => 1,\r\n        'sil' => 1\r\n    ];\r\n} else {\r\n    try {\r\n        $conn = getDatabaseConnection();\r\n        $currentPageUrl = basename($_SERVER['PHP_SELF']);\r\n        \r\n        $yetkiSql = \"\r\n            SELECT tsy.gor, tsy.kendi_kullanicini_gor, tsy.ekle, tsy.duzenle, tsy.sil\r\n            FROM dbo.tanim_sayfalar ts\r\n            INNER JOIN dbo.tanim_sayfa_yetkiler tsy ON ts.sayfa_id = tsy.sayfa_id\r\n            WHERE ts.sayfa_url = ? AND tsy.user_group_id = ? AND ts.durum = 1 AND tsy.durum = 1\r\n        \";\r\n        \r\n        $yetkiStmt = $conn->prepare($yetkiSql);\r\n        $yetkiStmt->execute([$currentPageUrl, $currentUser['group_id']]);\r\n        $yetkiResult = $yetkiStmt->fetch(PDO::FETCH_ASSOC);\r\n        \r\n        if ($yetkiResult) {\r\n            $sayfaYetkileri = [\r\n                'gor' => (int)$yetkiResult['gor'],\r\n                'kendi_kullanicini_gor' => (int)$yetkiResult['kendi_kullanicini_gor'],\r\n                'ekle' => (int)$yetkiResult['ekle'],\r\n                'duzenle' => (int)$yetkiResult['duzenle'],\r\n                'sil' => (int)$yetkiResult['sil']\r\n            ];\r\n            \r\n            if ($sayfaYetkileri['gor'] == 0) {\r\n                header('Location: ../../../index.php?error=yetki_yok');\r\n                exit;\r\n            }\r\n        } else {\r\n            header('Location: ../../../index.php?error=yetki_tanimlanmamis');\r\n            exit;\r\n        }\r\n    } catch (Exception $e) {\r\n        error_log(\"Yetki kontrol hatası: \" . $e->getMessage());\r\n        header('Location: ../../../index.php?error=sistem_hatasi');\r\n        exit;\r\n    }\r\n}\r\n\r\n$pageTitle = \"VoIP Numara Harcamalar\";\r\n$breadcrumbs = [\r\n    ['title' => 'Yönetim', 'url' => '../../../index.php'],\r\n    ['title' => 'VoIP', 'url' => '#'],\r\n    ['title' => 'VoIP Numara Harcamalar']\r\n];\r\n\r\n$message = '';\r\n$messageType = '';\r\n\r\n// VoIP Harcama işlemleri\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    try {\r\n        $conn = getDatabaseConnection();\r\n        \r\n        $action = $_POST['action'] ?? '';\r\n        \r\n        switch ($action) {\r\n            case 'upload_excel':\r\n                if ($sayfaYetkileri['ekle'] != 1) {\r\n                    throw new Exception('Excel yükleme yetkiniz bulunmamaktadır.');\r\n                }\r\n                if (!isset($_FILES['excel_file']) || $_FILES['excel_file']['error'] !== UPLOAD_ERR_OK) {\r\n                    throw new Exception('Excel dosyası yükleme hatası.');\r\n                }\r\n                \r\n                $excelTarih = $_POST['excel_tarih'];\r\n                $skipFirstRow = isset($_POST['skip_first_row']);\r\n                \r\n                // Dosya uzantısını kontrol et\r\n                $fileName = $_FILES['excel_file']['name'];\r\n                $fileExtension = strtolower(pathinfo($fileName, PATHINFO_EXTENSION));\r\n                if (!in_array($fileExtension, ['xlsx', 'xls'])) {\r\n                    throw new Exception('Sadece .xlsx ve .xls dosyaları kabul edilir.');\r\n                }\r\n                \r\n                // Dosyayı geçici klasöre taşı\r\n                $uploadDir = 'uploads/';\r\n                if (!is_dir($uploadDir)) {\r\n                    mkdir($uploadDir, 0777, true);\r\n                }\r\n                \r\n                $uploadFile = $uploadDir . 'temp_excel_' . time() . '.' . $fileExtension;\r\n                if (!move_uploaded_file($_FILES['excel_file']['tmp_name'], $uploadFile)) {\r\n                    throw new Exception('Dosya yükleme hatası.');\r\n                }\r\n                \r\n                try {\r\n                    // SimpleXLSX kütüphanesini kullan (PhpSpreadsheet alternatifi)\r\n                    require_once 'includes/SimpleXLSX.php';\r\n                    \r\n                    if ($xlsx = SimpleXLSX::parse($uploadFile)) {\r\n                        $rows = $xlsx->rows();\r\n                        $processedCount = 0;\r\n                        $errorCount = 0;\r\n                        $errors = [];\r\n                        \r\n                        // Sütun başlıklarını kontrol et (eğer ilk satır başlık ise)\r\n                        $costColumnIndex = 5; // Varsayılan Cost sütunu (6. sütun)\r\n                        $chargedAmountColumnIndex = 4; // Charged Amount sütunu (5. sütun)\r\n                        \r\n                        if ($skipFirstRow && count($rows) > 0) {\r\n                            $headerRow = $rows[0];\r\n                            // Cost sütununu ara\r\n                            $costFound = false;\r\n                            for ($col = 0; $col < count($headerRow); $col++) {\r\n                                $header = strtolower(trim($headerRow[$col] ?? ''));\r\n                                if (strpos($header, 'cost') !== false) {\r\n                                    $costColumnIndex = $col;\r\n                                    $costFound = true;\r\n                                    break;\r\n                                }\r\n                            }\r\n                            \r\n                            // Cost bulunamadıysa Charged Amount'u ara\r\n                            if (!$costFound) {\r\n                                for ($col = 0; $col < count($headerRow); $col++) {\r\n                                    $header = strtolower(trim($headerRow[$col] ?? ''));\r\n                                    if (strpos($header, 'charged amount') !== false || strpos($header, 'charged') !== false) {\r\n                                        $costColumnIndex = $col;\r\n                                        break;\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                        \r\n                        // VoIP numaralarını önce al (hızlı arama için)\r\n                        $voipNumMap = [];\r\n                        $voipSql = \"SELECT voip_operator_numara_id, voip_operator_numara_VoIPNo FROM voip_operator_numara\";\r\n                        $voipStmt = $conn->prepare($voipSql);\r\n                        $voipStmt->execute();\r\n                        while ($row = $voipStmt->fetch(PDO::FETCH_ASSOC)) {\r\n                            $voipNumMap[trim($row['voip_operator_numara_VoIPNo'])] = $row['voip_operator_numara_id'];\r\n                        }\r\n                        \r\n                        $startRow = $skipFirstRow ? 1 : 0;\r\n                        \r\n                        for ($i = $startRow; $i < count($rows); $i++) {\r\n                            $row = $rows[$i];\r\n                            \r\n                            if (count($row) < 6) {\r\n                                $errors[] = \"Satır \" . ($i + 1) . \": Eksik sütun\";\r\n                                $errorCount++;\r\n                                continue;\r\n                            }\r\n                            \r\n                            $customerName = trim($row[0] ?? ''); // Customer Name\r\n                            $numberOfCalls = !empty($row[1]) ? (int)$row[1] : null; // Number of Calls\r\n                            $duration = trim($row[2] ?? ''); // Duration, min\r\n                            $cost = !empty($row[$costColumnIndex]) ? (float)$row[$costColumnIndex] : 0; // Cost veya Charged Amount\r\n                            \r\n                            // Customer Name'den \"Acct. \" kısmını temizle\r\n                            $cleanCustomerName = $customerName;\r\n                            if (strpos($customerName, 'Acct. ') === 0) {\r\n                                $cleanCustomerName = trim(substr($customerName, 6)); // \"Acct. \" kısmını çıkar\r\n                            }\r\n                            \r\n                            // VoIP numara ID'sini bul (temizlenmiş isimle)\r\n                            $voipNumaraId = null;\r\n                            if (isset($voipNumMap[$cleanCustomerName])) {\r\n                                $voipNumaraId = $voipNumMap[$cleanCustomerName];\r\n                            } elseif (isset($voipNumMap[$customerName])) {\r\n                                // Orijinal isimle de dene\r\n                                $voipNumaraId = $voipNumMap[$customerName];\r\n                            }\r\n                            \r\n                            if (!$voipNumaraId) {\r\n                                $errors[] = \"Satır \" . ($i + 1) . \": VoIP numara bulunamadı: '$customerName' (aranan: '$cleanCustomerName')\";\r\n                                $errorCount++;\r\n                                continue;\r\n                            }\r\n                            \r\n                            // Duration formatını kontrol et ve dönüştür\r\n                            $durationStr = null;\r\n                            if ($duration) {\r\n                                // Eğer sayısal ise dakika cinsinden, hh:mm formatına çevir\r\n                                if (is_numeric($duration)) {\r\n                                    $minutes = (int)$duration;\r\n                                    $hours = floor($minutes / 60);\r\n                                    $mins = $minutes % 60;\r\n                                    $durationStr = sprintf('%02d:%02d', $hours, $mins);\r\n                                } else {\r\n                                    $durationStr = $duration;\r\n                                }\r\n                            }\r\n                            \r\n                            // Tarihi formatla\r\n                            $formattedDate = $excelTarih . ' 00:00:00';\r\n                            \r\n                            // Aynı numara ve aynı tarihteki mevcut kaydı kontrol et\r\n                            $checkSql = \"SELECT voip_operator_Harcama_id FROM voip_operator_Harcama \r\n                                         WHERE voip_operator_numara_id = ? \r\n                                         AND CAST(voip_operator_Harcama_Tarih AS DATE) = CAST(? AS DATE)\";\r\n                            $checkStmt = $conn->prepare($checkSql);\r\n                            $checkStmt->execute([$voipNumaraId, $formattedDate]);\r\n                            $existingRecord = $checkStmt->fetch(PDO::FETCH_ASSOC);\r\n                            \r\n                            if ($existingRecord) {\r\n                                // Mevcut kayıt varsa güncelle\r\n                                $updateSql = \"UPDATE voip_operator_Harcama SET \r\n                                              voip_operator_Harcama_CagriSayisi = ?, \r\n                                              voip_operator_Harcama_Sure = ?, \r\n                                              voip_operator_Harcama_Ucret = ? \r\n                                              WHERE voip_operator_Harcama_id = ?\";\r\n                                $updateStmt = $conn->prepare($updateSql);\r\n                                \r\n                                if ($updateStmt->execute([$numberOfCalls, $durationStr, $cost, $existingRecord['voip_operator_Harcama_id']])) {\r\n                                    $processedCount++;\r\n                                } else {\r\n                                    $errors[] = \"Satır \" . ($i + 1) . \": Güncelleme hatası\";\r\n                                    $errorCount++;\r\n                                }\r\n                            } else {\r\n                                // Yeni kayıt ekle\r\n                                $insertSql = \"INSERT INTO voip_operator_Harcama \r\n                                              (voip_operator_numara_id, voip_operator_Harcama_CagriSayisi, voip_operator_Harcama_Sure, \r\n                                               voip_operator_Harcama_Tarih, voip_operator_Harcama_Ucret) \r\n                                              VALUES (?, ?, ?, ?, ?)\";\r\n                                $insertStmt = $conn->prepare($insertSql);\r\n                                \r\n                                if ($insertStmt->execute([$voipNumaraId, $numberOfCalls, $durationStr, $formattedDate, $cost])) {\r\n                                    $processedCount++;\r\n                                } else {\r\n                                    $errors[] = \"Satır \" . ($i + 1) . \": Veritabanı hatası\";\r\n                                    $errorCount++;\r\n                                }\r\n                            }\r\n                        }\r\n                        \r\n                        // Geçici dosyayı sil\r\n                        unlink($uploadFile);\r\n                        \r\n                        // İstatistikler için ayrı sayaçlar ekle\r\n                        $addedCount = 0;\r\n                        $updatedCount = 0;\r\n                        \r\n                        // Performans için kayıt türlerini takip etmek yerine genel işlem sayısını kullanıyoruz\r\n                        if ($processedCount > 0) {\r\n                            $message = \"Excel dosyası başarıyla yüklendi. $processedCount kayıt işlendi (eklendi/güncellendi).\";\r\n                            if ($errorCount > 0) {\r\n                                $message .= \" $errorCount kayıtta hata oluştu.\";\r\n                            }\r\n                            $messageType = 'success';\r\n                        } else {\r\n                            $message = 'Hiçbir kayıt işlenemedi. Lütfen dosya formatını kontrol edin.';\r\n                            $messageType = 'warning';\r\n                        }\r\n                        \r\n                        if (!empty($errors)) {\r\n                            $message .= '<br><small>Hatalar: ' . implode(', ', array_slice($errors, 0, 5)) . '</small>';\r\n                        }\r\n                        \r\n                    } else {\r\n                        unlink($uploadFile);\r\n                        throw new Exception('Excel dosyası okunamadı: ' . SimpleXLSX::parseError());\r\n                    }\r\n                    \r\n                } catch (Exception $e) {\r\n                    if (file_exists($uploadFile)) {\r\n                        unlink($uploadFile);\r\n                    }\r\n                    throw new Exception('Excel işleme hatası: ' . $e->getMessage());\r\n                }\r\n                break;\r\n                \r\n            case 'add':\r\n                if ($sayfaYetkileri['ekle'] != 1) {\r\n                    throw new Exception('Ekleme yetkiniz bulunmamaktadır.');\r\n                }\r\n                \r\n                $voipOperatorNumaraId = (int)$_POST['voip_operator_numara_id'];\r\n                $cagriSayisi = $_POST['voip_operator_Harcama_CagriSayisi'] ? (int)$_POST['voip_operator_Harcama_CagriSayisi'] : null;\r\n                $sure = trim($_POST['voip_operator_Harcama_Sure']) ?: null;\r\n                $tarih = $_POST['voip_operator_Harcama_Tarih'];\r\n                \r\n                // Tarih formatını MSSQL için dönüştür\r\n                if ($tarih) {\r\n                    $dateTime = new DateTime($tarih);\r\n                    $tarih = $dateTime->format('Y-m-d H:i:s');\r\n                }\r\n                \r\n                $ucret = (float)$_POST['voip_operator_Harcama_Ucret'];\r\n                \r\n                // Aynı numara ve aynı tarihteki mevcut kaydı kontrol et\r\n                $checkSql = \"SELECT voip_operator_Harcama_id FROM voip_operator_Harcama \r\n                             WHERE voip_operator_numara_id = ? \r\n                             AND CAST(voip_operator_Harcama_Tarih AS DATE) = CAST(? AS DATE)\";\r\n                $checkStmt = $conn->prepare($checkSql);\r\n                $checkStmt->execute([$voipOperatorNumaraId, $tarih]);\r\n                $existingRecord = $checkStmt->fetch(PDO::FETCH_ASSOC);\r\n                \r\n                if ($existingRecord) {\r\n                    // Mevcut kayıt varsa güncelle\r\n                    $sql = \"UPDATE voip_operator_Harcama SET \r\n                            voip_operator_Harcama_CagriSayisi = ?, voip_operator_Harcama_Sure = ?, \r\n                            voip_operator_Harcama_Tarih = ?, voip_operator_Harcama_Ucret = ? \r\n                            WHERE voip_operator_Harcama_id = ?\";\r\n                    $stmt = $conn->prepare($sql);\r\n                    $stmt->execute([$cagriSayisi, $sure, $tarih, $ucret, $existingRecord['voip_operator_Harcama_id']]);\r\n                    $message = 'Aynı tarihte kayıt bulundu, mevcut kayıt güncellendi.';\r\n                } else {\r\n                    // Yeni kayıt ekle\r\n                    $sql = \"INSERT INTO voip_operator_Harcama \r\n                            (voip_operator_numara_id, voip_operator_Harcama_CagriSayisi, voip_operator_Harcama_Sure, \r\n                             voip_operator_Harcama_Tarih, voip_operator_Harcama_Ucret) \r\n                            VALUES (?, ?, ?, ?, ?)\";\r\n                    $stmt = $conn->prepare($sql);\r\n                    $stmt->execute([$voipOperatorNumaraId, $cagriSayisi, $sure, $tarih, $ucret]);\r\n                    $message = 'VoIP harcama kaydı başarıyla eklendi.';\r\n                }\r\n                \r\n                $messageType = 'success';\r\n                break;\r\n                \r\n            case 'edit':\r\n                if ($sayfaYetkileri['duzenle'] != 1) {\r\n                    throw new Exception('Düzenleme yetkiniz bulunmamaktadır.');\r\n                }\r\n                \r\n                $id = (int)$_POST['voip_operator_Harcama_id'];\r\n                $voipOperatorNumaraId = (int)$_POST['voip_operator_numara_id'];\r\n                $cagriSayisi = $_POST['voip_operator_Harcama_CagriSayisi'] ? (int)$_POST['voip_operator_Harcama_CagriSayisi'] : null;\r\n                $sure = trim($_POST['voip_operator_Harcama_Sure']) ?: null;\r\n                $tarih = $_POST['voip_operator_Harcama_Tarih'];\r\n                \r\n                // Tarih formatını MSSQL için dönüştür\r\n                if ($tarih) {\r\n                    $dateTime = new DateTime($tarih);\r\n                    $tarih = $dateTime->format('Y-m-d H:i:s');\r\n                }\r\n                \r\n                $ucret = (float)$_POST['voip_operator_Harcama_Ucret'];\r\n                \r\n                $sql = \"UPDATE voip_operator_Harcama SET \r\n                        voip_operator_numara_id = ?, voip_operator_Harcama_CagriSayisi = ?, voip_operator_Harcama_Sure = ?, \r\n                        voip_operator_Harcama_Tarih = ?, voip_operator_Harcama_Ucret = ? \r\n                        WHERE voip_operator_Harcama_id = ?\";\r\n                $stmt = $conn->prepare($sql);\r\n                $stmt->execute([$voipOperatorNumaraId, $cagriSayisi, $sure, $tarih, $ucret, $id]);\r\n                \r\n                $message = 'VoIP harcama kaydı başarıyla güncellendi.';\r\n                $messageType = 'success';\r\n                break;\r\n                \r\n            case 'delete':\r\n                if ($sayfaYetkileri['sil'] != 1) {\r\n                    throw new Exception('Silme yetkiniz bulunmamaktadır.');\r\n                }\r\n                \r\n                $id = (int)$_POST['id'];\r\n                \r\n                $sql = \"DELETE FROM voip_operator_Harcama WHERE voip_operator_Harcama_id = ?\";\r\n                $stmt = $conn->prepare($sql);\r\n                $stmt->execute([$id]);\r\n                \r\n                $message = 'VoIP harcama kaydı başarıyla silindi.';\r\n                $messageType = 'success';\r\n                break;\r\n        }\r\n    } catch (Exception $e) {\r\n        $message = 'Hata: ' . $e->getMessage();\r\n        $messageType = 'danger';\r\n    }\r\n}\r\n\r\n// VoIP Numaralarını al\r\ntry {\r\n    $conn = getDatabaseConnection();\r\n    \r\n    $numeraSql = \"SELECT n.voip_operator_numara_id, n.voip_operator_numara_VoIPNo, o.voip_operator_adi \r\n                  FROM voip_operator_numara n \r\n                  LEFT JOIN voip_operator_tanim o ON n.voip_operator_tanim_id = o.voip_operator_id \r\n                  WHERE n.voip_operator_numara_durum = 1 \r\n                  ORDER BY o.voip_operator_adi, n.voip_operator_numara_VoIPNo\";\r\n    $numeraStmt = $conn->prepare($numeraSql);\r\n    $numeraStmt->execute();\r\n    $voipNumbers = $numeraStmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n} catch (Exception $e) {\r\n    $voipNumbers = [];\r\n}\r\n\r\n// Filtreleme parametrelerini al\r\n$filterNumara = $_GET['filter_numara'] ?? '';\r\n$filterTarihBaslangic = $_GET['filter_tarih_baslangic'] ?? '';\r\n$filterTarihBitis = $_GET['filter_tarih_bitis'] ?? '';\r\n$filterAltBayi = $_GET['filter_alt_bayi'] ?? '';\r\n\r\n// Alt Bayi listesini al (filtreleme için)\r\n$altBayilar = [];\r\ntry {\r\n    $altBayiSql = \"SELECT DISTINCT u.id, (u.first_name + ' ' + u.last_name) as alt_bayi_adi\r\n                   FROM users u\r\n                   INNER JOIN voip_operator_NoTeslim nt ON u.id = nt.voip_operator_users_id\r\n                   WHERE u.first_name IS NOT NULL AND u.last_name IS NOT NULL\r\n                   ORDER BY alt_bayi_adi\";\r\n    $altBayiStmt = $conn->prepare($altBayiSql);\r\n    $altBayiStmt->execute();\r\n    $altBayilar = $altBayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n} catch (Exception $e) {\r\n    $altBayilar = [];\r\n}\r\n\r\n// VoIP Harcamalarını listele\r\n$harcamalar = [];\r\n$error = '';\r\ntry {\r\n    $conn = getDatabaseConnection();\r\n    \r\n    $whereConditions = [];\r\n    $params = [];\r\n    \r\n    if ($filterNumara) {\r\n        $whereConditions[] = \"h.voip_operator_numara_id = ?\";\r\n        $params[] = $filterNumara;\r\n    }\r\n    \r\n    if ($filterTarihBaslangic) {\r\n        $whereConditions[] = \"CAST(h.voip_operator_Harcama_Tarih AS DATE) >= ?\";\r\n        $params[] = $filterTarihBaslangic;\r\n    }\r\n    \r\n    if ($filterTarihBitis) {\r\n        $whereConditions[] = \"CAST(h.voip_operator_Harcama_Tarih AS DATE) <= ?\";\r\n        $params[] = $filterTarihBitis;\r\n    }\r\n    \r\n    if ($filterAltBayi) {\r\n        $whereConditions[] = \"latest_assignment.voip_operator_users_id = ?\";\r\n        $params[] = $filterAltBayi;\r\n    }\r\n    \r\n    $whereClause = !empty($whereConditions) ? 'WHERE ' . implode(' AND ', $whereConditions) : '';\r\n    \r\n    $sql = \"SELECT h.*, n.voip_operator_numara_VoIPNo, o.voip_operator_adi,\r\n                   u.first_name, u.last_name,\r\n                   (u.first_name + ' ' + u.last_name) as alt_bayi_adi\r\n            FROM voip_operator_Harcama h \r\n            LEFT JOIN voip_operator_numara n ON h.voip_operator_numara_id = n.voip_operator_numara_id\r\n            LEFT JOIN voip_operator_tanim o ON n.voip_operator_tanim_id = o.voip_operator_id\r\n            LEFT JOIN (\r\n                SELECT nt.voip_operator_numara_id, \r\n                       nt.voip_operator_users_id,\r\n                       ROW_NUMBER() OVER (PARTITION BY nt.voip_operator_numara_id ORDER BY nt.voip_operator_NoTeslim_TeslimTarihi DESC) as rn\r\n                FROM voip_operator_NoTeslim nt\r\n                WHERE nt.voip_operator_users_id IS NOT NULL\r\n            ) latest_assignment ON n.voip_operator_numara_id = latest_assignment.voip_operator_numara_id AND latest_assignment.rn = 1\r\n            LEFT JOIN users u ON latest_assignment.voip_operator_users_id = u.id\r\n            $whereClause\r\n            ORDER BY h.voip_operator_Harcama_Tarih DESC\";\r\n    $stmt = $conn->prepare($sql);\r\n    $stmt->execute($params);\r\n    $harcamalar = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    // Toplam istatistikleri hesapla\r\n    $toplamSql = \"SELECT \r\n                    COUNT(*) as toplam_kayit,\r\n                    ISNULL(SUM(h.voip_operator_Harcama_CagriSayisi), 0) as toplam_cagri,\r\n                    ISNULL(SUM(h.voip_operator_Harcama_Ucret), 0) as toplam_ucret\r\n                  FROM voip_operator_Harcama h \r\n                  LEFT JOIN voip_operator_numara n ON h.voip_operator_numara_id = n.voip_operator_numara_id\r\n                  LEFT JOIN voip_operator_tanim o ON n.voip_operator_tanim_id = o.voip_operator_id\r\n                  LEFT JOIN (\r\n                      SELECT nt.voip_operator_numara_id, \r\n                             nt.voip_operator_users_id,\r\n                             ROW_NUMBER() OVER (PARTITION BY nt.voip_operator_numara_id ORDER BY nt.voip_operator_NoTeslim_TeslimTarihi DESC) as rn\r\n                      FROM voip_operator_NoTeslim nt\r\n                      WHERE nt.voip_operator_users_id IS NOT NULL\r\n                  ) latest_assignment ON n.voip_operator_numara_id = latest_assignment.voip_operator_numara_id AND latest_assignment.rn = 1\r\n                  LEFT JOIN users u ON latest_assignment.voip_operator_users_id = u.id\r\n                  $whereClause\";\r\n    $toplamStmt = $conn->prepare($toplamSql);\r\n    $toplamStmt->execute($params);\r\n    $istatistikler = $toplamStmt->fetch(PDO::FETCH_ASSOC);\r\n    \r\n} catch (Exception $e) {\r\n    $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n}\r\n\r\ninclude '../../../includes/header.php';\r\n?>\r\n\r\n<div class=\"container-fluid mt-4\">\r\n    <div class=\"row\">\r\n        <div class=\"col-12\">\r\n            <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n                <h2><i class=\"fas fa-dollar-sign me-2\"></i>VoIP Numara Harcamalar</h2>\r\n                <?php if ($sayfaYetkileri['ekle'] == 1): ?>\r\n                <div class=\"btn-group\" role=\"group\">\r\n                    <button class=\"btn btn-success\" data-bs-toggle=\"modal\" data-bs-target=\"#uploadExcelModal\">\r\n                        <i class=\"fas fa-file-excel me-1\"></i>Excel Yükle\r\n                    </button>\r\n                    <button class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#addHarcamaModal\">\r\n                        <i class=\"fas fa-plus me-1\"></i>Yeni Harcama\r\n                    </button>\r\n                </div>\r\n                <?php endif; ?>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <?php if ($message): ?>\r\n        <div class=\"alert alert-<?php echo $messageType; ?> alert-dismissible fade show\" role=\"alert\">\r\n            <i class=\"fas fa-<?php echo $messageType === 'success' ? 'check-circle' : 'exclamation-triangle'; ?> me-2\"></i>\r\n            <?php echo htmlspecialchars($message); ?>\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n        </div>\r\n    <?php endif; ?>\r\n\r\n    <?php if ($error): ?>\r\n        <div class=\"alert alert-danger alert-dismissible fade show\" role=\"alert\">\r\n            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n            <?php echo htmlspecialchars($error); ?>\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n        </div>\r\n    <?php endif; ?>\r\n\r\n    <!-- İstatistikler -->\r\n    <?php if (isset($istatistikler)): ?>\r\n    <div class=\"row mb-4\">\r\n        <div class=\"col-md-4\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-body text-center\">\r\n                    <div class=\"text-primary\">\r\n                        <i class=\"fas fa-list-ol fa-2x mb-2\"></i>\r\n                    </div>\r\n                    <h5 class=\"card-title\">Toplam Kayıt</h5>\r\n                    <h3 class=\"text-primary\"><?php echo number_format($istatistikler['toplam_kayit']); ?></h3>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <div class=\"col-md-4\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-body text-center\">\r\n                    <div class=\"text-info\">\r\n                        <i class=\"fas fa-phone fa-2x mb-2\"></i>\r\n                    </div>\r\n                    <h5 class=\"card-title\">Toplam Çağrı</h5>\r\n                    <h3 class=\"text-info\"><?php echo number_format($istatistikler['toplam_cagri']); ?></h3>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <div class=\"col-md-4\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-body text-center\">\r\n                    <div class=\"text-success\">\r\n                        <i class=\"fas fa-lira-sign fa-2x mb-2\"></i>\r\n                    </div>\r\n                    <h5 class=\"card-title\">Toplam Ücret</h5>\r\n                    <h3 class=\"text-success\"><?php echo number_format($istatistikler['toplam_ucret'], 2); ?> ₺</h3>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <?php endif; ?>\r\n\r\n    <!-- Filtreleme -->\r\n    <div class=\"card border-0 shadow-sm mb-4\">\r\n        <div class=\"card-header bg-light\">\r\n            <h5 class=\"mb-0\">\r\n                <i class=\"fas fa-filter me-2\"></i>Filtreleme\r\n            </h5>\r\n        </div>\r\n        <div class=\"card-body\">\r\n            <form method=\"GET\" class=\"row g-3\">\r\n                <div class=\"col-md-3\">\r\n                    <label class=\"form-label\">VoIP Numara</label>\r\n                    <select name=\"filter_numara\" class=\"form-select select2-search\">\r\n                        <option value=\"\">Tümü</option>\r\n                        <?php foreach ($voipNumbers as $number): ?>\r\n                            <option value=\"<?php echo $number['voip_operator_numara_id']; ?>\" <?php echo $filterNumara == $number['voip_operator_numara_id'] ? 'selected' : ''; ?>>\r\n                                <?php echo htmlspecialchars($number['voip_operator_adi']) . ' - ' . htmlspecialchars($number['voip_operator_numara_VoIPNo']); ?>\r\n                            </option>\r\n                        <?php endforeach; ?>\r\n                    </select>\r\n                </div>\r\n                <div class=\"col-md-2\">\r\n                    <label class=\"form-label\">Alt Bayi</label>\r\n                    <select name=\"filter_alt_bayi\" class=\"form-select select2-search\">\r\n                        <option value=\"\">Tümü</option>\r\n                        <?php foreach ($altBayilar as $bayi): ?>\r\n                            <option value=\"<?php echo $bayi['id']; ?>\" <?php echo $filterAltBayi == $bayi['id'] ? 'selected' : ''; ?>>\r\n                                <?php echo htmlspecialchars($bayi['alt_bayi_adi']); ?>\r\n                            </option>\r\n                        <?php endforeach; ?>\r\n                    </select>\r\n                </div>\r\n                <div class=\"col-md-2\">\r\n                    <label class=\"form-label\">Başlangıç Tarihi</label>\r\n                    <input type=\"date\" name=\"filter_tarih_baslangic\" class=\"form-control\" value=\"<?php echo $filterTarihBaslangic; ?>\">\r\n                </div>\r\n                <div class=\"col-md-2\">\r\n                    <label class=\"form-label\">Bitiş Tarihi</label>\r\n                    <input type=\"date\" name=\"filter_tarih_bitis\" class=\"form-control\" value=\"<?php echo $filterTarihBitis; ?>\">\r\n                </div>\r\n                <div class=\"col-md-1\">\r\n                    <label class=\"form-label\">&nbsp;</label>\r\n                    <div class=\"d-grid\">\r\n                        <button type=\"submit\" class=\"btn btn-primary\">\r\n                            <i class=\"fas fa-search\"></i>\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n                <div class=\"col-md-1\">\r\n                    <label class=\"form-label\">&nbsp;</label>\r\n                    <div class=\"d-grid\">\r\n                        <a href=\"voip_operator_harcama.php\" class=\"btn btn-outline-secondary\">\r\n                            <i class=\"fas fa-times\"></i>\r\n                        </a>\r\n                    </div>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- VoIP Harcamalar Tablosu -->\r\n    <div class=\"card border-0 shadow-sm\">\r\n        <div class=\"card-header bg-primary text-white\">\r\n            <h5 class=\"mb-0\">\r\n                <i class=\"fas fa-list me-2\"></i>VoIP Harcama Listesi\r\n            </h5>\r\n        </div>\r\n        <div class=\"card-body p-0\">\r\n            <div class=\"table-responsive\">\r\n                <table class=\"table table-hover mb-0\">\r\n                    <thead class=\"table-light\">\r\n                        <tr>\r\n                            <th>ID</th>\r\n                            <th>VoIP Operatör</th>\r\n                            <th>VoIP No</th>\r\n                            <th>Alt Bayi</th>\r\n                            <th>Çağrı Sayısı</th>\r\n                            <th>Süre</th>\r\n                            <th>Tarih</th>\r\n                            <th>Ücret (₺)</th>\r\n                            <th>İşlemler</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        <?php if (!empty($harcamalar)): ?>\r\n                            <?php foreach ($harcamalar as $harcama): ?>\r\n                                <tr>\r\n                                    <td><?php echo $harcama['voip_operator_Harcama_id']; ?></td>\r\n                                    <td>\r\n                                        <strong><?php echo htmlspecialchars($harcama['voip_operator_adi'] ?? 'Bilinmeyen'); ?></strong>\r\n                                    </td>\r\n                                    <td>\r\n                                        <code><?php echo htmlspecialchars($harcama['voip_operator_numara_VoIPNo']); ?></code>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php if (!empty($harcama['alt_bayi_adi'])): ?>\r\n                                            <span class=\"badge bg-primary\"><?php echo htmlspecialchars($harcama['alt_bayi_adi']); ?></span>\r\n                                        <?php else: ?>\r\n                                            <span class=\"text-muted\">-</span>\r\n                                        <?php endif; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php if ($harcama['voip_operator_Harcama_CagriSayisi']): ?>\r\n                                            <span class=\"badge bg-info\"><?php echo number_format($harcama['voip_operator_Harcama_CagriSayisi']); ?></span>\r\n                                        <?php else: ?>\r\n                                            <span class=\"text-muted\">-</span>\r\n                                        <?php endif; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo $harcama['voip_operator_Harcama_Sure'] ? htmlspecialchars($harcama['voip_operator_Harcama_Sure']) : '<span class=\"text-muted\">-</span>'; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo $harcama['voip_operator_Harcama_Tarih'] ? date('d.m.Y H:i', strtotime($harcama['voip_operator_Harcama_Tarih'])) : '-'; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <strong class=\"text-success\"><?php echo number_format($harcama['voip_operator_Harcama_Ucret'], 2); ?></strong>\r\n                                    </td>\r\n                                    <td>\r\n                                        <div class=\"btn-group\" role=\"group\">\r\n                                            <?php if ($sayfaYetkileri['duzenle'] == 1): ?>\r\n                                            <button type=\"button\" class=\"btn btn-sm btn-outline-primary\" \r\n                                                    onclick=\"editHarcama(<?php echo htmlspecialchars(json_encode($harcama)); ?>)\">\r\n                                                <i class=\"fas fa-edit\"></i>\r\n                                            </button>\r\n                                            <?php endif; ?>\r\n                                            <?php if ($sayfaYetkileri['sil'] == 1): ?>\r\n                                            <button type=\"button\" class=\"btn btn-sm btn-outline-danger\" \r\n                                                    onclick=\"deleteHarcama(<?php echo $harcama['voip_operator_Harcama_id']; ?>, '<?php echo htmlspecialchars($harcama['voip_operator_numara_VoIPNo']); ?>')\">\r\n                                                <i class=\"fas fa-trash\"></i>\r\n                                            </button>\r\n                                            <?php endif; ?>\r\n                                        </div>\r\n                                    </td>\r\n                                </tr>\r\n                            <?php endforeach; ?>\r\n                        <?php else: ?>\r\n                            <tr>\r\n                                <td colspan=\"9\" class=\"text-center py-5 text-muted\">\r\n                                    <i class=\"fas fa-dollar-sign fa-3x mb-3 d-block\"></i>\r\n                                    <h5>Henüz harcama kaydı bulunmuyor</h5>\r\n                                    <p>İlk harcama kaydını eklemek için \"Yeni Harcama\" butonuna tıklayın.</p>\r\n                                </td>\r\n                            </tr>\r\n                        <?php endif; ?>\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Excel Yükleme Modal -->\r\n<div class=\"modal fade\" id=\"uploadExcelModal\" tabindex=\"-1\" aria-labelledby=\"uploadExcelModalLabel\" aria-hidden=\"true\">\r\n    <div class=\"modal-dialog modal-lg\">\r\n        <div class=\"modal-content\">\r\n            <div class=\"modal-header\">\r\n                <h5 class=\"modal-title\" id=\"uploadExcelModalLabel\">\r\n                    <i class=\"fas fa-file-excel me-2\"></i>VoIP Harcama Excel Dosyası Yükle\r\n                </h5>\r\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\r\n            </div>\r\n            <form method=\"POST\" enctype=\"multipart/form-data\">\r\n                <div class=\"modal-body\">\r\n                    <input type=\"hidden\" name=\"action\" value=\"upload_excel\">\r\n                    \r\n                    <div class=\"alert alert-info\">\r\n                        <i class=\"fas fa-info-circle me-2\"></i>\r\n                        <strong>Excel Dosyası Formatı:</strong><br>\r\n                        Customer Name, Number of Calls, Duration (min), Billed Duration (min), Charged Amount, Cost, Currency<br>\r\n                        <small class=\"text-muted\">Customer Name: \"Acct. 902129221364\" veya \"902129221364\" formatında olabilir<br>\r\n                        Ücret: \"Cost\" sütunu yoksa \"Charged Amount\" sütunu kullanılır</small>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"excel_tarih\" class=\"form-label\">Harcama Tarihi <span class=\"text-danger\">*</span></label>\r\n                        <input type=\"date\" class=\"form-control\" id=\"excel_tarih\" name=\"excel_tarih\" required>\r\n                        <div class=\"form-text\">Yüklenen tüm kayıtlar bu tarih ile kaydedilecek</div>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"excel_file\" class=\"form-label\">Excel Dosyası <span class=\"text-danger\">*</span></label>\r\n                        <input type=\"file\" class=\"form-control\" id=\"excel_file\" name=\"excel_file\" accept=\".xlsx,.xls\" required>\r\n                        <div class=\"form-text\">Sadece .xlsx ve .xls dosyaları kabul edilir</div>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <div class=\"form-check\">\r\n                            <input class=\"form-check-input\" type=\"checkbox\" id=\"skip_first_row\" name=\"skip_first_row\" checked>\r\n                            <label class=\"form-check-label\" for=\"skip_first_row\">\r\n                                İlk satırı atla (başlık satırı)\r\n                            </label>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"alert alert-warning\">\r\n                        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                        <strong>Dikkat:</strong> Customer Name alanında mevcut VoIP numaralarınız bulunmalıdır.<br>\r\n                        <small>Format: \"902129221364\" veya \"Acct. 902129221364\" (sistem otomatik olarak \"Acct. \" kısmını temizler)</small>\r\n                    </div>\r\n                    \r\n                    <div class=\"alert alert-info\">\r\n                        <i class=\"fas fa-sync-alt me-2\"></i>\r\n                        <strong>Mükerrer Kayıt:</strong> Aynı numara ve aynı tarihte kayıt varsa otomatik güncellenir.\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-success\" id=\"uploadBtn\">\r\n                        <i class=\"fas fa-upload me-1\"></i>Yükle\r\n                    </button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Loading Modal -->\r\n<div class=\"modal fade\" id=\"loadingModal\" tabindex=\"-1\" data-bs-backdrop=\"static\" data-bs-keyboard=\"false\">\r\n    <div class=\"modal-dialog modal-sm\">\r\n        <div class=\"modal-content\">\r\n            <div class=\"modal-body text-center\">\r\n                <div class=\"spinner-border text-primary\" role=\"status\">\r\n                    <span class=\"visually-hidden\">Yükleniyor...</span>\r\n                </div>\r\n                <p class=\"mt-3\">Excel dosyası işleniyor...</p>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Yeni Harcama Ekleme Modal -->\r\n<div class=\"modal fade\" id=\"addHarcamaModal\" tabindex=\"-1\" aria-labelledby=\"addHarcamaModalLabel\" aria-hidden=\"true\">\r\n    <div class=\"modal-dialog\">\r\n        <div class=\"modal-content\">\r\n            <div class=\"modal-header\">\r\n                <h5 class=\"modal-title\" id=\"addHarcamaModalLabel\">\r\n                    <i class=\"fas fa-plus me-2\"></i>Yeni VoIP Harcama Ekle\r\n                </h5>\r\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\r\n            </div>\r\n            <form method=\"POST\">\r\n                <div class=\"modal-body\">\r\n                    <input type=\"hidden\" name=\"action\" value=\"add\">\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"voip_operator_numara_id\" class=\"form-label\">VoIP Numara <span class=\"text-danger\">*</span></label>\r\n                        <select class=\"form-select select2-search\" id=\"voip_operator_numara_id\" name=\"voip_operator_numara_id\" required>\r\n                            <option value=\"\">Seçiniz...</option>\r\n                            <?php foreach ($voipNumbers as $number): ?>\r\n                                <option value=\"<?php echo $number['voip_operator_numara_id']; ?>\">\r\n                                    <?php echo htmlspecialchars($number['voip_operator_adi']) . ' - ' . htmlspecialchars($number['voip_operator_numara_VoIPNo']); ?>\r\n                                </option>\r\n                            <?php endforeach; ?>\r\n                        </select>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"voip_operator_Harcama_CagriSayisi\" class=\"form-label\">Çağrı Sayısı</label>\r\n                        <input type=\"number\" class=\"form-control\" id=\"voip_operator_Harcama_CagriSayisi\" name=\"voip_operator_Harcama_CagriSayisi\" min=\"0\" placeholder=\"örn: 2089\">\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"voip_operator_Harcama_Sure\" class=\"form-label\">Süre (dk:sn)</label>\r\n                        <input type=\"text\" class=\"form-control\" id=\"voip_operator_Harcama_Sure\" name=\"voip_operator_Harcama_Sure\" maxlength=\"10\" placeholder=\"örn: 03:45\">\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"voip_operator_Harcama_Tarih\" class=\"form-label\">Tarih <span class=\"text-danger\">*</span></label>\r\n                        <input type=\"datetime-local\" class=\"form-control\" id=\"voip_operator_Harcama_Tarih\" name=\"voip_operator_Harcama_Tarih\" required>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"voip_operator_Harcama_Ucret\" class=\"form-label\">Ücret (₺) <span class=\"text-danger\">*</span></label>\r\n                        <input type=\"number\" class=\"form-control\" id=\"voip_operator_Harcama_Ucret\" name=\"voip_operator_Harcama_Ucret\" step=\"0.00001\" min=\"0\" required placeholder=\"örn: 53.54167\">\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-primary\">\r\n                        <i class=\"fas fa-save me-1\"></i>Kaydet\r\n                    </button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Harcama Düzenleme Modal -->\r\n<div class=\"modal fade\" id=\"editHarcamaModal\" tabindex=\"-1\" aria-labelledby=\"editHarcamaModalLabel\" aria-hidden=\"true\">\r\n    <div class=\"modal-dialog\">\r\n        <div class=\"modal-content\">\r\n            <div class=\"modal-header\">\r\n                <h5 class=\"modal-title\" id=\"editHarcamaModalLabel\">\r\n                    <i class=\"fas fa-edit me-2\"></i>VoIP Harcama Düzenle\r\n                </h5>\r\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\r\n            </div>\r\n            <form method=\"POST\" id=\"editHarcamaForm\">\r\n                <div class=\"modal-body\">\r\n                    <input type=\"hidden\" name=\"action\" value=\"edit\">\r\n                    <input type=\"hidden\" name=\"voip_operator_Harcama_id\" id=\"edit_voip_operator_Harcama_id\">\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"edit_voip_operator_numara_id\" class=\"form-label\">VoIP Numara <span class=\"text-danger\">*</span></label>\r\n                        <select class=\"form-select select2-search\" id=\"edit_voip_operator_numara_id\" name=\"voip_operator_numara_id\" required>\r\n                            <option value=\"\">Seçiniz...</option>\r\n                            <?php foreach ($voipNumbers as $number): ?>\r\n                                <option value=\"<?php echo $number['voip_operator_numara_id']; ?>\">\r\n                                    <?php echo htmlspecialchars($number['voip_operator_adi']) . ' - ' . htmlspecialchars($number['voip_operator_numara_VoIPNo']); ?>\r\n                                </option>\r\n                            <?php endforeach; ?>\r\n                        </select>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"edit_voip_operator_Harcama_CagriSayisi\" class=\"form-label\">Çağrı Sayısı</label>\r\n                        <input type=\"number\" class=\"form-control\" id=\"edit_voip_operator_Harcama_CagriSayisi\" name=\"voip_operator_Harcama_CagriSayisi\" min=\"0\" placeholder=\"örn: 2089\">\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"edit_voip_operator_Harcama_Sure\" class=\"form-label\">Süre (dk:sn)</label>\r\n                        <input type=\"text\" class=\"form-control\" id=\"edit_voip_operator_Harcama_Sure\" name=\"voip_operator_Harcama_Sure\" maxlength=\"10\" placeholder=\"örn: 03:45\">\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"edit_voip_operator_Harcama_Tarih\" class=\"form-label\">Tarih <span class=\"text-danger\">*</span></label>\r\n                        <input type=\"datetime-local\" class=\"form-control\" id=\"edit_voip_operator_Harcama_Tarih\" name=\"voip_operator_Harcama_Tarih\" required>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"edit_voip_operator_Harcama_Ucret\" class=\"form-label\">Ücret (₺) <span class=\"text-danger\">*</span></label>\r\n                        <input type=\"number\" class=\"form-control\" id=\"edit_voip_operator_Harcama_Ucret\" name=\"voip_operator_Harcama_Ucret\" step=\"0.00001\" min=\"0\" required placeholder=\"örn: 53.54167\">\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-primary\">\r\n                        <i class=\"fas fa-save me-1\"></i>Güncelle\r\n                    </button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Silme Onay Modal -->\r\n<div class=\"modal fade\" id=\"deleteHarcamaModal\" tabindex=\"-1\" aria-labelledby=\"deleteHarcamaModalLabel\" aria-hidden=\"true\">\r\n    <div class=\"modal-dialog\">\r\n        <div class=\"modal-content\">\r\n            <div class=\"modal-header\">\r\n                <h5 class=\"modal-title\" id=\"deleteHarcamaModalLabel\">\r\n                    <i class=\"fas fa-trash me-2\"></i>Harcama Sil\r\n                </h5>\r\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\r\n            </div>\r\n            <div class=\"modal-body\">\r\n                <p>Bu VoIP harcama kaydını silmek istediğinizden emin misiniz?</p>\r\n                <p><strong id=\"deleteHarcamaInfo\"></strong></p>\r\n                <p class=\"text-danger\"><small>Bu işlem geri alınamaz!</small></p>\r\n            </div>\r\n            <div class=\"modal-footer\">\r\n                <form method=\"POST\" id=\"deleteHarcamaForm\">\r\n                    <input type=\"hidden\" name=\"action\" value=\"delete\">\r\n                    <input type=\"hidden\" name=\"id\" id=\"deleteHarcamaId\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-danger\">\r\n                        <i class=\"fas fa-trash me-1\"></i>Sil\r\n                    </button>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<script>\r\n$(document).ready(function() {\r\n    // Select2'yi tüm select2-search class'lı elementlere uygula\r\n    $('.select2-search').select2({\r\n        placeholder: 'Ara ve seç...',\r\n        allowClear: true,\r\n        language: {\r\n            noResults: function() {\r\n                return \"Sonuç bulunamadı\";\r\n            },\r\n            searching: function() {\r\n                return \"Aranıyor...\";\r\n            },\r\n            inputTooShort: function() {\r\n                return \"En az 1 karakter giriniz\";\r\n            }\r\n        }\r\n    });\r\n    \r\n    // Modal açıldığında Select2'yi yeniden başlat\r\n    $('#addHarcamaModal, #editHarcamaModal').on('shown.bs.modal', function () {\r\n        $(this).find('.select2-search').select2({\r\n            placeholder: 'Ara ve seç...',\r\n            allowClear: true,\r\n            dropdownParent: $(this),\r\n            language: {\r\n                noResults: function() {\r\n                    return \"Sonuç bulunamadı\";\r\n                },\r\n                searching: function() {\r\n                    return \"Aranıyor...\";\r\n                },\r\n                inputTooShort: function() {\r\n                    return \"En az 1 karakter giriniz\";\r\n                }\r\n            }\r\n        });\r\n    });\r\n});\r\n\r\n// Sayfa yüklendiğinde bugünün tarihini varsayılan olarak ayarla\r\ndocument.addEventListener('DOMContentLoaded', function() {\r\n    const now = new Date();\r\n    const localISOTime = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);\r\n    document.getElementById('voip_operator_Harcama_Tarih').value = localISOTime;\r\n    \r\n    // Excel modal için bugünün tarihini ayarla\r\n    const today = now.toISOString().slice(0, 10);\r\n    document.getElementById('excel_tarih').value = today;\r\n    \r\n    // Excel upload form için loading efekti\r\n    const uploadForm = document.querySelector('#uploadExcelModal form');\r\n    if (uploadForm) {\r\n        uploadForm.addEventListener('submit', function() {\r\n            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));\r\n            loadingModal.show();\r\n            \r\n            // Upload modal'ını kapat\r\n            const uploadModal = bootstrap.Modal.getInstance(document.getElementById('uploadExcelModal'));\r\n            if (uploadModal) {\r\n                uploadModal.hide();\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\nfunction editHarcama(harcama) {\r\n    // Modal formuna veri doldur\r\n    document.getElementById('edit_voip_operator_Harcama_id').value = harcama.voip_operator_Harcama_id;\r\n    $('#edit_voip_operator_numara_id').val(harcama.voip_operator_numara_id).trigger('change');\r\n    document.getElementById('edit_voip_operator_Harcama_CagriSayisi').value = harcama.voip_operator_Harcama_CagriSayisi || '';\r\n    document.getElementById('edit_voip_operator_Harcama_Sure').value = harcama.voip_operator_Harcama_Sure || '';\r\n    document.getElementById('edit_voip_operator_Harcama_Ucret').value = harcama.voip_operator_Harcama_Ucret;\r\n    \r\n    // Tarih formatını datetime-local için uygun hale getir\r\n    if (harcama.voip_operator_Harcama_Tarih) {\r\n        const date = new Date(harcama.voip_operator_Harcama_Tarih);\r\n        const localISOTime = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);\r\n        document.getElementById('edit_voip_operator_Harcama_Tarih').value = localISOTime;\r\n    }\r\n    \r\n    // Modal'ı aç\r\n    new bootstrap.Modal(document.getElementById('editHarcamaModal')).show();\r\n}\r\n\r\nfunction deleteHarcama(id, voipNo) {\r\n    document.getElementById('deleteHarcamaId').value = id;\r\n    document.getElementById('deleteHarcamaInfo').textContent = voipNo + ' numarası için harcama kaydı';\r\n    new bootstrap.Modal(document.getElementById('deleteHarcamaModal')).show();\r\n}\r\n</script>\r\n\r\n<?php include '../../../includes/footer.php'; ?>"
        }
    ]
}
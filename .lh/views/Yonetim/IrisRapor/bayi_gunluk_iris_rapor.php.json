{
    "sourceFile": "views/Yonetim/IrisRapor/bayi_gunluk_iris_rapor.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1761059907408,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1761059907408,
            "name": "Commit-0",
            "content": "<?php\r\n$pageTitle = \"Bayi Günlük Satış Adet\";\r\n$breadcrumbs = [\r\n    ['title' => 'Bayi Günlük Satış Adet']\r\n];\r\n\r\n// Auth kontrol\r\nrequire_once '../../../auth.php';\r\n$currentUser = checkAuth();\r\ncheckUserStatus();\r\nupdateLastActivity();\r\n\r\n// Sayfa yetkilendirme kontrolü\r\n$sayfaYetkileri = [\r\n    'gor' => false,\r\n    'kendi_kullanicini_gor' => false,\r\n    'ekle' => false,\r\n    'duzenle' => false,\r\n    'sil' => false\r\n];\r\n\r\n// Admin kontrolü (group_id = 1 ise tüm yetkilere sahip)\r\n$isAdmin = ($currentUser['group_id'] == 1);\r\n\r\nif ($isAdmin) {\r\n    // Admin için tüm yetkileri aç\r\n    $sayfaYetkileri = [\r\n        'gor' => 1,\r\n        'kendi_kullanicini_gor' => 0, // 0 = Herkesi görebilir\r\n        'ekle' => 1,\r\n        'duzenle' => 1,\r\n        'sil' => 1\r\n    ];\r\n} else {\r\n    // Admin değilse normal yetki kontrolü yap\r\n    try {\r\n        $conn = getDatabaseConnection();\r\n        \r\n        // Mevcut sayfa URL'sini al\r\n        $currentPageUrl = basename($_SERVER['PHP_SELF']);\r\n        \r\n        // Sayfa bilgisini ve yetkilerini çek\r\n        $yetkiSql = \"\r\n            SELECT \r\n                tsy.gor,\r\n                tsy.kendi_kullanicini_gor,\r\n                tsy.ekle,\r\n                tsy.duzenle,\r\n                tsy.sil,\r\n                tsy.durum as yetki_durum,\r\n                ts.durum as sayfa_durum\r\n            FROM dbo.tanim_sayfalar ts\r\n            INNER JOIN dbo.tanim_sayfa_yetkiler tsy ON ts.sayfa_id = tsy.sayfa_id\r\n            WHERE ts.sayfa_url = ?\r\n            AND tsy.user_group_id = ?\r\n            AND ts.durum = 1\r\n            AND tsy.durum = 1\r\n        \";\r\n        \r\n        $yetkiStmt = $conn->prepare($yetkiSql);\r\n        $yetkiStmt->execute([$currentPageUrl, $currentUser['group_id']]);\r\n        $yetkiResult = $yetkiStmt->fetch(PDO::FETCH_ASSOC);\r\n        \r\n        if ($yetkiResult) {\r\n            $sayfaYetkileri = [\r\n                'gor' => (int)$yetkiResult['gor'],\r\n                'kendi_kullanicini_gor' => (int)$yetkiResult['kendi_kullanicini_gor'],\r\n                'ekle' => (int)$yetkiResult['ekle'],\r\n                'duzenle' => (int)$yetkiResult['duzenle'],\r\n                'sil' => (int)$yetkiResult['sil']\r\n            ];\r\n            \r\n            // Görme yetkisi yoksa (0 ise) sayfaya erişimi engelle\r\n            if ($sayfaYetkileri['gor'] == 0) {\r\n                header('Location: ../../../index.php?error=yetki_yok');\r\n                exit;\r\n            }\r\n        } else {\r\n            // Yetki tanımı bulunamazsa erişimi engelle\r\n            header('Location: ../../../index.php?error=yetki_tanimlanmamis');\r\n            exit;\r\n        }\r\n        \r\n    } catch (Exception $e) {\r\n        // Hata durumunda güvenlik için erişimi engelle\r\n        error_log(\"Yetki kontrol hatası: \" . $e->getMessage());\r\n        header('Location: ../../../index.php?error=sistem_hatasi');\r\n        exit;\r\n    }\r\n}\r\n\r\n// Tarih filtresi kontrolü\r\n$selectedDate = isset($_POST['selected_date']) && !empty($_POST['selected_date']) ? $_POST['selected_date'] : date('Y-m-d', strtotime('-1 day'));\r\n$displayDate = date('d.m.Y', strtotime($selectedDate));\r\n\r\n// Veritabanından veri çek\r\n$bayiRapor = [];\r\n$bayiOnayRapor = [];\r\n$bayiKurulumRapor = [];\r\n$bayiHaftalikRapor = [];\r\ntry {\r\n    $conn = getDatabaseConnection();\r\n    \r\n    // BAYİ GÜNLÜK SATIŞ ADET sorgusu\r\n    $sql = \"\r\n    DECLARE @selectedDate date = ?;\r\n    \r\n    WITH P AS (\r\n        SELECT\r\n            TALEBI_GIREN_PERSONEL_ALTBAYI AS [BAYİ İSMİ],\r\n            ISNULL([ISP], 0)  AS ISP,\r\n            ISNULL([NEO], 0)  AS NEO,\r\n            ISNULL([UYDU], 0) AS UYDU,\r\n            ISNULL([NEO], 0) + ISNULL([UYDU], 0) AS [TV Toplam]\r\n        FROM (\r\n            SELECT TALEBI_GIREN_PERSONEL_ALTBAYI, MEMO_KAYIT_TIPI\r\n            FROM digiturk.iris_rapor\r\n            WHERE TALEP_GIRIS_TARIHI >= @selectedDate\r\n              AND TALEP_GIRIS_TARIHI < DATEADD(day, 1, @selectedDate)\r\n        ) AS S\r\n        PIVOT (\r\n            COUNT(MEMO_KAYIT_TIPI)\r\n            FOR MEMO_KAYIT_TIPI IN ([ISP], [NEO], [UYDU])\r\n        ) AS PV\r\n    )\r\n    -- Yardımcı sıralama kolonları (_sort_total, _sort_tv) ekle\r\n    , U AS (\r\n        SELECT [BAYİ İSMİ], ISP, NEO, UYDU, [TV Toplam],\r\n               CAST(0 AS int) AS _sort_total,\r\n               [TV Toplam]     AS _sort_tv\r\n        FROM P\r\n        UNION ALL\r\n        SELECT N'Genel Toplam',\r\n               SUM(ISP), SUM(NEO), SUM(UYDU),\r\n               SUM(NEO) + SUM(UYDU),\r\n               1 AS _sort_total,\r\n               SUM(NEO) + SUM(UYDU) AS _sort_tv\r\n        FROM P\r\n    )\r\n    -- Dış sarmalda sadece istediğin kolonları göster, sıralamayı yardımcılarla yap\r\n    SELECT [BAYİ İSMİ], ISP, NEO, UYDU, [TV Toplam]\r\n    FROM U\r\n    ORDER BY _sort_total, _sort_tv DESC, [BAYİ İSMİ];\r\n    \";\r\n    \r\n    $stmt = $conn->prepare($sql);\r\n    $stmt->execute([$selectedDate]);\r\n    $bayiRapor = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    // BAYİ GÜNLÜK ONAY ADET sorgusu\r\n    $sqlOnay = \"\r\n    DECLARE @selectedDate date = ?;\r\n    \r\n    WITH P AS (\r\n        SELECT\r\n            TALEBI_GIREN_PERSONEL_ALTBAYI AS [BAYİ İSMİ],\r\n            ISNULL([ISP], 0)  AS ISP,\r\n            ISNULL([NEO], 0)  AS NEO,\r\n            ISNULL([UYDU], 0) AS UYDU,\r\n            ISNULL([NEO], 0) + ISNULL([UYDU], 0) AS [TV Toplam]\r\n        FROM (\r\n            SELECT TALEBI_GIREN_PERSONEL_ALTBAYI, MEMO_KAYIT_TIPI\r\n            FROM digiturk.iris_rapor\r\n            WHERE TALEP_GIRIS_TARIHI >= @selectedDate\r\n              AND TALEP_GIRIS_TARIHI < DATEADD(day, 1, @selectedDate)\r\n              AND TEYIT_DURUM = N'ONAYLANDI'\r\n        ) AS S\r\n        PIVOT (\r\n            COUNT(MEMO_KAYIT_TIPI)\r\n            FOR MEMO_KAYIT_TIPI IN ([ISP], [NEO], [UYDU])\r\n        ) AS PV\r\n    )\r\n    , U AS (\r\n        SELECT [BAYİ İSMİ], ISP, NEO, UYDU, [TV Toplam],\r\n               CAST(0 AS int) AS _sort_total,\r\n               [TV Toplam]     AS _sort_tv\r\n        FROM P\r\n        UNION ALL\r\n        SELECT N'Genel Toplam',\r\n               SUM(ISP), SUM(NEO), SUM(UYDU),\r\n               SUM(NEO) + SUM(UYDU),\r\n               1 AS _sort_total,\r\n               SUM(NEO) + SUM(UYDU) AS _sort_tv\r\n        FROM P\r\n    )\r\n    SELECT [BAYİ İSMİ], ISP, NEO, UYDU, [TV Toplam]\r\n    FROM U\r\n    ORDER BY _sort_total, _sort_tv DESC, [BAYİ İSMİ];\r\n    \";\r\n    \r\n    $stmtOnay = $conn->prepare($sqlOnay);\r\n    $stmtOnay->execute([$selectedDate]);\r\n    $bayiOnayRapor = $stmtOnay->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    // BAYİ GÜNLÜK KURULUM ADET sorgusu\r\n    $sqlKurulum = \"\r\n    DECLARE @selectedDate date = ?;\r\n    \r\n    WITH P AS (\r\n        SELECT\r\n            TALEBI_GIREN_PERSONEL_ALTBAYI AS [BAYİ İSMİ],\r\n            ISNULL([ISP], 0)  AS ISP,\r\n            ISNULL([NEO], 0)  AS NEO,\r\n            ISNULL([UYDU], 0) AS UYDU,\r\n            ISNULL([NEO], 0) + ISNULL([UYDU], 0) AS [TV Toplam]\r\n        FROM (\r\n            SELECT TALEBI_GIREN_PERSONEL_ALTBAYI, MEMO_KAYIT_TIPI\r\n            FROM digiturk.iris_rapor\r\n            WHERE MEMO_KAPANIS_TARIHI >= @selectedDate\r\n              AND MEMO_KAPANIS_TARIHI < DATEADD(day, 1, @selectedDate)\r\n              AND SATIS_DURUMU = N'Tamamlandı'\r\n        ) AS S\r\n        PIVOT (\r\n            COUNT(MEMO_KAYIT_TIPI)\r\n            FOR MEMO_KAYIT_TIPI IN ([ISP], [NEO], [UYDU])\r\n        ) AS PV\r\n    )\r\n    , U AS (\r\n        SELECT [BAYİ İSMİ], ISP, NEO, UYDU, [TV Toplam],\r\n               CAST(0 AS int) AS _sort_total,\r\n               [TV Toplam]     AS _sort_tv\r\n        FROM P\r\n        UNION ALL\r\n        SELECT N'Genel Toplam',\r\n               SUM(ISP), SUM(NEO), SUM(UYDU),\r\n               SUM(NEO) + SUM(UYDU),\r\n               1 AS _sort_total,\r\n               SUM(NEO) + SUM(UYDU) AS _sort_tv\r\n        FROM P\r\n    )\r\n    SELECT [BAYİ İSMİ], ISP, NEO, UYDU, [TV Toplam]\r\n    FROM U\r\n    ORDER BY _sort_total, _sort_tv DESC, [BAYİ İSMİ];\r\n    \";\r\n    \r\n    $stmtKurulum = $conn->prepare($sqlKurulum);\r\n    $stmtKurulum->execute([$selectedDate]);\r\n    $bayiKurulumRapor = $stmtKurulum->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    // BAYİ HAFTALIK ORTALAMA sorgusu (son 7 gün ortalaması)\r\n    $sqlHaftalik = \"\r\n    DECLARE @endDate date = ?;\r\n    DECLARE @startDate date = DATEADD(day, -6, @endDate); -- 7 gün (bugün dahil)\r\n    \r\n    WITH P AS (\r\n        SELECT\r\n            TALEBI_GIREN_PERSONEL_ALTBAYI AS [BAYİ İSMİ],\r\n            ISNULL([ISP], 0)  AS ISP,\r\n            ISNULL([NEO], 0)  AS NEO,\r\n            ISNULL([UYDU], 0) AS UYDU,\r\n            ISNULL([NEO], 0) + ISNULL([UYDU], 0) AS [TV Toplam]\r\n        FROM (\r\n            SELECT TALEBI_GIREN_PERSONEL_ALTBAYI, MEMO_KAYIT_TIPI\r\n            FROM digiturk.iris_rapor\r\n            WHERE TALEP_GIRIS_TARIHI >= @startDate\r\n              AND TALEP_GIRIS_TARIHI <= @endDate\r\n        ) AS S\r\n        PIVOT (\r\n            COUNT(MEMO_KAYIT_TIPI)\r\n            FOR MEMO_KAYIT_TIPI IN ([ISP], [NEO], [UYDU])\r\n        ) AS PV\r\n    )\r\n    , U AS (\r\n        SELECT [BAYİ İSMİ], \r\n               CAST(ISP / 7.0 AS DECIMAL(10,1)) AS ISP,\r\n               CAST(NEO / 7.0 AS DECIMAL(10,1)) AS NEO,\r\n               CAST(UYDU / 7.0 AS DECIMAL(10,1)) AS UYDU,\r\n               CAST([TV Toplam] / 7.0 AS DECIMAL(10,1)) AS [TV Toplam],\r\n               CAST(0 AS int) AS _sort_total,\r\n               [TV Toplam] AS _sort_tv\r\n        FROM P\r\n        UNION ALL\r\n        SELECT N'Haftalık Ortalama',\r\n               CAST(SUM(ISP) / 7.0 AS DECIMAL(10,1)),\r\n               CAST(SUM(NEO) / 7.0 AS DECIMAL(10,1)),\r\n               CAST(SUM(UYDU) / 7.0 AS DECIMAL(10,1)),\r\n               CAST((SUM(NEO) + SUM(UYDU)) / 7.0 AS DECIMAL(10,1)),\r\n               1 AS _sort_total,\r\n               SUM(NEO) + SUM(UYDU) AS _sort_tv\r\n        FROM P\r\n    )\r\n    SELECT [BAYİ İSMİ], ISP, NEO, UYDU, [TV Toplam]\r\n    FROM U\r\n    ORDER BY _sort_total, _sort_tv DESC, [BAYİ İSMİ];\r\n    \";\r\n    \r\n    $stmtHaftalik = $conn->prepare($sqlHaftalik);\r\n    $stmtHaftalik->execute([$selectedDate]);\r\n    $bayiHaftalikRapor = $stmtHaftalik->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    // Tüm bayilerin listesini çıkar (Genel Toplam/Haftalık Ortalama hariç)\r\n    $tumBayiler = [];\r\n    foreach ([$bayiRapor, $bayiOnayRapor, $bayiKurulumRapor, $bayiHaftalikRapor] as $rapor) {\r\n        foreach ($rapor as $row) {\r\n            if (!in_array($row['BAYİ İSMİ'], ['Genel Toplam', 'Haftalık Ortalama']) && !in_array($row['BAYİ İSMİ'], $tumBayiler)) {\r\n                $tumBayiler[] = $row['BAYİ İSMİ'];\r\n            }\r\n        }\r\n    }\r\n    sort($tumBayiler);\r\n    \r\n    // Her tablo için normalize et (eksik bayiler için boş satır ekle)\r\n    function normalizeTable($rapor, $tumBayiler, $toplamBaslik) {\r\n        $normalized = [];\r\n        $mevcutBayiler = [];\r\n        $toplamRow = null;\r\n        \r\n        // Mevcut bayileri topla ve toplam satırını ayrı tut\r\n        foreach ($rapor as $row) {\r\n            if ($row['BAYİ İSMİ'] === $toplamBaslik) {\r\n                $toplamRow = $row;\r\n            } else {\r\n                $mevcutBayiler[$row['BAYİ İSMİ']] = $row;\r\n            }\r\n        }\r\n        \r\n        // Tüm bayiler için satır oluştur ve TV Toplam'a göre sırala\r\n        $bayiSatirlari = [];\r\n        foreach ($tumBayiler as $bayi) {\r\n            if (isset($mevcutBayiler[$bayi])) {\r\n                $bayiSatirlari[] = $mevcutBayiler[$bayi];\r\n            } else {\r\n                // Boş satır ekle\r\n                $bayiSatirlari[] = [\r\n                    'BAYİ İSMİ' => $bayi,\r\n                    'ISP' => 0,\r\n                    'NEO' => 0,\r\n                    'UYDU' => 0,\r\n                    'TV Toplam' => 0\r\n                ];\r\n            }\r\n        }\r\n        \r\n        // TV Toplam değerine göre yüksekten düşüğe sırala\r\n        usort($bayiSatirlari, function($a, $b) {\r\n            return $b['TV Toplam'] <=> $a['TV Toplam'];\r\n        });\r\n        \r\n        // Sıralı bayileri normalized array'e ekle\r\n        $normalized = $bayiSatirlari;\r\n        \r\n        // Toplam satırını en sona ekle\r\n        if ($toplamRow) {\r\n            $normalized[] = $toplamRow;\r\n        }\r\n        \r\n        return $normalized;\r\n    }\r\n    \r\n    // Tabloları normalize et\r\n    $bayiRapor = normalizeTable($bayiRapor, $tumBayiler, 'Genel Toplam');\r\n    $bayiOnayRapor = normalizeTable($bayiOnayRapor, $tumBayiler, 'Genel Toplam');\r\n    $bayiKurulumRapor = normalizeTable($bayiKurulumRapor, $tumBayiler, 'Genel Toplam');\r\n    $bayiHaftalikRapor = normalizeTable($bayiHaftalikRapor, $tumBayiler, 'Haftalık Ortalama');\r\n    \r\n    // En son yüklenen dosyanın tarih-saat bilgisini al\r\n    $sonDosyaTarih = '';\r\n    try {\r\n        $sqlSonDosya = \"SELECT TOP 1 dosya_adi FROM digiturk.iris_rapor WHERE dosya_adi IS NOT NULL ORDER BY id DESC\";\r\n        $stmtSonDosya = $conn->prepare($sqlSonDosya);\r\n        $stmtSonDosya->execute();\r\n        $sonDosya = $stmtSonDosya->fetch(PDO::FETCH_ASSOC);\r\n        \r\n        if ($sonDosya && $sonDosya['dosya_adi']) {\r\n            // \"Talep Raporu - Tüm Kayıtlar-27.09.2025 09_50.csv\" formatından tarih-saat çıkar\r\n            if (preg_match('/-(\\d{2}\\.\\d{2}\\.\\d{4})\\s+(\\d{2}_\\d{2})\\.csv$/', $sonDosya['dosya_adi'], $matches)) {\r\n                $tarih = $matches[1]; // 27.09.2025\r\n                $saat = str_replace('_', ':', $matches[2]); // 09:50\r\n                $sonDosyaTarih = \"Rapor Tarihi: \" . $tarih . \" \" . $saat;\r\n            }\r\n        }\r\n    } catch (Exception $e) {\r\n        // Hata durumunda boş bırak\r\n    }\r\n    \r\n} catch (Exception $e) {\r\n    $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n}\r\n\r\ninclude '../../../includes/header.php';\r\n?>\r\n\r\n<div class=\"container-fluid mt-4\">\r\n    <div class=\"row\">\r\n        <div class=\"col-12\">\r\n            <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n                <h2><i class=\"fas fa-shopping-cart me-2\"></i>Bayi Günlük Satış Adet</h2>\r\n                <div class=\"text-muted small\">\r\n                    Tarih: <?php echo date('d.m.Y H:i'); ?>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <?php if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1): ?>\r\n        <div class=\"alert alert-info alert-dismissible fade show\" role=\"alert\">\r\n            <i class=\"fas fa-info-circle me-2\"></i>\r\n            Sadece kendi bayinize ait raporları görüntüleyebilirsiniz.\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n        </div>\r\n    <?php endif; ?>\r\n\r\n    <!-- Tarih Filtresi -->\r\n    <div class=\"row mb-4\">\r\n        <div class=\"col-12\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-body\">\r\n                    <form method=\"POST\" action=\"\" class=\"row g-3 align-items-end\">\r\n                        <div class=\"col-md-4\">\r\n                            <label for=\"selected_date\" class=\"form-label\"><i class=\"fas fa-calendar-alt me-1\"></i>Rapor Tarihi Seçin</label>\r\n                            <input type=\"date\" class=\"form-control\" id=\"selected_date\" name=\"selected_date\" \r\n                                   value=\"<?php echo $selectedDate; ?>\" max=\"<?php echo date('Y-m-d'); ?>\">\r\n                        </div>\r\n                        <div class=\"col-md-3\">\r\n                            <button type=\"submit\" class=\"btn btn-primary\">\r\n                                <i class=\"fas fa-search me-1\"></i>Raporu Göster\r\n                            </button>\r\n                        </div>\r\n                        <div class=\"col-md-5\">\r\n                            <div class=\"d-flex gap-3 align-items-center justify-content-end\">\r\n                                <div class=\"text-end\">\r\n                                    <div class=\"d-flex align-items-center justify-content-end mb-1\">\r\n                                        <small class=\"text-muted me-2\" id=\"report1\"><?php echo $displayDate; ?> Bayi Özet Raporu</small>\r\n                                        <button type=\"button\" class=\"btn btn-sm btn-outline-secondary p-1\" onclick=\"copyToClipboard('report1')\" title=\"Kopyala\">\r\n                                            <i class=\"fas fa-copy\" style=\"font-size: 10px;\"></i>\r\n                                        </button>\r\n                                    </div>\r\n                                    <div class=\"d-flex align-items-center justify-content-end\">\r\n                                        <small class=\"text-muted me-2\" id=\"report2\"><?php echo $displayDate; ?> Kapanış Bayi Özet Raporu</small>\r\n                                        <button type=\"button\" class=\"btn btn-sm btn-outline-secondary p-1\" onclick=\"copyToClipboard('report2')\" title=\"Kopyala\">\r\n                                            <i class=\"fas fa-copy\" style=\"font-size: 10px;\"></i>\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                                <?php if ($sayfaYetkileri['duzenle'] == 1 && !isset($error) && !empty($bayiRapor)): ?>\r\n                                    <button onclick=\"shareScreenshot()\" class=\"btn btn-success\" title=\"Raporu Panoya Kopyala\">\r\n                                        <i class=\"fas fa-copy me-1\"></i>Kopyala\r\n                                    </button>\r\n                                <?php endif; ?>\r\n                            </div>\r\n                        </div>\r\n                    </form>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Tüm Tablolar Container -->\r\n    <div id=\"report-tables\">\r\n        <!-- Üst Sıra: Satış ve Kurulum Tabloları -->\r\n        <div class=\"row\">\r\n        <!-- BAYİ GÜNLÜK SATIŞ ADET Tablosu -->\r\n        <div class=\"col-lg-6\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-header text-white\" style=\"background-color: #4d93d9;\">\r\n                    <h5 class=\"mb-0\">\r\n                        <i class=\"fas fa-table me-2\"></i>BAYİ GÜNLÜK SATIŞ ADET\r\n                    </h5>\r\n                </div>\r\n                <div class=\"card-body p-0\">\r\n                    <?php if (isset($error)): ?>\r\n                        <div class=\"alert alert-danger m-3\">\r\n                            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                            <?php echo htmlspecialchars($error); ?>\r\n                        </div>\r\n                    <?php else: ?>\r\n                        <div class=\"table-responsive\">\r\n                            <table class=\"table table-bordered table-hover mb-0\">\r\n                                <thead class=\"table-dark\">\r\n                                    <tr>\r\n                                        <th class=\"text-center\" style=\"width: 30%;\">BAYİ İSMİ</th>\r\n                                        <th class=\"text-center\">ISP</th>\r\n                                        <th class=\"text-center\">NEO</th>\r\n                                        <th class=\"text-center\">UYDU</th>\r\n                                        <th class=\"text-center\">TV TOPLAM</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    <?php if (!empty($bayiRapor)): ?>\r\n                                        <?php foreach ($bayiRapor as $row): ?>\r\n                                            <tr <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\" class=\"fw-bold\"' : ''; ?>>\r\n                                                <td <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo htmlspecialchars($row['BAYİ İSMİ']); ?></td>\r\n                                                <td class=\"text-center\" <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['ISP']); ?></td>\r\n                                                <td class=\"text-center\" <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['NEO']); ?></td>\r\n                                                <td class=\"text-center\" <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['UYDU']); ?></td>\r\n                                                <td class=\"text-center fw-bold\" <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['TV Toplam']); ?></td>\r\n                                            </tr>\r\n                                        <?php endforeach; ?>\r\n                                    <?php else: ?>\r\n                                        <tr>\r\n                                            <td colspan=\"5\" class=\"text-center py-5 text-muted\">\r\n                                                <i class=\"fas fa-chart-bar fa-3x mb-3 d-block\"></i>\r\n                                                <h5>Veri bulunamadı</h5>\r\n                                                <p>Seçilen tarih aralığında satış verisi bulunmuyor.</p>\r\n                                            </td>\r\n                                        </tr>\r\n                                    <?php endif; ?>\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    <?php endif; ?>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        \r\n        <!-- BAYİ GÜNLÜK KURULUM ADET Tablosu -->\r\n        <div class=\"col-lg-6\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-header text-white\" style=\"background-color: #4d93d9;\">\r\n                    <h5 class=\"mb-0\">\r\n                        <i class=\"fas fa-cogs me-2\"></i>BAYİ GÜNLÜK KURULUM ADET\r\n                    </h5>\r\n                </div>\r\n                <div class=\"card-body p-0\">\r\n                    <?php if (isset($error)): ?>\r\n                        <div class=\"alert alert-danger m-3\">\r\n                            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                            <?php echo htmlspecialchars($error); ?>\r\n                        </div>\r\n                    <?php else: ?>\r\n                        <div class=\"table-responsive\">\r\n                            <table class=\"table table-bordered table-hover mb-0\">\r\n                                <thead class=\"table-dark\">\r\n                                    <tr>\r\n                                        <th class=\"text-center\" style=\"width: 30%;\">BAYİ İSMİ</th>\r\n                                        <th class=\"text-center\">ISP</th>\r\n                                        <th class=\"text-center\">NEO</th>\r\n                                        <th class=\"text-center\">UYDU</th>\r\n                                        <th class=\"text-center\">TV TOPLAM</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    <?php if (!empty($bayiKurulumRapor)): ?>\r\n                                        <?php foreach ($bayiKurulumRapor as $row): ?>\r\n                                            <tr <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\" class=\"fw-bold\"' : ''; ?>>\r\n                                                <td <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo htmlspecialchars($row['BAYİ İSMİ']); ?></td>\r\n                                                <td class=\"text-center\" <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['ISP']); ?></td>\r\n                                                <td class=\"text-center\" <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['NEO']); ?></td>\r\n                                                <td class=\"text-center\" <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['UYDU']); ?></td>\r\n                                                <td class=\"text-center fw-bold\" <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['TV Toplam']); ?></td>\r\n                                            </tr>\r\n                                        <?php endforeach; ?>\r\n                                    <?php else: ?>\r\n                                        <tr>\r\n                                            <td colspan=\"5\" class=\"text-center py-5 text-muted\">\r\n                                                <i class=\"fas fa-chart-bar fa-3x mb-3 d-block\"></i>\r\n                                                <h5>Veri bulunamadı</h5>\r\n                                                <p>Seçilen tarih aralığında kurulum verisi bulunmuyor.</p>\r\n                                            </td>\r\n                                        </tr>\r\n                                    <?php endif; ?>\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    <?php endif; ?>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Alt Sıra: Onay ve Dördüncü Tablo -->\r\n    <div class=\"row mt-4\">\r\n        <!-- BAYİ GÜNLÜK ONAY ADET Tablosu -->\r\n        <div class=\"col-lg-6\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-header text-white\" style=\"background-color: #4d93d9;\">\r\n                    <h5 class=\"mb-0\">\r\n                        <i class=\"fas fa-check-circle me-2\"></i>BAYİ GÜNLÜK ONAY ADET\r\n                    </h5>\r\n                </div>\r\n                <div class=\"card-body p-0\">\r\n                    <?php if (isset($error)): ?>\r\n                        <div class=\"alert alert-danger m-3\">\r\n                            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                            <?php echo htmlspecialchars($error); ?>\r\n                        </div>\r\n                    <?php else: ?>\r\n                        <div class=\"table-responsive\">\r\n                            <table class=\"table table-bordered table-hover mb-0\">\r\n                                <thead class=\"table-dark\">\r\n                                    <tr>\r\n                                        <th class=\"text-center\" style=\"width: 30%;\">BAYİ İSMİ</th>\r\n                                        <th class=\"text-center\">ISP</th>\r\n                                        <th class=\"text-center\">NEO</th>\r\n                                        <th class=\"text-center\">UYDU</th>\r\n                                        <th class=\"text-center\">TV TOPLAM</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    <?php if (!empty($bayiOnayRapor)): ?>\r\n                                        <?php foreach ($bayiOnayRapor as $row): ?>\r\n                                            <tr <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\" class=\"fw-bold\"' : ''; ?>>\r\n                                                <td <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo htmlspecialchars($row['BAYİ İSMİ']); ?></td>\r\n                                                <td class=\"text-center\" <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['ISP']); ?></td>\r\n                                                <td class=\"text-center\" <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['NEO']); ?></td>\r\n                                                <td class=\"text-center\" <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['UYDU']); ?></td>\r\n                                                <td class=\"text-center fw-bold\" <?php echo $row['BAYİ İSMİ'] === 'Genel Toplam' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['TV Toplam']); ?></td>\r\n                                            </tr>\r\n                                        <?php endforeach; ?>\r\n                                    <?php else: ?>\r\n                                        <tr>\r\n                                            <td colspan=\"5\" class=\"text-center py-5 text-muted\">\r\n                                                <i class=\"fas fa-chart-bar fa-3x mb-3 d-block\"></i>\r\n                                                <h5>Veri bulunamadı</h5>\r\n                                                <p>Seçilen tarih aralığında onaylı satış verisi bulunmuyor.</p>\r\n                                            </td>\r\n                                        </tr>\r\n                                    <?php endif; ?>\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    <?php endif; ?>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        \r\n        <!-- BAYİ HAFTALIK ORTALAMA Tablosu -->\r\n        <div class=\"col-lg-6\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-header text-white\" style=\"background-color: #4d93d9;\">\r\n                    <h5 class=\"mb-0\">\r\n                        <i class=\"fas fa-chart-line me-2\"></i>BAYİ HAFTALIK ORTALAMA\r\n                    </h5>\r\n                </div>\r\n                <div class=\"card-body p-0\">\r\n                    <?php if (isset($error)): ?>\r\n                        <div class=\"alert alert-danger m-3\">\r\n                            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                            <?php echo htmlspecialchars($error); ?>\r\n                        </div>\r\n                    <?php else: ?>\r\n                        <div class=\"table-responsive\">\r\n                            <table class=\"table table-bordered table-hover mb-0\">\r\n                                <thead class=\"table-dark\">\r\n                                    <tr>\r\n                                        <th class=\"text-center\" style=\"width: 30%;\">BAYİ İSMİ</th>\r\n                                        <th class=\"text-center\">ISP</th>\r\n                                        <th class=\"text-center\">NEO</th>\r\n                                        <th class=\"text-center\">UYDU</th>\r\n                                        <th class=\"text-center\">TV TOPLAM</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    <?php if (!empty($bayiHaftalikRapor)): ?>\r\n                                        <?php foreach ($bayiHaftalikRapor as $row): ?>\r\n                                            <tr <?php echo $row['BAYİ İSMİ'] === 'Haftalık Ortalama' ? 'style=\"background-color: #104861; color: white;\" class=\"fw-bold\"' : ''; ?>>\r\n                                                <td <?php echo $row['BAYİ İSMİ'] === 'Haftalık Ortalama' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo htmlspecialchars($row['BAYİ İSMİ']); ?></td>\r\n                                                <td class=\"text-center\" <?php echo $row['BAYİ İSMİ'] === 'Haftalık Ortalama' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['ISP'], 1); ?></td>\r\n                                                <td class=\"text-center\" <?php echo $row['BAYİ İSMİ'] === 'Haftalık Ortalama' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['NEO'], 1); ?></td>\r\n                                                <td class=\"text-center\" <?php echo $row['BAYİ İSMİ'] === 'Haftalık Ortalama' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['UYDU'], 1); ?></td>\r\n                                                <td class=\"text-center fw-bold\" <?php echo $row['BAYİ İSMİ'] === 'Haftalık Ortalama' ? 'style=\"background-color: #104861; color: white;\"' : ''; ?>><?php echo number_format($row['TV Toplam'], 1); ?></td>\r\n                                            </tr>\r\n                                        <?php endforeach; ?>\r\n                                    <?php else: ?>\r\n                                        <tr>\r\n                                            <td colspan=\"5\" class=\"text-center py-5 text-muted\">\r\n                                                <i class=\"fas fa-chart-line fa-3x mb-3 d-block\"></i>\r\n                                                <h5>Veri bulunamadı</h5>\r\n                                                <p>Son 7 günde haftalık ortalama verisi bulunmuyor.</p>\r\n                                            </td>\r\n                                        </tr>\r\n                                    <?php endif; ?>\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    <?php endif; ?>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <!-- Report Tables Container Sonu -->\r\n</div>\r\n\r\n<!-- HTML2Canvas CDN -->\r\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js\"></script>\r\n\r\n<script>\r\nfunction shareScreenshot() {\r\n    const element = document.getElementById('report-tables');\r\n    const button = event.target.closest('button');\r\n    \r\n    // Butonu devre dışı bırak ve loading göster\r\n    button.disabled = true;\r\n    button.innerHTML = '<i class=\"fas fa-spinner fa-spin me-1\"></i>Hazırlanıyor...';\r\n    \r\n    // Geçici container oluştur\r\n    const container = document.createElement('div');\r\n    container.style.cssText = 'position: absolute; top: -9999px; left: -9999px; background: white; padding: 20px; width: 1200px; position: relative;';\r\n    container.appendChild(element.cloneNode(true));\r\n    \r\n    // Sağ alt köşeye tarih bilgisi ekle\r\n    <?php if (!empty($sonDosyaTarih)): ?>\r\n    const dateOverlay = document.createElement('div');\r\n    dateOverlay.style.cssText = 'position: absolute; bottom: -2px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 5px; font-size: 12px; font-family: Arial, sans-serif;';\r\n    dateOverlay.textContent = '<?php echo $sonDosyaTarih; ?>';\r\n    container.appendChild(dateOverlay);\r\n    <?php endif; ?>\r\n    \r\n    document.body.appendChild(container);\r\n    \r\n    html2canvas(container, {\r\n        width: 1200,\r\n        height: container.scrollHeight + 40,\r\n        backgroundColor: '#ffffff',\r\n        scale: 2,\r\n        useCORS: true,\r\n        allowTaint: true,\r\n        scrollX: 0,\r\n        scrollY: 0\r\n    }).then(canvas => {\r\n        // Geçici container'ı kaldır\r\n        document.body.removeChild(container);\r\n        \r\n        // Canvas'ı blob'a dönüştür\r\n        canvas.toBlob(blob => {\r\n            // Doğrudan panoya kopyala (sadece panoya kopyalama için native share'i atlıyoruz)\r\n            if (navigator.clipboard && window.ClipboardItem) {\r\n                const item = new ClipboardItem({ 'image/png': blob });\r\n                navigator.clipboard.write([item]).then(() => {\r\n                    // Başarılı kopyalama mesajı göster\r\n                    const alertDiv = document.createElement('div');\r\n                    alertDiv.style.cssText = `\r\n                        position: fixed; top: 20px; right: 20px; z-index: 10000; \r\n                        background: #28a745; color: white; padding: 15px 20px; \r\n                        border-radius: 8px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);\r\n                        animation: slideIn 0.3s ease-out;\r\n                    `;\r\n                    alertDiv.innerHTML = '✅ Rapor panoya kopyalandı! WhatsApp Web\\'te Ctrl+V ile yapıştırabilirsiniz.';\r\n                    \r\n                    // CSS animasyonu ekle\r\n                    if (!document.getElementById('slideInStyle')) {\r\n                        const style = document.createElement('style');\r\n                        style.id = 'slideInStyle';\r\n                        style.textContent = '@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }';\r\n                        document.head.appendChild(style);\r\n                    }\r\n                    \r\n                    document.body.appendChild(alertDiv);\r\n                    \r\n                    // 4 saniye sonra mesajı kaldır\r\n                    setTimeout(() => {\r\n                        if (document.body.contains(alertDiv)) {\r\n                            alertDiv.style.animation = 'slideIn 0.3s ease-out reverse';\r\n                            setTimeout(() => document.body.removeChild(alertDiv), 300);\r\n                        }\r\n                    }, 4000);\r\n                    \r\n                }).catch(err => {\r\n                    console.error('Panoya kopyalama hatası:', err);\r\n                    alert('Tarayıcınız panoya görüntü kopyalamayı desteklemiyor. Lütfen Chrome veya Edge kullanın.');\r\n                });\r\n            } else {\r\n                alert('Tarayıcınız panoya görüntü kopyalamayı desteklemiyor. Lütfen Chrome veya Edge kullanın.');\r\n            }\r\n            \r\n            // Butonu normale döndür\r\n            button.disabled = false;\r\n            button.innerHTML = '<i class=\"fas fa-copy me-1\"></i>Kopyala';\r\n        }, 'image/png');\r\n    }).catch(error => {\r\n        console.error('Screenshot hatası:', error);\r\n        alert('Ekran görüntüsü alınamadı. Lütfen tekrar deneyin.');\r\n        \r\n        // Geçici container'ı temizle\r\n        if (document.body.contains(container)) {\r\n            document.body.removeChild(container);\r\n        }\r\n        \r\n        // Butonu normale döndür\r\n        button.disabled = false;\r\n        button.innerHTML = '<i class=\"fab fa-whatsapp me-1\"></i>Paylaş';\r\n    });\r\n}\r\n\r\n// Kopyalama fonksiyonu\r\nfunction copyToClipboard(elementId) {\r\n    const element = document.getElementById(elementId);\r\n    const text = element.textContent;\r\n    \r\n    navigator.clipboard.writeText(text).then(function() {\r\n        // Başarılı kopyalama feedback'i\r\n        const originalIcon = element.parentElement.querySelector('i');\r\n        const originalClass = originalIcon.className;\r\n        \r\n        // İkonu geçici olarak değiştir\r\n        originalIcon.className = 'fas fa-check text-success';\r\n        \r\n        // 2 saniye sonra eski haline döndür\r\n        setTimeout(() => {\r\n            originalIcon.className = originalClass;\r\n        }, 2000);\r\n    }).catch(function(err) {\r\n        console.error('Kopyalama hatası: ', err);\r\n        alert('Metin kopyalanamadı. Lütfen manuel olarak kopyalayın.');\r\n    });\r\n}\r\n</script>\r\n\r\n<?php include '../../../includes/footer.php'; ?>\r\n"
        }
    ]
}
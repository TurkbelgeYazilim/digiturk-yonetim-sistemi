{
    "sourceFile": "views/Yonetim/IrisRapor/abone_bul.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1761114496989,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1761114732146,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -195,105 +195,201 @@\n                         </div>\r\n                     <?php endif; ?>\r\n                 <?php endif; ?>\r\n \r\n-                <!-- Arama Sonuçları Tablosu -->\r\n+                <!-- Arama Sonuçları - Card Görünüm -->\r\n                 <?php if (count($aboneKayitlar) > 0): ?>\r\n-                <div class=\"table-responsive\">\r\n-                    <table class=\"table table-striped table-hover table-sm\">\r\n-                        <thead class=\"table-dark\">\r\n-                            <tr>\r\n-                                <th>Talep Türü</th>\r\n-                                <th>Potansiyel No</th>\r\n-                                <th>Müşteri No</th>\r\n-                                <th>Memo ID</th>\r\n-                                <th>Kayıt Tipi</th>\r\n-                                <th>Memo ID Tip</th>\r\n-                                <th>Memo Kodu</th>\r\n-                                <th>Kapanış Tarihi</th>\r\n-                                <th>Talep Giriş Tarihi</th>\r\n-                                <th>Bayi Kodu</th>\r\n-                                <th>Bayi Adı</th>\r\n-                                <th>Personel</th>\r\n-                                <th>Personel No</th>\r\n-                                <th>Alt Bayi</th>\r\n-                                <th>Satış Durumu</th>\r\n-                                <th>İnternet Süreç</th>\r\n-                                <th>Aktive Üye No</th>\r\n-                                <th>Outlet Durum</th>\r\n-                                <th>Teyit Durum</th>\r\n-                                <th>Son Durum</th>\r\n-                                <th>Son Cevap</th>\r\n-                                <th>Son Açıklama</th>\r\n-                                <th>Eklenme Tarihi</th>\r\n-                                <th>Dosya Adı</th>\r\n-                            </tr>\r\n-                        </thead>\r\n-                        <tbody>\r\n-                            <?php foreach ($aboneKayitlar as $kayit): ?>\r\n-                            <tr>\r\n-                                <td><?php echo htmlspecialchars($kayit['TALEP_TURU'] ?? ''); ?></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['UYDU_BASVURU_POTANSIYEL_NO'] ?? ''); ?></td>\r\n-                                <td><strong><?php echo htmlspecialchars($kayit['DT_MUSTERI_NO'] ?? ''); ?></strong></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['MEMO_ID'] ?? ''); ?></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['MEMO_KAYIT_TIPI'] ?? ''); ?></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['MEMO_ID_TIP'] ?? ''); ?></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['MEMO_KODU'] ?? ''); ?></td>\r\n-                                <td>\r\n-                                    <?php \r\n-                                    if (!empty($kayit['MEMO_KAPANIS_TARIHI'])) {\r\n-                                        $tarih = new DateTime($kayit['MEMO_KAPANIS_TARIHI']);\r\n-                                        echo $tarih->format('d.m.Y H:i');\r\n-                                    }\r\n-                                    ?>\r\n-                                </td>\r\n-                                <td>\r\n-                                    <?php \r\n-                                    if (!empty($kayit['TALEP_GIRIS_TARIHI'])) {\r\n-                                        $tarih = new DateTime($kayit['TALEP_GIRIS_TARIHI']);\r\n-                                        echo $tarih->format('d.m.Y H:i');\r\n-                                    }\r\n-                                    ?>\r\n-                                </td>\r\n-                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_BAYI_KODU'] ?? ''); ?></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_BAYI_ADI'] ?? ''); ?></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_PERSONEL'] ?? ''); ?></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_PERSONELNO'] ?? ''); ?></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_PERSONEL_ALTBAYI'] ?? ''); ?></td>\r\n-                                <td>\r\n-                                    <span class=\"badge <?php \r\n-                                        echo ($kayit['SATIS_DURUMU'] ?? '') === 'SATILDI' ? 'bg-success' : 'bg-secondary'; \r\n-                                    ?>\">\r\n-                                        <?php echo htmlspecialchars($kayit['SATIS_DURUMU'] ?? ''); ?>\r\n-                                    </span>\r\n-                                </td>\r\n-                                <td><?php echo htmlspecialchars($kayit['INTERNET_SUREC_DURUMU'] ?? ''); ?></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['AKTIVE_EDILEN_UYENO'] ?? ''); ?></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['GUNCEL_OUTLET_DURUM'] ?? ''); ?></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['TEYIT_DURUM'] ?? ''); ?></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['MEMO_SON_DURUM'] ?? ''); ?></td>\r\n-                                <td><?php echo htmlspecialchars($kayit['MEMO_SON_CEVAP'] ?? ''); ?></td>\r\n-                                <td>\r\n-                                    <small class=\"text-muted\">\r\n-                                        <?php \r\n-                                        $aciklama = $kayit['MEMO_SON_ACIKLAMA'] ?? '';\r\n-                                        echo htmlspecialchars(mb_substr($aciklama, 0, 50) . (mb_strlen($aciklama) > 50 ? '...' : ''));\r\n-                                        ?>\r\n-                                    </small>\r\n-                                </td>\r\n-                                <td>\r\n-                                    <?php \r\n-                                    if (!empty($kayit['eklenme_tarihi'])) {\r\n-                                        $tarih = new DateTime($kayit['eklenme_tarihi']);\r\n-                                        echo $tarih->format('d.m.Y H:i');\r\n-                                    }\r\n-                                    ?>\r\n-                                </td>\r\n-                                <td><small><?php echo htmlspecialchars($kayit['dosya_adi'] ?? ''); ?></small></td>\r\n-                            </tr>\r\n-                            <?php endforeach; ?>\r\n-                        </tbody>\r\n-                    </table>\r\n+                <div class=\"row\">\r\n+                    <?php foreach ($aboneKayitlar as $index => $kayit): ?>\r\n+                    <div class=\"col-12 mb-3\">\r\n+                        <div class=\"card\">\r\n+                            <div class=\"card-header bg-light\">\r\n+                                <div class=\"row align-items-center\">\r\n+                                    <div class=\"col-auto\">\r\n+                                        <h6 class=\"mb-0\">\r\n+                                            <span class=\"badge bg-primary\">#<?php echo $index + 1; ?></span>\r\n+                                        </h6>\r\n+                                    </div>\r\n+                                    <div class=\"col\">\r\n+                                        <strong>Müşteri No:</strong> <?php echo htmlspecialchars($kayit['DT_MUSTERI_NO'] ?? ''); ?>\r\n+                                    </div>\r\n+                                    <div class=\"col-auto\">\r\n+                                        <span class=\"badge <?php \r\n+                                            echo ($kayit['SATIS_DURUMU'] ?? '') === 'SATILDI' ? 'bg-success' : 'bg-secondary'; \r\n+                                        ?>\">\r\n+                                            <?php echo htmlspecialchars($kayit['SATIS_DURUMU'] ?? '-'); ?>\r\n+                                        </span>\r\n+                                    </div>\r\n+                                </div>\r\n+                            </div>\r\n+                            <div class=\"card-body\">\r\n+                                <div class=\"row\">\r\n+                                    <!-- Sol Kolon -->\r\n+                                    <div class=\"col-md-4\">\r\n+                                        <h6 class=\"text-primary mb-3\"><i class=\"fas fa-info-circle me-2\"></i>Genel Bilgiler</h6>\r\n+                                        <table class=\"table table-sm table-borderless\">\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\" style=\"width: 50%;\">Talep Türü:</td>\r\n+                                                <td><strong><?php echo htmlspecialchars($kayit['TALEP_TURU'] ?? '-'); ?></strong></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Potansiyel No:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['UYDU_BASVURU_POTANSIYEL_NO'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Memo ID:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['MEMO_ID'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Kayıt Tipi:</td>\r\n+                                                <td><span class=\"badge bg-info\"><?php echo htmlspecialchars($kayit['MEMO_KAYIT_TIPI'] ?? '-'); ?></span></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Memo ID Tip:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['MEMO_ID_TIP'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Memo Kodu:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['MEMO_KODU'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Aktive Üye No:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['AKTIVE_EDILEN_UYENO'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                        </table>\r\n+                                    </div>\r\n+\r\n+                                    <!-- Orta Kolon -->\r\n+                                    <div class=\"col-md-4\">\r\n+                                        <h6 class=\"text-primary mb-3\"><i class=\"fas fa-store me-2\"></i>Bayi Bilgileri</h6>\r\n+                                        <table class=\"table table-sm table-borderless\">\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\" style=\"width: 50%;\">Bayi Kodu:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_BAYI_KODU'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Bayi Adı:</td>\r\n+                                                <td><strong><?php echo htmlspecialchars($kayit['TALEBI_GIREN_BAYI_ADI'] ?? '-'); ?></strong></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Alt Bayi:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_PERSONEL_ALTBAYI'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Personel:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_PERSONEL'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Personel No:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_PERSONELNO'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                        </table>\r\n+\r\n+                                        <h6 class=\"text-primary mb-3 mt-4\"><i class=\"fas fa-calendar me-2\"></i>Tarih Bilgileri</h6>\r\n+                                        <table class=\"table table-sm table-borderless\">\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\" style=\"width: 50%;\">Talep Giriş:</td>\r\n+                                                <td>\r\n+                                                    <?php \r\n+                                                    if (!empty($kayit['TALEP_GIRIS_TARIHI'])) {\r\n+                                                        $tarih = new DateTime($kayit['TALEP_GIRIS_TARIHI']);\r\n+                                                        echo $tarih->format('d.m.Y H:i');\r\n+                                                    } else {\r\n+                                                        echo '-';\r\n+                                                    }\r\n+                                                    ?>\r\n+                                                </td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Kapanış:</td>\r\n+                                                <td>\r\n+                                                    <?php \r\n+                                                    if (!empty($kayit['MEMO_KAPANIS_TARIHI'])) {\r\n+                                                        $tarih = new DateTime($kayit['MEMO_KAPANIS_TARIHI']);\r\n+                                                        echo $tarih->format('d.m.Y H:i');\r\n+                                                    } else {\r\n+                                                        echo '-';\r\n+                                                    }\r\n+                                                    ?>\r\n+                                                </td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Eklenme:</td>\r\n+                                                <td>\r\n+                                                    <?php \r\n+                                                    if (!empty($kayit['eklenme_tarihi'])) {\r\n+                                                        $tarih = new DateTime($kayit['eklenme_tarihi']);\r\n+                                                        echo $tarih->format('d.m.Y H:i');\r\n+                                                    } else {\r\n+                                                        echo '-';\r\n+                                                    }\r\n+                                                    ?>\r\n+                                                </td>\r\n+                                            </tr>\r\n+                                        </table>\r\n+                                    </div>\r\n+\r\n+                                    <!-- Sağ Kolon -->\r\n+                                    <div class=\"col-md-4\">\r\n+                                        <h6 class=\"text-primary mb-3\"><i class=\"fas fa-chart-bar me-2\"></i>Durum Bilgileri</h6>\r\n+                                        <table class=\"table table-sm table-borderless\">\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\" style=\"width: 50%;\">Satış Durumu:</td>\r\n+                                                <td>\r\n+                                                    <span class=\"badge <?php \r\n+                                                        echo ($kayit['SATIS_DURUMU'] ?? '') === 'SATILDI' ? 'bg-success' : 'bg-secondary'; \r\n+                                                    ?>\">\r\n+                                                        <?php echo htmlspecialchars($kayit['SATIS_DURUMU'] ?? '-'); ?>\r\n+                                                    </span>\r\n+                                                </td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">İnternet Süreç:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['INTERNET_SUREC_DURUMU'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Outlet Durum:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['GUNCEL_OUTLET_DURUM'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Teyit Durum:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['TEYIT_DURUM'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Memo Son Durum:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['MEMO_SON_DURUM'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\">Memo Son Cevap:</td>\r\n+                                                <td><?php echo htmlspecialchars($kayit['MEMO_SON_CEVAP'] ?? '-'); ?></td>\r\n+                                            </tr>\r\n+                                        </table>\r\n+\r\n+                                        <h6 class=\"text-primary mb-3 mt-4\"><i class=\"fas fa-file me-2\"></i>Diğer</h6>\r\n+                                        <table class=\"table table-sm table-borderless\">\r\n+                                            <tr>\r\n+                                                <td class=\"text-muted\" style=\"width: 50%;\">Dosya Adı:</td>\r\n+                                                <td><small class=\"text-muted\"><?php echo htmlspecialchars($kayit['dosya_adi'] ?? '-'); ?></small></td>\r\n+                                            </tr>\r\n+                                        </table>\r\n+                                    </div>\r\n+                                </div>\r\n+\r\n+                                <!-- Memo Son Açıklama - Tam Genişlik -->\r\n+                                <?php if (!empty($kayit['MEMO_SON_ACIKLAMA'])): ?>\r\n+                                <div class=\"row mt-3\">\r\n+                                    <div class=\"col-12\">\r\n+                                        <div class=\"alert alert-info mb-0\">\r\n+                                            <strong><i class=\"fas fa-comment-alt me-2\"></i>Memo Son Açıklama:</strong>\r\n+                                            <p class=\"mb-0 mt-2\"><?php echo nl2br(htmlspecialchars($kayit['MEMO_SON_ACIKLAMA'])); ?></p>\r\n+                                        </div>\r\n+                                    </div>\r\n+                                </div>\r\n+                                <?php endif; ?>\r\n+                            </div>\r\n+                        </div>\r\n+                    </div>\r\n+                    <?php endforeach; ?>\r\n                 </div>\r\n                 <?php endif; ?>\r\n             </div>\r\n         </div>\r\n"
                },
                {
                    "date": 1761115345860,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -100,42 +100,97 @@\n     \r\n     try {\r\n         $conn = getDatabaseConnection();\r\n         \r\n-        $sql = \"\r\n-            SELECT \r\n-                [TALEP_TURU],\r\n-                [UYDU_BASVURU_POTANSIYEL_NO],\r\n-                [DT_MUSTERI_NO],\r\n-                [MEMO_ID],\r\n-                [MEMO_KAYIT_TIPI],\r\n-                [MEMO_ID_TIP],\r\n-                [MEMO_KODU],\r\n-                [MEMO_KAPANIS_TARIHI],\r\n-                [TALEP_GIRIS_TARIHI],\r\n-                [TALEBI_GIREN_BAYI_KODU],\r\n-                [TALEBI_GIREN_BAYI_ADI],\r\n-                [TALEBI_GIREN_PERSONEL],\r\n-                [TALEBI_GIREN_PERSONELNO],\r\n-                [TALEBI_GIREN_PERSONEL_ALTBAYI],\r\n-                [SATIS_DURUMU],\r\n-                [INTERNET_SUREC_DURUMU],\r\n-                [AKTIVE_EDILEN_UYENO],\r\n-                [GUNCEL_OUTLET_DURUM],\r\n-                [TEYIT_DURUM],\r\n-                [MEMO_SON_DURUM],\r\n-                [MEMO_SON_CEVAP],\r\n-                [MEMO_SON_ACIKLAMA],\r\n-                [eklenme_tarihi],\r\n-                [dosya_adi]\r\n-            FROM [digiturk].[iris_rapor]\r\n-            WHERE [DT_MUSTERI_NO] = ?\r\n-            ORDER BY [TALEP_GIRIS_TARIHI] DESC\r\n-        \";\r\n+        // kendi_kullanicini_gor = 1 ise sadece kendi giriş yaptığı kayıtları getir\r\n+        if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1) {\r\n+            // Kullanıcının bayi kodunu al\r\n+            $bayiKoduSql = \"SELECT bayi_kodu FROM users WHERE id = ?\";\r\n+            $bayiKoduStmt = $conn->prepare($bayiKoduSql);\r\n+            $bayiKoduStmt->execute([$currentUser['id']]);\r\n+            $bayiKoduResult = $bayiKoduStmt->fetch(PDO::FETCH_ASSOC);\r\n+            $userBayiKodu = $bayiKoduResult['bayi_kodu'] ?? null;\r\n+            \r\n+            if ($userBayiKodu) {\r\n+                $sql = \"\r\n+                    SELECT \r\n+                        [TALEP_TURU],\r\n+                        [UYDU_BASVURU_POTANSIYEL_NO],\r\n+                        [DT_MUSTERI_NO],\r\n+                        [MEMO_ID],\r\n+                        [MEMO_KAYIT_TIPI],\r\n+                        [MEMO_ID_TIP],\r\n+                        [MEMO_KODU],\r\n+                        [MEMO_KAPANIS_TARIHI],\r\n+                        [TALEP_GIRIS_TARIHI],\r\n+                        [TALEBI_GIREN_BAYI_KODU],\r\n+                        [TALEBI_GIREN_BAYI_ADI],\r\n+                        [TALEBI_GIREN_PERSONEL],\r\n+                        [TALEBI_GIREN_PERSONELNO],\r\n+                        [TALEBI_GIREN_PERSONEL_ALTBAYI],\r\n+                        [SATIS_DURUMU],\r\n+                        [INTERNET_SUREC_DURUMU],\r\n+                        [AKTIVE_EDILEN_UYENO],\r\n+                        [GUNCEL_OUTLET_DURUM],\r\n+                        [TEYIT_DURUM],\r\n+                        [MEMO_SON_DURUM],\r\n+                        [MEMO_SON_CEVAP],\r\n+                        [MEMO_SON_ACIKLAMA],\r\n+                        [eklenme_tarihi],\r\n+                        [dosya_adi]\r\n+                    FROM [digiturk].[iris_rapor]\r\n+                    WHERE [DT_MUSTERI_NO] = ?\r\n+                    AND [TALEBI_GIREN_BAYI_KODU] = ?\r\n+                    ORDER BY [TALEP_GIRIS_TARIHI] DESC\r\n+                \";\r\n+                \r\n+                $stmt = $conn->prepare($sql);\r\n+                $stmt->execute([$musteriNo, $userBayiKodu]);\r\n+            } else {\r\n+                // Bayi kodu bulunamazsa boş sonuç döndür\r\n+                $aboneKayitlar = [];\r\n+                $stmt = null;\r\n+            }\r\n+        } else {\r\n+            // kendi_kullanicini_gor = 0 ise tüm kayıtları getir\r\n+            $sql = \"\r\n+                SELECT \r\n+                    [TALEP_TURU],\r\n+                    [UYDU_BASVURU_POTANSIYEL_NO],\r\n+                    [DT_MUSTERI_NO],\r\n+                    [MEMO_ID],\r\n+                    [MEMO_KAYIT_TIPI],\r\n+                    [MEMO_ID_TIP],\r\n+                    [MEMO_KODU],\r\n+                    [MEMO_KAPANIS_TARIHI],\r\n+                    [TALEP_GIRIS_TARIHI],\r\n+                    [TALEBI_GIREN_BAYI_KODU],\r\n+                    [TALEBI_GIREN_BAYI_ADI],\r\n+                    [TALEBI_GIREN_PERSONEL],\r\n+                    [TALEBI_GIREN_PERSONELNO],\r\n+                    [TALEBI_GIREN_PERSONEL_ALTBAYI],\r\n+                    [SATIS_DURUMU],\r\n+                    [INTERNET_SUREC_DURUMU],\r\n+                    [AKTIVE_EDILEN_UYENO],\r\n+                    [GUNCEL_OUTLET_DURUM],\r\n+                    [TEYIT_DURUM],\r\n+                    [MEMO_SON_DURUM],\r\n+                    [MEMO_SON_CEVAP],\r\n+                    [MEMO_SON_ACIKLAMA],\r\n+                    [eklenme_tarihi],\r\n+                    [dosya_adi]\r\n+                FROM [digiturk].[iris_rapor]\r\n+                WHERE [DT_MUSTERI_NO] = ?\r\n+                ORDER BY [TALEP_GIRIS_TARIHI] DESC\r\n+            \";\r\n+            \r\n+            $stmt = $conn->prepare($sql);\r\n+            $stmt->execute([$musteriNo]);\r\n+        }\r\n         \r\n-        $stmt = $conn->prepare($sql);\r\n-        $stmt->execute([$musteriNo]);\r\n-        $aboneKayitlar = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n+        if ($stmt) {\r\n+            $aboneKayitlar = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n+        }\r\n         \r\n     } catch (Exception $e) {\r\n         $errorMessage = \"Arama sırasında bir hata oluştu: \" . $e->getMessage();\r\n         error_log($errorMessage);\r\n@@ -154,8 +209,16 @@\n                     <i class=\"fas fa-search me-2\"></i>Abone Bul\r\n                 </h5>\r\n             </div>\r\n             <div class=\"card-body\">\r\n+                <!-- Yetki Bilgilendirme -->\r\n+                <?php if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1): ?>\r\n+                <div class=\"alert alert-info mb-4\">\r\n+                    <i class=\"fas fa-info-circle me-2\"></i>\r\n+                    Sadece kendi bayi kodunuzla giriş yapılmış kayıtları görüntüleyebilirsiniz.\r\n+                </div>\r\n+                <?php endif; ?>\r\n+\r\n                 <!-- Arama Formu -->\r\n                 <form method=\"POST\" class=\"mb-4\">\r\n                     <div class=\"row g-3 align-items-end\">\r\n                         <div class=\"col-md-6\">\r\n@@ -190,9 +253,13 @@\n                         </div>\r\n                     <?php else: ?>\r\n                         <div class=\"alert alert-warning\">\r\n                             <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n-                            <strong><?php echo htmlspecialchars($musteriNo); ?></strong> müşteri numarası için kayıt bulunamadı.\r\n+                            <strong><?php echo htmlspecialchars($musteriNo); ?></strong> müşteri numarası için \r\n+                            <?php if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1): ?>\r\n+                                kendi bayi kodunuza ait \r\n+                            <?php endif; ?>\r\n+                            kayıt bulunamadı.\r\n                         </div>\r\n                     <?php endif; ?>\r\n                 <?php endif; ?>\r\n \r\n"
                },
                {
                    "date": 1761115420032,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,16 +1,31 @@\n <?php\r\n-$pageTitle = \"Abone Bul\";\r\n-$breadcrumbs = [\r\n-    ['title' => 'Abone Bul']\r\n-];\r\n-\r\n // Auth kontrol\r\n require_once '../../../auth.php';\r\n $currentUser = checkAuth();\r\n checkUserStatus();\r\n updateLastActivity();\r\n \r\n+// Sayfa başlığını veritabanından al\r\n+$pageTitle = \"Abone Bul\"; // Varsayılan\r\n+try {\r\n+    $conn = getDatabaseConnection();\r\n+    $currentPageUrl = basename($_SERVER['PHP_SELF']);\r\n+    $sayfaSql = \"SELECT sayfa_adi FROM dbo.tanim_sayfalar WHERE sayfa_url = ? AND durum = 1\";\r\n+    $sayfaStmt = $conn->prepare($sayfaSql);\r\n+    $sayfaStmt->execute([$currentPageUrl]);\r\n+    $sayfaResult = $sayfaStmt->fetch(PDO::FETCH_ASSOC);\r\n+    if ($sayfaResult && !empty($sayfaResult['sayfa_adi'])) {\r\n+        $pageTitle = $sayfaResult['sayfa_adi'];\r\n+    }\r\n+} catch (Exception $e) {\r\n+    error_log(\"Sayfa başlığı alınamadı: \" . $e->getMessage());\r\n+}\r\n+\r\n+$breadcrumbs = [\r\n+    ['title' => $pageTitle]\r\n+];\r\n+\r\n // Sayfa yetkilendirme kontrolü\r\n $sayfaYetkileri = [\r\n     'gor' => false,\r\n     'kendi_kullanicini_gor' => false,\r\n@@ -205,9 +220,9 @@\n     <div class=\"col-12\">\r\n         <div class=\"card shadow-sm\">\r\n             <div class=\"card-header bg-primary text-white\">\r\n                 <h5 class=\"mb-0\">\r\n-                    <i class=\"fas fa-search me-2\"></i>Abone Bul\r\n+                    <i class=\"fas fa-search me-2\"></i><?php echo htmlspecialchars($pageTitle); ?>\r\n                 </h5>\r\n             </div>\r\n             <div class=\"card-body\">\r\n                 <!-- Yetki Bilgilendirme -->\r\n"
                }
            ],
            "date": 1761114496989,
            "name": "Commit-0",
            "content": "<?php\r\n$pageTitle = \"Abone Bul\";\r\n$breadcrumbs = [\r\n    ['title' => 'Abone Bul']\r\n];\r\n\r\n// Auth kontrol\r\nrequire_once '../../../auth.php';\r\n$currentUser = checkAuth();\r\ncheckUserStatus();\r\nupdateLastActivity();\r\n\r\n// Sayfa yetkilendirme kontrolü\r\n$sayfaYetkileri = [\r\n    'gor' => false,\r\n    'kendi_kullanicini_gor' => false,\r\n    'ekle' => false,\r\n    'duzenle' => false,\r\n    'sil' => false\r\n];\r\n\r\n// Admin kontrolü (group_id = 1 ise tüm yetkilere sahip)\r\n$isAdmin = ($currentUser['group_id'] == 1);\r\n\r\nif ($isAdmin) {\r\n    // Admin için tüm yetkileri aç\r\n    $sayfaYetkileri = [\r\n        'gor' => 1,\r\n        'kendi_kullanicini_gor' => 0,\r\n        'ekle' => 1,\r\n        'duzenle' => 1,\r\n        'sil' => 1\r\n    ];\r\n} else {\r\n    // Admin değilse normal yetki kontrolü yap\r\n    try {\r\n        $conn = getDatabaseConnection();\r\n        \r\n        // Mevcut sayfa URL'sini al\r\n        $currentPageUrl = basename($_SERVER['PHP_SELF']);\r\n        \r\n        // Sayfa bilgisini ve yetkilerini çek\r\n        $yetkiSql = \"\r\n            SELECT \r\n                tsy.gor,\r\n                tsy.kendi_kullanicini_gor,\r\n                tsy.ekle,\r\n                tsy.duzenle,\r\n                tsy.sil,\r\n                tsy.durum as yetki_durum,\r\n                ts.durum as sayfa_durum\r\n            FROM dbo.tanim_sayfalar ts\r\n            INNER JOIN dbo.tanim_sayfa_yetkiler tsy ON ts.sayfa_id = tsy.sayfa_id\r\n            WHERE ts.sayfa_url = ?\r\n            AND tsy.user_group_id = ?\r\n            AND ts.durum = 1\r\n            AND tsy.durum = 1\r\n        \";\r\n        \r\n        $yetkiStmt = $conn->prepare($yetkiSql);\r\n        $yetkiStmt->execute([$currentPageUrl, $currentUser['group_id']]);\r\n        $yetkiResult = $yetkiStmt->fetch(PDO::FETCH_ASSOC);\r\n        \r\n        if ($yetkiResult) {\r\n            $sayfaYetkileri = [\r\n                'gor' => (int)$yetkiResult['gor'],\r\n                'kendi_kullanicini_gor' => (int)$yetkiResult['kendi_kullanicini_gor'],\r\n                'ekle' => (int)$yetkiResult['ekle'],\r\n                'duzenle' => (int)$yetkiResult['duzenle'],\r\n                'sil' => (int)$yetkiResult['sil']\r\n            ];\r\n            \r\n            // Görme yetkisi yoksa (0 ise) sayfaya erişimi engelle\r\n            if ($sayfaYetkileri['gor'] == 0) {\r\n                header('Location: ../../../index.php?error=yetki_yok');\r\n                exit;\r\n            }\r\n        } else {\r\n            // Yetki tanımı bulunamazsa erişimi engelle\r\n            header('Location: ../../../index.php?error=yetki_tanimlanmamis');\r\n            exit;\r\n        }\r\n        \r\n    } catch (Exception $e) {\r\n        // Hata durumunda güvenlik için erişimi engelle\r\n        error_log(\"Yetki kontrol hatası: \" . $e->getMessage());\r\n        header('Location: ../../../index.php?error=sistem_hatasi');\r\n        exit;\r\n    }\r\n}\r\n\r\n// Abone arama işlemi\r\n$aboneKayitlar = [];\r\n$musteriNo = '';\r\n$aramaYapildi = false;\r\n\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['musteri_no']) && !empty($_POST['musteri_no'])) {\r\n    $musteriNo = trim($_POST['musteri_no']);\r\n    $aramaYapildi = true;\r\n    \r\n    try {\r\n        $conn = getDatabaseConnection();\r\n        \r\n        $sql = \"\r\n            SELECT \r\n                [TALEP_TURU],\r\n                [UYDU_BASVURU_POTANSIYEL_NO],\r\n                [DT_MUSTERI_NO],\r\n                [MEMO_ID],\r\n                [MEMO_KAYIT_TIPI],\r\n                [MEMO_ID_TIP],\r\n                [MEMO_KODU],\r\n                [MEMO_KAPANIS_TARIHI],\r\n                [TALEP_GIRIS_TARIHI],\r\n                [TALEBI_GIREN_BAYI_KODU],\r\n                [TALEBI_GIREN_BAYI_ADI],\r\n                [TALEBI_GIREN_PERSONEL],\r\n                [TALEBI_GIREN_PERSONELNO],\r\n                [TALEBI_GIREN_PERSONEL_ALTBAYI],\r\n                [SATIS_DURUMU],\r\n                [INTERNET_SUREC_DURUMU],\r\n                [AKTIVE_EDILEN_UYENO],\r\n                [GUNCEL_OUTLET_DURUM],\r\n                [TEYIT_DURUM],\r\n                [MEMO_SON_DURUM],\r\n                [MEMO_SON_CEVAP],\r\n                [MEMO_SON_ACIKLAMA],\r\n                [eklenme_tarihi],\r\n                [dosya_adi]\r\n            FROM [digiturk].[iris_rapor]\r\n            WHERE [DT_MUSTERI_NO] = ?\r\n            ORDER BY [TALEP_GIRIS_TARIHI] DESC\r\n        \";\r\n        \r\n        $stmt = $conn->prepare($sql);\r\n        $stmt->execute([$musteriNo]);\r\n        $aboneKayitlar = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n        \r\n    } catch (Exception $e) {\r\n        $errorMessage = \"Arama sırasında bir hata oluştu: \" . $e->getMessage();\r\n        error_log($errorMessage);\r\n    }\r\n}\r\n\r\n// Header dahil et\r\nrequire_once '../../../includes/header.php';\r\n?>\r\n\r\n<div class=\"row\">\r\n    <div class=\"col-12\">\r\n        <div class=\"card shadow-sm\">\r\n            <div class=\"card-header bg-primary text-white\">\r\n                <h5 class=\"mb-0\">\r\n                    <i class=\"fas fa-search me-2\"></i>Abone Bul\r\n                </h5>\r\n            </div>\r\n            <div class=\"card-body\">\r\n                <!-- Arama Formu -->\r\n                <form method=\"POST\" class=\"mb-4\">\r\n                    <div class=\"row g-3 align-items-end\">\r\n                        <div class=\"col-md-6\">\r\n                            <label for=\"musteri_no\" class=\"form-label\">Müşteri No</label>\r\n                            <input type=\"text\" \r\n                                   class=\"form-control\" \r\n                                   id=\"musteri_no\" \r\n                                   name=\"musteri_no\" \r\n                                   value=\"<?php echo htmlspecialchars($musteriNo); ?>\"\r\n                                   placeholder=\"Müşteri numarası girin\" \r\n                                   required>\r\n                        </div>\r\n                        <div class=\"col-md-6\">\r\n                            <button type=\"submit\" class=\"btn btn-primary\">\r\n                                <i class=\"fas fa-search me-2\"></i>Ara\r\n                            </button>\r\n                            <?php if ($aramaYapildi): ?>\r\n                            <a href=\"abone_bul.php\" class=\"btn btn-secondary\">\r\n                                <i class=\"fas fa-redo me-2\"></i>Temizle\r\n                            </a>\r\n                            <?php endif; ?>\r\n                        </div>\r\n                    </div>\r\n                </form>\r\n\r\n                <!-- Sonuç Mesajı -->\r\n                <?php if ($aramaYapildi): ?>\r\n                    <?php if (count($aboneKayitlar) > 0): ?>\r\n                        <div class=\"alert alert-success\">\r\n                            <i class=\"fas fa-check-circle me-2\"></i>\r\n                            <strong><?php echo count($aboneKayitlar); ?></strong> kayıt bulundu.\r\n                        </div>\r\n                    <?php else: ?>\r\n                        <div class=\"alert alert-warning\">\r\n                            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                            <strong><?php echo htmlspecialchars($musteriNo); ?></strong> müşteri numarası için kayıt bulunamadı.\r\n                        </div>\r\n                    <?php endif; ?>\r\n                <?php endif; ?>\r\n\r\n                <!-- Arama Sonuçları Tablosu -->\r\n                <?php if (count($aboneKayitlar) > 0): ?>\r\n                <div class=\"table-responsive\">\r\n                    <table class=\"table table-striped table-hover table-sm\">\r\n                        <thead class=\"table-dark\">\r\n                            <tr>\r\n                                <th>Talep Türü</th>\r\n                                <th>Potansiyel No</th>\r\n                                <th>Müşteri No</th>\r\n                                <th>Memo ID</th>\r\n                                <th>Kayıt Tipi</th>\r\n                                <th>Memo ID Tip</th>\r\n                                <th>Memo Kodu</th>\r\n                                <th>Kapanış Tarihi</th>\r\n                                <th>Talep Giriş Tarihi</th>\r\n                                <th>Bayi Kodu</th>\r\n                                <th>Bayi Adı</th>\r\n                                <th>Personel</th>\r\n                                <th>Personel No</th>\r\n                                <th>Alt Bayi</th>\r\n                                <th>Satış Durumu</th>\r\n                                <th>İnternet Süreç</th>\r\n                                <th>Aktive Üye No</th>\r\n                                <th>Outlet Durum</th>\r\n                                <th>Teyit Durum</th>\r\n                                <th>Son Durum</th>\r\n                                <th>Son Cevap</th>\r\n                                <th>Son Açıklama</th>\r\n                                <th>Eklenme Tarihi</th>\r\n                                <th>Dosya Adı</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            <?php foreach ($aboneKayitlar as $kayit): ?>\r\n                            <tr>\r\n                                <td><?php echo htmlspecialchars($kayit['TALEP_TURU'] ?? ''); ?></td>\r\n                                <td><?php echo htmlspecialchars($kayit['UYDU_BASVURU_POTANSIYEL_NO'] ?? ''); ?></td>\r\n                                <td><strong><?php echo htmlspecialchars($kayit['DT_MUSTERI_NO'] ?? ''); ?></strong></td>\r\n                                <td><?php echo htmlspecialchars($kayit['MEMO_ID'] ?? ''); ?></td>\r\n                                <td><?php echo htmlspecialchars($kayit['MEMO_KAYIT_TIPI'] ?? ''); ?></td>\r\n                                <td><?php echo htmlspecialchars($kayit['MEMO_ID_TIP'] ?? ''); ?></td>\r\n                                <td><?php echo htmlspecialchars($kayit['MEMO_KODU'] ?? ''); ?></td>\r\n                                <td>\r\n                                    <?php \r\n                                    if (!empty($kayit['MEMO_KAPANIS_TARIHI'])) {\r\n                                        $tarih = new DateTime($kayit['MEMO_KAPANIS_TARIHI']);\r\n                                        echo $tarih->format('d.m.Y H:i');\r\n                                    }\r\n                                    ?>\r\n                                </td>\r\n                                <td>\r\n                                    <?php \r\n                                    if (!empty($kayit['TALEP_GIRIS_TARIHI'])) {\r\n                                        $tarih = new DateTime($kayit['TALEP_GIRIS_TARIHI']);\r\n                                        echo $tarih->format('d.m.Y H:i');\r\n                                    }\r\n                                    ?>\r\n                                </td>\r\n                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_BAYI_KODU'] ?? ''); ?></td>\r\n                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_BAYI_ADI'] ?? ''); ?></td>\r\n                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_PERSONEL'] ?? ''); ?></td>\r\n                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_PERSONELNO'] ?? ''); ?></td>\r\n                                <td><?php echo htmlspecialchars($kayit['TALEBI_GIREN_PERSONEL_ALTBAYI'] ?? ''); ?></td>\r\n                                <td>\r\n                                    <span class=\"badge <?php \r\n                                        echo ($kayit['SATIS_DURUMU'] ?? '') === 'SATILDI' ? 'bg-success' : 'bg-secondary'; \r\n                                    ?>\">\r\n                                        <?php echo htmlspecialchars($kayit['SATIS_DURUMU'] ?? ''); ?>\r\n                                    </span>\r\n                                </td>\r\n                                <td><?php echo htmlspecialchars($kayit['INTERNET_SUREC_DURUMU'] ?? ''); ?></td>\r\n                                <td><?php echo htmlspecialchars($kayit['AKTIVE_EDILEN_UYENO'] ?? ''); ?></td>\r\n                                <td><?php echo htmlspecialchars($kayit['GUNCEL_OUTLET_DURUM'] ?? ''); ?></td>\r\n                                <td><?php echo htmlspecialchars($kayit['TEYIT_DURUM'] ?? ''); ?></td>\r\n                                <td><?php echo htmlspecialchars($kayit['MEMO_SON_DURUM'] ?? ''); ?></td>\r\n                                <td><?php echo htmlspecialchars($kayit['MEMO_SON_CEVAP'] ?? ''); ?></td>\r\n                                <td>\r\n                                    <small class=\"text-muted\">\r\n                                        <?php \r\n                                        $aciklama = $kayit['MEMO_SON_ACIKLAMA'] ?? '';\r\n                                        echo htmlspecialchars(mb_substr($aciklama, 0, 50) . (mb_strlen($aciklama) > 50 ? '...' : ''));\r\n                                        ?>\r\n                                    </small>\r\n                                </td>\r\n                                <td>\r\n                                    <?php \r\n                                    if (!empty($kayit['eklenme_tarihi'])) {\r\n                                        $tarih = new DateTime($kayit['eklenme_tarihi']);\r\n                                        echo $tarih->format('d.m.Y H:i');\r\n                                    }\r\n                                    ?>\r\n                                </td>\r\n                                <td><small><?php echo htmlspecialchars($kayit['dosya_adi'] ?? ''); ?></small></td>\r\n                            </tr>\r\n                            <?php endforeach; ?>\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n                <?php endif; ?>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<?php\r\n// Footer dahil et\r\nrequire_once '../../../includes/footer.php';\r\n?>\r\n"
        }
    ]
}
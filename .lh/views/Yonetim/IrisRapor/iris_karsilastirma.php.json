{
    "sourceFile": "views/Yonetim/IrisRapor/iris_karsilastirma.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1761060077591,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1761060077591,
            "name": "Commit-0",
            "content": "<?php\r\n// Enable error reporting for debugging\r\nerror_reporting(E_ALL);\r\nini_set('display_errors', 1);\r\nini_set('log_errors', 1);\r\n\r\nrequire_once '../../../auth.php';\r\n\r\n// Kullanıcı kimlik doğrulaması\r\n$currentUser = checkAuth();\r\ncheckUserStatus();\r\nupdateLastActivity();\r\n\r\n// Sayfa yetkilendirme kontrolü\r\n$sayfaYetkileri = [\r\n    'gor' => false,\r\n    'kendi_kullanicini_gor' => false,\r\n    'ekle' => false,\r\n    'duzenle' => false,\r\n    'sil' => false\r\n];\r\n\r\n// Admin kontrolü (group_id = 1 ise tüm yetkilere sahip)\r\n$isAdmin = ($currentUser['group_id'] == 1);\r\n\r\nif ($isAdmin) {\r\n    // Admin için tüm yetkileri aç\r\n    $sayfaYetkileri = [\r\n        'gor' => 1,\r\n        'kendi_kullanicini_gor' => 0,\r\n        'ekle' => 1,\r\n        'duzenle' => 1,\r\n        'sil' => 1\r\n    ];\r\n} else {\r\n    // Admin değilse normal yetki kontrolü yap\r\n    try {\r\n        $conn = getDatabaseConnection();\r\n        \r\n        // Mevcut sayfa URL'sini al\r\n        $currentPageUrl = basename($_SERVER['PHP_SELF']);\r\n        \r\n        // Sayfa bilgisini ve yetkilerini çek\r\n        $yetkiSql = \"\r\n            SELECT \r\n                tsy.gor,\r\n                tsy.kendi_kullanicini_gor,\r\n                tsy.ekle,\r\n                tsy.duzenle,\r\n                tsy.sil,\r\n                tsy.durum as yetki_durum,\r\n                ts.durum as sayfa_durum\r\n            FROM dbo.tanim_sayfalar ts\r\n            INNER JOIN dbo.tanim_sayfa_yetkiler tsy ON ts.sayfa_id = tsy.sayfa_id\r\n            WHERE ts.sayfa_url = ?\r\n            AND tsy.user_group_id = ?\r\n            AND ts.durum = 1\r\n            AND tsy.durum = 1\r\n        \";\r\n        \r\n        $yetkiStmt = $conn->prepare($yetkiSql);\r\n        $yetkiStmt->execute([$currentPageUrl, $currentUser['group_id']]);\r\n        $yetkiResult = $yetkiStmt->fetch(PDO::FETCH_ASSOC);\r\n        \r\n        if ($yetkiResult) {\r\n            $sayfaYetkileri = [\r\n                'gor' => (int)$yetkiResult['gor'],\r\n                'kendi_kullanicini_gor' => (int)$yetkiResult['kendi_kullanicini_gor'],\r\n                'ekle' => (int)$yetkiResult['ekle'],\r\n                'duzenle' => (int)$yetkiResult['duzenle'],\r\n                'sil' => (int)$yetkiResult['sil']\r\n            ];\r\n            \r\n            // Görme yetkisi yoksa (0 ise) sayfaya erişimi engelle\r\n            if ($sayfaYetkileri['gor'] == 0) {\r\n                header('Location: ../../../index.php?error=yetki_yok');\r\n                exit;\r\n            }\r\n        } else {\r\n            // Yetki tanımı bulunamazsa erişimi engelle\r\n            header('Location: ../../../index.php?error=yetki_tanimlanmamis');\r\n            exit;\r\n        }\r\n        \r\n    } catch (Exception $e) {\r\n        // Hata durumunda güvenlik için erişimi engelle\r\n        error_log(\"Yetki kontrol hatası: \" . $e->getMessage());\r\n        header('Location: ../../../index.php?error=sistem_hatasi');\r\n        exit;\r\n    }\r\n}\r\n\r\n// Sayfa başlığı ve breadcrumb\r\n$pageTitle = 'Iris Karşılaştırma';\r\n$breadcrumbs = [\r\n    ['title' => 'Iris Karşılaştırma']\r\n];\r\n\r\n// Değişkenleri başlat\r\n$duplicates = [];\r\n$totalDuplicateMemos = 0;\r\n$totalDuplicateRecords = 0;\r\n$error = null;\r\n\r\n// Veritabanı bağlantısı\r\ntry {\r\n    $conn = getDatabaseConnection();\r\n    \r\n    // Önce tablo ve sütunların varlığını kontrol et\r\n    $checkTableSql = \"SELECT COUNT(*) as table_exists FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'digiturk' AND TABLE_NAME = 'iris_rapor'\";\r\n    $checkStmt = $conn->prepare($checkTableSql);\r\n    $checkStmt->execute();\r\n    $tableCheck = $checkStmt->fetch();\r\n    \r\n    if ($tableCheck['table_exists'] == 0) {\r\n        throw new Exception('iris_rapor tablosu bulunamadı. Lütfen önce raporları yükleyiniz.');\r\n    }\r\n    \r\n    // Gerekli sütunların varlığını kontrol et\r\n    $checkColumnsSql = \"\r\n        SELECT COLUMN_NAME \r\n        FROM INFORMATION_SCHEMA.COLUMNS \r\n        WHERE TABLE_SCHEMA = 'digiturk' AND TABLE_NAME = 'iris_rapor' \r\n        AND COLUMN_NAME IN ('MEMO_ID', 'GUNCEL_OUTLET_DURUM', 'TEYIT_DURUM', 'dosya_adi', 'eklenme_tarihi', 'guncellenme_tarihi')\r\n    \";\r\n    $checkColStmt = $conn->prepare($checkColumnsSql);\r\n    $checkColStmt->execute();\r\n    $columns = $checkColStmt->fetchAll();\r\n    \r\n    if (count($columns) < 4) { // En az temel sütunlar olmalı\r\n        throw new Exception('iris_rapor tablosunda gerekli sütunlar bulunamadı. Tablo yapısı eksik veya hatalı.');\r\n    }\r\n    \r\n    // Mükerrer MEMO_ID'leri getir\r\n    $sql = \"\r\n        WITH DuplicateMemos AS (\r\n            SELECT MEMO_ID, COUNT(*) as kayit_sayisi\r\n            FROM digiturk.iris_rapor \r\n            WHERE MEMO_ID IS NOT NULL AND MEMO_ID != ''\r\n            GROUP BY MEMO_ID\r\n            HAVING COUNT(*) > 1\r\n        )\r\n        SELECT \r\n            ISNULL(ir.dosya_adi, 'Belirtilmemiş') as 'Dosya Adı',\r\n            ir.MEMO_ID as 'Memo ID',\r\n            ISNULL(ir.GUNCEL_OUTLET_DURUM, '') as 'Güncel Outlet',\r\n            ISNULL(ir.TEYIT_DURUM, '') as 'Teyit Durumu',\r\n            ir.eklenme_tarihi as 'Eklenme Tarihi',\r\n            ir.guncellenme_tarihi as 'Güncellenme Tarihi',\r\n            dm.kayit_sayisi as 'Toplam Kayıt Sayısı'\r\n        FROM digiturk.iris_rapor ir\r\n        INNER JOIN DuplicateMemos dm ON ir.MEMO_ID = dm.MEMO_ID\r\n        ORDER BY ir.MEMO_ID, ir.eklenme_tarihi DESC\r\n    \";\r\n    \r\n    $stmt = $conn->prepare($sql);\r\n    $stmt->execute();\r\n    $duplicates = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    // Toplam mükerrer MEMO_ID sayısı\r\n    $countSql = \"\r\n        SELECT COUNT(DISTINCT MEMO_ID) as total_duplicate_memos,\r\n               SUM(kayit_sayisi) as total_duplicate_records\r\n        FROM (\r\n            SELECT MEMO_ID, COUNT(*) as kayit_sayisi\r\n            FROM digiturk.iris_rapor \r\n            WHERE MEMO_ID IS NOT NULL AND MEMO_ID != ''\r\n            GROUP BY MEMO_ID\r\n            HAVING COUNT(*) > 1\r\n        ) as temp\r\n    \";\r\n    \r\n    $countStmt = $conn->prepare($countSql);\r\n    $countStmt->execute();\r\n    $stats = $countStmt->fetch(PDO::FETCH_ASSOC);\r\n    \r\n    $totalDuplicateMemos = $stats['total_duplicate_memos'] ?? 0;\r\n    $totalDuplicateRecords = $stats['total_duplicate_records'] ?? 0;\r\n\r\n} catch (Exception $e) {\r\n    $error = \"Hata oluştu: \" . $e->getMessage();\r\n    // Log the error for debugging\r\n    error_log(\"Iris Karsilastirma Error: \" . $e->getMessage() . \" in \" . $e->getFile() . \" line \" . $e->getLine());\r\n}\r\n?>\r\n\r\n<?php \r\ntry {\r\n    include '../../../includes/header.php'; \r\n} catch (Exception $e) {\r\n    echo \"<!DOCTYPE html><html><head><title>Hata</title></head><body>\";\r\n    echo \"<div class='alert alert-danger'>Header dosyası yüklenirken hata: \" . htmlspecialchars($e->getMessage()) . \"</div>\";\r\n}\r\n?>\r\n\r\n<div class=\"row\">\r\n    <div class=\"col-12\">\r\n        <div class=\"card\">\r\n            <div class=\"card-header d-flex justify-content-between align-items-center\">\r\n                <h5 class=\"card-title mb-0\">\r\n                    <i class=\"fas fa-copy me-2\"></i>\r\n                    Iris Rapor - Mükerrer MEMO_ID Karşılaştırma\r\n                </h5>\r\n                <?php if (isset($duplicates) && is_array($duplicates) && count($duplicates) > 0): ?>\r\n                <button class=\"btn btn-success btn-sm\" onclick=\"exportToExcel()\">\r\n                    <i class=\"fas fa-file-excel me-1\"></i>\r\n                    Excel'e Aktar\r\n                </button>\r\n                <?php endif; ?>\r\n            </div>\r\n            <div class=\"card-body\">\r\n                <?php if (isset($error)): ?>\r\n                    <div class=\"alert alert-danger\">\r\n                        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                        <?php echo htmlspecialchars($error); ?>\r\n                    </div>\r\n                <?php else: ?>\r\n                    <!-- İstatistikler -->\r\n                    <div class=\"row mb-4\">\r\n                        <div class=\"col-md-6\">\r\n                            <div class=\"card bg-warning text-white\">\r\n                                <div class=\"card-body text-center\">\r\n                                    <h3 class=\"mb-0\"><?php echo number_format($totalDuplicateMemos); ?></h3>\r\n                                    <p class=\"mb-0\">Mükerrer MEMO_ID Sayısı</p>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"col-md-6\">\r\n                            <div class=\"card bg-danger text-white\">\r\n                                <div class=\"card-body text-center\">\r\n                                    <h3 class=\"mb-0\"><?php echo number_format($totalDuplicateRecords); ?></h3>\r\n                                    <p class=\"mb-0\">Toplam Mükerrer Kayıt Sayısı</p>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <?php if (isset($duplicates) && is_array($duplicates) && count($duplicates) > 0): ?>\r\n                        <!-- Filtre ve Arama -->\r\n                        <div class=\"row mb-3\">\r\n                            <div class=\"col-md-4\">\r\n                                <input type=\"text\" class=\"form-control\" id=\"searchInput\" placeholder=\"MEMO_ID veya Dosya Adı ara...\">\r\n                            </div>\r\n                            <div class=\"col-md-4\">\r\n                                <select class=\"form-control\" id=\"outletFilter\">\r\n                                    <option value=\"\">Tüm Outlet Durumları</option>\r\n                                    <?php\r\n                                    $outlets = array_unique(array_column($duplicates, 'Güncel Outlet'));\r\n                                    $outlets = array_filter($outlets); // Boş değerleri filtrele\r\n                                    foreach ($outlets as $outlet):\r\n                                        if (!empty($outlet)):\r\n                                    ?>\r\n                                    <option value=\"<?php echo htmlspecialchars($outlet); ?>\">\r\n                                        <?php echo htmlspecialchars($outlet); ?>\r\n                                    </option>\r\n                                    <?php \r\n                                        endif;\r\n                                    endforeach; \r\n                                    ?>\r\n                                </select>\r\n                            </div>\r\n                            <div class=\"col-md-4\">\r\n                                <select class=\"form-control\" id=\"teyitFilter\">\r\n                                    <option value=\"\">Tüm Teyit Durumları</option>\r\n                                    <?php\r\n                                    $teyitler = array_unique(array_column($duplicates, 'Teyit Durumu'));\r\n                                    $teyitler = array_filter($teyitler); // Boş değerleri filtrele\r\n                                    foreach ($teyitler as $teyit):\r\n                                        if (!empty($teyit)):\r\n                                    ?>\r\n                                    <option value=\"<?php echo htmlspecialchars($teyit); ?>\">\r\n                                        <?php echo htmlspecialchars($teyit); ?>\r\n                                    </option>\r\n                                    <?php \r\n                                        endif;\r\n                                    endforeach; \r\n                                    ?>\r\n                                </select>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <!-- Tablo -->\r\n                        <div class=\"table-responsive\">\r\n                            <table class=\"table table-striped table-hover\" id=\"duplicatesTable\">\r\n                                <thead class=\"table-dark\">\r\n                                    <tr>\r\n                                        <th>Sıra</th>\r\n                                        <th>Dosya Adı</th>\r\n                                        <th>MEMO_ID</th>\r\n                                        <th>Güncel Outlet</th>\r\n                                        <th>Teyit Durumu</th>\r\n                                        <th>Kayıt Sayısı</th>\r\n                                        <th>Eklenme Tarihi</th>\r\n                                        <th>Güncellenme Tarihi</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    <?php \r\n                                    if (isset($duplicates) && is_array($duplicates)):\r\n                                        $currentMemoId = null;\r\n                                        $counter = 1;\r\n                                        foreach ($duplicates as $row): \r\n                                            $isNewGroup = ($currentMemoId !== $row['Memo ID']);\r\n                                            if ($isNewGroup) {\r\n                                                $currentMemoId = $row['Memo ID'];\r\n                                            }\r\n                                    ?>\r\n                                    <tr class=\"<?php echo $isNewGroup ? 'table-warning' : ''; ?>\">\r\n                                        <td><?php echo $counter++; ?></td>\r\n                                        <td><?php echo htmlspecialchars($row['Dosya Adı'] ?? 'Belirtilmemiş'); ?></td>\r\n                                        <td>\r\n                                            <strong><?php echo htmlspecialchars($row['Memo ID'] ?? ''); ?></strong>\r\n                                            <?php if ($isNewGroup): ?>\r\n                                                <span class=\"badge bg-danger ms-2\"><?php echo intval($row['Toplam Kayıt Sayısı'] ?? 0); ?> adet</span>\r\n                                            <?php endif; ?>\r\n                                        </td>\r\n                                        <td>\r\n                                            <?php if (!empty($row['Güncel Outlet'])): ?>\r\n                                                <span class=\"badge bg-info\">\r\n                                                    <?php echo htmlspecialchars($row['Güncel Outlet']); ?>\r\n                                                </span>\r\n                                            <?php else: ?>\r\n                                                <span class=\"text-muted\">-</span>\r\n                                            <?php endif; ?>\r\n                                        </td>\r\n                                        <td>\r\n                                            <?php if (!empty($row['Teyit Durumu'])): ?>\r\n                                                <span class=\"badge bg-<?php echo (strpos(strtolower($row['Teyit Durumu']), 'onay') !== false) ? 'success' : 'secondary'; ?>\">\r\n                                                    <?php echo htmlspecialchars($row['Teyit Durumu']); ?>\r\n                                                </span>\r\n                                            <?php else: ?>\r\n                                                <span class=\"text-muted\">-</span>\r\n                                            <?php endif; ?>\r\n                                        </td>\r\n                                        <td>\r\n                                            <span class=\"badge bg-warning text-dark\">\r\n                                                <?php echo intval($row['Toplam Kayıt Sayısı'] ?? 0); ?>\r\n                                            </span>\r\n                                        </td>\r\n                                        <td>\r\n                                            <?php if (!empty($row['Eklenme Tarihi'])): ?>\r\n                                                <?php echo date('d.m.Y H:i', strtotime($row['Eklenme Tarihi'])); ?>\r\n                                            <?php else: ?>\r\n                                                <span class=\"text-muted\">-</span>\r\n                                            <?php endif; ?>\r\n                                        </td>\r\n                                        <td>\r\n                                            <?php if (!empty($row['Güncellenme Tarihi'])): ?>\r\n                                                <?php echo date('d.m.Y H:i', strtotime($row['Güncellenme Tarihi'])); ?>\r\n                                            <?php else: ?>\r\n                                                <span class=\"text-muted\">-</span>\r\n                                            <?php endif; ?>\r\n                                        </td>\r\n                                    </tr>\r\n                                    <?php \r\n                                        endforeach; \r\n                                    endif;\r\n                                    ?>\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n\r\n                        <!-- Sayfalama ve sonuçlar -->\r\n                        <div class=\"row mt-3\">\r\n                            <div class=\"col-md-6\">\r\n                                <p class=\"text-muted\">\r\n                                    Toplam <strong><?php echo isset($duplicates) && is_array($duplicates) ? count($duplicates) : 0; ?></strong> mükerrer kayıt gösteriliyor.\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n\r\n                    <?php else: ?>\r\n                        <div class=\"alert alert-success\">\r\n                            <i class=\"fas fa-check-circle me-2\"></i>\r\n                            <strong>Harika!</strong> Sistemde mükerrer MEMO_ID bulunamadı.\r\n                        </div>\r\n                    <?php endif; ?>\r\n                <?php endif; ?>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<?php\r\n$additionalJS = '\r\n<script src=\"https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js\"></script>\r\n<script>\r\n$(document).ready(function() {\r\n    // Arama fonksiyonu\r\n    function filterTable() {\r\n        var searchValue = $(\"#searchInput\").val().toLowerCase();\r\n        var outletValue = $(\"#outletFilter\").val();\r\n        var teyitValue = $(\"#teyitFilter\").val();\r\n        \r\n        $(\"#duplicatesTable tbody tr\").each(function() {\r\n            var row = $(this);\r\n            var memoId = row.find(\"td:eq(2)\").text().toLowerCase();\r\n            var dosyaAdi = row.find(\"td:eq(1)\").text().toLowerCase();\r\n            var outlet = row.find(\"td:eq(3)\").text();\r\n            var teyit = row.find(\"td:eq(4)\").text();\r\n            \r\n            var showRow = true;\r\n            \r\n            // Arama filtresi\r\n            if (searchValue && memoId.indexOf(searchValue) === -1 && dosyaAdi.indexOf(searchValue) === -1) {\r\n                showRow = false;\r\n            }\r\n            \r\n            // Outlet filtresi\r\n            if (outletValue && outlet.indexOf(outletValue) === -1) {\r\n                showRow = false;\r\n            }\r\n            \r\n            // Teyit filtresi\r\n            if (teyitValue && teyit.indexOf(teyitValue) === -1) {\r\n                showRow = false;\r\n            }\r\n            \r\n            if (showRow) {\r\n                row.show();\r\n            } else {\r\n                row.hide();\r\n            }\r\n        });\r\n    }\r\n    \r\n    // Olay dinleyicileri\r\n    $(\"#searchInput\").on(\"keyup\", filterTable);\r\n    $(\"#outletFilter\").on(\"change\", filterTable);\r\n    $(\"#teyitFilter\").on(\"change\", filterTable);\r\n});\r\n\r\n// Excel\\'e aktarma fonksiyonu\r\nfunction exportToExcel() {\r\n    // Görünür satırları al\r\n    var visibleRows = [];\r\n    $(\"#duplicatesTable tbody tr:visible\").each(function() {\r\n        var row = [];\r\n        $(this).find(\"td\").each(function(index) {\r\n            if (index === 2) { // MEMO_ID sütunu - badge\\'ı temizle\r\n                row.push($(this).find(\"strong\").text());\r\n            } else if (index === 3 || index === 4) { // Badge içeren sütunlar\r\n                var badgeText = $(this).find(\".badge\").text();\r\n                row.push(badgeText || $(this).text().replace(\"-\", \"\"));\r\n            } else if (index === 5) { // Kayıt sayısı\r\n                row.push($(this).find(\".badge\").text());\r\n            } else {\r\n                row.push($(this).text());\r\n            }\r\n        });\r\n        visibleRows.push(row);\r\n    });\r\n    \r\n    if (visibleRows.length === 0) {\r\n        alert(\"Excel\\'e aktarılacak veri bulunamadı!\");\r\n        return;\r\n    }\r\n    \r\n    // Başlık satırı\r\n    var headers = [\"Sıra\", \"Dosya Adı\", \"MEMO_ID\", \"Güncel Outlet\", \"Teyit Durumu\", \"Kayıt Sayısı\", \"Eklenme Tarihi\", \"Güncellenme Tarihi\"];\r\n    \r\n    // Workbook oluştur\r\n    var wb = XLSX.utils.book_new();\r\n    var wsData = [headers].concat(visibleRows);\r\n    var ws = XLSX.utils.aoa_to_sheet(wsData);\r\n    \r\n    // Sütun genişliklerini ayarla\r\n    ws[\"!cols\"] = [\r\n        {wch: 8},   // Sıra\r\n        {wch: 25},  // Dosya Adı\r\n        {wch: 15},  // MEMO_ID\r\n        {wch: 20},  // Güncel Outlet\r\n        {wch: 20},  // Teyit Durumu\r\n        {wch: 12},  // Kayıt Sayısı\r\n        {wch: 18},  // Eklenme Tarihi\r\n        {wch: 18}   // Güncellenme Tarihi\r\n    ];\r\n    \r\n    XLSX.utils.book_append_sheet(wb, ws, \"Mükerrer MEMO_ID\");\r\n    \r\n    // Dosya adı oluştur\r\n    var today = new Date();\r\n    var dateStr = today.getFullYear() + \"-\" + \r\n                  String(today.getMonth() + 1).padStart(2, \"0\") + \"-\" + \r\n                  String(today.getDate()).padStart(2, \"0\");\r\n    var filename = \"iris_mukerrer_memo_id_\" + dateStr + \".xlsx\";\r\n    \r\n    XLSX.writeFile(wb, filename);\r\n}\r\n</script>\r\n';\r\n?>\r\n\r\n<?php\r\ntry {\r\n    include '../../../includes/footer.php';\r\n} catch (Exception $e) {\r\n    echo \"<div class='alert alert-danger'>Footer dosyası yüklenirken hata: \" . htmlspecialchars($e->getMessage()) . \"</div>\";\r\n    echo \"</body></html>\";\r\n}\r\n?>\r\n"
        }
    ]
}
{
    "sourceFile": "views/Yonetim/Muhasebe/bayi_hakedis_tanimla.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1761057106369,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1761057106369,
            "name": "Commit-0",
            "content": "<?php\r\n// Debug için hata raporlamasını aç\r\nerror_reporting(E_ALL);\r\nini_set('display_errors', 1);\r\n\r\n$pageTitle = \"Bayi Hakediş Tanımlama\";\r\n$breadcrumbs = [\r\n    ['title' => 'Bayi Hakediş Tanımlama']\r\n];\r\n\r\n// Auth kontrol\r\nrequire_once '../../../auth.php';\r\n$currentUser = checkAuth();\r\ncheckUserStatus();\r\nupdateLastActivity();\r\n\r\n// Sayfa yetkilendirme kontrolü\r\n$sayfaYetkileri = [\r\n    'gor' => false,\r\n    'kendi_kullanicini_gor' => false,\r\n    'ekle' => false,\r\n    'duzenle' => false,\r\n    'sil' => false\r\n];\r\n\r\n// Admin kontrolü (group_id = 1 ise tüm yetkilere sahip)\r\n$isAdmin = ($currentUser['group_id'] == 1);\r\n\r\nif ($isAdmin) {\r\n    // Admin için tüm yetkileri aç\r\n    $sayfaYetkileri = [\r\n        'gor' => 1,\r\n        'kendi_kullanicini_gor' => 0, // 0 = Herkesi görebilir\r\n        'ekle' => 1,\r\n        'duzenle' => 1,\r\n        'sil' => 1\r\n    ];\r\n} else {\r\n    // Admin değilse normal yetki kontrolü yap\r\n    try {\r\n        $conn = getDatabaseConnection();\r\n        \r\n        // Mevcut sayfa URL'sini al\r\n        $currentPageUrl = basename($_SERVER['PHP_SELF']); // bayi_hakedis_tanimla.php\r\n        \r\n        // Sayfa bilgisini ve yetkilerini çek\r\n        $yetkiSql = \"\r\n            SELECT \r\n                tsy.gor,\r\n                tsy.kendi_kullanicini_gor,\r\n                tsy.ekle,\r\n                tsy.duzenle,\r\n                tsy.sil,\r\n                tsy.durum as yetki_durum,\r\n                ts.durum as sayfa_durum\r\n            FROM dbo.tanim_sayfalar ts\r\n            INNER JOIN dbo.tanim_sayfa_yetkiler tsy ON ts.sayfa_id = tsy.sayfa_id\r\n            WHERE ts.sayfa_url = ?\r\n            AND tsy.user_group_id = ?\r\n            AND ts.durum = 1\r\n            AND tsy.durum = 1\r\n        \";\r\n        \r\n        $yetkiStmt = $conn->prepare($yetkiSql);\r\n        $yetkiStmt->execute([$currentPageUrl, $currentUser['group_id']]);\r\n        $yetkiResult = $yetkiStmt->fetch(PDO::FETCH_ASSOC);\r\n        \r\n        if ($yetkiResult) {\r\n            $sayfaYetkileri = [\r\n                'gor' => (int)$yetkiResult['gor'],\r\n                'kendi_kullanicini_gor' => (int)$yetkiResult['kendi_kullanicini_gor'],\r\n                'ekle' => (int)$yetkiResult['ekle'],\r\n                'duzenle' => (int)$yetkiResult['duzenle'],\r\n                'sil' => (int)$yetkiResult['sil']\r\n            ];\r\n            \r\n            // Görme yetkisi yoksa (0 ise) sayfaya erişimi engelle\r\n            if ($sayfaYetkileri['gor'] == 0) {\r\n                header('Location: ../../../index.php?error=yetki_yok');\r\n                exit;\r\n            }\r\n        } else {\r\n            // Yetki tanımı bulunamazsa erişimi engelle\r\n            header('Location: ../../../index.php?error=yetki_tanimlanmamis');\r\n            exit;\r\n        }\r\n        \r\n    } catch (Exception $e) {\r\n        // Hata durumunda güvenlik için erişimi engelle\r\n        error_log(\"Yetki kontrol hatası: \" . $e->getMessage());\r\n        header('Location: ../../../index.php?error=sistem_hatasi');\r\n        exit;\r\n    }\r\n}\r\n\r\n$message = '';\r\n$messageType = '';\r\n\r\n// Hakediş tanım işlemleri\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    try {\r\n        $conn = getDatabaseConnection();\r\n        \r\n        $action = $_POST['action'] ?? '';\r\n        \r\n        switch ($action) {\r\n            case 'add':\r\n                $bayiId = (int)$_POST['bayi_id'];\r\n                $ispNeoFiyat = !empty($_POST['isp_neo_fiyat']) ? (float)$_POST['isp_neo_fiyat'] : null;\r\n                $ispUyduFiyat = !empty($_POST['isp_uydu_fiyat']) ? (float)$_POST['isp_uydu_fiyat'] : null;\r\n                $neoFiyat = !empty($_POST['neo_fiyat']) ? (float)$_POST['neo_fiyat'] : null;\r\n                $uyduFiyat = !empty($_POST['uydu_fiyat']) ? (float)$_POST['uydu_fiyat'] : null;\r\n                $donemIds = $_POST['bayi_hakedis_prim_donem_id'] ?? [];\r\n                $aciklama = trim($_POST['aciklama'] ?? '');\r\n                \r\n                // Açıklama uzunluk kontrolü\r\n                if (strlen($aciklama) > 200) {\r\n                    $message = 'Açıklama metni 200 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n                    $messageType = 'danger';\r\n                } \r\n                // Dönem seçimi kontrolü\r\n                elseif (empty($donemIds)) {\r\n                    $message = 'En az bir dönem seçmelisiniz.';\r\n                    $messageType = 'danger';\r\n                } else {\r\n                    // Her dönem için ayrı kayıt ekle\r\n                    $conn->beginTransaction();\r\n                    $successCount = 0;\r\n                    \r\n                    try {\r\n                        $sql = \"INSERT INTO hakedis_tanim (bayi_id, isp_neo_fiyat, isp_uydu_fiyat, neo_fiyat, uydu_fiyat, bayi_hakedis_prim_donem_id, aciklama) \r\n                                VALUES (?, ?, ?, ?, ?, ?, ?)\";\r\n                        $stmt = $conn->prepare($sql);\r\n                        \r\n                        foreach ($donemIds as $donemId) {\r\n                            $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, (int)$donemId, $aciklama]);\r\n                            $successCount++;\r\n                        }\r\n                        \r\n                        $conn->commit();\r\n                        $message = $successCount . ' adet hakediş tanımı başarıyla eklendi.';\r\n                        $messageType = 'success';\r\n                    } catch (Exception $e) {\r\n                        $conn->rollBack();\r\n                        $message = 'Hata: ' . $e->getMessage();\r\n                        $messageType = 'danger';\r\n                    }\r\n                }\r\n                break;\r\n                \r\n            case 'edit':\r\n                $id = (int)$_POST['id'];\r\n                $bayiId = (int)$_POST['bayi_id'];\r\n                $ispNeoFiyat = !empty($_POST['isp_neo_fiyat']) ? (float)$_POST['isp_neo_fiyat'] : null;\r\n                $ispUyduFiyat = !empty($_POST['isp_uydu_fiyat']) ? (float)$_POST['isp_uydu_fiyat'] : null;\r\n                $neoFiyat = !empty($_POST['neo_fiyat']) ? (float)$_POST['neo_fiyat'] : null;\r\n                $uyduFiyat = !empty($_POST['uydu_fiyat']) ? (float)$_POST['uydu_fiyat'] : null;\r\n                $donemIds = $_POST['bayi_hakedis_prim_donem_id'] ?? [];\r\n                $aciklama = trim($_POST['aciklama'] ?? '');\r\n                \r\n                // Açıklama uzunluk kontrolü\r\n                if (strlen($aciklama) > 200) {\r\n                    $message = 'Açıklama metni 200 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n                    $messageType = 'danger';\r\n                } \r\n                // Dönem seçimi kontrolü\r\n                elseif (empty($donemIds)) {\r\n                    $message = 'En az bir dönem seçmelisiniz. (Case 1)';\r\n                    $messageType = 'danger';\r\n                } else {\r\n                    // Dönem IDs'leri virgülle ayrılmış string olarak güncelle\r\n                    $donemIdsString = implode(',', array_map('intval', $donemIds));\r\n                    \r\n                    $sql = \"UPDATE hakedis_tanim SET bayi_id = ?, isp_neo_fiyat = ?, isp_uydu_fiyat = ?, neo_fiyat = ?, uydu_fiyat = ?, bayi_hakedis_prim_donem_id = ?, aciklama = ? WHERE id = ?\";\r\n                    $stmt = $conn->prepare($sql);\r\n                    $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $donemIdsString, $aciklama, $id]);\r\n                    \r\n                    $message = 'Hakediş tanımı başarıyla güncellendi. Dönemler: ' . $donemIdsString;\r\n                    $messageType = 'success';\r\n                }\r\n                break;\r\n                \r\n            case 'delete':\r\n                $id = (int)$_POST['id'];\r\n                \r\n                $sql = \"DELETE FROM hakedis_tanim WHERE id = ?\";\r\n                $stmt = $conn->prepare($sql);\r\n                $stmt->execute([$id]);\r\n                \r\n                $message = 'Hakediş tanımı başarıyla silindi.';\r\n                $messageType = 'success';\r\n                break;\r\n        }\r\n    } catch (Exception $e) {\r\n        $message = 'Hata: ' . $e->getMessage();\r\n        $messageType = 'danger';\r\n    }\r\n}\r\n\r\n// Bayileri al\r\n$bayiler = [];\r\n$donemler = [];\r\n\r\n// Veritabanı sorgularında schema prefix'ini ekle\r\ntry {\r\n    $conn = getDatabaseConnection();\r\n    \r\n    // kendi_kullanicini_gor = 1 ise sadece kendi kaydını çek\r\n    if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1) {\r\n        // Sadece kendi kaydını çek\r\n        $bayiSql = \"SELECT id, first_name, last_name, email \r\n                   FROM users \r\n                   WHERE id = ? AND status = 'AKTIF'\";\r\n        $bayiStmt = $conn->prepare($bayiSql);\r\n        $bayiStmt->execute([$currentUser['id']]);\r\n        $bayiler = $bayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n    } else {\r\n        // kendi_kullanicini_gor = 0 ise tüm bayileri göster\r\n        $bayiGroupSql = \"SELECT id FROM user_groups WHERE group_name IN ('bayi', 'Bayi')\";\r\n        $bayiGroupStmt = $conn->prepare($bayiGroupSql);\r\n        $bayiGroupStmt->execute();\r\n        $bayiGroups = $bayiGroupStmt->fetchAll(PDO::FETCH_COLUMN);\r\n        \r\n        if (!empty($bayiGroups)) {\r\n            $placeholders = str_repeat('?,', count($bayiGroups) - 1) . '?';\r\n            $bayiSql = \"SELECT id, first_name, last_name, email \r\n                       FROM users \r\n                       WHERE user_group_id IN ($placeholders) \r\n                       AND status = 'AKTIF'\r\n                       ORDER BY first_name, last_name\";\r\n            $bayiStmt = $conn->prepare($bayiSql);\r\n            $bayiStmt->execute($bayiGroups);\r\n            $bayiler = $bayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n        }\r\n    }\r\n    \r\n    // Dönemleri al\r\n    $donemSql = \"SELECT id, donem_adi FROM digiturk.bayi_hakedis_prim_donem WHERE durum = 'AKTIF' ORDER BY id DESC\";\r\n    $donemStmt = $conn->prepare($donemSql);\r\n    $donemStmt->execute();\r\n    $donemler = $donemStmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n} catch (Exception $e) {\r\n    // Hata durumunda boş array kalacak\r\n}\r\n\r\n// Hakediş tanımlarını listele - CLEAN VERSION\r\n$hakedisler = [];\r\ntry {\r\n    $conn = getDatabaseConnection();\r\n    \r\n    // kendi_kullanicini_gor = 1 ise sadece kendi kayıtlarını getir\r\n    if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1) {\r\n        $sql = \"SELECT DISTINCT ht.*, u.first_name, u.last_name, u.email\r\n                FROM hakedis_tanim ht\r\n                INNER JOIN users u ON ht.bayi_id = u.id\r\n                WHERE ht.bayi_id = ?\r\n                ORDER BY ht.created_at DESC\";\r\n        $stmt = $conn->prepare($sql);\r\n        $stmt->execute([$currentUser['id']]);\r\n    } else {\r\n        $sql = \"SELECT DISTINCT ht.*, u.first_name, u.last_name, u.email\r\n                FROM hakedis_tanim ht\r\n                INNER JOIN users u ON ht.bayi_id = u.id\r\n                ORDER BY ht.created_at DESC\";\r\n        $stmt = $conn->prepare($sql);\r\n        $stmt->execute();\r\n    }\r\n    \r\n    $hakedislerRaw = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    // İlk duplikasyon temizleme - ID'ye göre benzersiz kayıtlar\r\n    $uniqueHakedisler = [];\r\n    foreach ($hakedislerRaw as $hakedis) {\r\n        $uniqueHakedisler[$hakedis['id']] = $hakedis;\r\n    }\r\n    \r\n    // Array'e çevir ve sıralama yap\r\n    $hakedisler = array_values($uniqueHakedisler);\r\n    usort($hakedisler, function($a, $b) {\r\n        return strtotime($b['created_at']) - strtotime($a['created_at']);\r\n    });\r\n    \r\n    // Her hakediş için dönem isimlerini al\r\n    for ($i = 0; $i < count($hakedisler); $i++) {\r\n        if (!empty($hakedisler[$i]['bayi_hakedis_prim_donem_id'])) {\r\n            $donemIds = explode(',', $hakedisler[$i]['bayi_hakedis_prim_donem_id']);\r\n            $donemIds = array_filter(array_map('intval', $donemIds));\r\n            \r\n            if (!empty($donemIds)) {\r\n                $placeholders = str_repeat('?,', count($donemIds) - 1) . '?';\r\n                $donemSql = \"SELECT donem_adi FROM digiturk.bayi_hakedis_prim_donem WHERE id IN ($placeholders)\";\r\n                $donemStmt = $conn->prepare($donemSql);\r\n                $donemStmt->execute($donemIds);\r\n                $donemAdilar = $donemStmt->fetchAll(PDO::FETCH_COLUMN);\r\n                \r\n                $hakedisler[$i]['donem_adi'] = implode(', ', $donemAdilar);\r\n                $hakedisler[$i]['donemIds'] = $donemIds;\r\n            } else {\r\n                $hakedisler[$i]['donem_adi'] = 'Dönem Seçilmemiş';\r\n                $hakedisler[$i]['donemIds'] = [];\r\n            }\r\n        } else {\r\n            $hakedisler[$i]['donem_adi'] = 'Dönem Seçilmemiş';\r\n            $hakedisler[$i]['donemIds'] = [];\r\n        }\r\n    }\r\n    \r\n    // FINAL: Son duplikasyon kontrolü\r\n    $finalUnique = [];\r\n    foreach ($hakedisler as $hakedis) {\r\n        $finalUnique[$hakedis['id']] = $hakedis;\r\n    }\r\n    $hakedisler = array_values($finalUnique);\r\n    \r\n} catch (Exception $e) {\r\n    $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n}\r\n\r\n// Filtre dropdown'ları için benzersiz değerleri topla\r\n$filterData = [\r\n    'bayiler' => [],\r\n    'donemler' => [],\r\n    'fiyat_araliklari' => [\r\n        '0-100' => '0 - 100 ₺',\r\n        '100-500' => '100 - 500 ₺', \r\n        '500-1000' => '500 - 1000 ₺',\r\n        '1000-5000' => '1000 - 5000 ₺',\r\n        '5000+' => '5000+ ₺'\r\n    ]\r\n];\r\n\r\n// Benzersiz bayi isimlerini topla\r\nforeach ($hakedisler as $hakedis) {\r\n    $bayiKey = $hakedis['bayi_id'];\r\n    $bayiName = $hakedis['first_name'] . ' ' . $hakedis['last_name'];\r\n    \r\n    // Eğer kendi_kullanicini_gor = 1 ise sadece kendi kaydını ekle\r\n    if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1) {\r\n        if ($bayiKey == $currentUser['id']) {\r\n            $filterData['bayiler'][$bayiKey] = $bayiName;\r\n        }\r\n    } else {\r\n        if (!isset($filterData['bayiler'][$bayiKey])) {\r\n            $filterData['bayiler'][$bayiKey] = $bayiName;\r\n        }\r\n    }\r\n}\r\n\r\n// Benzersiz dönem isimlerini topla\r\nforeach ($hakedisler as $hakedis) {\r\n    if (!empty($hakedis['donem_adi'])) {\r\n        $donemIds = explode(',', $hakedis['bayi_hakedis_prim_donem_id']);\r\n        $donemAdilar = explode(', ', $hakedis['donem_adi']);\r\n        \r\n        for ($i = 0; $i < count($donemIds); $i++) {\r\n            if (isset($donemAdilar[$i])) {\r\n                $donemKey = trim($donemIds[$i]);\r\n                $donemAdi = trim($donemAdilar[$i]);\r\n                if (!isset($filterData['donemler'][$donemKey])) {\r\n                    $filterData['donemler'][$donemKey] = $donemAdi;\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\ninclude '../../../includes/header.php';\r\n?>\r\n\r\n<script>\r\n// JavaScript fonksiyonlarını sayfanın başında tanımla\r\nfunction editHakedisFromButton(button) {\r\n    try {\r\n        const hakedisData = button.getAttribute('data-hakedis');\r\n        if (!hakedisData) {\r\n            console.error('Hakedis data bulunamadı');\r\n            alert('Veri yükleme hatası. Sayfayı yenileyin ve tekrar deneyin.');\r\n            return;\r\n        }\r\n        \r\n        const hakedis = JSON.parse(hakedisData);\r\n        editHakedis(hakedis);\r\n    } catch (error) {\r\n        console.error('JSON parse hatası:', error);\r\n        alert('Veri okuma hatası. Sayfayı yenileyin ve tekrar deneyin.');\r\n    }\r\n}\r\n\r\nfunction validateForm() {\r\n    // Bayi seçimi kontrolü\r\n    let bayiId = document.getElementById('bayi_id') ? document.getElementById('bayi_id').value : '';\r\n    \r\n    // Eğer dropdown disabled ise hidden input'tan değeri al\r\n    if (!bayiId) {\r\n        const hiddenBayiId = document.querySelector('input[type=\"hidden\"][name=\"bayi_id\"]');\r\n        if (hiddenBayiId) {\r\n            bayiId = hiddenBayiId.value;\r\n        }\r\n    }\r\n    \r\n    if (!bayiId) {\r\n        alert('Lütfen bir bayi seçin.');\r\n        return false;\r\n    }\r\n    \r\n    // Dönem seçimi kontrolü\r\n    const checkedDonems = document.querySelectorAll('.donem-checkbox:checked');\r\n    \r\n    if (checkedDonems.length === 0) {\r\n        alert('Lütfen en az bir dönem seçin.');\r\n        return false;\r\n    }\r\n    \r\n    return true;\r\n}\r\n\r\nfunction selectAllPeriods() {\r\n    const checkboxes = document.querySelectorAll('.donem-checkbox');\r\n    checkboxes.forEach(checkbox => checkbox.checked = true);\r\n}\r\n\r\nfunction clearAllPeriods() {\r\n    const checkboxes = document.querySelectorAll('.donem-checkbox');\r\n    checkboxes.forEach(checkbox => checkbox.checked = false);\r\n}\r\n\r\nfunction deleteHakedis(hakedisId, bayiName) {\r\n    if (confirm(bayiName + ' için hakediş tanımını silmek istediğinizden emin misiniz?\\n\\nBu işlem geri alınamaz.')) {\r\n        const form = document.createElement('form');\r\n        form.method = 'POST';\r\n        form.innerHTML = `\r\n            <input type=\"hidden\" name=\"action\" value=\"delete\">\r\n            <input type=\"hidden\" name=\"id\" value=\"${hakedisId}\">\r\n        `;\r\n        document.body.appendChild(form);\r\n        form.submit();\r\n    }\r\n}\r\n\r\nfunction openNewModal() {\r\n    const modal = document.getElementById('addHakedisModal');\r\n    \r\n    if (!modal) {\r\n        console.error('Modal bulunamadı!');\r\n        alert('Modal bulunamadı. Sayfayı yenileyin.');\r\n        return;\r\n    }\r\n    \r\n    // Modal'ı temizle\r\n    clearModal();\r\n    \r\n    // Modal'ı aç\r\n    try {\r\n        if (typeof bootstrap !== 'undefined') {\r\n            const bootstrapModal = new bootstrap.Modal(modal);\r\n            bootstrapModal.show();\r\n        } else {\r\n            // Vanilla JavaScript ile aç\r\n            modal.style.display = 'block';\r\n            modal.classList.add('show');\r\n            document.body.classList.add('modal-open');\r\n            \r\n            // Backdrop ekle\r\n            const backdrop = document.createElement('div');\r\n            backdrop.className = 'modal-backdrop fade show';\r\n            backdrop.id = 'temp-backdrop';\r\n            document.body.appendChild(backdrop);\r\n            \r\n            // Close events\r\n            const closeButtons = modal.querySelectorAll('[data-bs-dismiss=\"modal\"]');\r\n            closeButtons.forEach(button => {\r\n                button.addEventListener('click', function() {\r\n                    modal.style.display = 'none';\r\n                    modal.classList.remove('show');\r\n                    document.body.classList.remove('modal-open');\r\n                    const tempBackdrop = document.getElementById('temp-backdrop');\r\n                    if (tempBackdrop) tempBackdrop.remove();\r\n                });\r\n            });\r\n            \r\n            backdrop.addEventListener('click', function() {\r\n                modal.style.display = 'none';\r\n                modal.classList.remove('show');\r\n                document.body.classList.remove('modal-open');\r\n                backdrop.remove();\r\n            });\r\n        }\r\n    } catch (error) {\r\n        console.error('Modal açılırken hata:', error);\r\n        alert('Modal açılırken bir hata oluştu.');\r\n    }\r\n}\r\n\r\nfunction clearModal() {\r\n    if (document.getElementById('modal_action')) {\r\n        document.getElementById('modal_action').value = 'add';\r\n        document.getElementById('modal_id').value = '';\r\n        document.getElementById('modal_title_text').textContent = 'Yeni Hakediş Tanımı';\r\n        document.getElementById('modal_icon').className = 'fas fa-plus me-2';\r\n        document.getElementById('modal_submit_text').textContent = 'Kaydet';\r\n        \r\n        // Formu temizle\r\n        const bayiSelect = document.getElementById('bayi_id');\r\n        if (bayiSelect && !bayiSelect.disabled) {\r\n            bayiSelect.value = '';\r\n        }\r\n        // Hidden input varsa onu temizleme (zaten disabled durumda sabit kalmalı)\r\n        \r\n        document.getElementById('isp_neo_fiyat').value = '';\r\n        document.getElementById('isp_uydu_fiyat').value = '';\r\n        document.getElementById('neo_fiyat').value = '';\r\n        document.getElementById('uydu_fiyat').value = '';\r\n        document.getElementById('aciklama').value = '';\r\n        \r\n        // Dönem checkbox'larını temizle\r\n        clearAllPeriods();\r\n    }\r\n}\r\n\r\nfunction editHakedis(hakedis) {\r\n    // DOM elementlerinin varlığını kontrol et\r\n    const modalAction = document.getElementById('modal_action');\r\n    const modalId = document.getElementById('modal_id');\r\n    const modalTitleText = document.getElementById('modal_title_text');\r\n    const modalIcon = document.getElementById('modal_icon');\r\n    const modalSubmitText = document.getElementById('modal_submit_text');\r\n    const bayiIdSelect = document.getElementById('bayi_id');\r\n    const ispNeoFiyat = document.getElementById('isp_neo_fiyat');\r\n    const ispUyduFiyat = document.getElementById('isp_uydu_fiyat');\r\n    const neoFiyat = document.getElementById('neo_fiyat');\r\n    const uyduFiyat = document.getElementById('uydu_fiyat');\r\n    const aciklama = document.getElementById('aciklama');\r\n    const modal = document.getElementById('addHakedisModal');\r\n    \r\n    // Eğer modal elementleri henüz yüklenmemişse, bekle ve tekrar dene\r\n    if (!modalAction || !modalId || !modalTitleText || !modal) {\r\n        setTimeout(() => editHakedis(hakedis), 500);\r\n        return;\r\n    }\r\n    \r\n    // Modal başlığını güncelle\r\n    modalAction.value = 'edit';\r\n    modalId.value = hakedis.id;\r\n    modalTitleText.textContent = 'Hakediş Tanımını Düzenle';\r\n    if (modalIcon) modalIcon.className = 'fas fa-edit me-2';\r\n    if (modalSubmitText) modalSubmitText.textContent = 'Güncelle';\r\n    \r\n    // Modal alanlarını doldur\r\n    if (bayiIdSelect) {\r\n        bayiIdSelect.value = hakedis.bayi_id;\r\n        // Eğer dropdown disabled ise hidden input'u da güncelle\r\n        const hiddenBayiId = document.querySelector('input[type=\"hidden\"][name=\"bayi_id\"]');\r\n        if (hiddenBayiId) {\r\n            hiddenBayiId.value = hakedis.bayi_id;\r\n        }\r\n    }\r\n    if (ispNeoFiyat) ispNeoFiyat.value = hakedis.isp_neo_fiyat || '';\r\n    if (ispUyduFiyat) ispUyduFiyat.value = hakedis.isp_uydu_fiyat || '';\r\n    if (neoFiyat) neoFiyat.value = hakedis.neo_fiyat || '';\r\n    if (uyduFiyat) uyduFiyat.value = hakedis.uydu_fiyat || '';\r\n    if (aciklama) aciklama.value = hakedis.aciklama || '';\r\n    \r\n    // Önce tüm checkbox'ları temizle\r\n    clearAllPeriods();\r\n    \r\n    // Dönem ID'lerini seç\r\n    if (hakedis.bayi_hakedis_prim_donem_id) {\r\n        const donemIds = hakedis.bayi_hakedis_prim_donem_id.toString().split(',').map(id => id.trim());\r\n        \r\n        donemIds.forEach(donemId => {\r\n            if (donemId) {\r\n                const checkbox = document.getElementById('donem_' + donemId);\r\n                if (checkbox) {\r\n                    checkbox.checked = true;\r\n                }\r\n            }\r\n        });\r\n    }\r\n    \r\n    // Modal'ı aç\r\n    try {\r\n        // Bootstrap kontrolü\r\n        if (typeof bootstrap !== 'undefined') {\r\n            const bootstrapModal = new bootstrap.Modal(modal);\r\n            bootstrapModal.show();\r\n        } else {\r\n            // Fallback: Modal'ı manuel olarak aç\r\n            modal.style.display = 'block';\r\n            modal.classList.add('show');\r\n            document.body.classList.add('modal-open');\r\n            \r\n            // Backdrop ekle\r\n            const backdrop = document.createElement('div');\r\n            backdrop.className = 'modal-backdrop fade show';\r\n            backdrop.id = 'temp-backdrop';\r\n            document.body.appendChild(backdrop);\r\n            \r\n            // Modal kapat butonu için event listener\r\n            const closeButtons = modal.querySelectorAll('[data-bs-dismiss=\"modal\"]');\r\n            closeButtons.forEach(button => {\r\n                button.addEventListener('click', function() {\r\n                    modal.style.display = 'none';\r\n                    modal.classList.remove('show');\r\n                    document.body.classList.remove('modal-open');\r\n                    const tempBackdrop = document.getElementById('temp-backdrop');\r\n                    if (tempBackdrop) tempBackdrop.remove();\r\n                });\r\n            });\r\n            \r\n            // Backdrop tıklama ile kapatma\r\n            backdrop.addEventListener('click', function() {\r\n                modal.style.display = 'none';\r\n                modal.classList.remove('show');\r\n                document.body.classList.remove('modal-open');\r\n                backdrop.remove();\r\n            });\r\n        }\r\n    } catch (error) {\r\n        console.error('Modal açılırken hata:', error);\r\n        alert('Modal açılırken bir hata oluştu. Sayfa yenilenecek.');\r\n        location.reload();\r\n    }\r\n}\r\n\r\n// Global error handler\r\nwindow.addEventListener('error', function(event) {\r\n    console.error('JavaScript hatası:', event.error);\r\n});\r\n\r\nconsole.log('JavaScript fonksiyonları yüklendi!');\r\n\r\n// DOM yüklendikten sonra dönem checkbox'larını kontrol et\r\ndocument.addEventListener('DOMContentLoaded', function() {\r\n    const donemCheckboxes = document.querySelectorAll('.donem-checkbox');\r\n    \r\n    if (donemCheckboxes.length === 0) {\r\n        console.warn('Hiç dönem checkbox bulunamadı! Dönem verileri yüklenmemiş olabilir.');\r\n    }\r\n});\r\n</script>\r\n\r\n<div class=\"container-fluid mt-4\">\r\n    <div class=\"row\">\r\n        <div class=\"col-12\">\r\n            <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n                <h2><i class=\"fas fa-calculator me-2\"></i>Bayi Hakediş Tanımlama</h2>\r\n                <?php if ($sayfaYetkileri['ekle'] == 1): ?>\r\n                <button class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#addHakedisModal\" onclick=\"openNewModal()\">\r\n                    <i class=\"fas fa-plus me-1\"></i>Yeni Hakediş Tanımı\r\n                </button>\r\n                <?php endif; ?>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <?php if ($message): ?>\r\n        <div class=\"alert alert-<?php echo $messageType; ?> alert-dismissible fade show\" role=\"alert\">\r\n            <i class=\"fas fa-<?php echo $messageType === 'success' ? 'check-circle' : 'exclamation-triangle'; ?> me-2\"></i>\r\n            <?php echo htmlspecialchars($message); ?>\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n        </div>\r\n    <?php endif; ?>\r\n\r\n    <?php if (isset($error)): ?>\r\n        <div class=\"alert alert-danger alert-dismissible fade show\" role=\"alert\">\r\n            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n            <?php echo htmlspecialchars($error); ?>\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n        </div>\r\n    <?php endif; ?>\r\n\r\n    <!-- Hakediş Tanımları Tablosu -->\r\n    <div class=\"card border-0 shadow-sm\">\r\n        <div class=\"card-header bg-primary text-white d-flex justify-content-between align-items-center\">\r\n            <h5 class=\"mb-0\">\r\n                <i class=\"fas fa-list me-2\"></i>Hakediş Tanım Listesi (<?php echo count($hakedisler); ?> kayıt)\r\n            </h5>\r\n            <div class=\"d-flex align-items-center\">\r\n                <small class=\"me-3\">\r\n                    <i class=\"fas fa-filter me-1\"></i>Filtreler aktif\r\n                </small>\r\n                <button type=\"button\" class=\"btn btn-sm btn-light\" onclick=\"clearAllFilters()\" title=\"Tüm Filtreleri Temizle\">\r\n                    <i class=\"fas fa-times me-1\"></i>Temizle\r\n                </button>\r\n            </div>\r\n        </div>\r\n        <div class=\"card-body p-0\">\r\n            <div class=\"table-responsive\">\r\n                <table class=\"table table-hover mb-0\" id=\"hakedisTable\">\r\n                    <thead class=\"table-light\">\r\n                        <tr>\r\n                            <th class=\"sortable\" data-column=\"0\">\r\n                                ID <i class=\"fas fa-sort ms-1\"></i>\r\n                            </th>\r\n                            <th class=\"sortable\" data-column=\"1\">\r\n                                Bayi <i class=\"fas fa-sort ms-1\"></i>\r\n                            </th>\r\n                            <th class=\"sortable\" data-column=\"2\">\r\n                                ISP Neo Fiyat <i class=\"fas fa-sort ms-1\"></i>\r\n                            </th>\r\n                            <th class=\"sortable\" data-column=\"3\">\r\n                                ISP Uydu Fiyat <i class=\"fas fa-sort ms-1\"></i>\r\n                            </th>\r\n                            <th class=\"sortable\" data-column=\"4\">\r\n                                Neo Fiyat <i class=\"fas fa-sort ms-1\"></i>\r\n                            </th>\r\n                            <th class=\"sortable\" data-column=\"5\">\r\n                                Uydu Fiyat <i class=\"fas fa-sort ms-1\"></i>\r\n                            </th>\r\n                            <th class=\"sortable\" data-column=\"6\">\r\n                                Dönem <i class=\"fas fa-sort ms-1\"></i>\r\n                            </th>\r\n                            <th class=\"sortable\" data-column=\"7\">\r\n                                Açıklama <i class=\"fas fa-sort ms-1\"></i>\r\n                            </th>\r\n                            <th>İşlemler</th>\r\n                        </tr>\r\n                        <tr class=\"filter-row\">\r\n                            <th>\r\n                                <select class=\"form-select form-select-sm table-filter\" data-column=\"0\">\r\n                                    <option value=\"\">Tüm ID'ler</option>\r\n                                    <?php \r\n                                    $uniqueIds = array_unique(array_column($hakedisler, 'id'));\r\n                                    sort($uniqueIds);\r\n                                    foreach ($uniqueIds as $id): \r\n                                    ?>\r\n                                        <option value=\"<?php echo $id; ?>\">\r\n                                            ID: <?php echo $id; ?>\r\n                                        </option>\r\n                                    <?php endforeach; ?>\r\n                                </select>\r\n                            </th>\r\n                            <th>\r\n                                <select class=\"form-select form-select-sm table-filter\" data-column=\"1\" <?php echo $sayfaYetkileri['kendi_kullanicini_gor'] == 1 ? 'disabled' : ''; ?>>\r\n                                    <?php if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1 && !empty($bayiler)): ?>\r\n                                        <option value=\"<?php echo $bayiler[0]['id']; ?>\" selected>\r\n                                            <?php echo htmlspecialchars($bayiler[0]['first_name'] . ' ' . $bayiler[0]['last_name']); ?>\r\n                                        </option>\r\n                                    <?php else: ?>\r\n                                        <option value=\"\">Tüm Bayiler</option>\r\n                                        <?php foreach ($filterData['bayiler'] as $bayiId => $bayiName): ?>\r\n                                            <option value=\"<?php echo $bayiId; ?>\">\r\n                                                <?php echo htmlspecialchars($bayiName); ?>\r\n                                            </option>\r\n                                        <?php endforeach; ?>\r\n                                    <?php endif; ?>\r\n                                </select>\r\n                            </th>\r\n                            <th>\r\n                                <select class=\"form-select form-select-sm table-filter\" data-column=\"2\">\r\n                                    <option value=\"\">Tüm Fiyatlar</option>\r\n                                    <?php foreach ($filterData['fiyat_araliklari'] as $range => $label): ?>\r\n                                        <option value=\"<?php echo $range; ?>\">\r\n                                            <?php echo $label; ?>\r\n                                        </option>\r\n                                    <?php endforeach; ?>\r\n                                </select>\r\n                            </th>\r\n                            <th>\r\n                                <select class=\"form-select form-select-sm table-filter\" data-column=\"3\">\r\n                                    <option value=\"\">Tüm Fiyatlar</option>\r\n                                    <?php foreach ($filterData['fiyat_araliklari'] as $range => $label): ?>\r\n                                        <option value=\"<?php echo $range; ?>\">\r\n                                            <?php echo $label; ?>\r\n                                        </option>\r\n                                    <?php endforeach; ?>\r\n                                </select>\r\n                            </th>\r\n                            <th>\r\n                                <select class=\"form-select form-select-sm table-filter\" data-column=\"4\">\r\n                                    <option value=\"\">Tüm Fiyatlar</option>\r\n                                    <?php foreach ($filterData['fiyat_araliklari'] as $range => $label): ?>\r\n                                        <option value=\"<?php echo $range; ?>\">\r\n                                            <?php echo $label; ?>\r\n                                        </option>\r\n                                    <?php endforeach; ?>\r\n                                </select>\r\n                            </th>\r\n                            <th>\r\n                                <select class=\"form-select form-select-sm table-filter\" data-column=\"5\">\r\n                                    <option value=\"\">Tüm Fiyatlar</option>\r\n                                    <?php foreach ($filterData['fiyat_araliklari'] as $range => $label): ?>\r\n                                        <option value=\"<?php echo $range; ?>\">\r\n                                            <?php echo $label; ?>\r\n                                        </option>\r\n                                    <?php endforeach; ?>\r\n                                </select>\r\n                            </th>\r\n                            <th>\r\n                                <select class=\"form-select form-select-sm table-filter\" data-column=\"6\">\r\n                                    <option value=\"\">Tüm Dönemler</option>\r\n                                    <?php foreach ($filterData['donemler'] as $donemId => $donemAdi): ?>\r\n                                        <option value=\"<?php echo $donemId; ?>\">\r\n                                            <?php echo htmlspecialchars($donemAdi); ?>\r\n                                        </option>\r\n                                    <?php endforeach; ?>\r\n                                </select>\r\n                            </th>\r\n                            <th>\r\n                                <select class=\"form-select form-select-sm table-filter\" data-column=\"7\">\r\n                                    <option value=\"\">Tüm Açıklamalar</option>\r\n                                    <option value=\"has_description\">Açıklaması Var</option>\r\n                                    <option value=\"no_description\">Açıklaması Yok</option>\r\n                                </select>\r\n                            </th>\r\n                            <th>\r\n                                <button type=\"button\" class=\"btn btn-sm btn-outline-secondary\" \r\n                                        onclick=\"clearAllFilters()\" title=\"Filtreleri Temizle\">\r\n                                    <i class=\"fas fa-times\"></i>\r\n                                </button>\r\n                            </th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        <?php if (!empty($hakedisler)): ?>\r\n                            <?php $siraNo = 1; ?>\r\n                            <?php foreach ($hakedisler as $hakedis): ?>\r\n                                <tr>\r\n                                    <td>\r\n                                        <?php echo $hakedis['id']; ?>\r\n                                        <br><small class=\"text-muted\">Sıra: <?php echo $siraNo; ?></small>\r\n                                    </td>\r\n                                    <td>\r\n                                        <strong><?php echo htmlspecialchars($hakedis['first_name'] . ' ' . $hakedis['last_name']); ?></strong>\r\n                                        <br><small class=\"text-muted\"><?php echo htmlspecialchars($hakedis['email']); ?></small>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo $hakedis['isp_neo_fiyat'] ? number_format($hakedis['isp_neo_fiyat'], 2) . ' ₺' : '-'; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo $hakedis['isp_uydu_fiyat'] ? number_format($hakedis['isp_uydu_fiyat'], 2) . ' ₺' : '-'; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo $hakedis['neo_fiyat'] ? number_format($hakedis['neo_fiyat'], 2) . ' ₺' : '-'; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo $hakedis['uydu_fiyat'] ? number_format($hakedis['uydu_fiyat'], 2) . ' ₺' : '-'; ?>\r\n                                    </td>\r\n                                    <td style=\"max-width: 200px;\">\r\n                                        <div class=\"donem-content\" \r\n                                             data-bs-toggle=\"tooltip\" \r\n                                             data-bs-placement=\"top\" \r\n                                             title=\"<?php echo htmlspecialchars($hakedis['donem_adi'] ?? 'Dönem Tanımlanmamış'); ?>\">\r\n                                            <span class=\"badge bg-info text-truncate d-inline-block\" style=\"max-width: 180px;\">\r\n                                                <?php echo htmlspecialchars($hakedis['donem_adi'] ?? 'Dönem Tanımlanmamış'); ?>\r\n                                            </span>\r\n                                        </div>\r\n                                    </td>\r\n                                    <td>\r\n                                        <span class=\"text-muted\" title=\"<?php echo htmlspecialchars($hakedis['aciklama'] ?? ''); ?>\">\r\n                                            <?php \r\n                                            $aciklama = $hakedis['aciklama'] ?? '';\r\n                                            if (strlen($aciklama) > 30) {\r\n                                                echo htmlspecialchars(substr($aciklama, 0, 30)) . '...';\r\n                                            } else {\r\n                                                echo htmlspecialchars($aciklama) ?: '-';\r\n                                            }\r\n                                            ?>\r\n                                        </span>\r\n                                    </td>\r\n                                    <td>\r\n                                        <div class=\"btn-group\" role=\"group\">\r\n                                            <?php if ($sayfaYetkileri['duzenle'] == 1): ?>\r\n                                            <button type=\"button\" class=\"btn btn-sm btn-outline-primary\" \r\n                                                    data-hakedis='<?php echo json_encode($hakedis, JSON_HEX_APOS | JSON_HEX_QUOT); ?>'\r\n                                                    onclick=\"editHakedisFromButton(this)\">\r\n                                                <i class=\"fas fa-edit\"></i>\r\n                                            </button>\r\n                                            <?php endif; ?>\r\n                                            <?php if ($sayfaYetkileri['sil'] == 1): ?>\r\n                                            <button type=\"button\" class=\"btn btn-sm btn-outline-danger\" \r\n                                                    onclick=\"deleteHakedis(<?php echo $hakedis['id']; ?>, '<?php echo htmlspecialchars($hakedis['first_name'] . ' ' . $hakedis['last_name']); ?>')\">\r\n                                                <i class=\"fas fa-trash\"></i>\r\n                                            </button>\r\n                                            <?php endif; ?>\r\n                                            <?php if ($sayfaYetkileri['duzenle'] == 0 && $sayfaYetkileri['sil'] == 0): ?>\r\n                                            <span class=\"badge bg-secondary\">Yetki Yok</span>\r\n                                            <?php endif; ?>\r\n                                        </div>\r\n                                    </td>\r\n                                </tr>\r\n                                <?php $siraNo++; ?>\r\n                            <?php endforeach; ?>\r\n                        <?php else: ?>\r\n                            <tr>\r\n                                <td colspan=\"9\" class=\"text-center py-5 text-muted\">\r\n                                    <i class=\"fas fa-calculator fa-3x mb-3 d-block\"></i>\r\n                                    <h5>Henüz hakediş tanımı bulunmuyor</h5>\r\n                                    <p>İlk hakediş tanımını eklemek için \"Yeni Hakediş Tanımı\" butonuna tıklayın.</p>\r\n                                </td>\r\n                            </tr>\r\n                        <?php endif; ?>\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Hakediş Tanımı Modal (Ekleme/Düzenleme) -->\r\n<div class=\"modal fade\" id=\"addHakedisModal\" tabindex=\"-1\">\r\n    <div class=\"modal-dialog modal-lg\">\r\n        <div class=\"modal-content\">\r\n            <form method=\"POST\" action=\"\">\r\n                <input type=\"hidden\" name=\"action\" id=\"modal_action\" value=\"add\">\r\n                <input type=\"hidden\" name=\"id\" id=\"modal_id\">\r\n                <div class=\"modal-header\">\r\n                    <h5 class=\"modal-title\" id=\"modal_title\">\r\n                        <i class=\"fas fa-plus me-2\" id=\"modal_icon\"></i><span id=\"modal_title_text\">Yeni Hakediş Tanımı</span>\r\n                    </h5>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"bayi_id\" class=\"form-label\">Bayi Ad Soyad <span class=\"text-danger\">*</span></label>\r\n                        <select class=\"form-select\" id=\"bayi_id\" name=\"bayi_id\" required <?php echo $sayfaYetkileri['kendi_kullanicini_gor'] == 1 ? 'disabled' : ''; ?>>\r\n                            <?php if ($sayfaYetkileri['kendi_kullanicini_gor'] == 0): ?>\r\n                                <option value=\"\">Bayi Seçin</option>\r\n                            <?php endif; ?>\r\n                            <?php foreach ($bayiler as $bayi): ?>\r\n                                <option value=\"<?php echo $bayi['id']; ?>\" <?php echo $sayfaYetkileri['kendi_kullanicini_gor'] == 1 ? 'selected' : ''; ?>>\r\n                                    <?php echo htmlspecialchars($bayi['first_name'] . ' ' . $bayi['last_name'] . ' (' . $bayi['email'] . ')'); ?>\r\n                                </option>\r\n                            <?php endforeach; ?>\r\n                        </select>\r\n                        <?php if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1): ?>\r\n                            <input type=\"hidden\" name=\"bayi_id\" value=\"<?php echo $bayiler[0]['id'] ?? ''; ?>\">\r\n                            <div class=\"form-text text-info\">\r\n                                <i class=\"fas fa-info-circle me-1\"></i>\r\n                                Sadece kendi kayıtlarınızı yönetebilirsiniz.\r\n                            </div>\r\n                        <?php endif; ?>\r\n                    </div>\r\n                    \r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"isp_neo_fiyat\" class=\"form-label\">ISP Neo Fiyat</label>\r\n                            <div class=\"input-group\">\r\n                                <input type=\"number\" class=\"form-control\" id=\"isp_neo_fiyat\" name=\"isp_neo_fiyat\" \r\n                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                <span class=\"input-group-text\">₺</span>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"isp_uydu_fiyat\" class=\"form-label\">ISP Uydu Fiyat</label>\r\n                            <div class=\"input-group\">\r\n                                <input type=\"number\" class=\"form-control\" id=\"isp_uydu_fiyat\" name=\"isp_uydu_fiyat\" \r\n                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                <span class=\"input-group-text\">₺</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"neo_fiyat\" class=\"form-label\">Neo Fiyat</label>\r\n                            <div class=\"input-group\">\r\n                                <input type=\"number\" class=\"form-control\" id=\"neo_fiyat\" name=\"neo_fiyat\" \r\n                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                <span class=\"input-group-text\">₺</span>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"uydu_fiyat\" class=\"form-label\">Uydu Fiyat</label>\r\n                            <div class=\"input-group\">\r\n                                <input type=\"number\" class=\"form-control\" id=\"uydu_fiyat\" name=\"uydu_fiyat\" \r\n                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                <span class=\"input-group-text\">₺</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"bayi_hakedis_prim_donem_id\" class=\"form-label\">Dönem Seçimi <span class=\"text-danger\">*</span></label>\r\n                        <?php if (empty($donemler)): ?>\r\n                            <div class=\"alert alert-warning\">\r\n                                <i class=\"fas fa-exclamation-triangle me-1\"></i>\r\n                                Hiç aktif dönem bulunamadı! Veritabanını kontrol edin.\r\n                            </div>\r\n                        <?php else: ?>\r\n                            <div class=\"alert alert-info mb-2\">\r\n                                <small><i class=\"fas fa-info-circle me-1\"></i>Toplam <?php echo count($donemler); ?> dönem mevcut</small>\r\n                            </div>\r\n                        <?php endif; ?>\r\n                        <div class=\"border rounded p-2\" style=\"max-height: 200px; overflow-y: auto;\">\r\n                            <?php foreach ($donemler as $donem): ?>\r\n                                <div class=\"form-check\">\r\n                                    <input class=\"form-check-input donem-checkbox\" type=\"checkbox\" \r\n                                           name=\"bayi_hakedis_prim_donem_id[]\" \r\n                                           value=\"<?php echo $donem['id']; ?>\" \r\n                                           id=\"donem_<?php echo $donem['id']; ?>\">\r\n                                    <label class=\"form-check-label\" for=\"donem_<?php echo $donem['id']; ?>\">\r\n                                        <?php echo htmlspecialchars($donem['donem_adi']); ?> (ID: <?php echo $donem['id']; ?>)\r\n                                    </label>\r\n                                </div>\r\n                            <?php endforeach; ?>\r\n                        </div>\r\n                        <div class=\"form-text\">\r\n                            <i class=\"fas fa-info-circle me-1\"></i>\r\n                            Birden fazla dönem seçebilirsiniz. En az bir dönem seçimi gereklidir.\r\n                        </div>\r\n                        <div class=\"mt-2\">\r\n                            <button type=\"button\" class=\"btn btn-sm btn-outline-primary\" onclick=\"selectAllPeriods()\">Tümünü Seç</button>\r\n                            <button type=\"button\" class=\"btn btn-sm btn-outline-secondary\" onclick=\"clearAllPeriods()\">Tümünü Temizle</button>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"aciklama\" class=\"form-label\">Açıklama</label>\r\n                        <textarea class=\"form-control\" id=\"aciklama\" name=\"aciklama\" rows=\"3\" \r\n                                  placeholder=\"Hakediş tanımı ile ilgili açıklama (isteğe bağlı)\" maxlength=\"200\"></textarea>\r\n                        <div class=\"form-text\">Maksimum 200 karakter</div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-primary\" id=\"modal_submit_btn\" onclick=\"return validateForm()\">\r\n                        <i class=\"fas fa-save me-1\"></i><span id=\"modal_submit_text\">Kaydet</span>\r\n                    </button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<style>\r\n.donem-checkbox:checked + .form-check-label {\r\n    font-weight: bold;\r\n    color: #0d6efd;\r\n}\r\n\r\n.form-check {\r\n    padding: 0.25rem 0;\r\n}\r\n\r\n.form-check:hover {\r\n    background-color: #f8f9fa;\r\n    border-radius: 0.25rem;\r\n}\r\n\r\n.border.rounded {\r\n    border-color: #dee2e6 !important;\r\n}\r\n\r\n/* Tablo sıralama stilleri */\r\n.sortable {\r\n    cursor: pointer;\r\n    user-select: none;\r\n    position: relative;\r\n    transition: background-color 0.2s ease;\r\n}\r\n\r\n.sortable:hover {\r\n    background-color: #e9ecef !important;\r\n}\r\n\r\n.sortable i {\r\n    opacity: 0.5;\r\n    transition: opacity 0.2s ease;\r\n}\r\n\r\n.sortable:hover i {\r\n    opacity: 1;\r\n}\r\n\r\n.sortable.asc i:before {\r\n    content: \"\\f0de\"; /* fa-sort-up */\r\n    color: #0d6efd;\r\n    opacity: 1;\r\n}\r\n\r\n.sortable.desc i:before {\r\n    content: \"\\f0dd\"; /* fa-sort-down */\r\n    color: #0d6efd;\r\n    opacity: 1;\r\n}\r\n\r\n/* Dönem sütunu için özel stil */\r\n.donem-content {\r\n    white-space: nowrap;\r\n    overflow: hidden;\r\n}\r\n\r\n.text-truncate {\r\n    text-overflow: ellipsis;\r\n}\r\n\r\n/* Filtre satırı stilleri */\r\n.filter-row th {\r\n    padding: 0.5rem;\r\n    background-color: #f8f9fa !important;\r\n    border-top: 1px solid #dee2e6;\r\n}\r\n\r\n.table-filter {\r\n    font-size: 0.8rem;\r\n    border: 1px solid #ced4da;\r\n    height: 32px;\r\n}\r\n\r\n.table-filter:focus {\r\n    border-color: #0d6efd;\r\n    box-shadow: 0 0 0 0.1rem rgba(13, 110, 253, 0.25);\r\n}\r\n\r\n/* Aktif filtre göstergesi */\r\n.table-filter.has-value {\r\n    background-color: #e7f3ff;\r\n    border-color: #0d6efd;\r\n    font-weight: 500;\r\n}\r\n\r\n.table-filter.has-value option:first-child {\r\n    font-weight: bold;\r\n    color: #0d6efd;\r\n}\r\n\r\n/* Dropdown ok işareti özelleştirme */\r\n.table-filter {\r\n    background-image: url(\"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e\");\r\n    background-repeat: no-repeat;\r\n    background-position: right 0.75rem center;\r\n    background-size: 16px 12px;\r\n}\r\n\r\n/* Gizli satır sınıfı */\r\n.filtered-hidden {\r\n    display: none !important;\r\n}\r\n\r\n/* Responsive tablo için mobil görünüm */\r\n@media (max-width: 768px) {\r\n    .table-responsive {\r\n        font-size: 0.85rem;\r\n    }\r\n    \r\n    .table th, .table td {\r\n        padding: 0.5rem 0.25rem;\r\n    }\r\n    \r\n    .btn-group .btn {\r\n        padding: 0.25rem 0.5rem;\r\n    }\r\n    \r\n    .filter-row th {\r\n        padding: 0.25rem;\r\n    }\r\n    \r\n    .table-filter {\r\n        font-size: 0.75rem;\r\n    }\r\n}\r\n</style>\r\n\r\n<script>\r\n// DOM yüklendikten sonra çalışacak\r\ndocument.addEventListener('DOMContentLoaded', function() {\r\n    console.log('DOM yüklendi. Event listener\\'lar ekleniyor...');\r\n    \r\n    // Modal event listener\r\n    const modal = document.getElementById('addHakedisModal');\r\n    if (modal) {\r\n        modal.addEventListener('show.bs.modal', function(event) {\r\n            // Eğer modal düzenleme için açılmıyorsa temizle\r\n            if (event.relatedTarget && event.relatedTarget.getAttribute('data-bs-target') === '#addHakedisModal') {\r\n                clearModal();\r\n            }\r\n        });\r\n    }\r\n    \r\n    // Form submit listener\r\n    const form = document.querySelector('#addHakedisModal form');\r\n    if (form) {\r\n        form.addEventListener('submit', function(e) {\r\n            console.log('Form submit edildi');\r\n            if (!validateForm()) {\r\n                e.preventDefault();\r\n                return false;\r\n            }\r\n        });\r\n    }\r\n    \r\n    // Tooltip'leri etkinleştir\r\n    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle=\"tooltip\"]'));\r\n    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {\r\n        return new bootstrap.Tooltip(tooltipTriggerEl);\r\n    });\r\n    \r\n    // Tablo sıralama özelliği\r\n    initTableSorting();\r\n    \r\n    // Tablo filtreleme özelliği\r\n    initTableFiltering();\r\n});\r\n\r\n// Tablo filtreleme fonksiyonları\r\nfunction initTableFiltering() {\r\n    const filterSelects = document.querySelectorAll('.table-filter');\r\n    \r\n    filterSelects.forEach(select => {\r\n        select.addEventListener('change', function() {\r\n            // Aktif filtre göstergesi\r\n            if (this.value) {\r\n                this.classList.add('has-value');\r\n            } else {\r\n                this.classList.remove('has-value');\r\n            }\r\n            \r\n            // Filtreleme işlemini gerçekleştir\r\n            applyTableFilters();\r\n        });\r\n    });\r\n}\r\n\r\nfunction applyTableFilters() {\r\n    const table = document.querySelector('#hakedisTable tbody');\r\n    const rows = table.querySelectorAll('tr');\r\n    const filterSelects = document.querySelectorAll('.table-filter');\r\n    \r\n    // Filtre değerlerini al\r\n    const filters = {};\r\n    filterSelects.forEach(select => {\r\n        const column = parseInt(select.dataset.column);\r\n        const value = select.value.trim();\r\n        if (value) {\r\n            filters[column] = value;\r\n        }\r\n    });\r\n    \r\n    let visibleRowCount = 0;\r\n    \r\n    rows.forEach(row => {\r\n        // Boş satır kontrolü (veri yoksa)\r\n        if (row.querySelector('td[colspan]')) {\r\n            return;\r\n        }\r\n        \r\n        let shouldShow = true;\r\n        \r\n        // Her filtre için kontrol et\r\n        Object.keys(filters).forEach(columnIndex => {\r\n            const filterValue = filters[columnIndex];\r\n            const cell = row.children[columnIndex];\r\n            const column = parseInt(columnIndex);\r\n            \r\n            if (!cell) return;\r\n            \r\n            if (column === 0) { // ID sütunu\r\n                const cellId = cell.textContent.trim().split('\\n')[0]; // Sadece ID'yi al\r\n                if (cellId !== filterValue) {\r\n                    shouldShow = false;\r\n                }\r\n            } else if (column === 1) { // Bayi sütunu\r\n                // Bayi ID'sini row data'sından al\r\n                const editButton = row.querySelector('button[data-hakedis]');\r\n                if (editButton) {\r\n                    try {\r\n                        const hakedisData = JSON.parse(editButton.getAttribute('data-hakedis'));\r\n                        if (hakedisData.bayi_id != filterValue) {\r\n                            shouldShow = false;\r\n                        }\r\n                    } catch (e) {\r\n                        shouldShow = false;\r\n                    }\r\n                } else {\r\n                    shouldShow = false;\r\n                }\r\n            } else if (column >= 2 && column <= 5) { // Fiyat sütunları\r\n                const priceText = cell.textContent.replace(/[₺,\\s-]/g, '');\r\n                const price = parseFloat(priceText) || 0;\r\n                \r\n                // Fiyat aralığı kontrolü\r\n                if (!checkPriceRange(price, filterValue)) {\r\n                    shouldShow = false;\r\n                }\r\n            } else if (column === 6) { // Dönem sütunu\r\n                // Dönem ID'lerini kontrol et\r\n                const editButton = row.querySelector('button[data-hakedis]');\r\n                if (editButton) {\r\n                    try {\r\n                        const hakedisData = JSON.parse(editButton.getAttribute('data-hakedis'));\r\n                        const donemIds = hakedisData.bayi_hakedis_prim_donem_id ? \r\n                            hakedisData.bayi_hakedis_prim_donem_id.toString().split(',') : [];\r\n                        \r\n                        if (!donemIds.some(id => id.trim() === filterValue)) {\r\n                            shouldShow = false;\r\n                        }\r\n                    } catch (e) {\r\n                        shouldShow = false;\r\n                    }\r\n                } else {\r\n                    shouldShow = false;\r\n                }\r\n            } else if (column === 7) { // Açıklama sütunu\r\n                const span = cell.querySelector('span[title]');\r\n                const aciklama = span ? span.getAttribute('title') : cell.textContent.trim();\r\n                \r\n                if (filterValue === 'has_description' && (!aciklama || aciklama === '-')) {\r\n                    shouldShow = false;\r\n                } else if (filterValue === 'no_description' && aciklama && aciklama !== '-') {\r\n                    shouldShow = false;\r\n                }\r\n            }\r\n        });\r\n        \r\n        // Satırı göster/gizle\r\n        if (shouldShow) {\r\n            row.classList.remove('filtered-hidden');\r\n            visibleRowCount++;\r\n        } else {\r\n            row.classList.add('filtered-hidden');\r\n        }\r\n    });\r\n    \r\n    // Sonuç sayısını güncelle\r\n    updateFilterResultsInfo(visibleRowCount, rows.length);\r\n}\r\n\r\nfunction checkPriceRange(price, range) {\r\n    switch (range) {\r\n        case '0-100':\r\n            return price >= 0 && price <= 100;\r\n        case '100-500':\r\n            return price > 100 && price <= 500;\r\n        case '500-1000':\r\n            return price > 500 && price <= 1000;\r\n        case '1000-5000':\r\n            return price > 1000 && price <= 5000;\r\n        case '5000+':\r\n            return price > 5000;\r\n        default:\r\n            return true;\r\n    }\r\n}\r\n\r\nfunction clearAllFilters() {\r\n    const filterSelects = document.querySelectorAll('.table-filter');\r\n    const rows = document.querySelectorAll('#hakedisTable tbody tr');\r\n    \r\n    // Tüm dropdown'ları temizle\r\n    filterSelects.forEach(select => {\r\n        select.value = '';\r\n        select.classList.remove('has-value');\r\n    });\r\n    \r\n    // Tüm satırları göster\r\n    rows.forEach(row => {\r\n        row.classList.remove('filtered-hidden');\r\n    });\r\n    \r\n    // Sonuç sayısını güncelle\r\n    const visibleRows = rows.length;\r\n    updateFilterResultsInfo(visibleRows, visibleRows);\r\n}\r\n\r\nfunction updateFilterResultsInfo(visibleCount, totalCount) {\r\n    // Kart başlığındaki kayıt sayısını güncelle\r\n    const cardHeader = document.querySelector('.card-header h5');\r\n    if (cardHeader) {\r\n        const baseText = 'Hakediş Tanım Listesi';\r\n        if (visibleCount === totalCount) {\r\n            cardHeader.innerHTML = `<i class=\"fas fa-list me-2\"></i>${baseText} (${totalCount} kayıt)`;\r\n        } else {\r\n            cardHeader.innerHTML = `<i class=\"fas fa-list me-2\"></i>${baseText} (${visibleCount}/${totalCount} kayıt)`;\r\n        }\r\n    }\r\n    \r\n    // Eğer hiç sonuç yoksa bilgi mesajı göster\r\n    showNoResultsMessage(visibleCount, totalCount);\r\n}\r\n\r\nfunction showNoResultsMessage(visibleCount, totalCount) {\r\n    const tbody = document.querySelector('#hakedisTable tbody');\r\n    let noResultsRow = tbody.querySelector('.no-results-row');\r\n    \r\n    // Mevcut \"sonuç yok\" satırını kaldır\r\n    if (noResultsRow) {\r\n        noResultsRow.remove();\r\n    }\r\n    \r\n    // Eğer filtre sonucu hiç kayıt yoksa mesaj göster\r\n    if (visibleCount === 0 && totalCount > 0) {\r\n        const row = document.createElement('tr');\r\n        row.className = 'no-results-row';\r\n        row.innerHTML = `\r\n            <td colspan=\"9\" class=\"text-center py-4 text-muted\">\r\n                <i class=\"fas fa-search fa-2x mb-2 d-block\"></i>\r\n                <h6>Filtreleme sonucu kayıt bulunamadı</h6>\r\n                <p class=\"mb-2\">Arama kriterlerinizi değiştirerek tekrar deneyin.</p>\r\n                <button type=\"button\" class=\"btn btn-sm btn-outline-primary\" onclick=\"clearAllFilters()\">\r\n                    <i class=\"fas fa-times me-1\"></i>Filtreleri Temizle\r\n                </button>\r\n            </td>\r\n        `;\r\n        tbody.appendChild(row);\r\n    }\r\n}\r\n\r\n// Tablo sıralama fonksiyonları\r\nfunction initTableSorting() {\r\n    const table = document.querySelector('#hakedisTable');\r\n    const headers = table.querySelectorAll('.sortable');\r\n    \r\n    headers.forEach(header => {\r\n        header.addEventListener('click', function() {\r\n            const column = parseInt(this.dataset.column);\r\n            const currentSort = this.classList.contains('asc') ? 'asc' : this.classList.contains('desc') ? 'desc' : 'none';\r\n            \r\n            // Tüm header'lardan sıralama classlarını kaldır\r\n            headers.forEach(h => h.classList.remove('asc', 'desc'));\r\n            \r\n            // Yeni sıralama yönünü belirle\r\n            let newSort;\r\n            if (currentSort === 'none' || currentSort === 'desc') {\r\n                newSort = 'asc';\r\n            } else {\r\n                newSort = 'desc';\r\n            }\r\n            \r\n            this.classList.add(newSort);\r\n            sortTable(column, newSort);\r\n        });\r\n    });\r\n}\r\n\r\nfunction sortTable(column, direction) {\r\n    const table = document.querySelector('#hakedisTable tbody');\r\n    const rows = Array.from(table.querySelectorAll('tr'));\r\n    \r\n    // Boş satır kontrolü (henüz veri yoksa)\r\n    if (rows.length === 1 && rows[0].querySelector('td[colspan]')) {\r\n        return;\r\n    }\r\n    \r\n    rows.sort((a, b) => {\r\n        const aCell = a.children[column];\r\n        const bCell = b.children[column];\r\n        \r\n        let aValue = '';\r\n        let bValue = '';\r\n        \r\n        // Hücre içeriğini al\r\n        if (column === 0) { // ID sütunu\r\n            aValue = parseInt(aCell.textContent.trim()) || 0;\r\n            bValue = parseInt(bCell.textContent.trim()) || 0;\r\n        } else if (column >= 2 && column <= 5) { // Fiyat sütunları\r\n            // Fiyat değerini al (₺ işaretini kaldır)\r\n            const aText = aCell.textContent.replace(/[₺,\\s]/g, '').replace('-', '0');\r\n            const bText = bCell.textContent.replace(/[₺,\\s]/g, '').replace('-', '0');\r\n            aValue = parseFloat(aText) || 0;\r\n            bValue = parseFloat(bText) || 0;\r\n        } else {\r\n            // Metin sütunları\r\n            aValue = aCell.textContent.trim().toLowerCase();\r\n            bValue = bCell.textContent.trim().toLowerCase();\r\n        }\r\n        \r\n        // Sıralama karşılaştırması\r\n        if (typeof aValue === 'number' && typeof bValue === 'number') {\r\n            return direction === 'asc' ? aValue - bValue : bValue - aValue;\r\n        } else {\r\n            if (direction === 'asc') {\r\n                return aValue.localeCompare(bValue, 'tr');\r\n            } else {\r\n                return bValue.localeCompare(aValue, 'tr');\r\n            }\r\n        }\r\n    });\r\n    \r\n    // Sıralanmış satırları tabloya ekle\r\n    rows.forEach(row => table.appendChild(row));\r\n}\r\n</script>\r\n\r\n<?php include '../../../includes/footer.php'; ?>"
        }
    ]
}
{
    "sourceFile": "views/Yonetim/Tanimlar/users.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1761059006468,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1761059006468,
            "name": "Commit-0",
            "content": "<?php\r\n$pageTitle = \"Kullanıcı Yönetimi\";\r\n$breadcrumbs = [\r\n    ['title' => 'Kullanıcı Yönetimi']\r\n];\r\n\r\n// Auth kontrol\r\nrequire_once '../../../auth.php';\r\n$currentUser = checkAuth();\r\ncheckUserStatus();\r\nupdateLastActivity();\r\n\r\n// Sayfa yetkilendirme kontrolü\r\n$sayfaYetkileri = [\r\n    'gor' => false,\r\n    'kendi_kullanicini_gor' => false,\r\n    'ekle' => false,\r\n    'duzenle' => false,\r\n    'sil' => false\r\n];\r\n\r\n// Admin kontrolü (group_id = 1 ise tüm yetkilere sahip)\r\n$isAdmin = ($currentUser['group_id'] == 1);\r\n\r\nif ($isAdmin) {\r\n    // Admin için tüm yetkileri aç\r\n    $sayfaYetkileri = [\r\n        'gor' => 1,\r\n        'kendi_kullanicini_gor' => 0, // 0 = Herkesi görebilir\r\n        'ekle' => 1,\r\n        'duzenle' => 1,\r\n        'sil' => 1\r\n    ];\r\n} else {\r\n    // Admin değilse normal yetki kontrolü yap\r\n    try {\r\n        $conn = getDatabaseConnection();\r\n        \r\n        // Mevcut sayfa URL'sini al\r\n        $currentPageUrl = basename($_SERVER['PHP_SELF']);\r\n        \r\n        // Sayfa bilgisini ve yetkilerini çek\r\n        $yetkiSql = \"\r\n            SELECT \r\n                tsy.gor,\r\n                tsy.kendi_kullanicini_gor,\r\n                tsy.ekle,\r\n                tsy.duzenle,\r\n                tsy.sil,\r\n                tsy.durum as yetki_durum,\r\n                ts.durum as sayfa_durum\r\n            FROM dbo.tanim_sayfalar ts\r\n            INNER JOIN dbo.tanim_sayfa_yetkiler tsy ON ts.sayfa_id = tsy.sayfa_id\r\n            WHERE ts.sayfa_url = ?\r\n            AND tsy.user_group_id = ?\r\n            AND ts.durum = 1\r\n            AND tsy.durum = 1\r\n        \";\r\n        \r\n        $yetkiStmt = $conn->prepare($yetkiSql);\r\n        $yetkiStmt->execute([$currentPageUrl, $currentUser['group_id']]);\r\n        $yetkiResult = $yetkiStmt->fetch(PDO::FETCH_ASSOC);\r\n        \r\n        if ($yetkiResult) {\r\n            $sayfaYetkileri = [\r\n                'gor' => (int)$yetkiResult['gor'],\r\n                'kendi_kullanicini_gor' => (int)$yetkiResult['kendi_kullanicini_gor'],\r\n                'ekle' => (int)$yetkiResult['ekle'],\r\n                'duzenle' => (int)$yetkiResult['duzenle'],\r\n                'sil' => (int)$yetkiResult['sil']\r\n            ];\r\n            \r\n            // Görme yetkisi yoksa (0 ise) sayfaya erişimi engelle\r\n            if ($sayfaYetkileri['gor'] == 0) {\r\n                header('Location: ../../../index.php?error=yetki_yok');\r\n                exit;\r\n            }\r\n        } else {\r\n            // Yetki tanımı bulunamazsa erişimi engelle\r\n            header('Location: ../../../index.php?error=yetki_tanimlanmamis');\r\n            exit;\r\n        }\r\n        \r\n    } catch (Exception $e) {\r\n        // Hata durumunda güvenlik için erişimi engelle\r\n        error_log(\"Yetki kontrol hatası: \" . $e->getMessage());\r\n        header('Location: ../../../index.php?error=sistem_hatasi');\r\n        exit;\r\n    }\r\n}\r\n\r\n// Veritabanı bağlantı fonksiyonu auth.php dosyasından kullanılıyor\r\n\r\n$message = '';\r\n$messageType = '';\r\n\r\n// Kullanıcı işlemleri\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    try {\r\n        $conn = getDatabaseConnection();\r\n        \r\n        $action = $_POST['action'] ?? '';\r\n        \r\n        switch ($action) {\r\n            case 'add':\r\n                // Ekleme yetkisi kontrolü\r\n                if ($sayfaYetkileri['ekle'] != 1) {\r\n                    $message = 'Kullanıcı ekleme yetkiniz bulunmamaktadır.';\r\n                    $messageType = 'danger';\r\n                    break;\r\n                }\r\n                \r\n                $email = trim($_POST['email']);\r\n                $password = $_POST['password'];\r\n                $firstName = trim($_POST['first_name']);\r\n                $lastName = trim($_POST['last_name']);\r\n                $phone = trim($_POST['phone']);\r\n                $status = $_POST['status'];\r\n                $groupId = $_POST['user_group_id'] ? (int)$_POST['user_group_id'] : null;\r\n                \r\n                // Email kontrolü\r\n                $checkSql = \"SELECT id FROM users WHERE email = ?\";\r\n                $checkStmt = $conn->prepare($checkSql);\r\n                $checkStmt->execute([$email]);\r\n                \r\n                if ($checkStmt->fetch()) {\r\n                    $message = 'Bu e-posta adresi zaten kullanılıyor.';\r\n                    $messageType = 'danger';\r\n                } else {\r\n                    $passwordHash = password_hash($password, PASSWORD_DEFAULT);\r\n                    \r\n                    $sql = \"INSERT INTO users (email, password_hash, first_name, last_name, phone, status, user_group_id) \r\n                            VALUES (?, ?, ?, ?, ?, ?, ?)\";\r\n                    $stmt = $conn->prepare($sql);\r\n                    $stmt->execute([$email, $passwordHash, $firstName, $lastName, $phone, $status, $groupId]);\r\n                    \r\n                    $message = 'Kullanıcı başarıyla eklendi.';\r\n                    $messageType = 'success';\r\n                }\r\n                break;\r\n                \r\n            case 'edit':\r\n                // Düzenleme yetkisi kontrolü\r\n                if ($sayfaYetkileri['duzenle'] != 1) {\r\n                    $message = 'Kullanıcı düzenleme yetkiniz bulunmamaktadır.';\r\n                    $messageType = 'danger';\r\n                    break;\r\n                }\r\n                \r\n                $id = $_POST['id'];\r\n                $email = trim($_POST['email']);\r\n                $firstName = trim($_POST['first_name']);\r\n                $lastName = trim($_POST['last_name']);\r\n                $phone = trim($_POST['phone']);\r\n                $status = $_POST['status'];\r\n                $groupId = $_POST['user_group_id'] ? (int)$_POST['user_group_id'] : null;\r\n                \r\n                // Email kontrolü (mevcut kullanıcı hariç)\r\n                $checkSql = \"SELECT id FROM users WHERE email = ? AND id != ?\";\r\n                $checkStmt = $conn->prepare($checkSql);\r\n                $checkStmt->execute([$email, $id]);\r\n                \r\n                if ($checkStmt->fetch()) {\r\n                    $message = 'Bu e-posta adresi başka bir kullanıcı tarafından kullanılıyor.';\r\n                    $messageType = 'danger';\r\n                } else {\r\n                    $sql = \"UPDATE users SET email = ?, first_name = ?, last_name = ?, phone = ?, status = ?, user_group_id = ?, updated_at = GETDATE() \r\n                            WHERE id = ?\";\r\n                    $stmt = $conn->prepare($sql);\r\n                    $stmt->execute([$email, $firstName, $lastName, $phone, $status, $groupId, $id]);\r\n                    \r\n                    $message = 'Kullanıcı başarıyla güncellendi.';\r\n                    $messageType = 'success';\r\n                }\r\n                break;\r\n                \r\n            case 'change_password':\r\n                // Düzenleme yetkisi kontrolü (şifre değiştirme de düzenleme sayılır)\r\n                if ($sayfaYetkileri['duzenle'] != 1) {\r\n                    $message = 'Şifre değiştirme yetkiniz bulunmamaktadır.';\r\n                    $messageType = 'danger';\r\n                    break;\r\n                }\r\n                \r\n                $id = $_POST['id'];\r\n                $newPassword = $_POST['new_password'];\r\n                $passwordHash = password_hash($newPassword, PASSWORD_DEFAULT);\r\n                \r\n                $sql = \"UPDATE users SET password_hash = ?, updated_at = GETDATE() WHERE id = ?\";\r\n                $stmt = $conn->prepare($sql);\r\n                $stmt->execute([$passwordHash, $id]);\r\n                \r\n                $message = 'Şifre başarıyla değiştirildi.';\r\n                $messageType = 'success';\r\n                break;\r\n                \r\n            case 'delete':\r\n                // Silme yetkisi kontrolü\r\n                if ($sayfaYetkileri['sil'] != 1) {\r\n                    $message = 'Kullanıcı silme yetkiniz bulunmamaktadır.';\r\n                    $messageType = 'danger';\r\n                    break;\r\n                }\r\n                \r\n                $id = $_POST['id'];\r\n                \r\n                // Kendi hesabını silmeye çalışıyor mu?\r\n                if ($id == $currentUser['id']) {\r\n                    $message = 'Kendi hesabınızı silemezsiniz.';\r\n                    $messageType = 'danger';\r\n                } else {\r\n                    $sql = \"DELETE FROM users WHERE id = ?\";\r\n                    $stmt = $conn->prepare($sql);\r\n                    $stmt->execute([$id]);\r\n                    \r\n                    $message = 'Kullanıcı başarıyla silindi.';\r\n                    $messageType = 'success';\r\n                }\r\n                break;\r\n        }\r\n    } catch (Exception $e) {\r\n        $message = 'Hata: ' . $e->getMessage();\r\n        $messageType = 'danger';\r\n    }\r\n}\r\n\r\n// Kullanıcı gruplarını al\r\ntry {\r\n    $conn = getDatabaseConnection();\r\n    \r\n    $groupSql = \"SELECT id, group_name, group_description as description FROM user_groups ORDER BY group_name\";\r\n    $groupStmt = $conn->prepare($groupSql);\r\n    $groupStmt->execute();\r\n    $userGroups = $groupStmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n} catch (Exception $e) {\r\n    $userGroups = [];\r\n}\r\n\r\n// Kullanıcıları listele (grup bilgileri ile birlikte)\r\n$users = [];\r\n$error = '';\r\ntry {\r\n    $conn = getDatabaseConnection();\r\n    \r\n    // kendi_kullanicini_gor = 1 ise sadece kendi kaydını getir\r\n    if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1) {\r\n        $sql = \"SELECT u.id, u.email, u.first_name, u.last_name, u.phone, u.status, u.created_at, \r\n                       u.last_login, u.login_attempts, u.user_group_id,\r\n                       ug.group_name, ug.group_description as group_description\r\n                FROM users u \r\n                LEFT JOIN user_groups ug ON u.user_group_id = ug.id\r\n                WHERE u.id = ?\r\n                ORDER BY u.created_at DESC\";\r\n        $stmt = $conn->prepare($sql);\r\n        $stmt->execute([$currentUser['id']]);\r\n    } else {\r\n        // kendi_kullanicini_gor = 0 ise tüm kullanıcıları getir\r\n        $sql = \"SELECT u.id, u.email, u.first_name, u.last_name, u.phone, u.status, u.created_at, \r\n                       u.last_login, u.login_attempts, u.user_group_id,\r\n                       ug.group_name, ug.group_description as group_description\r\n                FROM users u \r\n                LEFT JOIN user_groups ug ON u.user_group_id = ug.id\r\n                ORDER BY u.created_at DESC\";\r\n        $stmt = $conn->prepare($sql);\r\n        $stmt->execute();\r\n    }\r\n    \r\n    $users = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    // Debug için\r\n    error_log(\"Users query executed. Found \" . count($users) . \" users.\");\r\n    \r\n} catch (Exception $e) {\r\n    $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n    error_log(\"Users query error: \" . $e->getMessage());\r\n}\r\n\r\ninclude '../../../includes/header.php';\r\n?>\r\n\r\n<div class=\"container-fluid mt-4\">\r\n    <div class=\"row\">\r\n        <div class=\"col-12\">\r\n            <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n                <h2><i class=\"fas fa-users me-2\"></i>Kullanıcı Yönetimi</h2>\r\n                <?php if ($sayfaYetkileri['ekle'] == 1): ?>\r\n                <button class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#addUserModal\">\r\n                    <i class=\"fas fa-plus me-1\"></i>Yeni Kullanıcı\r\n                </button>\r\n                <?php endif; ?>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <?php if ($message): ?>\r\n        <div class=\"alert alert-<?php echo $messageType; ?> alert-dismissible fade show\" role=\"alert\">\r\n            <i class=\"fas fa-<?php echo $messageType === 'success' ? 'check-circle' : 'exclamation-triangle'; ?> me-2\"></i>\r\n            <?php echo htmlspecialchars($message); ?>\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n        </div>\r\n    <?php endif; ?>\r\n\r\n    <?php if ($error): ?>\r\n        <div class=\"alert alert-danger alert-dismissible fade show\" role=\"alert\">\r\n            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n            <?php echo htmlspecialchars($error); ?>\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n        </div>\r\n    <?php endif; ?>\r\n\r\n    <?php if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1): ?>\r\n        <div class=\"alert alert-info alert-dismissible fade show\" role=\"alert\">\r\n            <i class=\"fas fa-info-circle me-2\"></i>\r\n            Sadece kendi kullanıcı bilgilerinizi görüntüleyebilirsiniz.\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n        </div>\r\n    <?php endif; ?>\r\n\r\n    <!-- Kullanıcılar Tablosu -->\r\n    <div class=\"card border-0 shadow-sm\">\r\n        <div class=\"card-header bg-primary text-white\">\r\n            <h5 class=\"mb-0\">\r\n                <i class=\"fas fa-list me-2\"></i>Kullanıcı Listesi\r\n            </h5>\r\n        </div>\r\n        <div class=\"card-body p-0\">\r\n            <div class=\"table-responsive\">\r\n                <table class=\"table table-hover mb-0\">\r\n                    <thead class=\"table-light\">\r\n                        <tr>\r\n                            <th>ID</th>\r\n                            <th>Ad Soyad</th>\r\n                            <th>E-posta</th>\r\n                            <th>Telefon</th>\r\n                            <th>Grup</th>\r\n                            <th>Durum</th>\r\n                            <th>Kayıt Tarihi</th>\r\n                            <th>Son Giriş</th>\r\n                            <th>İşlemler</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        <?php if (!empty($users)): ?>\r\n                            <!-- Debug: <?php echo count($users); ?> kullanıcı bulundu -->\r\n                            <?php foreach ($users as $user): ?>\r\n                                <tr>\r\n                                    <td><?php echo $user['id']; ?></td>\r\n                                    <td>\r\n                                        <strong><?php echo htmlspecialchars($user['first_name'] . ' ' . $user['last_name']); ?></strong>\r\n                                        <?php if ($user['id'] == $currentUser['id']): ?>\r\n                                            <span class=\"badge bg-info ms-1\">Sen</span>\r\n                                        <?php endif; ?>\r\n                                    </td>\r\n                                    <td><?php echo htmlspecialchars($user['email']); ?></td>\r\n                                    <td><?php echo htmlspecialchars($user['phone'] ?? '-'); ?></td>\r\n                                    <td>\r\n                                        <?php if ($user['group_name']): ?>\r\n                                            <?php\r\n                                            $groupClass = '';\r\n                                            $groupText = $user['group_name'];\r\n                                            switch ($user['group_name']) {\r\n                                                case 'admin': $groupClass = 'bg-danger'; break;\r\n                                                case 'bolge_yoneticisi': $groupClass = 'bg-warning text-dark'; break;\r\n                                                case 'bayi': $groupClass = 'bg-info'; break;\r\n                                                default: $groupClass = 'bg-primary'; break;\r\n                                            }\r\n                                            ?>\r\n                                            <span class=\"badge <?php echo $groupClass; ?>\" title=\"<?php echo htmlspecialchars($user['group_description'] ?? ''); ?>\">\r\n                                                <?php echo htmlspecialchars($groupText); ?>\r\n                                            </span>\r\n                                        <?php else: ?>\r\n                                            <span class=\"badge bg-secondary\">Grup Yok</span>\r\n                                        <?php endif; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php\r\n                                        $statusClass = '';\r\n                                        switch ($user['status']) {\r\n                                            case 'AKTIF': $statusClass = 'bg-success'; break;\r\n                                            case 'PASIF': $statusClass = 'bg-danger'; break;\r\n                                            case 'BEKLEMEDE': $statusClass = 'bg-warning'; break;\r\n                                        }\r\n                                        ?>\r\n                                        <span class=\"badge <?php echo $statusClass; ?>\">\r\n                                            <?php echo $user['status']; ?>\r\n                                        </span>\r\n                                        <?php if ($user['login_attempts'] >= 5): ?>\r\n                                            <span class=\"badge bg-danger ms-1\">Kilitli</span>\r\n                                        <?php endif; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo $user['created_at'] ? date('d.m.Y H:i', strtotime($user['created_at'])) : '-'; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo $user['last_login'] ? date('d.m.Y H:i', strtotime($user['last_login'])) : 'Hiç'; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <div class=\"btn-group\" role=\"group\">\r\n                                            <?php if ($sayfaYetkileri['duzenle'] == 1): ?>\r\n                                            <button type=\"button\" class=\"btn btn-sm btn-outline-primary\" \r\n                                                    onclick=\"editUser(<?php echo htmlspecialchars(json_encode($user)); ?>)\">\r\n                                                <i class=\"fas fa-edit\"></i>\r\n                                            </button>\r\n                                            <button type=\"button\" class=\"btn btn-sm btn-outline-warning\" \r\n                                                    onclick=\"changePassword(<?php echo $user['id']; ?>, '<?php echo htmlspecialchars($user['first_name'] . ' ' . $user['last_name']); ?>')\">\r\n                                                <i class=\"fas fa-key\"></i>\r\n                                            </button>\r\n                                            <?php endif; ?>\r\n                                            <?php if ($sayfaYetkileri['sil'] == 1 && $user['id'] != $currentUser['id']): ?>\r\n                                            <button type=\"button\" class=\"btn btn-sm btn-outline-danger\" \r\n                                                    onclick=\"deleteUser(<?php echo $user['id']; ?>, '<?php echo htmlspecialchars($user['first_name'] . ' ' . $user['last_name']); ?>')\">\r\n                                                <i class=\"fas fa-trash\"></i>\r\n                                            </button>\r\n                                            <?php endif; ?>\r\n                                            <?php if ($sayfaYetkileri['duzenle'] == 0 && $sayfaYetkileri['sil'] == 0): ?>\r\n                                            <span class=\"badge bg-secondary\">Yetki Yok</span>\r\n                                            <?php endif; ?>\r\n                                        </div>\r\n                                    </td>\r\n                                </tr>\r\n                            <?php endforeach; ?>\r\n                        <?php else: ?>\r\n                            <tr>\r\n                                <td colspan=\"9\" class=\"text-center py-5 text-muted\">\r\n                                    <i class=\"fas fa-users fa-3x mb-3 d-block\"></i>\r\n                                    <h5>Henüz kullanıcı bulunmuyor</h5>\r\n                                    <p>İlk kullanıcıyı eklemek için \"Yeni Kullanıcı\" butonuna tıklayın.</p>\r\n                                    <!-- Debug: Users array count = <?php echo count($users); ?> -->\r\n                                    <?php if ($error): ?>\r\n                                        <p class=\"text-danger\">Hata: <?php echo htmlspecialchars($error); ?></p>\r\n                                    <?php endif; ?>\r\n                                </td>\r\n                            </tr>\r\n                        <?php endif; ?>\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Yeni Kullanıcı Modal -->\r\n<div class=\"modal fade\" id=\"addUserModal\" tabindex=\"-1\">\r\n    <div class=\"modal-dialog\">\r\n        <div class=\"modal-content\">\r\n            <form method=\"POST\" action=\"\">\r\n                <input type=\"hidden\" name=\"action\" value=\"add\">\r\n                <div class=\"modal-header\">\r\n                    <h5 class=\"modal-title\">\r\n                        <i class=\"fas fa-user-plus me-2\"></i>Yeni Kullanıcı Ekle\r\n                    </h5>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"add_first_name\" class=\"form-label\">Ad</label>\r\n                            <input type=\"text\" class=\"form-control\" id=\"add_first_name\" name=\"first_name\" required>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"add_last_name\" class=\"form-label\">Soyad</label>\r\n                            <input type=\"text\" class=\"form-control\" id=\"add_last_name\" name=\"last_name\" required>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"add_email\" class=\"form-label\">E-posta</label>\r\n                        <input type=\"email\" class=\"form-control\" id=\"add_email\" name=\"email\" required>\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"add_password\" class=\"form-label\">Şifre</label>\r\n                        <input type=\"password\" class=\"form-control\" id=\"add_password\" name=\"password\" required minlength=\"6\">\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"add_phone\" class=\"form-label\">Telefon</label>\r\n                        <input type=\"tel\" class=\"form-control\" id=\"add_phone\" name=\"phone\">\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"add_group\" class=\"form-label\">Kullanıcı Grubu</label>\r\n                        <select class=\"form-select\" id=\"add_group\" name=\"user_group_id\" required>\r\n                            <option value=\"\">Grup Seçin</option>\r\n                            <?php foreach ($userGroups as $group): ?>\r\n                                <option value=\"<?php echo $group['id']; ?>\">\r\n                                    <?php \r\n                                    $displayName = htmlspecialchars($group['group_name']);\r\n                                    if (!empty($group['description'])) {\r\n                                        $displayName .= ' - ' . htmlspecialchars($group['description']);\r\n                                    }\r\n                                    echo $displayName;\r\n                                    ?>\r\n                                </option>\r\n                            <?php endforeach; ?>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"add_status\" class=\"form-label\">Durum</label>\r\n                        <select class=\"form-select\" id=\"add_status\" name=\"status\" required>\r\n                            <option value=\"AKTIF\">Aktif</option>\r\n                            <option value=\"PASIF\">Pasif</option>\r\n                            <option value=\"BEKLEMEDE\">Beklemede</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-primary\">\r\n                        <i class=\"fas fa-save me-1\"></i>Kaydet\r\n                    </button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Kullanıcı Düzenle Modal -->\r\n<div class=\"modal fade\" id=\"editUserModal\" tabindex=\"-1\">\r\n    <div class=\"modal-dialog\">\r\n        <div class=\"modal-content\">\r\n            <form method=\"POST\" action=\"\">\r\n                <input type=\"hidden\" name=\"action\" value=\"edit\">\r\n                <input type=\"hidden\" name=\"id\" id=\"edit_id\">\r\n                <div class=\"modal-header\">\r\n                    <h5 class=\"modal-title\">\r\n                        <i class=\"fas fa-user-edit me-2\"></i>Kullanıcı Düzenle\r\n                    </h5>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"edit_first_name\" class=\"form-label\">Ad</label>\r\n                            <input type=\"text\" class=\"form-control\" id=\"edit_first_name\" name=\"first_name\" required>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"edit_last_name\" class=\"form-label\">Soyad</label>\r\n                            <input type=\"text\" class=\"form-control\" id=\"edit_last_name\" name=\"last_name\" required>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"edit_email\" class=\"form-label\">E-posta</label>\r\n                        <input type=\"email\" class=\"form-control\" id=\"edit_email\" name=\"email\" required>\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"edit_phone\" class=\"form-label\">Telefon</label>\r\n                        <input type=\"tel\" class=\"form-control\" id=\"edit_phone\" name=\"phone\">\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"edit_group\" class=\"form-label\">Kullanıcı Grubu</label>\r\n                        <select class=\"form-select\" id=\"edit_group\" name=\"user_group_id\">\r\n                            <option value=\"\">Grup Seçin</option>\r\n                            <?php foreach ($userGroups as $group): ?>\r\n                                <option value=\"<?php echo $group['id']; ?>\">\r\n                                    <?php \r\n                                    $displayName = htmlspecialchars($group['group_name']);\r\n                                    if (!empty($group['description'])) {\r\n                                        $displayName .= ' - ' . htmlspecialchars($group['description']);\r\n                                    }\r\n                                    echo $displayName;\r\n                                    ?>\r\n                                </option>\r\n                            <?php endforeach; ?>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"edit_status\" class=\"form-label\">Durum</label>\r\n                        <select class=\"form-select\" id=\"edit_status\" name=\"status\" required>\r\n                            <option value=\"AKTIF\">Aktif</option>\r\n                            <option value=\"PASIF\">Pasif</option>\r\n                            <option value=\"BEKLEMEDE\">Beklemede</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-primary\">\r\n                        <i class=\"fas fa-save me-1\"></i>Güncelle\r\n                    </button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Şifre Değiştir Modal -->\r\n<div class=\"modal fade\" id=\"changePasswordModal\" tabindex=\"-1\">\r\n    <div class=\"modal-dialog\">\r\n        <div class=\"modal-content\">\r\n            <form method=\"POST\" action=\"\">\r\n                <input type=\"hidden\" name=\"action\" value=\"change_password\">\r\n                <input type=\"hidden\" name=\"id\" id=\"password_id\">\r\n                <div class=\"modal-header\">\r\n                    <h5 class=\"modal-title\">\r\n                        <i class=\"fas fa-key me-2\"></i>Şifre Değiştir\r\n                    </h5>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <p id=\"password_user_name\" class=\"text-muted\"></p>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"new_password\" class=\"form-label\">Yeni Şifre</label>\r\n                        <input type=\"password\" class=\"form-control\" id=\"new_password\" name=\"new_password\" required minlength=\"6\">\r\n                        <div class=\"form-text\">Minimum 6 karakter olmalıdır.</div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-warning\">\r\n                        <i class=\"fas fa-key me-1\"></i>Şifreyi Değiştir\r\n                    </button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\r\n<script>\r\nfunction editUser(user) {\r\n    document.getElementById('edit_id').value = user.id;\r\n    document.getElementById('edit_first_name').value = user.first_name;\r\n    document.getElementById('edit_last_name').value = user.last_name;\r\n    document.getElementById('edit_email').value = user.email;\r\n    document.getElementById('edit_phone').value = user.phone || '';\r\n    document.getElementById('edit_group').value = user.user_group_id || '';\r\n    document.getElementById('edit_status').value = user.status;\r\n    \r\n    new bootstrap.Modal(document.getElementById('editUserModal')).show();\r\n}\r\n\r\nfunction changePassword(userId, userName) {\r\n    document.getElementById('password_id').value = userId;\r\n    document.getElementById('password_user_name').textContent = userName + ' kullanıcısının şifresini değiştiriyorsunuz.';\r\n    document.getElementById('new_password').value = '';\r\n    \r\n    new bootstrap.Modal(document.getElementById('changePasswordModal')).show();\r\n}\r\n\r\nfunction deleteUser(userId, userName) {\r\n    if (confirm(userName + ' kullanıcısını silmek istediğinizden emin misiniz?\\n\\nBu işlem geri alınamaz.')) {\r\n        const form = document.createElement('form');\r\n        form.method = 'POST';\r\n        form.innerHTML = `\r\n            <input type=\"hidden\" name=\"action\" value=\"delete\">\r\n            <input type=\"hidden\" name=\"id\" value=\"${userId}\">\r\n        `;\r\n        document.body.appendChild(form);\r\n        form.submit();\r\n    }\r\n}\r\n</script>\r\n\r\n<?php include '../../../includes/footer.php'; ?>\r\n"
        }
    ]
}
{
    "sourceFile": "views/Yonetim/Primebaz/primebaz_rapor_yukle.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1761061099046,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1761061099046,
            "name": "Commit-0",
            "content": "<?php\r\nerror_reporting(E_ALL);\r\nini_set('display_errors', 1);\r\n\r\nrequire_once '../../../auth.php';\r\n\r\n// Kullanıcı kimlik doğrulaması\r\n$currentUser = checkAuth();\r\ncheckUserStatus();\r\nupdateLastActivity();\r\n\r\n// Sayfa yetkilendirme kontrolü\r\n$sayfaYetkileri = [\r\n    'gor' => false,\r\n    'kendi_kullanicini_gor' => false,\r\n    'ekle' => false,\r\n    'duzenle' => false,\r\n    'sil' => false\r\n];\r\n\r\n// Admin kontrolü (group_id = 1 ise tüm yetkilere sahip)\r\n$isAdmin = ($currentUser['group_id'] == 1);\r\n\r\nif ($isAdmin) {\r\n    // Admin için tüm yetkileri aç\r\n    $sayfaYetkileri = [\r\n        'gor' => 1,\r\n        'kendi_kullanicini_gor' => 0,\r\n        'ekle' => 1,\r\n        'duzenle' => 1,\r\n        'sil' => 1\r\n    ];\r\n} else {\r\n    // Admin değilse normal yetki kontrolü yap\r\n    try {\r\n        $conn = getDatabaseConnection();\r\n        \r\n        // Mevcut sayfa URL'sini al\r\n        $currentPageUrl = basename($_SERVER['PHP_SELF']);\r\n        \r\n        // Sayfa bilgisini ve yetkilerini çek\r\n        $yetkiSql = \"\r\n            SELECT \r\n                tsy.gor,\r\n                tsy.kendi_kullanicini_gor,\r\n                tsy.ekle,\r\n                tsy.duzenle,\r\n                tsy.sil,\r\n                tsy.durum as yetki_durum,\r\n                ts.durum as sayfa_durum\r\n            FROM dbo.tanim_sayfalar ts\r\n            INNER JOIN dbo.tanim_sayfa_yetkiler tsy ON ts.sayfa_id = tsy.sayfa_id\r\n            WHERE ts.sayfa_url = ?\r\n            AND tsy.user_group_id = ?\r\n            AND ts.durum = 1\r\n            AND tsy.durum = 1\r\n        \";\r\n        \r\n        $yetkiStmt = $conn->prepare($yetkiSql);\r\n        $yetkiStmt->execute([$currentPageUrl, $currentUser['group_id']]);\r\n        $yetkiResult = $yetkiStmt->fetch(PDO::FETCH_ASSOC);\r\n        \r\n        if ($yetkiResult) {\r\n            $sayfaYetkileri = [\r\n                'gor' => (int)$yetkiResult['gor'],\r\n                'kendi_kullanicini_gor' => (int)$yetkiResult['kendi_kullanicini_gor'],\r\n                'ekle' => (int)$yetkiResult['ekle'],\r\n                'duzenle' => (int)$yetkiResult['duzenle'],\r\n                'sil' => (int)$yetkiResult['sil']\r\n            ];\r\n            \r\n            // Görme yetkisi yoksa (0 ise) sayfaya erişimi engelle\r\n            if ($sayfaYetkileri['gor'] == 0) {\r\n                header('Location: ../../../index.php?error=yetki_yok');\r\n                exit;\r\n            }\r\n        } else {\r\n            // Yetki tanımı bulunamazsa erişimi engelle\r\n            header('Location: ../../../index.php?error=yetki_tanimlanmamis');\r\n            exit;\r\n        }\r\n        \r\n    } catch (Exception $e) {\r\n        // Hata durumunda güvenlik için erişimi engelle\r\n        error_log(\"Yetki kontrol hatası: \" . $e->getMessage());\r\n        header('Location: ../../../index.php?error=sistem_hatasi');\r\n        exit;\r\n    }\r\n}\r\n\r\nclass PrimebazMSSQLConnection {\r\n    private $connection;\r\n    \r\n    public function __construct() {\r\n        // getDatabaseConnection fonksiyonunu kullan\r\n        $this->connection = getDatabaseConnection();\r\n    }\r\n    \r\n    public function getConnection() {\r\n        return $this->connection;\r\n    }\r\n    \r\n    public function createPrimebazRaporTable() {\r\n        $sql = \"\r\n        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='primebaz_rapor' AND xtype='U')\r\n        CREATE TABLE primebaz_rapor (\r\n            id INT IDENTITY(1,1) PRIMARY KEY,\r\n            prim_detay NVARCHAR(400) NULL,\r\n            prim_donem NVARCHAR(100) NULL,\r\n            memo_acan_personel_kimlik NVARCHAR(100) NULL,\r\n            bolge NVARCHAR(200) NULL,\r\n            bayi_yoneticisi NVARCHAR(200) NULL,\r\n            bayi_tip NVARCHAR(100) NULL,\r\n            bayi_kodu INT NULL,\r\n            bayi_adi NVARCHAR(300) NULL,\r\n            sozlesme_no NVARCHAR(100) NULL,\r\n            account_no INT NULL,\r\n            outlet_no INT NULL,\r\n            potansiyel_no INT NULL,\r\n            kampanya_kodu NVARCHAR(200) NULL,\r\n            sozlesme_durumu INT NULL,\r\n            uye_durumu NVARCHAR(200) NULL,\r\n            odeme_durum INT NULL,\r\n            odeme_tarihi DATE NULL,\r\n            prim_ust_urun_grubu NVARCHAR(200) NULL,\r\n            basic_basari_skala NVARCHAR(40) NULL,\r\n            cinema_basari_skala NVARCHAR(40) NULL,\r\n            sport_basari_skala NVARCHAR(40) NULL,\r\n            genel_basari_skala NVARCHAR(40) NULL,\r\n            isp_basari_skala NVARCHAR(40) NULL,\r\n            uyelik_turu NVARCHAR(100) NULL,\r\n            kurulum_ziyaret_tipi NVARCHAR(200) NULL,\r\n            kurulum_tipi_aciklama NVARCHAR(400) NULL,\r\n            eski_ref_prim DECIMAL(12,2) NULL,\r\n            odenecek_prim DECIMAL(12,2) NULL,\r\n            mahsup_tutari_odeme_durumu DECIMAL(12,2) NULL,\r\n            yonlendirme NVARCHAR(300) NULL,\r\n            prim_durum_aciklama NVARCHAR(1000) NULL,\r\n            dosya_adi NVARCHAR(510) NULL,\r\n            yuklenme_tarihi DATETIME NOT NULL DEFAULT GETDATE()\r\n        );\r\n        \";\r\n        \r\n        try {\r\n            $this->connection->exec($sql);\r\n        } catch (PDOException $e) {\r\n            throw new Exception('Tablo oluşturma hatası: ' . $e->getMessage());\r\n        }\r\n    }\r\n    \r\n    public function truncateTable() {\r\n        $sql = \"TRUNCATE TABLE primebaz_rapor\";\r\n        $this->connection->exec($sql);\r\n    }\r\n    \r\n    public function convertDateFormat($dateString) {\r\n        if (empty($dateString)) {\r\n            return null;\r\n        }\r\n        \r\n        // Excel'den gelen tarih formatları\r\n        $formats = [\r\n            'd.m.Y',\r\n            'd/m/Y',\r\n            'm/d/Y',\r\n            'Y-m-d',\r\n            'd-m-Y',\r\n            'Y/m/d',\r\n            'd.m.Y H:i:s',\r\n            'd/m/Y H:i:s',\r\n            'Y-m-d H:i:s'\r\n        ];\r\n        \r\n        foreach ($formats as $format) {\r\n            $date = DateTime::createFromFormat($format, $dateString);\r\n            if ($date !== false) {\r\n                return $date->format('Y-m-d');\r\n            }\r\n        }\r\n        \r\n        // Excel serial date kontrolü (örn: 44927)\r\n        if (is_numeric($dateString) && $dateString > 1 && $dateString < 100000) {\r\n            try {\r\n                $unixTimestamp = ($dateString - 25569) * 86400;\r\n                $date = new DateTime('@' . $unixTimestamp);\r\n                return $date->format('Y-m-d');\r\n            } catch (Exception $e) {\r\n                return null;\r\n            }\r\n        }\r\n        \r\n        return null;\r\n    }\r\n    \r\n    public function convertDecimal($value) {\r\n        if (empty($value) || !is_numeric($value)) {\r\n            return null;\r\n        }\r\n        return floatval($value);\r\n    }\r\n    \r\n    public function convertInteger($value) {\r\n        if (empty($value) || !is_numeric($value)) {\r\n            return null;\r\n        }\r\n        return intval($value);\r\n    }\r\n    \r\n    public function readExcelAsXML($excelFilePath) {\r\n        // .xlsx dosyalarını ZIP olarak aç ve XML'den oku\r\n        if (pathinfo($excelFilePath, PATHINFO_EXTENSION) !== 'xlsx') {\r\n            throw new Exception('Sadece .xlsx formatı destekleniyor. Lütfen dosyayı .xlsx formatında kaydedin.');\r\n        }\r\n        \r\n        if (!file_exists($excelFilePath)) {\r\n            throw new Exception('Excel dosyası bulunamadı: ' . $excelFilePath);\r\n        }\r\n        \r\n        if (!is_readable($excelFilePath)) {\r\n            throw new Exception('Excel dosyası okunamıyor: ' . $excelFilePath);\r\n        }\r\n        \r\n        $zip = new ZipArchive();\r\n        $result = $zip->open($excelFilePath);\r\n        if ($result !== TRUE) {\r\n            $errorMessages = [\r\n                ZipArchive::ER_OK => 'No error',\r\n                ZipArchive::ER_MULTIDISK => 'Multi-disk zip archives not supported',\r\n                ZipArchive::ER_RENAME => 'Renaming temporary file failed',\r\n                ZipArchive::ER_CLOSE => 'Closing zip archive failed',\r\n                ZipArchive::ER_SEEK => 'Seek error',\r\n                ZipArchive::ER_READ => 'Read error',\r\n                ZipArchive::ER_WRITE => 'Write error',\r\n                ZipArchive::ER_CRC => 'CRC error',\r\n                ZipArchive::ER_ZIPCLOSED => 'Containing zip archive was closed',\r\n                ZipArchive::ER_NOENT => 'No such file',\r\n                ZipArchive::ER_EXISTS => 'File already exists',\r\n                ZipArchive::ER_OPEN => 'Can not open file',\r\n                ZipArchive::ER_TMPOPEN => 'Failure to create temporary file',\r\n                ZipArchive::ER_ZLIB => 'Zlib error',\r\n                ZipArchive::ER_MEMORY => 'Memory allocation failure',\r\n                ZipArchive::ER_CHANGED => 'Entry has been changed',\r\n                ZipArchive::ER_COMPNOTSUPP => 'Compression method not supported',\r\n                ZipArchive::ER_EOF => 'Premature EOF',\r\n                ZipArchive::ER_INVAL => 'Invalid argument',\r\n                ZipArchive::ER_NOZIP => 'Not a zip archive',\r\n                ZipArchive::ER_INTERNAL => 'Internal error',\r\n                ZipArchive::ER_INCONS => 'Zip archive inconsistent',\r\n                ZipArchive::ER_REMOVE => 'Can not remove file',\r\n                ZipArchive::ER_DELETED => 'Entry has been deleted'\r\n            ];\r\n            \r\n            $errorMsg = isset($errorMessages[$result]) ? $errorMessages[$result] : 'Unknown error';\r\n            throw new Exception('Excel dosyası açılamadı. Hata kodu: ' . $result . ' (' . $errorMsg . '). Dosya bozuk olabilir.');\r\n        }\r\n        \r\n        // Shared strings oku\r\n        $sharedStrings = [];\r\n        $sharedStringsXML = $zip->getFromName('xl/sharedStrings.xml');\r\n        if ($sharedStringsXML) {\r\n            $xml = @simplexml_load_string($sharedStringsXML);\r\n            if ($xml === false) {\r\n                error_log('PRIMEBAZ: SharedStrings XML parse hatası');\r\n            } else {\r\n                foreach ($xml->si as $si) {\r\n                    $sharedStrings[] = (string)$si->t;\r\n                }\r\n            }\r\n        }\r\n        \r\n        // İlk worksheet'i oku\r\n        $worksheetXML = $zip->getFromName('xl/worksheets/sheet1.xml');\r\n        if (!$worksheetXML) {\r\n            // Alternatif worksheet isimlerini dene\r\n            $worksheetXML = $zip->getFromName('xl/worksheets/sheet.xml');\r\n            if (!$worksheetXML) {\r\n                throw new Exception('Worksheet bulunamadı. Dosyada geçerli bir çalışma sayfası yok.');\r\n            }\r\n        }\r\n        \r\n        $xml = @simplexml_load_string($worksheetXML);\r\n        if ($xml === false) {\r\n            throw new Exception('Worksheet XML parse edilemedi. Dosya bozuk olabilir.');\r\n        }\r\n        \r\n        if (!isset($xml->sheetData)) {\r\n            throw new Exception('Worksheet\\'te veri bulunamadı.');\r\n        }\r\n        $rows = [];\r\n        $rowIndex = 0;\r\n        \r\n        foreach ($xml->sheetData->row as $row) {\r\n            $rowData = [];\r\n            $cellIndex = 0;\r\n            $rowIndex++;\r\n            \r\n            try {\r\n                foreach ($row->c as $cell) {\r\n                    $cellValue = '';\r\n                    \r\n                    try {\r\n                        // Cell type kontrolü\r\n                        $cellType = (string)$cell['t'];\r\n                        if ($cellType === 's') {\r\n                            // Shared string\r\n                            $stringIndex = (int)$cell->v;\r\n                            $cellValue = isset($sharedStrings[$stringIndex]) ? $sharedStrings[$stringIndex] : '';\r\n                        } else {\r\n                            // Normal değer\r\n                            $cellValue = (string)$cell->v;\r\n                        }\r\n                    } catch (Exception $e) {\r\n                        error_log(\"PRIMEBAZ: Cell okuma hatası - Row $rowIndex, Cell $cellIndex: \" . $e->getMessage());\r\n                        $cellValue = ''; // Hatalı cell'i boş bırak\r\n                    }\r\n                    \r\n                    $rowData[] = $cellValue;\r\n                    $cellIndex++;\r\n                }\r\n            } catch (Exception $e) {\r\n                error_log(\"PRIMEBAZ: Row okuma hatası - Row $rowIndex: \" . $e->getMessage());\r\n                // Hatalı satırı atla\r\n                continue;\r\n            }\r\n            \r\n            $rows[] = $rowData;\r\n        }\r\n        \r\n        $zip->close();\r\n        return $rows;\r\n    }\r\n    \r\n    public function convertExcelToCsv($excelFilePath) {\r\n        $csvFilePath = str_replace(['.xlsx', '.xls'], '.csv', $excelFilePath);\r\n        \r\n        // Eğer aynı isimde CSV dosyası varsa onu kullan\r\n        if (file_exists($csvFilePath)) {\r\n            return $csvFilePath;\r\n        }\r\n        \r\n        try {\r\n            // .xlsx dosyalarını XML olarak oku\r\n            if (pathinfo($excelFilePath, PATHINFO_EXTENSION) === 'xlsx') {\r\n                $rows = $this->readExcelAsXML($excelFilePath);\r\n                \r\n                // CSV dosyası oluştur\r\n                $handle = fopen($csvFilePath, 'w');\r\n                if (!$handle) {\r\n                    throw new Exception('CSV dosyası oluşturulamadı');\r\n                }\r\n                \r\n                foreach ($rows as $row) {\r\n                    fputcsv($handle, $row, ';');\r\n                }\r\n                \r\n                fclose($handle);\r\n                return $csvFilePath;\r\n            } else {\r\n                throw new Exception('.xls formatı desteklenmiyor. Lütfen dosyayı .xlsx formatında kaydedin.');\r\n            }\r\n            \r\n        } catch (Exception $e) {\r\n            throw new Exception('Excel dosyası okunamadı: ' . $e->getMessage() . '. Lütfen dosyayı Excel\\'de açıp CSV formatında (\".csv\") kaydedin.');\r\n        }\r\n    }\r\n    \r\n    public function processExcelFile($filePath, $fileName, $batchSize = 1000) {\r\n        // Dosya türüne göre işlem yap\r\n        $extension = strtolower(pathinfo($filePath, PATHINFO_EXTENSION));\r\n        \r\n        if ($extension === 'csv') {\r\n            $csvFilePath = $filePath; // Zaten CSV\r\n        } else {\r\n            // Excel dosyasını CSV'ye dönüştür\r\n            $csvFilePath = $this->convertExcelToCsv($filePath);\r\n        }\r\n        \r\n        try {\r\n            $handle = fopen($csvFilePath, 'r');\r\n            if (!$handle) {\r\n                throw new Exception('Dönüştürülen CSV dosyası açılamadı');\r\n            }\r\n            \r\n            // BOM kontrolü\r\n            $bom = fread($handle, 4);\r\n            if (substr($bom, 0, 3) === \"\\xEF\\xBB\\xBF\") {\r\n                fseek($handle, 3);\r\n            } else {\r\n                rewind($handle);\r\n            }\r\n            \r\n            // Başlık satırını oku\r\n            $headers = null;\r\n            $currentPos = ftell($handle);\r\n            $headers = fgetcsv($handle, 0, ';', '\"', '\\\\');\r\n            if (!$headers || count($headers) <= 1) {\r\n                fseek($handle, $currentPos);\r\n                $headers = fgetcsv($handle, 0, ',', '\"', '\\\\');\r\n                if (!$headers || count($headers) <= 1) {\r\n                    fseek($handle, $currentPos);\r\n                    $headers = fgetcsv($handle, 0, \"\\t\", '\"', '\\\\');\r\n                }\r\n            }\r\n            \r\n            if (!$headers || count($headers) <= 1) {\r\n                fclose($handle);\r\n                throw new Exception('CSV başlıkları okunamadı');\r\n            }\r\n            \r\n            $headers = array_map('trim', $headers);\r\n            \r\n            // Sütun eşleştirmesi (büyük/küçük harf duyarsız)\r\n            // Internal column names (veritabanı sütunları)\r\n            $expectedColumns = [\r\n                'prim_detay', 'prim_donem', 'memo_acan_personel_kimlik', 'bolge', 'bayi_yoneticisi',\r\n                'bayi_tip', 'bayi_kodu', 'bayi_adi', 'sozlesme_no', 'account_no', 'outlet_no',\r\n                'potansiyel_no', 'kampanya_kodu', 'sozlesme_durumu', 'uye_durumu', 'odeme_durum',\r\n                'odeme_tarihi', 'prim_ust_urun_grubu', 'basic_basari_skala', 'cinema_basari_skala',\r\n                'sport_basari_skala', 'genel_basari_skala', 'isp_basari_skala', 'uyelik_turu',\r\n                'kurulum_ziyaret_tipi', 'kurulum_tipi_aciklama', 'eski_ref_prim', 'odenecek_prim',\r\n                'mahsup_tutari_odeme_durumu', 'yonlendirme', 'prim_durum_aciklama'\r\n            ];\r\n            \r\n            // Display names (kullanıcıya gösterilen başlıklar)\r\n            $expectedDisplayColumns = [\r\n                'PRİM DETAY', 'PRİM DÖNEM', 'MEMO_ACAN_PERSONEL_KIMLIK', 'BÖLGE', 'BAYİ YÖNETİCİSİ',\r\n                'BAYİ TİP', 'BAYİ KODU', 'BAYİ ADI', 'SOZLESME_NO', 'ACCOUNT_NO', 'OUTLET NO',\r\n                'POTANSİYEL_NO', 'KAMPANYA KODU', 'SÖZLEŞME DURUMU', 'ÜYE DURUMU', 'ODEME_DURUM',\r\n                'ODEME_TARIHI', 'PRIM_UST_URUN_GRUBU', 'BASIC_BASARI_SKALA', 'CINEMA_BASARI_SKALA',\r\n                'SPORT_BASARI_SKALA', 'GENEL_BASARI_SKALA', 'ISP_BASARI_SKALA', 'UYELIK_TURU',\r\n                'KURULUM_ZIYARET_TIPI', 'KURULUM_TIPI_ACIKLAMA', 'ESKI_REF_PRIM', 'ODENECEK_PRIM',\r\n                'MAHSUP TUTARI-ÖDEME DURUMU', 'Yönlendirme', 'PRİM DURUM AÇIKLAMA'\r\n            ];\r\n            \r\n            $columnMapping = [];\r\n            foreach ($expectedColumns as $i => $expected) {\r\n                $displayName = $expectedDisplayColumns[$i];\r\n                foreach ($headers as $index => $header) {\r\n                    $headerClean = strtolower(trim($header));\r\n                    // Hem internal hem display names ile eşleştir\r\n                    if ($headerClean === strtolower($expected) || $headerClean === strtolower($displayName)) {\r\n                        $columnMapping[$expected] = $index;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // Delimiter tespiti\r\n            $delimiter = ';';\r\n            $currentPos = ftell($handle);\r\n            $testLine = fgets($handle);\r\n            if (substr_count($testLine, ';') < substr_count($testLine, ',')) {\r\n                $delimiter = ',';\r\n            }\r\n            fseek($handle, $currentPos);\r\n            \r\n            // INSERT statement hazırla\r\n            $insertSql = \"INSERT INTO primebaz_rapor (\r\n                prim_detay, prim_donem, memo_acan_personel_kimlik, bolge, bayi_yoneticisi,\r\n                bayi_tip, bayi_kodu, bayi_adi, sozlesme_no, account_no, outlet_no,\r\n                potansiyel_no, kampanya_kodu, sozlesme_durumu, uye_durumu, odeme_durum,\r\n                odeme_tarihi, prim_ust_urun_grubu, basic_basari_skala, cinema_basari_skala,\r\n                sport_basari_skala, genel_basari_skala, isp_basari_skala, uyelik_turu,\r\n                kurulum_ziyaret_tipi, kurulum_tipi_aciklama, eski_ref_prim, odenecek_prim,\r\n                mahsup_tutari_odeme_durumu, yonlendirme, prim_durum_aciklama, dosya_adi\r\n            ) VALUES (\" . str_repeat('?,', 31) . \"?)\";\r\n            \r\n            $insertStmt = $this->connection->prepare($insertSql);\r\n            \r\n            $this->connection->beginTransaction();\r\n            \r\n            $successCount = 0;\r\n            $errorCount = 0;\r\n            $skippedRows = 0;\r\n            $errors = [];\r\n            $batchCount = 0;\r\n            $rowCount = 0;\r\n            \r\n            // Satır satır işle\r\n            while (($row = fgetcsv($handle, 0, $delimiter, '\"', '\\\\')) !== false) {\r\n                $rowCount++;\r\n                \r\n                // Boş satırları atla\r\n                $hasData = false;\r\n                foreach ($row as $cell) {\r\n                    if (!empty(trim($cell))) {\r\n                        $hasData = true;\r\n                        break;\r\n                    }\r\n                }\r\n                if (!$hasData) {\r\n                    $skippedRows++;\r\n                    continue;\r\n                }\r\n                \r\n                // Sütun sayısı kontrolü - Eksik sütunlar olsa bile işleme devam et\r\n                // Sadece fazla sütunları kırp\r\n                if (count($row) > count($expectedColumns)) {\r\n                    $row = array_slice($row, 0, count($expectedColumns));\r\n                }\r\n                \r\n                // Verileri hazırla\r\n                $processedRow = [];\r\n                foreach ($expectedColumns as $column) {\r\n                    $index = $columnMapping[$column] ?? null;\r\n                    $value = ($index !== null && isset($row[$index])) ? trim($row[$index]) : null;\r\n                    \r\n                    if ($value === '') {\r\n                        $value = null;\r\n                    }\r\n                    \r\n                    // Veri tipine göre dönüşüm\r\n                    if ($column === 'odeme_tarihi') {\r\n                        $value = $this->convertDateFormat($value);\r\n                    } elseif (in_array($column, ['bayi_kodu', 'account_no', 'outlet_no', 'potansiyel_no', 'sozlesme_durumu', 'odeme_durum'])) {\r\n                        $value = $this->convertInteger($value);\r\n                    } elseif (in_array($column, ['eski_ref_prim', 'odenecek_prim', 'mahsup_tutari_odeme_durumu'])) {\r\n                        $value = $this->convertDecimal($value);\r\n                    }\r\n                    \r\n                    $processedRow[] = $value;\r\n                }\r\n                $processedRow[] = $fileName; // dosya_adi\r\n                \r\n                try {\r\n                    $insertStmt->execute($processedRow);\r\n                    $successCount++;\r\n                } catch (PDOException $e) {\r\n                    $errorCount++;\r\n                    $errorDetails = [\r\n                        'row' => $rowCount + 1,\r\n                        'data' => $processedRow,\r\n                        'error' => $e->getMessage(),\r\n                        'code' => $e->getCode()\r\n                    ];\r\n                    $errors[] = \"Satır \" . ($rowCount + 1) . \": \" . $e->getMessage();\r\n                    \r\n                    // Detaylı hata loglama\r\n                    error_log(\"PRIMEBAZ UPLOAD ERROR - Row \" . ($rowCount + 1) . \": \" . $e->getMessage());\r\n                    error_log(\"PRIMEBAZ UPLOAD ERROR - Data: \" . json_encode($processedRow));\r\n                    \r\n                    if ($errorCount <= 5) {\r\n                        error_log(\"Error on row \" . ($rowCount + 1) . \": \" . $e->getMessage());\r\n                    }\r\n                    \r\n                    // İlk 10 hatada işlemi durdur\r\n                    if ($errorCount >= 10) {\r\n                        throw new Exception(\"Fazla hata oluştu. İşlem durduruldu. Son hata: \" . $e->getMessage());\r\n                    }\r\n                }\r\n                \r\n                $batchCount++;\r\n                \r\n                if ($batchCount >= $batchSize) {\r\n                    $this->connection->commit();\r\n                    $this->connection->beginTransaction();\r\n                    $batchCount = 0;\r\n                    error_log(\"Processed $rowCount rows from $fileName\");\r\n                }\r\n            }\r\n            \r\n            $this->connection->commit();\r\n            fclose($handle);\r\n            \r\n            // Geçici CSV dosyasını sil (sadece Excel'den dönüştürülmüşse)\r\n            if ($extension !== 'csv' && $csvFilePath !== $filePath && file_exists($csvFilePath)) {\r\n                unlink($csvFilePath);\r\n            }\r\n            \r\n            return [\r\n                'success' => true,\r\n                'successful' => $successCount,\r\n                'errors' => $errorCount,\r\n                'totalProcessed' => $successCount + $errorCount,\r\n                'skippedRows' => $skippedRows,\r\n                'error_details' => $errors,\r\n                'filename' => $fileName\r\n            ];\r\n            \r\n        } catch (Exception $e) {\r\n            if ($this->connection->inTransaction()) {\r\n                $this->connection->rollBack();\r\n            }\r\n            fclose($handle);\r\n            throw new Exception('CSV dosyası işleme hatası: ' . $e->getMessage());\r\n        }\r\n    }\r\n}\r\n\r\n$pageTitle = 'Primebaz Rapor Yükleme';\r\n$breadcrumbs = [\r\n    ['title' => 'Primebaz Rapor Yükleme']\r\n];\r\n\r\n$message = '';\r\n$messageType = '';\r\n$excelFiles = [];\r\n$uploadResult = null;\r\n\r\n// Excel ve CSV dosyalarını listele\r\n$uploadsDir = __DIR__ . '/uploads/primebaz';\r\nif (is_dir($uploadsDir)) {\r\n    $files = scandir($uploadsDir);\r\n    foreach ($files as $file) {\r\n        $extension = strtolower(pathinfo($file, PATHINFO_EXTENSION));\r\n        if (in_array($extension, ['xlsx', 'xls', 'csv'])) {\r\n            $excelFiles[] = $file;\r\n        }\r\n    }\r\n}\r\n\r\n// AJAX istekleri için\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    if (isset($_POST['action'])) {\r\n        header('Content-Type: application/json');\r\n        \r\n        if ($_POST['action'] === 'get_file_info') {\r\n            $selectedFile = $_POST['file'] ?? '';\r\n            if (empty($selectedFile) || !in_array($selectedFile, $excelFiles)) {\r\n                echo json_encode(['success' => false, 'error' => 'Geçersiz dosya seçimi']);\r\n                exit;\r\n            }\r\n            \r\n            $filePath = $uploadsDir . '/' . $selectedFile;\r\n            \r\n            try {\r\n                // Dosya türüne göre işlem yap\r\n                $extension = strtolower(pathinfo($filePath, PATHINFO_EXTENSION));\r\n                \r\n                if ($extension === 'csv') {\r\n                    $csvFilePath = $filePath; // Zaten CSV\r\n                } else {\r\n                    // Excel dosyasını CSV'ye dönüştür\r\n                    $db = new PrimebazMSSQLConnection();\r\n                    $csvFilePath = $db->convertExcelToCsv($filePath);\r\n                }\r\n                \r\n                $handle = fopen($csvFilePath, 'r');\r\n                if (!$handle) {\r\n                    throw new Exception('CSV dosyası açılamadı');\r\n                }\r\n                \r\n                // BOM kontrolü\r\n                $bom = fread($handle, 4);\r\n                if (substr($bom, 0, 3) === \"\\xEF\\xBB\\xBF\") {\r\n                    fseek($handle, 3);\r\n                } else {\r\n                    rewind($handle);\r\n                }\r\n                \r\n                // Başlık satırını oku\r\n                $headers = null;\r\n                $currentPos = ftell($handle);\r\n                $headers = fgetcsv($handle, 0, ';', '\"', '\\\\');\r\n                if (!$headers || count($headers) <= 1) {\r\n                    fseek($handle, $currentPos);\r\n                    $headers = fgetcsv($handle, 0, ',', '\"', '\\\\');\r\n                    if (!$headers || count($headers) <= 1) {\r\n                        fseek($handle, $currentPos);\r\n                        $headers = fgetcsv($handle, 0, \"\\t\", '\"', '\\\\');\r\n                    }\r\n                }\r\n                \r\n                if (!$headers || count($headers) <= 1) {\r\n                    fclose($handle);\r\n                    throw new Exception('CSV başlıkları okunamadı');\r\n                }\r\n                \r\n                $headers = array_map('trim', $headers);\r\n                \r\n                // Toplam satır sayısını hesapla\r\n                $totalRows = 0;\r\n                $delimiter = ';';\r\n                $testLine = fgets($handle);\r\n                if (substr_count($testLine, ';') < substr_count($testLine, ',')) {\r\n                    $delimiter = ',';\r\n                }\r\n                rewind($handle);\r\n                fgetcsv($handle, 0, $delimiter); // Skip header\r\n                \r\n                while (($row = fgetcsv($handle, 0, $delimiter, '\"', '\\\\')) !== false) {\r\n                    $hasData = false;\r\n                    foreach ($row as $cell) {\r\n                        if (!empty(trim($cell))) {\r\n                            $hasData = true;\r\n                            break;\r\n                        }\r\n                    }\r\n                    if ($hasData) {\r\n                        $totalRows++;\r\n                    }\r\n                }\r\n                \r\n                fclose($handle);\r\n                \r\n                // Geçici CSV dosyasını temizle (sadece Excel'den dönüştürülmüşse)\r\n                if ($extension !== 'csv' && $csvFilePath !== $filePath && file_exists($csvFilePath)) {\r\n                    unlink($csvFilePath);\r\n                }\r\n                \r\n                // Beklenen sütunlarla karşılaştır\r\n                // Internal column names (veritabanı sütunları)\r\n                $expectedColumns = [\r\n                    'prim_detay', 'prim_donem', 'memo_acan_personel_kimlik', 'bolge', 'bayi_yoneticisi',\r\n                    'bayi_tip', 'bayi_kodu', 'bayi_adi', 'sozlesme_no', 'account_no', 'outlet_no',\r\n                    'potansiyel_no', 'kampanya_kodu', 'sozlesme_durumu', 'uye_durumu', 'odeme_durum',\r\n                    'odeme_tarihi', 'prim_ust_urun_grubu', 'basic_basari_skala', 'cinema_basari_skala',\r\n                    'sport_basari_skala', 'genel_basari_skala', 'isp_basari_skala', 'uyelik_turu',\r\n                    'kurulum_ziyaret_tipi', 'kurulum_tipi_aciklama', 'eski_ref_prim', 'odenecek_prim',\r\n                    'mahsup_tutari_odeme_durumu', 'yonlendirme', 'prim_durum_aciklama'\r\n                ];\r\n                \r\n                // Display names (kullanıcıya gösterilen başlıklar)\r\n                $expectedDisplayColumns = [\r\n                    'PRİM DETAY', 'PRİM DÖNEM', 'MEMO_ACAN_PERSONEL_KIMLIK', 'BÖLGE', 'BAYİ YÖNETİCİSİ',\r\n                    'BAYİ TİP', 'BAYİ KODU', 'BAYİ ADI', 'SOZLESME_NO', 'ACCOUNT_NO', 'OUTLET NO',\r\n                    'POTANSİYEL_NO', 'KAMPANYA KODU', 'SÖZLEŞME DURUMU', 'ÜYE DURUMU', 'ODEME_DURUM',\r\n                    'ODEME_TARIHI', 'PRIM_UST_URUN_GRUBU', 'BASIC_BASARI_SKALA', 'CINEMA_BASARI_SKALA',\r\n                    'SPORT_BASARI_SKALA', 'GENEL_BASARI_SKALA', 'ISP_BASARI_SKALA', 'UYELIK_TURU',\r\n                    'KURULUM_ZIYARET_TIPI', 'KURULUM_TIPI_ACIKLAMA', 'ESKI_REF_PRIM', 'ODENECEK_PRIM',\r\n                    'MAHSUP TUTARI-ÖDEME DURUMU', 'Yönlendirme', 'PRİM DURUM AÇIKLAMA'\r\n                ];\r\n                \r\n                $matches = [];\r\n                $missingColumns = [];\r\n                $extraColumns = [];\r\n                \r\n                // Sütun eşleştirmeleri (büyük/küçük harf duyarsız)\r\n                foreach ($expectedColumns as $i => $expected) {\r\n                    $displayName = $expectedDisplayColumns[$i];\r\n                    $found = false;\r\n                    foreach ($headers as $index => $header) {\r\n                        $headerClean = strtolower(trim($header));\r\n                        // Hem internal hem display names ile eşleştir\r\n                        if ($headerClean === strtolower($expected) || $headerClean === strtolower($displayName)) {\r\n                            $matches[$expected] = $index;\r\n                            $found = true;\r\n                            break;\r\n                        }\r\n                    }\r\n                    if (!$found) {\r\n                        $missingColumns[] = $displayName; // Display name göster\r\n                    }\r\n                }\r\n                \r\n                foreach ($headers as $header) {\r\n                    $found = false;\r\n                    $headerClean = strtolower(trim($header));\r\n                    foreach ($expectedColumns as $i => $expected) {\r\n                        $displayName = $expectedDisplayColumns[$i];\r\n                        if ($headerClean === strtolower($expected) || $headerClean === strtolower($displayName)) {\r\n                            $found = true;\r\n                            break;\r\n                        }\r\n                    }\r\n                    if (!$found && !empty(trim($header))) {\r\n                        $extraColumns[] = $header;\r\n                    }\r\n                }\r\n                \r\n                $isCompatible = true; // Eksik sütunlar olsa bile yüklemeye izin ver\r\n                \r\n                echo json_encode([\r\n                    'success' => true,\r\n                    'headers' => $headers,\r\n                    'expectedColumns' => $expectedDisplayColumns, // Display names gönder\r\n                    'matches' => $matches,\r\n                    'missingColumns' => $missingColumns,\r\n                    'extraColumns' => $extraColumns,\r\n                    'isCompatible' => $isCompatible,\r\n                    'totalRows' => $totalRows,\r\n                    'fileSize' => round(filesize($filePath) / 1024 / 1024, 2) . ' MB'\r\n                ]);\r\n                \r\n            } catch (Exception $e) {\r\n                echo json_encode(['success' => false, 'error' => 'Dosya okuma hatası: ' . $e->getMessage()]);\r\n            }\r\n            exit;\r\n        }\r\n        \r\n        if ($_POST['action'] === 'upload') {\r\n            // Ekleme yetkisi kontrolü\r\n            if ($sayfaYetkileri['ekle'] != 1) {\r\n                echo json_encode(['success' => false, 'error' => 'Rapor yükleme yetkiniz bulunmamaktadır.']);\r\n                exit;\r\n            }\r\n            \r\n            $selectedFile = $_POST['file'] ?? '';\r\n            $truncate = isset($_POST['truncate']) && $_POST['truncate'] === '1';\r\n            \r\n            if (empty($selectedFile) || !in_array($selectedFile, $excelFiles)) {\r\n                echo json_encode(['success' => false, 'error' => 'Geçersiz dosya seçimi']);\r\n                exit;\r\n            }\r\n            \r\n            try {\r\n                $db = new PrimebazMSSQLConnection();\r\n                $db->createPrimebazRaporTable();\r\n                \r\n                if ($truncate) {\r\n                    $db->truncateTable();\r\n                }\r\n                \r\n                $result = $db->processExcelFile($uploadsDir . '/' . $selectedFile, $selectedFile);\r\n                echo json_encode($result);\r\n            } catch (Exception $e) {\r\n                $errorDetails = [\r\n                    'success' => false,\r\n                    'error' => $e->getMessage(),\r\n                    'file' => $e->getFile(),\r\n                    'line' => $e->getLine(),\r\n                    'selectedFile' => $selectedFile,\r\n                    'truncate' => $truncate,\r\n                    'timestamp' => date('Y-m-d H:i:s')\r\n                ];\r\n                \r\n                // Detaylı hata loglama\r\n                error_log(\"PRIMEBAZ UPLOAD FAILED: \" . json_encode($errorDetails));\r\n                error_log(\"Upload hatası: \" . json_encode($errorDetails));\r\n                \r\n                echo json_encode($errorDetails);\r\n            }\r\n            exit;\r\n        }\r\n    }\r\n}\r\n\r\ninclude '../../../includes/header.php';\r\n?>\r\n\r\n<div class=\"row\">\r\n    <div class=\"col-12\">\r\n        <div class=\"card\">\r\n            <div class=\"card-header bg-success text-white\">\r\n                <h4 class=\"card-title mb-0\">\r\n                    <i class=\"fas fa-file-excel me-2\"></i>\r\n                    Primebaz Rapor Yükleme\r\n                </h4>\r\n            </div>\r\n            <div class=\"card-body\">\r\n                <?php if ($sayfaYetkileri['ekle'] != 1): ?>\r\n                    <div class=\"alert alert-warning\">\r\n                        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                        Rapor yükleme yetkiniz bulunmamaktadır.\r\n                    </div>\r\n                <?php elseif (empty($excelFiles)): ?>\r\n                    <div class=\"alert alert-warning\">\r\n                        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                        Uploads/primebaz klasöründe Excel (.xlsx) veya CSV dosyası bulunamadı.\r\n                        <hr>\r\n                        <small>\r\n                            <strong>Dosya yükleme adımları:</strong><br>\r\n                            1. Excel dosyanızı .xlsx formatında kaydedin<br>\r\n                            2. Dosyayı <code>uploads/primebaz/</code> klasörüne kopyalayın<br>\r\n                            3. Sayfayı yenileyin\r\n                        </small>\r\n                    </div>\r\n                <?php else: ?>\r\n                    <form id=\"uploadForm\">\r\n                        <div class=\"row\">\r\n                            <div class=\"col-md-6\">\r\n                                <div class=\"mb-3\">\r\n                                    <label for=\"excelFile\" class=\"form-label\">Excel/CSV Dosyası Seçin</label>\r\n                                    <select class=\"form-select\" id=\"excelFile\" name=\"excelFile\" required>\r\n                                        <option value=\"\">-- Dosya Seçin --</option>\r\n                                        <?php foreach ($excelFiles as $file): ?>\r\n                                            <option value=\"<?php echo htmlspecialchars($file); ?>\">\r\n                                                <?php echo htmlspecialchars($file); ?>\r\n                                                <span class=\"text-muted\">(<?php echo strtoupper(pathinfo($file, PATHINFO_EXTENSION)); ?>)</span>\r\n                                            </option>\r\n                                        <?php endforeach; ?>\r\n                                    </select>\r\n                                    <div class=\"form-text\">Desteklenen formatlar: .xlsx, .csv</div>\r\n                                </div>\r\n                            </div>\r\n                            <div class=\"col-md-6\">\r\n                                <div class=\"mb-3\">\r\n                                    <label class=\"form-label\">Yükleme Seçenekleri</label>\r\n                                    <div class=\"form-check\">\r\n                                        <input class=\"form-check-input\" type=\"checkbox\" id=\"truncateTable\" name=\"truncateTable\" value=\"1\">\r\n                                        <label class=\"form-check-label text-danger\" for=\"truncateTable\">\r\n                                            <i class=\"fas fa-exclamation-triangle me-1\"></i>\r\n                                            Mevcut verileri temizle (Dikkat: Tüm veriler silinir!)\r\n                                        </label>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        \r\n                        <div id=\"fileAnalysis\" class=\"mb-4\" style=\"display: none;\">\r\n                            <div class=\"card\">\r\n                                <div class=\"card-header bg-info text-white\">\r\n                                    <h6 class=\"mb-0\">\r\n                                        <i class=\"fas fa-analytics me-2\"></i>\r\n                                        Dosya Analizi\r\n                                    </h6>\r\n                                </div>\r\n                                <div class=\"card-body\">\r\n                                    <div id=\"analysisContent\">\r\n                                        <!-- Analysis content will be loaded here -->\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        \r\n                        <div class=\"d-flex gap-2\">\r\n                            <button type=\"button\" id=\"analyzeBtn\" class=\"btn btn-info\" disabled>\r\n                                <i class=\"fas fa-search me-2\"></i>\r\n                                Dosyayı Analiz Et\r\n                            </button>\r\n                            <button type=\"submit\" id=\"uploadBtn\" class=\"btn btn-success\" disabled>\r\n                                <i class=\"fas fa-upload me-2\"></i>\r\n                                Yüklemeyi Başlat\r\n                            </button>\r\n                        </div>\r\n                    </form>\r\n                    \r\n                    <div id=\"progressContainer\" class=\"mt-4\" style=\"display: none;\">\r\n                        <div class=\"card\">\r\n                            <div class=\"card-body\">\r\n                                <h6>Yükleme Durumu:</h6>\r\n                                <div class=\"progress mb-3\">\r\n                                    <div id=\"progressBar\" class=\"progress-bar progress-bar-striped progress-bar-animated\" \r\n                                         role=\"progressbar\" style=\"width: 0%\"></div>\r\n                                </div>\r\n                                <div id=\"progressText\">Hazırlanıyor...</div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div id=\"resultContainer\" class=\"mt-4\" style=\"display: none;\">\r\n                        <div class=\"card\">\r\n                            <div class=\"card-header bg-success text-white\">\r\n                                <h6 class=\"mb-0\">\r\n                                    <i class=\"fas fa-check-circle me-2\"></i>\r\n                                    Yükleme Sonucu\r\n                                </h6>\r\n                            </div>\r\n                            <div class=\"card-body\">\r\n                                <div id=\"resultContent\">\r\n                                    <!-- Result content will be loaded here -->\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                <?php endif; ?>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<script>\r\n$(document).ready(function() {\r\n    console.log('=== Primebaz Upload System Initialized ===');\r\n    console.log('Page loaded successfully, event handlers being attached...');\r\n    \r\n    let analysisData = null;\r\n    \r\n    // Dosya seçimi değiştiğinde\r\n    $('#excelFile').change(function() {\r\n        const selectedFile = $(this).val();\r\n        if (selectedFile) {\r\n            $('#analyzeBtn').prop('disabled', false);\r\n            $('#fileAnalysis').hide();\r\n            $('#uploadBtn').prop('disabled', true);\r\n            analysisData = null;\r\n        } else {\r\n            $('#analyzeBtn').prop('disabled', true);\r\n            $('#fileAnalysis').hide();\r\n            $('#uploadBtn').prop('disabled', true);\r\n        }\r\n    });\r\n    \r\n    // Analiz butonu\r\n    $('#analyzeBtn').click(function() {\r\n        const selectedFile = $('#excelFile').val();\r\n        console.log('=== File Analysis Started ===');\r\n        console.log('Selected file:', selectedFile);\r\n        \r\n        if (!selectedFile) {\r\n            console.warn('No file selected for analysis');\r\n            return;\r\n        }\r\n        \r\n        $(this).prop('disabled', true).html('<i class=\"fas fa-spinner fa-spin me-2\"></i>Analiz Ediliyor...');\r\n        \r\n        console.log('Sending analysis request...');\r\n        $.post('', {\r\n            action: 'get_file_info',\r\n            file: selectedFile\r\n        })\r\n        .done(function(response) {\r\n            console.log('Analysis response received:', response);\r\n            if (response.success) {\r\n                console.log('Analysis successful - Rows:', response.total_rows, 'Columns:', response.column_count);\r\n                analysisData = response;\r\n                displayAnalysis(response);\r\n                $('#fileAnalysis').show();\r\n                $('#uploadBtn').prop('disabled', false); // Her zaman aktif et\r\n            } else {\r\n                console.error('Analysis failed:', response.error);\r\n                alert('Hata: ' + response.error);\r\n            }\r\n        })\r\n        .fail(function(xhr, status, error) {\r\n            console.error('Analysis request failed:', {xhr, status, error});\r\n            alert('Sunucu hatası oluştu');\r\n        })\r\n        .always(function() {\r\n            $('#analyzeBtn').prop('disabled', false).html('<i class=\"fas fa-search me-2\"></i>Dosyayı Analiz Et');\r\n        });\r\n    });\r\n    \r\n    // Upload form\r\n    $('#uploadForm').submit(function(e) {\r\n        e.preventDefault();\r\n        \r\n        console.log('=== Upload Process Started ===');\r\n        console.log('Analysis data:', analysisData);\r\n        \r\n        if (!analysisData) {\r\n            console.warn('No analysis data available');\r\n            alert('Önce dosya analizi yapın');\r\n            return;\r\n        }\r\n        \r\n        const truncate = $('#truncateTable').is(':checked');\r\n        console.log('Truncate table option:', truncate);\r\n        \r\n        if (truncate) {\r\n            console.log('Requesting confirmation for table truncation...');\r\n            if (!confirm('UYARI: Bu işlem mevcut tüm Primebaz rapor verilerini silecektir. Devam etmek istediğinizden emin misiniz?')) {\r\n                console.log('User cancelled truncation');\r\n                return;\r\n            }\r\n            console.log('User confirmed truncation');\r\n        }\r\n        \r\n        // Büyük dosya için ek uyarı\r\n        if (analysisData.totalRows > 10000) {\r\n            if (!confirm(`Bu dosyada ${analysisData.totalRows.toLocaleString()} kayıt bulunuyor. Yükleme işlemi birkaç dakika sürebilir ve sayfayı kapatmamanız gerekir. Devam etmek istiyor musunuz?`)) {\r\n                return;\r\n            }\r\n        }\r\n        \r\n        startUpload();\r\n    });\r\n    \r\n    function displayAnalysis(data) {\r\n        let html = `\r\n            <div class=\"row\">\r\n                <div class=\"col-md-3\">\r\n                    <div class=\"text-center\">\r\n                        <div class=\"display-6 text-primary\">${data.headers.length}</div>\r\n                        <div class=\"text-muted\">Dosya Sütun Sayısı</div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"col-md-3\">\r\n                    <div class=\"text-center\">\r\n                        <div class=\"display-6 text-success\">${Object.keys(data.matches).length}</div>\r\n                        <div class=\"text-muted\">Eşleşen Sütun</div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"col-md-3\">\r\n                    <div class=\"text-center\">\r\n                        <div class=\"display-6 text-info\">${data.totalRows || 'N/A'}</div>\r\n                        <div class=\"text-muted\">Toplam Kayıt</div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"col-md-3\">\r\n                    <div class=\"text-center\">\r\n                        <div class=\"display-6 text-secondary\">${data.fileSize || 'N/A'}</div>\r\n                        <div class=\"text-muted\">Dosya Boyutu</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <hr>\r\n        `;\r\n        \r\n        if (data.isCompatible || data.missingColumns.length === 0) {\r\n            html += `\r\n                <div class=\"alert alert-success\">\r\n                    <i class=\"fas fa-check-circle me-2\"></i>\r\n                    <strong>Tam Uyumlu!</strong> Excel dosyası veritabanı yapısıyla tam uyumlu. Yükleme işlemi başlatılabilir.\r\n                </div>\r\n            `;\r\n        } else {\r\n            html += `\r\n                <div class=\"alert alert-info\">\r\n                    <i class=\"fas fa-info-circle me-2\"></i>\r\n                    <strong>Uyumlu - Eksik Sütunlar Var!</strong> Bazı sütunlar eksik ama yükleme yapılabilir. \r\n                    Eksik sütunlar NULL olarak kaydedilecek, eşleşen sütunlar normal şekilde yüklenecektir.\r\n                </div>\r\n            `;\r\n        }\r\n        \r\n        // Büyük dosya uyarısı\r\n        if (data.totalRows > 5000) {\r\n            html += `\r\n                <div class=\"alert alert-info\">\r\n                    <i class=\"fas fa-info-circle me-2\"></i>\r\n                    <strong>Büyük Dosya:</strong> ${data.totalRows.toLocaleString()} kayıt tespit edildi. \r\n                    Yükleme işlemi birkaç dakika sürebilir. Lütfen sayfayı kapatmayın.\r\n                </div>\r\n            `;\r\n        }\r\n        \r\n        if (data.missingColumns.length > 0) {\r\n            html += `\r\n                <div class=\"alert alert-warning\">\r\n                    <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                    <strong>Eksik Sütunlar (NULL olarak kaydedilecek):</strong><br>\r\n                    Bu sütunlar veritabanında NULL değeri alacaktır.<br>\r\n                    ${data.missingColumns.map(col => `<span class=\"badge bg-secondary me-1\">${col}</span>`).join('')}\r\n                </div>\r\n            `;\r\n        }\r\n        \r\n        if (data.extraColumns.length > 0) {\r\n            html += `\r\n                <div class=\"alert alert-info\">\r\n                    <strong>Fazladan Sütunlar (göz ardı edilecek):</strong><br>\r\n                    ${data.extraColumns.map(col => `<span class=\"badge bg-info me-1\">${col}</span>`).join('')}\r\n                </div>\r\n            `;\r\n        }\r\n        \r\n        $('#analysisContent').html(html);\r\n    }\r\n    \r\n    function startUpload() {\r\n        console.log('=== Starting Upload Function ===');\r\n        const selectedFile = $('#excelFile').val();\r\n        const truncate = $('#truncateTable').is(':checked') ? '1' : '0';\r\n        \r\n        console.log('Upload parameters:', {\r\n            file: selectedFile,\r\n            truncate: truncate,\r\n            totalRows: analysisData?.totalRows || 'unknown'\r\n        });\r\n        \r\n        $('#uploadBtn').prop('disabled', true);\r\n        $('#progressContainer').show();\r\n        $('#resultContainer').hide();\r\n        \r\n        updateProgress(0, 'Yükleme başlatılıyor...');\r\n        \r\n        // Büyük dosyalar için progress simulation\r\n        let progressInterval;\r\n        let currentProgress = 0;\r\n        \r\n        if (analysisData && analysisData.totalRows > 1000) {\r\n            progressInterval = setInterval(function() {\r\n                if (currentProgress < 90) {\r\n                    currentProgress += Math.random() * 2;\r\n                                                updateProgress(Math.min(currentProgress, 90), 'Excel/CSV dosyası işleniyor... (' + Math.floor(currentProgress) + '%)');\r\n                }\r\n            }, 1500);\r\n        }\r\n        \r\n        console.log('Sending upload request...');\r\n        $.post('', {\r\n            action: 'upload',\r\n            file: selectedFile,\r\n            truncate: truncate\r\n        })\r\n        .done(function(response) {\r\n            console.log('Upload completed successfully:', response);\r\n            if (progressInterval) {\r\n                clearInterval(progressInterval);\r\n            }\r\n            updateProgress(100, 'Tamamlandı!');\r\n            \r\n            setTimeout(function() {\r\n                $('#progressContainer').hide();\r\n                displayResult(response);\r\n            }, 1000);\r\n        })\r\n        .fail(function(xhr, status, error) {\r\n            if (progressInterval) {\r\n                clearInterval(progressInterval);\r\n            }\r\n            \r\n            let errorMessage = 'Hata oluştu!';\r\n            console.error('Upload Failed - Full Error Details:', {\r\n                status: status,\r\n                error: error,\r\n                responseText: xhr.responseText,\r\n                statusCode: xhr.status\r\n            });\r\n            \r\n            try {\r\n                if (xhr.responseText) {\r\n                    const response = JSON.parse(xhr.responseText);\r\n                    errorMessage = response.error || errorMessage;\r\n                    console.error('Parsed Error Response:', response);\r\n                    \r\n                    // Display detailed error if available\r\n                    if (response.detailed_error) {\r\n                        errorMessage += '\\n\\nDetay: ' + response.detailed_error;\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                console.error('Failed to parse error response:', e);\r\n                errorMessage = xhr.responseText || error || 'Bilinmeyen hata';\r\n            }\r\n            \r\n            updateProgress(100, errorMessage);\r\n            $('#progressBar').removeClass('bg-success').addClass('bg-danger');\r\n        })\r\n        .always(function() {\r\n            $('#uploadBtn').prop('disabled', false);\r\n        });\r\n    }\r\n    \r\n    function updateProgress(percent, text) {\r\n        $('#progressBar').css('width', percent + '%');\r\n        \r\n        // Handle multi-line error messages\r\n        if (text.includes('\\n')) {\r\n            const lines = text.split('\\n');\r\n            $('#progressText').html(lines.map(line => \r\n                line.trim() ? '<div>' + $('<div>').text(line.trim()).html() + '</div>' : ''\r\n            ).join(''));\r\n        } else {\r\n            $('#progressText').text(text);\r\n        }\r\n        \r\n        if (percent === 100) {\r\n            $('#progressBar').removeClass('progress-bar-animated');\r\n        }\r\n    }\r\n    \r\n    function displayResult(result) {\r\n        let html = '';\r\n        \r\n        if (result.success) {\r\n            html = `\r\n                <div class=\"row text-center mb-3\">\r\n                    <div class=\"col-md-3\">\r\n                        <div class=\"display-6 text-primary\">${result.totalProcessed || 0}</div>\r\n                        <div class=\"text-muted\">İşlenen Kayıt</div>\r\n                    </div>\r\n                    <div class=\"col-md-3\">\r\n                        <div class=\"display-6 text-success\">${result.successful || 0}</div>\r\n                        <div class=\"text-muted\">Başarılı</div>\r\n                    </div>\r\n                    <div class=\"col-md-3\">\r\n                        <div class=\"display-6 text-danger\">${result.errors || 0}</div>\r\n                        <div class=\"text-muted\">Hata</div>\r\n                    </div>\r\n                    <div class=\"col-md-3\">\r\n                        <div class=\"display-6 text-info\">${result.skippedRows || 0}</div>\r\n                        <div class=\"text-muted\">Atlanan</div>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div class=\"alert alert-success\">\r\n                    <i class=\"fas fa-check-circle me-2\"></i>\r\n                    <strong>Başarılı!</strong> <code>${result.filename}</code> dosyası başarıyla işlendi.\r\n                </div>\r\n            `;\r\n            \r\n            if (result.error_details && result.error_details.length > 0) {\r\n                html += `\r\n                    <div class=\"alert alert-warning\">\r\n                        <strong>Hatalar:</strong>\r\n                        <ul class=\"mb-0 mt-2\">\r\n                            ${result.error_details.slice(0, 10).map(error => `<li><small>${error}</small></li>`).join('')}\r\n                        </ul>\r\n                        ${result.error_details.length > 10 ? `<small class=\"text-muted\">... ve ${result.error_details.length - 10} hata daha</small>` : ''}\r\n                    </div>\r\n                `;\r\n            }\r\n        } else {\r\n            html = `\r\n                <div class=\"alert alert-danger\">\r\n                    <i class=\"fas fa-times-circle me-2\"></i>\r\n                    <strong>Hata!</strong> ${result.error}\r\n                </div>\r\n            `;\r\n        }\r\n        \r\n        $('#resultContent').html(html);\r\n        $('#resultContainer').show();\r\n    }\r\n});\r\n</script>\r\n\r\n<?php include '../../../includes/footer.php'; ?>"
        }
    ]
}
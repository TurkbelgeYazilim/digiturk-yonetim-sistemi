{
    "sourceFile": "views/Yonetim/Primebaz/primebaz_rapor_analiz.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1761061099121,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1761061099121,
            "name": "Commit-0",
            "content": "<?php\r\nerror_reporting(E_ALL);\r\nini_set('display_errors', 1);\r\n\r\n// Auth kontrolü\r\nrequire_once '../../../auth.php';\r\n$currentUser = checkAuth();\r\ncheckUserStatus();\r\nupdateLastActivity();\r\n\r\n// Sayfa yetkilendirme kontrolü\r\n$sayfaYetkileri = [\r\n    'gor' => false,\r\n    'kendi_kullanicini_gor' => false,\r\n    'ekle' => false,\r\n    'duzenle' => false,\r\n    'sil' => false\r\n];\r\n\r\n// Admin kontrolü (group_id = 1 ise tüm yetkilere sahip)\r\n$isAdmin = ($currentUser['group_id'] == 1);\r\n\r\nif ($isAdmin) {\r\n    // Admin için tüm yetkileri aç\r\n    $sayfaYetkileri = [\r\n        'gor' => 1,\r\n        'kendi_kullanicini_gor' => 0,\r\n        'ekle' => 1,\r\n        'duzenle' => 1,\r\n        'sil' => 1\r\n    ];\r\n} else {\r\n    // Admin değilse normal yetki kontrolü yap\r\n    try {\r\n        $conn = getDatabaseConnection();\r\n        \r\n        // Mevcut sayfa URL'sini al\r\n        $currentPageUrl = basename($_SERVER['PHP_SELF']);\r\n        \r\n        // Sayfa bilgisini ve yetkilerini çek\r\n        $yetkiSql = \"\r\n            SELECT \r\n                tsy.gor,\r\n                tsy.kendi_kullanicini_gor,\r\n                tsy.ekle,\r\n                tsy.duzenle,\r\n                tsy.sil,\r\n                tsy.durum as yetki_durum,\r\n                ts.durum as sayfa_durum\r\n            FROM dbo.tanim_sayfalar ts\r\n            INNER JOIN dbo.tanim_sayfa_yetkiler tsy ON ts.sayfa_id = tsy.sayfa_id\r\n            WHERE ts.sayfa_url = ?\r\n            AND tsy.user_group_id = ?\r\n            AND ts.durum = 1\r\n            AND tsy.durum = 1\r\n        \";\r\n        \r\n        $yetkiStmt = $conn->prepare($yetkiSql);\r\n        $yetkiStmt->execute([$currentPageUrl, $currentUser['group_id']]);\r\n        $yetkiResult = $yetkiStmt->fetch(PDO::FETCH_ASSOC);\r\n        \r\n        if ($yetkiResult) {\r\n            $sayfaYetkileri = [\r\n                'gor' => (int)$yetkiResult['gor'],\r\n                'kendi_kullanicini_gor' => (int)$yetkiResult['kendi_kullanicini_gor'],\r\n                'ekle' => (int)$yetkiResult['ekle'],\r\n                'duzenle' => (int)$yetkiResult['duzenle'],\r\n                'sil' => (int)$yetkiResult['sil']\r\n            ];\r\n            \r\n            // Görme yetkisi yoksa (0 ise) sayfaya erişimi engelle\r\n            if ($sayfaYetkileri['gor'] == 0) {\r\n                header('Location: ../../../index.php?error=yetki_yok');\r\n                exit;\r\n            }\r\n        } else {\r\n            // Yetki tanımı bulunamazsa erişimi engelle\r\n            header('Location: ../../../index.php?error=yetki_tanimlanmamis');\r\n            exit;\r\n        }\r\n        \r\n    } catch (Exception $e) {\r\n        // Hata durumunda güvenlik için erişimi engelle\r\n        error_log(\"Yetki kontrol hatası: \" . $e->getMessage());\r\n        header('Location: ../../../index.php?error=sistem_hatasi');\r\n        exit;\r\n    }\r\n}\r\n\r\n$pageTitle = 'Primebaz Rapor Analizi';\r\n$breadcrumbs = [\r\n    ['title' => 'Yönetim', 'url' => '#'],\r\n    ['title' => 'Primebaz', 'url' => '#'],\r\n    ['title' => 'Rapor Analizi']\r\n];\r\n\r\n// Hata ve başarı mesajları\r\n$message = '';\r\n$messageType = '';\r\n\r\ntry {\r\n    $conn = getDatabaseConnection();\r\n    \r\n    // Önce primebaz_rapor tablosunun var olup olmadığını kontrol et\r\n    $tableCheckSQL = \"\r\n        SELECT COUNT(*) as table_exists \r\n        FROM INFORMATION_SCHEMA.TABLES \r\n        WHERE TABLE_NAME = 'primebaz_rapor'\r\n    \";\r\n    \r\n    $tableCheckStmt = $conn->prepare($tableCheckSQL);\r\n    $tableCheckStmt->execute();\r\n    $tableExists = $tableCheckStmt->fetch(PDO::FETCH_ASSOC)['table_exists'] > 0;\r\n    \r\n    if (!$tableExists) {\r\n        throw new Exception('Primebaz rapor tablosu bulunamadı. Önce bir rapor yüklemeniz gerekiyor.');\r\n    }\r\n    \r\n    // bayi_hakedis_prim_donem_id kolonunun var olup olmadığını kontrol et ve yoksa ekle\r\n    $columnCheckSQL = \"\r\n        SELECT COUNT(*) as column_exists \r\n        FROM INFORMATION_SCHEMA.COLUMNS \r\n        WHERE TABLE_NAME = 'primebaz_rapor' AND COLUMN_NAME = 'bayi_hakedis_prim_donem_id'\r\n    \";\r\n    \r\n    $columnCheckStmt = $conn->prepare($columnCheckSQL);\r\n    $columnCheckStmt->execute();\r\n    $columnExists = $columnCheckStmt->fetch(PDO::FETCH_ASSOC)['column_exists'] > 0;\r\n    \r\n    if (!$columnExists) {\r\n        // Kolonu ekle\r\n        $addColumnSQL = \"ALTER TABLE primebaz_rapor ADD bayi_hakedis_prim_donem_id INT NULL\";\r\n        $conn->exec($addColumnSQL);\r\n    }\r\n    \r\n    // users_bayi tablosunun var olup olmadığını kontrol et\r\n    $usersBayiCheckSQL = \"\r\n        SELECT COUNT(*) as table_exists \r\n        FROM INFORMATION_SCHEMA.TABLES \r\n        WHERE TABLE_NAME = 'users_bayi'\r\n    \";\r\n    \r\n    $usersBayiCheckStmt = $conn->prepare($usersBayiCheckSQL);\r\n    $usersBayiCheckStmt->execute();\r\n    $usersBayiExists = $usersBayiCheckStmt->fetch(PDO::FETCH_ASSOC)['table_exists'] > 0;\r\n    \r\n    if (!$usersBayiExists) {\r\n        throw new Exception('Kullanıcı-bayi eşleştirme tablosu bulunamadı. Sistem yöneticisiyle iletişime geçin.');\r\n    }\r\n    \r\n    // users_bayi tablosunun var olup olmadığını kontrol et\r\n    $usersBayiCheckSQL = \"\r\n        SELECT COUNT(*) as table_exists \r\n        FROM INFORMATION_SCHEMA.TABLES \r\n        WHERE TABLE_NAME = 'users_bayi'\r\n    \";\r\n    \r\n    $usersBayiCheckStmt = $conn->prepare($usersBayiCheckSQL);\r\n    $usersBayiCheckStmt->execute();\r\n    $usersBayiExists = $usersBayiCheckStmt->fetch(PDO::FETCH_ASSOC)['table_exists'] > 0;\r\n    \r\n    if (!$usersBayiExists) {\r\n        throw new Exception('Kullanıcı-bayi eşleştirme tablosu bulunamadı. Sistem yöneticisiyle iletişime geçin.');\r\n    }\r\n    \r\n    // Ana SQL sorgusu - kendi kullanıcısını görme yetkisi kontrolü\r\n    $sql = \"\r\n        SELECT \r\n            pr.memo_acan_personel_kimlik,\r\n            CONCAT(u.first_name, ' ', u.last_name) AS personel_adi,\r\n            ub.iris_altbayi,\r\n            pr.bayi_adi,\r\n            pr.dosya_adi,\r\n            ISNULL(bhpd.donem_adi, 'Dönem Tanımlanmamış') AS prim_donemi,\r\n            COUNT(*) AS toplam_adet,\r\n            SUM(CASE WHEN pr.uyelik_turu = 'ISP'  THEN 1 ELSE 0 END) AS ISP_adet,\r\n            SUM(CASE WHEN pr.uyelik_turu = 'NEO'  THEN 1 ELSE 0 END) AS NEO_adet,\r\n            SUM(CASE WHEN pr.uyelik_turu = 'UYDU' THEN 1 ELSE 0 END) AS UYDU_adet,\r\n            SUM(ISNULL(pr.odenecek_prim, 0)) AS toplam_odenecek_prim\r\n        FROM primebaz_rapor pr\r\n        INNER JOIN users_bayi ub \r\n            ON pr.memo_acan_personel_kimlik = ub.personel_kimlik_no\r\n        INNER JOIN users u \r\n            ON ub.user_id = u.id\r\n        LEFT JOIN digiturk.bayi_hakedis_prim_donem bhpd \r\n            ON pr.bayi_hakedis_prim_donem_id = bhpd.id\r\n        WHERE ISNULL(pr.odenecek_prim, 0) > 0\";\r\n    \r\n    // Kendi kullanıcısını görme yetkisi kontrolü\r\n    if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1) {\r\n        $sql .= \" AND ub.user_id = ?\";\r\n    }\r\n    \r\n    $sql .= \"\r\n        GROUP BY \r\n            pr.memo_acan_personel_kimlik, \r\n            u.first_name, \r\n            u.last_name, \r\n            ub.iris_altbayi, \r\n            pr.bayi_adi,\r\n            pr.dosya_adi,\r\n            bhpd.donem_adi\r\n        ORDER BY toplam_adet DESC\r\n    \";\r\n    \r\n    $stmt = $conn->prepare($sql);\r\n    if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1) {\r\n        $stmt->execute([$currentUser['id']]);\r\n    } else {\r\n        $stmt->execute();\r\n    }\r\n    $results = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    // Özet istatistikler - kendi kullanıcısını görme yetkisi kontrolü\r\n    $summarySQL = \"\r\n        SELECT \r\n            COUNT(*) as toplam_kayit,\r\n            COUNT(DISTINCT pr.memo_acan_personel_kimlik) as personel_sayisi,\r\n            COUNT(DISTINCT pr.bayi_adi) as bayi_sayisi,\r\n            COUNT(DISTINCT pr.dosya_adi) as dosya_sayisi,\r\n            SUM(CASE WHEN pr.uyelik_turu = 'ISP' THEN 1 ELSE 0 END) as toplam_isp,\r\n            SUM(CASE WHEN pr.uyelik_turu = 'NEO' THEN 1 ELSE 0 END) as toplam_neo,\r\n            SUM(CASE WHEN pr.uyelik_turu = 'UYDU' THEN 1 ELSE 0 END) as toplam_uydu,\r\n            SUM(ISNULL(pr.odenecek_prim, 0)) as toplam_odenecek_prim_tutari\r\n        FROM primebaz_rapor pr\";\r\n    \r\n    // Kendi kullanıcısını görme yetkisi kontrolü\r\n    if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1) {\r\n        $summarySQL .= \"\r\n        INNER JOIN users_bayi ub ON pr.memo_acan_personel_kimlik = ub.personel_kimlik_no\r\n        WHERE ISNULL(pr.odenecek_prim, 0) > 0 AND ub.user_id = ?\";\r\n    } else {\r\n        $summarySQL .= \"\r\n        WHERE ISNULL(pr.odenecek_prim, 0) > 0\";\r\n    }\r\n    \r\n    $summaryStmt = $conn->prepare($summarySQL);\r\n    if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1) {\r\n        $summaryStmt->execute([$currentUser['id']]);\r\n    } else {\r\n        $summaryStmt->execute();\r\n    }\r\n    $summary = $summaryStmt->fetch(PDO::FETCH_ASSOC);\r\n    \r\n    // En son yüklenen dosya bilgisi - kendi kullanıcısını görme yetkisi kontrolü\r\n    $lastFileSQL = \"\r\n        SELECT TOP 1 pr.dosya_adi, pr.yuklenme_tarihi, COUNT(*) as kayit_sayisi\r\n        FROM primebaz_rapor pr\";\r\n    \r\n    // Kendi kullanıcısını görme yetkisi kontrolü\r\n    if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1) {\r\n        $lastFileSQL .= \"\r\n        INNER JOIN users_bayi ub ON pr.memo_acan_personel_kimlik = ub.personel_kimlik_no\r\n        WHERE ISNULL(pr.odenecek_prim, 0) > 0 AND ub.user_id = ?\";\r\n    } else {\r\n        $lastFileSQL .= \"\r\n        WHERE ISNULL(pr.odenecek_prim, 0) > 0\";\r\n    }\r\n    \r\n    $lastFileSQL .= \"\r\n        GROUP BY pr.dosya_adi, pr.yuklenme_tarihi\r\n        ORDER BY pr.yuklenme_tarihi DESC\r\n    \";\r\n    \r\n    $lastFileStmt = $conn->prepare($lastFileSQL);\r\n    if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1) {\r\n        $lastFileStmt->execute([$currentUser['id']]);\r\n    } else {\r\n        $lastFileStmt->execute();\r\n    }\r\n    $lastFile = $lastFileStmt->fetch(PDO::FETCH_ASSOC);\r\n    \r\n    // Prim dönemleri listesi (id sırasına göre) - kendi kullanıcısını görme yetkisi kontrolü\r\n    $primDonemlerSQL = \"\r\n        SELECT DISTINCT bhpd.id, bhpd.donem_adi\r\n        FROM digiturk.bayi_hakedis_prim_donem bhpd\r\n        INNER JOIN primebaz_rapor pr ON pr.bayi_hakedis_prim_donem_id = bhpd.id\";\r\n    \r\n    // Kendi kullanıcısını görme yetkisi kontrolü\r\n    if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1) {\r\n        $primDonemlerSQL .= \"\r\n        INNER JOIN users_bayi ub ON pr.memo_acan_personel_kimlik = ub.personel_kimlik_no\r\n        WHERE bhpd.durum = 'AKTIF' AND ISNULL(pr.odenecek_prim, 0) > 0 AND ub.user_id = ?\";\r\n    } else {\r\n        $primDonemlerSQL .= \"\r\n        WHERE bhpd.durum = 'AKTIF' AND ISNULL(pr.odenecek_prim, 0) > 0\";\r\n    }\r\n    \r\n    $primDonemlerSQL .= \"\r\n        ORDER BY bhpd.id\r\n    \";\r\n    \r\n    $primDonemlerStmt = $conn->prepare($primDonemlerSQL);\r\n    if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1) {\r\n        $primDonemlerStmt->execute([$currentUser['id']]);\r\n    } else {\r\n        $primDonemlerStmt->execute();\r\n    }\r\n    $primDonemler = $primDonemlerStmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n} catch (Exception $e) {\r\n    $message = 'Veritabanı hatası: ' . $e->getMessage();\r\n    $messageType = 'danger';\r\n    $results = [];\r\n    $summary = [];\r\n    $lastFile = null;\r\n    $primDonemler = [];\r\n}\r\n\r\ninclude '../../../includes/header.php';\r\n?>\r\n\r\n<div class=\"row\">\r\n    <div class=\"col-12\">\r\n        <!-- Başlık -->\r\n        <div class=\"card mb-4\">\r\n            <div class=\"card-header bg-primary text-white\">\r\n                <h4 class=\"card-title mb-0\">\r\n                    <i class=\"fas fa-chart-bar me-2\"></i>\r\n                    Primebaz Rapor Analizi\r\n                </h4>\r\n            </div>\r\n            <div class=\"card-body\">\r\n                <p class=\"card-text text-muted\">\r\n                    Personel Kimlik No bazında üyelik türü analizi ve detaylı rapor görüntüleme sistemi\r\n                </p>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Hata/Başarı Mesajları -->\r\n        <?php if (!empty($message)): ?>\r\n            <div class=\"alert alert-<?php echo $messageType; ?> alert-dismissible fade show\" role=\"alert\">\r\n                <i class=\"fas fa-<?php echo $messageType === 'danger' ? 'exclamation-triangle' : 'check-circle'; ?> me-2\"></i>\r\n                <?php echo htmlspecialchars($message); ?>\r\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n            </div>\r\n        <?php endif; ?>\r\n\r\n        <!-- Özet İstatistikler -->\r\n        <?php if (!empty($summary)): ?>\r\n        <div class=\"row mb-4\" id=\"summaryStats\">\r\n            <div class=\"col-md-3\">\r\n                <div class=\"card border-0 shadow-sm\">\r\n                    <div class=\"card-body text-center\">\r\n                        <div class=\"display-6 text-primary fw-bold\" id=\"stat-toplam-kayit\">\r\n                            <?php echo number_format($summary['toplam_kayit'] ?? 0); ?>\r\n                        </div>\r\n                        <div class=\"text-muted small\">Toplam Girilen  İş</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div class=\"col-md-3\">\r\n                <div class=\"card border-0 shadow-sm\">\r\n                    <div class=\"card-body text-center\">\r\n                        <div class=\"display-6 text-primary fw-bold\" id=\"stat-toplam-kayit\">\r\n                            <?php echo number_format($summary['toplam_kayit'] ?? 0); ?>\r\n                        </div>\r\n                        <div class=\"text-muted small\">Toplam Hakedilen  İş</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div class=\"col-md-3\">\r\n                <div class=\"card border-0 shadow-sm\">\r\n                    <div class=\"card-body text-center\">\r\n                        <div class=\"display-6 text-info fw-bold\" id=\"stat-bayi-sayisi\">\r\n                            <?php echo number_format($summary['bayi_sayisi'] ?? 0); ?>\r\n                        </div>\r\n                        <div class=\"text-muted small\">Bayi Sayısı</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div class=\"col-md-3\">\r\n                <div class=\"card border-0 shadow-sm\">\r\n                    <div class=\"card-body text-center\">\r\n                        <div class=\"display-6 text-warning fw-bold\" id=\"stat-dosya-sayisi\">\r\n                            <?php echo number_format($summary['dosya_sayisi'] ?? 0); ?>\r\n                        </div>\r\n                        <div class=\"text-muted small\">Dosya Sayısı</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Üyelik Türü Dağılımı -->\r\n        <div class=\"row mb-4\">\r\n            <div class=\"col-md-3\">\r\n                <div class=\"card border-0 shadow-sm\">\r\n                    <div class=\"card-body text-center\">\r\n                        <div class=\"display-6 text-danger fw-bold\" id=\"stat-toplam-isp\">\r\n                            <?php echo number_format($summary['toplam_isp'] ?? 0); ?>\r\n                        </div>\r\n                        <div class=\"text-muted small\">ISP Üyelikleri</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div class=\"col-md-3\">\r\n                <div class=\"card border-0 shadow-sm\">\r\n                    <div class=\"card-body text-center\">\r\n                        <div class=\"display-6 text-success fw-bold\" id=\"stat-toplam-neo\">\r\n                            <?php echo number_format($summary['toplam_neo'] ?? 0); ?>\r\n                        </div>\r\n                        <div class=\"text-muted small\">NEO Üyelikleri</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div class=\"col-md-3\">\r\n                <div class=\"card border-0 shadow-sm\">\r\n                    <div class=\"card-body text-center\">\r\n                        <div class=\"display-6 text-primary fw-bold\" id=\"stat-toplam-uydu\">\r\n                            <?php echo number_format($summary['toplam_uydu'] ?? 0); ?>\r\n                        </div>\r\n                        <div class=\"text-muted small\">UYDU Üyelikleri</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div class=\"col-md-3\">\r\n                <div class=\"card border-0 shadow-sm\">\r\n                    <div class=\"card-body text-center\">\r\n                        <div class=\"display-6 text-warning fw-bold\" id=\"stat-toplam-prim\">\r\n                            <?php echo number_format($summary['toplam_odenecek_prim_tutari'] ?? 0, 2); ?> ₺\r\n                        </div>\r\n                        <div class=\"text-muted small\">Toplam Ödenecek Prim</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <?php endif; ?>\r\n\r\n        <!-- Kendi kullanıcısını görme yetkisi uyarısı -->\r\n        <?php if ($sayfaYetkileri['kendi_kullanicini_gor'] == 1): ?>\r\n        <div class=\"alert alert-warning\">\r\n            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n            Sadece kendi personellerinize ait kayıtları görüntüleyebilirsiniz.\r\n        </div>\r\n        <?php endif; ?>\r\n\r\n        <!-- Son Yüklenen Dosya Bilgisi -->\r\n        <?php if (!empty($lastFile)): ?>\r\n        <div class=\"alert alert-info\">\r\n            <i class=\"fas fa-info-circle me-2\"></i>\r\n            <strong>Son Yüklenen Dosya:</strong> \r\n            <?php echo htmlspecialchars($lastFile['dosya_adi']); ?> \r\n            <small class=\"text-muted\">\r\n                (<?php echo date('d.m.Y H:i', strtotime($lastFile['yuklenme_tarihi'])); ?> - \r\n                <?php echo number_format($lastFile['kayit_sayisi']); ?> kayıt)\r\n            </small>\r\n        </div>\r\n        <?php endif; ?>\r\n\r\n        <!-- Filtreler -->\r\n        <div class=\"card mb-4\">\r\n            <div class=\"card-header bg-light\">\r\n                <h6 class=\"card-title mb-0\">\r\n                    <i class=\"fas fa-filter me-2\"></i>\r\n                    Filtreler\r\n                </h6>\r\n                <small class=\"text-muted\">\r\n                    <i class=\"fas fa-info-circle me-1\"></i>\r\n                    Sadece ödenecek primi 0'dan büyük olan kayıtlar gösterilmektedir.\r\n                </small>\r\n            </div>\r\n            <div class=\"card-body\">\r\n                <div class=\"row g-3\">\r\n                    <div class=\"col-md-3\">\r\n                        <label for=\"filterPrimDonem\" class=\"form-label\">Prim Dönemi</label>\r\n                        <select class=\"form-select\" id=\"filterPrimDonem\">\r\n                            <option value=\"\">Tüm Dönemler</option>\r\n                            <?php if (!empty($primDonemler)): ?>\r\n                                <?php foreach ($primDonemler as $donem): ?>\r\n                                    <option value=\"<?php echo htmlspecialchars($donem['donem_adi']); ?>\">\r\n                                        <?php echo htmlspecialchars($donem['donem_adi']); ?>\r\n                                    </option>\r\n                                <?php endforeach; ?>\r\n                            <?php endif; ?>\r\n                            <?php \r\n                            // Dönem tanımlanmamış kayıtları için\r\n                            if (!empty($results)): \r\n                                $hasUndefinedPeriod = false;\r\n                                foreach ($results as $result) {\r\n                                    if (($result['prim_donemi'] ?? '') === 'Dönem Tanımlanmamış') {\r\n                                        $hasUndefinedPeriod = true;\r\n                                        break;\r\n                                    }\r\n                                }\r\n                                if ($hasUndefinedPeriod): \r\n                            ?>\r\n                                <option value=\"Dönem Tanımlanmamış\">Dönem Tanımlanmamış</option>\r\n                            <?php \r\n                                endif;\r\n                            endif; \r\n                            ?>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"col-md-3\">\r\n                        <label for=\"filterPersonel\" class=\"form-label\">Bayi Personel Adı</label>\r\n                        <select class=\"form-select\" id=\"filterPersonel\">\r\n                            <option value=\"\">Tüm Personeller</option>\r\n                            <?php if (!empty($results)): ?>\r\n                                <?php \r\n                                $personelList = array_unique(array_column($results, 'personel_adi'));\r\n                                sort($personelList);\r\n                                foreach ($personelList as $personel): \r\n                                ?>\r\n                                    <option value=\"<?php echo htmlspecialchars($personel); ?>\">\r\n                                        <?php echo htmlspecialchars($personel); ?>\r\n                                    </option>\r\n                                <?php endforeach; ?>\r\n                            <?php endif; ?>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"col-md-3\">\r\n                        <label for=\"filterDosya\" class=\"form-label\">Dosya Adı</label>\r\n                        <select class=\"form-select\" id=\"filterDosya\">\r\n                            <option value=\"\">Tüm Dosyalar</option>\r\n                            <?php if (!empty($results)): ?>\r\n                                <?php \r\n                                $dosyaList = array_unique(array_column($results, 'dosya_adi'));\r\n                                sort($dosyaList);\r\n                                foreach ($dosyaList as $dosya): \r\n                                ?>\r\n                                    <option value=\"<?php echo htmlspecialchars($dosya); ?>\">\r\n                                        <?php echo htmlspecialchars($dosya); ?>\r\n                                    </option>\r\n                                <?php endforeach; ?>\r\n                            <?php endif; ?>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"col-md-3 d-flex align-items-end\">\r\n                        <button type=\"button\" class=\"btn btn-outline-secondary\" id=\"clearFilters\">\r\n                            <i class=\"fas fa-times me-1\"></i>\r\n                            Filtreleri Temizle\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Ana Tablo -->\r\n        <div class=\"card\">\r\n            <div class=\"card-header bg-light\">\r\n                <div class=\"row align-items-center\">\r\n                    <div class=\"col\">\r\n                        <h5 class=\"card-title mb-0\">\r\n                            <i class=\"fas fa-table me-2\"></i>\r\n                            Personel Bazında Analiz Sonuçları\r\n                        </h5>\r\n                    </div>\r\n                    <div class=\"col-auto\">\r\n                        <?php if ($sayfaYetkileri['duzenle'] == 1): ?>\r\n                        <button class=\"btn btn-success btn-sm\" id=\"exportExcel\">\r\n                            <i class=\"fas fa-file-excel me-1\"></i>\r\n                            Excel'e Aktar\r\n                        </button>\r\n                        <button class=\"btn btn-info btn-sm\" id=\"printTable\">\r\n                            <i class=\"fas fa-print me-1\"></i>\r\n                            Yazdır\r\n                        </button>\r\n                        <?php endif; ?>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div class=\"card-body\">\r\n                <?php if (empty($results)): ?>\r\n                    <div class=\"text-center py-5\">\r\n                        <i class=\"fas fa-inbox fa-3x text-muted mb-3\"></i>\r\n                        <h5 class=\"text-muted\">Henüz analiz edilecek veri bulunmuyor</h5>\r\n                        <p class=\"text-muted\">Primebaz raporu yüklemek için <a href=\"primebaz_rapor_yukle.php\" class=\"text-decoration-none\">buraya tıklayın</a></p>\r\n                    </div>\r\n                <?php else: ?>\r\n                    <div class=\"table-responsive\">\r\n                        <table class=\"table table-hover table-striped\" id=\"analysisTable\">\r\n                            <thead class=\"table-dark\">\r\n                                <tr>\r\n                                    <th class=\"text-center\">#</th>\r\n                                    <th>Prim Dönemi</th>\r\n                                    <th>Personel Kimlik No</th>\r\n                                    <th>Bayi Personel Adı</th>\r\n                                    <th>Bayi Adı</th>\r\n                                    <th>Ana Bayi Adı</th>\r\n                                    <th>Dosya Adı</th>\r\n                                    <th class=\"text-center\">Toplam</th>\r\n                                    <th class=\"text-center\">ISP</th>\r\n                                    <th class=\"text-center\">NEO</th>\r\n                                    <th class=\"text-center\">UYDU</th>\r\n                                    <th class=\"text-center\">Ödenecek Prim</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody>\r\n                                <?php foreach ($results as $index => $row): ?>\r\n                                <tr>\r\n                                    <td class=\"text-center text-muted\">\r\n                                        <?php echo $index + 1; ?>\r\n                                    </td>\r\n                                    <td data-filter=\"<?php echo htmlspecialchars($row['prim_donemi'] ?? 'Dönem Tanımlanmamış'); ?>\">\r\n                                        <span class=\"badge bg-info\">\r\n                                            <?php echo htmlspecialchars($row['prim_donemi'] ?? 'Dönem Tanımlanmamış'); ?>\r\n                                        </span>\r\n                                    </td>\r\n                                    <td>\r\n                                        <code><?php echo htmlspecialchars($row['memo_acan_personel_kimlik'] ?? '-'); ?></code>\r\n                                    </td>\r\n                                    <td>\r\n                                        <strong><?php echo htmlspecialchars($row['personel_adi'] ?? '-'); ?></strong>\r\n                                    </td>\r\n                                    <td>\r\n                                        <span class=\"badge bg-secondary\">\r\n                                            <?php echo htmlspecialchars($row['iris_altbayi'] ?? '-'); ?>\r\n                                        </span>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo htmlspecialchars($row['bayi_adi'] ?? '-'); ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <small class=\"text-muted\">\r\n                                            <?php echo htmlspecialchars($row['dosya_adi'] ?? '-'); ?>\r\n                                        </small>\r\n                                    </td>\r\n                                    <td class=\"text-center\">\r\n                                        <span class=\"badge bg-primary fs-6\">\r\n                                            <?php echo number_format($row['toplam_adet'] ?? 0); ?>\r\n                                        </span>\r\n                                    </td>\r\n                                    <td class=\"text-center\">\r\n                                        <?php if (($row['ISP_adet'] ?? 0) > 0): ?>\r\n                                            <span class=\"badge bg-danger\">\r\n                                                <?php echo number_format($row['ISP_adet']); ?>\r\n                                            </span>\r\n                                        <?php else: ?>\r\n                                            <span class=\"text-muted\">-</span>\r\n                                        <?php endif; ?>\r\n                                    </td>\r\n                                    <td class=\"text-center\">\r\n                                        <?php if (($row['NEO_adet'] ?? 0) > 0): ?>\r\n                                            <span class=\"badge bg-success\">\r\n                                                <?php echo number_format($row['NEO_adet']); ?>\r\n                                            </span>\r\n                                        <?php else: ?>\r\n                                            <span class=\"text-muted\">-</span>\r\n                                        <?php endif; ?>\r\n                                    </td>\r\n                                    <td class=\"text-center\">\r\n                                        <?php if (($row['UYDU_adet'] ?? 0) > 0): ?>\r\n                                            <span class=\"badge bg-info\">\r\n                                                <?php echo number_format($row['UYDU_adet']); ?>\r\n                                            </span>\r\n                                        <?php else: ?>\r\n                                            <span class=\"text-muted\">-</span>\r\n                                        <?php endif; ?>\r\n                                    </td>\r\n                                    <td class=\"text-center\">\r\n                                        <span class=\"badge bg-warning text-dark fs-6\">\r\n                                            <?php echo number_format($row['toplam_odenecek_prim'] ?? 0, 2); ?> ₺\r\n                                        </span>\r\n                                    </td>\r\n                                </tr>\r\n                                <?php endforeach; ?>\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                    \r\n                    <!-- Sayfalama bilgisi -->\r\n                    <div class=\"mt-3\">\r\n                        <small class=\"text-muted\">\r\n                            Toplam <?php echo count($results); ?> sonuç gösteriliyor\r\n                        </small>\r\n                    </div>\r\n                <?php endif; ?>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- DataTables CSS ve JS -->\r\n<link rel=\"stylesheet\" type=\"text/css\" href=\"https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css\">\r\n<link rel=\"stylesheet\" type=\"text/css\" href=\"https://cdn.datatables.net/buttons/2.2.3/css/buttons.bootstrap5.min.css\">\r\n\r\n<script src=\"https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js\"></script>\r\n<script src=\"https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js\"></script>\r\n<script src=\"https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js\"></script>\r\n<script src=\"https://cdn.datatables.net/buttons/2.2.3/js/buttons.bootstrap5.min.js\"></script>\r\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js\"></script>\r\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js\"></script>\r\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js\"></script>\r\n<script src=\"https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js\"></script>\r\n<script src=\"https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js\"></script>\r\n\r\n<script>\r\n$(document).ready(function() {\r\n    // DataTable başlatma\r\n    var table = $('#analysisTable').DataTable({\r\n        dom: 'Bfrtip',\r\n        buttons: [],\r\n        language: {\r\n            url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/tr.json'\r\n        },\r\n        order: [[7, 'desc']], // Toplam adet sütununa göre sırala\r\n        pageLength: 50,\r\n        responsive: true,\r\n        columnDefs: [\r\n            { targets: [0, 7, 8, 9, 10, 11], className: 'text-center' },\r\n            { targets: [2], className: 'font-monospace' }\r\n        ]\r\n    });\r\n    \r\n    // Filtre fonksiyonları\r\n    function updateSummaryStats() {\r\n        // Filtrelenmiş satırları al\r\n        var filteredData = table.rows({ filter: 'applied' }).data().toArray();\r\n        \r\n        var stats = {\r\n            toplamKayit: 0,\r\n            personelSayisi: new Set(),\r\n            bayiSayisi: new Set(),\r\n            dosyaSayisi: new Set(),\r\n            toplamIsp: 0,\r\n            toplamNeo: 0,\r\n            toplamUydu: 0,\r\n            toplamPrim: 0\r\n        };\r\n        \r\n        // Her filtrelenmiş satır için istatistikleri hesapla\r\n        filteredData.forEach(function(row) {\r\n            // Toplam kayıt sayısı (her satır bir kayıt)\r\n            stats.toplamKayit += parseInt($(row[7]).text().replace(/,/g, '')) || 0;\r\n            \r\n            // Benzersiz personel, bayi ve dosya sayıları\r\n            stats.personelSayisi.add($(row[3]).text().trim());\r\n            stats.bayiSayisi.add($(row[5]).text().trim());\r\n            stats.dosyaSayisi.add($(row[6]).text().trim());\r\n            \r\n            // Üyelik türü toplamları\r\n            stats.toplamIsp += parseInt($(row[8]).text().replace(/,/g, '')) || 0;\r\n            stats.toplamNeo += parseInt($(row[9]).text().replace(/,/g, '')) || 0;\r\n            stats.toplamUydu += parseInt($(row[10]).text().replace(/,/g, '')) || 0;\r\n            \r\n            // Toplam prim tutarı\r\n            var primText = $(row[11]).text().replace(/₺|,/g, '').trim();\r\n            stats.toplamPrim = (stats.toplamPrim || 0) + (parseFloat(primText) || 0);\r\n        });\r\n        \r\n        // İstatistikleri güncelle\r\n        $('#stat-toplam-kayit').text(stats.toplamKayit.toLocaleString('tr-TR'));\r\n        $('#stat-personel-sayisi').text(stats.personelSayisi.size.toLocaleString('tr-TR'));\r\n        $('#stat-bayi-sayisi').text(stats.bayiSayisi.size.toLocaleString('tr-TR'));\r\n        $('#stat-dosya-sayisi').text(stats.dosyaSayisi.size.toLocaleString('tr-TR'));\r\n        $('#stat-toplam-isp').text(stats.toplamIsp.toLocaleString('tr-TR'));\r\n        $('#stat-toplam-neo').text(stats.toplamNeo.toLocaleString('tr-TR'));\r\n        $('#stat-toplam-uydu').text(stats.toplamUydu.toLocaleString('tr-TR'));\r\n        $('#stat-toplam-prim').text((stats.toplamPrim || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ₺');\r\n    }\r\n    \r\n    function applyFilters() {\r\n        var primDonemFilter = $('#filterPrimDonem').val();\r\n        var personelFilter = $('#filterPersonel').val();\r\n        var dosyaFilter = $('#filterDosya').val();\r\n        \r\n        console.log('Prim Dönem Filtresi:', primDonemFilter); // Debug için\r\n        \r\n        // Tüm filtreleri temizle\r\n        table.columns().search('');\r\n        \r\n        // Prim Dönemi filtresi\r\n        if (primDonemFilter !== '') {\r\n            // Önce data-filter attribute'unda ara\r\n            table.column(1).search(primDonemFilter, false, false);\r\n        }\r\n        \r\n        // Personel filtresi - tam eşleşme\r\n        if (personelFilter !== '') {\r\n            table.column(3).search('^' + $.fn.dataTable.util.escapeRegex(personelFilter) + '$', true, false);\r\n        }\r\n        \r\n        // Dosya filtresi - tam eşleşme\r\n        if (dosyaFilter !== '') {\r\n            table.column(6).search('^' + $.fn.dataTable.util.escapeRegex(dosyaFilter) + '$', true, false);\r\n        }\r\n        \r\n        table.draw();\r\n        \r\n        // İstatistikleri güncelle\r\n        updateSummaryStats();\r\n    }\r\n    \r\n    // Filtre butonları\r\n    $('#clearFilters').click(function() {\r\n        $('#filterPrimDonem').val('');\r\n        $('#filterPersonel').val('');\r\n        $('#filterDosya').val('');\r\n        table.columns().search('').draw();\r\n        // İstatistikleri güncelle\r\n        updateSummaryStats();\r\n    });\r\n    \r\n    // Filtre değişikliklerinde otomatik uygula\r\n    $('#filterPrimDonem, #filterPersonel, #filterDosya').change(function() {\r\n        applyFilters();\r\n    });\r\n    \r\n    // Excel Export\r\n    $('#exportExcel').click(function() {\r\n        var data = [];\r\n        \r\n        // Başlıkları ekle\r\n        data.push([\r\n            'Sıra',\r\n            'Prim Dönemi',\r\n            'Personel Kimlik No',\r\n            'Bayi Personel Adı',\r\n            'Bayi Adı',\r\n            'Ana Bayi Adı',\r\n            'Dosya Adı',\r\n            'Toplam Adet',\r\n            'ISP Adet',\r\n            'NEO Adet',\r\n            'UYDU Adet',\r\n            'Ödenecek Prim (₺)'\r\n        ]);\r\n        \r\n        // Filtrelenmiş veri satırlarını ekle\r\n        table.rows({ filter: 'applied' }).data().each(function(row, index) {\r\n            data.push([\r\n                index + 1,\r\n                $(row[1]).text(),\r\n                $(row[2]).text(),\r\n                $(row[3]).text(),\r\n                $(row[4]).text(),\r\n                $(row[5]).text(),\r\n                $(row[6]).text(),\r\n                $(row[7]).text(),\r\n                $(row[8]).text() || '0',\r\n                $(row[9]).text() || '0',\r\n                $(row[10]).text() || '0',\r\n                $(row[11]).text() || '0'\r\n            ]);\r\n        });\r\n        \r\n        // Excel dosyası oluştur ve indir\r\n        var ws = XLSX.utils.aoa_to_sheet(data);\r\n        var wb = XLSX.utils.book_new();\r\n        XLSX.utils.book_append_sheet(wb, ws, \"Primebaz Analiz\");\r\n        XLSX.writeFile(wb, 'primebaz_rapor_analizi_' + new Date().toISOString().split('T')[0] + '.xlsx');\r\n    });\r\n    \r\n    // Print function\r\n    $('#printTable').click(function() {\r\n        window.print();\r\n    });\r\n    \r\n    // Tablo satırlarına hover efekti\r\n    $('#analysisTable tbody tr').hover(\r\n        function() {\r\n            $(this).addClass('table-active');\r\n        },\r\n        function() {\r\n            $(this).removeClass('table-active');\r\n        }\r\n    );\r\n});\r\n</script>\r\n\r\n<!-- Excel Export için SheetJS -->\r\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js\"></script>\r\n\r\n<!-- Print için özel CSS -->\r\n<style>\r\n@media print {\r\n    .card-header .col-auto,\r\n    .breadcrumb,\r\n    .btn,\r\n    .alert {\r\n        display: none !important;\r\n    }\r\n    \r\n    .table {\r\n        font-size: 10px !important;\r\n    }\r\n    \r\n    .badge {\r\n        background-color: #000 !important;\r\n        color: #fff !important;\r\n        -webkit-print-color-adjust: exact !important;\r\n        print-color-adjust: exact !important;\r\n    }\r\n}\r\n\r\n/* Özel stiller */\r\n.table th {\r\n    font-weight: 600;\r\n    font-size: 0.875rem;\r\n}\r\n\r\n.table td {\r\n    vertical-align: middle;\r\n}\r\n\r\n.badge {\r\n    font-size: 0.75rem;\r\n    padding: 0.375em 0.5em;\r\n}\r\n\r\ncode {\r\n    background-color: #f8f9fa;\r\n    color: #495057;\r\n    padding: 0.2rem 0.4rem;\r\n    border-radius: 0.25rem;\r\n    font-size: 0.875em;\r\n}\r\n</style>\r\n\r\n<?php include '../../../includes/footer.php'; ?>"
        }
    ]
}
{
    "sourceFile": "iris_rapor_yukle.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1758960655892,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1759767412666,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -371,13 +371,30 @@\n // CSV dosyalarını listele\r\n $uploadsDir = __DIR__ . '/uploads';\r\n if (is_dir($uploadsDir)) {\r\n     $files = scandir($uploadsDir);\r\n+    $csvFilesWithTime = [];\r\n+    \r\n     foreach ($files as $file) {\r\n         if (pathinfo($file, PATHINFO_EXTENSION) === 'csv') {\r\n-            $csvFiles[] = $file;\r\n+            $filePath = $uploadsDir . '/' . $file;\r\n+            $modTime = filemtime($filePath);\r\n+            $csvFilesWithTime[] = [\r\n+                'name' => $file,\r\n+                'time' => $modTime\r\n+            ];\r\n         }\r\n     }\r\n+    \r\n+    // Dosyaları oluşturulma tarihine göre yeniden eskiye doğru sırala\r\n+    usort($csvFilesWithTime, function($a, $b) {\r\n+        return $b['time'] - $a['time']; // Yeniden eskiye (descending order)\r\n+    });\r\n+    \r\n+    // Sadece dosya isimlerini al\r\n+    foreach ($csvFilesWithTime as $fileInfo) {\r\n+        $csvFiles[] = $fileInfo['name'];\r\n+    }\r\n }\r\n \r\n // Veritabanı tablo yapısı (beklenen sütunlar)\r\n $expectedColumns = [\r\n"
                },
                {
                    "date": 1760511722896,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -48,10 +48,10 @@\n     }\r\n     \r\n     public function createIrisRaporTable() {\r\n         $sql = \"\r\n-        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='iris_rapor' AND xtype='U')\r\n-        CREATE TABLE iris_rapor (\r\n+        IF NOT EXISTS (SELECT * FROM sys.tables t JOIN sys.schemas s ON t.schema_id = s.schema_id WHERE s.name = 'digiturk' AND t.name = 'iris_rapor')\r\n+        CREATE TABLE digiturk.iris_rapor (\r\n             id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n             TALEP_ID NVARCHAR(50),\r\n             TALEP_TURU NVARCHAR(100),\r\n             UYDU_BASVURU_POTANSIYEL_NO NVARCHAR(50),\r\n@@ -94,11 +94,11 @@\n             guncellenme_tarihi DATETIME2,\r\n             dosya_adi NVARCHAR(255)\r\n         );\r\n         \r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('iris_rapor') AND name = 'IX_iris_rapor_MEMO_ID_UNIQUE')\r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('digiturk.iris_rapor') AND name = 'IX_iris_rapor_MEMO_ID_UNIQUE')\r\n         BEGIN\r\n-            CREATE UNIQUE INDEX IX_iris_rapor_MEMO_ID_UNIQUE ON iris_rapor (MEMO_ID) WHERE MEMO_ID IS NOT NULL\r\n+            CREATE UNIQUE INDEX IX_iris_rapor_MEMO_ID_UNIQUE ON digiturk.iris_rapor (MEMO_ID) WHERE MEMO_ID IS NOT NULL\r\n         END\r\n         \";\r\n         \r\n         try {\r\n@@ -108,9 +108,9 @@\n         }\r\n     }\r\n     \r\n     public function truncateTable() {\r\n-        $sql = \"TRUNCATE TABLE iris_rapor\";\r\n+        $sql = \"TRUNCATE TABLE digiturk.iris_rapor\";\r\n         $this->connection->exec($sql);\r\n     }\r\n     \r\n     public function convertDateFormat($dateString) {\r\n@@ -185,13 +185,13 @@\n         \r\n         $this->connection->beginTransaction();\r\n         \r\n         // Check if MEMO_ID exists\r\n-        $checkSql = \"SELECT id FROM iris_rapor WHERE MEMO_ID = ? AND MEMO_ID IS NOT NULL\";\r\n+        $checkSql = \"SELECT id FROM digiturk.iris_rapor WHERE MEMO_ID = ? AND MEMO_ID IS NOT NULL\";\r\n         $checkStmt = $this->connection->prepare($checkSql);\r\n         \r\n         // UPDATE statement - 38 parameters (all columns except MEMO_ID) + 1 for WHERE = 39 total\r\n-        $updateSql = \"UPDATE iris_rapor SET \r\n+        $updateSql = \"UPDATE digiturk.iris_rapor SET \r\n             TALEP_ID = ?, TALEP_TURU = ?, UYDU_BASVURU_POTANSIYEL_NO = ?, UYDU_BASVURU_UYE_NO = ?, DT_MUSTERI_NO = ?,\r\n             MEMO_KAYIT_TIPI = ?, MEMO_ID_TIP = ?, MEMO_KODU = ?, MEMO_KAPANIS_TARIHI = ?,\r\n             MEMO_YONLENEN_BAYI_KODU = ?, MEMO_YONLENEN_BAYI_ADI = ?, MEMO_YONLENEN_BAYI_YONETICISI = ?,\r\n             MEMO_YONLENEN_BAYI_BOLGE = ?, MEMO_YONLENEN_BAYI_TEKNIK_YNTC = ?, TALEP_GIRIS_TARIHI = ?,\r\n@@ -205,9 +205,9 @@\n             WHERE MEMO_ID = ? AND MEMO_ID IS NOT NULL\";\r\n         $updateStmt = $this->connection->prepare($updateSql);\r\n         \r\n         // INSERT statement - 39 parameters (all columns including dosya_adi)\r\n-        $insertSql = \"INSERT INTO iris_rapor (\r\n+        $insertSql = \"INSERT INTO digiturk.iris_rapor (\r\n             TALEP_ID, TALEP_TURU, UYDU_BASVURU_POTANSIYEL_NO, UYDU_BASVURU_UYE_NO, DT_MUSTERI_NO,\r\n             MEMO_ID, MEMO_KAYIT_TIPI, MEMO_ID_TIP, MEMO_KODU, MEMO_KAPANIS_TARIHI,\r\n             MEMO_YONLENEN_BAYI_KODU, MEMO_YONLENEN_BAYI_ADI, MEMO_YONLENEN_BAYI_YONETICISI,\r\n             MEMO_YONLENEN_BAYI_BOLGE, MEMO_YONLENEN_BAYI_TEKNIK_YNTC, TALEP_GIRIS_TARIHI,\r\n"
                }
            ],
            "date": 1758960655892,
            "name": "Commit-0",
            "content": "<?php\r\nerror_reporting(E_ALL);\r\nini_set('display_errors', 1);\r\n\r\nsession_start();\r\n\r\n// Yetki kontrolü - GEÇİCİ OLARAK KAPALI\r\n/*\r\nif (!isset($_SESSION['user_id'])) {\r\n    header('Location: login.php');\r\n    exit;\r\n}\r\n*/\r\n\r\nclass IrisMSSQLConnection {\r\n    private $connection;\r\n    private $config;\r\n    \r\n    public function __construct() {\r\n        $configFile = __DIR__ . '/config/mssql.php';\r\n        \r\n        if (!file_exists($configFile)) {\r\n            throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n        }\r\n        \r\n        $this->config = include $configFile;\r\n        $this->connect();\r\n    }\r\n    \r\n    private function connect() {\r\n        try {\r\n            $dsn = \"sqlsrv:Server={$this->config['host']};Database={$this->config['database']};TrustServerCertificate=yes\";\r\n            \r\n            $this->connection = new PDO($dsn, $this->config['username'], $this->config['password'], [\r\n                PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n                PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n                PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n                PDO::ATTR_EMULATE_PREPARES => false\r\n            ]);\r\n            \r\n        } catch (PDOException $e) {\r\n            throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n        }\r\n    }\r\n    \r\n    public function getConnection() {\r\n        return $this->connection;\r\n    }\r\n    \r\n    public function createIrisRaporTable() {\r\n        $sql = \"\r\n        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='iris_rapor' AND xtype='U')\r\n        CREATE TABLE iris_rapor (\r\n            id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n            TALEP_ID NVARCHAR(50),\r\n            TALEP_TURU NVARCHAR(100),\r\n            UYDU_BASVURU_POTANSIYEL_NO NVARCHAR(50),\r\n            UYDU_BASVURU_UYE_NO NVARCHAR(50),\r\n            DT_MUSTERI_NO NVARCHAR(50),\r\n            MEMO_ID BIGINT NULL,\r\n            MEMO_KAYIT_TIPI NVARCHAR(50),\r\n            MEMO_ID_TIP NVARCHAR(50),\r\n            MEMO_KODU NVARCHAR(100),\r\n            MEMO_KAPANIS_TARIHI DATETIME2,\r\n            MEMO_YONLENEN_BAYI_KODU NVARCHAR(50),\r\n            MEMO_YONLENEN_BAYI_ADI NVARCHAR(200),\r\n            MEMO_YONLENEN_BAYI_YONETICISI NVARCHAR(200),\r\n            MEMO_YONLENEN_BAYI_BOLGE NVARCHAR(100),\r\n            MEMO_YONLENEN_BAYI_TEKNIK_YNTC NVARCHAR(200),\r\n            TALEP_GIRIS_TARIHI DATETIME2,\r\n            TALEBI_GIREN_BAYI_KODU NVARCHAR(50),\r\n            TALEBI_GIREN_BAYI_ADI NVARCHAR(200),\r\n            TALEBI_GIREN_PERSONEL NVARCHAR(200),\r\n            TALEBI_GIREN_PERSONELNO NVARCHAR(50),\r\n            TALEBI_GIREN_PERSONELKODU NVARCHAR(50),\r\n            TALEBI_GIREN_PERSONEL_ALTBAYI NVARCHAR(200),\r\n            TALEP_KAYNAK NVARCHAR(100),\r\n            SATIS_DURUMU NVARCHAR(100),\r\n            INTERNET_SUREC_DURUMU NVARCHAR(100),\r\n            AKTIVE_EDILEN_UYENO NVARCHAR(50),\r\n            AKTIVE_EDILEN_OUTLETNO NVARCHAR(50),\r\n            AKTIVE_EDILEN_SOZLESMENO NVARCHAR(50),\r\n            AKTIVE_EDILEN_SOZLESMEKMP NVARCHAR(100),\r\n            AKTIVE_EDILEN_SOZLESMEDURUM NVARCHAR(100),\r\n            TALEP_TAKIP_NOTU NVARCHAR(1000),\r\n            GUNCEL_OUTLET_DURUM NVARCHAR(100),\r\n            TEYIT_DURUM NVARCHAR(100),\r\n            TEYIT_ARAMA_DURUM NVARCHAR(100),\r\n            RANDEVU_TARIHI DATETIME2,\r\n            MEMO_SON_DURUM NVARCHAR(100),\r\n            MEMO_SON_CEVAP NVARCHAR(500),\r\n            MEMO_SON_ACIKLAMA NVARCHAR(1000),\r\n            eklenme_tarihi DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n            guncellenme_tarihi DATETIME2,\r\n            dosya_adi NVARCHAR(255)\r\n        );\r\n        \r\n        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('iris_rapor') AND name = 'IX_iris_rapor_MEMO_ID_UNIQUE')\r\n        BEGIN\r\n            CREATE UNIQUE INDEX IX_iris_rapor_MEMO_ID_UNIQUE ON iris_rapor (MEMO_ID) WHERE MEMO_ID IS NOT NULL\r\n        END\r\n        \";\r\n        \r\n        try {\r\n            $this->connection->exec($sql);\r\n        } catch (PDOException $e) {\r\n            throw new Exception('Tablo oluşturma hatası: ' . $e->getMessage());\r\n        }\r\n    }\r\n    \r\n    public function truncateTable() {\r\n        $sql = \"TRUNCATE TABLE iris_rapor\";\r\n        $this->connection->exec($sql);\r\n    }\r\n    \r\n    public function convertDateFormat($dateString) {\r\n        if (empty($dateString)) {\r\n            return null;\r\n        }\r\n        \r\n        $formats = [\r\n            'd.m.Y H:i:s',\r\n            'd.m.Y H:i',\r\n            'd.m.Y',\r\n            'd/m/Y H:i:s',\r\n            'd/m/Y H:i',\r\n            'd/m/Y',\r\n            'Y-m-d H:i:s',\r\n            'Y-m-d H:i',\r\n            'Y-m-d'\r\n        ];\r\n        \r\n        foreach ($formats as $format) {\r\n            $date = DateTime::createFromFormat($format, $dateString);\r\n            if ($date !== false) {\r\n                return $date->format('Y-m-d H:i:s');\r\n            }\r\n        }\r\n        \r\n        return null;\r\n    }\r\n    \r\n    public function insertBatchStreaming($filePath, $expectedColumns, $fileName, $batchSize = 1000) {\r\n        ini_set('memory_limit', '512M');\r\n        set_time_limit(1800);\r\n        \r\n        $handle = fopen($filePath, 'r');\r\n        if (!$handle) {\r\n            throw new Exception('CSV dosyası açılamadı');\r\n        }\r\n        \r\n        $bom = fread($handle, 4);\r\n        if (substr($bom, 0, 3) === \"\\xEF\\xBB\\xBF\") {\r\n            fseek($handle, 3);\r\n        } else {\r\n            rewind($handle);\r\n        }\r\n        \r\n        $headers = null;\r\n        $currentPos = ftell($handle);\r\n        $headers = fgetcsv($handle, 0, ';', '\"', '\\\\');\r\n        if (!$headers || count($headers) <= 1) {\r\n            fseek($handle, $currentPos);\r\n            $headers = fgetcsv($handle, 0, ',', '\"', '\\\\');\r\n            if (!$headers || count($headers) <= 1) {\r\n                fseek($handle, $currentPos);\r\n                $headers = fgetcsv($handle, 0, \"\\t\", '\"', '\\\\');\r\n            }\r\n        }\r\n        \r\n        if (!$headers || count($headers) <= 1) {\r\n            fclose($handle);\r\n            throw new Exception('CSV başlıkları okunamadı');\r\n        }\r\n        \r\n        $columnMapping = [];\r\n        foreach ($expectedColumns as $expected) {\r\n            foreach ($headers as $index => $header) {\r\n                if (strtoupper(trim($header)) === strtoupper($expected)) {\r\n                    $columnMapping[$expected] = $index;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        \r\n        $this->connection->beginTransaction();\r\n        \r\n        // Check if MEMO_ID exists\r\n        $checkSql = \"SELECT id FROM iris_rapor WHERE MEMO_ID = ? AND MEMO_ID IS NOT NULL\";\r\n        $checkStmt = $this->connection->prepare($checkSql);\r\n        \r\n        // UPDATE statement - 38 parameters (all columns except MEMO_ID) + 1 for WHERE = 39 total\r\n        $updateSql = \"UPDATE iris_rapor SET \r\n            TALEP_ID = ?, TALEP_TURU = ?, UYDU_BASVURU_POTANSIYEL_NO = ?, UYDU_BASVURU_UYE_NO = ?, DT_MUSTERI_NO = ?,\r\n            MEMO_KAYIT_TIPI = ?, MEMO_ID_TIP = ?, MEMO_KODU = ?, MEMO_KAPANIS_TARIHI = ?,\r\n            MEMO_YONLENEN_BAYI_KODU = ?, MEMO_YONLENEN_BAYI_ADI = ?, MEMO_YONLENEN_BAYI_YONETICISI = ?,\r\n            MEMO_YONLENEN_BAYI_BOLGE = ?, MEMO_YONLENEN_BAYI_TEKNIK_YNTC = ?, TALEP_GIRIS_TARIHI = ?,\r\n            TALEBI_GIREN_BAYI_KODU = ?, TALEBI_GIREN_BAYI_ADI = ?, TALEBI_GIREN_PERSONEL = ?,\r\n            TALEBI_GIREN_PERSONELNO = ?, TALEBI_GIREN_PERSONELKODU = ?, TALEBI_GIREN_PERSONEL_ALTBAYI = ?,\r\n            TALEP_KAYNAK = ?, SATIS_DURUMU = ?, INTERNET_SUREC_DURUMU = ?, AKTIVE_EDILEN_UYENO = ?,\r\n            AKTIVE_EDILEN_OUTLETNO = ?, AKTIVE_EDILEN_SOZLESMENO = ?, AKTIVE_EDILEN_SOZLESMEKMP = ?,\r\n            AKTIVE_EDILEN_SOZLESMEDURUM = ?, TALEP_TAKIP_NOTU = ?, GUNCEL_OUTLET_DURUM = ?,\r\n            TEYIT_DURUM = ?, TEYIT_ARAMA_DURUM = ?, RANDEVU_TARIHI = ?, MEMO_SON_DURUM = ?,\r\n            MEMO_SON_CEVAP = ?, MEMO_SON_ACIKLAMA = ?, dosya_adi = ?, guncellenme_tarihi = GETDATE()\r\n            WHERE MEMO_ID = ? AND MEMO_ID IS NOT NULL\";\r\n        $updateStmt = $this->connection->prepare($updateSql);\r\n        \r\n        // INSERT statement - 39 parameters (all columns including dosya_adi)\r\n        $insertSql = \"INSERT INTO iris_rapor (\r\n            TALEP_ID, TALEP_TURU, UYDU_BASVURU_POTANSIYEL_NO, UYDU_BASVURU_UYE_NO, DT_MUSTERI_NO,\r\n            MEMO_ID, MEMO_KAYIT_TIPI, MEMO_ID_TIP, MEMO_KODU, MEMO_KAPANIS_TARIHI,\r\n            MEMO_YONLENEN_BAYI_KODU, MEMO_YONLENEN_BAYI_ADI, MEMO_YONLENEN_BAYI_YONETICISI,\r\n            MEMO_YONLENEN_BAYI_BOLGE, MEMO_YONLENEN_BAYI_TEKNIK_YNTC, TALEP_GIRIS_TARIHI,\r\n            TALEBI_GIREN_BAYI_KODU, TALEBI_GIREN_BAYI_ADI, TALEBI_GIREN_PERSONEL,\r\n            TALEBI_GIREN_PERSONELNO, TALEBI_GIREN_PERSONELKODU, TALEBI_GIREN_PERSONEL_ALTBAYI,\r\n            TALEP_KAYNAK, SATIS_DURUMU, INTERNET_SUREC_DURUMU, AKTIVE_EDILEN_UYENO,\r\n            AKTIVE_EDILEN_OUTLETNO, AKTIVE_EDILEN_SOZLESMENO, AKTIVE_EDILEN_SOZLESMEKMP,\r\n            AKTIVE_EDILEN_SOZLESMEDURUM, TALEP_TAKIP_NOTU, GUNCEL_OUTLET_DURUM,\r\n            TEYIT_DURUM, TEYIT_ARAMA_DURUM, RANDEVU_TARIHI, MEMO_SON_DURUM,\r\n            MEMO_SON_CEVAP, MEMO_SON_ACIKLAMA, dosya_adi\r\n        ) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\";\r\n        $insertStmt = $this->connection->prepare($insertSql);\r\n        \r\n        $rowCount = 0;\r\n        $skippedRows = 0;\r\n        $successCount = 0;\r\n        $errorCount = 0;\r\n        $updateCount = 0;\r\n        $insertCount = 0;\r\n        $errors = [];\r\n        $batchCount = 0;\r\n        \r\n        $delimiter = substr_count($headers[0], ',') > substr_count($headers[0], ';') ? ',' : ';';\r\n        \r\n        while (($row = fgetcsv($handle, 0, $delimiter, '\"', '\\\\')) !== false) {\r\n            $hasData = false;\r\n            foreach ($row as $cell) {\r\n                if (!empty(trim($cell))) {\r\n                    $hasData = true;\r\n                    break;\r\n                }\r\n            }\r\n            if (!$hasData) {\r\n                $skippedRows++;\r\n                continue;\r\n            }\r\n            \r\n            if (count($row) < count($expectedColumns)) {\r\n                $skippedRows++;\r\n                continue;\r\n            }\r\n            if (count($row) > count($expectedColumns)) {\r\n                $row = array_slice($row, 0, count($expectedColumns));\r\n            }\r\n            \r\n            $processedRow = [];\r\n            foreach ($expectedColumns as $column) {\r\n                $index = $columnMapping[$column] ?? null;\r\n                $value = ($index !== null && isset($row[$index])) ? trim($row[$index]) : null;\r\n                \r\n                if ($value === '') {\r\n                    $value = null;\r\n                }\r\n                \r\n                if (in_array($column, ['MEMO_KAPANIS_TARIHI', 'TALEP_GIRIS_TARIHI', 'RANDEVU_TARIHI'])) {\r\n                    $value = $this->convertDateFormat($value);\r\n                }\r\n                \r\n                if ($column === 'MEMO_ID') {\r\n                    if (!empty($value) && is_numeric($value)) {\r\n                        $value = intval($value);\r\n                    } else {\r\n                        $value = null;\r\n                    }\r\n                }\r\n                \r\n                $processedRow[] = $value;\r\n            }\r\n            $processedRow[] = $fileName; // dosya_adi at index 38\r\n            \r\n            $memoId = $processedRow[5]; // MEMO_ID is at index 5\r\n            \r\n            try {\r\n                if ($memoId === null) {\r\n                    // Direct INSERT for null MEMO_ID\r\n                    $insertStmt->execute($processedRow);\r\n                    $insertCount++;\r\n                    $successCount++;\r\n                } else {\r\n                    // Check if exists\r\n                    $checkStmt->execute([$memoId]);\r\n                    $existing = $checkStmt->fetch();\r\n                    \r\n                    if ($existing) {\r\n                        // UPDATE - build update array without MEMO_ID\r\n                        $updateParams = [];\r\n                        // Add first 5 columns (before MEMO_ID)\r\n                        for ($i = 0; $i < 5; $i++) {\r\n                            $updateParams[] = $processedRow[$i];\r\n                        }\r\n                        // Add columns after MEMO_ID (from index 6 to 37)\r\n                        for ($i = 6; $i < 38; $i++) {\r\n                            $updateParams[] = $processedRow[$i];\r\n                        }\r\n                        // Add dosya_adi\r\n                        $updateParams[] = $processedRow[38];\r\n                        // Add MEMO_ID for WHERE clause\r\n                        $updateParams[] = $memoId;\r\n                        \r\n                        $updateStmt->execute($updateParams);\r\n                        $updateCount++;\r\n                        $successCount++;\r\n                    } else {\r\n                        // INSERT new record\r\n                        $insertStmt->execute($processedRow);\r\n                        $insertCount++;\r\n                        $successCount++;\r\n                    }\r\n                }\r\n            } catch (PDOException $e) {\r\n                $errorCount++;\r\n                $errors[] = \"Satır \" . ($rowCount + 2) . \" (MEMO_ID: \" . ($memoId ?? 'NULL') . \"): \" . $e->getMessage();\r\n                \r\n                // Log the actual parameters for debugging\r\n                if ($errorCount <= 5) {\r\n                    error_log(\"Error on row \" . ($rowCount + 2) . \" - Parameter count: \" . count($processedRow));\r\n                    error_log(\"MEMO_ID: \" . ($memoId ?? 'NULL'));\r\n                }\r\n            }\r\n            \r\n            $rowCount++;\r\n            $batchCount++;\r\n            \r\n            if ($batchCount >= $batchSize) {\r\n                $this->connection->commit();\r\n                $this->connection->beginTransaction();\r\n                $batchCount = 0;\r\n                error_log(\"Processed $rowCount rows from $fileName\");\r\n            }\r\n        }\r\n        \r\n        $this->connection->commit();\r\n        fclose($handle);\r\n        \r\n        return [\r\n            'success' => true,\r\n            'successful' => $successCount,\r\n            'errors' => $errorCount,\r\n            'updated' => $updateCount,\r\n            'inserted' => $insertCount,\r\n            'totalProcessed' => $rowCount,\r\n            'skippedRows' => $skippedRows,\r\n            'error_details' => $errors,\r\n            'filename' => $fileName\r\n        ];\r\n    }\r\n}\r\n\r\n$pageTitle = 'Iris Rapor Yükleme';\r\n$breadcrumbs = [\r\n    ['title' => 'Iris Rapor Yükleme']\r\n];\r\n\r\n$message = '';\r\n$messageType = '';\r\n$csvFiles = [];\r\n$csvHeaders = [];\r\n$columnMapping = [];\r\n$uploadResult = null;\r\n\r\n// CSV dosyalarını listele\r\n$uploadsDir = __DIR__ . '/uploads';\r\nif (is_dir($uploadsDir)) {\r\n    $files = scandir($uploadsDir);\r\n    foreach ($files as $file) {\r\n        if (pathinfo($file, PATHINFO_EXTENSION) === 'csv') {\r\n            $csvFiles[] = $file;\r\n        }\r\n    }\r\n}\r\n\r\n// Veritabanı tablo yapısı (beklenen sütunlar)\r\n$expectedColumns = [\r\n    'TALEP_ID',\r\n    'TALEP_TURU', \r\n    'UYDU_BASVURU_POTANSIYEL_NO',\r\n    'UYDU_BASVURU_UYE_NO',\r\n    'DT_MUSTERI_NO',\r\n    'MEMO_ID',\r\n    'MEMO_KAYIT_TIPI',\r\n    'MEMO_ID_TIP',\r\n    'MEMO_KODU',\r\n    'MEMO_KAPANIS_TARIHI',\r\n    'MEMO_YONLENEN_BAYI_KODU',\r\n    'MEMO_YONLENEN_BAYI_ADI',\r\n    'MEMO_YONLENEN_BAYI_YONETICISI',\r\n    'MEMO_YONLENEN_BAYI_BOLGE',\r\n    'MEMO_YONLENEN_BAYI_TEKNIK_YNTC',\r\n    'TALEP_GIRIS_TARIHI',\r\n    'TALEBI_GIREN_BAYI_KODU',\r\n    'TALEBI_GIREN_BAYI_ADI',\r\n    'TALEBI_GIREN_PERSONEL',\r\n    'TALEBI_GIREN_PERSONELNO',\r\n    'TALEBI_GIREN_PERSONELKODU',\r\n    'TALEBI_GIREN_PERSONEL_ALTBAYI',\r\n    'TALEP_KAYNAK',\r\n    'SATIS_DURUMU',\r\n    'INTERNET_SUREC_DURUMU',\r\n    'AKTIVE_EDILEN_UYENO',\r\n    'AKTIVE_EDILEN_OUTLETNO',\r\n    'AKTIVE_EDILEN_SOZLESMENO',\r\n    'AKTIVE_EDILEN_SOZLESMEKMP',\r\n    'AKTIVE_EDILEN_SOZLESMEDURUM',\r\n    'TALEP_TAKIP_NOTU',\r\n    'GUNCEL_OUTLET_DURUM',\r\n    'TEYIT_DURUM',\r\n    'TEYIT_ARAMA_DURUM',\r\n    'RANDEVU_TARIHI',\r\n    'MEMO_SON_DURUM',\r\n    'MEMO_SON_CEVAP',\r\n    'MEMO_SON_ACIKLAMA'\r\n];\r\n\r\n// AJAX istekleri için\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    if (isset($_POST['action'])) {\r\n        header('Content-Type: application/json');\r\n        \r\n        if ($_POST['action'] === 'get_headers') {\r\n            $selectedFile = $_POST['file'] ?? '';\r\n            if (empty($selectedFile) || !in_array($selectedFile, $csvFiles)) {\r\n                echo json_encode(['success' => false, 'error' => 'Geçersiz dosya seçimi']);\r\n                exit;\r\n            }\r\n            \r\n            $filePath = $uploadsDir . '/' . $selectedFile;\r\n            $headers = [];\r\n            \r\n            try {\r\n                $handle = fopen($filePath, 'r');\r\n                if ($handle !== false) {\r\n                    $bom = fread($handle, 4);\r\n                    if (substr($bom, 0, 3) === \"\\xEF\\xBB\\xBF\") {\r\n                        fseek($handle, 3);\r\n                    } elseif (substr($bom, 0, 2) === \"\\xFF\\xFE\" || substr($bom, 0, 2) === \"\\xFE\\xFF\") {\r\n                        fseek($handle, 2);\r\n                    } else {\r\n                        rewind($handle);\r\n                    }\r\n                    \r\n                    $headerLine = null;\r\n                    $currentPos = ftell($handle);\r\n                    \r\n                    $headerLine = fgetcsv($handle, 0, ';', '\"', '\\\\');\r\n                    if (!$headerLine || count($headerLine) <= 1) {\r\n                        fseek($handle, $currentPos);\r\n                        $headerLine = fgetcsv($handle, 0, ',', '\"', '\\\\');\r\n                        if (!$headerLine || count($headerLine) <= 1) {\r\n                            fseek($handle, $currentPos);\r\n                            $headerLine = fgetcsv($handle, 0, \"\\t\", '\"', '\\\\');\r\n                        }\r\n                    }\r\n                    \r\n                    if ($headerLine && count($headerLine) > 1) {\r\n                        $headers = array_map('trim', $headerLine);\r\n                        \r\n                        $matches = [];\r\n                        $missingColumns = [];\r\n                        $extraColumns = [];\r\n                        \r\n                        foreach ($expectedColumns as $expected) {\r\n                            $found = false;\r\n                            foreach ($headers as $index => $header) {\r\n                                if (strtoupper(trim($header)) === strtoupper($expected)) {\r\n                                    $matches[$expected] = $index;\r\n                                    $found = true;\r\n                                    break;\r\n                                }\r\n                            }\r\n                            if (!$found) {\r\n                                $missingColumns[] = $expected;\r\n                            }\r\n                        }\r\n                        \r\n                        foreach ($headers as $header) {\r\n                            $found = false;\r\n                            foreach ($expectedColumns as $expected) {\r\n                                if (strtoupper(trim($header)) === strtoupper($expected)) {\r\n                                    $found = true;\r\n                                    break;\r\n                                }\r\n                            }\r\n                            if (!$found && !empty(trim($header))) {\r\n                                $extraColumns[] = $header;\r\n                            }\r\n                        }\r\n                        \r\n                        $isCompatible = empty($missingColumns);\r\n                        \r\n                        echo json_encode([\r\n                            'success' => true,\r\n                            'headers' => $headers,\r\n                            'expectedColumns' => $expectedColumns,\r\n                            'matches' => $matches,\r\n                            'missingColumns' => $missingColumns,\r\n                            'extraColumns' => $extraColumns,\r\n                            'isCompatible' => $isCompatible,\r\n                            'totalRows' => countCsvRows($filePath) - 1\r\n                        ]);\r\n                    } else {\r\n                        echo json_encode(['success' => false, 'error' => 'CSV başlıkları okunamadı']);\r\n                    }\r\n                    fclose($handle);\r\n                } else {\r\n                    echo json_encode(['success' => false, 'error' => 'Dosya açılamadı']);\r\n                }\r\n            } catch (Exception $e) {\r\n                echo json_encode(['success' => false, 'error' => 'Dosya okuma hatası: ' . $e->getMessage()]);\r\n            }\r\n            exit;\r\n        }\r\n        \r\n        if ($_POST['action'] === 'upload') {\r\n            $selectedFile = $_POST['file'] ?? '';\r\n            $truncate = isset($_POST['truncate']) && $_POST['truncate'] === '1';\r\n            \r\n            if (empty($selectedFile) || !in_array($selectedFile, $csvFiles)) {\r\n                echo json_encode(['success' => false, 'error' => 'Geçersiz dosya seçimi']);\r\n                exit;\r\n            }\r\n            \r\n            try {\r\n                $db = new IrisMSSQLConnection();\r\n                $db->createIrisRaporTable();\r\n                \r\n                if ($truncate) {\r\n                    $db->truncateTable();\r\n                }\r\n                \r\n                $result = $db->insertBatchStreaming($uploadsDir . '/' . $selectedFile, $expectedColumns, $selectedFile);\r\n                echo json_encode($result);\r\n            } catch (Exception $e) {\r\n                $errorDetails = [\r\n                    'success' => false,\r\n                    'error' => $e->getMessage(),\r\n                    'file' => $e->getFile(),\r\n                    'line' => $e->getLine(),\r\n                    'trace' => $e->getTraceAsString()\r\n                ];\r\n                error_log(\"Upload hatası: \" . json_encode($errorDetails));\r\n                echo json_encode($errorDetails);\r\n            }\r\n            exit;\r\n        }\r\n    }\r\n}\r\n\r\nfunction countCsvRows($filePath) {\r\n    $handle = fopen($filePath, 'r');\r\n    if (!$handle) return 0;\r\n    \r\n    $bom = fread($handle, 4);\r\n    if (substr($bom, 0, 3) === \"\\xEF\\xBB\\xBF\") {\r\n        fseek($handle, 3);\r\n    } else {\r\n        rewind($handle);\r\n    }\r\n    \r\n    $currentPos = ftell($handle);\r\n    $testLine = fgets($handle);\r\n    $delimiter = ';';\r\n    if (substr_count($testLine, ';') < substr_count($testLine, ',')) {\r\n        $delimiter = ',';\r\n    }\r\n    fseek($handle, $currentPos);\r\n    \r\n    $count = 0;\r\n    while (($row = fgetcsv($handle, 0, $delimiter, '\"', '\\\\')) !== false) {\r\n        $count++;\r\n    }\r\n    \r\n    fclose($handle);\r\n    return $count;\r\n}\r\n\r\ninclude 'includes/header.php';\r\n?>\r\n\r\n<div class=\"row\">\r\n    <div class=\"col-12\">\r\n        <div class=\"card\">\r\n            <div class=\"card-header bg-primary text-white\">\r\n                <h4 class=\"card-title mb-0\">\r\n                    <i class=\"fas fa-upload me-2\"></i>\r\n                    Iris Rapor Yükleme\r\n                </h4>\r\n            </div>\r\n            <div class=\"card-body\">\r\n                <?php if (empty($csvFiles)): ?>\r\n                    <div class=\"alert alert-warning\">\r\n                        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                        Uploads klasöründe CSV dosyası bulunamadı.\r\n                    </div>\r\n                <?php else: ?>\r\n                    <form id=\"uploadForm\">\r\n                        <div class=\"row\">\r\n                            <div class=\"col-md-6\">\r\n                                <div class=\"mb-3\">\r\n                                    <label for=\"csvFile\" class=\"form-label\">CSV Dosyası Seçin</label>\r\n                                    <select class=\"form-select\" id=\"csvFile\" name=\"csvFile\" required>\r\n                                        <option value=\"\">-- Dosya Seçin --</option>\r\n                                        <?php foreach ($csvFiles as $file): ?>\r\n                                            <option value=\"<?php echo htmlspecialchars($file); ?>\"><?php echo htmlspecialchars($file); ?></option>\r\n                                        <?php endforeach; ?>\r\n                                    </select>\r\n                                </div>\r\n                            </div>\r\n                            <div class=\"col-md-6\">\r\n                                <div class=\"mb-3\">\r\n                                    <label class=\"form-label\">Yükleme Seçenekleri</label>\r\n                                    <div class=\"form-check\">\r\n                                        <input class=\"form-check-input\" type=\"checkbox\" id=\"truncateTable\" name=\"truncateTable\" value=\"1\">\r\n                                        <label class=\"form-check-label text-danger\" for=\"truncateTable\">\r\n                                            <i class=\"fas fa-exclamation-triangle me-1\"></i>\r\n                                            Mevcut verileri temizle (Dikkat: Tüm veriler silinir!)\r\n                                        </label>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        \r\n                        <div id=\"fileAnalysis\" class=\"mb-4\" style=\"display: none;\">\r\n                            <div class=\"card\">\r\n                                <div class=\"card-header bg-info text-white\">\r\n                                    <h6 class=\"mb-0\">\r\n                                        <i class=\"fas fa-analytics me-2\"></i>\r\n                                        Dosya Analizi\r\n                                    </h6>\r\n                                </div>\r\n                                <div class=\"card-body\">\r\n                                    <div id=\"analysisContent\">\r\n                                        <!-- Analysis content will be loaded here -->\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        \r\n                        <div class=\"d-flex gap-2\">\r\n                            <button type=\"button\" id=\"analyzeBtn\" class=\"btn btn-info\" disabled>\r\n                                <i class=\"fas fa-search me-2\"></i>\r\n                                Dosyayı Analiz Et\r\n                            </button>\r\n                            <button type=\"submit\" id=\"uploadBtn\" class=\"btn btn-success\" disabled>\r\n                                <i class=\"fas fa-upload me-2\"></i>\r\n                                Yüklemeyi Başlat\r\n                            </button>\r\n                        </div>\r\n                    </form>\r\n                    \r\n                    <div id=\"progressContainer\" class=\"mt-4\" style=\"display: none;\">\r\n                        <div class=\"card\">\r\n                            <div class=\"card-body\">\r\n                                <h6>Yükleme Durumu:</h6>\r\n                                <div class=\"progress mb-3\">\r\n                                    <div id=\"progressBar\" class=\"progress-bar progress-bar-striped progress-bar-animated\" \r\n                                         role=\"progressbar\" style=\"width: 0%\"></div>\r\n                                </div>\r\n                                <div id=\"progressText\">Hazırlanıyor...</div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div id=\"resultContainer\" class=\"mt-4\" style=\"display: none;\">\r\n                        <div class=\"card\">\r\n                            <div class=\"card-header bg-success text-white\">\r\n                                <h6 class=\"mb-0\">\r\n                                    <i class=\"fas fa-check-circle me-2\"></i>\r\n                                    Yükleme Sonucu\r\n                                </h6>\r\n                            </div>\r\n                            <div class=\"card-body\">\r\n                                <div id=\"resultContent\">\r\n                                    <!-- Result content will be loaded here -->\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                <?php endif; ?>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<script>\r\n$(document).ready(function() {\r\n    let analysisData = null;\r\n    \r\n    // Dosya seçimi değiştiğinde\r\n    $('#csvFile').change(function() {\r\n        const selectedFile = $(this).val();\r\n        if (selectedFile) {\r\n            $('#analyzeBtn').prop('disabled', false);\r\n            $('#fileAnalysis').hide();\r\n            $('#uploadBtn').prop('disabled', true);\r\n            analysisData = null;\r\n        } else {\r\n            $('#analyzeBtn').prop('disabled', true);\r\n            $('#fileAnalysis').hide();\r\n            $('#uploadBtn').prop('disabled', true);\r\n        }\r\n    });\r\n    \r\n    // Analiz butonu\r\n    $('#analyzeBtn').click(function() {\r\n        const selectedFile = $('#csvFile').val();\r\n        if (!selectedFile) return;\r\n        \r\n        $(this).prop('disabled', true).html('<i class=\"fas fa-spinner fa-spin me-2\"></i>Analiz Ediliyor...');\r\n        \r\n        $.post('', {\r\n            action: 'get_headers',\r\n            file: selectedFile\r\n        })\r\n        .done(function(response) {\r\n            if (response.success) {\r\n                analysisData = response;\r\n                displayAnalysis(response);\r\n                $('#fileAnalysis').show();\r\n                $('#uploadBtn').prop('disabled', !response.isCompatible);\r\n            } else {\r\n                alert('Hata: ' + response.error);\r\n            }\r\n        })\r\n        .fail(function() {\r\n            alert('Sunucu hatası oluştu');\r\n        })\r\n        .always(function() {\r\n            $('#analyzeBtn').prop('disabled', false).html('<i class=\"fas fa-search me-2\"></i>Dosyayı Analiz Et');\r\n        });\r\n    });\r\n    \r\n    // Upload form\r\n    $('#uploadForm').submit(function(e) {\r\n        e.preventDefault();\r\n        \r\n        if (!analysisData || !analysisData.isCompatible) {\r\n            alert('Önce dosya analizi yapın ve uyumluluğu kontrol edin');\r\n            return;\r\n        }\r\n        \r\n        const truncate = $('#truncateTable').is(':checked');\r\n        if (truncate) {\r\n            if (!confirm('UYARI: Bu işlem mevcut tüm Iris rapor verilerini silecektir. Devam etmek istediğinizden emin misiniz?')) {\r\n                return;\r\n            }\r\n        }\r\n        \r\n        // Büyük dosya için ek uyarı\r\n        if (analysisData.totalRows > 20000) {\r\n            if (!confirm(`Bu dosyada ${analysisData.totalRows.toLocaleString()} kayıt bulunuyor. Yükleme işlemi 10-15 dakika sürebilir ve sayfayı kapatmamanız gerekir. Devam etmek istiyor musunuz?`)) {\r\n                return;\r\n            }\r\n        }\r\n        \r\n        startUpload();\r\n    });\r\n    \r\n    function displayAnalysis(data) {\r\n        let html = `\r\n            <div class=\"row\">\r\n                <div class=\"col-md-4\">\r\n                    <div class=\"text-center\">\r\n                        <div class=\"display-6 text-primary\">${data.headers.length}</div>\r\n                        <div class=\"text-muted\">CSV Sütun Sayısı</div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"col-md-4\">\r\n                    <div class=\"text-center\">\r\n                        <div class=\"display-6 text-success\">${Object.keys(data.matches).length}</div>\r\n                        <div class=\"text-muted\">Eşleşen Sütun</div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"col-md-4\">\r\n                    <div class=\"text-center\">\r\n                        <div class=\"display-6 text-info\">${data.totalRows || 'N/A'}</div>\r\n                        <div class=\"text-muted\">Toplam Kayıt</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <hr>\r\n        `;\r\n        \r\n        if (data.isCompatible) {\r\n            html += `\r\n                <div class=\"alert alert-success\">\r\n                    <i class=\"fas fa-check-circle me-2\"></i>\r\n                    <strong>Uyumlu!</strong> CSV dosyası veritabanı yapısıyla uyumlu. Yükleme işlemi başlatılabilir.\r\n                </div>\r\n            `;\r\n            \r\n            // Büyük dosya uyarısı\r\n            if (data.totalRows > 10000) {\r\n                html += `\r\n                    <div class=\"alert alert-info\">\r\n                        <i class=\"fas fa-info-circle me-2\"></i>\r\n                        <strong>Büyük Dosya:</strong> ${data.totalRows.toLocaleString()} kayıt tespit edildi. \r\n                        Yükleme işlemi 10-15 dakika sürebilir. Lütfen sayfayı kapatmayın.\r\n                    </div>\r\n                `;\r\n            }\r\n        } else {\r\n            html += `\r\n                <div class=\"alert alert-danger\">\r\n                    <i class=\"fas fa-times-circle me-2\"></i>\r\n                    <strong>Uyumsuz!</strong> CSV dosyasında bazı zorunlu sütunlar eksik.\r\n                </div>\r\n            `;\r\n        }\r\n        \r\n        if (data.missingColumns.length > 0) {\r\n            html += `\r\n                <div class=\"alert alert-warning\">\r\n                    <strong>Eksik Sütunlar:</strong><br>\r\n                    ${data.missingColumns.map(col => `<span class=\"badge bg-warning text-dark me-1\">${col}</span>`).join('')}\r\n                </div>\r\n            `;\r\n        }\r\n        \r\n        if (data.extraColumns.length > 0) {\r\n            html += `\r\n                <div class=\"alert alert-info\">\r\n                    <strong>Fazladan Sütunlar (göz ardı edilecek):</strong><br>\r\n                    ${data.extraColumns.map(col => `<span class=\"badge bg-info me-1\">${col}</span>`).join('')}\r\n                </div>\r\n            `;\r\n        }\r\n        \r\n        // Sütun eşleştirmesi tablosu\r\n        html += `\r\n            <div class=\"table-responsive mt-3\">\r\n                <table class=\"table table-sm\">\r\n                    <thead class=\"table-dark\">\r\n                        <tr>\r\n                            <th>Beklenen Sütun</th>\r\n                            <th>CSV Sütunu</th>\r\n                            <th>Durum</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n        `;\r\n        \r\n        data.expectedColumns.forEach(function(expected) {\r\n            const csvColumn = data.headers[data.matches[expected]] || 'Bulunamadı';\r\n            const status = data.matches[expected] !== undefined ? \r\n                '<span class=\"badge bg-success\">✓ Eşleşti</span>' : \r\n                '<span class=\"badge bg-danger\">✗ Eksik</span>';\r\n            \r\n            html += `\r\n                <tr>\r\n                    <td><code>${expected}</code></td>\r\n                    <td>${csvColumn !== 'Bulunamadı' ? csvColumn : '<em>Bulunamadı</em>'}</td>\r\n                    <td>${status}</td>\r\n                </tr>\r\n            `;\r\n        });\r\n        \r\n        html += `\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        `;\r\n        \r\n        $('#analysisContent').html(html);\r\n    }\r\n    \r\n    function startUpload() {\r\n        $('#uploadBtn').prop('disabled', true);\r\n        $('#progressContainer').show();\r\n        $('#resultContainer').hide();\r\n        \r\n        updateProgress(0, 'Yükleme başlatılıyor...');\r\n        \r\n        const selectedFile = $('#csvFile').val();\r\n        const truncate = $('#truncateTable').is(':checked') ? '1' : '0';\r\n        \r\n        // Büyük dosyalar için progress simulation\r\n        let progressInterval;\r\n        let currentProgress = 0;\r\n        \r\n        if (analysisData && analysisData.totalRows > 5000) {\r\n            progressInterval = setInterval(function() {\r\n                if (currentProgress < 90) {\r\n                    currentProgress += Math.random() * 3;\r\n                    updateProgress(Math.min(currentProgress, 90), 'Veriler işleniyor... (' + Math.floor(currentProgress) + '%)');\r\n                }\r\n            }, 1000);\r\n        }\r\n        \r\n        $.post('', {\r\n            action: 'upload',\r\n            file: selectedFile,\r\n            truncate: truncate\r\n        })\r\n        .done(function(response) {\r\n            if (progressInterval) {\r\n                clearInterval(progressInterval);\r\n            }\r\n            updateProgress(100, 'Tamamlandı!');\r\n            \r\n            setTimeout(function() {\r\n                $('#progressContainer').hide();\r\n                displayResult(response);\r\n            }, 1000);\r\n        })\r\n        .fail(function(xhr, status, error) {\r\n            if (progressInterval) {\r\n                clearInterval(progressInterval);\r\n            }\r\n            \r\n            let errorMessage = 'Hata oluştu!';\r\n            try {\r\n                if (xhr.responseText) {\r\n                    const response = JSON.parse(xhr.responseText);\r\n                    errorMessage = response.error || errorMessage;\r\n                    \r\n                    // Detaylı hata bilgisi konsola yazdır\r\n                    console.error('Upload Error Details:', response);\r\n                }\r\n            } catch (e) {\r\n                errorMessage = xhr.responseText || error || 'Bilinmeyen hata';\r\n            }\r\n            \r\n            updateProgress(100, errorMessage);\r\n            $('#progressBar').removeClass('bg-success').addClass('bg-danger');\r\n        })\r\n        .always(function() {\r\n            $('#uploadBtn').prop('disabled', false);\r\n        });\r\n    }\r\n    \r\n    function updateProgress(percent, text) {\r\n        $('#progressBar').css('width', percent + '%');\r\n        $('#progressText').text(text);\r\n        \r\n        if (percent === 100) {\r\n            $('#progressBar').removeClass('progress-bar-animated');\r\n        }\r\n    }\r\n    \r\n    function displayResult(result) {\r\n        let html = '';\r\n        \r\n        if (result.success) {\r\n            html = `\r\n                <div class=\"row text-center mb-3\">\r\n                    <div class=\"col-md-2\">\r\n                        <div class=\"display-6 text-primary\">${result.totalProcessed || 0}</div>\r\n                        <div class=\"text-muted\">İşlenen Kayıt</div>\r\n                    </div>\r\n                    <div class=\"col-md-2\">\r\n                        <div class=\"display-6 text-success\">${result.inserted || 0}</div>\r\n                        <div class=\"text-muted\">Eklenen</div>\r\n                    </div>\r\n                    <div class=\"col-md-2\">\r\n                        <div class=\"display-6 text-warning\">${result.updated || 0}</div>\r\n                        <div class=\"text-muted\">Güncellenen</div>\r\n                    </div>\r\n                    <div class=\"col-md-2\">\r\n                        <div class=\"display-6 text-danger\">${result.errors || 0}</div>\r\n                        <div class=\"text-muted\">Hata</div>\r\n                    </div>\r\n                    <div class=\"col-md-2\">\r\n                        <div class=\"display-6 text-info\">${result.skippedRows || 0}</div>\r\n                        <div class=\"text-muted\">Atlanan</div>\r\n                    </div>\r\n                    <div class=\"col-md-2\">\r\n                        <div class=\"display-6 text-secondary\">${result.totalProcessed || 0}</div>\r\n                        <div class=\"text-muted\">Toplam</div>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div class=\"alert alert-success\">\r\n                    <i class=\"fas fa-check-circle me-2\"></i>\r\n                    <strong>Başarılı!</strong> <code>${result.filename}</code> dosyası başarıyla işlendi.\r\n                </div>\r\n            `;\r\n            \r\n            if (result.error_details && result.error_details.length > 0) {\r\n                html += `\r\n                    <div class=\"alert alert-warning\">\r\n                        <strong>Hatalar:</strong>\r\n                        <ul class=\"mb-0 mt-2\">\r\n                            ${result.error_details.slice(0, 10).map(error => `<li><small>${error}</small></li>`).join('')}\r\n                        </ul>\r\n                        ${result.error_details.length > 10 ? `<small class=\"text-muted\">... ve ${result.error_details.length - 10} hata daha</small>` : ''}\r\n                    </div>\r\n                `;\r\n            }\r\n        } else {\r\n            html = `\r\n                <div class=\"alert alert-danger\">\r\n                    <i class=\"fas fa-times-circle me-2\"></i>\r\n                    <strong>Hata!</strong> ${result.error}\r\n                </div>\r\n            `;\r\n        }\r\n        \r\n        $('#resultContent').html(html);\r\n        $('#resultContainer').show();\r\n    }\r\n});\r\n</script>\r\n\r\n<?php include 'includes/footer.php'; ?>\r\n"
        }
    ]
}
{
    "sourceFile": "MSSQLConnection.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1758958391739,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1758977855775,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,20 @@\n <?php\r\n /**\r\n- * MSSQL Database Connection Class\r\n- * Iris Rapor sistemi için veritabanı bağlantı yöneticisi\r\n+ * MSSQL Database Connection Class            hakedis_tanim (\r\n+            id INT IDENTITY(1,1) PRIMARY KEY,\r\n+            bayi_id INT NOT NULL,\r\n+            isp_neo_fiyat DECIMAL(10,2) NULL,\r\n+            isp_uydu_fiyat DECIMAL(10,2) NULL,\r\n+            neo_fiyat DECIMAL(10,2) NULL,\r\n+            uydu_fiyat DECIMAL(10,2) NULL,\r\n+            hakedis_baslangic_tarihi DATETIME2 NOT NULL,\r\n+            hakedis_bitis_tarihi DATETIME2 NOT NULL,\r\n+            aciklama NVARCHAR(500) NULL,\r\n+            created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n+            updated_at DATETIME2 NULL,\r\n+            FOREIGN KEY (bayi_id) REFERENCES users(id) ON DELETE CASCADE\r\n+        );r sistemi için veritabanı bağlantı yöneticisi\r\n  */\r\n class MSSQLConnection {\r\n     private $connection;\r\n     private $config;\r\n"
                },
                {
                    "date": 1759242376094,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -90,8 +90,82 @@\n         }\r\n     }\r\n \r\n     /**\r\n+     * Primebaz rapor tablosunu oluştur (eğer yoksa)\r\n+     */\r\n+    public function createPrimebazTable() {\r\n+        $sql = \"\r\n+        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='primebaz_rapor' AND xtype='U')\r\n+        CREATE TABLE primebaz_rapor (\r\n+            id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n+            bayi_kodu NVARCHAR(50),\r\n+            bayi_adi NVARCHAR(200),\r\n+            bolge NVARCHAR(100),\r\n+            il NVARCHAR(50),\r\n+            ilce NVARCHAR(100),\r\n+            mahalle NVARCHAR(200),\r\n+            alan_kodu NVARCHAR(50),\r\n+            musteri_no NVARCHAR(50),\r\n+            musteri_adi NVARCHAR(200),\r\n+            musteri_soyadi NVARCHAR(200),\r\n+            telefon NVARCHAR(20),\r\n+            adres NVARCHAR(500),\r\n+            urun_kodu NVARCHAR(50),\r\n+            urun_adi NVARCHAR(200),\r\n+            paket_kodu NVARCHAR(50),\r\n+            paket_adi NVARCHAR(200),\r\n+            baslangic_tarihi DATETIME2,\r\n+            bitis_tarihi DATETIME2,\r\n+            islem_tarihi DATETIME2,\r\n+            islem_tipi NVARCHAR(50),\r\n+            tutar DECIMAL(10,2),\r\n+            komisyon_orani DECIMAL(5,2),\r\n+            komisyon_tutari DECIMAL(10,2),\r\n+            kdv_orani DECIMAL(5,2),\r\n+            kdv_tutari DECIMAL(10,2),\r\n+            toplam_tutar DECIMAL(10,2),\r\n+            odeme_tarihi DATETIME2,\r\n+            odeme_durumu NVARCHAR(50),\r\n+            aciklama NVARCHAR(500),\r\n+            ay INT,\r\n+            yil INT,\r\n+            donem NVARCHAR(20),\r\n+            eklenme_tarihi DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n+            guncellenme_tarihi DATETIME2,\r\n+            dosya_adi NVARCHAR(255)\r\n+        );\r\n+        \r\n+        -- İndeksler\r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_bayi_kodu')\r\n+        BEGIN\r\n+            CREATE INDEX IX_primebaz_rapor_bayi_kodu ON primebaz_rapor (bayi_kodu)\r\n+        END\r\n+        \r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_musteri_no')\r\n+        BEGIN\r\n+            CREATE INDEX IX_primebaz_rapor_musteri_no ON primebaz_rapor (musteri_no)\r\n+        END\r\n+        \r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_donem')\r\n+        BEGIN\r\n+            CREATE INDEX IX_primebaz_rapor_donem ON primebaz_rapor (yil, ay, donem)\r\n+        END\r\n+        \r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_tarih')\r\n+        BEGIN\r\n+            CREATE INDEX IX_primebaz_rapor_tarih ON primebaz_rapor (islem_tarihi)\r\n+        END\r\n+        \";\r\n+        \r\n+        try {\r\n+            $this->connection->exec($sql);\r\n+        } catch (PDOException $e) {\r\n+            throw new Exception('Primebaz tablosu oluşturma hatası: ' . $e->getMessage());\r\n+        }\r\n+    }\r\n+\r\n+    /**\r\n      * Iris rapor tablosunu oluştur (eğer yoksa)\r\n      */\r\n     public function createIrisRaporTable() {\r\n         $sql = \"\r\n"
                },
                {
                    "date": 1759329309532,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,387 @@\n+<?php\r\n+/**\r\n+ * MSSQL Database Connection Class            hakedis_tanim (\r\n+            id INT IDENTITY(1,1) PRIMARY KEY,\r\n+            bayi_id INT NOT NULL,\r\n+            isp_neo_fiyat DECIMAL(10,2) NULL,\r\n+            isp_uydu_fiyat DECIMAL(10,2) NULL,\r\n+            neo_fiyat DECIMAL(10,2) NULL,\r\n+            uydu_fiyat DECIMAL(10,2) NULL,\r\n+            hakedis_baslangic_tarihi DATETIME2 NOT NULL,\r\n+            hakedis_bitis_tarihi DATETIME2 NOT NULL,\r\n+            aciklama NVARCHAR(500) NULL,\r\n+            created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n+            updated_at DATETIME2 NULL,\r\n+            FOREIGN KEY (bayi_id) REFERENCES users(id) ON DELETE CASCADE\r\n+        );r sistemi için veritabanı bağlantı yöneticisi\r\n+ */\r\n+class MSSQLConnection {\r\n+    private $connection;\r\n+    private $config;\r\n+    \r\n+    public function __construct() {\r\n+        $configFile = __DIR__ . '/config/mssql.php';\r\n+        \r\n+        if (!file_exists($configFile)) {\r\n+            throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n+        }\r\n+        \r\n+        $this->config = include $configFile;\r\n+        $this->connect();\r\n+    }\r\n+    \r\n+    private function connect() {\r\n+        try {\r\n+            $dsn = \"sqlsrv:Server={$this->config['host']};Database={$this->config['database']};TrustServerCertificate=yes\";\r\n+            \r\n+            $this->connection = new PDO($dsn, $this->config['username'], $this->config['password'], [\r\n+                PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n+                PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n+                PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n+                PDO::ATTR_EMULATE_PREPARES => false\r\n+            ]);\r\n+            \r\n+        } catch (PDOException $e) {\r\n+            throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n+        }\r\n+    }\r\n+    \r\n+    public function getConnection() {\r\n+        return $this->connection;\r\n+    }\r\n+    \r\n+    /**\r\n+     * Hakediş tanım tablosunu oluştur (eğer yoksa)\r\n+     */\r\n+    public function createHakedisTanimTable() {\r\n+        $sql = \"\r\n+        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='hakedis_tanim' AND xtype='U')\r\n+        CREATE TABLE hakedis_tanim (\r\n+            id INT IDENTITY(1,1) PRIMARY KEY,\r\n+            bayi_id INT NOT NULL,\r\n+            isp_neo_fiyat DECIMAL(10,2) NULL,\r\n+            isp_uydu_fiyat DECIMAL(10,2) NULL,\r\n+            neo_fiyat DECIMAL(10,2) NULL,\r\n+            uydu_fiyat DECIMAL(10,2) NULL,\r\n+            hakedis_baslangic_tarihi DATETIME2 NOT NULL,\r\n+            hakedis_bitis_tarihi DATETIME2 NOT NULL,\r\n+            aciklama NVARCHAR(200) NULL,\r\n+            created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n+            updated_at DATETIME2 NULL,\r\n+            FOREIGN KEY (bayi_id) REFERENCES users(id) ON DELETE CASCADE\r\n+        );\r\n+        \r\n+        -- Index ekleme\r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('hakedis_tanim') AND name = 'IX_hakedis_tanim_bayi_id')\r\n+        BEGIN\r\n+            CREATE INDEX IX_hakedis_tanim_bayi_id ON hakedis_tanim (bayi_id)\r\n+        END\r\n+        \r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('hakedis_tanim') AND name = 'IX_hakedis_tanim_tarih')\r\n+        BEGIN\r\n+            CREATE INDEX IX_hakedis_tanim_tarih ON hakedis_tanim (hakedis_baslangic_tarihi, hakedis_bitis_tarihi)\r\n+        END\r\n+        \";\r\n+        \r\n+        try {\r\n+            $this->connection->exec($sql);\r\n+        } catch (PDOException $e) {\r\n+            throw new Exception('Hakediş tanım tablosu oluşturma hatası: ' . $e->getMessage());\r\n+        }\r\n+    }\r\n+\r\n+    /**\r\n+     * Primebaz rapor tablosunu oluştur (eğer yoksa)\r\n+     */\r\n+    public function createPrimebazTable() {\r\n+        $sql = \"\r\n+        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='primebaz_rapor' AND xtype='U')\r\n+        CREATE TABLE primebaz_rapor (\r\n+            id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n+            bayi_kodu NVARCHAR(50),\r\n+            bayi_adi NVARCHAR(200),\r\n+            bolge NVARCHAR(100),\r\n+            il NVARCHAR(50),\r\n+            ilce NVARCHAR(100),\r\n+            mahalle NVARCHAR(200),\r\n+            alan_kodu NVARCHAR(50),\r\n+            musteri_no NVARCHAR(50),\r\n+            musteri_adi NVARCHAR(200),\r\n+            musteri_soyadi NVARCHAR(200),\r\n+            telefon NVARCHAR(20),\r\n+            adres NVARCHAR(500),\r\n+            urun_kodu NVARCHAR(50),\r\n+            urun_adi NVARCHAR(200),\r\n+            paket_kodu NVARCHAR(50),\r\n+            paket_adi NVARCHAR(200),\r\n+            baslangic_tarihi DATETIME2,\r\n+            bitis_tarihi DATETIME2,\r\n+            islem_tarihi DATETIME2,\r\n+            islem_tipi NVARCHAR(50),\r\n+            tutar DECIMAL(10,2),\r\n+            komisyon_orani DECIMAL(5,2),\r\n+            komisyon_tutari DECIMAL(10,2),\r\n+            kdv_orani DECIMAL(5,2),\r\n+            kdv_tutari DECIMAL(10,2),\r\n+            toplam_tutar DECIMAL(10,2),\r\n+            odeme_tarihi DATETIME2,\r\n+            odeme_durumu NVARCHAR(50),\r\n+            aciklama NVARCHAR(500),\r\n+            ay INT,\r\n+            yil INT,\r\n+            donem NVARCHAR(20),\r\n+            eklenme_tarihi DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n+            guncellenme_tarihi DATETIME2,\r\n+            dosya_adi NVARCHAR(255)\r\n+        );\r\n+        \r\n+        -- İndeksler\r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_bayi_kodu')\r\n+        BEGIN\r\n+            CREATE INDEX IX_primebaz_rapor_bayi_kodu ON primebaz_rapor (bayi_kodu)\r\n+        END\r\n+        \r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_musteri_no')\r\n+        BEGIN\r\n+            CREATE INDEX IX_primebaz_rapor_musteri_no ON primebaz_rapor (musteri_no)\r\n+        END\r\n+        \r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_donem')\r\n+        BEGIN\r\n+            CREATE INDEX IX_primebaz_rapor_donem ON primebaz_rapor (yil, ay, donem)\r\n+        END\r\n+        \r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_tarih')\r\n+        BEGIN\r\n+            CREATE INDEX IX_primebaz_rapor_tarih ON primebaz_rapor (islem_tarihi)\r\n+        END\r\n+        \";\r\n+        \r\n+        try {\r\n+            $this->connection->exec($sql);\r\n+        } catch (PDOException $e) {\r\n+            throw new Exception('Primebaz tablosu oluşturma hatası: ' . $e->getMessage());\r\n+        }\r\n+    }\r\n+\r\n+    /**\r\n+     * Iris rapor tablosunu oluştur (eğer yoksa)\r\n+     */\r\n+    public function createIrisRaporTable() {\r\n+        $sql = \"\r\n+        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='iris_rapor' AND xtype='U')\r\n+        CREATE TABLE iris_rapor (\r\n+            id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n+            TALEP_ID NVARCHAR(50),\r\n+            TALEP_TURU NVARCHAR(100),\r\n+            UYDU_BASVURU_POTANSIYEL_NO NVARCHAR(50),\r\n+            UYDU_BASVURU_UYE_NO NVARCHAR(50),\r\n+            DT_MUSTERI_NO NVARCHAR(50),\r\n+            MEMO_ID BIGINT NULL,\r\n+            MEMO_KAYIT_TIPI NVARCHAR(50),\r\n+            MEMO_ID_TIP NVARCHAR(50),\r\n+            MEMO_KODU NVARCHAR(100),\r\n+            MEMO_KAPANIS_TARIHI DATETIME2,\r\n+            MEMO_YONLENEN_BAYI_KODU NVARCHAR(50),\r\n+            MEMO_YONLENEN_BAYI_ADI NVARCHAR(200),\r\n+            MEMO_YONLENEN_BAYI_YONETICISI NVARCHAR(200),\r\n+            MEMO_YONLENEN_BAYI_BOLGE NVARCHAR(100),\r\n+            MEMO_YONLENEN_BAYI_TEKNIK_YNTC NVARCHAR(200),\r\n+            TALEP_GIRIS_TARIHI DATETIME2,\r\n+            TALEBI_GIREN_BAYI_KODU NVARCHAR(50),\r\n+            TALEBI_GIREN_BAYI_ADI NVARCHAR(200),\r\n+            TALEBI_GIREN_PERSONEL NVARCHAR(200),\r\n+            TALEBI_GIREN_PERSONELNO NVARCHAR(50),\r\n+            TALEBI_GIREN_PERSONELKODU NVARCHAR(50),\r\n+            TALEBI_GIREN_PERSONEL_ALTBAYI NVARCHAR(200),\r\n+            TALEP_KAYNAK NVARCHAR(100),\r\n+            SATIS_DURUMU NVARCHAR(100),\r\n+            INTERNET_SUREC_DURUMU NVARCHAR(100),\r\n+            AKTIVE_EDILEN_UYENO NVARCHAR(50),\r\n+            AKTIVE_EDILEN_OUTLETNO NVARCHAR(50),\r\n+            AKTIVE_EDILEN_SOZLESMENO NVARCHAR(50),\r\n+            AKTIVE_EDILEN_SOZLESMEKMP NVARCHAR(100),\r\n+            AKTIVE_EDILEN_SOZLESMEDURUM NVARCHAR(100),\r\n+            TALEP_TAKIP_NOTU NVARCHAR(1000),\r\n+            GUNCEL_OUTLET_DURUM NVARCHAR(100),\r\n+            TEYIT_DURUM NVARCHAR(100),\r\n+            TEYIT_ARAMA_DURUM NVARCHAR(100),\r\n+            RANDEVU_TARIHI DATETIME2,\r\n+            MEMO_SON_DURUM NVARCHAR(100),\r\n+            MEMO_SON_CEVAP NVARCHAR(500),\r\n+            MEMO_SON_ACIKLAMA NVARCHAR(1000),\r\n+            eklenme_tarihi DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n+            guncellenme_tarihi DATETIME2,\r\n+            dosya_adi NVARCHAR(255)\r\n+        );\r\n+        \r\n+        -- MEMO_ID unique constraint sadece NULL olmayan değerler için\r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('iris_rapor') AND name = 'IX_iris_rapor_MEMO_ID_UNIQUE')\r\n+        BEGIN\r\n+            CREATE UNIQUE INDEX IX_iris_rapor_MEMO_ID_UNIQUE ON iris_rapor (MEMO_ID) WHERE MEMO_ID IS NOT NULL\r\n+        END\r\n+        \";\r\n+        \r\n+        try {\r\n+            $this->connection->exec($sql);\r\n+        } catch (PDOException $e) {\r\n+            throw new Exception('Tablo oluşturma hatası: ' . $e->getMessage());\r\n+        }\r\n+    }\r\n+\r\n+    public function insertBatch($data) {\r\n+        $successCount = 0;\r\n+        $errorCount = 0;\r\n+        $updateCount = 0;\r\n+        $insertCount = 0;\r\n+        $errors = [];\r\n+        \r\n+        try {\r\n+            $this->connection->beginTransaction();\r\n+            \r\n+            // MEMO_ID kontrolü ve güncelleme/ekleme sorguları\r\n+            $checkSql = \"SELECT id FROM iris_rapor WHERE MEMO_ID = ? AND MEMO_ID IS NOT NULL\";\r\n+            $checkStmt = $this->connection->prepare($checkSql);\r\n+            \r\n+            $updateSql = \"UPDATE iris_rapor SET \r\n+                TALEP_ID = ?, TALEP_TURU = ?, UYDU_BASVURU_POTANSIYEL_NO = ?, UYDU_BASVURU_UYE_NO = ?, DT_MUSTERI_NO = ?,\r\n+                MEMO_KAYIT_TIPI = ?, MEMO_ID_TIP = ?, MEMO_KODU = ?, MEMO_KAPANIS_TARIHI = ?,\r\n+                MEMO_YONLENEN_BAYI_KODU = ?, MEMO_YONLENEN_BAYI_ADI = ?, MEMO_YONLENEN_BAYI_YONETICISI = ?,\r\n+                MEMO_YONLENEN_BAYI_BOLGE = ?, MEMO_YONLENEN_BAYI_TEKNIK_YNTC = ?, TALEP_GIRIS_TARIHI = ?,\r\n+                TALEBI_GIREN_BAYI_KODU = ?, TALEBI_GIREN_BAYI_ADI = ?, TALEBI_GIREN_PERSONEL = ?,\r\n+                TALEBI_GIREN_PERSONELNO = ?, TALEBI_GIREN_PERSONELKODU = ?, TALEBI_GIREN_PERSONEL_ALTBAYI = ?,\r\n+                TALEP_KAYNAK = ?, SATIS_DURUMU = ?, INTERNET_SUREC_DURUMU = ?, AKTIVE_EDILEN_UYENO = ?,\r\n+                AKTIVE_EDILEN_OUTLETNO = ?, AKTIVE_EDILEN_SOZLESMENO = ?, AKTIVE_EDILEN_SOZLESMEKMP = ?,\r\n+                AKTIVE_EDILEN_SOZLESMEDURUM = ?, TALEP_TAKIP_NOTU = ?, GUNCEL_OUTLET_DURUM = ?,\r\n+                TEYIT_DURUM = ?, TEYIT_ARAMA_DURUM = ?, RANDEVU_TARIHI = ?, MEMO_SON_DURUM = ?,\r\n+                MEMO_SON_CEVAP = ?, MEMO_SON_ACIKLAMA = ?, dosya_adi = ?, guncellenme_tarihi = GETDATE()\r\n+                WHERE MEMO_ID = ? AND MEMO_ID IS NOT NULL\";\r\n+            $updateStmt = $this->connection->prepare($updateSql);\r\n+            \r\n+            $insertSql = \"INSERT INTO iris_rapor (\r\n+                TALEP_ID, TALEP_TURU, UYDU_BASVURU_POTANSIYEL_NO, UYDU_BASVURU_UYE_NO, DT_MUSTERI_NO,\r\n+                MEMO_ID, MEMO_KAYIT_TIPI, MEMO_ID_TIP, MEMO_KODU, MEMO_KAPANIS_TARIHI,\r\n+                MEMO_YONLENEN_BAYI_KODU, MEMO_YONLENEN_BAYI_ADI, MEMO_YONLENEN_BAYI_YONETICISI,\r\n+                MEMO_YONLENEN_BAYI_BOLGE, MEMO_YONLENEN_BAYI_TEKNIK_YNTC, TALEP_GIRIS_TARIHI,\r\n+                TALEBI_GIREN_BAYI_KODU, TALEBI_GIREN_BAYI_ADI, TALEBI_GIREN_PERSONEL,\r\n+                TALEBI_GIREN_PERSONELNO, TALEBI_GIREN_PERSONELKODU, TALEBI_GIREN_PERSONEL_ALTBAYI,\r\n+                TALEP_KAYNAK, SATIS_DURUMU, INTERNET_SUREC_DURUMU, AKTIVE_EDILEN_UYENO,\r\n+                AKTIVE_EDILEN_OUTLETNO, AKTIVE_EDILEN_SOZLESMENO, AKTIVE_EDILEN_SOZLESMEKMP,\r\n+                AKTIVE_EDILEN_SOZLESMEDURUM, TALEP_TAKIP_NOTU, GUNCEL_OUTLET_DURUM,\r\n+                TEYIT_DURUM, TEYIT_ARAMA_DURUM, RANDEVU_TARIHI, MEMO_SON_DURUM,\r\n+                MEMO_SON_CEVAP, MEMO_SON_ACIKLAMA, dosya_adi\r\n+            ) VALUES (\r\n+                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, \r\n+                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?\r\n+            )\";\r\n+            $insertStmt = $this->connection->prepare($insertSql);\r\n+            \r\n+            foreach ($data as $index => $row) {\r\n+                try {\r\n+                    $memoId = $row[5]; // MEMO_ID 6. sütun (0-indexed)\r\n+                    \r\n+                    // MEMO_ID boş ise null yap\r\n+                    if (empty($memoId) || !is_numeric($memoId)) {\r\n+                        $row[5] = null;\r\n+                        $memoId = null;\r\n+                    } else {\r\n+                        $memoId = intval($memoId);\r\n+                        $row[5] = $memoId;\r\n+                    }\r\n+                    \r\n+                    // MEMO_ID null ise direkt insert et\r\n+                    if ($memoId === null) {\r\n+                        $insertStmt->execute($row);\r\n+                        $insertCount++;\r\n+                        $successCount++;\r\n+                        continue;\r\n+                    }\r\n+                    \r\n+                    // MEMO_ID var mı kontrol et\r\n+                    $checkStmt->execute([$memoId]);\r\n+                    $existing = $checkStmt->fetch();\r\n+                    \r\n+                    if ($existing) {\r\n+                        // Güncelle - MEMO_ID'yi sona ekle\r\n+                        $updateRow = array_slice($row, 0, 5); // İlk 5 alan\r\n+                        $updateRow = array_merge($updateRow, array_slice($row, 6, 32)); // MEMO_ID'den sonraki alanlar\r\n+                        $updateRow[] = $row[38]; // dosya_adi ekle\r\n+                        $updateRow[] = $memoId; // MEMO_ID'yi WHERE koşulu için sona ekle\r\n+                        \r\n+                        $updateStmt->execute($updateRow);\r\n+                        $updateCount++;\r\n+                        $successCount++;\r\n+                    } else {\r\n+                        // Yeni kayıt ekle\r\n+                        $insertStmt->execute($row);\r\n+                        $insertCount++;\r\n+                        $successCount++;\r\n+                    }\r\n+                    \r\n+                } catch (PDOException $e) {\r\n+                    $errorCount++;\r\n+                    $errors[] = \"Satır \" . ($index + 2) . \" (MEMO_ID: \" . ($memoId ?? 'NULL') . \"): \" . $e->getMessage();\r\n+                }\r\n+            }\r\n+            \r\n+            $this->connection->commit();\r\n+            \r\n+            return [\r\n+                'success' => true,\r\n+                'successful' => $successCount,\r\n+                'errors' => $errorCount,\r\n+                'updated' => $updateCount,\r\n+                'inserted' => $insertCount,\r\n+                'error_details' => $errors\r\n+            ];\r\n+            \r\n+        } catch (Exception $e) {\r\n+            $this->connection->rollback();\r\n+            throw $e;\r\n+        }\r\n+    }\r\n+    \r\n+    public function convertDateFormat($dateString) {\r\n+        if (empty($dateString)) {\r\n+            return null;\r\n+        }\r\n+        \r\n+        // Farklı tarih formatlarını dene\r\n+        $formats = [\r\n+            'd.m.Y H:i:s',\r\n+            'd.m.Y H:i',\r\n+            'd.m.Y',\r\n+            'd/m/Y H:i:s',\r\n+            'd/m/Y H:i',\r\n+            'd/m/Y',\r\n+            'Y-m-d H:i:s',\r\n+            'Y-m-d H:i',\r\n+            'Y-m-d'\r\n+        ];\r\n+        \r\n+        foreach ($formats as $format) {\r\n+            $date = DateTime::createFromFormat($format, $dateString);\r\n+            if ($date !== false) {\r\n+                return $date->format('Y-m-d H:i:s');\r\n+            }\r\n+        }\r\n+        \r\n+        return null; // Hiçbir format uymazsa null döndür\r\n+    }\r\n+    \r\n+    public function truncateTable() {\r\n+        $sql = \"TRUNCATE TABLE iris_rapor\";\r\n+        $this->connection->exec($sql);\r\n+    }\r\n+    \r\n+    public function getRecordCount() {\r\n+        $stmt = $this->connection->query(\"SELECT COUNT(*) as count FROM iris_rapor\");\r\n+        $result = $stmt->fetch();\r\n+        return $result['count'];\r\n+    }\r\n+    \r\n+    public function __destruct() {\r\n+        $this->connection = null;\r\n+    }\r\n+}\r\n+?>\r\n"
                },
                {
                    "date": 1759335721881,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -384,391 +384,4 @@\n         $this->connection = null;\r\n     }\r\n }\r\n ?>\r\n-<?php\r\n-/**\r\n- * MSSQL Database Connection Class            hakedis_tanim (\r\n-            id INT IDENTITY(1,1) PRIMARY KEY,\r\n-            bayi_id INT NOT NULL,\r\n-            isp_neo_fiyat DECIMAL(10,2) NULL,\r\n-            isp_uydu_fiyat DECIMAL(10,2) NULL,\r\n-            neo_fiyat DECIMAL(10,2) NULL,\r\n-            uydu_fiyat DECIMAL(10,2) NULL,\r\n-            hakedis_baslangic_tarihi DATETIME2 NOT NULL,\r\n-            hakedis_bitis_tarihi DATETIME2 NOT NULL,\r\n-            aciklama NVARCHAR(500) NULL,\r\n-            created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n-            updated_at DATETIME2 NULL,\r\n-            FOREIGN KEY (bayi_id) REFERENCES users(id) ON DELETE CASCADE\r\n-        );r sistemi için veritabanı bağlantı yöneticisi\r\n- */\r\n-class MSSQLConnection {\r\n-    private $connection;\r\n-    private $config;\r\n-    \r\n-    public function __construct() {\r\n-        $configFile = __DIR__ . '/config/mssql.php';\r\n-        \r\n-        if (!file_exists($configFile)) {\r\n-            throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n-        }\r\n-        \r\n-        $this->config = include $configFile;\r\n-        $this->connect();\r\n-    }\r\n-    \r\n-    private function connect() {\r\n-        try {\r\n-            $dsn = \"sqlsrv:Server={$this->config['host']};Database={$this->config['database']};TrustServerCertificate=yes\";\r\n-            \r\n-            $this->connection = new PDO($dsn, $this->config['username'], $this->config['password'], [\r\n-                PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n-                PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n-                PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n-                PDO::ATTR_EMULATE_PREPARES => false\r\n-            ]);\r\n-            \r\n-        } catch (PDOException $e) {\r\n-            throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n-        }\r\n-    }\r\n-    \r\n-    public function getConnection() {\r\n-        return $this->connection;\r\n-    }\r\n-    \r\n-    /**\r\n-     * Hakediş tanım tablosunu oluştur (eğer yoksa)\r\n-     */\r\n-    public function createHakedisTanimTable() {\r\n-        $sql = \"\r\n-        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='hakedis_tanim' AND xtype='U')\r\n-        CREATE TABLE hakedis_tanim (\r\n-            id INT IDENTITY(1,1) PRIMARY KEY,\r\n-            bayi_id INT NOT NULL,\r\n-            isp_neo_fiyat DECIMAL(10,2) NULL,\r\n-            isp_uydu_fiyat DECIMAL(10,2) NULL,\r\n-            neo_fiyat DECIMAL(10,2) NULL,\r\n-            uydu_fiyat DECIMAL(10,2) NULL,\r\n-            hakedis_baslangic_tarihi DATETIME2 NOT NULL,\r\n-            hakedis_bitis_tarihi DATETIME2 NOT NULL,\r\n-            aciklama NVARCHAR(200) NULL,\r\n-            created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n-            updated_at DATETIME2 NULL,\r\n-            FOREIGN KEY (bayi_id) REFERENCES users(id) ON DELETE CASCADE\r\n-        );\r\n-        \r\n-        -- Index ekleme\r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('hakedis_tanim') AND name = 'IX_hakedis_tanim_bayi_id')\r\n-        BEGIN\r\n-            CREATE INDEX IX_hakedis_tanim_bayi_id ON hakedis_tanim (bayi_id)\r\n-        END\r\n-        \r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('hakedis_tanim') AND name = 'IX_hakedis_tanim_tarih')\r\n-        BEGIN\r\n-            CREATE INDEX IX_hakedis_tanim_tarih ON hakedis_tanim (hakedis_baslangic_tarihi, hakedis_bitis_tarihi)\r\n-        END\r\n-        \";\r\n-        \r\n-        try {\r\n-            $this->connection->exec($sql);\r\n-        } catch (PDOException $e) {\r\n-            throw new Exception('Hakediş tanım tablosu oluşturma hatası: ' . $e->getMessage());\r\n-        }\r\n-    }\r\n-\r\n-    /**\r\n-     * Primebaz rapor tablosunu oluştur (eğer yoksa)\r\n-     */\r\n-    public function createPrimebazTable() {\r\n-        $sql = \"\r\n-        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='primebaz_rapor' AND xtype='U')\r\n-        CREATE TABLE primebaz_rapor (\r\n-            id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n-            bayi_kodu NVARCHAR(50),\r\n-            bayi_adi NVARCHAR(200),\r\n-            bolge NVARCHAR(100),\r\n-            il NVARCHAR(50),\r\n-            ilce NVARCHAR(100),\r\n-            mahalle NVARCHAR(200),\r\n-            alan_kodu NVARCHAR(50),\r\n-            musteri_no NVARCHAR(50),\r\n-            musteri_adi NVARCHAR(200),\r\n-            musteri_soyadi NVARCHAR(200),\r\n-            telefon NVARCHAR(20),\r\n-            adres NVARCHAR(500),\r\n-            urun_kodu NVARCHAR(50),\r\n-            urun_adi NVARCHAR(200),\r\n-            paket_kodu NVARCHAR(50),\r\n-            paket_adi NVARCHAR(200),\r\n-            baslangic_tarihi DATETIME2,\r\n-            bitis_tarihi DATETIME2,\r\n-            islem_tarihi DATETIME2,\r\n-            islem_tipi NVARCHAR(50),\r\n-            tutar DECIMAL(10,2),\r\n-            komisyon_orani DECIMAL(5,2),\r\n-            komisyon_tutari DECIMAL(10,2),\r\n-            kdv_orani DECIMAL(5,2),\r\n-            kdv_tutari DECIMAL(10,2),\r\n-            toplam_tutar DECIMAL(10,2),\r\n-            odeme_tarihi DATETIME2,\r\n-            odeme_durumu NVARCHAR(50),\r\n-            aciklama NVARCHAR(500),\r\n-            ay INT,\r\n-            yil INT,\r\n-            donem NVARCHAR(20),\r\n-            eklenme_tarihi DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n-            guncellenme_tarihi DATETIME2,\r\n-            dosya_adi NVARCHAR(255)\r\n-        );\r\n-        \r\n-        -- İndeksler\r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_bayi_kodu')\r\n-        BEGIN\r\n-            CREATE INDEX IX_primebaz_rapor_bayi_kodu ON primebaz_rapor (bayi_kodu)\r\n-        END\r\n-        \r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_musteri_no')\r\n-        BEGIN\r\n-            CREATE INDEX IX_primebaz_rapor_musteri_no ON primebaz_rapor (musteri_no)\r\n-        END\r\n-        \r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_donem')\r\n-        BEGIN\r\n-            CREATE INDEX IX_primebaz_rapor_donem ON primebaz_rapor (yil, ay, donem)\r\n-        END\r\n-        \r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_tarih')\r\n-        BEGIN\r\n-            CREATE INDEX IX_primebaz_rapor_tarih ON primebaz_rapor (islem_tarihi)\r\n-        END\r\n-        \";\r\n-        \r\n-        try {\r\n-            $this->connection->exec($sql);\r\n-        } catch (PDOException $e) {\r\n-            throw new Exception('Primebaz tablosu oluşturma hatası: ' . $e->getMessage());\r\n-        }\r\n-    }\r\n-\r\n-    /**\r\n-     * Iris rapor tablosunu oluştur (eğer yoksa)\r\n-     */\r\n-    public function createIrisRaporTable() {\r\n-        $sql = \"\r\n-        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='iris_rapor' AND xtype='U')\r\n-        CREATE TABLE iris_rapor (\r\n-            id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n-            TALEP_ID NVARCHAR(50),\r\n-            TALEP_TURU NVARCHAR(100),\r\n-            UYDU_BASVURU_POTANSIYEL_NO NVARCHAR(50),\r\n-            UYDU_BASVURU_UYE_NO NVARCHAR(50),\r\n-            DT_MUSTERI_NO NVARCHAR(50),\r\n-            MEMO_ID BIGINT NULL,\r\n-            MEMO_KAYIT_TIPI NVARCHAR(50),\r\n-            MEMO_ID_TIP NVARCHAR(50),\r\n-            MEMO_KODU NVARCHAR(100),\r\n-            MEMO_KAPANIS_TARIHI DATETIME2,\r\n-            MEMO_YONLENEN_BAYI_KODU NVARCHAR(50),\r\n-            MEMO_YONLENEN_BAYI_ADI NVARCHAR(200),\r\n-            MEMO_YONLENEN_BAYI_YONETICISI NVARCHAR(200),\r\n-            MEMO_YONLENEN_BAYI_BOLGE NVARCHAR(100),\r\n-            MEMO_YONLENEN_BAYI_TEKNIK_YNTC NVARCHAR(200),\r\n-            TALEP_GIRIS_TARIHI DATETIME2,\r\n-            TALEBI_GIREN_BAYI_KODU NVARCHAR(50),\r\n-            TALEBI_GIREN_BAYI_ADI NVARCHAR(200),\r\n-            TALEBI_GIREN_PERSONEL NVARCHAR(200),\r\n-            TALEBI_GIREN_PERSONELNO NVARCHAR(50),\r\n-            TALEBI_GIREN_PERSONELKODU NVARCHAR(50),\r\n-            TALEBI_GIREN_PERSONEL_ALTBAYI NVARCHAR(200),\r\n-            TALEP_KAYNAK NVARCHAR(100),\r\n-            SATIS_DURUMU NVARCHAR(100),\r\n-            INTERNET_SUREC_DURUMU NVARCHAR(100),\r\n-            AKTIVE_EDILEN_UYENO NVARCHAR(50),\r\n-            AKTIVE_EDILEN_OUTLETNO NVARCHAR(50),\r\n-            AKTIVE_EDILEN_SOZLESMENO NVARCHAR(50),\r\n-            AKTIVE_EDILEN_SOZLESMEKMP NVARCHAR(100),\r\n-            AKTIVE_EDILEN_SOZLESMEDURUM NVARCHAR(100),\r\n-            TALEP_TAKIP_NOTU NVARCHAR(1000),\r\n-            GUNCEL_OUTLET_DURUM NVARCHAR(100),\r\n-            TEYIT_DURUM NVARCHAR(100),\r\n-            TEYIT_ARAMA_DURUM NVARCHAR(100),\r\n-            RANDEVU_TARIHI DATETIME2,\r\n-            MEMO_SON_DURUM NVARCHAR(100),\r\n-            MEMO_SON_CEVAP NVARCHAR(500),\r\n-            MEMO_SON_ACIKLAMA NVARCHAR(1000),\r\n-            eklenme_tarihi DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n-            guncellenme_tarihi DATETIME2,\r\n-            dosya_adi NVARCHAR(255)\r\n-        );\r\n-        \r\n-        -- MEMO_ID unique constraint sadece NULL olmayan değerler için\r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('iris_rapor') AND name = 'IX_iris_rapor_MEMO_ID_UNIQUE')\r\n-        BEGIN\r\n-            CREATE UNIQUE INDEX IX_iris_rapor_MEMO_ID_UNIQUE ON iris_rapor (MEMO_ID) WHERE MEMO_ID IS NOT NULL\r\n-        END\r\n-        \";\r\n-        \r\n-        try {\r\n-            $this->connection->exec($sql);\r\n-        } catch (PDOException $e) {\r\n-            throw new Exception('Tablo oluşturma hatası: ' . $e->getMessage());\r\n-        }\r\n-    }\r\n-\r\n-    public function insertBatch($data) {\r\n-        $successCount = 0;\r\n-        $errorCount = 0;\r\n-        $updateCount = 0;\r\n-        $insertCount = 0;\r\n-        $errors = [];\r\n-        \r\n-        try {\r\n-            $this->connection->beginTransaction();\r\n-            \r\n-            // MEMO_ID kontrolü ve güncelleme/ekleme sorguları\r\n-            $checkSql = \"SELECT id FROM iris_rapor WHERE MEMO_ID = ? AND MEMO_ID IS NOT NULL\";\r\n-            $checkStmt = $this->connection->prepare($checkSql);\r\n-            \r\n-            $updateSql = \"UPDATE iris_rapor SET \r\n-                TALEP_ID = ?, TALEP_TURU = ?, UYDU_BASVURU_POTANSIYEL_NO = ?, UYDU_BASVURU_UYE_NO = ?, DT_MUSTERI_NO = ?,\r\n-                MEMO_KAYIT_TIPI = ?, MEMO_ID_TIP = ?, MEMO_KODU = ?, MEMO_KAPANIS_TARIHI = ?,\r\n-                MEMO_YONLENEN_BAYI_KODU = ?, MEMO_YONLENEN_BAYI_ADI = ?, MEMO_YONLENEN_BAYI_YONETICISI = ?,\r\n-                MEMO_YONLENEN_BAYI_BOLGE = ?, MEMO_YONLENEN_BAYI_TEKNIK_YNTC = ?, TALEP_GIRIS_TARIHI = ?,\r\n-                TALEBI_GIREN_BAYI_KODU = ?, TALEBI_GIREN_BAYI_ADI = ?, TALEBI_GIREN_PERSONEL = ?,\r\n-                TALEBI_GIREN_PERSONELNO = ?, TALEBI_GIREN_PERSONELKODU = ?, TALEBI_GIREN_PERSONEL_ALTBAYI = ?,\r\n-                TALEP_KAYNAK = ?, SATIS_DURUMU = ?, INTERNET_SUREC_DURUMU = ?, AKTIVE_EDILEN_UYENO = ?,\r\n-                AKTIVE_EDILEN_OUTLETNO = ?, AKTIVE_EDILEN_SOZLESMENO = ?, AKTIVE_EDILEN_SOZLESMEKMP = ?,\r\n-                AKTIVE_EDILEN_SOZLESMEDURUM = ?, TALEP_TAKIP_NOTU = ?, GUNCEL_OUTLET_DURUM = ?,\r\n-                TEYIT_DURUM = ?, TEYIT_ARAMA_DURUM = ?, RANDEVU_TARIHI = ?, MEMO_SON_DURUM = ?,\r\n-                MEMO_SON_CEVAP = ?, MEMO_SON_ACIKLAMA = ?, dosya_adi = ?, guncellenme_tarihi = GETDATE()\r\n-                WHERE MEMO_ID = ? AND MEMO_ID IS NOT NULL\";\r\n-            $updateStmt = $this->connection->prepare($updateSql);\r\n-            \r\n-            $insertSql = \"INSERT INTO iris_rapor (\r\n-                TALEP_ID, TALEP_TURU, UYDU_BASVURU_POTANSIYEL_NO, UYDU_BASVURU_UYE_NO, DT_MUSTERI_NO,\r\n-                MEMO_ID, MEMO_KAYIT_TIPI, MEMO_ID_TIP, MEMO_KODU, MEMO_KAPANIS_TARIHI,\r\n-                MEMO_YONLENEN_BAYI_KODU, MEMO_YONLENEN_BAYI_ADI, MEMO_YONLENEN_BAYI_YONETICISI,\r\n-                MEMO_YONLENEN_BAYI_BOLGE, MEMO_YONLENEN_BAYI_TEKNIK_YNTC, TALEP_GIRIS_TARIHI,\r\n-                TALEBI_GIREN_BAYI_KODU, TALEBI_GIREN_BAYI_ADI, TALEBI_GIREN_PERSONEL,\r\n-                TALEBI_GIREN_PERSONELNO, TALEBI_GIREN_PERSONELKODU, TALEBI_GIREN_PERSONEL_ALTBAYI,\r\n-                TALEP_KAYNAK, SATIS_DURUMU, INTERNET_SUREC_DURUMU, AKTIVE_EDILEN_UYENO,\r\n-                AKTIVE_EDILEN_OUTLETNO, AKTIVE_EDILEN_SOZLESMENO, AKTIVE_EDILEN_SOZLESMEKMP,\r\n-                AKTIVE_EDILEN_SOZLESMEDURUM, TALEP_TAKIP_NOTU, GUNCEL_OUTLET_DURUM,\r\n-                TEYIT_DURUM, TEYIT_ARAMA_DURUM, RANDEVU_TARIHI, MEMO_SON_DURUM,\r\n-                MEMO_SON_CEVAP, MEMO_SON_ACIKLAMA, dosya_adi\r\n-            ) VALUES (\r\n-                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, \r\n-                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?\r\n-            )\";\r\n-            $insertStmt = $this->connection->prepare($insertSql);\r\n-            \r\n-            foreach ($data as $index => $row) {\r\n-                try {\r\n-                    $memoId = $row[5]; // MEMO_ID 6. sütun (0-indexed)\r\n-                    \r\n-                    // MEMO_ID boş ise null yap\r\n-                    if (empty($memoId) || !is_numeric($memoId)) {\r\n-                        $row[5] = null;\r\n-                        $memoId = null;\r\n-                    } else {\r\n-                        $memoId = intval($memoId);\r\n-                        $row[5] = $memoId;\r\n-                    }\r\n-                    \r\n-                    // MEMO_ID null ise direkt insert et\r\n-                    if ($memoId === null) {\r\n-                        $insertStmt->execute($row);\r\n-                        $insertCount++;\r\n-                        $successCount++;\r\n-                        continue;\r\n-                    }\r\n-                    \r\n-                    // MEMO_ID var mı kontrol et\r\n-                    $checkStmt->execute([$memoId]);\r\n-                    $existing = $checkStmt->fetch();\r\n-                    \r\n-                    if ($existing) {\r\n-                        // Güncelle - MEMO_ID'yi sona ekle\r\n-                        $updateRow = array_slice($row, 0, 5); // İlk 5 alan\r\n-                        $updateRow = array_merge($updateRow, array_slice($row, 6, 32)); // MEMO_ID'den sonraki alanlar\r\n-                        $updateRow[] = $row[38]; // dosya_adi ekle\r\n-                        $updateRow[] = $memoId; // MEMO_ID'yi WHERE koşulu için sona ekle\r\n-                        \r\n-                        $updateStmt->execute($updateRow);\r\n-                        $updateCount++;\r\n-                        $successCount++;\r\n-                    } else {\r\n-                        // Yeni kayıt ekle\r\n-                        $insertStmt->execute($row);\r\n-                        $insertCount++;\r\n-                        $successCount++;\r\n-                    }\r\n-                    \r\n-                } catch (PDOException $e) {\r\n-                    $errorCount++;\r\n-                    $errors[] = \"Satır \" . ($index + 2) . \" (MEMO_ID: \" . ($memoId ?? 'NULL') . \"): \" . $e->getMessage();\r\n-                }\r\n-            }\r\n-            \r\n-            $this->connection->commit();\r\n-            \r\n-            return [\r\n-                'success' => true,\r\n-                'successful' => $successCount,\r\n-                'errors' => $errorCount,\r\n-                'updated' => $updateCount,\r\n-                'inserted' => $insertCount,\r\n-                'error_details' => $errors\r\n-            ];\r\n-            \r\n-        } catch (Exception $e) {\r\n-            $this->connection->rollback();\r\n-            throw $e;\r\n-        }\r\n-    }\r\n-    \r\n-    public function convertDateFormat($dateString) {\r\n-        if (empty($dateString)) {\r\n-            return null;\r\n-        }\r\n-        \r\n-        // Farklı tarih formatlarını dene\r\n-        $formats = [\r\n-            'd.m.Y H:i:s',\r\n-            'd.m.Y H:i',\r\n-            'd.m.Y',\r\n-            'd/m/Y H:i:s',\r\n-            'd/m/Y H:i',\r\n-            'd/m/Y',\r\n-            'Y-m-d H:i:s',\r\n-            'Y-m-d H:i',\r\n-            'Y-m-d'\r\n-        ];\r\n-        \r\n-        foreach ($formats as $format) {\r\n-            $date = DateTime::createFromFormat($format, $dateString);\r\n-            if ($date !== false) {\r\n-                return $date->format('Y-m-d H:i:s');\r\n-            }\r\n-        }\r\n-        \r\n-        return null; // Hiçbir format uymazsa null döndür\r\n-    }\r\n-    \r\n-    public function truncateTable() {\r\n-        $sql = \"TRUNCATE TABLE iris_rapor\";\r\n-        $this->connection->exec($sql);\r\n-    }\r\n-    \r\n-    public function getRecordCount() {\r\n-        $stmt = $this->connection->query(\"SELECT COUNT(*) as count FROM iris_rapor\");\r\n-        $result = $stmt->fetch();\r\n-        return $result['count'];\r\n-    }\r\n-    \r\n-    public function __destruct() {\r\n-        $this->connection = null;\r\n-    }\r\n-}\r\n-?>\r\n"
                }
            ],
            "date": 1758958391739,
            "name": "Commit-0",
            "content": "<?php\r\n/**\r\n * MSSQL Database Connection Class\r\n * Iris Rapor sistemi için veritabanı bağlantı yöneticisi\r\n */\r\nclass MSSQLConnection {\r\n    private $connection;\r\n    private $config;\r\n    \r\n    public function __construct() {\r\n        $configFile = __DIR__ . '/config/mssql.php';\r\n        \r\n        if (!file_exists($configFile)) {\r\n            throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n        }\r\n        \r\n        $this->config = include $configFile;\r\n        $this->connect();\r\n    }\r\n    \r\n    private function connect() {\r\n        try {\r\n            $dsn = \"sqlsrv:Server={$this->config['host']};Database={$this->config['database']};TrustServerCertificate=yes\";\r\n            \r\n            $this->connection = new PDO($dsn, $this->config['username'], $this->config['password'], [\r\n                PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n                PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n                PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n                PDO::ATTR_EMULATE_PREPARES => false\r\n            ]);\r\n            \r\n        } catch (PDOException $e) {\r\n            throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n        }\r\n    }\r\n    \r\n    public function getConnection() {\r\n        return $this->connection;\r\n    }\r\n    \r\n    /**\r\n     * Hakediş tanım tablosunu oluştur (eğer yoksa)\r\n     */\r\n    public function createHakedisTanimTable() {\r\n        $sql = \"\r\n        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='hakedis_tanim' AND xtype='U')\r\n        CREATE TABLE hakedis_tanim (\r\n            id INT IDENTITY(1,1) PRIMARY KEY,\r\n            bayi_id INT NOT NULL,\r\n            isp_neo_fiyat DECIMAL(10,2) NULL,\r\n            isp_uydu_fiyat DECIMAL(10,2) NULL,\r\n            neo_fiyat DECIMAL(10,2) NULL,\r\n            uydu_fiyat DECIMAL(10,2) NULL,\r\n            hakedis_baslangic_tarihi DATETIME2 NOT NULL,\r\n            hakedis_bitis_tarihi DATETIME2 NOT NULL,\r\n            aciklama NVARCHAR(200) NULL,\r\n            created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n            updated_at DATETIME2 NULL,\r\n            FOREIGN KEY (bayi_id) REFERENCES users(id) ON DELETE CASCADE\r\n        );\r\n        \r\n        -- Index ekleme\r\n        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('hakedis_tanim') AND name = 'IX_hakedis_tanim_bayi_id')\r\n        BEGIN\r\n            CREATE INDEX IX_hakedis_tanim_bayi_id ON hakedis_tanim (bayi_id)\r\n        END\r\n        \r\n        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('hakedis_tanim') AND name = 'IX_hakedis_tanim_tarih')\r\n        BEGIN\r\n            CREATE INDEX IX_hakedis_tanim_tarih ON hakedis_tanim (hakedis_baslangic_tarihi, hakedis_bitis_tarihi)\r\n        END\r\n        \";\r\n        \r\n        try {\r\n            $this->connection->exec($sql);\r\n        } catch (PDOException $e) {\r\n            throw new Exception('Hakediş tanım tablosu oluşturma hatası: ' . $e->getMessage());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Iris rapor tablosunu oluştur (eğer yoksa)\r\n     */\r\n    public function createIrisRaporTable() {\r\n        $sql = \"\r\n        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='iris_rapor' AND xtype='U')\r\n        CREATE TABLE iris_rapor (\r\n            id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n            TALEP_ID NVARCHAR(50),\r\n            TALEP_TURU NVARCHAR(100),\r\n            UYDU_BASVURU_POTANSIYEL_NO NVARCHAR(50),\r\n            UYDU_BASVURU_UYE_NO NVARCHAR(50),\r\n            DT_MUSTERI_NO NVARCHAR(50),\r\n            MEMO_ID BIGINT NULL,\r\n            MEMO_KAYIT_TIPI NVARCHAR(50),\r\n            MEMO_ID_TIP NVARCHAR(50),\r\n            MEMO_KODU NVARCHAR(100),\r\n            MEMO_KAPANIS_TARIHI DATETIME2,\r\n            MEMO_YONLENEN_BAYI_KODU NVARCHAR(50),\r\n            MEMO_YONLENEN_BAYI_ADI NVARCHAR(200),\r\n            MEMO_YONLENEN_BAYI_YONETICISI NVARCHAR(200),\r\n            MEMO_YONLENEN_BAYI_BOLGE NVARCHAR(100),\r\n            MEMO_YONLENEN_BAYI_TEKNIK_YNTC NVARCHAR(200),\r\n            TALEP_GIRIS_TARIHI DATETIME2,\r\n            TALEBI_GIREN_BAYI_KODU NVARCHAR(50),\r\n            TALEBI_GIREN_BAYI_ADI NVARCHAR(200),\r\n            TALEBI_GIREN_PERSONEL NVARCHAR(200),\r\n            TALEBI_GIREN_PERSONELNO NVARCHAR(50),\r\n            TALEBI_GIREN_PERSONELKODU NVARCHAR(50),\r\n            TALEBI_GIREN_PERSONEL_ALTBAYI NVARCHAR(200),\r\n            TALEP_KAYNAK NVARCHAR(100),\r\n            SATIS_DURUMU NVARCHAR(100),\r\n            INTERNET_SUREC_DURUMU NVARCHAR(100),\r\n            AKTIVE_EDILEN_UYENO NVARCHAR(50),\r\n            AKTIVE_EDILEN_OUTLETNO NVARCHAR(50),\r\n            AKTIVE_EDILEN_SOZLESMENO NVARCHAR(50),\r\n            AKTIVE_EDILEN_SOZLESMEKMP NVARCHAR(100),\r\n            AKTIVE_EDILEN_SOZLESMEDURUM NVARCHAR(100),\r\n            TALEP_TAKIP_NOTU NVARCHAR(1000),\r\n            GUNCEL_OUTLET_DURUM NVARCHAR(100),\r\n            TEYIT_DURUM NVARCHAR(100),\r\n            TEYIT_ARAMA_DURUM NVARCHAR(100),\r\n            RANDEVU_TARIHI DATETIME2,\r\n            MEMO_SON_DURUM NVARCHAR(100),\r\n            MEMO_SON_CEVAP NVARCHAR(500),\r\n            MEMO_SON_ACIKLAMA NVARCHAR(1000),\r\n            eklenme_tarihi DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n            guncellenme_tarihi DATETIME2,\r\n            dosya_adi NVARCHAR(255)\r\n        );\r\n        \r\n        -- MEMO_ID unique constraint sadece NULL olmayan değerler için\r\n        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('iris_rapor') AND name = 'IX_iris_rapor_MEMO_ID_UNIQUE')\r\n        BEGIN\r\n            CREATE UNIQUE INDEX IX_iris_rapor_MEMO_ID_UNIQUE ON iris_rapor (MEMO_ID) WHERE MEMO_ID IS NOT NULL\r\n        END\r\n        \";\r\n        \r\n        try {\r\n            $this->connection->exec($sql);\r\n        } catch (PDOException $e) {\r\n            throw new Exception('Tablo oluşturma hatası: ' . $e->getMessage());\r\n        }\r\n    }\r\n\r\n    public function insertBatch($data) {\r\n        $successCount = 0;\r\n        $errorCount = 0;\r\n        $updateCount = 0;\r\n        $insertCount = 0;\r\n        $errors = [];\r\n        \r\n        try {\r\n            $this->connection->beginTransaction();\r\n            \r\n            // MEMO_ID kontrolü ve güncelleme/ekleme sorguları\r\n            $checkSql = \"SELECT id FROM iris_rapor WHERE MEMO_ID = ? AND MEMO_ID IS NOT NULL\";\r\n            $checkStmt = $this->connection->prepare($checkSql);\r\n            \r\n            $updateSql = \"UPDATE iris_rapor SET \r\n                TALEP_ID = ?, TALEP_TURU = ?, UYDU_BASVURU_POTANSIYEL_NO = ?, UYDU_BASVURU_UYE_NO = ?, DT_MUSTERI_NO = ?,\r\n                MEMO_KAYIT_TIPI = ?, MEMO_ID_TIP = ?, MEMO_KODU = ?, MEMO_KAPANIS_TARIHI = ?,\r\n                MEMO_YONLENEN_BAYI_KODU = ?, MEMO_YONLENEN_BAYI_ADI = ?, MEMO_YONLENEN_BAYI_YONETICISI = ?,\r\n                MEMO_YONLENEN_BAYI_BOLGE = ?, MEMO_YONLENEN_BAYI_TEKNIK_YNTC = ?, TALEP_GIRIS_TARIHI = ?,\r\n                TALEBI_GIREN_BAYI_KODU = ?, TALEBI_GIREN_BAYI_ADI = ?, TALEBI_GIREN_PERSONEL = ?,\r\n                TALEBI_GIREN_PERSONELNO = ?, TALEBI_GIREN_PERSONELKODU = ?, TALEBI_GIREN_PERSONEL_ALTBAYI = ?,\r\n                TALEP_KAYNAK = ?, SATIS_DURUMU = ?, INTERNET_SUREC_DURUMU = ?, AKTIVE_EDILEN_UYENO = ?,\r\n                AKTIVE_EDILEN_OUTLETNO = ?, AKTIVE_EDILEN_SOZLESMENO = ?, AKTIVE_EDILEN_SOZLESMEKMP = ?,\r\n                AKTIVE_EDILEN_SOZLESMEDURUM = ?, TALEP_TAKIP_NOTU = ?, GUNCEL_OUTLET_DURUM = ?,\r\n                TEYIT_DURUM = ?, TEYIT_ARAMA_DURUM = ?, RANDEVU_TARIHI = ?, MEMO_SON_DURUM = ?,\r\n                MEMO_SON_CEVAP = ?, MEMO_SON_ACIKLAMA = ?, dosya_adi = ?, guncellenme_tarihi = GETDATE()\r\n                WHERE MEMO_ID = ? AND MEMO_ID IS NOT NULL\";\r\n            $updateStmt = $this->connection->prepare($updateSql);\r\n            \r\n            $insertSql = \"INSERT INTO iris_rapor (\r\n                TALEP_ID, TALEP_TURU, UYDU_BASVURU_POTANSIYEL_NO, UYDU_BASVURU_UYE_NO, DT_MUSTERI_NO,\r\n                MEMO_ID, MEMO_KAYIT_TIPI, MEMO_ID_TIP, MEMO_KODU, MEMO_KAPANIS_TARIHI,\r\n                MEMO_YONLENEN_BAYI_KODU, MEMO_YONLENEN_BAYI_ADI, MEMO_YONLENEN_BAYI_YONETICISI,\r\n                MEMO_YONLENEN_BAYI_BOLGE, MEMO_YONLENEN_BAYI_TEKNIK_YNTC, TALEP_GIRIS_TARIHI,\r\n                TALEBI_GIREN_BAYI_KODU, TALEBI_GIREN_BAYI_ADI, TALEBI_GIREN_PERSONEL,\r\n                TALEBI_GIREN_PERSONELNO, TALEBI_GIREN_PERSONELKODU, TALEBI_GIREN_PERSONEL_ALTBAYI,\r\n                TALEP_KAYNAK, SATIS_DURUMU, INTERNET_SUREC_DURUMU, AKTIVE_EDILEN_UYENO,\r\n                AKTIVE_EDILEN_OUTLETNO, AKTIVE_EDILEN_SOZLESMENO, AKTIVE_EDILEN_SOZLESMEKMP,\r\n                AKTIVE_EDILEN_SOZLESMEDURUM, TALEP_TAKIP_NOTU, GUNCEL_OUTLET_DURUM,\r\n                TEYIT_DURUM, TEYIT_ARAMA_DURUM, RANDEVU_TARIHI, MEMO_SON_DURUM,\r\n                MEMO_SON_CEVAP, MEMO_SON_ACIKLAMA, dosya_adi\r\n            ) VALUES (\r\n                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, \r\n                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?\r\n            )\";\r\n            $insertStmt = $this->connection->prepare($insertSql);\r\n            \r\n            foreach ($data as $index => $row) {\r\n                try {\r\n                    $memoId = $row[5]; // MEMO_ID 6. sütun (0-indexed)\r\n                    \r\n                    // MEMO_ID boş ise null yap\r\n                    if (empty($memoId) || !is_numeric($memoId)) {\r\n                        $row[5] = null;\r\n                        $memoId = null;\r\n                    } else {\r\n                        $memoId = intval($memoId);\r\n                        $row[5] = $memoId;\r\n                    }\r\n                    \r\n                    // MEMO_ID null ise direkt insert et\r\n                    if ($memoId === null) {\r\n                        $insertStmt->execute($row);\r\n                        $insertCount++;\r\n                        $successCount++;\r\n                        continue;\r\n                    }\r\n                    \r\n                    // MEMO_ID var mı kontrol et\r\n                    $checkStmt->execute([$memoId]);\r\n                    $existing = $checkStmt->fetch();\r\n                    \r\n                    if ($existing) {\r\n                        // Güncelle - MEMO_ID'yi sona ekle\r\n                        $updateRow = array_slice($row, 0, 5); // İlk 5 alan\r\n                        $updateRow = array_merge($updateRow, array_slice($row, 6, 32)); // MEMO_ID'den sonraki alanlar\r\n                        $updateRow[] = $row[38]; // dosya_adi ekle\r\n                        $updateRow[] = $memoId; // MEMO_ID'yi WHERE koşulu için sona ekle\r\n                        \r\n                        $updateStmt->execute($updateRow);\r\n                        $updateCount++;\r\n                        $successCount++;\r\n                    } else {\r\n                        // Yeni kayıt ekle\r\n                        $insertStmt->execute($row);\r\n                        $insertCount++;\r\n                        $successCount++;\r\n                    }\r\n                    \r\n                } catch (PDOException $e) {\r\n                    $errorCount++;\r\n                    $errors[] = \"Satır \" . ($index + 2) . \" (MEMO_ID: \" . ($memoId ?? 'NULL') . \"): \" . $e->getMessage();\r\n                }\r\n            }\r\n            \r\n            $this->connection->commit();\r\n            \r\n            return [\r\n                'success' => true,\r\n                'successful' => $successCount,\r\n                'errors' => $errorCount,\r\n                'updated' => $updateCount,\r\n                'inserted' => $insertCount,\r\n                'error_details' => $errors\r\n            ];\r\n            \r\n        } catch (Exception $e) {\r\n            $this->connection->rollback();\r\n            throw $e;\r\n        }\r\n    }\r\n    \r\n    public function convertDateFormat($dateString) {\r\n        if (empty($dateString)) {\r\n            return null;\r\n        }\r\n        \r\n        // Farklı tarih formatlarını dene\r\n        $formats = [\r\n            'd.m.Y H:i:s',\r\n            'd.m.Y H:i',\r\n            'd.m.Y',\r\n            'd/m/Y H:i:s',\r\n            'd/m/Y H:i',\r\n            'd/m/Y',\r\n            'Y-m-d H:i:s',\r\n            'Y-m-d H:i',\r\n            'Y-m-d'\r\n        ];\r\n        \r\n        foreach ($formats as $format) {\r\n            $date = DateTime::createFromFormat($format, $dateString);\r\n            if ($date !== false) {\r\n                return $date->format('Y-m-d H:i:s');\r\n            }\r\n        }\r\n        \r\n        return null; // Hiçbir format uymazsa null döndür\r\n    }\r\n    \r\n    public function truncateTable() {\r\n        $sql = \"TRUNCATE TABLE iris_rapor\";\r\n        $this->connection->exec($sql);\r\n    }\r\n    \r\n    public function getRecordCount() {\r\n        $stmt = $this->connection->query(\"SELECT COUNT(*) as count FROM iris_rapor\");\r\n        $result = $stmt->fetch();\r\n        return $result['count'];\r\n    }\r\n    \r\n    public function __destruct() {\r\n        $this->connection = null;\r\n    }\r\n}\r\n?>\r\n"
        }
    ]
}
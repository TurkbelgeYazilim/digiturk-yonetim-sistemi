{
    "sourceFile": "primebaz_rapor_yukle_v2.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1759246380110,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1759246380110,
            "name": "Commit-0",
            "content": "<?php\r\nsession_start();\r\n\r\n// Kullanıcı giriş kontrolü\r\nif (!isset($_SESSION['user_id'])) {\r\n    header(\"Location: login.php\");\r\n    exit();\r\n}\r\n\r\n// Hata raporlamayı aç (geliştirme aşamasında)\r\nerror_reporting(E_ALL);\r\nini_set('display_errors', 1);\r\n\r\ninclude 'includes/header.php';\r\n\r\n/**\r\n * Primebaz Database Connection Class\r\n */\r\nclass PrimebazConnection {\r\n    private $connection;\r\n    private $config;\r\n    \r\n    public function __construct() {\r\n        $configFile = __DIR__ . '/config/mssql.php';\r\n        \r\n        if (!file_exists($configFile)) {\r\n            throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n        }\r\n        \r\n        $this->config = include $configFile;\r\n        $this->connect();\r\n    }\r\n    \r\n    private function connect() {\r\n        try {\r\n            $dsn = \"sqlsrv:Server={$this->config['host']};Database={$this->config['database']};TrustServerCertificate=yes\";\r\n            \r\n            $this->connection = new PDO($dsn, $this->config['username'], $this->config['password'], [\r\n                PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n                PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n                PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n                PDO::ATTR_EMULATE_PREPARES => false\r\n            ]);\r\n            \r\n        } catch (PDOException $e) {\r\n            throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n        }\r\n    }\r\n    \r\n    public function getConnection() {\r\n        return $this->connection;\r\n    }\r\n    \r\n    /**\r\n     * Primebaz rapor tablosunu oluştur (eğer yoksa)\r\n     */\r\n    public function createPrimebazTable() {\r\n        $sql = \"\r\n        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='primebaz_rapor' AND xtype='U')\r\n        CREATE TABLE primebaz_rapor (\r\n            id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n            bayi_kodu NVARCHAR(50),\r\n            bayi_adi NVARCHAR(200),\r\n            bolge NVARCHAR(100),\r\n            il NVARCHAR(50),\r\n            ilce NVARCHAR(100),\r\n            mahalle NVARCHAR(200),\r\n            alan_kodu NVARCHAR(50),\r\n            musteri_no NVARCHAR(50),\r\n            musteri_adi NVARCHAR(200),\r\n            musteri_soyadi NVARCHAR(200),\r\n            telefon NVARCHAR(20),\r\n            adres NVARCHAR(500),\r\n            urun_kodu NVARCHAR(50),\r\n            urun_adi NVARCHAR(200),\r\n            paket_kodu NVARCHAR(50),\r\n            paket_adi NVARCHAR(200),\r\n            baslangic_tarihi DATETIME2,\r\n            bitis_tarihi DATETIME2,\r\n            islem_tarihi DATETIME2,\r\n            islem_tipi NVARCHAR(50),\r\n            tutar DECIMAL(10,2),\r\n            komisyon_orani DECIMAL(5,2),\r\n            komisyon_tutari DECIMAL(10,2),\r\n            kdv_orani DECIMAL(5,2),\r\n            kdv_tutari DECIMAL(10,2),\r\n            toplam_tutar DECIMAL(10,2),\r\n            odeme_tarihi DATETIME2,\r\n            odeme_durumu NVARCHAR(50),\r\n            aciklama NVARCHAR(500),\r\n            ay INT,\r\n            yil INT,\r\n            donem NVARCHAR(20),\r\n            eklenme_tarihi DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n            guncellenme_tarihi DATETIME2,\r\n            dosya_adi NVARCHAR(255)\r\n        );\r\n        \";\r\n        \r\n        try {\r\n            $this->connection->exec($sql);\r\n        } catch (PDOException $e) {\r\n            throw new Exception('Primebaz tablosu oluşturma hatası: ' . $e->getMessage());\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Tablo kayıt sayısını al\r\n     */\r\n    public function getRecordCount() {\r\n        try {\r\n            $stmt = $this->connection->query(\"SELECT COUNT(*) as count FROM primebaz_rapor\");\r\n            $result = $stmt->fetch();\r\n            return $result['count'];\r\n        } catch (Exception $e) {\r\n            return 0;\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Dönem bazında kayıt sayısını al\r\n     */\r\n    public function getRecordCountByDonem() {\r\n        try {\r\n            $sql = \"SELECT donem, COUNT(*) as count FROM primebaz_rapor GROUP BY donem ORDER BY yil DESC, ay DESC\";\r\n            $stmt = $this->connection->query($sql);\r\n            return $stmt->fetchAll();\r\n        } catch (Exception $e) {\r\n            return [];\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Tabloyu temizle\r\n     */\r\n    public function truncateTable() {\r\n        $sql = \"TRUNCATE TABLE primebaz_rapor\";\r\n        $this->connection->exec($sql);\r\n    }\r\n    \r\n    /**\r\n     * Test verisi ekle\r\n     */\r\n    public function insertTestData() {\r\n        $testData = [\r\n            ['BAY001', 'Test Bayi 1', 'İstanbul', 'İstanbul', 'Kadıköy', 'Acıbadem', 'ALAN001', 'MUS001', 'Test', 'Müşteri', '05551234567', 'Test Adres', 'URN001', 'Test Ürün', 'PAK001', 'Test Paket', '2024-01-01', '2024-12-31', '2024-06-15', 'YENİ', 100.00, 5.5, 5.50, 18, 18.00, 123.50, '2024-06-20', 'ÖDENDİ', 'Test açıklama', 6, 2024, 'HAZİRAN\\'24', 'TEST.xlsx'],\r\n            ['BAY002', 'Test Bayi 2', 'Ankara', 'Ankara', 'Çankaya', 'Kızılay', 'ALAN002', 'MUS002', 'Test2', 'Müşteri2', '05559876543', 'Test Adres 2', 'URN002', 'Test Ürün 2', 'PAK002', 'Test Paket 2', '2024-02-01', '2024-12-31', '2024-07-15', 'YENİ', 200.00, 6.0, 12.00, 18, 36.00, 248.00, '2024-07-20', 'ÖDENDİ', 'Test açıklama 2', 7, 2024, 'TEMMUZ\\'24', 'TEST.xlsx']\r\n        ];\r\n        \r\n        $sql = \"INSERT INTO primebaz_rapor (\r\n            bayi_kodu, bayi_adi, bolge, il, ilce, mahalle, alan_kodu,\r\n            musteri_no, musteri_adi, musteri_soyadi, telefon, adres,\r\n            urun_kodu, urun_adi, paket_kodu, paket_adi,\r\n            baslangic_tarihi, bitis_tarihi, islem_tarihi, islem_tipi,\r\n            tutar, komisyon_orani, komisyon_tutari, kdv_orani, kdv_tutari, toplam_tutar,\r\n            odeme_tarihi, odeme_durumu, aciklama,\r\n            ay, yil, donem, dosya_adi\r\n        ) VALUES (\r\n            ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,\r\n            ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,\r\n            ?, ?, ?, ?\r\n        )\";\r\n        \r\n        $stmt = $this->connection->prepare($sql);\r\n        \r\n        foreach ($testData as $row) {\r\n            $stmt->execute($row);\r\n        }\r\n        \r\n        return count($testData);\r\n    }\r\n    \r\n    public function __destruct() {\r\n        $this->connection = null;\r\n    }\r\n}\r\n\r\n// İşlem kontrolü\r\n$message = '';\r\n$messageType = '';\r\n\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    try {\r\n        $db = new PrimebazConnection();\r\n        \r\n        if (isset($_POST['create_table'])) {\r\n            $db->createPrimebazTable();\r\n            $message = 'Primebaz tablosu başarıyla oluşturuldu!';\r\n            $messageType = 'success';\r\n        }\r\n        \r\n        if (isset($_POST['add_test_data'])) {\r\n            $db->createPrimebazTable(); // Tablo varsa hiçbir şey yapmaz\r\n            $count = $db->insertTestData();\r\n            $message = $count . ' adet test verisi başarıyla eklendi!';\r\n            $messageType = 'success';\r\n        }\r\n        \r\n        if (isset($_POST['truncate_table'])) {\r\n            $db->truncateTable();\r\n            $message = 'Primebaz tablosu başarıyla temizlendi!';\r\n            $messageType = 'success';\r\n        }\r\n        \r\n    } catch (Exception $e) {\r\n        $message = 'Hata: ' . $e->getMessage();\r\n        $messageType = 'danger';\r\n    }\r\n}\r\n\r\n// Mevcut dosyaları listele\r\n$uploadDir = __DIR__ . '/uploads/primebaz/';\r\n$files = [];\r\nif (is_dir($uploadDir)) {\r\n    $fileList = scandir($uploadDir);\r\n    foreach ($fileList as $file) {\r\n        if ($file != '.' && $file != '..' && (stripos($file, '.xlsx') !== false || stripos($file, '.xls') !== false)) {\r\n            if (strpos($file, '~$') !== 0) { // Geçici dosyaları atla\r\n                $filePath = $uploadDir . $file;\r\n                $files[] = [\r\n                    'name' => $file,\r\n                    'size' => filesize($filePath),\r\n                    'date' => date('d.m.Y H:i:s', filemtime($filePath))\r\n                ];\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// Mevcut kayıt sayısını al\r\ntry {\r\n    $db = new PrimebazConnection();\r\n    $recordCount = $db->getRecordCount();\r\n    $donemStats = $db->getRecordCountByDonem();\r\n} catch (Exception $e) {\r\n    $recordCount = 0;\r\n    $donemStats = [];\r\n}\r\n?>\r\n\r\n<div class=\"container-fluid\">\r\n    <div class=\"row\">\r\n        <div class=\"col-12\">\r\n            <h1 class=\"h3 mb-4 text-gray-800\">Primebaz Rapor Yükleme (Test Sürümü)</h1>\r\n            \r\n            <?php if ($message): ?>\r\n                <div class=\"alert alert-<?php echo $messageType; ?> alert-dismissible fade show\" role=\"alert\">\r\n                    <?php echo htmlspecialchars($message); ?>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n                </div>\r\n            <?php endif; ?>\r\n            \r\n            <!-- İstatistikler -->\r\n            <div class=\"row mb-4\">\r\n                <div class=\"col-xl-3 col-md-6 mb-4\">\r\n                    <div class=\"card border-start border-primary border-4 shadow h-100 py-2\">\r\n                        <div class=\"card-body\">\r\n                            <div class=\"row no-gutters align-items-center\">\r\n                                <div class=\"col me-2\">\r\n                                    <div class=\"text-xs fw-bold text-primary text-uppercase mb-1\">\r\n                                        Toplam Kayıt</div>\r\n                                    <div class=\"h5 mb-0 fw-bold text-gray-800\"><?php echo number_format($recordCount); ?></div>\r\n                                </div>\r\n                                <div class=\"col-auto\">\r\n                                    <i class=\"fas fa-database fa-2x text-gray-300\"></i>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div class=\"col-xl-3 col-md-6 mb-4\">\r\n                    <div class=\"card border-start border-success border-4 shadow h-100 py-2\">\r\n                        <div class=\"card-body\">\r\n                            <div class=\"row no-gutters align-items-center\">\r\n                                <div class=\"col me-2\">\r\n                                    <div class=\"text-xs fw-bold text-success text-uppercase mb-1\">\r\n                                        Excel Dosyası</div>\r\n                                    <div class=\"h5 mb-0 fw-bold text-gray-800\"><?php echo count($files); ?></div>\r\n                                </div>\r\n                                <div class=\"col-auto\">\r\n                                    <i class=\"fas fa-file-excel fa-2x text-gray-300\"></i>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div class=\"col-xl-3 col-md-6 mb-4\">\r\n                    <div class=\"card border-start border-info border-4 shadow h-100 py-2\">\r\n                        <div class=\"card-body\">\r\n                            <div class=\"row no-gutters align-items-center\">\r\n                                <div class=\"col me-2\">\r\n                                    <div class=\"text-xs fw-bold text-info text-uppercase mb-1\">\r\n                                        Dönem Sayısı</div>\r\n                                    <div class=\"h5 mb-0 fw-bold text-gray-800\"><?php echo count($donemStats); ?></div>\r\n                                </div>\r\n                                <div class=\"col-auto\">\r\n                                    <i class=\"fas fa-calendar fa-2x text-gray-300\"></i>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div class=\"col-xl-3 col-md-6 mb-4\">\r\n                    <div class=\"card border-start border-warning border-4 shadow h-100 py-2\">\r\n                        <div class=\"card-body\">\r\n                            <div class=\"row no-gutters align-items-center\">\r\n                                <div class=\"col me-2\">\r\n                                    <div class=\"text-xs fw-bold text-warning text-uppercase mb-1\">\r\n                                        Dosya Boyutu</div>\r\n                                    <div class=\"h5 mb-0 fw-bold text-gray-800\">\r\n                                        <?php \r\n                                        $totalSize = array_sum(array_column($files, 'size'));\r\n                                        echo number_format($totalSize / 1024 / 1024, 1) . ' MB';\r\n                                        ?>\r\n                                    </div>\r\n                                </div>\r\n                                <div class=\"col-auto\">\r\n                                    <i class=\"fas fa-hdd fa-2x text-gray-300\"></i>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            \r\n            <!-- İşlem Butonları -->\r\n            <div class=\"card shadow mb-4\">\r\n                <div class=\"card-header py-3\">\r\n                    <h6 class=\"m-0 fw-bold text-primary\">İşlemler</h6>\r\n                </div>\r\n                <div class=\"card-body\">\r\n                    <form method=\"post\" class=\"d-inline\">\r\n                        <button type=\"submit\" name=\"create_table\" class=\"btn btn-primary btn-sm\">\r\n                            <i class=\"fas fa-plus\"></i> Tablo Oluştur\r\n                        </button>\r\n                    </form>\r\n                    \r\n                    <form method=\"post\" class=\"d-inline ms-2\">\r\n                        <button type=\"submit\" name=\"add_test_data\" class=\"btn btn-success btn-sm\">\r\n                            <i class=\"fas fa-plus-circle\"></i> Test Verisi Ekle\r\n                        </button>\r\n                    </form>\r\n                    \r\n                    <form method=\"post\" class=\"d-inline ms-2\">\r\n                        <button type=\"submit\" name=\"truncate_table\" class=\"btn btn-danger btn-sm\" \r\n                                onclick=\"return confirm('Tüm veriler silinecek! Emin misiniz?')\">\r\n                            <i class=\"fas fa-trash\"></i> Tabloyu Temizle\r\n                        </button>\r\n                    </form>\r\n                </div>\r\n            </div>\r\n            \r\n            <!-- Dönem İstatistikleri -->\r\n            <?php if (!empty($donemStats)): ?>\r\n                <div class=\"card shadow mb-4\">\r\n                    <div class=\"card-header py-3\">\r\n                        <h6 class=\"m-0 fw-bold text-primary\">Dönem İstatistikleri</h6>\r\n                    </div>\r\n                    <div class=\"card-body\">\r\n                        <div class=\"table-responsive\">\r\n                            <table class=\"table table-bordered\">\r\n                                <thead>\r\n                                    <tr>\r\n                                        <th>Dönem</th>\r\n                                        <th>Kayıt Sayısı</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    <?php foreach ($donemStats as $stat): ?>\r\n                                        <tr>\r\n                                            <td><?php echo htmlspecialchars($stat['donem'] ?? 'Belirtilmemiş'); ?></td>\r\n                                            <td><?php echo number_format($stat['count']); ?></td>\r\n                                        </tr>\r\n                                    <?php endforeach; ?>\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            <?php endif; ?>\r\n            \r\n            <!-- Dosya Listesi -->\r\n            <div class=\"card shadow mb-4\">\r\n                <div class=\"card-header py-3\">\r\n                    <h6 class=\"m-0 fw-bold text-primary\">Primebaz Klasörü - Excel Dosyaları</h6>\r\n                </div>\r\n                <div class=\"card-body\">\r\n                    <?php if (empty($files)): ?>\r\n                        <div class=\"alert alert-info\">\r\n                            Primebaz klasöründe Excel dosyası bulunamadı.\r\n                            <br><small class=\"text-muted\">Aranılan klasör: <?php echo htmlspecialchars($uploadDir); ?></small>\r\n                        </div>\r\n                    <?php else: ?>\r\n                        <div class=\"table-responsive\">\r\n                            <table class=\"table table-bordered\">\r\n                                <thead>\r\n                                    <tr>\r\n                                        <th>Dosya Adı</th>\r\n                                        <th>Boyut</th>\r\n                                        <th>Değiştirilme Tarihi</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    <?php foreach ($files as $file): ?>\r\n                                        <tr>\r\n                                            <td><?php echo htmlspecialchars($file['name']); ?></td>\r\n                                            <td><?php echo number_format($file['size'] / 1024, 1); ?> KB</td>\r\n                                            <td><?php echo $file['date']; ?></td>\r\n                                        </tr>\r\n                                    <?php endforeach; ?>\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    <?php endif; ?>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<?php include 'includes/footer.php'; ?>"
        }
    ]
}
{
    "sourceFile": "bayi_hakedis_odeme.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1759329191748,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1759329235447,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,10 +18,8 @@\n     header('Location: index.php?error=Yetkisiz erişim');\r\n     exit;\r\n }\r\n \r\n-require_once 'MSSQLConnection.php';\r\n-\r\n $message = '';\r\n $messageType = '';\r\n $errors = [];\r\n \r\n@@ -30,11 +28,37 @@\n if (!is_dir($uploadDir)) {\r\n     mkdir($uploadDir, 0755, true);\r\n }\r\n \r\n+// Veritabanı bağlantı fonksiyonu\r\n+function getDatabaseConnection() {\r\n+    $configFile = __DIR__ . '/config/mssql.php';\r\n+    \r\n+    if (!file_exists($configFile)) {\r\n+        throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n+    }\r\n+    \r\n+    $config = include $configFile;\r\n+    \r\n+    try {\r\n+        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n+        \r\n+        $connection = new PDO($dsn, $config['username'], $config['password'], [\r\n+            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n+            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n+            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n+            PDO::ATTR_EMULATE_PREPARES => false\r\n+        ]);\r\n+        \r\n+        return $connection;\r\n+        \r\n+    } catch (PDOException $e) {\r\n+        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n+    }\r\n+}\r\n+\r\n try {\r\n-    $db = new MSSQLConnection();\r\n-    $conn = $db->getConnection();\r\n+    $conn = getDatabaseConnection();\r\n     \r\n     // Tablo oluştur (eğer yoksa)\r\n     createHakedisOdemeTable($conn);\r\n     \r\n"
                },
                {
                    "date": 1759385814939,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -28,34 +28,9 @@\n if (!is_dir($uploadDir)) {\r\n     mkdir($uploadDir, 0755, true);\r\n }\r\n \r\n-// Veritabanı bağlantı fonksiyonu\r\n-function getDatabaseConnection() {\r\n-    $configFile = __DIR__ . '/config/mssql.php';\r\n-    \r\n-    if (!file_exists($configFile)) {\r\n-        throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n-    }\r\n-    \r\n-    $config = include $configFile;\r\n-    \r\n-    try {\r\n-        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n-        \r\n-        $connection = new PDO($dsn, $config['username'], $config['password'], [\r\n-            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n-            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n-            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n-            PDO::ATTR_EMULATE_PREPARES => false\r\n-        ]);\r\n-        \r\n-        return $connection;\r\n-        \r\n-    } catch (PDOException $e) {\r\n-        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n-    }\r\n-}\r\n+// Veritabanı bağlantı fonksiyonu auth.php dosyasından kullanılıyor\r\n \r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n"
                },
                {
                    "date": 1760623863025,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,13 +12,10 @@\n require_once 'auth.php';\r\n $currentUser = checkAuth();\r\n checkUserStatus();\r\n \r\n-// Admin kontrolü\r\n-if ($currentUser['group_name'] !== 'admin') {\r\n-    header('Location: index.php?error=Yetkisiz erişim');\r\n-    exit;\r\n-}\r\n+// Yetki kontrolü geçici olarak kaldırıldı\r\n+// Herhangi bir login olmuş kullanıcı erişebilir\r\n \r\n $message = '';\r\n $messageType = '';\r\n $errors = [];\r\n"
                }
            ],
            "date": 1759329191748,
            "name": "Commit-0",
            "content": "<?php\r\nerror_reporting(E_ALL);\r\nini_set('display_errors', 1);\r\n\r\n$pageTitle = \"Bayi Hakediş Ödeme Yönetimi\";\r\n$breadcrumbs = [\r\n    ['title' => 'Ana Sayfa', 'url' => 'index.php'],\r\n    ['title' => 'Bayi Hakediş Ödeme Yönetimi']\r\n];\r\n\r\n// Auth kontrol\r\nrequire_once 'auth.php';\r\n$currentUser = checkAuth();\r\ncheckUserStatus();\r\n\r\n// Admin kontrolü\r\nif ($currentUser['group_name'] !== 'admin') {\r\n    header('Location: index.php?error=Yetkisiz erişim');\r\n    exit;\r\n}\r\n\r\nrequire_once 'MSSQLConnection.php';\r\n\r\n$message = '';\r\n$messageType = '';\r\n$errors = [];\r\n\r\n// Upload klasörü kontrolü ve oluşturma\r\n$uploadDir = 'uploads/hakedis_odeme/';\r\nif (!is_dir($uploadDir)) {\r\n    mkdir($uploadDir, 0755, true);\r\n}\r\n\r\ntry {\r\n    $db = new MSSQLConnection();\r\n    $conn = $db->getConnection();\r\n    \r\n    // Tablo oluştur (eğer yoksa)\r\n    createHakedisOdemeTable($conn);\r\n    \r\n    // AJAX isteği kontrolü\r\n    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {\r\n        header('Content-Type: application/json');\r\n        \r\n        try {\r\n            $action = $_POST['action'];\r\n            \r\n            if ($action === 'get_payments') {\r\n                // Ödemeleri getir\r\n                $user_id = $_POST['user_id'] ?? '';\r\n                $odeme_turu_id = $_POST['odeme_turu_id'] ?? '';\r\n                $baslangic_tarih = $_POST['baslangic_tarih'] ?? '';\r\n                $bitis_tarih = $_POST['bitis_tarih'] ?? '';\r\n                \r\n                $where_conditions = [];\r\n                $params = [];\r\n                \r\n                if (!empty($user_id)) {\r\n                    $where_conditions[] = \"bho.user_id = ?\";\r\n                    $params[] = $user_id;\r\n                }\r\n                \r\n                if (!empty($odeme_turu_id)) {\r\n                    $where_conditions[] = \"bho.odeme_turu_id = ?\";\r\n                    $params[] = $odeme_turu_id;\r\n                }\r\n                \r\n                if (!empty($baslangic_tarih)) {\r\n                    $where_conditions[] = \"CAST(bho.odeme_tarihi AS DATE) >= ?\";\r\n                    $params[] = $baslangic_tarih;\r\n                }\r\n                \r\n                if (!empty($bitis_tarih)) {\r\n                    $where_conditions[] = \"CAST(bho.odeme_tarihi AS DATE) <= ?\";\r\n                    $params[] = $bitis_tarih;\r\n                }\r\n                \r\n                $where_sql = empty($where_conditions) ? \"\" : \"WHERE \" . implode(\" AND \", $where_conditions);\r\n                \r\n                $sql = \"SELECT bho.id, bho.user_id, bho.odeme_turu_id, bho.odeme_tutari, bho.odeme_tarihi, \r\n                               bho.aciklama, bho.evrak_dosya_adi, bho.evrak_dosya_yolu, bho.created_at,\r\n                               u.first_name + ' ' + u.last_name as user_name, u.email as user_email,\r\n                               ot.tur_adi as odeme_turu_adi, ot.aciklama as odeme_turu_aciklama,\r\n                               cb.first_name + ' ' + cb.last_name as created_by_name\r\n                        FROM bayi_hakedis_odeme bho\r\n                        INNER JOIN users u ON bho.user_id = u.id\r\n                        INNER JOIN odeme_turleri ot ON bho.odeme_turu_id = ot.id\r\n                        LEFT JOIN users cb ON bho.created_by = cb.id\r\n                        {$where_sql}\r\n                        ORDER BY bho.created_at DESC\";\r\n                \r\n                $stmt = $conn->prepare($sql);\r\n                $stmt->execute($params);\r\n                $payments = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n                \r\n                echo json_encode([\r\n                    'success' => true,\r\n                    'data' => $payments\r\n                ]);\r\n                exit;\r\n            }\r\n            \r\n            if ($action === 'delete') {\r\n                $id = $_POST['id'] ?? 0;\r\n                \r\n                // Önce dosya bilgisini al\r\n                $fileSql = \"SELECT evrak_dosya_yolu FROM bayi_hakedis_odeme WHERE id = ?\";\r\n                $fileStmt = $conn->prepare($fileSql);\r\n                $fileStmt->execute([$id]);\r\n                $fileInfo = $fileStmt->fetch();\r\n                \r\n                // Kaydı sil\r\n                $deleteSql = \"DELETE FROM bayi_hakedis_odeme WHERE id = ?\";\r\n                $deleteStmt = $conn->prepare($deleteSql);\r\n                $deleteStmt->execute([$id]);\r\n                \r\n                // Dosyayı sil (eğer varsa)\r\n                if ($fileInfo && $fileInfo['evrak_dosya_yolu'] && file_exists($fileInfo['evrak_dosya_yolu'])) {\r\n                    unlink($fileInfo['evrak_dosya_yolu']);\r\n                }\r\n                \r\n                echo json_encode(['success' => true, 'message' => 'Ödeme kaydı başarıyla silindi.']);\r\n                exit;\r\n            }\r\n            \r\n            if ($action === 'get_payment_details') {\r\n                $id = $_POST['id'] ?? 0;\r\n                \r\n                $sql = \"SELECT bho.*, u.first_name + ' ' + u.last_name as user_name\r\n                        FROM bayi_hakedis_odeme bho\r\n                        INNER JOIN users u ON bho.user_id = u.id\r\n                        WHERE bho.id = ?\";\r\n                $stmt = $conn->prepare($sql);\r\n                $stmt->execute([$id]);\r\n                $payment = $stmt->fetch(PDO::FETCH_ASSOC);\r\n                \r\n                if ($payment) {\r\n                    // Tarih formatını JavaScript için uygun hale getir\r\n                    $payment['odeme_tarihi_formatted'] = date('Y-m-d\\TH:i', strtotime($payment['odeme_tarihi']));\r\n                    echo json_encode(['success' => true, 'data' => $payment]);\r\n                } else {\r\n                    echo json_encode(['success' => false, 'message' => 'Ödeme kaydı bulunamadı.']);\r\n                }\r\n                exit;\r\n            }\r\n            \r\n        } catch (Exception $e) {\r\n            echo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);\r\n            exit;\r\n        }\r\n    }\r\n    \r\n    // Form gönderimi\r\n    if ($_SERVER['REQUEST_METHOD'] === 'POST' && !isset($_POST['action'])) {\r\n        try {\r\n            $formAction = $_POST['form_action'] ?? '';\r\n            \r\n            if ($formAction === 'add' || $formAction === 'edit') {\r\n                $id = $_POST['id'] ?? 0;\r\n                $user_id = (int)$_POST['user_id'];\r\n                $odeme_turu_id = (int)$_POST['odeme_turu_id'];\r\n                $odeme_tutari = (float)$_POST['odeme_tutari'];\r\n                \r\n                // Tarih formatını SQL Server için dönüştür\r\n                $odeme_tarihi_raw = $_POST['odeme_tarihi'];\r\n                $odeme_tarihi = date('Y-m-d H:i:s', strtotime($odeme_tarihi_raw));\r\n                \r\n                $aciklama = trim($_POST['aciklama']);\r\n                \r\n                // Dosya yükleme kontrolü\r\n                $evrak_dosya_adi = null;\r\n                $evrak_dosya_yolu = null;\r\n                $evrak_dosya_boyutu = null;\r\n                \r\n                if (isset($_FILES['evrak_dosya']) && $_FILES['evrak_dosya']['error'] === UPLOAD_ERR_OK) {\r\n                    $file = $_FILES['evrak_dosya'];\r\n                    $allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];\r\n                    $maxSize = 5 * 1024 * 1024; // 5MB\r\n                    \r\n                    if (!in_array($file['type'], $allowedTypes)) {\r\n                        throw new Exception('Sadece JPEG, PNG, GIF ve PDF dosyaları yüklenebilir.');\r\n                    }\r\n                    \r\n                    if ($file['size'] > $maxSize) {\r\n                        throw new Exception('Dosya boyutu 5MB\\'dan büyük olamaz.');\r\n                    }\r\n                    \r\n                    // Dosya adını güvenli hale getir\r\n                    $fileExtension = pathinfo($file['name'], PATHINFO_EXTENSION);\r\n                    $safeFileName = 'hakedis_odeme_' . $user_id . '_' . date('Y_m_d_H_i_s') . '_' . uniqid() . '.' . $fileExtension;\r\n                    $uploadPath = $uploadDir . $safeFileName;\r\n                    \r\n                    if (move_uploaded_file($file['tmp_name'], $uploadPath)) {\r\n                        $evrak_dosya_adi = $file['name'];\r\n                        $evrak_dosya_yolu = $uploadPath;\r\n                        $evrak_dosya_boyutu = $file['size'];\r\n                    } else {\r\n                        throw new Exception('Dosya yükleme başarısız.');\r\n                    }\r\n                }\r\n                \r\n                if ($formAction === 'add') {\r\n                    $sql = \"INSERT INTO bayi_hakedis_odeme \r\n                            (user_id, odeme_turu_id, odeme_tutari, odeme_tarihi, aciklama, \r\n                             evrak_dosya_adi, evrak_dosya_yolu, evrak_dosya_boyutu, created_by) \r\n                            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\";\r\n                    $stmt = $conn->prepare($sql);\r\n                    $stmt->execute([\r\n                        $user_id, $odeme_turu_id, $odeme_tutari, $odeme_tarihi, $aciklama,\r\n                        $evrak_dosya_adi, $evrak_dosya_yolu, $evrak_dosya_boyutu, $currentUser['id']\r\n                    ]);\r\n                    \r\n                    $message = 'Hakediş ödeme kaydı başarıyla eklendi.';\r\n                    $messageType = 'success';\r\n                    \r\n                } else { // edit\r\n                    if ($evrak_dosya_adi) {\r\n                        // Eski dosyayı sil\r\n                        $oldFileSql = \"SELECT evrak_dosya_yolu FROM bayi_hakedis_odeme WHERE id = ?\";\r\n                        $oldFileStmt = $conn->prepare($oldFileSql);\r\n                        $oldFileStmt->execute([$id]);\r\n                        $oldFile = $oldFileStmt->fetch();\r\n                        if ($oldFile && $oldFile['evrak_dosya_yolu'] && file_exists($oldFile['evrak_dosya_yolu'])) {\r\n                            unlink($oldFile['evrak_dosya_yolu']);\r\n                        }\r\n                        \r\n                        $sql = \"UPDATE bayi_hakedis_odeme SET \r\n                                user_id = ?, odeme_turu_id = ?, odeme_tutari = ?, odeme_tarihi = ?, \r\n                                aciklama = ?, evrak_dosya_adi = ?, evrak_dosya_yolu = ?, \r\n                                evrak_dosya_boyutu = ?, updated_at = GETDATE(), updated_by = ?\r\n                                WHERE id = ?\";\r\n                        $stmt = $conn->prepare($sql);\r\n                        $stmt->execute([\r\n                            $user_id, $odeme_turu_id, $odeme_tutari, $odeme_tarihi, $aciklama,\r\n                            $evrak_dosya_adi, $evrak_dosya_yolu, $evrak_dosya_boyutu, $currentUser['id'], $id\r\n                        ]);\r\n                    } else {\r\n                        $sql = \"UPDATE bayi_hakedis_odeme SET \r\n                                user_id = ?, odeme_turu_id = ?, odeme_tutari = ?, odeme_tarihi = ?, \r\n                                aciklama = ?, updated_at = GETDATE(), updated_by = ?\r\n                                WHERE id = ?\";\r\n                        $stmt = $conn->prepare($sql);\r\n                        $stmt->execute([\r\n                            $user_id, $odeme_turu_id, $odeme_tutari, $odeme_tarihi, $aciklama, $currentUser['id'], $id\r\n                        ]);\r\n                    }\r\n                    \r\n                    $message = 'Hakediş ödeme kaydı başarıyla güncellendi.';\r\n                    $messageType = 'success';\r\n                }\r\n            }\r\n            \r\n        } catch (Exception $e) {\r\n            $message = 'Hata: ' . $e->getMessage();\r\n            $messageType = 'danger';\r\n            error_log(\"Hakediş ödeme hatası: \" . $e->getMessage());\r\n        }\r\n    }\r\n    \r\n    // Kullanıcıları al (sadece aktif bayiler)\r\n    $usersSql = \"SELECT u.id, u.first_name, u.last_name, u.email \r\n                 FROM users u \r\n                 INNER JOIN user_groups ug ON u.user_group_id = ug.id\r\n                 WHERE u.status = 'AKTIF' AND ug.group_name = 'bayi'\r\n                 ORDER BY u.first_name, u.last_name\";\r\n    $usersStmt = $conn->prepare($usersSql);\r\n    $usersStmt->execute();\r\n    $users = $usersStmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    // Ödeme türlerini al\r\n    $odemeturleriSql = \"SELECT * FROM odeme_turleri WHERE aktif = 1 ORDER BY tur_adi\";\r\n    $odemeturleriStmt = $conn->prepare($odemeturleriSql);\r\n    $odemeturleriStmt->execute();\r\n    $odeme_turleri = $odemeturleriStmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n} catch (Exception $e) {\r\n    $message = 'Veritabanı bağlantı hatası: ' . $e->getMessage();\r\n    $messageType = 'danger';\r\n    error_log(\"Hakediş ödeme DB hatası: \" . $e->getMessage());\r\n}\r\n\r\n// Tablo oluşturma fonksiyonu\r\nfunction createHakedisOdemeTable($conn) {\r\n    $sql = \"\r\n    IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='bayi_hakedis_odeme' AND xtype='U')\r\n    BEGIN\r\n        CREATE TABLE bayi_hakedis_odeme (\r\n            id INT IDENTITY(1,1) PRIMARY KEY,\r\n            user_id INT NOT NULL,\r\n            odeme_turu_id INT NOT NULL,\r\n            odeme_tutari DECIMAL(15,2) NOT NULL,\r\n            odeme_tarihi DATETIME2 NOT NULL,\r\n            aciklama NVARCHAR(500) NULL,\r\n            evrak_dosya_adi NVARCHAR(255) NULL,\r\n            evrak_dosya_yolu NVARCHAR(500) NULL,\r\n            evrak_dosya_boyutu INT NULL,\r\n            created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n            updated_at DATETIME2 NULL,\r\n            created_by INT NULL,\r\n            updated_by INT NULL,\r\n            \r\n            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\r\n            FOREIGN KEY (odeme_turu_id) REFERENCES odeme_turleri(id),\r\n            FOREIGN KEY (created_by) REFERENCES users(id),\r\n            FOREIGN KEY (updated_by) REFERENCES users(id)\r\n        );\r\n        \r\n        CREATE INDEX IX_bayi_hakedis_odeme_user_id ON bayi_hakedis_odeme (user_id);\r\n        CREATE INDEX IX_bayi_hakedis_odeme_odeme_turu_id ON bayi_hakedis_odeme (odeme_turu_id);\r\n        CREATE INDEX IX_bayi_hakedis_odeme_odeme_tarihi ON bayi_hakedis_odeme (odeme_tarihi);\r\n        CREATE INDEX IX_bayi_hakedis_odeme_created_at ON bayi_hakedis_odeme (created_at);\r\n    END\r\n    \";\r\n    \r\n    try {\r\n        $conn->exec($sql);\r\n    } catch (PDOException $e) {\r\n        // Tablo zaten mevcut olabilir, hata verme\r\n        error_log(\"Tablo oluşturma uyarısı: \" . $e->getMessage());\r\n    }\r\n}\r\n\r\ninclude 'includes/header.php';\r\n?>\r\n\r\n<div class=\"container-fluid mt-4\">\r\n    <div class=\"row\">\r\n        <div class=\"col-12\">\r\n            <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n                <h2><i class=\"fas fa-money-bill-wave me-2\"></i>Bayi Hakediş Ödeme Yönetimi</h2>\r\n                <button class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#addPaymentModal\">\r\n                    <i class=\"fas fa-plus me-1\"></i>Yeni Ödeme Kaydı\r\n                </button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <?php if ($message): ?>\r\n        <div class=\"alert alert-<?php echo $messageType; ?> alert-dismissible fade show\" role=\"alert\">\r\n            <i class=\"fas fa-<?php echo $messageType === 'success' ? 'check-circle' : 'exclamation-triangle'; ?> me-2\"></i>\r\n            <?php echo htmlspecialchars($message); ?>\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n        </div>\r\n    <?php endif; ?>\r\n\r\n    <!-- Filtreler -->\r\n    <div class=\"card border-0 shadow-sm mb-4\">\r\n        <div class=\"card-header bg-light\">\r\n            <h5 class=\"mb-0\">\r\n                <i class=\"fas fa-filter me-2\"></i>Filtreler\r\n            </h5>\r\n        </div>\r\n        <div class=\"card-body\">\r\n            <div class=\"row g-3\">\r\n                <div class=\"col-md-3\">\r\n                    <label for=\"filter_user\" class=\"form-label\">Bayi</label>\r\n                    <select class=\"form-select\" id=\"filter_user\">\r\n                        <option value=\"\">Tüm Bayiler</option>\r\n                        <?php foreach ($users as $user): ?>\r\n                            <option value=\"<?php echo $user['id']; ?>\">\r\n                                <?php echo htmlspecialchars($user['first_name'] . ' ' . $user['last_name']); ?>\r\n                            </option>\r\n                        <?php endforeach; ?>\r\n                    </select>\r\n                </div>\r\n                <div class=\"col-md-3\">\r\n                    <label for=\"filter_odeme_turu\" class=\"form-label\">Ödeme Türü</label>\r\n                    <select class=\"form-select\" id=\"filter_odeme_turu\">\r\n                        <option value=\"\">Tüm Türler</option>\r\n                        <?php foreach ($odeme_turleri as $tur): ?>\r\n                            <option value=\"<?php echo $tur['id']; ?>\">\r\n                                <?php echo htmlspecialchars($tur['tur_adi']); ?>\r\n                            </option>\r\n                        <?php endforeach; ?>\r\n                    </select>\r\n                </div>\r\n                <div class=\"col-md-2\">\r\n                    <label for=\"filter_baslangic\" class=\"form-label\">Başlangıç Tarihi</label>\r\n                    <input type=\"date\" class=\"form-control\" id=\"filter_baslangic\">\r\n                </div>\r\n                <div class=\"col-md-2\">\r\n                    <label for=\"filter_bitis\" class=\"form-label\">Bitiş Tarihi</label>\r\n                    <input type=\"date\" class=\"form-control\" id=\"filter_bitis\">\r\n                </div>\r\n                <div class=\"col-md-2 d-flex align-items-end\">\r\n                    <button type=\"button\" class=\"btn btn-primary me-2\" onclick=\"loadPayments()\">\r\n                        <i class=\"fas fa-search\"></i> Filtrele\r\n                    </button>\r\n                    <button type=\"button\" class=\"btn btn-secondary\" onclick=\"clearFilters()\">\r\n                        <i class=\"fas fa-times\"></i>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Ödeme Kayıtları Tablosu -->\r\n    <div class=\"card border-0 shadow-sm\">\r\n        <div class=\"card-header bg-primary text-white\">\r\n            <h5 class=\"mb-0\">\r\n                <i class=\"fas fa-list me-2\"></i>Ödeme Kayıtları\r\n            </h5>\r\n        </div>\r\n        <div class=\"card-body p-0\">\r\n            <div class=\"table-responsive\">\r\n                <table class=\"table table-hover mb-0\" id=\"paymentsTable\">\r\n                    <thead class=\"table-light\">\r\n                        <tr>\r\n                            <th>ID</th>\r\n                            <th>Bayi</th>\r\n                            <th>Ödeme Türü</th>\r\n                            <th>Tutar</th>\r\n                            <th>Ödeme Tarihi</th>\r\n                            <th>Açıklama</th>\r\n                            <th>Evrak</th>\r\n                            <th>Kayıt Tarihi</th>\r\n                            <th>İşlemler</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody id=\"paymentsTableBody\">\r\n                        <tr>\r\n                            <td colspan=\"9\" class=\"text-center py-5 text-muted\">\r\n                                <i class=\"fas fa-spinner fa-spin fa-2x mb-3 d-block\"></i>\r\n                                <p>Veriler yükleniyor...</p>\r\n                            </td>\r\n                        </tr>\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Yeni Ödeme Kaydı Modal -->\r\n<div class=\"modal fade\" id=\"addPaymentModal\" tabindex=\"-1\">\r\n    <div class=\"modal-dialog modal-lg\">\r\n        <div class=\"modal-content\">\r\n            <form method=\"POST\" action=\"\" enctype=\"multipart/form-data\" id=\"addPaymentForm\">\r\n                <input type=\"hidden\" name=\"form_action\" value=\"add\">\r\n                <div class=\"modal-header\">\r\n                    <h5 class=\"modal-title\">\r\n                        <i class=\"fas fa-plus me-2\"></i>Yeni Hakediş Ödeme Kaydı\r\n                    </h5>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"add_user_id\" class=\"form-label\">Bayi *</label>\r\n                            <select class=\"form-select\" id=\"add_user_id\" name=\"user_id\" required>\r\n                                <option value=\"\">Bayi Seçin</option>\r\n                                <?php foreach ($users as $user): ?>\r\n                                    <option value=\"<?php echo $user['id']; ?>\">\r\n                                        <?php echo htmlspecialchars($user['first_name'] . ' ' . $user['last_name'] . ' (' . $user['email'] . ')'); ?>\r\n                                    </option>\r\n                                <?php endforeach; ?>\r\n                            </select>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"add_odeme_turu_id\" class=\"form-label\">Ödeme Türü *</label>\r\n                            <select class=\"form-select\" id=\"add_odeme_turu_id\" name=\"odeme_turu_id\" required>\r\n                                <option value=\"\">Ödeme Türü Seçin</option>\r\n                                <?php foreach ($odeme_turleri as $tur): ?>\r\n                                    <option value=\"<?php echo $tur['id']; ?>\">\r\n                                        <?php echo htmlspecialchars($tur['tur_adi']); ?>\r\n                                        <?php if ($tur['aciklama']): ?>\r\n                                            - <?php echo htmlspecialchars($tur['aciklama']); ?>\r\n                                        <?php endif; ?>\r\n                                    </option>\r\n                                <?php endforeach; ?>\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"add_odeme_tutari\" class=\"form-label\">Ödeme Tutarı (₺) *</label>\r\n                            <input type=\"number\" class=\"form-control\" id=\"add_odeme_tutari\" name=\"odeme_tutari\" \r\n                                   step=\"0.01\" min=\"0\" required>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"add_odeme_tarihi\" class=\"form-label\">Ödeme Tarihi *</label>\r\n                            <input type=\"datetime-local\" class=\"form-control\" id=\"add_odeme_tarihi\" name=\"odeme_tarihi\" required>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"add_aciklama\" class=\"form-label\">Açıklama</label>\r\n                        <textarea class=\"form-control\" id=\"add_aciklama\" name=\"aciklama\" rows=\"3\" \r\n                                  maxlength=\"500\" placeholder=\"Ödeme ile ilgili açıklama...\"></textarea>\r\n                        <div class=\"form-text\">Maksimum 500 karakter</div>\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"add_evrak_dosya\" class=\"form-label\">Evrak/Dekont Yükle</label>\r\n                        <input type=\"file\" class=\"form-control\" id=\"add_evrak_dosya\" name=\"evrak_dosya\" \r\n                               accept=\".jpg,.jpeg,.png,.gif,.pdf\">\r\n                        <div class=\"form-text\">JPEG, PNG, GIF veya PDF formatında, maksimum 5MB</div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-primary\">\r\n                        <i class=\"fas fa-save me-1\"></i>Kaydet\r\n                    </button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Ödeme Kaydı Düzenle Modal -->\r\n<div class=\"modal fade\" id=\"editPaymentModal\" tabindex=\"-1\">\r\n    <div class=\"modal-dialog modal-lg\">\r\n        <div class=\"modal-content\">\r\n            <form method=\"POST\" action=\"\" enctype=\"multipart/form-data\" id=\"editPaymentForm\">\r\n                <input type=\"hidden\" name=\"form_action\" value=\"edit\">\r\n                <input type=\"hidden\" name=\"id\" id=\"edit_id\">\r\n                <div class=\"modal-header\">\r\n                    <h5 class=\"modal-title\">\r\n                        <i class=\"fas fa-edit me-2\"></i>Hakediş Ödeme Kaydını Düzenle\r\n                    </h5>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"edit_user_id\" class=\"form-label\">Bayi *</label>\r\n                            <select class=\"form-select\" id=\"edit_user_id\" name=\"user_id\" required>\r\n                                <option value=\"\">Bayi Seçin</option>\r\n                                <?php foreach ($users as $user): ?>\r\n                                    <option value=\"<?php echo $user['id']; ?>\">\r\n                                        <?php echo htmlspecialchars($user['first_name'] . ' ' . $user['last_name'] . ' (' . $user['email'] . ')'); ?>\r\n                                    </option>\r\n                                <?php endforeach; ?>\r\n                            </select>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"edit_odeme_turu_id\" class=\"form-label\">Ödeme Türü *</label>\r\n                            <select class=\"form-select\" id=\"edit_odeme_turu_id\" name=\"odeme_turu_id\" required>\r\n                                <option value=\"\">Ödeme Türü Seçin</option>\r\n                                <?php foreach ($odeme_turleri as $tur): ?>\r\n                                    <option value=\"<?php echo $tur['id']; ?>\">\r\n                                        <?php echo htmlspecialchars($tur['tur_adi']); ?>\r\n                                        <?php if ($tur['aciklama']): ?>\r\n                                            - <?php echo htmlspecialchars($tur['aciklama']); ?>\r\n                                        <?php endif; ?>\r\n                                    </option>\r\n                                <?php endforeach; ?>\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"edit_odeme_tutari\" class=\"form-label\">Ödeme Tutarı (₺) *</label>\r\n                            <input type=\"number\" class=\"form-control\" id=\"edit_odeme_tutari\" name=\"odeme_tutari\" \r\n                                   step=\"0.01\" min=\"0\" required>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"edit_odeme_tarihi\" class=\"form-label\">Ödeme Tarihi *</label>\r\n                            <input type=\"datetime-local\" class=\"form-control\" id=\"edit_odeme_tarihi\" name=\"odeme_tarihi\" required>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"edit_aciklama\" class=\"form-label\">Açıklama</label>\r\n                        <textarea class=\"form-control\" id=\"edit_aciklama\" name=\"aciklama\" rows=\"3\" \r\n                                  maxlength=\"500\" placeholder=\"Ödeme ile ilgili açıklama...\"></textarea>\r\n                        <div class=\"form-text\">Maksimum 500 karakter</div>\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"edit_evrak_dosya\" class=\"form-label\">Evrak/Dekont Yükle (Opsiyonel)</label>\r\n                        <input type=\"file\" class=\"form-control\" id=\"edit_evrak_dosya\" name=\"evrak_dosya\" \r\n                               accept=\".jpg,.jpeg,.png,.gif,.pdf\">\r\n                        <div class=\"form-text\">JPEG, PNG, GIF veya PDF formatında, maksimum 5MB. Boş bırakırsanız mevcut dosya korunur.</div>\r\n                        <div id=\"current_file_info\" class=\"mt-2\"></div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-primary\">\r\n                        <i class=\"fas fa-save me-1\"></i>Güncelle\r\n                    </button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\r\n<script>\r\n// Sayfa yüklendiğinde ödemeleri getir\r\ndocument.addEventListener('DOMContentLoaded', function() {\r\n    loadPayments();\r\n    \r\n    // Bugünün tarihini varsayılan olarak ayarla\r\n    const now = new Date();\r\n    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());\r\n    document.getElementById('add_odeme_tarihi').value = now.toISOString().slice(0, 16);\r\n});\r\n\r\nfunction loadPayments() {\r\n    const tbody = document.getElementById('paymentsTableBody');\r\n    tbody.innerHTML = `\r\n        <tr>\r\n            <td colspan=\"9\" class=\"text-center py-3\">\r\n                <i class=\"fas fa-spinner fa-spin\"></i> Yükleniyor...\r\n            </td>\r\n        </tr>\r\n    `;\r\n    \r\n    const formData = new FormData();\r\n    formData.append('action', 'get_payments');\r\n    formData.append('user_id', document.getElementById('filter_user').value);\r\n    formData.append('odeme_turu_id', document.getElementById('filter_odeme_turu').value);\r\n    formData.append('baslangic_tarih', document.getElementById('filter_baslangic').value);\r\n    formData.append('bitis_tarih', document.getElementById('filter_bitis').value);\r\n    \r\n    fetch('', {\r\n        method: 'POST',\r\n        body: formData\r\n    })\r\n    .then(response => response.json())\r\n    .then(data => {\r\n        if (data.success) {\r\n            displayPayments(data.data);\r\n        } else {\r\n            tbody.innerHTML = `\r\n                <tr>\r\n                    <td colspan=\"9\" class=\"text-center py-3 text-danger\">\r\n                        Hata: ${data.message || 'Bilinmeyen hata'}\r\n                    </td>\r\n                </tr>\r\n            `;\r\n        }\r\n    })\r\n    .catch(error => {\r\n        console.error('Fetch error:', error);\r\n        tbody.innerHTML = `\r\n            <tr>\r\n                <td colspan=\"9\" class=\"text-center py-3 text-danger\">\r\n                    Veriler yüklenirken hata oluştu.\r\n                </td>\r\n            </tr>\r\n        `;\r\n    });\r\n}\r\n\r\nfunction displayPayments(payments) {\r\n    const tbody = document.getElementById('paymentsTableBody');\r\n    \r\n    if (payments.length === 0) {\r\n        tbody.innerHTML = `\r\n            <tr>\r\n                <td colspan=\"9\" class=\"text-center py-5 text-muted\">\r\n                    <i class=\"fas fa-money-bill-wave fa-3x mb-3 d-block\"></i>\r\n                    <h5>Henüz ödeme kaydı bulunmuyor</h5>\r\n                    <p>İlk ödeme kaydını eklemek için \"Yeni Ödeme Kaydı\" butonuna tıklayın.</p>\r\n                </td>\r\n            </tr>\r\n        `;\r\n        return;\r\n    }\r\n    \r\n    let html = '';\r\n    payments.forEach(payment => {\r\n        const odemetarihi = new Date(payment.odeme_tarihi).toLocaleString('tr-TR');\r\n        const kayitTarihi = new Date(payment.created_at).toLocaleString('tr-TR');\r\n        const tutar = parseFloat(payment.odeme_tutari).toLocaleString('tr-TR', {\r\n            style: 'currency',\r\n            currency: 'TRY'\r\n        });\r\n        \r\n        const evrakHtml = payment.evrak_dosya_adi ? \r\n            `<a href=\"${payment.evrak_dosya_yolu}\" target=\"_blank\" class=\"btn btn-sm btn-outline-primary\">\r\n                <i class=\"fas fa-file-alt\"></i> Görüntüle\r\n            </a>` : \r\n            '<span class=\"text-muted\">-</span>';\r\n        \r\n        html += `\r\n            <tr>\r\n                <td>${payment.id}</td>\r\n                <td>\r\n                    <strong>${escapeHtml(payment.user_name)}</strong><br>\r\n                    <small class=\"text-muted\">${escapeHtml(payment.user_email)}</small>\r\n                </td>\r\n                <td>\r\n                    <span class=\"badge bg-info\">${escapeHtml(payment.odeme_turu_adi)}</span>\r\n                </td>\r\n                <td><strong>${tutar}</strong></td>\r\n                <td>${odemetarihi}</td>\r\n                <td>${payment.aciklama ? escapeHtml(payment.aciklama) : '<span class=\"text-muted\">-</span>'}</td>\r\n                <td>${evrakHtml}</td>\r\n                <td>\r\n                    ${kayitTarihi}<br>\r\n                    ${payment.created_by_name ? '<small class=\"text-muted\">(' + escapeHtml(payment.created_by_name) + ')</small>' : ''}\r\n                </td>\r\n                <td>\r\n                    <div class=\"btn-group\" role=\"group\">\r\n                        <button type=\"button\" class=\"btn btn-sm btn-outline-primary\" \r\n                                onclick=\"editPayment(${payment.id})\">\r\n                            <i class=\"fas fa-edit\"></i>\r\n                        </button>\r\n                        <button type=\"button\" class=\"btn btn-sm btn-outline-danger\" \r\n                                onclick=\"deletePayment(${payment.id}, '${escapeHtml(payment.user_name)}')\">\r\n                            <i class=\"fas fa-trash\"></i>\r\n                        </button>\r\n                    </div>\r\n                </td>\r\n            </tr>\r\n        `;\r\n    });\r\n    \r\n    tbody.innerHTML = html;\r\n}\r\n\r\nfunction editPayment(paymentId) {\r\n    // AJAX ile ödeme bilgilerini getir\r\n    const formData = new FormData();\r\n    formData.append('action', 'get_payment_details');\r\n    formData.append('id', paymentId);\r\n    \r\n    fetch('', {\r\n        method: 'POST',\r\n        body: formData\r\n    })\r\n    .then(response => response.json())\r\n    .then(data => {\r\n        if (data.success) {\r\n            const payment = data.data;\r\n            \r\n            // Form alanlarını doldur\r\n            document.getElementById('edit_id').value = payment.id;\r\n            document.getElementById('edit_user_id').value = payment.user_id;\r\n            document.getElementById('edit_odeme_turu_id').value = payment.odeme_turu_id;\r\n            document.getElementById('edit_odeme_tutari').value = payment.odeme_tutari;\r\n            document.getElementById('edit_odeme_tarihi').value = payment.odeme_tarihi_formatted;\r\n            document.getElementById('edit_aciklama').value = payment.aciklama || '';\r\n            \r\n            // Mevcut dosya bilgisini göster\r\n            const currentFileInfo = document.getElementById('current_file_info');\r\n            if (payment.evrak_dosya_adi) {\r\n                currentFileInfo.innerHTML = `\r\n                    <div class=\"alert alert-info\">\r\n                        <i class=\"fas fa-file-alt me-2\"></i>\r\n                        Mevcut dosya: <strong>${payment.evrak_dosya_adi}</strong>\r\n                        <a href=\"${payment.evrak_dosya_yolu}\" target=\"_blank\" class=\"btn btn-sm btn-outline-primary ms-2\">\r\n                            <i class=\"fas fa-eye\"></i> Görüntüle\r\n                        </a>\r\n                    </div>\r\n                `;\r\n            } else {\r\n                currentFileInfo.innerHTML = '<p class=\"text-muted\">Mevcut dosya yok</p>';\r\n            }\r\n            \r\n            // Modal'ı aç\r\n            new bootstrap.Modal(document.getElementById('editPaymentModal')).show();\r\n        } else {\r\n            alert('Hata: ' + (data.message || 'Bilinmeyen hata'));\r\n        }\r\n    })\r\n    .catch(error => {\r\n        console.error('Edit payment error:', error);\r\n        alert('Ödeme bilgileri alınırken hata oluştu.');\r\n    });\r\n}\r\n\r\nfunction deletePayment(paymentId, userName) {\r\n    if (confirm(`${userName} için ödeme kaydını silmek istediğinizden emin misiniz?\\n\\nBu işlem geri alınamaz.`)) {\r\n        const formData = new FormData();\r\n        formData.append('action', 'delete');\r\n        formData.append('id', paymentId);\r\n        \r\n        fetch('', {\r\n            method: 'POST',\r\n            body: formData\r\n        })\r\n        .then(response => response.json())\r\n        .then(data => {\r\n            if (data.success) {\r\n                alert('Ödeme kaydı başarıyla silindi.');\r\n                loadPayments();\r\n            } else {\r\n                alert('Hata: ' + (data.message || 'Bilinmeyen hata'));\r\n            }\r\n        })\r\n        .catch(error => {\r\n            console.error('Delete error:', error);\r\n            alert('Silme işlemi sırasında hata oluştu.');\r\n        });\r\n    }\r\n}\r\n\r\nfunction clearFilters() {\r\n    document.getElementById('filter_user').value = '';\r\n    document.getElementById('filter_odeme_turu').value = '';\r\n    document.getElementById('filter_baslangic').value = '';\r\n    document.getElementById('filter_bitis').value = '';\r\n    loadPayments();\r\n}\r\n\r\nfunction escapeHtml(text) {\r\n    const map = {\r\n        '&': '&amp;',\r\n        '<': '&lt;',\r\n        '>': '&gt;',\r\n        '\"': '&quot;',\r\n        \"'\": '&#039;'\r\n    };\r\n    return text.replace(/[&<>\"']/g, function(m) { return map[m]; });\r\n}\r\n</script>\r\n\r\n<?php include 'includes/footer.php'; ?>\r\n"
        }
    ]
}
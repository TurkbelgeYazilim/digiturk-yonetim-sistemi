{
    "sourceFile": "bayi_hakedis_hesapla.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 23,
            "patches": [
                {
                    "date": 1759329717817,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1759335701519,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,34 +9,9 @@\n $currentUser = checkAuth();\r\n checkUserStatus();\r\n updateLastActivity();\r\n \r\n-// Veritabanı bağlantı fonksiyonu\r\n-function getDatabaseConnection() {\r\n-    $configFile = __DIR__ . '/config/mssql.php';\r\n-    \r\n-    if (!file_exists($configFile)) {\r\n-        throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n-    }\r\n-    \r\n-    $config = include $configFile;\r\n-    \r\n-    try {\r\n-        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n-        \r\n-        $connection = new PDO($dsn, $config['username'], $config['password'], [\r\n-            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n-            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n-            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n-            PDO::ATTR_EMULATE_PREPARES => false\r\n-        ]);\r\n-        \r\n-        return $connection;\r\n-        \r\n-    } catch (PDOException $e) {\r\n-        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n-    }\r\n-}\r\n+// getDatabaseConnection function is already defined in auth.php\r\n \r\n // Filtre parametrelerini al - varsayılan değerlerle\r\n $startDate = isset($_GET['start_date']) ? $_GET['start_date'] : '';\r\n $endDate = isset($_GET['end_date']) ? $_GET['end_date'] : '';\r\n@@ -125,28 +100,97 @@\n         $endDate = $hakedisDonemleri[$hakedisDonemi]['end'];\r\n     }\r\n }\r\n \r\n+// Initialize variables with default values\r\n+$outletDurumOptions = [];\r\n+$satisDurumuOptions = [];\r\n+$altBayiOptions = [];\r\n+$pivotData = [];\r\n+$stats = ['toplam_kayit' => 0, 'toplam_altbayi' => 0, 'toplam_kayit_tipi' => 0];\r\n+$columns = ['ISP_NEO', 'ISP_UYDU', 'NEO', 'UYDU'];\r\n+$error = null;\r\n+\r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n+    // Önce tablo ve sütunların varlığını kontrol et\r\n+    $checkTableSql = \"SELECT COUNT(*) as table_exists FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'iris_rapor'\";\r\n+    $checkStmt = $conn->prepare($checkTableSql);\r\n+    $checkStmt->execute();\r\n+    $tableCheck = $checkStmt->fetch();\r\n+    \r\n+    if ($tableCheck['table_exists'] == 0) {\r\n+        throw new Exception('iris_rapor tablosu bulunamadı. Lütfen önce raporları yükleyiniz.');\r\n+    }\r\n+    \r\n+    // Gerekli sütunların varlığını kontrol et\r\n+    $requiredColumns = ['GUNCEL_OUTLET_DURUM', 'SATIS_DURUMU', 'TALEBI_GIREN_PERSONEL_ALTBAYI', 'MEMO_KAYIT_TIPI', 'MEMO_KAPANIS_TARIHI', 'TALEP_TURU'];\r\n+    $checkColumnsSql = \"\r\n+        SELECT COLUMN_NAME \r\n+        FROM INFORMATION_SCHEMA.COLUMNS \r\n+        WHERE TABLE_NAME = 'iris_rapor' \r\n+        AND COLUMN_NAME IN ('\" . implode(\"','\", $requiredColumns) . \"')\r\n+    \";\r\n+    $checkColStmt = $conn->prepare($checkColumnsSql);\r\n+    $checkColStmt->execute();\r\n+    $existingColumns = $checkColStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+    \r\n+    $missingColumns = array_diff($requiredColumns, $existingColumns);\r\n+    if (!empty($missingColumns)) {\r\n+        throw new Exception('Gerekli sütunlar bulunamadı: ' . implode(', ', $missingColumns) . '. Lütfen güncel rapor formatını kullanın.');\r\n+    }\r\n+    \r\n+    // Test data availability\r\n+    $testSql = \"SELECT COUNT(*) as row_count FROM iris_rapor\";\r\n+    $testStmt = $conn->prepare($testSql);\r\n+    $testStmt->execute();\r\n+    $rowCount = $testStmt->fetch(PDO::FETCH_ASSOC);\r\n+    \r\n+    if ($rowCount['row_count'] == 0) {\r\n+        throw new Exception('iris_rapor tablosunda veri bulunamadı. Lütfen önce raporları yükleyiniz.');\r\n+    }\r\n+    \r\n+    // Initialize with empty arrays in case queries fail\r\n+    $outletDurumOptions = [];\r\n+    $satisDurumuOptions = [];\r\n+    $altBayiOptions = [];\r\n+    \r\n     // Önce GUNCEL_OUTLET_DURUM değerlerini al (dropdown için)\r\n-    $outletDurumSql = \"SELECT DISTINCT GUNCEL_OUTLET_DURUM FROM iris_rapor WHERE GUNCEL_OUTLET_DURUM IS NOT NULL AND GUNCEL_OUTLET_DURUM != '' ORDER BY GUNCEL_OUTLET_DURUM\";\r\n-    $outletDurumStmt = $conn->prepare($outletDurumSql);\r\n-    $outletDurumStmt->execute();\r\n-    $outletDurumOptions = $outletDurumStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+    try {\r\n+        $outletDurumSql = \"SELECT DISTINCT GUNCEL_OUTLET_DURUM FROM iris_rapor WHERE GUNCEL_OUTLET_DURUM IS NOT NULL AND GUNCEL_OUTLET_DURUM != '' ORDER BY GUNCEL_OUTLET_DURUM\";\r\n+        $outletDurumStmt = $conn->prepare($outletDurumSql);\r\n+        if ($outletDurumStmt) {\r\n+            $outletDurumStmt->execute();\r\n+            $outletDurumOptions = $outletDurumStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+        }\r\n+    } catch (Exception $e) {\r\n+        // Silent fail for dropdown queries\r\n+    }\r\n     \r\n     // SATIS_DURUMU değerlerini al (dropdown için)\r\n-    $satisDurumuSql = \"SELECT DISTINCT SATIS_DURUMU FROM iris_rapor WHERE SATIS_DURUMU IS NOT NULL AND SATIS_DURUMU != '' ORDER BY SATIS_DURUMU\";\r\n-    $satisDurumuStmt = $conn->prepare($satisDurumuSql);\r\n-    $satisDurumuStmt->execute();\r\n-    $satisDurumuOptions = $satisDurumuStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+    try {\r\n+        $satisDurumuSql = \"SELECT DISTINCT SATIS_DURUMU FROM iris_rapor WHERE SATIS_DURUMU IS NOT NULL AND SATIS_DURUMU != '' ORDER BY SATIS_DURUMU\";\r\n+        $satisDurumuStmt = $conn->prepare($satisDurumuSql);\r\n+        if ($satisDurumuStmt) {\r\n+            $satisDurumuStmt->execute();\r\n+            $satisDurumuOptions = $satisDurumuStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+        }\r\n+    } catch (Exception $e) {\r\n+        // Silent fail for dropdown queries\r\n+    }\r\n     \r\n     // Alt Bayi değerlerini al (dropdown için)\r\n-    $altBayiSql = \"SELECT DISTINCT TALEBI_GIREN_PERSONEL_ALTBAYI FROM iris_rapor WHERE TALEBI_GIREN_PERSONEL_ALTBAYI IS NOT NULL AND TALEBI_GIREN_PERSONEL_ALTBAYI != '' ORDER BY TALEBI_GIREN_PERSONEL_ALTBAYI\";\r\n-    $altBayiStmt = $conn->prepare($altBayiSql);\r\n-    $altBayiStmt->execute();\r\n-    $altBayiOptions = $altBayiStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+    try {\r\n+        $altBayiSql = \"SELECT DISTINCT TALEBI_GIREN_PERSONEL_ALTBAYI FROM iris_rapor WHERE TALEBI_GIREN_PERSONEL_ALTBAYI IS NOT NULL AND TALEBI_GIREN_PERSONEL_ALTBAYI != '' ORDER BY TALEBI_GIREN_PERSONEL_ALTBAYI\";\r\n+        $altBayiStmt = $conn->prepare($altBayiSql);\r\n+        if ($altBayiStmt) {\r\n+            $altBayiStmt->execute();\r\n+            $altBayiOptions = $altBayiStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+        }\r\n+    } catch (Exception $e) {\r\n+        // Silent fail for dropdown queries\r\n+    }\r\n     \r\n     // WHERE koşullarını hazırla\r\n     $whereConditions = [];\r\n     $params = [];\r\n@@ -200,11 +244,19 @@\n     GROUP BY TALEBI_GIREN_PERSONEL_ALTBAYI\r\n     ORDER BY TOPLAM DESC, ALTBAYI\r\n     \";\r\n     \r\n-    $stmt = $conn->prepare($sql);\r\n-    $stmt->execute($params);\r\n-    $pivotData = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n+    // Main pivot query with error handling\r\n+    $pivotData = [];\r\n+    try {\r\n+        $stmt = $conn->prepare($sql);\r\n+        if ($stmt) {\r\n+            $stmt->execute($params);\r\n+            $pivotData = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n+        }\r\n+    } catch (Exception $e) {\r\n+        $pivotData = [];\r\n+    }\r\n     \r\n     // Sütun başlıklarını manuel olarak belirle (ISP'yi ISP_NEO ve ISP_UYDU olarak böl)\r\n     $columns = ['ISP_NEO', 'ISP_UYDU', 'NEO', 'UYDU'];\r\n     \r\n@@ -217,12 +269,24 @@\n     FROM iris_rapor\r\n     $whereClause\r\n     \";\r\n     \r\n-    $statsStmt = $conn->prepare($statsSql);\r\n-    $statsStmt->execute($params);\r\n-    $stats = $statsStmt->fetch(PDO::FETCH_ASSOC);\r\n+    // Stats query with error handling\r\n+    $stats = ['toplam_kayit' => 0, 'toplam_altbayi' => 0, 'toplam_kayit_tipi' => 0];\r\n+    try {\r\n+        $statsStmt = $conn->prepare($statsSql);\r\n+        if ($statsStmt) {\r\n+            $statsStmt->execute($params);\r\n+            $statsResult = $statsStmt->fetch(PDO::FETCH_ASSOC);\r\n+            if ($statsResult) {\r\n+                $stats = $statsResult;\r\n+            }\r\n+        }\r\n+    } catch (Exception $e) {\r\n+        // Silent fail with default stats\r\n+    }\r\n     \r\n+ \r\n } catch (Exception $e) {\r\n     $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n }\r\n \r\n"
                },
                {
                    "date": 1759996794717,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,9 +18,9 @@\n \r\n // Varsayılan filtreler - sadece herhangi bir parametre yoksa\r\n $hasAnyParam = !empty($_GET);\r\n $outletDurum = isset($_GET['outlet_durum']) ? $_GET['outlet_durum'] : ($hasAnyParam ? '' : 'AKTIF');\r\n-$satisDurumu = isset($_GET['satis_durumu']) ? $_GET['satis_durumu'] : ($hasAnyParam ? '' : 'TAMAMLANDI');\r\n+$teyitDurum = isset($_GET['teyit_durum']) ? $_GET['teyit_durum'] : ($hasAnyParam ? '' : 'ONAYLANDI');\r\n $hakedisDonemi = isset($_GET['hakedis_donemi']) ? $_GET['hakedis_donemi'] : '';\r\n $altBayi = isset($_GET['alt_bayi']) ? $_GET['alt_bayi'] : '';\r\n \r\n // Hakediş dönemlerine göre tarih aralıkları\r\n@@ -123,9 +123,9 @@\n         throw new Exception('iris_rapor tablosu bulunamadı. Lütfen önce raporları yükleyiniz.');\r\n     }\r\n     \r\n     // Gerekli sütunların varlığını kontrol et\r\n-    $requiredColumns = ['GUNCEL_OUTLET_DURUM', 'SATIS_DURUMU', 'TALEBI_GIREN_PERSONEL_ALTBAYI', 'MEMO_KAYIT_TIPI', 'MEMO_KAPANIS_TARIHI', 'TALEP_TURU'];\r\n+    $requiredColumns = ['GUNCEL_OUTLET_DURUM', 'TEYIT_DURUM', 'TALEBI_GIREN_PERSONEL_ALTBAYI', 'MEMO_KAYIT_TIPI', 'MEMO_KAPANIS_TARIHI', 'TALEP_TURU'];\r\n     $checkColumnsSql = \"\r\n         SELECT COLUMN_NAME \r\n         FROM INFORMATION_SCHEMA.COLUMNS \r\n         WHERE TABLE_NAME = 'iris_rapor' \r\n@@ -151,9 +151,9 @@\n     }\r\n     \r\n     // Initialize with empty arrays in case queries fail\r\n     $outletDurumOptions = [];\r\n-    $satisDurumuOptions = [];\r\n+    $teyitDurumOptions = [];\r\n     $altBayiOptions = [];\r\n     \r\n     // Önce GUNCEL_OUTLET_DURUM değerlerini al (dropdown için)\r\n     try {\r\n@@ -166,15 +166,15 @@\n     } catch (Exception $e) {\r\n         // Silent fail for dropdown queries\r\n     }\r\n     \r\n-    // SATIS_DURUMU değerlerini al (dropdown için)\r\n+    // TEYIT_DURUM değerlerini al (dropdown için)\r\n     try {\r\n-        $satisDurumuSql = \"SELECT DISTINCT SATIS_DURUMU FROM iris_rapor WHERE SATIS_DURUMU IS NOT NULL AND SATIS_DURUMU != '' ORDER BY SATIS_DURUMU\";\r\n-        $satisDurumuStmt = $conn->prepare($satisDurumuSql);\r\n-        if ($satisDurumuStmt) {\r\n-            $satisDurumuStmt->execute();\r\n-            $satisDurumuOptions = $satisDurumuStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+        $teyitDurumSql = \"SELECT DISTINCT TEYIT_DURUM FROM iris_rapor WHERE TEYIT_DURUM IS NOT NULL AND TEYIT_DURUM != '' ORDER BY TEYIT_DURUM\";\r\n+        $teyitDurumStmt = $conn->prepare($teyitDurumSql);\r\n+        if ($teyitDurumStmt) {\r\n+            $teyitDurumStmt->execute();\r\n+            $teyitDurumOptions = $teyitDurumStmt->fetchAll(PDO::FETCH_COLUMN);\r\n         }\r\n     } catch (Exception $e) {\r\n         // Silent fail for dropdown queries\r\n     }\r\n@@ -215,12 +215,12 @@\n         $whereConditions[] = \"GUNCEL_OUTLET_DURUM = ?\";\r\n         $params[] = $outletDurum;\r\n     }\r\n     \r\n-    // Satış durumu filtresi\r\n-    if (!empty($satisDurumu)) {\r\n-        $whereConditions[] = \"SATIS_DURUMU = ?\";\r\n-        $params[] = $satisDurumu;\r\n+    // Teyit durum filtresi\r\n+    if (!empty($teyitDurum)) {\r\n+        $whereConditions[] = \"TEYIT_DURUM = ?\";\r\n+        $params[] = $teyitDurum;\r\n     }\r\n     \r\n     // Alt bayi filtresi\r\n     if (!empty($altBayi)) {\r\n@@ -395,16 +395,16 @@\n                                 <?php endforeach; ?>\r\n                             </select>\r\n                         </div>\r\n                         <div class=\"col-md-2\">\r\n-                            <label for=\"satis_durumu\" class=\"form-label\">\r\n-                                <i class=\"fas fa-shopping-cart me-1\"></i>Satış Durumu\r\n+                            <label for=\"teyit_durum\" class=\"form-label\">\r\n+                                <i class=\"fas fa-check-circle me-1\"></i>Teyit Durum\r\n                             </label>\r\n-                            <select class=\"form-select\" id=\"satis_durumu\" name=\"satis_durumu\">\r\n+                            <select class=\"form-select\" id=\"teyit_durum\" name=\"teyit_durum\">\r\n                                 <option value=\"\">Tümü</option>\r\n-                                <?php foreach ($satisDurumuOptions as $option): ?>\r\n+                                <?php foreach ($teyitDurumOptions as $option): ?>\r\n                                     <option value=\"<?php echo htmlspecialchars($option); ?>\" \r\n-                                            <?php echo $satisDurumu === $option ? 'selected' : ''; ?>>\r\n+                                            <?php echo $teyitDurum === $option ? 'selected' : ''; ?>>\r\n                                         <?php echo htmlspecialchars($option); ?>\r\n                                     </option>\r\n                                 <?php endforeach; ?>\r\n                             </select>\r\n@@ -455,9 +455,9 @@\n                         </div>\r\n                     </div>\r\n                     \r\n                     <!-- Aktif Filtreler -->\r\n-                    <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($satisDurumu) || !empty($hakedisDonemi) || !empty($altBayi)): ?>\r\n+                    <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($teyitDurum) || !empty($hakedisDonemi) || !empty($altBayi)): ?>\r\n                     <div class=\"mt-3\">\r\n                         <h6 class=\"text-muted mb-2\">\r\n                             <i class=\"fas fa-filter me-1\"></i>Aktif Filtreler:\r\n                         </h6>\r\n@@ -490,13 +490,13 @@\n                                     Outlet: <?php echo htmlspecialchars($outletDurum); ?>\r\n                                     <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('outlet_durum')\" style=\"font-size: 0.7em;\"></button>\r\n                                 </span>\r\n                             <?php endif; ?>\r\n-                            <?php if (!empty($satisDurumu)): ?>\r\n+                            <?php if (!empty($teyitDurum)): ?>\r\n                                 <span class=\"badge bg-warning\">\r\n-                                    <i class=\"fas fa-shopping-cart me-1\"></i>\r\n-                                    Satış: <?php echo htmlspecialchars($satisDurumu); ?>\r\n-                                    <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('satis_durumu')\" style=\"font-size: 0.7em;\"></button>\r\n+                                    <i class=\"fas fa-check-circle me-1\"></i>\r\n+                                    Teyit: <?php echo htmlspecialchars($teyitDurum); ?>\r\n+                                    <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('teyit_durum')\" style=\"font-size: 0.7em;\"></button>\r\n                                 </span>\r\n                             <?php endif; ?>\r\n                             <?php if (!empty($altBayi)): ?>\r\n                                 <span class=\"badge bg-dark\">\r\n@@ -563,9 +563,9 @@\n                             if (!empty($startDate)) $activeFilters++;\r\n                             if (!empty($endDate)) $activeFilters++;\r\n                         }\r\n                         if (!empty($outletDurum)) $activeFilters++;\r\n-                        if (!empty($satisDurumu)) $activeFilters++;\r\n+                        if (!empty($teyitDurum)) $activeFilters++;\r\n                         if (!empty($altBayi)) $activeFilters++;\r\n                         \r\n                         if ($activeFilters > 0) {\r\n                             echo $activeFilters . ' Filtre Aktif';\r\n@@ -593,10 +593,10 @@\n                         if (!empty($outletDurum)) {\r\n                             $filterDetails[] = 'Outlet: ' . $outletDurum;\r\n                         }\r\n                         \r\n-                        if (!empty($satisDurumu)) {\r\n-                            $filterDetails[] = 'Satış: ' . $satisDurumu;\r\n+                        if (!empty($teyitDurum)) {\r\n+                            $filterDetails[] = 'Teyit: ' . $teyitDurum;\r\n                         }\r\n                         \r\n                         if (!empty($altBayi)) {\r\n                             $filterDetails[] = 'Alt Bayi: ' . $altBayi;\r\n@@ -708,9 +708,9 @@\n                             <?php else: ?>\r\n                                 <tr>\r\n                                     <td colspan=\"<?php echo count($columns) + 2; ?>\" class=\"text-center py-5 text-muted\">\r\n                                         <i class=\"fas fa-search fa-2x mb-3 d-block\"></i>\r\n-                        <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($satisDurumu) || !empty($hakedisDonemi) || !empty($altBayi)): ?>\r\n+                        <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($teyitDurum) || !empty($hakedisDonemi) || !empty($altBayi)): ?>\r\n                             <h5>Belirtilen kriterlere uygun veri bulunamadı</h5>\r\n                             <p class=\"mb-0\">\r\n                                 <?php \r\n                                 $activeFilterCount = 0;\r\n@@ -720,9 +720,9 @@\n                                     if (!empty($startDate)) $activeFilterCount++;\r\n                                     if (!empty($endDate)) $activeFilterCount++;\r\n                                 }\r\n                                 if (!empty($outletDurum)) $activeFilterCount++;\r\n-                                if (!empty($satisDurumu)) $activeFilterCount++;\r\n+                                if (!empty($teyitDurum)) $activeFilterCount++;\r\n                                 if (!empty($altBayi)) $activeFilterCount++;                                                echo \"Aktif \" . $activeFilterCount . \" filtre ile eşleşen kayıt bulunamadı.\";\r\n                                                 ?>\r\n                                                 <br>Lütfen farklı kriterler deneyin veya filtreleri temizleyin.\r\n                                             </p>\r\n@@ -871,9 +871,9 @@\n function clearFilters() {\r\n     document.getElementById('start_date').value = '';\r\n     document.getElementById('end_date').value = '';\r\n     document.getElementById('outlet_durum').value = '';\r\n-    document.getElementById('satis_durumu').value = '';\r\n+    document.getElementById('teyit_durum').value = '';\r\n     document.getElementById('hakedis_donemi').value = '';\r\n     document.getElementById('alt_bayi').value = '';\r\n     document.getElementById('filterForm').submit();\r\n }\r\n@@ -986,9 +986,9 @@\n     // Tarih validasyonu\r\n     const startDateInput = document.getElementById('start_date');\r\n     const endDateInput = document.getElementById('end_date');\r\n     const outletDurumSelect = document.getElementById('outlet_durum');\r\n-    const satisDurumuSelect = document.getElementById('satis_durumu');\r\n+    const teyitDurumSelect = document.getElementById('teyit_durum');\r\n     const hakedisDonemiSelect = document.getElementById('hakedis_donemi');\r\n     \r\n     // Hakediş dönemleri tanımları (PHP'den JavaScript'e)\r\n     const hakedisDonemleri = <?php echo json_encode($hakedisDonemleri); ?>;\r\n@@ -1037,9 +1037,9 @@\n         // Bu özellik istenirse aktif edilebilir\r\n         // document.getElementById('filterForm').submit();\r\n     });\r\n     \r\n-    satisDurumuSelect.addEventListener('change', function() {\r\n+    teyitDurumSelect.addEventListener('change', function() {\r\n         // Eğer kullanıcı dropdown'dan seçim yaparsa otomatik filtreleme yapabilir\r\n         // Bu özellik istenirse aktif edilebilir\r\n         // document.getElementById('filterForm').submit();\r\n     });\r\n"
                },
                {
                    "date": 1759996983696,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,86 +22,11 @@\n $teyitDurum = isset($_GET['teyit_durum']) ? $_GET['teyit_durum'] : ($hasAnyParam ? '' : 'ONAYLANDI');\r\n $hakedisDonemi = isset($_GET['hakedis_donemi']) ? $_GET['hakedis_donemi'] : '';\r\n $altBayi = isset($_GET['alt_bayi']) ? $_GET['alt_bayi'] : '';\r\n \r\n-// Hakediş dönemlerine göre tarih aralıkları\r\n-$hakedisDonemleri = [\r\n-    'eylul_2024' => [\r\n-        'label' => 'Eylül 2024 Hakediş Dönemi',\r\n-        'start' => '2024-09-04',\r\n-        'end' => '2024-10-03'\r\n-    ],\r\n-    'ekim_2024' => [\r\n-        'label' => 'Ekim 2024 Hakediş Dönemi',\r\n-        'start' => '2024-10-04',\r\n-        'end' => '2024-11-03'\r\n-    ],\r\n-    'kasim_2024' => [\r\n-        'label' => 'Kasım 2024 Hakediş Dönemi',\r\n-        'start' => '2024-11-04',\r\n-        'end' => '2024-12-03'\r\n-    ],\r\n-    'aralik_2024' => [\r\n-        'label' => 'Aralık 2024 Hakediş Dönemi',\r\n-        'start' => '2024-12-04',\r\n-        'end' => '2025-01-03'\r\n-    ],\r\n-    'ocak_2025' => [\r\n-        'label' => 'Ocak 2025 Hakediş Dönemi',\r\n-        'start' => '2025-01-04',\r\n-        'end' => '2025-02-03'\r\n-    ],\r\n-    'subat_2025' => [\r\n-        'label' => 'Şubat 2025 Hakediş Dönemi',\r\n-        'start' => '2025-02-04',\r\n-        'end' => '2025-03-03'\r\n-    ],\r\n-    'mart_2025' => [\r\n-        'label' => 'Mart 2025 Hakediş Dönemi',\r\n-        'start' => '2025-03-04',\r\n-        'end' => '2025-04-03'\r\n-    ],\r\n-    'nisan_2025' => [\r\n-        'label' => 'Nisan 2025 Hakediş Dönemi',\r\n-        'start' => '2025-04-04',\r\n-        'end' => '2025-05-03'\r\n-    ],\r\n-    'mayis_2025' => [\r\n-        'label' => 'Mayıs 2025 Hakediş Dönemi',\r\n-        'start' => '2025-05-04',\r\n-        'end' => '2025-06-03'\r\n-    ],\r\n-    'haziran_2025' => [\r\n-        'label' => 'Haziran 2025 Hakediş Dönemi',\r\n-        'start' => '2025-06-04',\r\n-        'end' => '2025-07-03'\r\n-    ],\r\n-    'temmuz_2025' => [\r\n-        'label' => 'Temmuz 2025 Hakediş Dönemi',\r\n-        'start' => '2025-07-04',\r\n-        'end' => '2025-08-03'\r\n-    ],\r\n-    'agustos_2025' => [\r\n-        'label' => 'Ağustos 2025 Hakediş Dönemi',\r\n-        'start' => '2025-08-04',\r\n-        'end' => '2025-09-03'\r\n-    ],\r\n-    'eylul_2025' => [\r\n-        'label' => 'Eylül 2025 Hakediş Dönemi',\r\n-        'start' => '2025-09-04',\r\n-        'end' => '2025-10-03'\r\n-    ]\r\n-];\r\n+// Hakediş dönemlerini veritabanından al (veritabanı bağlantısı kurulduktan sonra)\r\n+$hakedisDonemleri = [];\r\n \r\n-// Hakediş dönemi seçildiyse tarih aralığını otomatik ayarla\r\n-if (!empty($hakedisDonemi) && isset($hakedisDonemleri[$hakedisDonemi])) {\r\n-    // Sadece tarih parametreleri manuel olarak set edilmemişse otomatik ayarla\r\n-    if (empty($_GET['start_date']) && empty($_GET['end_date'])) {\r\n-        $startDate = $hakedisDonemleri[$hakedisDonemi]['start'];\r\n-        $endDate = $hakedisDonemleri[$hakedisDonemi]['end'];\r\n-    }\r\n-}\r\n-\r\n // Initialize variables with default values\r\n $outletDurumOptions = [];\r\n $satisDurumuOptions = [];\r\n $altBayiOptions = [];\r\n@@ -112,8 +37,27 @@\n \r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n+    // Hakediş dönemlerini al\r\n+    try {\r\n+        $hakedisDonemiSql = \"SELECT id, donem_adi, baslangic_tarihi, bitis_tarihi FROM bayi_hakedis_prim_donem ORDER BY baslangic_tarihi DESC\";\r\n+        $hakedisDonemiStmt = $conn->prepare($hakedisDonemiSql);\r\n+        $hakedisDonemiStmt->execute();\r\n+        $hakedisDonemiResult = $hakedisDonemiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+        \r\n+        foreach ($hakedisDonemiResult as $donem) {\r\n+            $hakedisDonemleri[$donem['id']] = [\r\n+                'label' => $donem['donem_adi'],\r\n+                'start' => $donem['baslangic_tarihi'],\r\n+                'end' => $donem['bitis_tarihi']\r\n+            ];\r\n+        }\r\n+    } catch (Exception $e) {\r\n+        // Hata durumunda boş dizi kullan\r\n+        $hakedisDonemleri = [];\r\n+    }\r\n+    \r\n     // Önce tablo ve sütunların varlığını kontrol et\r\n     $checkTableSql = \"SELECT COUNT(*) as table_exists FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'iris_rapor'\";\r\n     $checkStmt = $conn->prepare($checkTableSql);\r\n     $checkStmt->execute();\r\n@@ -284,13 +228,21 @@\n     } catch (Exception $e) {\r\n         // Silent fail with default stats\r\n     }\r\n     \r\n- \r\n } catch (Exception $e) {\r\n     $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n }\r\n \r\n+// Hakediş dönemi seçildiyse tarih aralığını otomatik ayarla (veritabanından veri çekildikten sonra)\r\n+if (!empty($hakedisDonemi) && isset($hakedisDonemleri[$hakedisDonemi])) {\r\n+    // Sadece tarih parametreleri manuel olarak set edilmemişse otomatik ayarla\r\n+    if (empty($_GET['start_date']) && empty($_GET['end_date'])) {\r\n+        $startDate = date('Y-m-d', strtotime($hakedisDonemleri[$hakedisDonemi]['start']));\r\n+        $endDate = date('Y-m-d', strtotime($hakedisDonemleri[$hakedisDonemi]['end']));\r\n+    }\r\n+}\r\n+\r\n include 'includes/header.php';\r\n ?>\r\n \r\n <div class=\"container-fluid mt-4\">\r\n"
                },
                {
                    "date": 1760008716807,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,11 +21,15 @@\n $outletDurum = isset($_GET['outlet_durum']) ? $_GET['outlet_durum'] : ($hasAnyParam ? '' : 'AKTIF');\r\n $teyitDurum = isset($_GET['teyit_durum']) ? $_GET['teyit_durum'] : ($hasAnyParam ? '' : 'ONAYLANDI');\r\n $hakedisDonemi = isset($_GET['hakedis_donemi']) ? $_GET['hakedis_donemi'] : '';\r\n $altBayi = isset($_GET['alt_bayi']) ? $_GET['alt_bayi'] : '';\r\n+$hesaplamaYap = isset($_GET['hesaplama_yap']) ? $_GET['hesaplama_yap'] : false;\r\n \r\n // Hakediş dönemlerini veritabanından al (veritabanı bağlantısı kurulduktan sonra)\r\n $hakedisDonemleri = [];\r\n+$altBayiList = [];\r\n+$hakedisHesaplama = [];\r\n+$hakedisResult = null;\r\n \r\n // Initialize variables with default values\r\n $outletDurumOptions = [];\r\n $satisDurumuOptions = [];\r\n@@ -55,8 +59,116 @@\n     } catch (Exception $e) {\r\n         // Hata durumunda boş dizi kullan\r\n         $hakedisDonemleri = [];\r\n     }\r\n+\r\n+    // Alt bayileri al (users_bayi tablosundan)\r\n+    try {\r\n+        $altBayiSql = \"SELECT ub.id, ub.user_id, u.username as bayi_adi FROM users_bayi ub \r\n+                       INNER JOIN users u ON ub.user_id = u.id \r\n+                       ORDER BY u.username\";\r\n+        $altBayiStmt = $conn->prepare($altBayiSql);\r\n+        $altBayiStmt->execute();\r\n+        $altBayiResult = $altBayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+        \r\n+        foreach ($altBayiResult as $bayi) {\r\n+            $altBayiList[$bayi['user_id']] = [\r\n+                'id' => $bayi['id'],\r\n+                'user_id' => $bayi['user_id'],\r\n+                'bayi_adi' => $bayi['bayi_adi']\r\n+            ];\r\n+        }\r\n+    } catch (Exception $e) {\r\n+        $altBayiList = [];\r\n+    }\r\n+\r\n+    // Hakediş hesaplama yapılacaksa\r\n+    if ($hesaplamaYap && !empty($hakedisDonemi) && !empty($altBayi)) {\r\n+        try {\r\n+            // Seçilen dönem bilgilerini al\r\n+            $selectedDonem = $hakedisDonemleri[$hakedisDonemi] ?? null;\r\n+            $selectedBayi = $altBayiList[$altBayi] ?? null;\r\n+            \r\n+            if ($selectedDonem && $selectedBayi) {\r\n+                // Hakediş tanım fiyatlarını al\r\n+                $hakedisQuery = \"SELECT isp_neo_fiyat, isp_uydu_fiyat, neo_fiyat, uydu_fiyat \r\n+                                FROM hakedis_tanim \r\n+                                WHERE bayi_hakedis_prim_donem_id = ? AND bayi_id = ?\";\r\n+                $hakedisStmt = $conn->prepare($hakedisQuery);\r\n+                $hakedisStmt->execute([$hakedisDonemi, $altBayi]);\r\n+                $hakedisData = $hakedisStmt->fetch(PDO::FETCH_ASSOC);\r\n+                \r\n+                if ($hakedisData) {\r\n+                    // Dönem tarih aralığında işlem sayılarını hesapla\r\n+                    $startDateCalc = $selectedDonem['start'];\r\n+                    $endDateCalc = $selectedDonem['end'];\r\n+                    \r\n+                    // İşlem sayılarını hesapla\r\n+                    $countQuery = \"\r\n+                        SELECT \r\n+                            SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'ISP ve Neo Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_NEO_COUNT,\r\n+                            SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'Uydu ve ISP Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_UYDU_COUNT,\r\n+                            SUM(CASE WHEN MEMO_KAYIT_TIPI = 'NEO' THEN 1 ELSE 0 END) as NEO_COUNT,\r\n+                            SUM(CASE WHEN MEMO_KAYIT_TIPI = 'UYDU' THEN 1 ELSE 0 END) as UYDU_COUNT\r\n+                        FROM iris_rapor \r\n+                        WHERE MEMO_KAPANIS_TARIHI >= ? \r\n+                        AND MEMO_KAPANIS_TARIHI <= ?\r\n+                        AND TALEBI_GIREN_PERSONEL_ALTBAYI = ?\r\n+                        AND GUNCEL_OUTLET_DURUM = 'AKTIF'\r\n+                        AND TEYIT_DURUM = 'ONAYLANDI'\r\n+                    \";\r\n+                    \r\n+                    $countStmt = $conn->prepare($countQuery);\r\n+                    $countStmt->execute([\r\n+                        $startDateCalc . ' 00:00:00',\r\n+                        $endDateCalc . ' 23:59:59',\r\n+                        $selectedBayi['bayi_adi']\r\n+                    ]);\r\n+                    $counts = $countStmt->fetch(PDO::FETCH_ASSOC);\r\n+                    \r\n+                    // Hakediş hesaplama\r\n+                    $hakedisResult = [\r\n+                        'donem_info' => $selectedDonem,\r\n+                        'bayi_info' => $selectedBayi,\r\n+                        'fiyatlar' => $hakedisData,\r\n+                        'islem_sayilari' => $counts,\r\n+                        'hesaplamalar' => [\r\n+                            'ISP_NEO' => [\r\n+                                'adet' => $counts['ISP_NEO_COUNT'] ?? 0,\r\n+                                'birim_fiyat' => $hakedisData['isp_neo_fiyat'] ?? 0,\r\n+                                'toplam' => ($counts['ISP_NEO_COUNT'] ?? 0) * ($hakedisData['isp_neo_fiyat'] ?? 0)\r\n+                            ],\r\n+                            'ISP_UYDU' => [\r\n+                                'adet' => $counts['ISP_UYDU_COUNT'] ?? 0,\r\n+                                'birim_fiyat' => $hakedisData['isp_uydu_fiyat'] ?? 0,\r\n+                                'toplam' => ($counts['ISP_UYDU_COUNT'] ?? 0) * ($hakedisData['isp_uydu_fiyat'] ?? 0)\r\n+                            ],\r\n+                            'NEO' => [\r\n+                                'adet' => $counts['NEO_COUNT'] ?? 0,\r\n+                                'birim_fiyat' => $hakedisData['neo_fiyat'] ?? 0,\r\n+                                'toplam' => ($counts['NEO_COUNT'] ?? 0) * ($hakedisData['neo_fiyat'] ?? 0)\r\n+                            ],\r\n+                            'UYDU' => [\r\n+                                'adet' => $counts['UYDU_COUNT'] ?? 0,\r\n+                                'birim_fiyat' => $hakedisData['uydu_fiyat'] ?? 0,\r\n+                                'toplam' => ($counts['UYDU_COUNT'] ?? 0) * ($hakedisData['uydu_fiyat'] ?? 0)\r\n+                            ]\r\n+                        ]\r\n+                    ];\r\n+                    \r\n+                    // Genel toplam hesapla\r\n+                    $hakedisResult['genel_toplam'] = array_sum(array_column($hakedisResult['hesaplamalar'], 'toplam'));\r\n+                    \r\n+                } else {\r\n+                    $error = \"Seçilen dönem ve bayi için hakediş tanımı bulunamadı.\";\r\n+                }\r\n+            } else {\r\n+                $error = \"Geçersiz dönem veya bayi seçimi.\";\r\n+            }\r\n+        } catch (Exception $e) {\r\n+            $error = \"Hakediş hesaplama hatası: \" . $e->getMessage();\r\n+        }\r\n+    }\r\n     \r\n     // Önce tablo ve sütunların varlığını kontrol et\r\n     $checkTableSql = \"SELECT COUNT(*) as table_exists FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'iris_rapor'\";\r\n     $checkStmt = $conn->prepare($checkTableSql);\r\n@@ -248,9 +360,9 @@\n <div class=\"container-fluid mt-4\">\r\n     <div class=\"row\">\r\n         <div class=\"col-12\">\r\n             <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n-                <h2><i class=\"fas fa-calculator me-2\"></i>Hakediş Hesaplama Raporu</h2>\r\n+                <h2><i class=\"fas fa-calculator me-2\"></i>Hakediş Hesaplama</h2>\r\n                 <div class=\"btn-group\">\r\n                     <button class=\"btn btn-outline-primary\" onclick=\"exportToExcel()\">\r\n                         <i class=\"fas fa-file-excel me-1\"></i>Excel'e Aktar\r\n                     </button>\r\n@@ -264,8 +376,229 @@\n             </div>\r\n         </div>\r\n     </div>\r\n \r\n+    <!-- Hakediş Hesaplama Formu -->\r\n+    <div class=\"card border-0 shadow-sm mb-4\">\r\n+        <div class=\"card-header bg-success text-white\">\r\n+            <h6 class=\"mb-0\">\r\n+                <i class=\"fas fa-calculator me-2\"></i>Hakediş Hesaplama\r\n+            </h6>\r\n+        </div>\r\n+        <div class=\"card-body\">\r\n+            <form method=\"GET\" action=\"\" id=\"hakedisFrm\">\r\n+                <input type=\"hidden\" name=\"hesaplama_yap\" value=\"1\">\r\n+                <div class=\"row g-3 align-items-end\">\r\n+                    <div class=\"col-md-4\">\r\n+                        <label for=\"hakedis_donemi_calc\" class=\"form-label\">\r\n+                            <i class=\"fas fa-calendar-check me-1\"></i>Hakediş Dönemi *\r\n+                        </label>\r\n+                        <select class=\"form-select\" id=\"hakedis_donemi_calc\" name=\"hakedis_donemi\" required>\r\n+                            <option value=\"\">Dönem Seçiniz</option>\r\n+                            <?php foreach ($hakedisDonemleri as $key => $donem): ?>\r\n+                                <option value=\"<?php echo $key; ?>\" \r\n+                                        <?php echo $hakedisDonemi == $key ? 'selected' : ''; ?>>\r\n+                                    <?php echo htmlspecialchars($donem['label']); ?>\r\n+                                    (<?php echo date('d.m.Y', strtotime($donem['start'])); ?> - \r\n+                                     <?php echo date('d.m.Y', strtotime($donem['end'])); ?>)\r\n+                                </option>\r\n+                            <?php endforeach; ?>\r\n+                        </select>\r\n+                    </div>\r\n+                    <div class=\"col-md-4\">\r\n+                        <label for=\"alt_bayi_calc\" class=\"form-label\">\r\n+                            <i class=\"fas fa-user-tie me-1\"></i>Alt Bayi *\r\n+                        </label>\r\n+                        <select class=\"form-select\" id=\"alt_bayi_calc\" name=\"alt_bayi\" required>\r\n+                            <option value=\"\">Bayi Seçiniz</option>\r\n+                            <?php foreach ($altBayiList as $user_id => $bayi): ?>\r\n+                                <option value=\"<?php echo $user_id; ?>\" \r\n+                                        <?php echo $altBayi == $user_id ? 'selected' : ''; ?>>\r\n+                                    <?php echo htmlspecialchars($bayi['bayi_adi']); ?>\r\n+                                    (ID: <?php echo $bayi['id']; ?>)\r\n+                                </option>\r\n+                            <?php endforeach; ?>\r\n+                        </select>\r\n+                    </div>\r\n+                    <div class=\"col-md-4\">\r\n+                        <button type=\"submit\" class=\"btn btn-success btn-lg w-100\">\r\n+                            <i class=\"fas fa-calculator me-1\"></i>Hakediş Hesapla\r\n+                        </button>\r\n+                    </div>\r\n+                </div>\r\n+            </form>\r\n+        </div>\r\n+    </div>\r\n+\r\n+    <!-- Hakediş Hesaplama Sonucu -->\r\n+    <?php if ($hakedisResult): ?>\r\n+    <div class=\"card border-0 shadow-sm mb-4\">\r\n+        <div class=\"card-header bg-primary text-white\">\r\n+            <div class=\"row align-items-center\">\r\n+                <div class=\"col\">\r\n+                    <h5 class=\"mb-0\">\r\n+                        <i class=\"fas fa-chart-line me-2\"></i>\r\n+                        Hakediş Hesaplama Sonucu\r\n+                    </h5>\r\n+                </div>\r\n+                <div class=\"col-auto\">\r\n+                    <span class=\"badge bg-light text-dark fs-6\">\r\n+                        <i class=\"fas fa-lira-sign me-1\"></i>\r\n+                        <?php echo number_format($hakedisResult['genel_toplam'], 2, ',', '.'); ?> TL\r\n+                    </span>\r\n+                </div>\r\n+            </div>\r\n+        </div>\r\n+        <div class=\"card-body\">\r\n+            <!-- Dönem ve Bayi Bilgileri -->\r\n+            <div class=\"row mb-4\">\r\n+                <div class=\"col-md-6\">\r\n+                    <div class=\"card border-primary\">\r\n+                        <div class=\"card-header bg-primary text-white py-2\">\r\n+                            <h6 class=\"mb-0\"><i class=\"fas fa-calendar me-1\"></i>Dönem Bilgileri</h6>\r\n+                        </div>\r\n+                        <div class=\"card-body py-3\">\r\n+                            <p class=\"mb-1\"><strong>Dönem:</strong> <?php echo htmlspecialchars($hakedisResult['donem_info']['label']); ?></p>\r\n+                            <p class=\"mb-1\"><strong>Başlangıç:</strong> <?php echo date('d.m.Y', strtotime($hakedisResult['donem_info']['start'])); ?></p>\r\n+                            <p class=\"mb-0\"><strong>Bitiş:</strong> <?php echo date('d.m.Y', strtotime($hakedisResult['donem_info']['end'])); ?></p>\r\n+                        </div>\r\n+                    </div>\r\n+                </div>\r\n+                <div class=\"col-md-6\">\r\n+                    <div class=\"card border-success\">\r\n+                        <div class=\"card-header bg-success text-white py-2\">\r\n+                            <h6 class=\"mb-0\"><i class=\"fas fa-user-tie me-1\"></i>Bayi Bilgileri</h6>\r\n+                        </div>\r\n+                        <div class=\"card-body py-3\">\r\n+                            <p class=\"mb-1\"><strong>Bayi Adı:</strong> <?php echo htmlspecialchars($hakedisResult['bayi_info']['bayi_adi']); ?></p>\r\n+                            <p class=\"mb-1\"><strong>Bayi ID:</strong> <?php echo $hakedisResult['bayi_info']['id']; ?></p>\r\n+                            <p class=\"mb-0\"><strong>User ID:</strong> <?php echo $hakedisResult['bayi_info']['user_id']; ?></p>\r\n+                        </div>\r\n+                    </div>\r\n+                </div>\r\n+            </div>\r\n+\r\n+            <!-- Hakediş Hesaplama Detayları -->\r\n+            <div class=\"table-responsive\">\r\n+                <table class=\"table table-striped table-hover\">\r\n+                    <thead class=\"table-dark\">\r\n+                        <tr>\r\n+                            <th>Kayıt Tipi</th>\r\n+                            <th class=\"text-center\">İşlem Adedi</th>\r\n+                            <th class=\"text-end\">Birim Fiyat (TL)</th>\r\n+                            <th class=\"text-end\">Toplam Tutar (TL)</th>\r\n+                        </tr>\r\n+                    </thead>\r\n+                    <tbody>\r\n+                        <?php foreach ($hakedisResult['hesaplamalar'] as $tip => $hesap): ?>\r\n+                        <tr>\r\n+                            <td>\r\n+                                <strong><?php echo $tip; ?></strong>\r\n+                                <?php \r\n+                                switch($tip) {\r\n+                                    case 'ISP_NEO':\r\n+                                        echo '<br><small class=\"text-muted\">ISP ve Neo Potansiyel Talep</small>';\r\n+                                        break;\r\n+                                    case 'ISP_UYDU':\r\n+                                        echo '<br><small class=\"text-muted\">Uydu ve ISP Potansiyel Talep</small>';\r\n+                                        break;\r\n+                                    case 'NEO':\r\n+                                        echo '<br><small class=\"text-muted\">Neo İşlemleri</small>';\r\n+                                        break;\r\n+                                    case 'UYDU':\r\n+                                        echo '<br><small class=\"text-muted\">Uydu İşlemleri</small>';\r\n+                                        break;\r\n+                                }\r\n+                                ?>\r\n+                            </td>\r\n+                            <td class=\"text-center\">\r\n+                                <span class=\"badge bg-info fs-6\"><?php echo number_format($hesap['adet']); ?></span>\r\n+                            </td>\r\n+                            <td class=\"text-end\">\r\n+                                <strong><?php echo number_format($hesap['birim_fiyat'], 2, ',', '.'); ?></strong>\r\n+                            </td>\r\n+                            <td class=\"text-end\">\r\n+                                <strong class=\"text-success\">\r\n+                                    <i class=\"fas fa-lira-sign me-1\"></i>\r\n+                                    <?php echo number_format($hesap['toplam'], 2, ',', '.'); ?>\r\n+                                </strong>\r\n+                            </td>\r\n+                        </tr>\r\n+                        <?php endforeach; ?>\r\n+                    </tbody>\r\n+                    <tfoot class=\"table-success\">\r\n+                        <tr>\r\n+                            <th colspan=\"3\" class=\"text-end\">GENEL TOPLAM:</th>\r\n+                            <th class=\"text-end\">\r\n+                                <h5 class=\"mb-0 text-success\">\r\n+                                    <i class=\"fas fa-lira-sign me-1\"></i>\r\n+                                    <?php echo number_format($hakedisResult['genel_toplam'], 2, ',', '.'); ?> TL\r\n+                                </h5>\r\n+                            </th>\r\n+                        </tr>\r\n+                    </tfoot>\r\n+                </table>\r\n+            </div>\r\n+\r\n+            <!-- Özet Kartları -->\r\n+            <div class=\"row mt-4\">\r\n+                <div class=\"col-md-3\">\r\n+                    <div class=\"card border-info text-center\">\r\n+                        <div class=\"card-body py-3\">\r\n+                            <h4 class=\"text-info mb-1\">\r\n+                                <?php echo array_sum(array_column($hakedisResult['hesaplamalar'], 'adet')); ?>\r\n+                            </h4>\r\n+                            <p class=\"mb-0 text-muted\">Toplam İşlem</p>\r\n+                        </div>\r\n+                    </div>\r\n+                </div>\r\n+                <div class=\"col-md-3\">\r\n+                    <div class=\"card border-warning text-center\">\r\n+                        <div class=\"card-body py-3\">\r\n+                            <h4 class=\"text-warning mb-1\">\r\n+                                <?php echo number_format(\r\n+                                    array_sum(array_column($hakedisResult['hesaplamalar'], 'birim_fiyat')) / 4, \r\n+                                    2, ',', '.'\r\n+                                ); ?>\r\n+                            </h4>\r\n+                            <p class=\"mb-0 text-muted\">Ort. Birim Fiyat</p>\r\n+                        </div>\r\n+                    </div>\r\n+                </div>\r\n+                <div class=\"col-md-3\">\r\n+                    <div class=\"card border-primary text-center\">\r\n+                        <div class=\"card-body py-3\">\r\n+                            <h4 class=\"text-primary mb-1\">\r\n+                                <?php echo count(array_filter($hakedisResult['hesaplamalar'], function($h) { return $h['adet'] > 0; })); ?>\r\n+                            </h4>\r\n+                            <p class=\"mb-0 text-muted\">Aktif Tip Sayısı</p>\r\n+                        </div>\r\n+                    </div>\r\n+                </div>\r\n+                <div class=\"col-md-3\">\r\n+                    <div class=\"card border-success text-center\">\r\n+                        <div class=\"card-body py-3\">\r\n+                            <h4 class=\"text-success mb-1\">\r\n+                                <?php \r\n+                                $totalAdet = array_sum(array_column($hakedisResult['hesaplamalar'], 'adet'));\r\n+                                $avgPerTransaction = $totalAdet > 0 ? $hakedisResult['genel_toplam'] / $totalAdet : 0;\r\n+                                echo number_format($avgPerTransaction, 2, ',', '.');\r\n+                                ?>\r\n+                            </h4>\r\n+                            <p class=\"mb-0 text-muted\">İşlem Başına Ort.</p>\r\n+                        </div>\r\n+                    </div>\r\n+                </div>\r\n+            </div>\r\n+        </div>\r\n+    </div>\r\n+    <?php elseif ($error && $hesaplamaYap): ?>\r\n+    <div class=\"alert alert-danger\">\r\n+        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n+        <?php echo htmlspecialchars($error); ?>\r\n+    </div>\r\n+    <?php endif; ?>\r\n+\r\n     <!-- Filtre Formu -->\r\n     <div class=\"card border-0 shadow-sm mb-4\">\r\n         <div class=\"card-header bg-light\">\r\n             <h6 class=\"mb-0\">\r\n@@ -917,10 +1250,57 @@\n     document.body.appendChild(container);\r\n     return container;\r\n }\r\n \r\n-// Tablo satırlarına hover efekti ve form validasyonu\r\n+// Hakediş hesaplama form validasyonu\r\n document.addEventListener('DOMContentLoaded', function() {\r\n+    const hakedisFrm = document.getElementById('hakedisFrm');\r\n+    const donemeSelect = document.getElementById('hakedis_donemi_calc');\r\n+    const bayiSelect = document.getElementById('alt_bayi_calc');\r\n+    \r\n+    if (hakedisFrm) {\r\n+        hakedisFrm.addEventListener('submit', function(e) {\r\n+            if (!donemeSelect.value || !bayiSelect.value) {\r\n+                e.preventDefault();\r\n+                showToast('Lütfen dönem ve bayi seçimi yapınız!', 'error');\r\n+                return false;\r\n+            }\r\n+            \r\n+            // Loading göster\r\n+            const submitBtn = this.querySelector('button[type=\"submit\"]');\r\n+            const originalText = submitBtn.innerHTML;\r\n+            submitBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin me-1\"></i>Hesaplanıyor...';\r\n+            submitBtn.disabled = true;\r\n+            \r\n+            // Form submit edilirse loading'i geri al\r\n+            setTimeout(() => {\r\n+                submitBtn.innerHTML = originalText;\r\n+                submitBtn.disabled = false;\r\n+            }, 5000);\r\n+        });\r\n+    }\r\n+    \r\n+    // Dönem değişikliğinde bilgi göster\r\n+    if (donemeSelect) {\r\n+        donemeSelect.addEventListener('change', function() {\r\n+            const selectedOption = this.options[this.selectedIndex];\r\n+            if (selectedOption.value) {\r\n+                showToast('Dönem seçildi: ' + selectedOption.text, 'info');\r\n+            }\r\n+        });\r\n+    }\r\n+    \r\n+    // Bayi değişikliğinde bilgi göster\r\n+    if (bayiSelect) {\r\n+        bayiSelect.addEventListener('change', function() {\r\n+            const selectedOption = this.options[this.selectedIndex];\r\n+            if (selectedOption.value) {\r\n+                showToast('Bayi seçildi: ' + selectedOption.text, 'info');\r\n+            }\r\n+        });\r\n+    }\r\n+\r\n+    // Tablo satırlarına hover efekti ve form validasyonu\r\n     const tableRows = document.querySelectorAll('#pivotTable tbody tr:not(.table-secondary)');\r\n     \r\n     tableRows.forEach(row => {\r\n         row.addEventListener('mouseenter', function() {\r\n@@ -945,8 +1325,10 @@\n     // Hakediş dönemleri tanımları (PHP'den JavaScript'e)\r\n     const hakedisDonemleri = <?php echo json_encode($hakedisDonemleri); ?>;\r\n     \r\n     function validateDates() {\r\n+        if (!startDateInput || !endDateInput) return true;\r\n+        \r\n         const startDate = startDateInput.value;\r\n         const endDate = endDateInput.value;\r\n         \r\n         if (startDate && endDate) {\r\n@@ -957,85 +1339,98 @@\n         }\r\n         return true;\r\n     }\r\n     \r\n-    // Form submit validasyonu\r\n-    document.getElementById('filterForm').addEventListener('submit', function(e) {\r\n-        if (!validateDates()) {\r\n-            e.preventDefault();\r\n-            return false;\r\n-        }\r\n-        \r\n-        // Loading göster\r\n-        const submitBtn = this.querySelector('button[type=\"submit\"]');\r\n-        const originalText = submitBtn.innerHTML;\r\n-        submitBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin me-1\"></i>Filtreleniyor...';\r\n-        submitBtn.disabled = true;\r\n-        \r\n-        // Form submit edilirse loading'i geri al\r\n-        setTimeout(() => {\r\n-            submitBtn.innerHTML = originalText;\r\n-            submitBtn.disabled = false;\r\n-        }, 3000);\r\n-    });\r\n+    // Form submit validasyonu (eğer filtre formu varsa)\r\n+    const filterForm = document.getElementById('filterForm');\r\n+    if (filterForm) {\r\n+        filterForm.addEventListener('submit', function(e) {\r\n+            if (!validateDates()) {\r\n+                e.preventDefault();\r\n+                return false;\r\n+            }\r\n+            \r\n+            // Loading göster\r\n+            const submitBtn = this.querySelector('button[type=\"submit\"]');\r\n+            const originalText = submitBtn.innerHTML;\r\n+            submitBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin me-1\"></i>Filtreleniyor...';\r\n+            submitBtn.disabled = true;\r\n+            \r\n+            // Form submit edilirse loading'i geri al\r\n+            setTimeout(() => {\r\n+                submitBtn.innerHTML = originalText;\r\n+                submitBtn.disabled = false;\r\n+            }, 3000);\r\n+        });\r\n+    }\r\n     \r\n     // Tarih değişikliklerinde otomatik validasyon\r\n-    [startDateInput, endDateInput].forEach(input => {\r\n-        input.addEventListener('change', validateDates);\r\n-    });\r\n+    if (startDateInput && endDateInput) {\r\n+        [startDateInput, endDateInput].forEach(input => {\r\n+            input.addEventListener('change', validateDates);\r\n+        });\r\n+    }\r\n     \r\n     // Dropdown değişikliklerinde otomatik filtreleme (opsiyonel)\r\n-    outletDurumSelect.addEventListener('change', function() {\r\n-        // Eğer kullanıcı dropdown'dan seçim yaparsa otomatik filtreleme yapabilir\r\n-        // Bu özellik istenirse aktif edilebilir\r\n-        // document.getElementById('filterForm').submit();\r\n-    });\r\n+    if (outletDurumSelect) {\r\n+        outletDurumSelect.addEventListener('change', function() {\r\n+            // Eğer kullanıcı dropdown'dan seçim yaparsa otomatik filtreleme yapabilir\r\n+            // Bu özellik istenirse aktif edilebilir\r\n+            // document.getElementById('filterForm').submit();\r\n+        });\r\n+    }\r\n     \r\n-    teyitDurumSelect.addEventListener('change', function() {\r\n-        // Eğer kullanıcı dropdown'dan seçim yaparsa otomatik filtreleme yapabilir\r\n-        // Bu özellik istenirse aktif edilebilir\r\n-        // document.getElementById('filterForm').submit();\r\n-    });\r\n+    if (teyitDurumSelect) {\r\n+        teyitDurumSelect.addEventListener('change', function() {\r\n+            // Eğer kullanıcı dropdown'dan seçim yaparsa otomatik filtreleme yapabilir\r\n+            // Bu özellik istenirse aktif edilebilir\r\n+            // document.getElementById('filterForm').submit();\r\n+        });\r\n+    }\r\n     \r\n-    // Hakediş dönemi değişikliğinde otomatik tarih güncelleme\r\n-    hakedisDonemiSelect.addEventListener('change', function() {\r\n-        const selectedDonem = this.value;\r\n-        \r\n-        if (selectedDonem && hakedisDonemleri[selectedDonem]) {\r\n-            // Hakediş dönemi seçildiyse tarih alanlarını otomatik doldur ve readonly yap\r\n-            startDateInput.value = hakedisDonemleri[selectedDonem].start;\r\n-            endDateInput.value = hakedisDonemleri[selectedDonem].end;\r\n-            startDateInput.readOnly = true;\r\n-            endDateInput.readOnly = true;\r\n+    // Hakediş dönemi değişikliğinde otomatik tarih güncelleme (eğer filtre formu varsa)\r\n+    if (hakedisDonemiSelect) {\r\n+        hakedisDonemiSelect.addEventListener('change', function() {\r\n+            const selectedDonem = this.value;\r\n             \r\n-            // Hızlı tarih butonlarını devre dışı bırak\r\n-            const quickDateBtns = document.querySelectorAll('[onclick^=\"setDateRange\"]');\r\n-            quickDateBtns.forEach(btn => btn.disabled = true);\r\n+            if (selectedDonem && hakedisDonemleri[selectedDonem] && startDateInput && endDateInput) {\r\n+                // Hakediş dönemi seçildiyse tarih alanlarını otomatik doldur ve readonly yap\r\n+                startDateInput.value = hakedisDonemleri[selectedDonem].start;\r\n+                endDateInput.value = hakedisDonemleri[selectedDonem].end;\r\n+                startDateInput.readOnly = true;\r\n+                endDateInput.readOnly = true;\r\n+                \r\n+                // Hızlı tarih butonlarını devre dışı bırak\r\n+                const quickDateBtns = document.querySelectorAll('[onclick^=\"setDateRange\"]');\r\n+                quickDateBtns.forEach(btn => btn.disabled = true);\r\n+                \r\n+            } else if (startDateInput && endDateInput) {\r\n+                // Manuel seçim yapıldıysa tarih alanlarını düzenlenebilir yap\r\n+                startDateInput.readOnly = false;\r\n+                endDateInput.readOnly = false;\r\n+                \r\n+                // Hızlı tarih butonlarını aktif et\r\n+                const quickDateBtns = document.querySelectorAll('[onclick^=\"setDateRange\"]');\r\n+                quickDateBtns.forEach(btn => btn.disabled = false);\r\n+            }\r\n             \r\n-        } else {\r\n-            // Manuel seçim yapıldıysa tarih alanlarını düzenlenebilir yap\r\n-            startDateInput.readOnly = false;\r\n-            endDateInput.readOnly = false;\r\n-            \r\n-            // Hızlı tarih butonlarını aktif et\r\n-            const quickDateBtns = document.querySelectorAll('[onclick^=\"setDateRange\"]');\r\n-            quickDateBtns.forEach(btn => btn.disabled = false);\r\n-        }\r\n-        \r\n-        // Otomatik form submit (opsiyonel)\r\n-        // document.getElementById('filterForm').submit();\r\n-    });\r\n+            // Otomatik form submit (opsiyonel)\r\n+            // document.getElementById('filterForm').submit();\r\n+        });\r\n+    }\r\n     \r\n     // Enter tuşu ile form submit\r\n-    [startDateInput, endDateInput].forEach(input => {\r\n-        input.addEventListener('keypress', function(e) {\r\n-            if (e.key === 'Enter') {\r\n-                if (validateDates()) {\r\n-                    document.getElementById('filterForm').submit();\r\n+    if (startDateInput && endDateInput) {\r\n+        [startDateInput, endDateInput].forEach(input => {\r\n+            input.addEventListener('keypress', function(e) {\r\n+                if (e.key === 'Enter') {\r\n+                    if (validateDates()) {\r\n+                        document.getElementById('filterForm').submit();\r\n+                    }\r\n                 }\r\n-            }\r\n+            });\r\n         });\r\n-    });\r\n+    }\r\n });\r\n \r\n // Yazdırma için CSS\r\n const printStyles = `\r\n"
                },
                {
                    "date": 1760454189027,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -60,26 +60,67 @@\n         // Hata durumunda boş dizi kullan\r\n         $hakedisDonemleri = [];\r\n     }\r\n \r\n-    // Alt bayileri al (users_bayi tablosundan)\r\n+    // Alt bayileri al - önce iris_rapor'dan mevcut bayileri kontrol et\r\n     try {\r\n+        // Önce users_bayi tablosundan dene\r\n         $altBayiSql = \"SELECT ub.id, ub.user_id, u.username as bayi_adi FROM users_bayi ub \r\n                        INNER JOIN users u ON ub.user_id = u.id \r\n                        ORDER BY u.username\";\r\n         $altBayiStmt = $conn->prepare($altBayiSql);\r\n         $altBayiStmt->execute();\r\n         $altBayiResult = $altBayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n         \r\n-        foreach ($altBayiResult as $bayi) {\r\n-            $altBayiList[$bayi['user_id']] = [\r\n-                'id' => $bayi['id'],\r\n-                'user_id' => $bayi['user_id'],\r\n-                'bayi_adi' => $bayi['bayi_adi']\r\n-            ];\r\n+        if (!empty($altBayiResult)) {\r\n+            foreach ($altBayiResult as $bayi) {\r\n+                $altBayiList[$bayi['user_id']] = [\r\n+                    'id' => $bayi['id'],\r\n+                    'user_id' => $bayi['user_id'],\r\n+                    'bayi_adi' => $bayi['bayi_adi']\r\n+                ];\r\n+            }\r\n+        } else {\r\n+            // Eğer users_bayi tablosu boşsa, iris_rapor'dan al\r\n+            $irisBayiSql = \"SELECT DISTINCT TALEBI_GIREN_PERSONEL_ALTBAYI as bayi_adi \r\n+                           FROM iris_rapor \r\n+                           WHERE TALEBI_GIREN_PERSONEL_ALTBAYI IS NOT NULL \r\n+                           AND TALEBI_GIREN_PERSONEL_ALTBAYI != ''\r\n+                           ORDER BY TALEBI_GIREN_PERSONEL_ALTBAYI\";\r\n+            $irisBayiStmt = $conn->prepare($irisBayiSql);\r\n+            $irisBayiStmt->execute();\r\n+            $irisBayiResult = $irisBayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+            \r\n+            foreach ($irisBayiResult as $index => $bayi) {\r\n+                $altBayiList[$bayi['bayi_adi']] = [\r\n+                    'id' => $index + 1,\r\n+                    'user_id' => $bayi['bayi_adi'],\r\n+                    'bayi_adi' => $bayi['bayi_adi']\r\n+                ];\r\n+            }\r\n         }\r\n     } catch (Exception $e) {\r\n-        $altBayiList = [];\r\n+        // Hata durumunda iris_rapor'dan al\r\n+        try {\r\n+            $irisBayiSql = \"SELECT DISTINCT TALEBI_GIREN_PERSONEL_ALTBAYI as bayi_adi \r\n+                           FROM iris_rapor \r\n+                           WHERE TALEBI_GIREN_PERSONEL_ALTBAYI IS NOT NULL \r\n+                           AND TALEBI_GIREN_PERSONEL_ALTBAYI != ''\r\n+                           ORDER BY TALEBI_GIREN_PERSONEL_ALTBAYI\";\r\n+            $irisBayiStmt = $conn->prepare($irisBayiSql);\r\n+            $irisBayiStmt->execute();\r\n+            $irisBayiResult = $irisBayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+            \r\n+            foreach ($irisBayiResult as $index => $bayi) {\r\n+                $altBayiList[$bayi['bayi_adi']] = [\r\n+                    'id' => $index + 1,\r\n+                    'user_id' => $bayi['bayi_adi'],\r\n+                    'bayi_adi' => $bayi['bayi_adi']\r\n+                ];\r\n+            }\r\n+        } catch (Exception $e2) {\r\n+            $altBayiList = [];\r\n+        }\r\n     }\r\n \r\n     // Hakediş hesaplama yapılacaksa\r\n     if ($hesaplamaYap && !empty($hakedisDonemi) && !empty($altBayi)) {\r\n@@ -88,79 +129,164 @@\n             $selectedDonem = $hakedisDonemleri[$hakedisDonemi] ?? null;\r\n             $selectedBayi = $altBayiList[$altBayi] ?? null;\r\n             \r\n             if ($selectedDonem && $selectedBayi) {\r\n-                // Hakediş tanım fiyatlarını al\r\n-                $hakedisQuery = \"SELECT isp_neo_fiyat, isp_uydu_fiyat, neo_fiyat, uydu_fiyat \r\n-                                FROM hakedis_tanim \r\n-                                WHERE bayi_hakedis_prim_donem_id = ? AND bayi_id = ?\";\r\n-                $hakedisStmt = $conn->prepare($hakedisQuery);\r\n-                $hakedisStmt->execute([$hakedisDonemi, $altBayi]);\r\n-                $hakedisData = $hakedisStmt->fetch(PDO::FETCH_ASSOC);\r\n+                // Bayi ID'sini doğru şekilde al - çoklu yöntem\r\n+                $bayiId = null;\r\n+                $debugInfo = [];\r\n                 \r\n-                if ($hakedisData) {\r\n-                    // Dönem tarih aralığında işlem sayılarını hesapla\r\n-                    $startDateCalc = $selectedDonem['start'];\r\n-                    $endDateCalc = $selectedDonem['end'];\r\n+                // Yöntem 1: Doğrudan user_id kontrolü\r\n+                if (isset($selectedBayi['user_id']) && is_numeric($selectedBayi['user_id'])) {\r\n+                    $bayiId = $selectedBayi['user_id'];\r\n+                    $debugInfo[] = \"user_id kullanıldı: \" . $bayiId;\r\n+                }\r\n+                \r\n+                // Yöntem 2: String user_id'yi integer'a çevir\r\n+                if (!$bayiId && isset($selectedBayi['user_id']) && !is_numeric($selectedBayi['user_id'])) {\r\n+                    // Bayi adı seçilmiş, users tablosundan ID bul\r\n+                    try {\r\n+                        $findBayiQuery = \"SELECT id FROM users WHERE username = ?\";\r\n+                        $findBayiStmt = $conn->prepare($findBayiQuery);\r\n+                        $findBayiStmt->execute([$selectedBayi['user_id']]);\r\n+                        $bayiResult = $findBayiStmt->fetch(PDO::FETCH_ASSOC);\r\n+                        if ($bayiResult) {\r\n+                            $bayiId = $bayiResult['id'];\r\n+                            $debugInfo[] = \"username ile bulundu: \" . $selectedBayi['user_id'] . \" -> \" . $bayiId;\r\n+                        }\r\n+                    } catch (Exception $e) {\r\n+                        $debugInfo[] = \"username sorgusu hatası: \" . $e->getMessage();\r\n+                    }\r\n+                }\r\n+                \r\n+                // Yöntem 3: bayi_adi ile users tablosunda ara\r\n+                if (!$bayiId && isset($selectedBayi['bayi_adi'])) {\r\n+                    try {\r\n+                        $findBayiQuery2 = \"SELECT id FROM users WHERE username = ?\";\r\n+                        $findBayiStmt2 = $conn->prepare($findBayiQuery2);\r\n+                        $findBayiStmt2->execute([$selectedBayi['bayi_adi']]);\r\n+                        $bayiResult2 = $findBayiStmt2->fetch(PDO::FETCH_ASSOC);\r\n+                        if ($bayiResult2) {\r\n+                            $bayiId = $bayiResult2['id'];\r\n+                            $debugInfo[] = \"bayi_adi ile bulundu: \" . $selectedBayi['bayi_adi'] . \" -> \" . $bayiId;\r\n+                        }\r\n+                    } catch (Exception $e) {\r\n+                        $debugInfo[] = \"bayi_adi sorgusu hatası: \" . $e->getMessage();\r\n+                    }\r\n+                }\r\n+                \r\n+                // Yöntem 4: users_bayi tablosundan doğrudan kontrol\r\n+                if (!$bayiId) {\r\n+                    try {\r\n+                        $findBayiQuery3 = \"SELECT ub.user_id, u.username FROM users_bayi ub \r\n+                                          INNER JOIN users u ON ub.user_id = u.id \r\n+                                          WHERE u.username = ? OR u.username = ?\";\r\n+                        $findBayiStmt3 = $conn->prepare($findBayiQuery3);\r\n+                        $findBayiStmt3->execute([\r\n+                            $selectedBayi['bayi_adi'] ?? '', \r\n+                            $selectedBayi['user_id'] ?? ''\r\n+                        ]);\r\n+                        $bayiResult3 = $findBayiStmt3->fetch(PDO::FETCH_ASSOC);\r\n+                        if ($bayiResult3) {\r\n+                            $bayiId = $bayiResult3['user_id'];\r\n+                            $debugInfo[] = \"users_bayi ile bulundu: \" . $bayiResult3['username'] . \" -> \" . $bayiId;\r\n+                        }\r\n+                    } catch (Exception $e) {\r\n+                        $debugInfo[] = \"users_bayi sorgusu hatası: \" . $e->getMessage();\r\n+                    }\r\n+                }\r\n+                \r\n+                if (!$bayiId) {\r\n+                    $error = \"Bayi ID'si bulunamadı. Seçilen bayi: \" . \r\n+                             json_encode($selectedBayi) . \r\n+                             \". Debug: \" . implode('; ', $debugInfo) . \r\n+                             \". Lütfen hakediş tanımlarında bu bayi için kayıt oluşturun.\";\r\n+                } else {\r\n+                    // Hakediş tanım fiyatlarını al - önce user_id ile dene\r\n+                    $hakedisQuery = \"SELECT isp_neo_fiyat, isp_uydu_fiyat, neo_fiyat, uydu_fiyat \r\n+                                    FROM hakedis_tanim \r\n+                                    WHERE bayi_hakedis_prim_donem_id = ? AND bayi_id = ?\";\r\n+                    $hakedisStmt = $conn->prepare($hakedisQuery);\r\n+                    $hakedisStmt->execute([$hakedisDonemi, $bayiId]);\r\n+                    $hakedisData = $hakedisStmt->fetch(PDO::FETCH_ASSOC);\r\n                     \r\n-                    // İşlem sayılarını hesapla\r\n-                    $countQuery = \"\r\n-                        SELECT \r\n-                            SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'ISP ve Neo Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_NEO_COUNT,\r\n-                            SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'Uydu ve ISP Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_UYDU_COUNT,\r\n-                            SUM(CASE WHEN MEMO_KAYIT_TIPI = 'NEO' THEN 1 ELSE 0 END) as NEO_COUNT,\r\n-                            SUM(CASE WHEN MEMO_KAYIT_TIPI = 'UYDU' THEN 1 ELSE 0 END) as UYDU_COUNT\r\n-                        FROM iris_rapor \r\n-                        WHERE MEMO_KAPANIS_TARIHI >= ? \r\n-                        AND MEMO_KAPANIS_TARIHI <= ?\r\n-                        AND TALEBI_GIREN_PERSONEL_ALTBAYI = ?\r\n-                        AND GUNCEL_OUTLET_DURUM = 'AKTIF'\r\n-                        AND TEYIT_DURUM = 'ONAYLANDI'\r\n-                    \";\r\n-                    \r\n-                    $countStmt = $conn->prepare($countQuery);\r\n-                    $countStmt->execute([\r\n-                        $startDateCalc . ' 00:00:00',\r\n-                        $endDateCalc . ' 23:59:59',\r\n-                        $selectedBayi['bayi_adi']\r\n-                    ]);\r\n-                    $counts = $countStmt->fetch(PDO::FETCH_ASSOC);\r\n-                    \r\n-                    // Hakediş hesaplama\r\n-                    $hakedisResult = [\r\n-                        'donem_info' => $selectedDonem,\r\n-                        'bayi_info' => $selectedBayi,\r\n-                        'fiyatlar' => $hakedisData,\r\n-                        'islem_sayilari' => $counts,\r\n-                        'hesaplamalar' => [\r\n-                            'ISP_NEO' => [\r\n-                                'adet' => $counts['ISP_NEO_COUNT'] ?? 0,\r\n-                                'birim_fiyat' => $hakedisData['isp_neo_fiyat'] ?? 0,\r\n-                                'toplam' => ($counts['ISP_NEO_COUNT'] ?? 0) * ($hakedisData['isp_neo_fiyat'] ?? 0)\r\n-                            ],\r\n-                            'ISP_UYDU' => [\r\n-                                'adet' => $counts['ISP_UYDU_COUNT'] ?? 0,\r\n-                                'birim_fiyat' => $hakedisData['isp_uydu_fiyat'] ?? 0,\r\n-                                'toplam' => ($counts['ISP_UYDU_COUNT'] ?? 0) * ($hakedisData['isp_uydu_fiyat'] ?? 0)\r\n-                            ],\r\n-                            'NEO' => [\r\n-                                'adet' => $counts['NEO_COUNT'] ?? 0,\r\n-                                'birim_fiyat' => $hakedisData['neo_fiyat'] ?? 0,\r\n-                                'toplam' => ($counts['NEO_COUNT'] ?? 0) * ($hakedisData['neo_fiyat'] ?? 0)\r\n-                            ],\r\n-                            'UYDU' => [\r\n-                                'adet' => $counts['UYDU_COUNT'] ?? 0,\r\n-                                'birim_fiyat' => $hakedisData['uydu_fiyat'] ?? 0,\r\n-                                'toplam' => ($counts['UYDU_COUNT'] ?? 0) * ($hakedisData['uydu_fiyat'] ?? 0)\r\n+                    // Eğer user_id ile bulunamadıysa, doğrudan bayi adıyla join dene\r\n+                    if (!$hakedisData) {\r\n+                        $hakedisQuery2 = \"SELECT ht.isp_neo_fiyat, ht.isp_uydu_fiyat, ht.neo_fiyat, ht.uydu_fiyat \r\n+                                         FROM hakedis_tanim ht\r\n+                                         INNER JOIN users u ON ht.bayi_id = u.id\r\n+                                         WHERE ht.bayi_hakedis_prim_donem_id = ? AND u.username = ?\";\r\n+                        $hakedisStmt2 = $conn->prepare($hakedisQuery2);\r\n+                        $hakedisStmt2->execute([$hakedisDonemi, $selectedBayi['bayi_adi']]);\r\n+                        $hakedisData = $hakedisStmt2->fetch(PDO::FETCH_ASSOC);\r\n+                    }\r\n+                \r\n+                    if ($hakedisData) {\r\n+                        // Dönem tarih aralığında işlem sayılarını hesapla\r\n+                        $startDateCalc = $selectedDonem['start'];\r\n+                        $endDateCalc = $selectedDonem['end'];\r\n+                        \r\n+                        // İşlem sayılarını hesapla\r\n+                        $countQuery = \"\r\n+                            SELECT \r\n+                                SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'ISP ve Neo Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_NEO_COUNT,\r\n+                                SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'Uydu ve ISP Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_UYDU_COUNT,\r\n+                                SUM(CASE WHEN MEMO_KAYIT_TIPI = 'NEO' THEN 1 ELSE 0 END) as NEO_COUNT,\r\n+                                SUM(CASE WHEN MEMO_KAYIT_TIPI = 'UYDU' THEN 1 ELSE 0 END) as UYDU_COUNT\r\n+                            FROM iris_rapor \r\n+                            WHERE MEMO_KAPANIS_TARIHI >= ? \r\n+                            AND MEMO_KAPANIS_TARIHI <= ?\r\n+                            AND TALEBI_GIREN_PERSONEL_ALTBAYI = ?\r\n+                            AND GUNCEL_OUTLET_DURUM = 'AKTIF'\r\n+                            AND TEYIT_DURUM = 'ONAYLANDI'\r\n+                        \";\r\n+                        \r\n+                        // Bayi adını doğru şekilde al\r\n+                        $bayiAdi = $selectedBayi['bayi_adi'];\r\n+                        \r\n+                        $countStmt = $conn->prepare($countQuery);\r\n+                        $countStmt->execute([\r\n+                            $startDateCalc . ' 00:00:00',\r\n+                            $endDateCalc . ' 23:59:59',\r\n+                            $bayiAdi\r\n+                        ]);\r\n+                        $counts = $countStmt->fetch(PDO::FETCH_ASSOC);\r\n+                        \r\n+                        // Hakediş hesaplama\r\n+                        $hakedisResult = [\r\n+                            'donem_info' => $selectedDonem,\r\n+                            'bayi_info' => $selectedBayi,\r\n+                            'fiyatlar' => $hakedisData,\r\n+                            'islem_sayilari' => $counts,\r\n+                            'hesaplamalar' => [\r\n+                                'ISP_NEO' => [\r\n+                                    'adet' => $counts['ISP_NEO_COUNT'] ?? 0,\r\n+                                    'birim_fiyat' => $hakedisData['isp_neo_fiyat'] ?? 0,\r\n+                                    'toplam' => ($counts['ISP_NEO_COUNT'] ?? 0) * ($hakedisData['isp_neo_fiyat'] ?? 0)\r\n+                                ],\r\n+                                'ISP_UYDU' => [\r\n+                                    'adet' => $counts['ISP_UYDU_COUNT'] ?? 0,\r\n+                                    'birim_fiyat' => $hakedisData['isp_uydu_fiyat'] ?? 0,\r\n+                                    'toplam' => ($counts['ISP_UYDU_COUNT'] ?? 0) * ($hakedisData['isp_uydu_fiyat'] ?? 0)\r\n+                                ],\r\n+                                'NEO' => [\r\n+                                    'adet' => $counts['NEO_COUNT'] ?? 0,\r\n+                                    'birim_fiyat' => $hakedisData['neo_fiyat'] ?? 0,\r\n+                                    'toplam' => ($counts['NEO_COUNT'] ?? 0) * ($hakedisData['neo_fiyat'] ?? 0)\r\n+                                ],\r\n+                                'UYDU' => [\r\n+                                    'adet' => $counts['UYDU_COUNT'] ?? 0,\r\n+                                    'birim_fiyat' => $hakedisData['uydu_fiyat'] ?? 0,\r\n+                                    'toplam' => ($counts['UYDU_COUNT'] ?? 0) * ($hakedisData['uydu_fiyat'] ?? 0)\r\n+                                ]\r\n                             ]\r\n-                        ]\r\n-                    ];\r\n-                    \r\n-                    // Genel toplam hesapla\r\n-                    $hakedisResult['genel_toplam'] = array_sum(array_column($hakedisResult['hesaplamalar'], 'toplam'));\r\n-                    \r\n-                } else {\r\n-                    $error = \"Seçilen dönem ve bayi için hakediş tanımı bulunamadı.\";\r\n+                        ];\r\n+                        \r\n+                        // Genel toplam hesapla\r\n+                        $hakedisResult['genel_toplam'] = array_sum(array_column($hakedisResult['hesaplamalar'], 'toplam'));\r\n+                        \r\n+                    } else {\r\n+                        $error = \"Seçilen dönem (ID: $hakedisDonemi) ve bayi ('{$selectedBayi['bayi_adi']}' - ID: $bayiId) için hakediş tanımı bulunamadı. Lütfen hakediş tanımlarını kontrol edin.\";\r\n+                    }\r\n                 }\r\n             } else {\r\n                 $error = \"Geçersiz dönem veya bayi seçimi.\";\r\n             }\r\n@@ -405,20 +531,35 @@\n                         </select>\r\n                     </div>\r\n                     <div class=\"col-md-4\">\r\n                         <label for=\"alt_bayi_calc\" class=\"form-label\">\r\n-                            <i class=\"fas fa-user-tie me-1\"></i>Alt Bayi *\r\n+                            <i class=\"fas fa-user-tie me-1\"></i>Alt Bayi * \r\n+                            <?php if (empty($altBayiList)): ?>\r\n+                                <small class=\"text-danger\">(Bayi bulunamadı)</small>\r\n+                            <?php else: ?>\r\n+                                <small class=\"text-success\">(<?php echo count($altBayiList); ?> bayi)</small>\r\n+                            <?php endif; ?>\r\n                         </label>\r\n                         <select class=\"form-select\" id=\"alt_bayi_calc\" name=\"alt_bayi\" required>\r\n                             <option value=\"\">Bayi Seçiniz</option>\r\n-                            <?php foreach ($altBayiList as $user_id => $bayi): ?>\r\n-                                <option value=\"<?php echo $user_id; ?>\" \r\n-                                        <?php echo $altBayi == $user_id ? 'selected' : ''; ?>>\r\n-                                    <?php echo htmlspecialchars($bayi['bayi_adi']); ?>\r\n-                                    (ID: <?php echo $bayi['id']; ?>)\r\n-                                </option>\r\n-                            <?php endforeach; ?>\r\n+                            <?php if (!empty($altBayiList)): ?>\r\n+                                <?php foreach ($altBayiList as $user_id => $bayi): ?>\r\n+                                    <option value=\"<?php echo htmlspecialchars($user_id); ?>\" \r\n+                                            <?php echo $altBayi == $user_id ? 'selected' : ''; ?>>\r\n+                                        <?php echo htmlspecialchars($bayi['bayi_adi']); ?>\r\n+                                        (ID: <?php echo $bayi['id']; ?>)\r\n+                                    </option>\r\n+                                <?php endforeach; ?>\r\n+                            <?php else: ?>\r\n+                                <option value=\"\" disabled>Bayi bulunamadı - Lütfen veri yükleyin</option>\r\n+                            <?php endif; ?>\r\n                         </select>\r\n+                        <?php if (empty($altBayiList)): ?>\r\n+                            <div class=\"form-text text-muted\">\r\n+                                <i class=\"fas fa-info-circle me-1\"></i>\r\n+                                Alt bayi listesi boş. Lütfen önce IRIS raporlarını yükleyin.\r\n+                            </div>\r\n+                        <?php endif; ?>\r\n                     </div>\r\n                     <div class=\"col-md-4\">\r\n                         <button type=\"submit\" class=\"btn btn-success btn-lg w-100\">\r\n                             <i class=\"fas fa-calculator me-1\"></i>Hakediş Hesapla\r\n@@ -898,14 +1039,161 @@\n             </div>\r\n         </div>\r\n     </div>\r\n \r\n+    <!-- Debug Bilgileri (Geliştirme amaçlı) -->\r\n+    <?php if (empty($altBayiList) && !isset($error)): ?>\r\n+    <div class=\"alert alert-warning\">\r\n+        <h6><i class=\"fas fa-database me-2\"></i>Veritabanı Durumu</h6>\r\n+        <p class=\"mb-2\"><strong>Alt Bayi Listesi:</strong> Boş (<?php echo count($altBayiList); ?> kayıt)</p>\r\n+        <p class=\"mb-2\"><strong>Hakediş Dönemleri:</strong> <?php echo count($hakedisDonemleri); ?> dönem</p>\r\n+        \r\n+        <div class=\"mt-3\">\r\n+            <h6>Olası Çözümler:</h6>\r\n+            <ul class=\"mb-0\">\r\n+                <li>IRIS raporlarının yüklenmiş olduğundan emin olun</li>\r\n+                <li><code>users_bayi</code> tablosunda kayıt bulunduğundan emin olun</li>\r\n+                <li><code>iris_rapor</code> tablosunda <code>TALEBI_GIREN_PERSONEL_ALTBAYI</code> verisi olduğundan emin olun</li>\r\n+            </ul>\r\n+        </div>\r\n+    </div>\r\n+    <?php endif; ?>\r\n+\r\n+    <!-- Bayi ID Bulunamadı Hatası için Debug -->\r\n+    <?php if (isset($error) && strpos($error, 'Bayi ID\\'si bulunamadı') !== false): ?>\r\n+    <div class=\"alert alert-warning\">\r\n+        <h6><i class=\"fas fa-exclamation-triangle me-2\"></i>Bayi ID Bulunamadı - Debug Bilgisi</h6>\r\n+        <div class=\"mb-3\">\r\n+            <strong>Seçilen Parametreler:</strong>\r\n+            <ul>\r\n+                <li><strong>Alt Bayi Parametresi:</strong> <?php echo htmlspecialchars($altBayi ?? 'Boş'); ?></li>\r\n+                <li><strong>Hakediş Dönemi:</strong> <?php echo htmlspecialchars($hakedisDonemi ?? 'Boş'); ?></li>\r\n+            </ul>\r\n+        </div>\r\n+        \r\n+        <?php\r\n+        // Mevcut users tablosunu kontrol et\r\n+        try {\r\n+            echo \"<div class='mt-3'>\";\r\n+            echo \"<h6>Mevcut Users Tablosu:</h6>\";\r\n+            $usersQuery = \"SELECT TOP 10 id, username FROM users ORDER BY id\";\r\n+            $usersStmt = $conn->prepare($usersQuery);\r\n+            $usersStmt->execute();\r\n+            $usersResult = $usersStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+            \r\n+            if (!empty($usersResult)) {\r\n+                echo \"<ul>\";\r\n+                foreach ($usersResult as $user) {\r\n+                    echo \"<li>ID: {$user['id']} - Username: {$user['username']}</li>\";\r\n+                }\r\n+                echo \"</ul>\";\r\n+            } else {\r\n+                echo \"<p class='text-danger'>Users tablosu boş!</p>\";\r\n+            }\r\n+            echo \"</div>\";\r\n+            \r\n+            // users_bayi tablosunu kontrol et\r\n+            echo \"<div class='mt-3'>\";\r\n+            echo \"<h6>Mevcut Users_Bayi Tablosu:</h6>\";\r\n+            $usersBayiQuery = \"SELECT TOP 10 ub.id, ub.user_id, u.username FROM users_bayi ub \r\n+                              LEFT JOIN users u ON ub.user_id = u.id ORDER BY ub.id\";\r\n+            $usersBayiStmt = $conn->prepare($usersBayiQuery);\r\n+            $usersBayiStmt->execute();\r\n+            $usersBayiResult = $usersBayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+            \r\n+            if (!empty($usersBayiResult)) {\r\n+                echo \"<ul>\";\r\n+                foreach ($usersBayiResult as $ub) {\r\n+                    echo \"<li>Bayi ID: {$ub['id']} - User ID: {$ub['user_id']} - Username: {$ub['username']}</li>\";\r\n+                }\r\n+                echo \"</ul>\";\r\n+            } else {\r\n+                echo \"<p class='text-danger'>Users_Bayi tablosu boş!</p>\";\r\n+            }\r\n+            echo \"</div>\";\r\n+            \r\n+        } catch (Exception $e) {\r\n+            echo \"<p class='text-danger'>Debug sorgusu hatası: \" . $e->getMessage() . \"</p>\";\r\n+        }\r\n+        ?>\r\n+        \r\n+        <div class=\"mt-3\">\r\n+            <h6>Çözüm Önerileri:</h6>\r\n+            <ol>\r\n+                <li><strong>users</strong> tablosunda bayi kullanıcısının kayıt olduğundan emin olun</li>\r\n+                <li><strong>users_bayi</strong> tablosunda bu kullanıcı için kayıt oluşturun</li>\r\n+                <li><strong>hakedis_tanim</strong> tablosunda bu bayi ve dönem için fiyat tanımı yapın</li>\r\n+            </ol>\r\n+        </div>\r\n+    </div>\r\n+    <?php endif; ?>\r\n+    <div class=\"alert alert-info\">\r\n+        <h6><i class=\"fas fa-info-circle me-2\"></i>Hakediş Tanım Kontrol</h6>\r\n+        <?php\r\n+        try {\r\n+            $debugQuery = \"SELECT ht.*, u.username, bhpd.donem_adi \r\n+                          FROM hakedis_tanim ht \r\n+                          LEFT JOIN users u ON ht.bayi_id = u.id \r\n+                          LEFT JOIN bayi_hakedis_prim_donem bhpd ON ht.bayi_hakedis_prim_donem_id = bhpd.id\r\n+                          WHERE ht.bayi_hakedis_prim_donem_id = ?\";\r\n+            $debugStmt = $conn->prepare($debugQuery);\r\n+            $debugStmt->execute([$hakedisDonemi]);\r\n+            $debugResults = $debugStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+            \r\n+            if (!empty($debugResults)) {\r\n+                echo \"<p><strong>Bu dönem için mevcut hakediş tanımları:</strong></p>\";\r\n+                echo \"<ul>\";\r\n+                foreach ($debugResults as $debug) {\r\n+                    echo \"<li>Bayi ID: {$debug['bayi_id']} - {$debug['username']} - Dönem: {$debug['donem_adi']}</li>\";\r\n+                }\r\n+                echo \"</ul>\";\r\n+            } else {\r\n+                echo \"<p class='text-danger'>Bu dönem için hiç hakediş tanımı bulunamadı.</p>\";\r\n+            }\r\n+        } catch (Exception $e) {\r\n+            echo \"<p class='text-danger'>Debug sorgusu hatası: \" . $e->getMessage() . \"</p>\";\r\n+        }\r\n+        ?>\r\n+    </div>\r\n+\r\n+    <!-- Hakediş Tanım Kontrolü -->\r\n+    <?php if (!empty($hakedisDonemi) && !empty($altBayi) && $hesaplamaYap && isset($error) && strpos($error, 'hakediş tanımı bulunamadı') !== false): ?>\r\n+    <div class=\"alert alert-info\">\r\n+        <h6><i class=\"fas fa-info-circle me-2\"></i>Hakediş Tanım Kontrol</h6>\r\n+        <?php\r\n+        try {\r\n+            $debugQuery = \"SELECT ht.*, u.username, bhpd.donem_adi \r\n+                          FROM hakedis_tanim ht \r\n+                          LEFT JOIN users u ON ht.bayi_id = u.id \r\n+                          LEFT JOIN bayi_hakedis_prim_donem bhpd ON ht.bayi_hakedis_prim_donem_id = bhpd.id\r\n+                          WHERE ht.bayi_hakedis_prim_donem_id = ?\";\r\n+            $debugStmt = $conn->prepare($debugQuery);\r\n+            $debugStmt->execute([$hakedisDonemi]);\r\n+            $debugResults = $debugStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+            \r\n+            if (!empty($debugResults)) {\r\n+                echo \"<p><strong>Bu dönem için mevcut hakediş tanımları:</strong></p>\";\r\n+                echo \"<ul>\";\r\n+                foreach ($debugResults as $debug) {\r\n+                    echo \"<li>Bayi ID: {$debug['bayi_id']} - {$debug['username']} - Dönem: {$debug['donem_adi']}</li>\";\r\n+                }\r\n+                echo \"</ul>\";\r\n+            } else {\r\n+                echo \"<p class='text-danger'>Bu dönem için hiç hakediş tanımı bulunamadı.</p>\";\r\n+            }\r\n+        } catch (Exception $e) {\r\n+            echo \"<p class='text-danger'>Debug sorgusu hatası: \" . $e->getMessage() . \"</p>\";\r\n+        }\r\n+        ?>\r\n+    </div>\r\n+    <?php endif; ?>\r\n+\r\n     <?php if (isset($error)): ?>\r\n         <div class=\"alert alert-danger\">\r\n             <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n             <?php echo htmlspecialchars($error); ?>\r\n         </div>\r\n-    <?php else: ?>\r\n+    <?php endif; ?>\r\n         \r\n         <!-- Ana Rapor Tablosu -->\r\n         <div class=\"card border-0 shadow-sm\">\r\n             <div class=\"card-header bg-primary text-white\">\r\n@@ -1107,9 +1395,8 @@\n             </div>\r\n         </div>\r\n         <?php endif; ?>\r\n \r\n-    <?php endif; ?>\r\n </div>\r\n \r\n <!-- Bootstrap JS -->\r\n <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\r\n"
                },
                {
                    "date": 1760456491392,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -43,9 +43,9 @@\n     $conn = getDatabaseConnection();\r\n     \r\n     // Hakediş dönemlerini al\r\n     try {\r\n-        $hakedisDonemiSql = \"SELECT id, donem_adi, baslangic_tarihi, bitis_tarihi FROM bayi_hakedis_prim_donem ORDER BY baslangic_tarihi DESC\";\r\n+        $hakedisDonemiSql = \"SELECT id, donem_adi, baslangic_tarihi, bitis_tarihi FROM digiturk.bayi_hakedis_prim_donem ORDER BY baslangic_tarihi DESC\";\r\n         $hakedisDonemiStmt = $conn->prepare($hakedisDonemiSql);\r\n         $hakedisDonemiStmt->execute();\r\n         $hakedisDonemiResult = $hakedisDonemiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n         \r\n@@ -63,11 +63,11 @@\n \r\n     // Alt bayileri al - önce iris_rapor'dan mevcut bayileri kontrol et\r\n     try {\r\n         // Önce users_bayi tablosundan dene\r\n-        $altBayiSql = \"SELECT ub.id, ub.user_id, u.username as bayi_adi FROM users_bayi ub \r\n+        $altBayiSql = \"SELECT ub.id, ub.user_id, (u.first_name + ' ' + u.last_name) as bayi_adi FROM users_bayi ub \r\n                        INNER JOIN users u ON ub.user_id = u.id \r\n-                       ORDER BY u.username\";\r\n+                       ORDER BY u.first_name, u.last_name\";\r\n         $altBayiStmt = $conn->prepare($altBayiSql);\r\n         $altBayiStmt->execute();\r\n         $altBayiResult = $altBayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n         \r\n@@ -81,9 +81,9 @@\n             }\r\n         } else {\r\n             // Eğer users_bayi tablosu boşsa, iris_rapor'dan al\r\n             $irisBayiSql = \"SELECT DISTINCT TALEBI_GIREN_PERSONEL_ALTBAYI as bayi_adi \r\n-                           FROM iris_rapor \r\n+                           FROM digiturk.iris_rapor \r\n                            WHERE TALEBI_GIREN_PERSONEL_ALTBAYI IS NOT NULL \r\n                            AND TALEBI_GIREN_PERSONEL_ALTBAYI != ''\r\n                            ORDER BY TALEBI_GIREN_PERSONEL_ALTBAYI\";\r\n             $irisBayiStmt = $conn->prepare($irisBayiSql);\r\n@@ -101,9 +101,9 @@\n     } catch (Exception $e) {\r\n         // Hata durumunda iris_rapor'dan al\r\n         try {\r\n             $irisBayiSql = \"SELECT DISTINCT TALEBI_GIREN_PERSONEL_ALTBAYI as bayi_adi \r\n-                           FROM iris_rapor \r\n+                           FROM digiturk.iris_rapor \r\n                            WHERE TALEBI_GIREN_PERSONEL_ALTBAYI IS NOT NULL \r\n                            AND TALEBI_GIREN_PERSONEL_ALTBAYI != ''\r\n                            ORDER BY TALEBI_GIREN_PERSONEL_ALTBAYI\";\r\n             $irisBayiStmt = $conn->prepare($irisBayiSql);\r\n@@ -143,25 +143,25 @@\n                 // Yöntem 2: String user_id'yi integer'a çevir\r\n                 if (!$bayiId && isset($selectedBayi['user_id']) && !is_numeric($selectedBayi['user_id'])) {\r\n                     // Bayi adı seçilmiş, users tablosundan ID bul\r\n                     try {\r\n-                        $findBayiQuery = \"SELECT id FROM users WHERE username = ?\";\r\n+                        $findBayiQuery = \"SELECT id FROM users WHERE (first_name + ' ' + last_name) = ?\";\r\n                         $findBayiStmt = $conn->prepare($findBayiQuery);\r\n                         $findBayiStmt->execute([$selectedBayi['user_id']]);\r\n                         $bayiResult = $findBayiStmt->fetch(PDO::FETCH_ASSOC);\r\n                         if ($bayiResult) {\r\n                             $bayiId = $bayiResult['id'];\r\n-                            $debugInfo[] = \"username ile bulundu: \" . $selectedBayi['user_id'] . \" -> \" . $bayiId;\r\n+                            $debugInfo[] = \"ad soyad ile bulundu: \" . $selectedBayi['user_id'] . \" -> \" . $bayiId;\r\n                         }\r\n                     } catch (Exception $e) {\r\n-                        $debugInfo[] = \"username sorgusu hatası: \" . $e->getMessage();\r\n+                        $debugInfo[] = \"ad soyad sorgusu hatası: \" . $e->getMessage();\r\n                     }\r\n                 }\r\n                 \r\n                 // Yöntem 3: bayi_adi ile users tablosunda ara\r\n                 if (!$bayiId && isset($selectedBayi['bayi_adi'])) {\r\n                     try {\r\n-                        $findBayiQuery2 = \"SELECT id FROM users WHERE username = ?\";\r\n+                        $findBayiQuery2 = \"SELECT id FROM users WHERE (first_name + ' ' + last_name) = ?\";\r\n                         $findBayiStmt2 = $conn->prepare($findBayiQuery2);\r\n                         $findBayiStmt2->execute([$selectedBayi['bayi_adi']]);\r\n                         $bayiResult2 = $findBayiStmt2->fetch(PDO::FETCH_ASSOC);\r\n                         if ($bayiResult2) {\r\n@@ -175,20 +175,20 @@\n                 \r\n                 // Yöntem 4: users_bayi tablosundan doğrudan kontrol\r\n                 if (!$bayiId) {\r\n                     try {\r\n-                        $findBayiQuery3 = \"SELECT ub.user_id, u.username FROM users_bayi ub \r\n+                        $findBayiQuery3 = \"SELECT ub.user_id, (u.first_name + ' ' + u.last_name) as bayi_adi FROM users_bayi ub \r\n                                           INNER JOIN users u ON ub.user_id = u.id \r\n-                                          WHERE u.username = ? OR u.username = ?\";\r\n+                                          WHERE (u.first_name + ' ' + u.last_name) = ? OR (u.first_name + ' ' + u.last_name) = ?\";\r\n                         $findBayiStmt3 = $conn->prepare($findBayiQuery3);\r\n                         $findBayiStmt3->execute([\r\n                             $selectedBayi['bayi_adi'] ?? '', \r\n                             $selectedBayi['user_id'] ?? ''\r\n                         ]);\r\n                         $bayiResult3 = $findBayiStmt3->fetch(PDO::FETCH_ASSOC);\r\n                         if ($bayiResult3) {\r\n                             $bayiId = $bayiResult3['user_id'];\r\n-                            $debugInfo[] = \"users_bayi ile bulundu: \" . $bayiResult3['username'] . \" -> \" . $bayiId;\r\n+                            $debugInfo[] = \"users_bayi ile bulundu: \" . $bayiResult3['bayi_adi'] . \" -> \" . $bayiId;\r\n                         }\r\n                     } catch (Exception $e) {\r\n                         $debugInfo[] = \"users_bayi sorgusu hatası: \" . $e->getMessage();\r\n                     }\r\n@@ -212,9 +212,9 @@\n                     if (!$hakedisData) {\r\n                         $hakedisQuery2 = \"SELECT ht.isp_neo_fiyat, ht.isp_uydu_fiyat, ht.neo_fiyat, ht.uydu_fiyat \r\n                                          FROM hakedis_tanim ht\r\n                                          INNER JOIN users u ON ht.bayi_id = u.id\r\n-                                         WHERE ht.bayi_hakedis_prim_donem_id = ? AND u.username = ?\";\r\n+                                         WHERE ht.bayi_hakedis_prim_donem_id = ? AND (u.first_name + ' ' + u.last_name) = ?\";\r\n                         $hakedisStmt2 = $conn->prepare($hakedisQuery2);\r\n                         $hakedisStmt2->execute([$hakedisDonemi, $selectedBayi['bayi_adi']]);\r\n                         $hakedisData = $hakedisStmt2->fetch(PDO::FETCH_ASSOC);\r\n                     }\r\n@@ -230,9 +230,9 @@\n                                 SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'ISP ve Neo Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_NEO_COUNT,\r\n                                 SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'Uydu ve ISP Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_UYDU_COUNT,\r\n                                 SUM(CASE WHEN MEMO_KAYIT_TIPI = 'NEO' THEN 1 ELSE 0 END) as NEO_COUNT,\r\n                                 SUM(CASE WHEN MEMO_KAYIT_TIPI = 'UYDU' THEN 1 ELSE 0 END) as UYDU_COUNT\r\n-                            FROM iris_rapor \r\n+                            FROM digiturk.iris_rapor \r\n                             WHERE MEMO_KAPANIS_TARIHI >= ? \r\n                             AND MEMO_KAPANIS_TARIHI <= ?\r\n                             AND TALEBI_GIREN_PERSONEL_ALTBAYI = ?\r\n                             AND GUNCEL_OUTLET_DURUM = 'AKTIF'\r\n@@ -295,9 +295,9 @@\n         }\r\n     }\r\n     \r\n     // Önce tablo ve sütunların varlığını kontrol et\r\n-    $checkTableSql = \"SELECT COUNT(*) as table_exists FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'iris_rapor'\";\r\n+    $checkTableSql = \"SELECT COUNT(*) as table_exists FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'digiturk' AND TABLE_NAME = 'iris_rapor'\";\r\n     $checkStmt = $conn->prepare($checkTableSql);\r\n     $checkStmt->execute();\r\n     $tableCheck = $checkStmt->fetch();\r\n     \r\n@@ -309,9 +309,9 @@\n     $requiredColumns = ['GUNCEL_OUTLET_DURUM', 'TEYIT_DURUM', 'TALEBI_GIREN_PERSONEL_ALTBAYI', 'MEMO_KAYIT_TIPI', 'MEMO_KAPANIS_TARIHI', 'TALEP_TURU'];\r\n     $checkColumnsSql = \"\r\n         SELECT COLUMN_NAME \r\n         FROM INFORMATION_SCHEMA.COLUMNS \r\n-        WHERE TABLE_NAME = 'iris_rapor' \r\n+        WHERE TABLE_SCHEMA = 'digiturk' AND TABLE_NAME = 'iris_rapor' \r\n         AND COLUMN_NAME IN ('\" . implode(\"','\", $requiredColumns) . \"')\r\n     \";\r\n     $checkColStmt = $conn->prepare($checkColumnsSql);\r\n     $checkColStmt->execute();\r\n@@ -322,9 +322,9 @@\n         throw new Exception('Gerekli sütunlar bulunamadı: ' . implode(', ', $missingColumns) . '. Lütfen güncel rapor formatını kullanın.');\r\n     }\r\n     \r\n     // Test data availability\r\n-    $testSql = \"SELECT COUNT(*) as row_count FROM iris_rapor\";\r\n+    $testSql = \"SELECT COUNT(*) as row_count FROM digiturk.iris_rapor\";\r\n     $testStmt = $conn->prepare($testSql);\r\n     $testStmt->execute();\r\n     $rowCount = $testStmt->fetch(PDO::FETCH_ASSOC);\r\n     \r\n@@ -338,9 +338,9 @@\n     $altBayiOptions = [];\r\n     \r\n     // Önce GUNCEL_OUTLET_DURUM değerlerini al (dropdown için)\r\n     try {\r\n-        $outletDurumSql = \"SELECT DISTINCT GUNCEL_OUTLET_DURUM FROM iris_rapor WHERE GUNCEL_OUTLET_DURUM IS NOT NULL AND GUNCEL_OUTLET_DURUM != '' ORDER BY GUNCEL_OUTLET_DURUM\";\r\n+        $outletDurumSql = \"SELECT DISTINCT GUNCEL_OUTLET_DURUM FROM digiturk.iris_rapor WHERE GUNCEL_OUTLET_DURUM IS NOT NULL AND GUNCEL_OUTLET_DURUM != '' ORDER BY GUNCEL_OUTLET_DURUM\";\r\n         $outletDurumStmt = $conn->prepare($outletDurumSql);\r\n         if ($outletDurumStmt) {\r\n             $outletDurumStmt->execute();\r\n             $outletDurumOptions = $outletDurumStmt->fetchAll(PDO::FETCH_COLUMN);\r\n@@ -350,9 +350,9 @@\n     }\r\n     \r\n     // TEYIT_DURUM değerlerini al (dropdown için)\r\n     try {\r\n-        $teyitDurumSql = \"SELECT DISTINCT TEYIT_DURUM FROM iris_rapor WHERE TEYIT_DURUM IS NOT NULL AND TEYIT_DURUM != '' ORDER BY TEYIT_DURUM\";\r\n+        $teyitDurumSql = \"SELECT DISTINCT TEYIT_DURUM FROM digiturk.iris_rapor WHERE TEYIT_DURUM IS NOT NULL AND TEYIT_DURUM != '' ORDER BY TEYIT_DURUM\";\r\n         $teyitDurumStmt = $conn->prepare($teyitDurumSql);\r\n         if ($teyitDurumStmt) {\r\n             $teyitDurumStmt->execute();\r\n             $teyitDurumOptions = $teyitDurumStmt->fetchAll(PDO::FETCH_COLUMN);\r\n@@ -362,9 +362,9 @@\n     }\r\n     \r\n     // Alt Bayi değerlerini al (dropdown için)\r\n     try {\r\n-        $altBayiSql = \"SELECT DISTINCT TALEBI_GIREN_PERSONEL_ALTBAYI FROM iris_rapor WHERE TALEBI_GIREN_PERSONEL_ALTBAYI IS NOT NULL AND TALEBI_GIREN_PERSONEL_ALTBAYI != '' ORDER BY TALEBI_GIREN_PERSONEL_ALTBAYI\";\r\n+        $altBayiSql = \"SELECT DISTINCT TALEBI_GIREN_PERSONEL_ALTBAYI FROM digiturk.iris_rapor WHERE TALEBI_GIREN_PERSONEL_ALTBAYI IS NOT NULL AND TALEBI_GIREN_PERSONEL_ALTBAYI != '' ORDER BY TALEBI_GIREN_PERSONEL_ALTBAYI\";\r\n         $altBayiStmt = $conn->prepare($altBayiSql);\r\n         if ($altBayiStmt) {\r\n             $altBayiStmt->execute();\r\n             $altBayiOptions = $altBayiStmt->fetchAll(PDO::FETCH_COLUMN);\r\n@@ -420,9 +420,9 @@\n         SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'Uydu ve ISP Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_UYDU,\r\n         SUM(CASE WHEN MEMO_KAYIT_TIPI = 'NEO' THEN 1 ELSE 0 END) as NEO,\r\n         SUM(CASE WHEN MEMO_KAYIT_TIPI = 'UYDU' THEN 1 ELSE 0 END) as UYDU,\r\n         COUNT(*) as TOPLAM\r\n-    FROM iris_rapor \r\n+    FROM digiturk.iris_rapor \r\n     $whereClause\r\n     GROUP BY TALEBI_GIREN_PERSONEL_ALTBAYI\r\n     ORDER BY TOPLAM DESC, ALTBAYI\r\n     \";\r\n@@ -447,9 +447,9 @@\n     SELECT \r\n         COUNT(*) as toplam_kayit,\r\n         COUNT(DISTINCT TALEBI_GIREN_PERSONEL_ALTBAYI) as toplam_altbayi,\r\n         COUNT(DISTINCT MEMO_KAYIT_TIPI) as toplam_kayit_tipi\r\n-    FROM iris_rapor\r\n+    FROM digiturk.iris_rapor\r\n     $whereClause\r\n     \";\r\n     \r\n     // Stats query with error handling\r\n@@ -1074,17 +1074,17 @@\n         // Mevcut users tablosunu kontrol et\r\n         try {\r\n             echo \"<div class='mt-3'>\";\r\n             echo \"<h6>Mevcut Users Tablosu:</h6>\";\r\n-            $usersQuery = \"SELECT TOP 10 id, username FROM users ORDER BY id\";\r\n+            $usersQuery = \"SELECT TOP 10 id, (first_name + ' ' + last_name) as full_name FROM users ORDER BY id\";\r\n             $usersStmt = $conn->prepare($usersQuery);\r\n             $usersStmt->execute();\r\n             $usersResult = $usersStmt->fetchAll(PDO::FETCH_ASSOC);\r\n             \r\n             if (!empty($usersResult)) {\r\n                 echo \"<ul>\";\r\n                 foreach ($usersResult as $user) {\r\n-                    echo \"<li>ID: {$user['id']} - Username: {$user['username']}</li>\";\r\n+                    echo \"<li>ID: {$user['id']} - Ad Soyad: {$user['full_name']}</li>\";\r\n                 }\r\n                 echo \"</ul>\";\r\n             } else {\r\n                 echo \"<p class='text-danger'>Users tablosu boş!</p>\";\r\n@@ -1093,18 +1093,18 @@\n             \r\n             // users_bayi tablosunu kontrol et\r\n             echo \"<div class='mt-3'>\";\r\n             echo \"<h6>Mevcut Users_Bayi Tablosu:</h6>\";\r\n-            $usersBayiQuery = \"SELECT TOP 10 ub.id, ub.user_id, u.username FROM users_bayi ub \r\n+            $usersBayiQuery = \"SELECT TOP 10 ub.id, ub.user_id, (u.first_name + ' ' + u.last_name) as bayi_adi FROM users_bayi ub \r\n                               LEFT JOIN users u ON ub.user_id = u.id ORDER BY ub.id\";\r\n             $usersBayiStmt = $conn->prepare($usersBayiQuery);\r\n             $usersBayiStmt->execute();\r\n             $usersBayiResult = $usersBayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n             \r\n             if (!empty($usersBayiResult)) {\r\n                 echo \"<ul>\";\r\n                 foreach ($usersBayiResult as $ub) {\r\n-                    echo \"<li>Bayi ID: {$ub['id']} - User ID: {$ub['user_id']} - Username: {$ub['username']}</li>\";\r\n+                    echo \"<li>Bayi ID: {$ub['id']} - User ID: {$ub['user_id']} - Ad Soyad: {$ub['bayi_adi']}</li>\";\r\n                 }\r\n                 echo \"</ul>\";\r\n             } else {\r\n                 echo \"<p class='text-danger'>Users_Bayi tablosu boş!</p>\";\r\n@@ -1129,12 +1129,12 @@\n     <div class=\"alert alert-info\">\r\n         <h6><i class=\"fas fa-info-circle me-2\"></i>Hakediş Tanım Kontrol</h6>\r\n         <?php\r\n         try {\r\n-            $debugQuery = \"SELECT ht.*, u.username, bhpd.donem_adi \r\n+            $debugQuery = \"SELECT ht.*, (u.first_name + ' ' + u.last_name) as bayi_adi, bhpd.donem_adi \r\n                           FROM hakedis_tanim ht \r\n                           LEFT JOIN users u ON ht.bayi_id = u.id \r\n-                          LEFT JOIN bayi_hakedis_prim_donem bhpd ON ht.bayi_hakedis_prim_donem_id = bhpd.id\r\n+                          LEFT JOIN digiturk.bayi_hakedis_prim_donem bhpd ON ht.bayi_hakedis_prim_donem_id = bhpd.id\r\n                           WHERE ht.bayi_hakedis_prim_donem_id = ?\";\r\n             $debugStmt = $conn->prepare($debugQuery);\r\n             $debugStmt->execute([$hakedisDonemi]);\r\n             $debugResults = $debugStmt->fetchAll(PDO::FETCH_ASSOC);\r\n@@ -1142,9 +1142,9 @@\n             if (!empty($debugResults)) {\r\n                 echo \"<p><strong>Bu dönem için mevcut hakediş tanımları:</strong></p>\";\r\n                 echo \"<ul>\";\r\n                 foreach ($debugResults as $debug) {\r\n-                    echo \"<li>Bayi ID: {$debug['bayi_id']} - {$debug['username']} - Dönem: {$debug['donem_adi']}</li>\";\r\n+                    echo \"<li>Bayi ID: {$debug['bayi_id']} - {$debug['bayi_adi']} - Dönem: {$debug['donem_adi']}</li>\";\r\n                 }\r\n                 echo \"</ul>\";\r\n             } else {\r\n                 echo \"<p class='text-danger'>Bu dönem için hiç hakediş tanımı bulunamadı.</p>\";\r\n@@ -1160,12 +1160,12 @@\n     <div class=\"alert alert-info\">\r\n         <h6><i class=\"fas fa-info-circle me-2\"></i>Hakediş Tanım Kontrol</h6>\r\n         <?php\r\n         try {\r\n-            $debugQuery = \"SELECT ht.*, u.username, bhpd.donem_adi \r\n+            $debugQuery = \"SELECT ht.*, (u.first_name + ' ' + u.last_name) as bayi_adi, bhpd.donem_adi \r\n                           FROM hakedis_tanim ht \r\n                           LEFT JOIN users u ON ht.bayi_id = u.id \r\n-                          LEFT JOIN bayi_hakedis_prim_donem bhpd ON ht.bayi_hakedis_prim_donem_id = bhpd.id\r\n+                          LEFT JOIN digiturk.bayi_hakedis_prim_donem bhpd ON ht.bayi_hakedis_prim_donem_id = bhpd.id\r\n                           WHERE ht.bayi_hakedis_prim_donem_id = ?\";\r\n             $debugStmt = $conn->prepare($debugQuery);\r\n             $debugStmt->execute([$hakedisDonemi]);\r\n             $debugResults = $debugStmt->fetchAll(PDO::FETCH_ASSOC);\r\n@@ -1173,9 +1173,9 @@\n             if (!empty($debugResults)) {\r\n                 echo \"<p><strong>Bu dönem için mevcut hakediş tanımları:</strong></p>\";\r\n                 echo \"<ul>\";\r\n                 foreach ($debugResults as $debug) {\r\n-                    echo \"<li>Bayi ID: {$debug['bayi_id']} - {$debug['username']} - Dönem: {$debug['donem_adi']}</li>\";\r\n+                    echo \"<li>Bayi ID: {$debug['bayi_id']} - {$debug['bayi_adi']} - Dönem: {$debug['donem_adi']}</li>\";\r\n                 }\r\n                 echo \"</ul>\";\r\n             } else {\r\n                 echo \"<p class='text-danger'>Bu dönem için hiç hakediş tanımı bulunamadı.</p>\";\r\n"
                },
                {
                    "date": 1760512689223,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -836,9 +836,9 @@\n                             </select>\r\n                         </div>\r\n                         <div class=\"col-md-2\">\r\n                             <label for=\"alt_bayi\" class=\"form-label\">\r\n-                                <i class=\"fas fa-user-tie me-1\"></i>Alt Bayi\r\n+                                <i class=\"fas fa-user-tie me-1\"></i>Alt Bayi Kodu\r\n                             </label>\r\n                             <select class=\"form-select\" id=\"alt_bayi\" name=\"alt_bayi\">\r\n                                 <option value=\"\">Tümü</option>\r\n                                 <?php foreach ($altBayiOptions as $option): ?>\r\n"
                },
                {
                    "date": 1760513387261,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,15 +21,12 @@\n $outletDurum = isset($_GET['outlet_durum']) ? $_GET['outlet_durum'] : ($hasAnyParam ? '' : 'AKTIF');\r\n $teyitDurum = isset($_GET['teyit_durum']) ? $_GET['teyit_durum'] : ($hasAnyParam ? '' : 'ONAYLANDI');\r\n $hakedisDonemi = isset($_GET['hakedis_donemi']) ? $_GET['hakedis_donemi'] : '';\r\n $altBayi = isset($_GET['alt_bayi']) ? $_GET['alt_bayi'] : '';\r\n-$hesaplamaYap = isset($_GET['hesaplama_yap']) ? $_GET['hesaplama_yap'] : false;\r\n \r\n // Hakediş dönemlerini veritabanından al (veritabanı bağlantısı kurulduktan sonra)\r\n $hakedisDonemleri = [];\r\n $altBayiList = [];\r\n-$hakedisHesaplama = [];\r\n-$hakedisResult = null;\r\n \r\n // Initialize variables with default values\r\n $outletDurumOptions = [];\r\n $satisDurumuOptions = [];\r\n@@ -121,182 +118,9 @@\n             $altBayiList = [];\r\n         }\r\n     }\r\n \r\n-    // Hakediş hesaplama yapılacaksa\r\n-    if ($hesaplamaYap && !empty($hakedisDonemi) && !empty($altBayi)) {\r\n-        try {\r\n-            // Seçilen dönem bilgilerini al\r\n-            $selectedDonem = $hakedisDonemleri[$hakedisDonemi] ?? null;\r\n-            $selectedBayi = $altBayiList[$altBayi] ?? null;\r\n-            \r\n-            if ($selectedDonem && $selectedBayi) {\r\n-                // Bayi ID'sini doğru şekilde al - çoklu yöntem\r\n-                $bayiId = null;\r\n-                $debugInfo = [];\r\n-                \r\n-                // Yöntem 1: Doğrudan user_id kontrolü\r\n-                if (isset($selectedBayi['user_id']) && is_numeric($selectedBayi['user_id'])) {\r\n-                    $bayiId = $selectedBayi['user_id'];\r\n-                    $debugInfo[] = \"user_id kullanıldı: \" . $bayiId;\r\n-                }\r\n-                \r\n-                // Yöntem 2: String user_id'yi integer'a çevir\r\n-                if (!$bayiId && isset($selectedBayi['user_id']) && !is_numeric($selectedBayi['user_id'])) {\r\n-                    // Bayi adı seçilmiş, users tablosundan ID bul\r\n-                    try {\r\n-                        $findBayiQuery = \"SELECT id FROM users WHERE (first_name + ' ' + last_name) = ?\";\r\n-                        $findBayiStmt = $conn->prepare($findBayiQuery);\r\n-                        $findBayiStmt->execute([$selectedBayi['user_id']]);\r\n-                        $bayiResult = $findBayiStmt->fetch(PDO::FETCH_ASSOC);\r\n-                        if ($bayiResult) {\r\n-                            $bayiId = $bayiResult['id'];\r\n-                            $debugInfo[] = \"ad soyad ile bulundu: \" . $selectedBayi['user_id'] . \" -> \" . $bayiId;\r\n-                        }\r\n-                    } catch (Exception $e) {\r\n-                        $debugInfo[] = \"ad soyad sorgusu hatası: \" . $e->getMessage();\r\n-                    }\r\n-                }\r\n-                \r\n-                // Yöntem 3: bayi_adi ile users tablosunda ara\r\n-                if (!$bayiId && isset($selectedBayi['bayi_adi'])) {\r\n-                    try {\r\n-                        $findBayiQuery2 = \"SELECT id FROM users WHERE (first_name + ' ' + last_name) = ?\";\r\n-                        $findBayiStmt2 = $conn->prepare($findBayiQuery2);\r\n-                        $findBayiStmt2->execute([$selectedBayi['bayi_adi']]);\r\n-                        $bayiResult2 = $findBayiStmt2->fetch(PDO::FETCH_ASSOC);\r\n-                        if ($bayiResult2) {\r\n-                            $bayiId = $bayiResult2['id'];\r\n-                            $debugInfo[] = \"bayi_adi ile bulundu: \" . $selectedBayi['bayi_adi'] . \" -> \" . $bayiId;\r\n-                        }\r\n-                    } catch (Exception $e) {\r\n-                        $debugInfo[] = \"bayi_adi sorgusu hatası: \" . $e->getMessage();\r\n-                    }\r\n-                }\r\n-                \r\n-                // Yöntem 4: users_bayi tablosundan doğrudan kontrol\r\n-                if (!$bayiId) {\r\n-                    try {\r\n-                        $findBayiQuery3 = \"SELECT ub.user_id, (u.first_name + ' ' + u.last_name) as bayi_adi FROM users_bayi ub \r\n-                                          INNER JOIN users u ON ub.user_id = u.id \r\n-                                          WHERE (u.first_name + ' ' + u.last_name) = ? OR (u.first_name + ' ' + u.last_name) = ?\";\r\n-                        $findBayiStmt3 = $conn->prepare($findBayiQuery3);\r\n-                        $findBayiStmt3->execute([\r\n-                            $selectedBayi['bayi_adi'] ?? '', \r\n-                            $selectedBayi['user_id'] ?? ''\r\n-                        ]);\r\n-                        $bayiResult3 = $findBayiStmt3->fetch(PDO::FETCH_ASSOC);\r\n-                        if ($bayiResult3) {\r\n-                            $bayiId = $bayiResult3['user_id'];\r\n-                            $debugInfo[] = \"users_bayi ile bulundu: \" . $bayiResult3['bayi_adi'] . \" -> \" . $bayiId;\r\n-                        }\r\n-                    } catch (Exception $e) {\r\n-                        $debugInfo[] = \"users_bayi sorgusu hatası: \" . $e->getMessage();\r\n-                    }\r\n-                }\r\n-                \r\n-                if (!$bayiId) {\r\n-                    $error = \"Bayi ID'si bulunamadı. Seçilen bayi: \" . \r\n-                             json_encode($selectedBayi) . \r\n-                             \". Debug: \" . implode('; ', $debugInfo) . \r\n-                             \". Lütfen hakediş tanımlarında bu bayi için kayıt oluşturun.\";\r\n-                } else {\r\n-                    // Hakediş tanım fiyatlarını al - önce user_id ile dene\r\n-                    $hakedisQuery = \"SELECT isp_neo_fiyat, isp_uydu_fiyat, neo_fiyat, uydu_fiyat \r\n-                                    FROM hakedis_tanim \r\n-                                    WHERE bayi_hakedis_prim_donem_id = ? AND bayi_id = ?\";\r\n-                    $hakedisStmt = $conn->prepare($hakedisQuery);\r\n-                    $hakedisStmt->execute([$hakedisDonemi, $bayiId]);\r\n-                    $hakedisData = $hakedisStmt->fetch(PDO::FETCH_ASSOC);\r\n-                    \r\n-                    // Eğer user_id ile bulunamadıysa, doğrudan bayi adıyla join dene\r\n-                    if (!$hakedisData) {\r\n-                        $hakedisQuery2 = \"SELECT ht.isp_neo_fiyat, ht.isp_uydu_fiyat, ht.neo_fiyat, ht.uydu_fiyat \r\n-                                         FROM hakedis_tanim ht\r\n-                                         INNER JOIN users u ON ht.bayi_id = u.id\r\n-                                         WHERE ht.bayi_hakedis_prim_donem_id = ? AND (u.first_name + ' ' + u.last_name) = ?\";\r\n-                        $hakedisStmt2 = $conn->prepare($hakedisQuery2);\r\n-                        $hakedisStmt2->execute([$hakedisDonemi, $selectedBayi['bayi_adi']]);\r\n-                        $hakedisData = $hakedisStmt2->fetch(PDO::FETCH_ASSOC);\r\n-                    }\r\n-                \r\n-                    if ($hakedisData) {\r\n-                        // Dönem tarih aralığında işlem sayılarını hesapla\r\n-                        $startDateCalc = $selectedDonem['start'];\r\n-                        $endDateCalc = $selectedDonem['end'];\r\n-                        \r\n-                        // İşlem sayılarını hesapla\r\n-                        $countQuery = \"\r\n-                            SELECT \r\n-                                SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'ISP ve Neo Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_NEO_COUNT,\r\n-                                SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'Uydu ve ISP Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_UYDU_COUNT,\r\n-                                SUM(CASE WHEN MEMO_KAYIT_TIPI = 'NEO' THEN 1 ELSE 0 END) as NEO_COUNT,\r\n-                                SUM(CASE WHEN MEMO_KAYIT_TIPI = 'UYDU' THEN 1 ELSE 0 END) as UYDU_COUNT\r\n-                            FROM digiturk.iris_rapor \r\n-                            WHERE MEMO_KAPANIS_TARIHI >= ? \r\n-                            AND MEMO_KAPANIS_TARIHI <= ?\r\n-                            AND TALEBI_GIREN_PERSONEL_ALTBAYI = ?\r\n-                            AND GUNCEL_OUTLET_DURUM = 'AKTIF'\r\n-                            AND TEYIT_DURUM = 'ONAYLANDI'\r\n-                        \";\r\n-                        \r\n-                        // Bayi adını doğru şekilde al\r\n-                        $bayiAdi = $selectedBayi['bayi_adi'];\r\n-                        \r\n-                        $countStmt = $conn->prepare($countQuery);\r\n-                        $countStmt->execute([\r\n-                            $startDateCalc . ' 00:00:00',\r\n-                            $endDateCalc . ' 23:59:59',\r\n-                            $bayiAdi\r\n-                        ]);\r\n-                        $counts = $countStmt->fetch(PDO::FETCH_ASSOC);\r\n-                        \r\n-                        // Hakediş hesaplama\r\n-                        $hakedisResult = [\r\n-                            'donem_info' => $selectedDonem,\r\n-                            'bayi_info' => $selectedBayi,\r\n-                            'fiyatlar' => $hakedisData,\r\n-                            'islem_sayilari' => $counts,\r\n-                            'hesaplamalar' => [\r\n-                                'ISP_NEO' => [\r\n-                                    'adet' => $counts['ISP_NEO_COUNT'] ?? 0,\r\n-                                    'birim_fiyat' => $hakedisData['isp_neo_fiyat'] ?? 0,\r\n-                                    'toplam' => ($counts['ISP_NEO_COUNT'] ?? 0) * ($hakedisData['isp_neo_fiyat'] ?? 0)\r\n-                                ],\r\n-                                'ISP_UYDU' => [\r\n-                                    'adet' => $counts['ISP_UYDU_COUNT'] ?? 0,\r\n-                                    'birim_fiyat' => $hakedisData['isp_uydu_fiyat'] ?? 0,\r\n-                                    'toplam' => ($counts['ISP_UYDU_COUNT'] ?? 0) * ($hakedisData['isp_uydu_fiyat'] ?? 0)\r\n-                                ],\r\n-                                'NEO' => [\r\n-                                    'adet' => $counts['NEO_COUNT'] ?? 0,\r\n-                                    'birim_fiyat' => $hakedisData['neo_fiyat'] ?? 0,\r\n-                                    'toplam' => ($counts['NEO_COUNT'] ?? 0) * ($hakedisData['neo_fiyat'] ?? 0)\r\n-                                ],\r\n-                                'UYDU' => [\r\n-                                    'adet' => $counts['UYDU_COUNT'] ?? 0,\r\n-                                    'birim_fiyat' => $hakedisData['uydu_fiyat'] ?? 0,\r\n-                                    'toplam' => ($counts['UYDU_COUNT'] ?? 0) * ($hakedisData['uydu_fiyat'] ?? 0)\r\n-                                ]\r\n-                            ]\r\n-                        ];\r\n-                        \r\n-                        // Genel toplam hesapla\r\n-                        $hakedisResult['genel_toplam'] = array_sum(array_column($hakedisResult['hesaplamalar'], 'toplam'));\r\n-                        \r\n-                    } else {\r\n-                        $error = \"Seçilen dönem (ID: $hakedisDonemi) ve bayi ('{$selectedBayi['bayi_adi']}' - ID: $bayiId) için hakediş tanımı bulunamadı. Lütfen hakediş tanımlarını kontrol edin.\";\r\n-                    }\r\n-                }\r\n-            } else {\r\n-                $error = \"Geçersiz dönem veya bayi seçimi.\";\r\n-            }\r\n-        } catch (Exception $e) {\r\n-            $error = \"Hakediş hesaplama hatası: \" . $e->getMessage();\r\n-        }\r\n-    }\r\n-    \r\n-    // Önce tablo ve sütunların varlığını kontrol et\r\n+    // Hakediş dönemlerini veritabanından al (veritabanı bağlantısı kurulduktan sonra)\r\n     $checkTableSql = \"SELECT COUNT(*) as table_exists FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'digiturk' AND TABLE_NAME = 'iris_rapor'\";\r\n     $checkStmt = $conn->prepare($checkTableSql);\r\n     $checkStmt->execute();\r\n     $tableCheck = $checkStmt->fetch();\r\n@@ -502,244 +326,10 @@\n             </div>\r\n         </div>\r\n     </div>\r\n \r\n-    <!-- Hakediş Hesaplama Formu -->\r\n-    <div class=\"card border-0 shadow-sm mb-4\">\r\n-        <div class=\"card-header bg-success text-white\">\r\n-            <h6 class=\"mb-0\">\r\n-                <i class=\"fas fa-calculator me-2\"></i>Hakediş Hesaplama\r\n-            </h6>\r\n-        </div>\r\n-        <div class=\"card-body\">\r\n-            <form method=\"GET\" action=\"\" id=\"hakedisFrm\">\r\n-                <input type=\"hidden\" name=\"hesaplama_yap\" value=\"1\">\r\n-                <div class=\"row g-3 align-items-end\">\r\n-                    <div class=\"col-md-4\">\r\n-                        <label for=\"hakedis_donemi_calc\" class=\"form-label\">\r\n-                            <i class=\"fas fa-calendar-check me-1\"></i>Hakediş Dönemi *\r\n-                        </label>\r\n-                        <select class=\"form-select\" id=\"hakedis_donemi_calc\" name=\"hakedis_donemi\" required>\r\n-                            <option value=\"\">Dönem Seçiniz</option>\r\n-                            <?php foreach ($hakedisDonemleri as $key => $donem): ?>\r\n-                                <option value=\"<?php echo $key; ?>\" \r\n-                                        <?php echo $hakedisDonemi == $key ? 'selected' : ''; ?>>\r\n-                                    <?php echo htmlspecialchars($donem['label']); ?>\r\n-                                    (<?php echo date('d.m.Y', strtotime($donem['start'])); ?> - \r\n-                                     <?php echo date('d.m.Y', strtotime($donem['end'])); ?>)\r\n-                                </option>\r\n-                            <?php endforeach; ?>\r\n-                        </select>\r\n-                    </div>\r\n-                    <div class=\"col-md-4\">\r\n-                        <label for=\"alt_bayi_calc\" class=\"form-label\">\r\n-                            <i class=\"fas fa-user-tie me-1\"></i>Alt Bayi * \r\n-                            <?php if (empty($altBayiList)): ?>\r\n-                                <small class=\"text-danger\">(Bayi bulunamadı)</small>\r\n-                            <?php else: ?>\r\n-                                <small class=\"text-success\">(<?php echo count($altBayiList); ?> bayi)</small>\r\n-                            <?php endif; ?>\r\n-                        </label>\r\n-                        <select class=\"form-select\" id=\"alt_bayi_calc\" name=\"alt_bayi\" required>\r\n-                            <option value=\"\">Bayi Seçiniz</option>\r\n-                            <?php if (!empty($altBayiList)): ?>\r\n-                                <?php foreach ($altBayiList as $user_id => $bayi): ?>\r\n-                                    <option value=\"<?php echo htmlspecialchars($user_id); ?>\" \r\n-                                            <?php echo $altBayi == $user_id ? 'selected' : ''; ?>>\r\n-                                        <?php echo htmlspecialchars($bayi['bayi_adi']); ?>\r\n-                                        (ID: <?php echo $bayi['id']; ?>)\r\n-                                    </option>\r\n-                                <?php endforeach; ?>\r\n-                            <?php else: ?>\r\n-                                <option value=\"\" disabled>Bayi bulunamadı - Lütfen veri yükleyin</option>\r\n-                            <?php endif; ?>\r\n-                        </select>\r\n-                        <?php if (empty($altBayiList)): ?>\r\n-                            <div class=\"form-text text-muted\">\r\n-                                <i class=\"fas fa-info-circle me-1\"></i>\r\n-                                Alt bayi listesi boş. Lütfen önce IRIS raporlarını yükleyin.\r\n-                            </div>\r\n-                        <?php endif; ?>\r\n-                    </div>\r\n-                    <div class=\"col-md-4\">\r\n-                        <button type=\"submit\" class=\"btn btn-success btn-lg w-100\">\r\n-                            <i class=\"fas fa-calculator me-1\"></i>Hakediş Hesapla\r\n-                        </button>\r\n-                    </div>\r\n-                </div>\r\n-            </form>\r\n-        </div>\r\n-    </div>\r\n \r\n-    <!-- Hakediş Hesaplama Sonucu -->\r\n-    <?php if ($hakedisResult): ?>\r\n-    <div class=\"card border-0 shadow-sm mb-4\">\r\n-        <div class=\"card-header bg-primary text-white\">\r\n-            <div class=\"row align-items-center\">\r\n-                <div class=\"col\">\r\n-                    <h5 class=\"mb-0\">\r\n-                        <i class=\"fas fa-chart-line me-2\"></i>\r\n-                        Hakediş Hesaplama Sonucu\r\n-                    </h5>\r\n-                </div>\r\n-                <div class=\"col-auto\">\r\n-                    <span class=\"badge bg-light text-dark fs-6\">\r\n-                        <i class=\"fas fa-lira-sign me-1\"></i>\r\n-                        <?php echo number_format($hakedisResult['genel_toplam'], 2, ',', '.'); ?> TL\r\n-                    </span>\r\n-                </div>\r\n-            </div>\r\n-        </div>\r\n-        <div class=\"card-body\">\r\n-            <!-- Dönem ve Bayi Bilgileri -->\r\n-            <div class=\"row mb-4\">\r\n-                <div class=\"col-md-6\">\r\n-                    <div class=\"card border-primary\">\r\n-                        <div class=\"card-header bg-primary text-white py-2\">\r\n-                            <h6 class=\"mb-0\"><i class=\"fas fa-calendar me-1\"></i>Dönem Bilgileri</h6>\r\n-                        </div>\r\n-                        <div class=\"card-body py-3\">\r\n-                            <p class=\"mb-1\"><strong>Dönem:</strong> <?php echo htmlspecialchars($hakedisResult['donem_info']['label']); ?></p>\r\n-                            <p class=\"mb-1\"><strong>Başlangıç:</strong> <?php echo date('d.m.Y', strtotime($hakedisResult['donem_info']['start'])); ?></p>\r\n-                            <p class=\"mb-0\"><strong>Bitiş:</strong> <?php echo date('d.m.Y', strtotime($hakedisResult['donem_info']['end'])); ?></p>\r\n-                        </div>\r\n-                    </div>\r\n-                </div>\r\n-                <div class=\"col-md-6\">\r\n-                    <div class=\"card border-success\">\r\n-                        <div class=\"card-header bg-success text-white py-2\">\r\n-                            <h6 class=\"mb-0\"><i class=\"fas fa-user-tie me-1\"></i>Bayi Bilgileri</h6>\r\n-                        </div>\r\n-                        <div class=\"card-body py-3\">\r\n-                            <p class=\"mb-1\"><strong>Bayi Adı:</strong> <?php echo htmlspecialchars($hakedisResult['bayi_info']['bayi_adi']); ?></p>\r\n-                            <p class=\"mb-1\"><strong>Bayi ID:</strong> <?php echo $hakedisResult['bayi_info']['id']; ?></p>\r\n-                            <p class=\"mb-0\"><strong>User ID:</strong> <?php echo $hakedisResult['bayi_info']['user_id']; ?></p>\r\n-                        </div>\r\n-                    </div>\r\n-                </div>\r\n-            </div>\r\n \r\n-            <!-- Hakediş Hesaplama Detayları -->\r\n-            <div class=\"table-responsive\">\r\n-                <table class=\"table table-striped table-hover\">\r\n-                    <thead class=\"table-dark\">\r\n-                        <tr>\r\n-                            <th>Kayıt Tipi</th>\r\n-                            <th class=\"text-center\">İşlem Adedi</th>\r\n-                            <th class=\"text-end\">Birim Fiyat (TL)</th>\r\n-                            <th class=\"text-end\">Toplam Tutar (TL)</th>\r\n-                        </tr>\r\n-                    </thead>\r\n-                    <tbody>\r\n-                        <?php foreach ($hakedisResult['hesaplamalar'] as $tip => $hesap): ?>\r\n-                        <tr>\r\n-                            <td>\r\n-                                <strong><?php echo $tip; ?></strong>\r\n-                                <?php \r\n-                                switch($tip) {\r\n-                                    case 'ISP_NEO':\r\n-                                        echo '<br><small class=\"text-muted\">ISP ve Neo Potansiyel Talep</small>';\r\n-                                        break;\r\n-                                    case 'ISP_UYDU':\r\n-                                        echo '<br><small class=\"text-muted\">Uydu ve ISP Potansiyel Talep</small>';\r\n-                                        break;\r\n-                                    case 'NEO':\r\n-                                        echo '<br><small class=\"text-muted\">Neo İşlemleri</small>';\r\n-                                        break;\r\n-                                    case 'UYDU':\r\n-                                        echo '<br><small class=\"text-muted\">Uydu İşlemleri</small>';\r\n-                                        break;\r\n-                                }\r\n-                                ?>\r\n-                            </td>\r\n-                            <td class=\"text-center\">\r\n-                                <span class=\"badge bg-info fs-6\"><?php echo number_format($hesap['adet']); ?></span>\r\n-                            </td>\r\n-                            <td class=\"text-end\">\r\n-                                <strong><?php echo number_format($hesap['birim_fiyat'], 2, ',', '.'); ?></strong>\r\n-                            </td>\r\n-                            <td class=\"text-end\">\r\n-                                <strong class=\"text-success\">\r\n-                                    <i class=\"fas fa-lira-sign me-1\"></i>\r\n-                                    <?php echo number_format($hesap['toplam'], 2, ',', '.'); ?>\r\n-                                </strong>\r\n-                            </td>\r\n-                        </tr>\r\n-                        <?php endforeach; ?>\r\n-                    </tbody>\r\n-                    <tfoot class=\"table-success\">\r\n-                        <tr>\r\n-                            <th colspan=\"3\" class=\"text-end\">GENEL TOPLAM:</th>\r\n-                            <th class=\"text-end\">\r\n-                                <h5 class=\"mb-0 text-success\">\r\n-                                    <i class=\"fas fa-lira-sign me-1\"></i>\r\n-                                    <?php echo number_format($hakedisResult['genel_toplam'], 2, ',', '.'); ?> TL\r\n-                                </h5>\r\n-                            </th>\r\n-                        </tr>\r\n-                    </tfoot>\r\n-                </table>\r\n-            </div>\r\n-\r\n-            <!-- Özet Kartları -->\r\n-            <div class=\"row mt-4\">\r\n-                <div class=\"col-md-3\">\r\n-                    <div class=\"card border-info text-center\">\r\n-                        <div class=\"card-body py-3\">\r\n-                            <h4 class=\"text-info mb-1\">\r\n-                                <?php echo array_sum(array_column($hakedisResult['hesaplamalar'], 'adet')); ?>\r\n-                            </h4>\r\n-                            <p class=\"mb-0 text-muted\">Toplam İşlem</p>\r\n-                        </div>\r\n-                    </div>\r\n-                </div>\r\n-                <div class=\"col-md-3\">\r\n-                    <div class=\"card border-warning text-center\">\r\n-                        <div class=\"card-body py-3\">\r\n-                            <h4 class=\"text-warning mb-1\">\r\n-                                <?php echo number_format(\r\n-                                    array_sum(array_column($hakedisResult['hesaplamalar'], 'birim_fiyat')) / 4, \r\n-                                    2, ',', '.'\r\n-                                ); ?>\r\n-                            </h4>\r\n-                            <p class=\"mb-0 text-muted\">Ort. Birim Fiyat</p>\r\n-                        </div>\r\n-                    </div>\r\n-                </div>\r\n-                <div class=\"col-md-3\">\r\n-                    <div class=\"card border-primary text-center\">\r\n-                        <div class=\"card-body py-3\">\r\n-                            <h4 class=\"text-primary mb-1\">\r\n-                                <?php echo count(array_filter($hakedisResult['hesaplamalar'], function($h) { return $h['adet'] > 0; })); ?>\r\n-                            </h4>\r\n-                            <p class=\"mb-0 text-muted\">Aktif Tip Sayısı</p>\r\n-                        </div>\r\n-                    </div>\r\n-                </div>\r\n-                <div class=\"col-md-3\">\r\n-                    <div class=\"card border-success text-center\">\r\n-                        <div class=\"card-body py-3\">\r\n-                            <h4 class=\"text-success mb-1\">\r\n-                                <?php \r\n-                                $totalAdet = array_sum(array_column($hakedisResult['hesaplamalar'], 'adet'));\r\n-                                $avgPerTransaction = $totalAdet > 0 ? $hakedisResult['genel_toplam'] / $totalAdet : 0;\r\n-                                echo number_format($avgPerTransaction, 2, ',', '.');\r\n-                                ?>\r\n-                            </h4>\r\n-                            <p class=\"mb-0 text-muted\">İşlem Başına Ort.</p>\r\n-                        </div>\r\n-                    </div>\r\n-                </div>\r\n-            </div>\r\n-        </div>\r\n-    </div>\r\n-    <?php elseif ($error && $hesaplamaYap): ?>\r\n-    <div class=\"alert alert-danger\">\r\n-        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n-        <?php echo htmlspecialchars($error); ?>\r\n-    </div>\r\n-    <?php endif; ?>\r\n-\r\n     <!-- Filtre Formu -->\r\n     <div class=\"card border-0 shadow-sm mb-4\">\r\n         <div class=\"card-header bg-light\">\r\n             <h6 class=\"mb-0\">\r\n@@ -1057,143 +647,11 @@\n         </div>\r\n     </div>\r\n     <?php endif; ?>\r\n \r\n-    <!-- Bayi ID Bulunamadı Hatası için Debug -->\r\n-    <?php if (isset($error) && strpos($error, 'Bayi ID\\'si bulunamadı') !== false): ?>\r\n-    <div class=\"alert alert-warning\">\r\n-        <h6><i class=\"fas fa-exclamation-triangle me-2\"></i>Bayi ID Bulunamadı - Debug Bilgisi</h6>\r\n-        <div class=\"mb-3\">\r\n-            <strong>Seçilen Parametreler:</strong>\r\n-            <ul>\r\n-                <li><strong>Alt Bayi Parametresi:</strong> <?php echo htmlspecialchars($altBayi ?? 'Boş'); ?></li>\r\n-                <li><strong>Hakediş Dönemi:</strong> <?php echo htmlspecialchars($hakedisDonemi ?? 'Boş'); ?></li>\r\n-            </ul>\r\n-        </div>\r\n-        \r\n-        <?php\r\n-        // Mevcut users tablosunu kontrol et\r\n-        try {\r\n-            echo \"<div class='mt-3'>\";\r\n-            echo \"<h6>Mevcut Users Tablosu:</h6>\";\r\n-            $usersQuery = \"SELECT TOP 10 id, (first_name + ' ' + last_name) as full_name FROM users ORDER BY id\";\r\n-            $usersStmt = $conn->prepare($usersQuery);\r\n-            $usersStmt->execute();\r\n-            $usersResult = $usersStmt->fetchAll(PDO::FETCH_ASSOC);\r\n-            \r\n-            if (!empty($usersResult)) {\r\n-                echo \"<ul>\";\r\n-                foreach ($usersResult as $user) {\r\n-                    echo \"<li>ID: {$user['id']} - Ad Soyad: {$user['full_name']}</li>\";\r\n-                }\r\n-                echo \"</ul>\";\r\n-            } else {\r\n-                echo \"<p class='text-danger'>Users tablosu boş!</p>\";\r\n-            }\r\n-            echo \"</div>\";\r\n-            \r\n-            // users_bayi tablosunu kontrol et\r\n-            echo \"<div class='mt-3'>\";\r\n-            echo \"<h6>Mevcut Users_Bayi Tablosu:</h6>\";\r\n-            $usersBayiQuery = \"SELECT TOP 10 ub.id, ub.user_id, (u.first_name + ' ' + u.last_name) as bayi_adi FROM users_bayi ub \r\n-                              LEFT JOIN users u ON ub.user_id = u.id ORDER BY ub.id\";\r\n-            $usersBayiStmt = $conn->prepare($usersBayiQuery);\r\n-            $usersBayiStmt->execute();\r\n-            $usersBayiResult = $usersBayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n-            \r\n-            if (!empty($usersBayiResult)) {\r\n-                echo \"<ul>\";\r\n-                foreach ($usersBayiResult as $ub) {\r\n-                    echo \"<li>Bayi ID: {$ub['id']} - User ID: {$ub['user_id']} - Ad Soyad: {$ub['bayi_adi']}</li>\";\r\n-                }\r\n-                echo \"</ul>\";\r\n-            } else {\r\n-                echo \"<p class='text-danger'>Users_Bayi tablosu boş!</p>\";\r\n-            }\r\n-            echo \"</div>\";\r\n-            \r\n-        } catch (Exception $e) {\r\n-            echo \"<p class='text-danger'>Debug sorgusu hatası: \" . $e->getMessage() . \"</p>\";\r\n-        }\r\n-        ?>\r\n-        \r\n-        <div class=\"mt-3\">\r\n-            <h6>Çözüm Önerileri:</h6>\r\n-            <ol>\r\n-                <li><strong>users</strong> tablosunda bayi kullanıcısının kayıt olduğundan emin olun</li>\r\n-                <li><strong>users_bayi</strong> tablosunda bu kullanıcı için kayıt oluşturun</li>\r\n-                <li><strong>hakedis_tanim</strong> tablosunda bu bayi ve dönem için fiyat tanımı yapın</li>\r\n-            </ol>\r\n-        </div>\r\n-    </div>\r\n-    <?php endif; ?>\r\n-    <div class=\"alert alert-info\">\r\n-        <h6><i class=\"fas fa-info-circle me-2\"></i>Hakediş Tanım Kontrol</h6>\r\n-        <?php\r\n-        try {\r\n-            $debugQuery = \"SELECT ht.*, (u.first_name + ' ' + u.last_name) as bayi_adi, bhpd.donem_adi \r\n-                          FROM hakedis_tanim ht \r\n-                          LEFT JOIN users u ON ht.bayi_id = u.id \r\n-                          LEFT JOIN digiturk.bayi_hakedis_prim_donem bhpd ON ht.bayi_hakedis_prim_donem_id = bhpd.id\r\n-                          WHERE ht.bayi_hakedis_prim_donem_id = ?\";\r\n-            $debugStmt = $conn->prepare($debugQuery);\r\n-            $debugStmt->execute([$hakedisDonemi]);\r\n-            $debugResults = $debugStmt->fetchAll(PDO::FETCH_ASSOC);\r\n-            \r\n-            if (!empty($debugResults)) {\r\n-                echo \"<p><strong>Bu dönem için mevcut hakediş tanımları:</strong></p>\";\r\n-                echo \"<ul>\";\r\n-                foreach ($debugResults as $debug) {\r\n-                    echo \"<li>Bayi ID: {$debug['bayi_id']} - {$debug['bayi_adi']} - Dönem: {$debug['donem_adi']}</li>\";\r\n-                }\r\n-                echo \"</ul>\";\r\n-            } else {\r\n-                echo \"<p class='text-danger'>Bu dönem için hiç hakediş tanımı bulunamadı.</p>\";\r\n-            }\r\n-        } catch (Exception $e) {\r\n-            echo \"<p class='text-danger'>Debug sorgusu hatası: \" . $e->getMessage() . \"</p>\";\r\n-        }\r\n-        ?>\r\n-    </div>\r\n \r\n-    <!-- Hakediş Tanım Kontrolü -->\r\n-    <?php if (!empty($hakedisDonemi) && !empty($altBayi) && $hesaplamaYap && isset($error) && strpos($error, 'hakediş tanımı bulunamadı') !== false): ?>\r\n-    <div class=\"alert alert-info\">\r\n-        <h6><i class=\"fas fa-info-circle me-2\"></i>Hakediş Tanım Kontrol</h6>\r\n-        <?php\r\n-        try {\r\n-            $debugQuery = \"SELECT ht.*, (u.first_name + ' ' + u.last_name) as bayi_adi, bhpd.donem_adi \r\n-                          FROM hakedis_tanim ht \r\n-                          LEFT JOIN users u ON ht.bayi_id = u.id \r\n-                          LEFT JOIN digiturk.bayi_hakedis_prim_donem bhpd ON ht.bayi_hakedis_prim_donem_id = bhpd.id\r\n-                          WHERE ht.bayi_hakedis_prim_donem_id = ?\";\r\n-            $debugStmt = $conn->prepare($debugQuery);\r\n-            $debugStmt->execute([$hakedisDonemi]);\r\n-            $debugResults = $debugStmt->fetchAll(PDO::FETCH_ASSOC);\r\n-            \r\n-            if (!empty($debugResults)) {\r\n-                echo \"<p><strong>Bu dönem için mevcut hakediş tanımları:</strong></p>\";\r\n-                echo \"<ul>\";\r\n-                foreach ($debugResults as $debug) {\r\n-                    echo \"<li>Bayi ID: {$debug['bayi_id']} - {$debug['bayi_adi']} - Dönem: {$debug['donem_adi']}</li>\";\r\n-                }\r\n-                echo \"</ul>\";\r\n-            } else {\r\n-                echo \"<p class='text-danger'>Bu dönem için hiç hakediş tanımı bulunamadı.</p>\";\r\n-            }\r\n-        } catch (Exception $e) {\r\n-            echo \"<p class='text-danger'>Debug sorgusu hatası: \" . $e->getMessage() . \"</p>\";\r\n-        }\r\n-        ?>\r\n-    </div>\r\n-    <?php endif; ?>\r\n \r\n-    <?php if (isset($error)): ?>\r\n-        <div class=\"alert alert-danger\">\r\n-            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n-            <?php echo htmlspecialchars($error); ?>\r\n-        </div>\r\n-    <?php endif; ?>\r\n+\r\n         \r\n         <!-- Ana Rapor Tablosu -->\r\n         <div class=\"card border-0 shadow-sm\">\r\n             <div class=\"card-header bg-primary text-white\">\r\n@@ -1537,57 +995,11 @@\n     document.body.appendChild(container);\r\n     return container;\r\n }\r\n \r\n-// Hakediş hesaplama form validasyonu\r\n+\r\n+// Form validasyonu ve etkileşimler\r\n document.addEventListener('DOMContentLoaded', function() {\r\n-    const hakedisFrm = document.getElementById('hakedisFrm');\r\n-    const donemeSelect = document.getElementById('hakedis_donemi_calc');\r\n-    const bayiSelect = document.getElementById('alt_bayi_calc');\r\n-    \r\n-    if (hakedisFrm) {\r\n-        hakedisFrm.addEventListener('submit', function(e) {\r\n-            if (!donemeSelect.value || !bayiSelect.value) {\r\n-                e.preventDefault();\r\n-                showToast('Lütfen dönem ve bayi seçimi yapınız!', 'error');\r\n-                return false;\r\n-            }\r\n-            \r\n-            // Loading göster\r\n-            const submitBtn = this.querySelector('button[type=\"submit\"]');\r\n-            const originalText = submitBtn.innerHTML;\r\n-            submitBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin me-1\"></i>Hesaplanıyor...';\r\n-            submitBtn.disabled = true;\r\n-            \r\n-            // Form submit edilirse loading'i geri al\r\n-            setTimeout(() => {\r\n-                submitBtn.innerHTML = originalText;\r\n-                submitBtn.disabled = false;\r\n-            }, 5000);\r\n-        });\r\n-    }\r\n-    \r\n-    // Dönem değişikliğinde bilgi göster\r\n-    if (donemeSelect) {\r\n-        donemeSelect.addEventListener('change', function() {\r\n-            const selectedOption = this.options[this.selectedIndex];\r\n-            if (selectedOption.value) {\r\n-                showToast('Dönem seçildi: ' + selectedOption.text, 'info');\r\n-            }\r\n-        });\r\n-    }\r\n-    \r\n-    // Bayi değişikliğinde bilgi göster\r\n-    if (bayiSelect) {\r\n-        bayiSelect.addEventListener('change', function() {\r\n-            const selectedOption = this.options[this.selectedIndex];\r\n-            if (selectedOption.value) {\r\n-                showToast('Bayi seçildi: ' + selectedOption.text, 'info');\r\n-            }\r\n-        });\r\n-    }\r\n-\r\n-    // Tablo satırlarına hover efekti ve form validasyonu\r\n     const tableRows = document.querySelectorAll('#pivotTable tbody tr:not(.table-secondary)');\r\n     \r\n     tableRows.forEach(row => {\r\n         row.addEventListener('mouseenter', function() {\r\n"
                },
                {
                    "date": 1760513710377,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,9 +18,9 @@\n \r\n // Varsayılan filtreler - sadece herhangi bir parametre yoksa\r\n $hasAnyParam = !empty($_GET);\r\n $outletDurum = isset($_GET['outlet_durum']) ? $_GET['outlet_durum'] : ($hasAnyParam ? '' : 'AKTIF');\r\n-$teyitDurum = isset($_GET['teyit_durum']) ? $_GET['teyit_durum'] : ($hasAnyParam ? '' : 'ONAYLANDI');\r\n+$satisDurumu = isset($_GET['satis_durumu']) ? $_GET['satis_durumu'] : '';\r\n $hakedisDonemi = isset($_GET['hakedis_donemi']) ? $_GET['hakedis_donemi'] : '';\r\n $altBayi = isset($_GET['alt_bayi']) ? $_GET['alt_bayi'] : '';\r\n \r\n // Hakediş dönemlerini veritabanından al (veritabanı bağlantısı kurulduktan sonra)\r\n@@ -129,9 +129,9 @@\n         throw new Exception('iris_rapor tablosu bulunamadı. Lütfen önce raporları yükleyiniz.');\r\n     }\r\n     \r\n     // Gerekli sütunların varlığını kontrol et\r\n-    $requiredColumns = ['GUNCEL_OUTLET_DURUM', 'TEYIT_DURUM', 'TALEBI_GIREN_PERSONEL_ALTBAYI', 'MEMO_KAYIT_TIPI', 'MEMO_KAPANIS_TARIHI', 'TALEP_TURU'];\r\n+    $requiredColumns = ['GUNCEL_OUTLET_DURUM', 'SATIS_DURUMU', 'TALEBI_GIREN_PERSONEL_ALTBAYI', 'MEMO_KAYIT_TIPI', 'MEMO_KAPANIS_TARIHI', 'TALEP_TURU'];\r\n     $checkColumnsSql = \"\r\n         SELECT COLUMN_NAME \r\n         FROM INFORMATION_SCHEMA.COLUMNS \r\n         WHERE TABLE_SCHEMA = 'digiturk' AND TABLE_NAME = 'iris_rapor' \r\n@@ -157,9 +157,9 @@\n     }\r\n     \r\n     // Initialize with empty arrays in case queries fail\r\n     $outletDurumOptions = [];\r\n-    $teyitDurumOptions = [];\r\n+    $satisDurumuOptions = [];\r\n     $altBayiOptions = [];\r\n     \r\n     // Önce GUNCEL_OUTLET_DURUM değerlerini al (dropdown için)\r\n     try {\r\n@@ -172,15 +172,15 @@\n     } catch (Exception $e) {\r\n         // Silent fail for dropdown queries\r\n     }\r\n     \r\n-    // TEYIT_DURUM değerlerini al (dropdown için)\r\n+    // SATIS_DURUMU değerlerini al (dropdown için)\r\n     try {\r\n-        $teyitDurumSql = \"SELECT DISTINCT TEYIT_DURUM FROM digiturk.iris_rapor WHERE TEYIT_DURUM IS NOT NULL AND TEYIT_DURUM != '' ORDER BY TEYIT_DURUM\";\r\n-        $teyitDurumStmt = $conn->prepare($teyitDurumSql);\r\n-        if ($teyitDurumStmt) {\r\n-            $teyitDurumStmt->execute();\r\n-            $teyitDurumOptions = $teyitDurumStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+        $satisDurumuSql = \"SELECT DISTINCT SATIS_DURUMU FROM digiturk.iris_rapor WHERE SATIS_DURUMU IS NOT NULL AND SATIS_DURUMU != '' ORDER BY SATIS_DURUMU\";\r\n+        $satisDurumuStmt = $conn->prepare($satisDurumuSql);\r\n+        if ($satisDurumuStmt) {\r\n+            $satisDurumuStmt->execute();\r\n+            $satisDurumuOptions = $satisDurumuStmt->fetchAll(PDO::FETCH_COLUMN);\r\n         }\r\n     } catch (Exception $e) {\r\n         // Silent fail for dropdown queries\r\n     }\r\n@@ -221,12 +221,12 @@\n         $whereConditions[] = \"GUNCEL_OUTLET_DURUM = ?\";\r\n         $params[] = $outletDurum;\r\n     }\r\n     \r\n-    // Teyit durum filtresi\r\n-    if (!empty($teyitDurum)) {\r\n-        $whereConditions[] = \"TEYIT_DURUM = ?\";\r\n-        $params[] = $teyitDurum;\r\n+    // Satış durumu filtresi\r\n+    if (!empty($satisDurumu)) {\r\n+        $whereConditions[] = \"SATIS_DURUMU = ?\";\r\n+        $params[] = $satisDurumu;\r\n     }\r\n     \r\n     // Alt bayi filtresi\r\n     if (!empty($altBayi)) {\r\n@@ -411,16 +411,16 @@\n                                 <?php endforeach; ?>\r\n                             </select>\r\n                         </div>\r\n                         <div class=\"col-md-2\">\r\n-                            <label for=\"teyit_durum\" class=\"form-label\">\r\n-                                <i class=\"fas fa-check-circle me-1\"></i>Teyit Durum\r\n+                            <label for=\"satis_durumu\" class=\"form-label\">\r\n+                                <i class=\"fas fa-chart-line me-1\"></i>Satış Durum\r\n                             </label>\r\n-                            <select class=\"form-select\" id=\"teyit_durum\" name=\"teyit_durum\">\r\n+                            <select class=\"form-select\" id=\"satis_durumu\" name=\"satis_durumu\">\r\n                                 <option value=\"\">Tümü</option>\r\n-                                <?php foreach ($teyitDurumOptions as $option): ?>\r\n+                                <?php foreach ($satisDurumuOptions as $option): ?>\r\n                                     <option value=\"<?php echo htmlspecialchars($option); ?>\" \r\n-                                            <?php echo $teyitDurum === $option ? 'selected' : ''; ?>>\r\n+                                            <?php echo $satisDurumu === $option ? 'selected' : ''; ?>>\r\n                                         <?php echo htmlspecialchars($option); ?>\r\n                                     </option>\r\n                                 <?php endforeach; ?>\r\n                             </select>\r\n@@ -471,9 +471,9 @@\n                         </div>\r\n                     </div>\r\n                     \r\n                     <!-- Aktif Filtreler -->\r\n-                    <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($teyitDurum) || !empty($hakedisDonemi) || !empty($altBayi)): ?>\r\n+                    <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($satisDurumu) || !empty($hakedisDonemi) || !empty($altBayi)): ?>\r\n                     <div class=\"mt-3\">\r\n                         <h6 class=\"text-muted mb-2\">\r\n                             <i class=\"fas fa-filter me-1\"></i>Aktif Filtreler:\r\n                         </h6>\r\n@@ -506,13 +506,13 @@\n                                     Outlet: <?php echo htmlspecialchars($outletDurum); ?>\r\n                                     <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('outlet_durum')\" style=\"font-size: 0.7em;\"></button>\r\n                                 </span>\r\n                             <?php endif; ?>\r\n-                            <?php if (!empty($teyitDurum)): ?>\r\n+                            <?php if (!empty($satisDurumu)): ?>\r\n                                 <span class=\"badge bg-warning\">\r\n-                                    <i class=\"fas fa-check-circle me-1\"></i>\r\n-                                    Teyit: <?php echo htmlspecialchars($teyitDurum); ?>\r\n-                                    <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('teyit_durum')\" style=\"font-size: 0.7em;\"></button>\r\n+                                    <i class=\"fas fa-chart-line me-1\"></i>\r\n+                                    Satış: <?php echo htmlspecialchars($satisDurumu); ?>\r\n+                                    <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('satis_durumu')\" style=\"font-size: 0.7em;\"></button>\r\n                                 </span>\r\n                             <?php endif; ?>\r\n                             <?php if (!empty($altBayi)): ?>\r\n                                 <span class=\"badge bg-dark\">\r\n@@ -579,9 +579,9 @@\n                             if (!empty($startDate)) $activeFilters++;\r\n                             if (!empty($endDate)) $activeFilters++;\r\n                         }\r\n                         if (!empty($outletDurum)) $activeFilters++;\r\n-                        if (!empty($teyitDurum)) $activeFilters++;\r\n+                        if (!empty($satisDurumu)) $activeFilters++;\r\n                         if (!empty($altBayi)) $activeFilters++;\r\n                         \r\n                         if ($activeFilters > 0) {\r\n                             echo $activeFilters . ' Filtre Aktif';\r\n@@ -609,10 +609,10 @@\n                         if (!empty($outletDurum)) {\r\n                             $filterDetails[] = 'Outlet: ' . $outletDurum;\r\n                         }\r\n                         \r\n-                        if (!empty($teyitDurum)) {\r\n-                            $filterDetails[] = 'Teyit: ' . $teyitDurum;\r\n+                        if (!empty($satisDurumu)) {\r\n+                            $filterDetails[] = 'Satış: ' . $satisDurumu;\r\n                         }\r\n                         \r\n                         if (!empty($altBayi)) {\r\n                             $filterDetails[] = 'Alt Bayi: ' . $altBayi;\r\n@@ -739,9 +739,9 @@\n                             <?php else: ?>\r\n                                 <tr>\r\n                                     <td colspan=\"<?php echo count($columns) + 2; ?>\" class=\"text-center py-5 text-muted\">\r\n                                         <i class=\"fas fa-search fa-2x mb-3 d-block\"></i>\r\n-                        <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($teyitDurum) || !empty($hakedisDonemi) || !empty($altBayi)): ?>\r\n+                        <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($satisDurumu) || !empty($hakedisDonemi) || !empty($altBayi)): ?>\r\n                             <h5>Belirtilen kriterlere uygun veri bulunamadı</h5>\r\n                             <p class=\"mb-0\">\r\n                                 <?php \r\n                                 $activeFilterCount = 0;\r\n@@ -751,9 +751,9 @@\n                                     if (!empty($startDate)) $activeFilterCount++;\r\n                                     if (!empty($endDate)) $activeFilterCount++;\r\n                                 }\r\n                                 if (!empty($outletDurum)) $activeFilterCount++;\r\n-                                if (!empty($teyitDurum)) $activeFilterCount++;\r\n+                                if (!empty($satisDurumu)) $activeFilterCount++;\r\n                                 if (!empty($altBayi)) $activeFilterCount++;                                                echo \"Aktif \" . $activeFilterCount . \" filtre ile eşleşen kayıt bulunamadı.\";\r\n                                                 ?>\r\n                                                 <br>Lütfen farklı kriterler deneyin veya filtreleri temizleyin.\r\n                                             </p>\r\n@@ -901,9 +901,9 @@\n function clearFilters() {\r\n     document.getElementById('start_date').value = '';\r\n     document.getElementById('end_date').value = '';\r\n     document.getElementById('outlet_durum').value = '';\r\n-    document.getElementById('teyit_durum').value = '';\r\n+    document.getElementById('satis_durumu').value = '';\r\n     document.getElementById('hakedis_donemi').value = '';\r\n     document.getElementById('alt_bayi').value = '';\r\n     document.getElementById('filterForm').submit();\r\n }\r\n@@ -1017,9 +1017,9 @@\n     // Tarih validasyonu\r\n     const startDateInput = document.getElementById('start_date');\r\n     const endDateInput = document.getElementById('end_date');\r\n     const outletDurumSelect = document.getElementById('outlet_durum');\r\n-    const teyitDurumSelect = document.getElementById('teyit_durum');\r\n+    const satisDurumuSelect = document.getElementById('satis_durumu');\r\n     const hakedisDonemiSelect = document.getElementById('hakedis_donemi');\r\n     \r\n     // Hakediş dönemleri tanımları (PHP'den JavaScript'e)\r\n     const hakedisDonemleri = <?php echo json_encode($hakedisDonemleri); ?>;\r\n@@ -1077,10 +1077,10 @@\n             // document.getElementById('filterForm').submit();\r\n         });\r\n     }\r\n     \r\n-    if (teyitDurumSelect) {\r\n-        teyitDurumSelect.addEventListener('change', function() {\r\n+    if (satisDurumuSelect) {\r\n+        satisDurumuSelect.addEventListener('change', function() {\r\n             // Eğer kullanıcı dropdown'dan seçim yaparsa otomatik filtreleme yapabilir\r\n             // Bu özellik istenirse aktif edilebilir\r\n             // document.getElementById('filterForm').submit();\r\n         });\r\n"
                },
                {
                    "date": 1760514127340,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,8 +21,9 @@\n $outletDurum = isset($_GET['outlet_durum']) ? $_GET['outlet_durum'] : ($hasAnyParam ? '' : 'AKTIF');\r\n $satisDurumu = isset($_GET['satis_durumu']) ? $_GET['satis_durumu'] : '';\r\n $hakedisDonemi = isset($_GET['hakedis_donemi']) ? $_GET['hakedis_donemi'] : '';\r\n $altBayi = isset($_GET['alt_bayi']) ? $_GET['alt_bayi'] : '';\r\n+$bayiAdSoyad = isset($_GET['bayi_ad_soyad']) ? $_GET['bayi_ad_soyad'] : '';\r\n \r\n // Hakediş dönemlerini veritabanından al (veritabanı bağlantısı kurulduktan sonra)\r\n $hakedisDonemleri = [];\r\n $altBayiList = [];\r\n@@ -30,8 +31,9 @@\n // Initialize variables with default values\r\n $outletDurumOptions = [];\r\n $satisDurumuOptions = [];\r\n $altBayiOptions = [];\r\n+$bayiAdSoyadOptions = [];\r\n $pivotData = [];\r\n $stats = ['toplam_kayit' => 0, 'toplam_altbayi' => 0, 'toplam_kayit_tipi' => 0];\r\n $columns = ['ISP_NEO', 'ISP_UYDU', 'NEO', 'UYDU'];\r\n $error = null;\r\n@@ -159,8 +161,9 @@\n     // Initialize with empty arrays in case queries fail\r\n     $outletDurumOptions = [];\r\n     $satisDurumuOptions = [];\r\n     $altBayiOptions = [];\r\n+    $bayiAdSoyadOptions = [];\r\n     \r\n     // Önce GUNCEL_OUTLET_DURUM değerlerini al (dropdown için)\r\n     try {\r\n         $outletDurumSql = \"SELECT DISTINCT GUNCEL_OUTLET_DURUM FROM digiturk.iris_rapor WHERE GUNCEL_OUTLET_DURUM IS NOT NULL AND GUNCEL_OUTLET_DURUM != '' ORDER BY GUNCEL_OUTLET_DURUM\";\r\n@@ -196,8 +199,28 @@\n     } catch (Exception $e) {\r\n         // Silent fail for dropdown queries\r\n     }\r\n     \r\n+    // Bayi Ad Soyad değerlerini al (users tablosundan)\r\n+    try {\r\n+        $bayiAdSoyadSql = \"SELECT id, first_name, last_name, (first_name + ' ' + last_name) as full_name FROM users WHERE first_name IS NOT NULL AND last_name IS NOT NULL ORDER BY first_name, last_name\";\r\n+        $bayiAdSoyadStmt = $conn->prepare($bayiAdSoyadSql);\r\n+        if ($bayiAdSoyadStmt) {\r\n+            $bayiAdSoyadStmt->execute();\r\n+            $bayiAdSoyadResult = $bayiAdSoyadStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+            \r\n+            foreach ($bayiAdSoyadResult as $bayi) {\r\n+                $fullName = trim($bayi['first_name'] . ' ' . $bayi['last_name']);\r\n+                if (!empty($fullName)) {\r\n+                    $bayiAdSoyadOptions[$bayi['id']] = $fullName;\r\n+                }\r\n+            }\r\n+        }\r\n+    } catch (Exception $e) {\r\n+        // Silent fail for dropdown queries - debug için hata mesajı ekleyelim\r\n+        error_log(\"Bayi Ad Soyad sorgu hatası: \" . $e->getMessage());\r\n+    }\r\n+    \r\n     // WHERE koşullarını hazırla\r\n     $whereConditions = [];\r\n     $params = [];\r\n     \r\n@@ -233,8 +256,14 @@\n         $whereConditions[] = \"TALEBI_GIREN_PERSONEL_ALTBAYI = ?\";\r\n         $params[] = $altBayi;\r\n     }\r\n     \r\n+    // Bayi ad soyad filtresi (users tablosu ile join yaparak)\r\n+    if (!empty($bayiAdSoyad)) {\r\n+        // Bu filtreyi uygulamak için users tablosu ile join yapmamız gerekiyor\r\n+        // Şimdilik bu filtre için özel bir sorgu mantığı ekleyeceğiz\r\n+    }\r\n+    \r\n     $whereClause = \"WHERE \" . implode(\" AND \", $whereConditions);\r\n     \r\n     // Pivot sorgusu - TALEBI_GIREN_PERSONEL_ALTBAYI satır, MEMO_KAYIT_TIPI sütun\r\n     $sql = \"\r\n@@ -438,9 +467,23 @@\n                                     </option>\r\n                                 <?php endforeach; ?>\r\n                             </select>\r\n                         </div>\r\n-                        <div class=\"col-md-3\">\r\n+                        <div class=\"col-md-2\">\r\n+                            <label for=\"bayi_ad_soyad\" class=\"form-label\">\r\n+                                <i class=\"fas fa-user me-1\"></i>Bayi Ad Soyad\r\n+                            </label>\r\n+                            <select class=\"form-select\" id=\"bayi_ad_soyad\" name=\"bayi_ad_soyad\">\r\n+                                <option value=\"\">Tümü</option>\r\n+                                <?php foreach ($bayiAdSoyadOptions as $id => $fullName): ?>\r\n+                                    <option value=\"<?php echo htmlspecialchars($id); ?>\" \r\n+                                            <?php echo $bayiAdSoyad == $id ? 'selected' : ''; ?>>\r\n+                                        <?php echo htmlspecialchars($fullName); ?>\r\n+                                    </option>\r\n+                                <?php endforeach; ?>\r\n+                            </select>\r\n+                        </div>\r\n+                        <div class=\"col-md-2\">\r\n                             <div class=\"btn-group w-100\">\r\n                                 <button type=\"submit\" class=\"btn btn-primary btn-lg\">\r\n                                     <i class=\"fas fa-search me-1\"></i>Filtrele\r\n                                 </button>\r\n@@ -448,9 +491,9 @@\n                                     <i class=\"fas fa-times me-1\"></i>Temizle\r\n                                 </button>\r\n                             </div>\r\n                         </div>\r\n-                        <div class=\"col-md-3\">\r\n+                        <div class=\"col-md-2\">\r\n                             <?php if (!empty($hakedisDonemi) && isset($hakedisDonemleri[$hakedisDonemi])): ?>\r\n                                 <div class=\"alert alert-info mb-0 py-2\">\r\n                                     <i class=\"fas fa-info-circle me-1\"></i>\r\n                                     <strong><?php echo htmlspecialchars($hakedisDonemleri[$hakedisDonemi]['label']); ?></strong>\r\n@@ -471,9 +514,9 @@\n                         </div>\r\n                     </div>\r\n                     \r\n                     <!-- Aktif Filtreler -->\r\n-                    <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($satisDurumu) || !empty($hakedisDonemi) || !empty($altBayi)): ?>\r\n+                    <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($satisDurumu) || !empty($hakedisDonemi) || !empty($altBayi) || !empty($bayiAdSoyad)): ?>\r\n                     <div class=\"mt-3\">\r\n                         <h6 class=\"text-muted mb-2\">\r\n                             <i class=\"fas fa-filter me-1\"></i>Aktif Filtreler:\r\n                         </h6>\r\n@@ -520,8 +563,15 @@\n                                     Alt Bayi: <?php echo htmlspecialchars($altBayi); ?>\r\n                                     <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('alt_bayi')\" style=\"font-size: 0.7em;\"></button>\r\n                                 </span>\r\n                             <?php endif; ?>\r\n+                            <?php if (!empty($bayiAdSoyad) && isset($bayiAdSoyadOptions[$bayiAdSoyad])): ?>\r\n+                                <span class=\"badge bg-secondary\">\r\n+                                    <i class=\"fas fa-user me-1\"></i>\r\n+                                    Bayi: <?php echo htmlspecialchars($bayiAdSoyadOptions[$bayiAdSoyad]); ?>\r\n+                                    <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('bayi_ad_soyad')\" style=\"font-size: 0.7em;\"></button>\r\n+                                </span>\r\n+                            <?php endif; ?>\r\n                         </div>\r\n                     </div>\r\n                     <?php endif; ?>\r\n                 </form>\r\n@@ -581,8 +631,9 @@\n                         }\r\n                         if (!empty($outletDurum)) $activeFilters++;\r\n                         if (!empty($satisDurumu)) $activeFilters++;\r\n                         if (!empty($altBayi)) $activeFilters++;\r\n+                        if (!empty($bayiAdSoyad)) $activeFilters++;\r\n                         \r\n                         if ($activeFilters > 0) {\r\n                             echo $activeFilters . ' Filtre Aktif';\r\n                         } else {\r\n@@ -617,8 +668,12 @@\n                         if (!empty($altBayi)) {\r\n                             $filterDetails[] = 'Alt Bayi: ' . $altBayi;\r\n                         }\r\n                         \r\n+                        if (!empty($bayiAdSoyad) && isset($bayiAdSoyadOptions[$bayiAdSoyad])) {\r\n+                            $filterDetails[] = 'Bayi: ' . $bayiAdSoyadOptions[$bayiAdSoyad];\r\n+                        }\r\n+                        \r\n                         if (!empty($filterDetails)) {\r\n                             echo implode(' • ', $filterDetails);\r\n                         } else {\r\n                             echo 'Filtre Durumu';\r\n@@ -630,10 +685,51 @@\n         </div>\r\n     </div>\r\n \r\n     <!-- Debug Bilgileri (Geliştirme amaçlı) -->\r\n-    <?php if (empty($altBayiList) && !isset($error)): ?>\r\n+    <?php if (empty($bayiAdSoyadOptions)): ?>\r\n     <div class=\"alert alert-warning\">\r\n+        <h6><i class=\"fas fa-database me-2\"></i>Bayi Ad Soyad Debug</h6>\r\n+        <p class=\"mb-2\"><strong>Bayi Ad Soyad Listesi:</strong> Boş (<?php echo count($bayiAdSoyadOptions); ?> kayıt)</p>\r\n+        \r\n+        <?php\r\n+        // Users tablosunu kontrol et\r\n+        try {\r\n+            echo \"<div class='mt-3'>\";\r\n+            echo \"<h6>Mevcut Users Tablosu (İlk 10 kayıt):</h6>\";\r\n+            $testUsersQuery = \"SELECT TOP 10 id, first_name, last_name, status FROM users ORDER BY id\";\r\n+            $testUsersStmt = $conn->prepare($testUsersQuery);\r\n+            $testUsersStmt->execute();\r\n+            $testUsersResult = $testUsersStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+            \r\n+            if (!empty($testUsersResult)) {\r\n+                echo \"<table class='table table-sm'>\";\r\n+                echo \"<thead><tr><th>ID</th><th>First Name</th><th>Last Name</th><th>Status</th></tr></thead>\";\r\n+                echo \"<tbody>\";\r\n+                foreach ($testUsersResult as $user) {\r\n+                    echo \"<tr>\";\r\n+                    echo \"<td>{$user['id']}</td>\";\r\n+                    echo \"<td>\" . htmlspecialchars($user['first_name'] ?? 'NULL') . \"</td>\";\r\n+                    echo \"<td>\" . htmlspecialchars($user['last_name'] ?? 'NULL') . \"</td>\";\r\n+                    echo \"<td>\" . htmlspecialchars($user['status'] ?? 'NULL') . \"</td>\";\r\n+                    echo \"</tr>\";\r\n+                }\r\n+                echo \"</tbody></table>\";\r\n+            } else {\r\n+                echo \"<p class='text-danger'>Users tablosu boş!</p>\";\r\n+            }\r\n+            echo \"</div>\";\r\n+            \r\n+        } catch (Exception $e) {\r\n+            echo \"<p class='text-danger'>Debug sorgusu hatası: \" . $e->getMessage() . \"</p>\";\r\n+        }\r\n+        ?>\r\n+    </div>\r\n+    <?php endif; ?>\r\n+\r\n+    <!-- Debug Bilgileri (Geliştirme amaçlı) -->\r\n+    <?php if (empty($altBayiList)): ?>\r\n+    <div class=\"alert alert-warning\">\r\n         <h6><i class=\"fas fa-database me-2\"></i>Veritabanı Durumu</h6>\r\n         <p class=\"mb-2\"><strong>Alt Bayi Listesi:</strong> Boş (<?php echo count($altBayiList); ?> kayıt)</p>\r\n         <p class=\"mb-2\"><strong>Hakediş Dönemleri:</strong> <?php echo count($hakedisDonemleri); ?> dönem</p>\r\n         \r\n@@ -739,9 +835,9 @@\n                             <?php else: ?>\r\n                                 <tr>\r\n                                     <td colspan=\"<?php echo count($columns) + 2; ?>\" class=\"text-center py-5 text-muted\">\r\n                                         <i class=\"fas fa-search fa-2x mb-3 d-block\"></i>\r\n-                        <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($satisDurumu) || !empty($hakedisDonemi) || !empty($altBayi)): ?>\r\n+                        <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($satisDurumu) || !empty($hakedisDonemi) || !empty($altBayi) || !empty($bayiAdSoyad)): ?>\r\n                             <h5>Belirtilen kriterlere uygun veri bulunamadı</h5>\r\n                             <p class=\"mb-0\">\r\n                                 <?php \r\n                                 $activeFilterCount = 0;\r\n@@ -752,9 +848,10 @@\n                                     if (!empty($endDate)) $activeFilterCount++;\r\n                                 }\r\n                                 if (!empty($outletDurum)) $activeFilterCount++;\r\n                                 if (!empty($satisDurumu)) $activeFilterCount++;\r\n-                                if (!empty($altBayi)) $activeFilterCount++;                                                echo \"Aktif \" . $activeFilterCount . \" filtre ile eşleşen kayıt bulunamadı.\";\r\n+                                if (!empty($altBayi)) $activeFilterCount++;\r\n+                                if (!empty($bayiAdSoyad)) $activeFilterCount++;                                                echo \"Aktif \" . $activeFilterCount . \" filtre ile eşleşen kayıt bulunamadı.\";\r\n                                                 ?>\r\n                                                 <br>Lütfen farklı kriterler deneyin veya filtreleri temizleyin.\r\n                                             </p>\r\n                                             <button class=\"btn btn-outline-primary mt-2\" onclick=\"clearFilters()\">\r\n@@ -904,8 +1001,9 @@\n     document.getElementById('outlet_durum').value = '';\r\n     document.getElementById('satis_durumu').value = '';\r\n     document.getElementById('hakedis_donemi').value = '';\r\n     document.getElementById('alt_bayi').value = '';\r\n+    document.getElementById('bayi_ad_soyad').value = '';\r\n     document.getElementById('filterForm').submit();\r\n }\r\n \r\n // Belirli filtreyi kaldır\r\n@@ -1019,8 +1117,9 @@\n     const endDateInput = document.getElementById('end_date');\r\n     const outletDurumSelect = document.getElementById('outlet_durum');\r\n     const satisDurumuSelect = document.getElementById('satis_durumu');\r\n     const hakedisDonemiSelect = document.getElementById('hakedis_donemi');\r\n+    const bayiAdSoyadSelect = document.getElementById('bayi_ad_soyad');\r\n     \r\n     // Hakediş dönemleri tanımları (PHP'den JavaScript'e)\r\n     const hakedisDonemleri = <?php echo json_encode($hakedisDonemleri); ?>;\r\n     \r\n@@ -1085,8 +1184,17 @@\n             // document.getElementById('filterForm').submit();\r\n         });\r\n     }\r\n     \r\n+    // Bayi Ad Soyad dropdown değişikliklerinde (opsiyonel)\r\n+    if (bayiAdSoyadSelect) {\r\n+        bayiAdSoyadSelect.addEventListener('change', function() {\r\n+            // Eğer kullanıcı dropdown'dan seçim yaparsa otomatik filtreleme yapabilir\r\n+            // Bu özellik istenirse aktif edilebilir\r\n+            // document.getElementById('filterForm').submit();\r\n+        });\r\n+    }\r\n+    \r\n     // Hakediş dönemi değişikliğinde otomatik tarih güncelleme (eğer filtre formu varsa)\r\n     if (hakedisDonemiSelect) {\r\n         hakedisDonemiSelect.addEventListener('change', function() {\r\n             const selectedDonem = this.value;\r\n"
                },
                {
                    "date": 1760514757000,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -502,15 +502,8 @@\n                                         <?php echo date('d.m.Y', strtotime($hakedisDonemleri[$hakedisDonemi]['start'])); ?> - \r\n                                         <?php echo date('d.m.Y', strtotime($hakedisDonemleri[$hakedisDonemi]['end'])); ?>\r\n                                     </small>\r\n                                 </div>\r\n-                            <?php else: ?>\r\n-                                <div class=\"text-muted\">\r\n-                                    <small>\r\n-                                        <i class=\"fas fa-calendar me-1\"></i>\r\n-                                        Manuel tarih seçimi aktif\r\n-                                    </small>\r\n-                                </div>\r\n                             <?php endif; ?>\r\n                         </div>\r\n                     </div>\r\n                     \r\n"
                },
                {
                    "date": 1760514767716,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -745,9 +745,9 @@\n         <div class=\"card border-0 shadow-sm\">\r\n             <div class=\"card-header bg-primary text-white\">\r\n                 <h5 class=\"mb-0\">\r\n                     <i class=\"fas fa-table me-2\"></i>\r\n-                    Alt Bayi - Kayıt Tipi Dağılımı\r\n+                    Alt Bayi Kodu - Kayıt Tipi Dağılımı\r\n                 </h5>\r\n             </div>\r\n             <div class=\"card-body p-0\">\r\n                 <div class=\"table-responsive\">\r\n"
                },
                {
                    "date": 1760514781092,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -753,9 +753,9 @@\n                 <div class=\"table-responsive\">\r\n                     <table class=\"table table-hover mb-0\" id=\"pivotTable\">\r\n                         <thead class=\"table-light sticky-top\">\r\n                             <tr>\r\n-                                <th class=\"text-start ps-3\">Alt Bayi</th>\r\n+                                <th class=\"text-start ps-3\">Alt Bayi Kodu</th>\r\n                                 <?php if (!empty($columns)): ?>\r\n                                     <?php foreach ($columns as $column): ?>\r\n                                         <th class=\"text-center\"><?php echo htmlspecialchars($column); ?></th>\r\n                                     <?php endforeach; ?>\r\n"
                },
                {
                    "date": 1760514833303,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -591,9 +591,9 @@\n                     <div class=\"text-success mb-2\">\r\n                         <i class=\"fas fa-users fa-2x\"></i>\r\n                     </div>\r\n                     <h4 class=\"text-success\"><?php echo isset($stats['toplam_altbayi']) ? number_format($stats['toplam_altbayi']) : '0'; ?></h4>\r\n-                    <p class=\"text-muted mb-0\">Alt Bayi Sayısı</p>\r\n+                    <p class=\"text-muted mb-0\">Alt Bayi Kodu Sayısı</p>\r\n                 </div>\r\n             </div>\r\n         </div>\r\n         <div class=\"col-md-3\">\r\n"
                },
                {
                    "date": 1760515251124,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -199,20 +199,36 @@\n     } catch (Exception $e) {\r\n         // Silent fail for dropdown queries\r\n     }\r\n     \r\n-    // Bayi Ad Soyad değerlerini al (users tablosundan)\r\n+    // Bayi Ad Soyad değerlerini al (users_bayi tablosu ile ilişkilendirerek)\r\n     try {\r\n-        $bayiAdSoyadSql = \"SELECT id, first_name, last_name, (first_name + ' ' + last_name) as full_name FROM users WHERE first_name IS NOT NULL AND last_name IS NOT NULL ORDER BY first_name, last_name\";\r\n+        $bayiAdSoyadSql = \"\r\n+            SELECT \r\n+                u.id, \r\n+                u.first_name, \r\n+                u.last_name,\r\n+                (u.first_name + ' ' + u.last_name) as full_name,\r\n+                ub.iris_altbayi\r\n+            FROM users u \r\n+            INNER JOIN users_bayi ub ON u.id = ub.user_id \r\n+            WHERE u.first_name IS NOT NULL \r\n+            AND u.last_name IS NOT NULL \r\n+            AND ub.iris_altbayi IS NOT NULL \r\n+            AND ub.iris_altbayi != ''\r\n+            ORDER BY u.first_name, u.last_name\";\r\n         $bayiAdSoyadStmt = $conn->prepare($bayiAdSoyadSql);\r\n         if ($bayiAdSoyadStmt) {\r\n             $bayiAdSoyadStmt->execute();\r\n             $bayiAdSoyadResult = $bayiAdSoyadStmt->fetchAll(PDO::FETCH_ASSOC);\r\n             \r\n             foreach ($bayiAdSoyadResult as $bayi) {\r\n                 $fullName = trim($bayi['first_name'] . ' ' . $bayi['last_name']);\r\n                 if (!empty($fullName)) {\r\n-                    $bayiAdSoyadOptions[$bayi['id']] = $fullName;\r\n+                    $bayiAdSoyadOptions[$bayi['id']] = [\r\n+                        'full_name' => $fullName,\r\n+                        'iris_altbayi' => $bayi['iris_altbayi']\r\n+                    ];\r\n                 }\r\n             }\r\n         }\r\n     } catch (Exception $e) {\r\n@@ -256,12 +272,25 @@\n         $whereConditions[] = \"TALEBI_GIREN_PERSONEL_ALTBAYI = ?\";\r\n         $params[] = $altBayi;\r\n     }\r\n     \r\n-    // Bayi ad soyad filtresi (users tablosu ile join yaparak)\r\n+    // Bayi ad soyad filtresi (users_bayi tablosu ile iris_altbayi kodunu alarak)\r\n     if (!empty($bayiAdSoyad)) {\r\n-        // Bu filtreyi uygulamak için users tablosu ile join yapmamız gerekiyor\r\n-        // Şimdilik bu filtre için özel bir sorgu mantığı ekleyeceğiz\r\n+        try {\r\n+            // Seçilen bayinin iris_altbayi kodunu al\r\n+            $bayiAltBayiQuery = \"SELECT iris_altbayi FROM users_bayi WHERE user_id = ?\";\r\n+            $bayiAltBayiStmt = $conn->prepare($bayiAltBayiQuery);\r\n+            $bayiAltBayiStmt->execute([$bayiAdSoyad]);\r\n+            $bayiAltBayiResult = $bayiAltBayiStmt->fetch(PDO::FETCH_ASSOC);\r\n+            \r\n+            if ($bayiAltBayiResult && !empty($bayiAltBayiResult['iris_altbayi'])) {\r\n+                $whereConditions[] = \"TALEBI_GIREN_PERSONEL_ALTBAYI = ?\";\r\n+                $params[] = $bayiAltBayiResult['iris_altbayi'];\r\n+            }\r\n+        } catch (Exception $e) {\r\n+            // Hata durumunda filtreyi atlayalım\r\n+            error_log(\"Bayi Ad Soyad filtresi hatası: \" . $e->getMessage());\r\n+        }\r\n     }\r\n     \r\n     $whereClause = \"WHERE \" . implode(\" AND \", $whereConditions);\r\n     \r\n@@ -473,12 +502,14 @@\n                                 <i class=\"fas fa-user me-1\"></i>Bayi Ad Soyad\r\n                             </label>\r\n                             <select class=\"form-select\" id=\"bayi_ad_soyad\" name=\"bayi_ad_soyad\">\r\n                                 <option value=\"\">Tümü</option>\r\n-                                <?php foreach ($bayiAdSoyadOptions as $id => $fullName): ?>\r\n+                                <?php foreach ($bayiAdSoyadOptions as $id => $bayiData): ?>\r\n                                     <option value=\"<?php echo htmlspecialchars($id); ?>\" \r\n-                                            <?php echo $bayiAdSoyad == $id ? 'selected' : ''; ?>>\r\n-                                        <?php echo htmlspecialchars($fullName); ?>\r\n+                                            <?php echo $bayiAdSoyad == $id ? 'selected' : ''; ?>\r\n+                                            data-iris-altbayi=\"<?php echo htmlspecialchars($bayiData['iris_altbayi']); ?>\">\r\n+                                        <?php echo htmlspecialchars($bayiData['full_name']); ?> \r\n+                                        <small>(<?php echo htmlspecialchars($bayiData['iris_altbayi']); ?>)</small>\r\n                                     </option>\r\n                                 <?php endforeach; ?>\r\n                             </select>\r\n                         </div>\r\n@@ -559,9 +590,9 @@\n                             <?php endif; ?>\r\n                             <?php if (!empty($bayiAdSoyad) && isset($bayiAdSoyadOptions[$bayiAdSoyad])): ?>\r\n                                 <span class=\"badge bg-secondary\">\r\n                                     <i class=\"fas fa-user me-1\"></i>\r\n-                                    Bayi: <?php echo htmlspecialchars($bayiAdSoyadOptions[$bayiAdSoyad]); ?>\r\n+                                    Bayi: <?php echo htmlspecialchars($bayiAdSoyadOptions[$bayiAdSoyad]['full_name']); ?>\r\n                                     <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('bayi_ad_soyad')\" style=\"font-size: 0.7em;\"></button>\r\n                                 </span>\r\n                             <?php endif; ?>\r\n                         </div>\r\n@@ -662,9 +693,9 @@\n                             $filterDetails[] = 'Alt Bayi: ' . $altBayi;\r\n                         }\r\n                         \r\n                         if (!empty($bayiAdSoyad) && isset($bayiAdSoyadOptions[$bayiAdSoyad])) {\r\n-                            $filterDetails[] = 'Bayi: ' . $bayiAdSoyadOptions[$bayiAdSoyad];\r\n+                            $filterDetails[] = 'Bayi: ' . $bayiAdSoyadOptions[$bayiAdSoyad]['full_name'];\r\n                         }\r\n                         \r\n                         if (!empty($filterDetails)) {\r\n                             echo implode(' • ', $filterDetails);\r\n@@ -1177,14 +1208,32 @@\n             // document.getElementById('filterForm').submit();\r\n         });\r\n     }\r\n     \r\n-    // Bayi Ad Soyad dropdown değişikliklerinde (opsiyonel)\r\n+    // Bayi Ad Soyad dropdown değişikliklerinde alt bayi filtreleme\r\n     if (bayiAdSoyadSelect) {\r\n         bayiAdSoyadSelect.addEventListener('change', function() {\r\n-            // Eğer kullanıcı dropdown'dan seçim yaparsa otomatik filtreleme yapabilir\r\n-            // Bu özellik istenirse aktif edilebilir\r\n-            // document.getElementById('filterForm').submit();\r\n+            const selectedOption = this.options[this.selectedIndex];\r\n+            const altBayiSelect = document.getElementById('alt_bayi');\r\n+            \r\n+            if (selectedOption.value && selectedOption.getAttribute('data-iris-altbayi') && altBayiSelect) {\r\n+                // Seçilen bayinin iris_altbayi kodunu al\r\n+                const irisAltBayi = selectedOption.getAttribute('data-iris-altbayi');\r\n+                \r\n+                // Alt bayi dropdown'unda bu değeri seç\r\n+                for (let i = 0; i < altBayiSelect.options.length; i++) {\r\n+                    if (altBayiSelect.options[i].value === irisAltBayi) {\r\n+                        altBayiSelect.selectedIndex = i;\r\n+                        break;\r\n+                    }\r\n+                }\r\n+                \r\n+                // Bilgi mesajı göster\r\n+                showToast(`Bayi seçildi: ${selectedOption.text.split('(')[0].trim()}. Alt Bayi Kodu otomatik seçildi: ${irisAltBayi}`, 'info');\r\n+            } else if (!selectedOption.value && altBayiSelect) {\r\n+                // Bayi seçimi temizlenirse alt bayi'yi de temizle\r\n+                altBayiSelect.selectedIndex = 0;\r\n+            }\r\n         });\r\n     }\r\n     \r\n     // Hakediş dönemi değişikliğinde otomatik tarih güncelleme (eğer filtre formu varsa)\r\n"
                },
                {
                    "date": 1760521514186,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -187,18 +187,35 @@\n     } catch (Exception $e) {\r\n         // Silent fail for dropdown queries\r\n     }\r\n     \r\n-    // Alt Bayi değerlerini al (dropdown için)\r\n+    // Alt Bayi değerlerini al (dropdown için) - personel_kimlik_no temelinde\r\n     try {\r\n-        $altBayiSql = \"SELECT DISTINCT TALEBI_GIREN_PERSONEL_ALTBAYI FROM digiturk.iris_rapor WHERE TALEBI_GIREN_PERSONEL_ALTBAYI IS NOT NULL AND TALEBI_GIREN_PERSONEL_ALTBAYI != '' ORDER BY TALEBI_GIREN_PERSONEL_ALTBAYI\";\r\n+        $altBayiSql = \"SELECT DISTINCT ub.personel_kimlik_no, (u.first_name + ' ' + u.last_name) as bayi_adi \r\n+                       FROM users_bayi ub \r\n+                       INNER JOIN users u ON ub.user_id = u.id \r\n+                       WHERE ub.personel_kimlik_no IS NOT NULL \r\n+                       AND ub.personel_kimlik_no != '' \r\n+                       ORDER BY u.first_name, u.last_name\";\r\n         $altBayiStmt = $conn->prepare($altBayiSql);\r\n         if ($altBayiStmt) {\r\n             $altBayiStmt->execute();\r\n-            $altBayiOptions = $altBayiStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+            $altBayiResult = $altBayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+            \r\n+            foreach ($altBayiResult as $bayi) {\r\n+                $altBayiOptions[] = $bayi['personel_kimlik_no'];\r\n+            }\r\n         }\r\n     } catch (Exception $e) {\r\n-        // Silent fail for dropdown queries\r\n+        // Hata durumunda iris_rapor'dan personel no'larını al\r\n+        try {\r\n+            $irisBayiSql = \"SELECT DISTINCT TALEBI_GIREN_PERSONELNO FROM digiturk.iris_rapor WHERE TALEBI_GIREN_PERSONELNO IS NOT NULL AND TALEBI_GIREN_PERSONELNO != '' ORDER BY TALEBI_GIREN_PERSONELNO\";\r\n+            $irisBayiStmt = $conn->prepare($irisBayiSql);\r\n+            $irisBayiStmt->execute();\r\n+            $altBayiOptions = $irisBayiStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+        } catch (Exception $e2) {\r\n+            // Silent fail for dropdown queries\r\n+        }\r\n     }\r\n     \r\n     // Bayi Ad Soyad değerlerini al (users_bayi tablosu ile ilişkilendirerek)\r\n     try {\r\n@@ -207,15 +224,15 @@\n                 u.id, \r\n                 u.first_name, \r\n                 u.last_name,\r\n                 (u.first_name + ' ' + u.last_name) as full_name,\r\n-                ub.iris_altbayi\r\n+                ub.personel_kimlik_no\r\n             FROM users u \r\n             INNER JOIN users_bayi ub ON u.id = ub.user_id \r\n             WHERE u.first_name IS NOT NULL \r\n             AND u.last_name IS NOT NULL \r\n-            AND ub.iris_altbayi IS NOT NULL \r\n-            AND ub.iris_altbayi != ''\r\n+            AND ub.personel_kimlik_no IS NOT NULL \r\n+            AND ub.personel_kimlik_no != ''\r\n             ORDER BY u.first_name, u.last_name\";\r\n         $bayiAdSoyadStmt = $conn->prepare($bayiAdSoyadSql);\r\n         if ($bayiAdSoyadStmt) {\r\n             $bayiAdSoyadStmt->execute();\r\n@@ -225,9 +242,9 @@\n                 $fullName = trim($bayi['first_name'] . ' ' . $bayi['last_name']);\r\n                 if (!empty($fullName)) {\r\n                     $bayiAdSoyadOptions[$bayi['id']] = [\r\n                         'full_name' => $fullName,\r\n-                        'iris_altbayi' => $bayi['iris_altbayi']\r\n+                        'personel_kimlik_no' => $bayi['personel_kimlik_no']\r\n                     ];\r\n                 }\r\n             }\r\n         }\r\n@@ -266,26 +283,26 @@\n         $whereConditions[] = \"SATIS_DURUMU = ?\";\r\n         $params[] = $satisDurumu;\r\n     }\r\n     \r\n-    // Alt bayi filtresi\r\n+    // Alt bayi filtresi - personel_kimlik_no ile eşleştir\r\n     if (!empty($altBayi)) {\r\n-        $whereConditions[] = \"TALEBI_GIREN_PERSONEL_ALTBAYI = ?\";\r\n+        $whereConditions[] = \"TALEBI_GIREN_PERSONELNO = ?\";\r\n         $params[] = $altBayi;\r\n     }\r\n     \r\n-    // Bayi ad soyad filtresi (users_bayi tablosu ile iris_altbayi kodunu alarak)\r\n+    // Bayi ad soyad filtresi (users_bayi tablosu ile personel_kimlik_no kodunu alarak)\r\n     if (!empty($bayiAdSoyad)) {\r\n         try {\r\n-            // Seçilen bayinin iris_altbayi kodunu al\r\n-            $bayiAltBayiQuery = \"SELECT iris_altbayi FROM users_bayi WHERE user_id = ?\";\r\n-            $bayiAltBayiStmt = $conn->prepare($bayiAltBayiQuery);\r\n-            $bayiAltBayiStmt->execute([$bayiAdSoyad]);\r\n-            $bayiAltBayiResult = $bayiAltBayiStmt->fetch(PDO::FETCH_ASSOC);\r\n+            // Seçilen bayinin personel_kimlik_no kodunu al\r\n+            $bayiPersonelKimlikQuery = \"SELECT personel_kimlik_no FROM users_bayi WHERE user_id = ?\";\r\n+            $bayiPersonelKimlikStmt = $conn->prepare($bayiPersonelKimlikQuery);\r\n+            $bayiPersonelKimlikStmt->execute([$bayiAdSoyad]);\r\n+            $bayiPersonelKimlikResult = $bayiPersonelKimlikStmt->fetch(PDO::FETCH_ASSOC);\r\n             \r\n-            if ($bayiAltBayiResult && !empty($bayiAltBayiResult['iris_altbayi'])) {\r\n-                $whereConditions[] = \"TALEBI_GIREN_PERSONEL_ALTBAYI = ?\";\r\n-                $params[] = $bayiAltBayiResult['iris_altbayi'];\r\n+            if ($bayiPersonelKimlikResult && !empty($bayiPersonelKimlikResult['personel_kimlik_no'])) {\r\n+                $whereConditions[] = \"TALEBI_GIREN_PERSONELNO = ?\";\r\n+                $params[] = $bayiPersonelKimlikResult['personel_kimlik_no'];\r\n             }\r\n         } catch (Exception $e) {\r\n             // Hata durumunda filtreyi atlayalım\r\n             error_log(\"Bayi Ad Soyad filtresi hatası: \" . $e->getMessage());\r\n@@ -484,9 +501,9 @@\n                             </select>\r\n                         </div>\r\n                         <div class=\"col-md-2\">\r\n                             <label for=\"alt_bayi\" class=\"form-label\">\r\n-                                <i class=\"fas fa-user-tie me-1\"></i>Alt Bayi Kodu\r\n+                                <i class=\"fas fa-user-tie me-1\"></i>Personel Kimlik No\r\n                             </label>\r\n                             <select class=\"form-select\" id=\"alt_bayi\" name=\"alt_bayi\">\r\n                                 <option value=\"\">Tümü</option>\r\n                                 <?php foreach ($altBayiOptions as $option): ?>\r\n@@ -505,11 +522,11 @@\n                                 <option value=\"\">Tümü</option>\r\n                                 <?php foreach ($bayiAdSoyadOptions as $id => $bayiData): ?>\r\n                                     <option value=\"<?php echo htmlspecialchars($id); ?>\" \r\n                                             <?php echo $bayiAdSoyad == $id ? 'selected' : ''; ?>\r\n-                                            data-iris-altbayi=\"<?php echo htmlspecialchars($bayiData['iris_altbayi']); ?>\">\r\n+                                            data-personel-kimlik-no=\"<?php echo htmlspecialchars($bayiData['personel_kimlik_no']); ?>\">\r\n                                         <?php echo htmlspecialchars($bayiData['full_name']); ?> \r\n-                                        <small>(<?php echo htmlspecialchars($bayiData['iris_altbayi']); ?>)</small>\r\n+                                        <small>(<?php echo htmlspecialchars($bayiData['personel_kimlik_no']); ?>)</small>\r\n                                     </option>\r\n                                 <?php endforeach; ?>\r\n                             </select>\r\n                         </div>\r\n@@ -583,9 +600,9 @@\n                             <?php endif; ?>\r\n                             <?php if (!empty($altBayi)): ?>\r\n                                 <span class=\"badge bg-dark\">\r\n                                     <i class=\"fas fa-user-tie me-1\"></i>\r\n-                                    Alt Bayi: <?php echo htmlspecialchars($altBayi); ?>\r\n+                                    Personel No: <?php echo htmlspecialchars($altBayi); ?>\r\n                                     <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('alt_bayi')\" style=\"font-size: 0.7em;\"></button>\r\n                                 </span>\r\n                             <?php endif; ?>\r\n                             <?php if (!empty($bayiAdSoyad) && isset($bayiAdSoyadOptions[$bayiAdSoyad])): ?>\r\n@@ -689,9 +706,9 @@\n                             $filterDetails[] = 'Satış: ' . $satisDurumu;\r\n                         }\r\n                         \r\n                         if (!empty($altBayi)) {\r\n-                            $filterDetails[] = 'Alt Bayi: ' . $altBayi;\r\n+                            $filterDetails[] = 'Personel No: ' . $altBayi;\r\n                         }\r\n                         \r\n                         if (!empty($bayiAdSoyad) && isset($bayiAdSoyadOptions[$bayiAdSoyad])) {\r\n                             $filterDetails[] = 'Bayi: ' . $bayiAdSoyadOptions[$bayiAdSoyad]['full_name'];\r\n@@ -1208,28 +1225,28 @@\n             // document.getElementById('filterForm').submit();\r\n         });\r\n     }\r\n     \r\n-    // Bayi Ad Soyad dropdown değişikliklerinde alt bayi filtreleme\r\n+    // Bayi Ad Soyad dropdown değişikliklerinde personel kimlik no filtreleme\r\n     if (bayiAdSoyadSelect) {\r\n         bayiAdSoyadSelect.addEventListener('change', function() {\r\n             const selectedOption = this.options[this.selectedIndex];\r\n             const altBayiSelect = document.getElementById('alt_bayi');\r\n             \r\n-            if (selectedOption.value && selectedOption.getAttribute('data-iris-altbayi') && altBayiSelect) {\r\n-                // Seçilen bayinin iris_altbayi kodunu al\r\n-                const irisAltBayi = selectedOption.getAttribute('data-iris-altbayi');\r\n+            if (selectedOption.value && selectedOption.getAttribute('data-personel-kimlik-no') && altBayiSelect) {\r\n+                // Seçilen bayinin personel_kimlik_no kodunu al\r\n+                const personelKimlikNo = selectedOption.getAttribute('data-personel-kimlik-no');\r\n                 \r\n                 // Alt bayi dropdown'unda bu değeri seç\r\n                 for (let i = 0; i < altBayiSelect.options.length; i++) {\r\n-                    if (altBayiSelect.options[i].value === irisAltBayi) {\r\n+                    if (altBayiSelect.options[i].value === personelKimlikNo) {\r\n                         altBayiSelect.selectedIndex = i;\r\n                         break;\r\n                     }\r\n                 }\r\n                 \r\n                 // Bilgi mesajı göster\r\n-                showToast(`Bayi seçildi: ${selectedOption.text.split('(')[0].trim()}. Alt Bayi Kodu otomatik seçildi: ${irisAltBayi}`, 'info');\r\n+                showToast(`Bayi seçildi: ${selectedOption.text.split('(')[0].trim()}. Personel Kimlik No otomatik seçildi: ${personelKimlikNo}`, 'info');\r\n             } else if (!selectedOption.value && altBayiSelect) {\r\n                 // Bayi seçimi temizlenirse alt bayi'yi de temizle\r\n                 altBayiSelect.selectedIndex = 0;\r\n             }\r\n"
                },
                {
                    "date": 1760974092974,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -20,9 +20,9 @@\n $hasAnyParam = !empty($_GET);\r\n $outletDurum = isset($_GET['outlet_durum']) ? $_GET['outlet_durum'] : ($hasAnyParam ? '' : 'AKTIF');\r\n $satisDurumu = isset($_GET['satis_durumu']) ? $_GET['satis_durumu'] : '';\r\n $hakedisDonemi = isset($_GET['hakedis_donemi']) ? $_GET['hakedis_donemi'] : '';\r\n-$altBayi = isset($_GET['alt_bayi']) ? $_GET['alt_bayi'] : '';\r\n+$altBayi = isset($_GET['alt_bayi']) ? (is_array($_GET['alt_bayi']) ? $_GET['alt_bayi'] : [$_GET['alt_bayi']]) : [];\r\n $bayiAdSoyad = isset($_GET['bayi_ad_soyad']) ? $_GET['bayi_ad_soyad'] : '';\r\n \r\n // Hakediş dönemlerini veritabanından al (veritabanı bağlantısı kurulduktan sonra)\r\n $hakedisDonemleri = [];\r\n@@ -240,12 +240,17 @@\n             \r\n             foreach ($bayiAdSoyadResult as $bayi) {\r\n                 $fullName = trim($bayi['first_name'] . ' ' . $bayi['last_name']);\r\n                 if (!empty($fullName)) {\r\n-                    $bayiAdSoyadOptions[$bayi['id']] = [\r\n-                        'full_name' => $fullName,\r\n-                        'personel_kimlik_no' => $bayi['personel_kimlik_no']\r\n-                    ];\r\n+                    // Aynı kullanıcı için birden fazla personel_kimlik_no olabilir\r\n+                    if (!isset($bayiAdSoyadOptions[$bayi['id']])) {\r\n+                        $bayiAdSoyadOptions[$bayi['id']] = [\r\n+                            'full_name' => $fullName,\r\n+                            'personel_kimlik_no' => []\r\n+                        ];\r\n+                    }\r\n+                    // Personel kimlik no'yu array olarak sakla\r\n+                    $bayiAdSoyadOptions[$bayi['id']]['personel_kimlik_no'][] = $bayi['personel_kimlik_no'];\r\n                 }\r\n             }\r\n         }\r\n     } catch (Exception $e) {\r\n@@ -283,26 +288,41 @@\n         $whereConditions[] = \"SATIS_DURUMU = ?\";\r\n         $params[] = $satisDurumu;\r\n     }\r\n     \r\n-    // Alt bayi filtresi - personel_kimlik_no ile eşleştir\r\n-    if (!empty($altBayi)) {\r\n-        $whereConditions[] = \"TALEBI_GIREN_PERSONELNO = ?\";\r\n-        $params[] = $altBayi;\r\n-    }\r\n-    \r\n-    // Bayi ad soyad filtresi (users_bayi tablosu ile personel_kimlik_no kodunu alarak)\r\n-    if (!empty($bayiAdSoyad)) {\r\n+    // Personel filtresi - Alt bayi veya Bayi ad soyad (öncelik sırasına göre)\r\n+    // Eğer Alt Bayi (Personel Kimlik No) manuel seçildiyse onu kullan\r\n+    if (!empty($altBayi) && is_array($altBayi)) {\r\n+        $altBayi = array_filter($altBayi); // Boş değerleri temizle\r\n+        if (!empty($altBayi)) {\r\n+            $placeholders = str_repeat('?,', count($altBayi) - 1) . '?';\r\n+            $whereConditions[] = \"TALEBI_GIREN_PERSONELNO IN ($placeholders)\";\r\n+            foreach ($altBayi as $personelNo) {\r\n+                $params[] = $personelNo;\r\n+            }\r\n+        }\r\n+    } \r\n+    // Eğer Alt Bayi boş ama Bayi Ad Soyad seçildiyse, bayinin tüm personel kimlik nolarını kullan\r\n+    elseif (!empty($bayiAdSoyad)) {\r\n         try {\r\n-            // Seçilen bayinin personel_kimlik_no kodunu al\r\n+            // Seçilen bayinin tüm personel_kimlik_no kodlarını al\r\n             $bayiPersonelKimlikQuery = \"SELECT personel_kimlik_no FROM users_bayi WHERE user_id = ?\";\r\n             $bayiPersonelKimlikStmt = $conn->prepare($bayiPersonelKimlikQuery);\r\n             $bayiPersonelKimlikStmt->execute([$bayiAdSoyad]);\r\n-            $bayiPersonelKimlikResult = $bayiPersonelKimlikStmt->fetch(PDO::FETCH_ASSOC);\r\n+            $bayiPersonelKimlikResults = $bayiPersonelKimlikStmt->fetchAll(PDO::FETCH_ASSOC);\r\n             \r\n-            if ($bayiPersonelKimlikResult && !empty($bayiPersonelKimlikResult['personel_kimlik_no'])) {\r\n-                $whereConditions[] = \"TALEBI_GIREN_PERSONELNO = ?\";\r\n-                $params[] = $bayiPersonelKimlikResult['personel_kimlik_no'];\r\n+            if (!empty($bayiPersonelKimlikResults)) {\r\n+                $personelKimlikNos = array_column($bayiPersonelKimlikResults, 'personel_kimlik_no');\r\n+                $personelKimlikNos = array_filter($personelKimlikNos); // Boş değerleri temizle\r\n+                \r\n+                if (!empty($personelKimlikNos)) {\r\n+                    // Birden fazla personel_kimlik_no varsa IN operatörü kullan\r\n+                    $placeholders = str_repeat('?,', count($personelKimlikNos) - 1) . '?';\r\n+                    $whereConditions[] = \"TALEBI_GIREN_PERSONELNO IN ($placeholders)\";\r\n+                    foreach ($personelKimlikNos as $pkNo) {\r\n+                        $params[] = $pkNo;\r\n+                    }\r\n+                }\r\n             }\r\n         } catch (Exception $e) {\r\n             // Hata durumunda filtreyi atlayalım\r\n             error_log(\"Bayi Ad Soyad filtresi hatası: \" . $e->getMessage());\r\n@@ -503,17 +523,19 @@\n                         <div class=\"col-md-2\">\r\n                             <label for=\"alt_bayi\" class=\"form-label\">\r\n                                 <i class=\"fas fa-user-tie me-1\"></i>Personel Kimlik No\r\n                             </label>\r\n-                            <select class=\"form-select\" id=\"alt_bayi\" name=\"alt_bayi\">\r\n-                                <option value=\"\">Tümü</option>\r\n+                            <select class=\"form-select\" id=\"alt_bayi\" name=\"alt_bayi[]\" multiple style=\"height: 38px;\">\r\n                                 <?php foreach ($altBayiOptions as $option): ?>\r\n                                     <option value=\"<?php echo htmlspecialchars($option); ?>\" \r\n-                                            <?php echo $altBayi === $option ? 'selected' : ''; ?>>\r\n+                                            <?php echo in_array($option, $altBayi) ? 'selected' : ''; ?>>\r\n                                         <?php echo htmlspecialchars($option); ?>\r\n                                     </option>\r\n                                 <?php endforeach; ?>\r\n                             </select>\r\n+                            <small class=\"form-text text-muted\">\r\n+                                <i class=\"fas fa-info-circle\"></i> Çoklu seçim için Ctrl+Tıklayın\r\n+                            </small>\r\n                         </div>\r\n                         <div class=\"col-md-2\">\r\n                             <label for=\"bayi_ad_soyad\" class=\"form-label\">\r\n                                 <i class=\"fas fa-user me-1\"></i>Bayi Ad Soyad\r\n@@ -522,11 +544,11 @@\n                                 <option value=\"\">Tümü</option>\r\n                                 <?php foreach ($bayiAdSoyadOptions as $id => $bayiData): ?>\r\n                                     <option value=\"<?php echo htmlspecialchars($id); ?>\" \r\n                                             <?php echo $bayiAdSoyad == $id ? 'selected' : ''; ?>\r\n-                                            data-personel-kimlik-no=\"<?php echo htmlspecialchars($bayiData['personel_kimlik_no']); ?>\">\r\n+                                            data-personel-kimlik-no=\"<?php echo htmlspecialchars(implode(',', $bayiData['personel_kimlik_no'])); ?>\">\r\n                                         <?php echo htmlspecialchars($bayiData['full_name']); ?> \r\n-                                        <small>(<?php echo htmlspecialchars($bayiData['personel_kimlik_no']); ?>)</small>\r\n+                                        <small>(<?php echo htmlspecialchars(implode(', ', $bayiData['personel_kimlik_no'])); ?>)</small>\r\n                                     </option>\r\n                                 <?php endforeach; ?>\r\n                             </select>\r\n                         </div>\r\n@@ -597,14 +619,16 @@\n                                     Satış: <?php echo htmlspecialchars($satisDurumu); ?>\r\n                                     <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('satis_durumu')\" style=\"font-size: 0.7em;\"></button>\r\n                                 </span>\r\n                             <?php endif; ?>\r\n-                            <?php if (!empty($altBayi)): ?>\r\n-                                <span class=\"badge bg-dark\">\r\n-                                    <i class=\"fas fa-user-tie me-1\"></i>\r\n-                                    Personel No: <?php echo htmlspecialchars($altBayi); ?>\r\n-                                    <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('alt_bayi')\" style=\"font-size: 0.7em;\"></button>\r\n-                                </span>\r\n+                            <?php if (!empty($altBayi) && is_array($altBayi)): ?>\r\n+                                <?php foreach ($altBayi as $personelNo): ?>\r\n+                                    <span class=\"badge bg-dark\">\r\n+                                        <i class=\"fas fa-user-tie me-1\"></i>\r\n+                                        Personel No: <?php echo htmlspecialchars($personelNo); ?>\r\n+                                        <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeArrayFilter('alt_bayi', '<?php echo htmlspecialchars($personelNo); ?>')\" style=\"font-size: 0.7em;\"></button>\r\n+                                    </span>\r\n+                                <?php endforeach; ?>\r\n                             <?php endif; ?>\r\n                             <?php if (!empty($bayiAdSoyad) && isset($bayiAdSoyadOptions[$bayiAdSoyad])): ?>\r\n                                 <span class=\"badge bg-secondary\">\r\n                                     <i class=\"fas fa-user me-1\"></i>\r\n@@ -671,9 +695,9 @@\n                             if (!empty($endDate)) $activeFilters++;\r\n                         }\r\n                         if (!empty($outletDurum)) $activeFilters++;\r\n                         if (!empty($satisDurumu)) $activeFilters++;\r\n-                        if (!empty($altBayi)) $activeFilters++;\r\n+                        if (!empty($altBayi) && is_array($altBayi)) $activeFilters += count($altBayi);\r\n                         if (!empty($bayiAdSoyad)) $activeFilters++;\r\n                         \r\n                         if ($activeFilters > 0) {\r\n                             echo $activeFilters . ' Filtre Aktif';\r\n@@ -705,10 +729,14 @@\n                         if (!empty($satisDurumu)) {\r\n                             $filterDetails[] = 'Satış: ' . $satisDurumu;\r\n                         }\r\n                         \r\n-                        if (!empty($altBayi)) {\r\n-                            $filterDetails[] = 'Personel No: ' . $altBayi;\r\n+                        if (!empty($altBayi) && is_array($altBayi)) {\r\n+                            if (count($altBayi) > 2) {\r\n+                                $filterDetails[] = 'Personel No: ' . implode(', ', array_slice($altBayi, 0, 2)) . '... (+' . (count($altBayi) - 2) . ')';\r\n+                            } else {\r\n+                                $filterDetails[] = 'Personel No: ' . implode(', ', $altBayi);\r\n+                            }\r\n                         }\r\n                         \r\n                         if (!empty($bayiAdSoyad) && isset($bayiAdSoyadOptions[$bayiAdSoyad])) {\r\n                             $filterDetails[] = 'Bayi: ' . $bayiAdSoyadOptions[$bayiAdSoyad]['full_name'];\r\n@@ -1041,9 +1069,15 @@\n     document.getElementById('end_date').value = '';\r\n     document.getElementById('outlet_durum').value = '';\r\n     document.getElementById('satis_durumu').value = '';\r\n     document.getElementById('hakedis_donemi').value = '';\r\n-    document.getElementById('alt_bayi').value = '';\r\n+    \r\n+    // Multi-select için tüm seçimleri kaldır\r\n+    const altBayiSelect = document.getElementById('alt_bayi');\r\n+    for (let i = 0; i < altBayiSelect.options.length; i++) {\r\n+        altBayiSelect.options[i].selected = false;\r\n+    }\r\n+    \r\n     document.getElementById('bayi_ad_soyad').value = '';\r\n     document.getElementById('filterForm').submit();\r\n }\r\n \r\n@@ -1052,8 +1086,19 @@\n     document.getElementById(filterName).value = '';\r\n     document.getElementById('filterForm').submit();\r\n }\r\n \r\n+// Array filtreyi kaldır (multi-select için)\r\n+function removeArrayFilter(filterName, value) {\r\n+    const select = document.getElementById(filterName);\r\n+    for (let i = 0; i < select.options.length; i++) {\r\n+        if (select.options[i].value === value) {\r\n+            select.options[i].selected = false;\r\n+        }\r\n+    }\r\n+    document.getElementById('filterForm').submit();\r\n+}\r\n+\r\n // Hızlı tarih aralığı seçimi\r\n function setDateRange(range) {\r\n     const today = new Date();\r\n     const startDateInput = document.getElementById('start_date');\r\n@@ -1232,24 +1277,39 @@\n             const selectedOption = this.options[this.selectedIndex];\r\n             const altBayiSelect = document.getElementById('alt_bayi');\r\n             \r\n             if (selectedOption.value && selectedOption.getAttribute('data-personel-kimlik-no') && altBayiSelect) {\r\n-                // Seçilen bayinin personel_kimlik_no kodunu al\r\n-                const personelKimlikNo = selectedOption.getAttribute('data-personel-kimlik-no');\r\n+                // Seçilen bayinin personel_kimlik_no kodlarını al (virgülle ayrılmış)\r\n+                const personelKimlikNos = selectedOption.getAttribute('data-personel-kimlik-no').split(',');\r\n                 \r\n-                // Alt bayi dropdown'unda bu değeri seç\r\n+                // Multi-select için tüm ilgili seçimleri temizle ve yeni seçimleri yap\r\n                 for (let i = 0; i < altBayiSelect.options.length; i++) {\r\n-                    if (altBayiSelect.options[i].value === personelKimlikNo) {\r\n-                        altBayiSelect.selectedIndex = i;\r\n-                        break;\r\n+                    altBayiSelect.options[i].selected = false;\r\n+                }\r\n+                \r\n+                if (personelKimlikNos.length > 0) {\r\n+                    // Tüm personel kimlik no'ları seç\r\n+                    personelKimlikNos.forEach(pkNo => {\r\n+                        const trimmedPkNo = pkNo.trim();\r\n+                        for (let i = 0; i < altBayiSelect.options.length; i++) {\r\n+                            if (altBayiSelect.options[i].value === trimmedPkNo) {\r\n+                                altBayiSelect.options[i].selected = true;\r\n+                            }\r\n+                        }\r\n+                    });\r\n+                    \r\n+                    // Bilgi mesajı göster\r\n+                    if (personelKimlikNos.length > 1) {\r\n+                        showToast(`Bayi seçildi: ${selectedOption.text.split('(')[0].trim()}. Bu bayiye kayıtlı ${personelKimlikNos.length} adet Personel Kimlik No otomatik seçildi.`, 'info');\r\n+                    } else {\r\n+                        showToast(`Bayi seçildi: ${selectedOption.text.split('(')[0].trim()}. Personel Kimlik No otomatik seçildi: ${personelKimlikNos[0].trim()}`, 'info');\r\n                     }\r\n                 }\r\n-                \r\n-                // Bilgi mesajı göster\r\n-                showToast(`Bayi seçildi: ${selectedOption.text.split('(')[0].trim()}. Personel Kimlik No otomatik seçildi: ${personelKimlikNo}`, 'info');\r\n             } else if (!selectedOption.value && altBayiSelect) {\r\n                 // Bayi seçimi temizlenirse alt bayi'yi de temizle\r\n-                altBayiSelect.selectedIndex = 0;\r\n+                for (let i = 0; i < altBayiSelect.options.length; i++) {\r\n+                    altBayiSelect.options[i].selected = false;\r\n+                }\r\n             }\r\n         });\r\n     }\r\n     \r\n@@ -1297,9 +1357,9 @@\n         });\r\n     }\r\n });\r\n \r\n-// Yazdırma için CSS\r\n+<!-- Yazdırma için CSS -->\r\n const printStyles = `\r\n     <style media=\"print\">\r\n         @page { margin: 1cm; }\r\n         .btn-group, .card-header .btn { display: none !important; }\r\n@@ -1310,7 +1370,37 @@\n         body { background: white !important; }\r\n     </style>\r\n `;\r\n document.head.insertAdjacentHTML('beforeend', printStyles);\r\n+\r\n+// Multi-select stil iyileştirme\r\n+const multiSelectStyles = `\r\n+    <style>\r\n+        #alt_bayi {\r\n+            min-height: 38px !important;\r\n+            height: auto !important;\r\n+            overflow-y: auto;\r\n+            max-height: 150px;\r\n+        }\r\n+        #alt_bayi option {\r\n+            padding: 8px 12px;\r\n+            border-bottom: 1px solid #f0f0f0;\r\n+            cursor: pointer;\r\n+        }\r\n+        #alt_bayi option:hover {\r\n+            background-color: #e9ecef;\r\n+        }\r\n+        #alt_bayi option:checked {\r\n+            background: linear-gradient(0deg, #0d6efd 0%, #0d6efd 100%);\r\n+            color: white;\r\n+            font-weight: 500;\r\n+        }\r\n+        #alt_bayi option:checked::before {\r\n+            content: \"✓ \";\r\n+            font-weight: bold;\r\n+        }\r\n+    </style>\r\n+`;\r\n+document.head.insertAdjacentHTML('beforeend', multiSelectStyles);\r\n </script>\r\n \r\n <?php include 'includes/footer.php'; ?>\r\n"
                },
                {
                    "date": 1760974284955,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,9 +18,9 @@\n \r\n // Varsayılan filtreler - sadece herhangi bir parametre yoksa\r\n $hasAnyParam = !empty($_GET);\r\n $outletDurum = isset($_GET['outlet_durum']) ? $_GET['outlet_durum'] : ($hasAnyParam ? '' : 'AKTIF');\r\n-$satisDurumu = isset($_GET['satis_durumu']) ? $_GET['satis_durumu'] : '';\r\n+$satisDurumu = isset($_GET['satis_durumu']) ? $_GET['satis_durumu'] : ($hasAnyParam ? '' : 'Tamamlandı');\r\n $hakedisDonemi = isset($_GET['hakedis_donemi']) ? $_GET['hakedis_donemi'] : '';\r\n $altBayi = isset($_GET['alt_bayi']) ? (is_array($_GET['alt_bayi']) ? $_GET['alt_bayi'] : [$_GET['alt_bayi']]) : [];\r\n $bayiAdSoyad = isset($_GET['bayi_ad_soyad']) ? $_GET['bayi_ad_soyad'] : '';\r\n \r\n@@ -519,9 +519,9 @@\n                                     </option>\r\n                                 <?php endforeach; ?>\r\n                             </select>\r\n                         </div>\r\n-                        <div class=\"col-md-2\">\r\n+                        <div class=\"col-md-2\" style=\"display: none;\">\r\n                             <label for=\"alt_bayi\" class=\"form-label\">\r\n                                 <i class=\"fas fa-user-tie me-1\"></i>Personel Kimlik No\r\n                             </label>\r\n                             <select class=\"form-select\" id=\"alt_bayi\" name=\"alt_bayi[]\" multiple style=\"height: 38px;\">\r\n"
                },
                {
                    "date": 1760974411592,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -334,16 +334,17 @@\n     // Pivot sorgusu - TALEBI_GIREN_PERSONEL_ALTBAYI satır, MEMO_KAYIT_TIPI sütun\r\n     $sql = \"\r\n     SELECT \r\n         ISNULL(TALEBI_GIREN_PERSONEL_ALTBAYI, 'Belirtilmemiş') as ALTBAYI,\r\n+        TALEBI_GIREN_PERSONELNO as PERSONEL_NO,\r\n         SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'ISP ve Neo Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_NEO,\r\n         SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'Uydu ve ISP Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_UYDU,\r\n         SUM(CASE WHEN MEMO_KAYIT_TIPI = 'NEO' THEN 1 ELSE 0 END) as NEO,\r\n         SUM(CASE WHEN MEMO_KAYIT_TIPI = 'UYDU' THEN 1 ELSE 0 END) as UYDU,\r\n         COUNT(*) as TOPLAM\r\n     FROM digiturk.iris_rapor \r\n     $whereClause\r\n-    GROUP BY TALEBI_GIREN_PERSONEL_ALTBAYI\r\n+    GROUP BY TALEBI_GIREN_PERSONEL_ALTBAYI, TALEBI_GIREN_PERSONELNO\r\n     ORDER BY TOPLAM DESC, ALTBAYI\r\n     \";\r\n     \r\n     // Main pivot query with error handling\r\n@@ -852,8 +853,14 @@\n                                 <?php foreach ($pivotData as $row): ?>\r\n                                     <tr>\r\n                                         <td class=\"ps-3 fw-medium\">\r\n                                             <?php echo htmlspecialchars($row['ALTBAYI']); ?>\r\n+                                            <?php if (!empty($row['PERSONEL_NO'])): ?>\r\n+                                                <br>\r\n+                                                <small class=\"text-muted\">\r\n+                                                    <i class=\"fas fa-id-card me-1\"></i><?php echo htmlspecialchars($row['PERSONEL_NO']); ?>\r\n+                                                </small>\r\n+                                            <?php endif; ?>\r\n                                         </td>\r\n                                         \r\n                         <?php foreach ($columns as $column): ?>\r\n                             <?php \r\n"
                },
                {
                    "date": 1760974916246,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -358,8 +358,19 @@\n     } catch (Exception $e) {\r\n         $pivotData = [];\r\n     }\r\n     \r\n+    // Sistemde kayıtlı personel kimlik nolarını al (renklendirme için)\r\n+    $registeredPersonelNos = [];\r\n+    try {\r\n+        $registeredSql = \"SELECT DISTINCT personel_kimlik_no FROM users_bayi WHERE personel_kimlik_no IS NOT NULL AND personel_kimlik_no != ''\";\r\n+        $registeredStmt = $conn->prepare($registeredSql);\r\n+        $registeredStmt->execute();\r\n+        $registeredPersonelNos = $registeredStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+    } catch (Exception $e) {\r\n+        $registeredPersonelNos = [];\r\n+    }\r\n+    \r\n     // Sütun başlıklarını manuel olarak belirle (ISP'yi ISP_NEO ve ISP_UYDU olarak böl)\r\n     $columns = ['ISP_NEO', 'ISP_UYDU', 'NEO', 'UYDU'];\r\n     \r\n     // Genel istatistikler (aynı filtrelerle)\r\n@@ -850,10 +861,18 @@\n                                 $grandTotal = 0;\r\n                                 ?>\r\n                                 \r\n                                 <?php foreach ($pivotData as $row): ?>\r\n-                                    <tr>\r\n+                                    <?php \r\n+                                    // Personel no sistemde kayıtlı mı kontrol et\r\n+                                    $isRegistered = !empty($row['PERSONEL_NO']) && in_array($row['PERSONEL_NO'], $registeredPersonelNos);\r\n+                                    $rowClass = $isRegistered ? 'table-success' : '';\r\n+                                    ?>\r\n+                                    <tr class=\"<?php echo $rowClass; ?>\">\r\n                                         <td class=\"ps-3 fw-medium\">\r\n+                                            <?php if ($isRegistered): ?>\r\n+                                                <i class=\"fas fa-check-circle text-success me-1\" title=\"Sistemde kayıtlı\"></i>\r\n+                                            <?php endif; ?>\r\n                                             <?php echo htmlspecialchars($row['ALTBAYI']); ?>\r\n                                             <?php if (!empty($row['PERSONEL_NO'])): ?>\r\n                                                 <br>\r\n                                                 <small class=\"text-muted\">\r\n"
                },
                {
                    "date": 1760975020930,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -842,8 +842,9 @@\n                     <table class=\"table table-hover mb-0\" id=\"pivotTable\">\r\n                         <thead class=\"table-light sticky-top\">\r\n                             <tr>\r\n                                 <th class=\"text-start ps-3\">Alt Bayi Kodu</th>\r\n+                                <th class=\"text-center\">Hakediş Dönemi</th>\r\n                                 <?php if (!empty($columns)): ?>\r\n                                     <?php foreach ($columns as $column): ?>\r\n                                         <th class=\"text-center\"><?php echo htmlspecialchars($column); ?></th>\r\n                                     <?php endforeach; ?>\r\n@@ -879,8 +880,20 @@\n                                                     <i class=\"fas fa-id-card me-1\"></i><?php echo htmlspecialchars($row['PERSONEL_NO']); ?>\r\n                                                 </small>\r\n                                             <?php endif; ?>\r\n                                         </td>\r\n+                                        <td class=\"text-center\">\r\n+                                            <?php \r\n+                                            // Hakediş dönemi bilgisini göster\r\n+                                            if (!empty($hakedisDonemi) && isset($hakedisDonemleri[$hakedisDonemi])) {\r\n+                                                echo '<span class=\"badge bg-info\">' . htmlspecialchars($hakedisDonemleri[$hakedisDonemi]['label']) . '</span>';\r\n+                                            } elseif (!empty($startDate) && !empty($endDate)) {\r\n+                                                echo '<small class=\"text-muted\">' . date('d.m.Y', strtotime($startDate)) . ' - ' . date('d.m.Y', strtotime($endDate)) . '</small>';\r\n+                                            } else {\r\n+                                                echo '<span class=\"text-muted\">-</span>';\r\n+                                            }\r\n+                                            ?>\r\n+                                        </td>\r\n                                         \r\n                         <?php foreach ($columns as $column): ?>\r\n                             <?php \r\n                             $value = 0;\r\n@@ -916,8 +929,9 @@\n                                 \r\n                                 <!-- Toplam Satırı -->\r\n                                 <tr class=\"table-secondary\">\r\n                                     <td class=\"ps-3 fw-bold\">TOPLAM</td>\r\n+                                    <td class=\"text-center fw-bold\">-</td>\r\n                                     <?php foreach ($columns as $column): ?>\r\n                                         <td class=\"text-center fw-bold\">\r\n                                             <?php echo number_format($totalRow[$column]); ?>\r\n                                         </td>\r\n@@ -928,9 +942,9 @@\n                                 </tr>\r\n                                 \r\n                             <?php else: ?>\r\n                                 <tr>\r\n-                                    <td colspan=\"<?php echo count($columns) + 2; ?>\" class=\"text-center py-5 text-muted\">\r\n+                                    <td colspan=\"<?php echo count($columns) + 3; ?>\" class=\"text-center py-5 text-muted\">\r\n                                         <i class=\"fas fa-search fa-2x mb-3 d-block\"></i>\r\n                         <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($satisDurumu) || !empty($hakedisDonemi) || !empty($altBayi) || !empty($bayiAdSoyad)): ?>\r\n                             <h5>Belirtilen kriterlere uygun veri bulunamadı</h5>\r\n                             <p class=\"mb-0\">\r\n"
                },
                {
                    "date": 1760976426091,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -335,16 +335,17 @@\n     $sql = \"\r\n     SELECT \r\n         ISNULL(TALEBI_GIREN_PERSONEL_ALTBAYI, 'Belirtilmemiş') as ALTBAYI,\r\n         TALEBI_GIREN_PERSONELNO as PERSONEL_NO,\r\n+        TALEBI_GIREN_PERSONEL as TALEBI_GIREN_PERSONEL,\r\n         SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'ISP ve Neo Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_NEO,\r\n         SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'Uydu ve ISP Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_UYDU,\r\n         SUM(CASE WHEN MEMO_KAYIT_TIPI = 'NEO' THEN 1 ELSE 0 END) as NEO,\r\n         SUM(CASE WHEN MEMO_KAYIT_TIPI = 'UYDU' THEN 1 ELSE 0 END) as UYDU,\r\n         COUNT(*) as TOPLAM\r\n     FROM digiturk.iris_rapor \r\n     $whereClause\r\n-    GROUP BY TALEBI_GIREN_PERSONEL_ALTBAYI, TALEBI_GIREN_PERSONELNO\r\n+    GROUP BY TALEBI_GIREN_PERSONEL_ALTBAYI, TALEBI_GIREN_PERSONELNO, TALEBI_GIREN_PERSONEL\r\n     ORDER BY TOPLAM DESC, ALTBAYI\r\n     \";\r\n     \r\n     // Main pivot query with error handling\r\n@@ -879,8 +880,14 @@\n                                                 <small class=\"text-muted\">\r\n                                                     <i class=\"fas fa-id-card me-1\"></i><?php echo htmlspecialchars($row['PERSONEL_NO']); ?>\r\n                                                 </small>\r\n                                             <?php endif; ?>\r\n+                                            <?php if (!empty($row['TALEBI_GIREN_PERSONEL'])): ?>\r\n+                                                <br>\r\n+                                                <small class=\"text-muted\">\r\n+                                                    <i class=\"fas fa-user me-1\"></i><?php echo htmlspecialchars($row['TALEBI_GIREN_PERSONEL']); ?>\r\n+                                                </small>\r\n+                                            <?php endif; ?>\r\n                                         </td>\r\n                                         <td class=\"text-center\">\r\n                                             <?php \r\n                                             // Hakediş dönemi bilgisini göster\r\n"
                },
                {
                    "date": 1760976648572,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,8 +23,17 @@\n $hakedisDonemi = isset($_GET['hakedis_donemi']) ? $_GET['hakedis_donemi'] : '';\r\n $altBayi = isset($_GET['alt_bayi']) ? (is_array($_GET['alt_bayi']) ? $_GET['alt_bayi'] : [$_GET['alt_bayi']]) : [];\r\n $bayiAdSoyad = isset($_GET['bayi_ad_soyad']) ? $_GET['bayi_ad_soyad'] : '';\r\n \r\n+// Kullanıcının grup bilgisini al\r\n+$userGroupId = $currentUser['group_id'] ?? null;\r\n+$isRestrictedUser = ($userGroupId == 3); // Grup ID 3 olan kullanıcılar kısıtlı\r\n+\r\n+// Eğer kullanıcı grup 3 ise, sadece kendi kaydını gösterecek\r\n+if ($isRestrictedUser) {\r\n+    $bayiAdSoyad = $currentUser['id'];\r\n+}\r\n+\r\n // Hakediş dönemlerini veritabanından al (veritabanı bağlantısı kurulduktan sonra)\r\n $hakedisDonemleri = [];\r\n $altBayiList = [];\r\n \r\n@@ -552,19 +561,32 @@\n                         <div class=\"col-md-2\">\r\n                             <label for=\"bayi_ad_soyad\" class=\"form-label\">\r\n                                 <i class=\"fas fa-user me-1\"></i>Bayi Ad Soyad\r\n                             </label>\r\n-                            <select class=\"form-select\" id=\"bayi_ad_soyad\" name=\"bayi_ad_soyad\">\r\n+                            <select class=\"form-select\" id=\"bayi_ad_soyad\" name=\"bayi_ad_soyad\" <?php echo $isRestrictedUser ? 'disabled' : ''; ?>>\r\n                                 <option value=\"\">Tümü</option>\r\n                                 <?php foreach ($bayiAdSoyadOptions as $id => $bayiData): ?>\r\n+                                    <?php \r\n+                                    // Kısıtlı kullanıcı ise sadece kendi kaydını göster\r\n+                                    if ($isRestrictedUser && $id != $currentUser['id']) {\r\n+                                        continue;\r\n+                                    }\r\n+                                    ?>\r\n                                     <option value=\"<?php echo htmlspecialchars($id); ?>\" \r\n                                             <?php echo $bayiAdSoyad == $id ? 'selected' : ''; ?>\r\n                                             data-personel-kimlik-no=\"<?php echo htmlspecialchars(implode(',', $bayiData['personel_kimlik_no'])); ?>\">\r\n                                         <?php echo htmlspecialchars($bayiData['full_name']); ?> \r\n                                         <small>(<?php echo htmlspecialchars(implode(', ', $bayiData['personel_kimlik_no'])); ?>)</small>\r\n                                     </option>\r\n                                 <?php endforeach; ?>\r\n                             </select>\r\n+                            <?php if ($isRestrictedUser): ?>\r\n+                                <!-- Kısıtlı kullanıcı için hidden input ile değeri gönder -->\r\n+                                <input type=\"hidden\" name=\"bayi_ad_soyad\" value=\"<?php echo htmlspecialchars($currentUser['id']); ?>\">\r\n+                                <small class=\"text-muted\">\r\n+                                    <i class=\"fas fa-info-circle\"></i> Sadece kendi kayıtlarınızı görüntüleyebilirsiniz\r\n+                                </small>\r\n+                            <?php endif; ?>\r\n                         </div>\r\n                         <div class=\"col-md-2\">\r\n                             <div class=\"btn-group w-100\">\r\n                                 <button type=\"submit\" class=\"btn btn-primary btn-lg\">\r\n"
                }
            ],
            "date": 1759329717817,
            "name": "Commit-0",
            "content": "<?php\r\n$pageTitle = \"Hakediş Hesaplama\";\r\n$breadcrumbs = [\r\n    ['title' => 'Hakediş Hesaplama']\r\n];\r\n\r\n// Auth kontrol\r\nrequire_once 'auth.php';\r\n$currentUser = checkAuth();\r\ncheckUserStatus();\r\nupdateLastActivity();\r\n\r\n// Veritabanı bağlantı fonksiyonu\r\nfunction getDatabaseConnection() {\r\n    $configFile = __DIR__ . '/config/mssql.php';\r\n    \r\n    if (!file_exists($configFile)) {\r\n        throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n    }\r\n    \r\n    $config = include $configFile;\r\n    \r\n    try {\r\n        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n        \r\n        $connection = new PDO($dsn, $config['username'], $config['password'], [\r\n            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n            PDO::ATTR_EMULATE_PREPARES => false\r\n        ]);\r\n        \r\n        return $connection;\r\n        \r\n    } catch (PDOException $e) {\r\n        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n    }\r\n}\r\n\r\n// Filtre parametrelerini al - varsayılan değerlerle\r\n$startDate = isset($_GET['start_date']) ? $_GET['start_date'] : '';\r\n$endDate = isset($_GET['end_date']) ? $_GET['end_date'] : '';\r\n\r\n// Varsayılan filtreler - sadece herhangi bir parametre yoksa\r\n$hasAnyParam = !empty($_GET);\r\n$outletDurum = isset($_GET['outlet_durum']) ? $_GET['outlet_durum'] : ($hasAnyParam ? '' : 'AKTIF');\r\n$satisDurumu = isset($_GET['satis_durumu']) ? $_GET['satis_durumu'] : ($hasAnyParam ? '' : 'TAMAMLANDI');\r\n$hakedisDonemi = isset($_GET['hakedis_donemi']) ? $_GET['hakedis_donemi'] : '';\r\n$altBayi = isset($_GET['alt_bayi']) ? $_GET['alt_bayi'] : '';\r\n\r\n// Hakediş dönemlerine göre tarih aralıkları\r\n$hakedisDonemleri = [\r\n    'eylul_2024' => [\r\n        'label' => 'Eylül 2024 Hakediş Dönemi',\r\n        'start' => '2024-09-04',\r\n        'end' => '2024-10-03'\r\n    ],\r\n    'ekim_2024' => [\r\n        'label' => 'Ekim 2024 Hakediş Dönemi',\r\n        'start' => '2024-10-04',\r\n        'end' => '2024-11-03'\r\n    ],\r\n    'kasim_2024' => [\r\n        'label' => 'Kasım 2024 Hakediş Dönemi',\r\n        'start' => '2024-11-04',\r\n        'end' => '2024-12-03'\r\n    ],\r\n    'aralik_2024' => [\r\n        'label' => 'Aralık 2024 Hakediş Dönemi',\r\n        'start' => '2024-12-04',\r\n        'end' => '2025-01-03'\r\n    ],\r\n    'ocak_2025' => [\r\n        'label' => 'Ocak 2025 Hakediş Dönemi',\r\n        'start' => '2025-01-04',\r\n        'end' => '2025-02-03'\r\n    ],\r\n    'subat_2025' => [\r\n        'label' => 'Şubat 2025 Hakediş Dönemi',\r\n        'start' => '2025-02-04',\r\n        'end' => '2025-03-03'\r\n    ],\r\n    'mart_2025' => [\r\n        'label' => 'Mart 2025 Hakediş Dönemi',\r\n        'start' => '2025-03-04',\r\n        'end' => '2025-04-03'\r\n    ],\r\n    'nisan_2025' => [\r\n        'label' => 'Nisan 2025 Hakediş Dönemi',\r\n        'start' => '2025-04-04',\r\n        'end' => '2025-05-03'\r\n    ],\r\n    'mayis_2025' => [\r\n        'label' => 'Mayıs 2025 Hakediş Dönemi',\r\n        'start' => '2025-05-04',\r\n        'end' => '2025-06-03'\r\n    ],\r\n    'haziran_2025' => [\r\n        'label' => 'Haziran 2025 Hakediş Dönemi',\r\n        'start' => '2025-06-04',\r\n        'end' => '2025-07-03'\r\n    ],\r\n    'temmuz_2025' => [\r\n        'label' => 'Temmuz 2025 Hakediş Dönemi',\r\n        'start' => '2025-07-04',\r\n        'end' => '2025-08-03'\r\n    ],\r\n    'agustos_2025' => [\r\n        'label' => 'Ağustos 2025 Hakediş Dönemi',\r\n        'start' => '2025-08-04',\r\n        'end' => '2025-09-03'\r\n    ],\r\n    'eylul_2025' => [\r\n        'label' => 'Eylül 2025 Hakediş Dönemi',\r\n        'start' => '2025-09-04',\r\n        'end' => '2025-10-03'\r\n    ]\r\n];\r\n\r\n// Hakediş dönemi seçildiyse tarih aralığını otomatik ayarla\r\nif (!empty($hakedisDonemi) && isset($hakedisDonemleri[$hakedisDonemi])) {\r\n    // Sadece tarih parametreleri manuel olarak set edilmemişse otomatik ayarla\r\n    if (empty($_GET['start_date']) && empty($_GET['end_date'])) {\r\n        $startDate = $hakedisDonemleri[$hakedisDonemi]['start'];\r\n        $endDate = $hakedisDonemleri[$hakedisDonemi]['end'];\r\n    }\r\n}\r\n\r\ntry {\r\n    $conn = getDatabaseConnection();\r\n    \r\n    // Önce GUNCEL_OUTLET_DURUM değerlerini al (dropdown için)\r\n    $outletDurumSql = \"SELECT DISTINCT GUNCEL_OUTLET_DURUM FROM iris_rapor WHERE GUNCEL_OUTLET_DURUM IS NOT NULL AND GUNCEL_OUTLET_DURUM != '' ORDER BY GUNCEL_OUTLET_DURUM\";\r\n    $outletDurumStmt = $conn->prepare($outletDurumSql);\r\n    $outletDurumStmt->execute();\r\n    $outletDurumOptions = $outletDurumStmt->fetchAll(PDO::FETCH_COLUMN);\r\n    \r\n    // SATIS_DURUMU değerlerini al (dropdown için)\r\n    $satisDurumuSql = \"SELECT DISTINCT SATIS_DURUMU FROM iris_rapor WHERE SATIS_DURUMU IS NOT NULL AND SATIS_DURUMU != '' ORDER BY SATIS_DURUMU\";\r\n    $satisDurumuStmt = $conn->prepare($satisDurumuSql);\r\n    $satisDurumuStmt->execute();\r\n    $satisDurumuOptions = $satisDurumuStmt->fetchAll(PDO::FETCH_COLUMN);\r\n    \r\n    // Alt Bayi değerlerini al (dropdown için)\r\n    $altBayiSql = \"SELECT DISTINCT TALEBI_GIREN_PERSONEL_ALTBAYI FROM iris_rapor WHERE TALEBI_GIREN_PERSONEL_ALTBAYI IS NOT NULL AND TALEBI_GIREN_PERSONEL_ALTBAYI != '' ORDER BY TALEBI_GIREN_PERSONEL_ALTBAYI\";\r\n    $altBayiStmt = $conn->prepare($altBayiSql);\r\n    $altBayiStmt->execute();\r\n    $altBayiOptions = $altBayiStmt->fetchAll(PDO::FETCH_COLUMN);\r\n    \r\n    // WHERE koşullarını hazırla\r\n    $whereConditions = [];\r\n    $params = [];\r\n    \r\n    // Temel koşullar\r\n    $whereConditions[] = \"TALEBI_GIREN_PERSONEL_ALTBAYI IS NOT NULL\";\r\n    $whereConditions[] = \"TALEBI_GIREN_PERSONEL_ALTBAYI != ''\";\r\n    \r\n    // Tarih filtresi\r\n    if (!empty($startDate)) {\r\n        $whereConditions[] = \"MEMO_KAPANIS_TARIHI >= ?\";\r\n        $params[] = $startDate . ' 00:00:00';\r\n    }\r\n    \r\n    if (!empty($endDate)) {\r\n        $whereConditions[] = \"MEMO_KAPANIS_TARIHI <= ?\";\r\n        $params[] = $endDate . ' 23:59:59';\r\n    }\r\n    \r\n    // Outlet durum filtresi\r\n    if (!empty($outletDurum)) {\r\n        $whereConditions[] = \"GUNCEL_OUTLET_DURUM = ?\";\r\n        $params[] = $outletDurum;\r\n    }\r\n    \r\n    // Satış durumu filtresi\r\n    if (!empty($satisDurumu)) {\r\n        $whereConditions[] = \"SATIS_DURUMU = ?\";\r\n        $params[] = $satisDurumu;\r\n    }\r\n    \r\n    // Alt bayi filtresi\r\n    if (!empty($altBayi)) {\r\n        $whereConditions[] = \"TALEBI_GIREN_PERSONEL_ALTBAYI = ?\";\r\n        $params[] = $altBayi;\r\n    }\r\n    \r\n    $whereClause = \"WHERE \" . implode(\" AND \", $whereConditions);\r\n    \r\n    // Pivot sorgusu - TALEBI_GIREN_PERSONEL_ALTBAYI satır, MEMO_KAYIT_TIPI sütun\r\n    $sql = \"\r\n    SELECT \r\n        ISNULL(TALEBI_GIREN_PERSONEL_ALTBAYI, 'Belirtilmemiş') as ALTBAYI,\r\n        SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'ISP ve Neo Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_NEO,\r\n        SUM(CASE WHEN MEMO_KAYIT_TIPI = 'ISP' AND TALEP_TURU = 'Uydu ve ISP Potansiyel Talep' THEN 1 ELSE 0 END) as ISP_UYDU,\r\n        SUM(CASE WHEN MEMO_KAYIT_TIPI = 'NEO' THEN 1 ELSE 0 END) as NEO,\r\n        SUM(CASE WHEN MEMO_KAYIT_TIPI = 'UYDU' THEN 1 ELSE 0 END) as UYDU,\r\n        COUNT(*) as TOPLAM\r\n    FROM iris_rapor \r\n    $whereClause\r\n    GROUP BY TALEBI_GIREN_PERSONEL_ALTBAYI\r\n    ORDER BY TOPLAM DESC, ALTBAYI\r\n    \";\r\n    \r\n    $stmt = $conn->prepare($sql);\r\n    $stmt->execute($params);\r\n    $pivotData = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    // Sütun başlıklarını manuel olarak belirle (ISP'yi ISP_NEO ve ISP_UYDU olarak böl)\r\n    $columns = ['ISP_NEO', 'ISP_UYDU', 'NEO', 'UYDU'];\r\n    \r\n    // Genel istatistikler (aynı filtrelerle)\r\n    $statsSql = \"\r\n    SELECT \r\n        COUNT(*) as toplam_kayit,\r\n        COUNT(DISTINCT TALEBI_GIREN_PERSONEL_ALTBAYI) as toplam_altbayi,\r\n        COUNT(DISTINCT MEMO_KAYIT_TIPI) as toplam_kayit_tipi\r\n    FROM iris_rapor\r\n    $whereClause\r\n    \";\r\n    \r\n    $statsStmt = $conn->prepare($statsSql);\r\n    $statsStmt->execute($params);\r\n    $stats = $statsStmt->fetch(PDO::FETCH_ASSOC);\r\n    \r\n} catch (Exception $e) {\r\n    $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n}\r\n\r\ninclude 'includes/header.php';\r\n?>\r\n\r\n<div class=\"container-fluid mt-4\">\r\n    <div class=\"row\">\r\n        <div class=\"col-12\">\r\n            <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n                <h2><i class=\"fas fa-calculator me-2\"></i>Hakediş Hesaplama Raporu</h2>\r\n                <div class=\"btn-group\">\r\n                    <button class=\"btn btn-outline-primary\" onclick=\"exportToExcel()\">\r\n                        <i class=\"fas fa-file-excel me-1\"></i>Excel'e Aktar\r\n                    </button>\r\n                    <button class=\"btn btn-outline-secondary\" onclick=\"printReport()\">\r\n                        <i class=\"fas fa-print me-1\"></i>Yazdır\r\n                    </button>\r\n                    <button class=\"btn btn-outline-info\" onclick=\"refreshData()\">\r\n                        <i class=\"fas fa-sync-alt me-1\"></i>Yenile\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Filtre Formu -->\r\n    <div class=\"card border-0 shadow-sm mb-4\">\r\n        <div class=\"card-header bg-light\">\r\n            <h6 class=\"mb-0\">\r\n                <i class=\"fas fa-filter me-2\"></i>Filtreler\r\n                <button class=\"btn btn-sm btn-outline-secondary float-end\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#filterCollapse\">\r\n                    <i class=\"fas fa-chevron-down\"></i>\r\n                </button>\r\n            </h6>\r\n        </div>\r\n        <div class=\"collapse show\" id=\"filterCollapse\">\r\n            <div class=\"card-body\">\r\n                <form method=\"GET\" action=\"\" id=\"filterForm\">\r\n                    <!-- Birinci Satır: Hakediş Dönemi ve Tarih Filtreleri -->\r\n                    <div class=\"row g-3 align-items-end mb-3\">\r\n                        <div class=\"col-md-3\">\r\n                            <label for=\"hakedis_donemi\" class=\"form-label\">\r\n                                <i class=\"fas fa-calendar-check me-1\"></i>Hakediş Dönemi\r\n                            </label>\r\n                            <select class=\"form-select\" id=\"hakedis_donemi\" name=\"hakedis_donemi\">\r\n                                <option value=\"\">Manuel Tarih Seçimi</option>\r\n                                <?php foreach ($hakedisDonemleri as $key => $donem): ?>\r\n                                    <option value=\"<?php echo $key; ?>\" \r\n                                            <?php echo $hakedisDonemi === $key ? 'selected' : ''; ?>>\r\n                                        <?php echo htmlspecialchars($donem['label']); ?>\r\n                                    </option>\r\n                                <?php endforeach; ?>\r\n                            </select>\r\n                        </div>\r\n                        <div class=\"col-md-3\">\r\n                            <label for=\"start_date\" class=\"form-label\">\r\n                                <i class=\"fas fa-calendar-alt me-1\"></i>Başlangıç Tarihi\r\n                            </label>\r\n                            <input type=\"date\" \r\n                                   class=\"form-control\" \r\n                                   id=\"start_date\" \r\n                                   name=\"start_date\" \r\n                                   value=\"<?php echo htmlspecialchars($startDate); ?>\"\r\n                                   <?php echo !empty($hakedisDonemi) ? 'readonly' : ''; ?>>\r\n                        </div>\r\n                        <div class=\"col-md-3\">\r\n                            <label for=\"end_date\" class=\"form-label\">\r\n                                <i class=\"fas fa-calendar-alt me-1\"></i>Bitiş Tarihi\r\n                            </label>\r\n                            <input type=\"date\" \r\n                                   class=\"form-control\" \r\n                                   id=\"end_date\" \r\n                                   name=\"end_date\" \r\n                                   value=\"<?php echo htmlspecialchars($endDate); ?>\"\r\n                                   <?php echo !empty($hakedisDonemi) ? 'readonly' : ''; ?>>\r\n                        </div>\r\n                        <div class=\"col-md-3\">\r\n                            <div class=\"btn-group w-100\">\r\n                                <button type=\"button\" class=\"btn btn-outline-info btn-sm\" onclick=\"setDateRange('today')\" <?php echo !empty($hakedisDonemi) ? 'disabled' : ''; ?>>\r\n                                    <i class=\"fas fa-calendar-day me-1\"></i>Bugün\r\n                                </button>\r\n                                <button type=\"button\" class=\"btn btn-outline-info btn-sm\" onclick=\"setDateRange('week')\" <?php echo !empty($hakedisDonemi) ? 'disabled' : ''; ?>>\r\n                                    <i class=\"fas fa-calendar-week me-1\"></i>Bu Hafta\r\n                                </button>\r\n                                <button type=\"button\" class=\"btn btn-outline-info btn-sm\" onclick=\"setDateRange('month')\" <?php echo !empty($hakedisDonemi) ? 'disabled' : ''; ?>>\r\n                                    <i class=\"fas fa-calendar me-1\"></i>Bu Ay\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <!-- İkinci Satır: Diğer Filtreler ve Butonlar -->\r\n                    <div class=\"row g-3 align-items-end\">\r\n                        <div class=\"col-md-2\">\r\n                            <label for=\"outlet_durum\" class=\"form-label\">\r\n                                <i class=\"fas fa-store me-1\"></i>Outlet Durum\r\n                            </label>\r\n                            <select class=\"form-select\" id=\"outlet_durum\" name=\"outlet_durum\">\r\n                                <option value=\"\">Tümü</option>\r\n                                <?php foreach ($outletDurumOptions as $option): ?>\r\n                                    <option value=\"<?php echo htmlspecialchars($option); ?>\" \r\n                                            <?php echo $outletDurum === $option ? 'selected' : ''; ?>>\r\n                                        <?php echo htmlspecialchars($option); ?>\r\n                                    </option>\r\n                                <?php endforeach; ?>\r\n                            </select>\r\n                        </div>\r\n                        <div class=\"col-md-2\">\r\n                            <label for=\"satis_durumu\" class=\"form-label\">\r\n                                <i class=\"fas fa-shopping-cart me-1\"></i>Satış Durumu\r\n                            </label>\r\n                            <select class=\"form-select\" id=\"satis_durumu\" name=\"satis_durumu\">\r\n                                <option value=\"\">Tümü</option>\r\n                                <?php foreach ($satisDurumuOptions as $option): ?>\r\n                                    <option value=\"<?php echo htmlspecialchars($option); ?>\" \r\n                                            <?php echo $satisDurumu === $option ? 'selected' : ''; ?>>\r\n                                        <?php echo htmlspecialchars($option); ?>\r\n                                    </option>\r\n                                <?php endforeach; ?>\r\n                            </select>\r\n                        </div>\r\n                        <div class=\"col-md-2\">\r\n                            <label for=\"alt_bayi\" class=\"form-label\">\r\n                                <i class=\"fas fa-user-tie me-1\"></i>Alt Bayi\r\n                            </label>\r\n                            <select class=\"form-select\" id=\"alt_bayi\" name=\"alt_bayi\">\r\n                                <option value=\"\">Tümü</option>\r\n                                <?php foreach ($altBayiOptions as $option): ?>\r\n                                    <option value=\"<?php echo htmlspecialchars($option); ?>\" \r\n                                            <?php echo $altBayi === $option ? 'selected' : ''; ?>>\r\n                                        <?php echo htmlspecialchars($option); ?>\r\n                                    </option>\r\n                                <?php endforeach; ?>\r\n                            </select>\r\n                        </div>\r\n                        <div class=\"col-md-3\">\r\n                            <div class=\"btn-group w-100\">\r\n                                <button type=\"submit\" class=\"btn btn-primary btn-lg\">\r\n                                    <i class=\"fas fa-search me-1\"></i>Filtrele\r\n                                </button>\r\n                                <button type=\"button\" class=\"btn btn-outline-secondary btn-lg\" onclick=\"clearFilters()\">\r\n                                    <i class=\"fas fa-times me-1\"></i>Temizle\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"col-md-3\">\r\n                            <?php if (!empty($hakedisDonemi) && isset($hakedisDonemleri[$hakedisDonemi])): ?>\r\n                                <div class=\"alert alert-info mb-0 py-2\">\r\n                                    <i class=\"fas fa-info-circle me-1\"></i>\r\n                                    <strong><?php echo htmlspecialchars($hakedisDonemleri[$hakedisDonemi]['label']); ?></strong>\r\n                                    <br>\r\n                                    <small>\r\n                                        <?php echo date('d.m.Y', strtotime($hakedisDonemleri[$hakedisDonemi]['start'])); ?> - \r\n                                        <?php echo date('d.m.Y', strtotime($hakedisDonemleri[$hakedisDonemi]['end'])); ?>\r\n                                    </small>\r\n                                </div>\r\n                            <?php else: ?>\r\n                                <div class=\"text-muted\">\r\n                                    <small>\r\n                                        <i class=\"fas fa-calendar me-1\"></i>\r\n                                        Manuel tarih seçimi aktif\r\n                                    </small>\r\n                                </div>\r\n                            <?php endif; ?>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <!-- Aktif Filtreler -->\r\n                    <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($satisDurumu) || !empty($hakedisDonemi) || !empty($altBayi)): ?>\r\n                    <div class=\"mt-3\">\r\n                        <h6 class=\"text-muted mb-2\">\r\n                            <i class=\"fas fa-filter me-1\"></i>Aktif Filtreler:\r\n                        </h6>\r\n                        <div class=\"d-flex flex-wrap gap-2\">\r\n                            <?php if (!empty($hakedisDonemi) && isset($hakedisDonemleri[$hakedisDonemi])): ?>\r\n                                <span class=\"badge bg-info\">\r\n                                    <i class=\"fas fa-calendar-check me-1\"></i>\r\n                                    <?php echo htmlspecialchars($hakedisDonemleri[$hakedisDonemi]['label']); ?>\r\n                                    <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('hakedis_donemi')\" style=\"font-size: 0.7em;\"></button>\r\n                                </span>\r\n                            <?php else: ?>\r\n                                <?php if (!empty($startDate)): ?>\r\n                                    <span class=\"badge bg-primary\">\r\n                                        <i class=\"fas fa-calendar me-1\"></i>\r\n                                        Başlangıç: <?php echo date('d.m.Y', strtotime($startDate)); ?>\r\n                                        <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('start_date')\" style=\"font-size: 0.7em;\"></button>\r\n                                    </span>\r\n                                <?php endif; ?>\r\n                                <?php if (!empty($endDate)): ?>\r\n                                    <span class=\"badge bg-primary\">\r\n                                        <i class=\"fas fa-calendar me-1\"></i>\r\n                                        Bitiş: <?php echo date('d.m.Y', strtotime($endDate)); ?>\r\n                                        <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('end_date')\" style=\"font-size: 0.7em;\"></button>\r\n                                    </span>\r\n                                <?php endif; ?>\r\n                            <?php endif; ?>\r\n                            <?php if (!empty($outletDurum)): ?>\r\n                                <span class=\"badge bg-success\">\r\n                                    <i class=\"fas fa-store me-1\"></i>\r\n                                    Outlet: <?php echo htmlspecialchars($outletDurum); ?>\r\n                                    <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('outlet_durum')\" style=\"font-size: 0.7em;\"></button>\r\n                                </span>\r\n                            <?php endif; ?>\r\n                            <?php if (!empty($satisDurumu)): ?>\r\n                                <span class=\"badge bg-warning\">\r\n                                    <i class=\"fas fa-shopping-cart me-1\"></i>\r\n                                    Satış: <?php echo htmlspecialchars($satisDurumu); ?>\r\n                                    <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('satis_durumu')\" style=\"font-size: 0.7em;\"></button>\r\n                                </span>\r\n                            <?php endif; ?>\r\n                            <?php if (!empty($altBayi)): ?>\r\n                                <span class=\"badge bg-dark\">\r\n                                    <i class=\"fas fa-user-tie me-1\"></i>\r\n                                    Alt Bayi: <?php echo htmlspecialchars($altBayi); ?>\r\n                                    <button type=\"button\" class=\"btn-close btn-close-white ms-1\" onclick=\"removeFilter('alt_bayi')\" style=\"font-size: 0.7em;\"></button>\r\n                                </span>\r\n                            <?php endif; ?>\r\n                        </div>\r\n                    </div>\r\n                    <?php endif; ?>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- İstatistik Kartları -->\r\n    <div class=\"row mb-4\">\r\n        <div class=\"col-md-3\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-body text-center\">\r\n                    <div class=\"text-primary mb-2\">\r\n                        <i class=\"fas fa-database fa-2x\"></i>\r\n                    </div>\r\n                    <h4 class=\"text-primary\"><?php echo isset($stats['toplam_kayit']) ? number_format($stats['toplam_kayit']) : '0'; ?></h4>\r\n                    <p class=\"text-muted mb-0\">Toplam Kayıt</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <div class=\"col-md-3\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-body text-center\">\r\n                    <div class=\"text-success mb-2\">\r\n                        <i class=\"fas fa-users fa-2x\"></i>\r\n                    </div>\r\n                    <h4 class=\"text-success\"><?php echo isset($stats['toplam_altbayi']) ? number_format($stats['toplam_altbayi']) : '0'; ?></h4>\r\n                    <p class=\"text-muted mb-0\">Alt Bayi Sayısı</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <div class=\"col-md-3\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-body text-center\">\r\n                    <div class=\"text-info mb-2\">\r\n                        <i class=\"fas fa-tags fa-2x\"></i>\r\n                    </div>\r\n                    <h4 class=\"text-info\"><?php echo isset($stats['toplam_kayit_tipi']) ? number_format($stats['toplam_kayit_tipi']) : '0'; ?></h4>\r\n                    <p class=\"text-muted mb-0\">Kayıt Tipi Sayısı</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <div class=\"col-md-3\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-body text-center\">\r\n                    <div class=\"text-warning mb-2\">\r\n                        <i class=\"fas fa-filter fa-2x\"></i>\r\n                    </div>\r\n                    <h4 class=\"text-warning\">\r\n                        <?php \r\n                        $activeFilters = 0;\r\n                        if (!empty($hakedisDonemi)) {\r\n                            $activeFilters++; // Hakediş dönemi seçildiyse tarih aralığı otomatik sayılır\r\n                        } else {\r\n                            if (!empty($startDate)) $activeFilters++;\r\n                            if (!empty($endDate)) $activeFilters++;\r\n                        }\r\n                        if (!empty($outletDurum)) $activeFilters++;\r\n                        if (!empty($satisDurumu)) $activeFilters++;\r\n                        if (!empty($altBayi)) $activeFilters++;\r\n                        \r\n                        if ($activeFilters > 0) {\r\n                            echo $activeFilters . ' Filtre Aktif';\r\n                        } else {\r\n                            echo 'Tüm Veriler';\r\n                        }\r\n                        ?>\r\n                    </h4>\r\n                    <p class=\"text-muted mb-0\">\r\n                        <?php \r\n                        $filterDetails = [];\r\n                        \r\n                        if (!empty($hakedisDonemi) && isset($hakedisDonemleri[$hakedisDonemi])) {\r\n                            $filterDetails[] = $hakedisDonemleri[$hakedisDonemi]['label'];\r\n                        } else {\r\n                            if (!empty($startDate) && !empty($endDate)) {\r\n                                $filterDetails[] = date('d.m.Y', strtotime($startDate)) . ' - ' . date('d.m.Y', strtotime($endDate));\r\n                            } elseif (!empty($startDate)) {\r\n                                $filterDetails[] = date('d.m.Y', strtotime($startDate)) . ' sonrası';\r\n                            } elseif (!empty($endDate)) {\r\n                                $filterDetails[] = date('d.m.Y', strtotime($endDate)) . ' öncesi';\r\n                            }\r\n                        }\r\n                        \r\n                        if (!empty($outletDurum)) {\r\n                            $filterDetails[] = 'Outlet: ' . $outletDurum;\r\n                        }\r\n                        \r\n                        if (!empty($satisDurumu)) {\r\n                            $filterDetails[] = 'Satış: ' . $satisDurumu;\r\n                        }\r\n                        \r\n                        if (!empty($altBayi)) {\r\n                            $filterDetails[] = 'Alt Bayi: ' . $altBayi;\r\n                        }\r\n                        \r\n                        if (!empty($filterDetails)) {\r\n                            echo implode(' • ', $filterDetails);\r\n                        } else {\r\n                            echo 'Filtre Durumu';\r\n                        }\r\n                        ?>\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <?php if (isset($error)): ?>\r\n        <div class=\"alert alert-danger\">\r\n            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n            <?php echo htmlspecialchars($error); ?>\r\n        </div>\r\n    <?php else: ?>\r\n        \r\n        <!-- Ana Rapor Tablosu -->\r\n        <div class=\"card border-0 shadow-sm\">\r\n            <div class=\"card-header bg-primary text-white\">\r\n                <h5 class=\"mb-0\">\r\n                    <i class=\"fas fa-table me-2\"></i>\r\n                    Alt Bayi - Kayıt Tipi Dağılımı\r\n                </h5>\r\n            </div>\r\n            <div class=\"card-body p-0\">\r\n                <div class=\"table-responsive\">\r\n                    <table class=\"table table-hover mb-0\" id=\"pivotTable\">\r\n                        <thead class=\"table-light sticky-top\">\r\n                            <tr>\r\n                                <th class=\"text-start ps-3\">Alt Bayi</th>\r\n                                <?php if (!empty($columns)): ?>\r\n                                    <?php foreach ($columns as $column): ?>\r\n                                        <th class=\"text-center\"><?php echo htmlspecialchars($column); ?></th>\r\n                                    <?php endforeach; ?>\r\n                                <?php endif; ?>\r\n                                <th class=\"text-center bg-light fw-bold\">TOPLAM</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            <?php if (!empty($pivotData)): ?>\r\n                                <?php \r\n                                $totalRow = [];\r\n                                foreach ($columns as $col) {\r\n                                    $totalRow[$col] = 0;\r\n                                }\r\n                                $grandTotal = 0;\r\n                                ?>\r\n                                \r\n                                <?php foreach ($pivotData as $row): ?>\r\n                                    <tr>\r\n                                        <td class=\"ps-3 fw-medium\">\r\n                                            <?php echo htmlspecialchars($row['ALTBAYI']); ?>\r\n                                        </td>\r\n                                        \r\n                        <?php foreach ($columns as $column): ?>\r\n                            <?php \r\n                            $value = 0;\r\n                            switch(strtoupper($column)) {\r\n                                case 'ISP_NEO':\r\n                                    $value = $row['ISP_NEO'];\r\n                                    break;\r\n                                case 'ISP_UYDU':\r\n                                    $value = $row['ISP_UYDU'];\r\n                                    break;\r\n                                case 'NEO':\r\n                                    $value = $row['NEO'];\r\n                                    break;\r\n                                case 'UYDU':\r\n                                    $value = $row['UYDU'];\r\n                                    break;\r\n                            }\r\n                            $totalRow[$column] += $value;\r\n                            ?>\r\n                            <td class=\"text-center\">\r\n                                <?php if ($value > 0): ?>\r\n                                    <span class=\"badge bg-primary\"><?php echo number_format($value); ?></span>\r\n                                <?php else: ?>\r\n                                    <span class=\"text-muted\">-</span>\r\n                                <?php endif; ?>\r\n                            </td>\r\n                        <?php endforeach; ?>                                        <td class=\"text-center bg-light\">\r\n                                            <strong class=\"text-primary\"><?php echo number_format($row['TOPLAM']); ?></strong>\r\n                                        </td>\r\n                                    </tr>\r\n                                    <?php $grandTotal += $row['TOPLAM']; ?>\r\n                                <?php endforeach; ?>\r\n                                \r\n                                <!-- Toplam Satırı -->\r\n                                <tr class=\"table-secondary\">\r\n                                    <td class=\"ps-3 fw-bold\">TOPLAM</td>\r\n                                    <?php foreach ($columns as $column): ?>\r\n                                        <td class=\"text-center fw-bold\">\r\n                                            <?php echo number_format($totalRow[$column]); ?>\r\n                                        </td>\r\n                                    <?php endforeach; ?>\r\n                                    <td class=\"text-center fw-bold bg-primary text-white\">\r\n                                        <?php echo number_format($grandTotal); ?>\r\n                                    </td>\r\n                                </tr>\r\n                                \r\n                            <?php else: ?>\r\n                                <tr>\r\n                                    <td colspan=\"<?php echo count($columns) + 2; ?>\" class=\"text-center py-5 text-muted\">\r\n                                        <i class=\"fas fa-search fa-2x mb-3 d-block\"></i>\r\n                        <?php if (!empty($startDate) || !empty($endDate) || !empty($outletDurum) || !empty($satisDurumu) || !empty($hakedisDonemi) || !empty($altBayi)): ?>\r\n                            <h5>Belirtilen kriterlere uygun veri bulunamadı</h5>\r\n                            <p class=\"mb-0\">\r\n                                <?php \r\n                                $activeFilterCount = 0;\r\n                                if (!empty($hakedisDonemi)) {\r\n                                    $activeFilterCount++; // Hakediş dönemi tarihleri de kapsar\r\n                                } else {\r\n                                    if (!empty($startDate)) $activeFilterCount++;\r\n                                    if (!empty($endDate)) $activeFilterCount++;\r\n                                }\r\n                                if (!empty($outletDurum)) $activeFilterCount++;\r\n                                if (!empty($satisDurumu)) $activeFilterCount++;\r\n                                if (!empty($altBayi)) $activeFilterCount++;                                                echo \"Aktif \" . $activeFilterCount . \" filtre ile eşleşen kayıt bulunamadı.\";\r\n                                                ?>\r\n                                                <br>Lütfen farklı kriterler deneyin veya filtreleri temizleyin.\r\n                                            </p>\r\n                                            <button class=\"btn btn-outline-primary mt-2\" onclick=\"clearFilters()\">\r\n                                                <i class=\"fas fa-times me-1\"></i>Filtreleri Temizle\r\n                                            </button>\r\n                                        <?php else: ?>\r\n                                            <h5>Henüz veri bulunmuyor</h5>\r\n                                            <p class=\"mb-0\">Lütfen önce CSV dosyalarınızı sisteme yükleyin.</p>\r\n                                            <a href=\"upload_iris_final.php\" class=\"btn btn-outline-primary mt-2\">\r\n                                                <i class=\"fas fa-upload me-1\"></i>Dosya Yükle\r\n                                            </a>\r\n                                        <?php endif; ?>\r\n                                    </td>\r\n                                </tr>\r\n                            <?php endif; ?>\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Detaylı Analiz -->\r\n        <?php if (!empty($pivotData)): ?>\r\n        <div class=\"row mt-4\">\r\n            <div class=\"col-md-6\">\r\n                <div class=\"card border-0 shadow-sm\">\r\n                    <div class=\"card-header bg-success text-white\">\r\n                        <h6 class=\"mb-0\">En Yüksek İşlem Hacmi</h6>\r\n                    </div>\r\n                    <div class=\"card-body\">\r\n                        <?php \r\n                        $topPerformers = array_slice($pivotData, 0, 5);\r\n                        foreach ($topPerformers as $index => $performer): \r\n                        ?>\r\n                            <div class=\"d-flex justify-content-between align-items-center <?php echo $index > 0 ? 'mt-2' : ''; ?>\">\r\n                                <span class=\"text-truncate me-2\" title=\"<?php echo htmlspecialchars($performer['ALTBAYI']); ?>\">\r\n                                    <?php echo ($index + 1) . '. ' . htmlspecialchars($performer['ALTBAYI']); ?>\r\n                                </span>\r\n                                <span class=\"badge bg-success\"><?php echo number_format($performer['TOPLAM']); ?></span>\r\n                            </div>\r\n                            <?php if ($index < count($topPerformers) - 1): ?>\r\n                                <hr class=\"my-2\">\r\n                            <?php endif; ?>\r\n                        <?php endforeach; ?>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            \r\n            <div class=\"col-md-6\">\r\n                <div class=\"card border-0 shadow-sm\">\r\n                    <div class=\"card-header bg-info text-white\">\r\n                        <h6 class=\"mb-0\">Kayıt Tipi Dağılımı</h6>\r\n                    </div>\r\n                    <div class=\"card-body\">\r\n                        <?php \r\n                        $typeStats = [];\r\n                        foreach ($pivotData as $row) {\r\n                            foreach ($columns as $column) {\r\n                                if (!isset($typeStats[$column])) {\r\n                                    $typeStats[$column] = 0;\r\n                                }\r\n                                switch(strtoupper($column)) {\r\n                                    case 'ISP_NEO':\r\n                                        $typeStats[$column] += $row['ISP_NEO'];\r\n                                        break;\r\n                                    case 'ISP_UYDU':\r\n                                        $typeStats[$column] += $row['ISP_UYDU'];\r\n                                        break;\r\n                                    case 'NEO':\r\n                                        $typeStats[$column] += $row['NEO'];\r\n                                        break;\r\n                                    case 'UYDU':\r\n                                        $typeStats[$column] += $row['UYDU'];\r\n                                        break;\r\n                                }\r\n                            }\r\n                        }\r\n                        arsort($typeStats);\r\n                        \r\n                        foreach ($typeStats as $type => $count):\r\n                            $percentage = $grandTotal > 0 ? round(($count / $grandTotal) * 100, 1) : 0;\r\n                        ?>\r\n                            <div class=\"d-flex justify-content-between align-items-center mb-2\">\r\n                                <span><?php echo htmlspecialchars($type); ?></span>\r\n                                <div class=\"text-end\">\r\n                                    <span class=\"badge bg-info me-2\"><?php echo number_format($count); ?></span>\r\n                                    <small class=\"text-muted\">(%<?php echo $percentage; ?>)</small>\r\n                                </div>\r\n                            </div>\r\n                            <div class=\"progress mb-3\" style=\"height: 6px;\">\r\n                                <div class=\"progress-bar bg-info\" style=\"width: <?php echo $percentage; ?>%\"></div>\r\n                            </div>\r\n                        <?php endforeach; ?>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <?php endif; ?>\r\n\r\n    <?php endif; ?>\r\n</div>\r\n\r\n<!-- Bootstrap JS -->\r\n<script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\r\n\r\n<!-- Excel Export için SheetJS -->\r\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js\"></script>\r\n\r\n<script>\r\n// Excel'e aktarma fonksiyonu\r\nfunction exportToExcel() {\r\n    try {\r\n        const table = document.getElementById('pivotTable');\r\n        const wb = XLSX.utils.table_to_book(table, {sheet: \"Hakediş Raporu\"});\r\n        \r\n        // Dosya adını tarih ile oluştur\r\n        const now = new Date();\r\n        const dateStr = now.getFullYear() + '-' + \r\n                       String(now.getMonth() + 1).padStart(2, '0') + '-' + \r\n                       String(now.getDate()).padStart(2, '0');\r\n        const filename = `Hakedis_Raporu_${dateStr}.xlsx`;\r\n        \r\n        XLSX.writeFile(wb, filename);\r\n        \r\n        // Başarı mesajı\r\n        showToast('Excel dosyası başarıyla indirildi!', 'success');\r\n    } catch (error) {\r\n        console.error('Excel export error:', error);\r\n        showToast('Excel aktarımında hata oluştu!', 'error');\r\n    }\r\n}\r\n\r\n// Yazdırma fonksiyonu\r\nfunction printReport() {\r\n    window.print();\r\n}\r\n\r\n// Sayfayı yenileme (mevcut filtreleri koruyarak)\r\nfunction refreshData() {\r\n    const currentUrl = new URL(window.location);\r\n    window.location.href = currentUrl.toString();\r\n}\r\n\r\n// Filtreleri temizle\r\nfunction clearFilters() {\r\n    document.getElementById('start_date').value = '';\r\n    document.getElementById('end_date').value = '';\r\n    document.getElementById('outlet_durum').value = '';\r\n    document.getElementById('satis_durumu').value = '';\r\n    document.getElementById('hakedis_donemi').value = '';\r\n    document.getElementById('alt_bayi').value = '';\r\n    document.getElementById('filterForm').submit();\r\n}\r\n\r\n// Belirli filtreyi kaldır\r\nfunction removeFilter(filterName) {\r\n    document.getElementById(filterName).value = '';\r\n    document.getElementById('filterForm').submit();\r\n}\r\n\r\n// Hızlı tarih aralığı seçimi\r\nfunction setDateRange(range) {\r\n    const today = new Date();\r\n    const startDateInput = document.getElementById('start_date');\r\n    const endDateInput = document.getElementById('end_date');\r\n    \r\n    let startDate, endDate;\r\n    \r\n    switch(range) {\r\n        case 'today':\r\n            startDate = today;\r\n            endDate = today;\r\n            break;\r\n            \r\n        case 'week':\r\n            const startOfWeek = new Date(today);\r\n            startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Pazartesi\r\n            const endOfWeek = new Date(startOfWeek);\r\n            endOfWeek.setDate(startOfWeek.getDate() + 6); // Pazar\r\n            startDate = startOfWeek;\r\n            endDate = endOfWeek;\r\n            break;\r\n            \r\n        case 'month':\r\n            startDate = new Date(today.getFullYear(), today.getMonth(), 1);\r\n            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);\r\n            break;\r\n            \r\n        default:\r\n            return;\r\n    }\r\n    \r\n    startDateInput.value = startDate.toISOString().split('T')[0];\r\n    endDateInput.value = endDate.toISOString().split('T')[0];\r\n    \r\n    // Otomatik submit\r\n    setTimeout(() => {\r\n        document.getElementById('filterForm').submit();\r\n    }, 100);\r\n}\r\n\r\n// Toast mesaj fonksiyonu\r\nfunction showToast(message, type = 'info') {\r\n    const toastContainer = document.getElementById('toastContainer') || createToastContainer();\r\n    \r\n    const toast = document.createElement('div');\r\n    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;\r\n    toast.setAttribute('role', 'alert');\r\n    toast.setAttribute('aria-live', 'assertive');\r\n    toast.setAttribute('aria-atomic', 'true');\r\n    \r\n    toast.innerHTML = `\r\n        <div class=\"d-flex\">\r\n            <div class=\"toast-body\">\r\n                <i class=\"fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2\"></i>\r\n                ${message}\r\n            </div>\r\n            <button type=\"button\" class=\"btn-close btn-close-white me-2 m-auto\" data-bs-dismiss=\"toast\"></button>\r\n        </div>\r\n    `;\r\n    \r\n    toastContainer.appendChild(toast);\r\n    \r\n    const bsToast = new bootstrap.Toast(toast);\r\n    bsToast.show();\r\n    \r\n    // Toast kaldırıldıktan sonra DOM'dan sil\r\n    toast.addEventListener('hidden.bs.toast', () => {\r\n        toast.remove();\r\n    });\r\n}\r\n\r\n// Toast container oluştur\r\nfunction createToastContainer() {\r\n    const container = document.createElement('div');\r\n    container.id = 'toastContainer';\r\n    container.className = 'toast-container position-fixed top-0 end-0 p-3';\r\n    container.style.zIndex = '9999';\r\n    document.body.appendChild(container);\r\n    return container;\r\n}\r\n\r\n// Tablo satırlarına hover efekti ve form validasyonu\r\ndocument.addEventListener('DOMContentLoaded', function() {\r\n    const tableRows = document.querySelectorAll('#pivotTable tbody tr:not(.table-secondary)');\r\n    \r\n    tableRows.forEach(row => {\r\n        row.addEventListener('mouseenter', function() {\r\n            this.style.backgroundColor = '#f8f9fa';\r\n            this.style.transform = 'scale(1.01)';\r\n            this.style.transition = 'all 0.2s ease';\r\n        });\r\n        \r\n        row.addEventListener('mouseleave', function() {\r\n            this.style.backgroundColor = '';\r\n            this.style.transform = '';\r\n        });\r\n    });\r\n    \r\n    // Tarih validasyonu\r\n    const startDateInput = document.getElementById('start_date');\r\n    const endDateInput = document.getElementById('end_date');\r\n    const outletDurumSelect = document.getElementById('outlet_durum');\r\n    const satisDurumuSelect = document.getElementById('satis_durumu');\r\n    const hakedisDonemiSelect = document.getElementById('hakedis_donemi');\r\n    \r\n    // Hakediş dönemleri tanımları (PHP'den JavaScript'e)\r\n    const hakedisDonemleri = <?php echo json_encode($hakedisDonemleri); ?>;\r\n    \r\n    function validateDates() {\r\n        const startDate = startDateInput.value;\r\n        const endDate = endDateInput.value;\r\n        \r\n        if (startDate && endDate) {\r\n            if (new Date(startDate) > new Date(endDate)) {\r\n                showToast('Başlangıç tarihi bitiş tarihinden büyük olamaz!', 'error');\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n    \r\n    // Form submit validasyonu\r\n    document.getElementById('filterForm').addEventListener('submit', function(e) {\r\n        if (!validateDates()) {\r\n            e.preventDefault();\r\n            return false;\r\n        }\r\n        \r\n        // Loading göster\r\n        const submitBtn = this.querySelector('button[type=\"submit\"]');\r\n        const originalText = submitBtn.innerHTML;\r\n        submitBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin me-1\"></i>Filtreleniyor...';\r\n        submitBtn.disabled = true;\r\n        \r\n        // Form submit edilirse loading'i geri al\r\n        setTimeout(() => {\r\n            submitBtn.innerHTML = originalText;\r\n            submitBtn.disabled = false;\r\n        }, 3000);\r\n    });\r\n    \r\n    // Tarih değişikliklerinde otomatik validasyon\r\n    [startDateInput, endDateInput].forEach(input => {\r\n        input.addEventListener('change', validateDates);\r\n    });\r\n    \r\n    // Dropdown değişikliklerinde otomatik filtreleme (opsiyonel)\r\n    outletDurumSelect.addEventListener('change', function() {\r\n        // Eğer kullanıcı dropdown'dan seçim yaparsa otomatik filtreleme yapabilir\r\n        // Bu özellik istenirse aktif edilebilir\r\n        // document.getElementById('filterForm').submit();\r\n    });\r\n    \r\n    satisDurumuSelect.addEventListener('change', function() {\r\n        // Eğer kullanıcı dropdown'dan seçim yaparsa otomatik filtreleme yapabilir\r\n        // Bu özellik istenirse aktif edilebilir\r\n        // document.getElementById('filterForm').submit();\r\n    });\r\n    \r\n    // Hakediş dönemi değişikliğinde otomatik tarih güncelleme\r\n    hakedisDonemiSelect.addEventListener('change', function() {\r\n        const selectedDonem = this.value;\r\n        \r\n        if (selectedDonem && hakedisDonemleri[selectedDonem]) {\r\n            // Hakediş dönemi seçildiyse tarih alanlarını otomatik doldur ve readonly yap\r\n            startDateInput.value = hakedisDonemleri[selectedDonem].start;\r\n            endDateInput.value = hakedisDonemleri[selectedDonem].end;\r\n            startDateInput.readOnly = true;\r\n            endDateInput.readOnly = true;\r\n            \r\n            // Hızlı tarih butonlarını devre dışı bırak\r\n            const quickDateBtns = document.querySelectorAll('[onclick^=\"setDateRange\"]');\r\n            quickDateBtns.forEach(btn => btn.disabled = true);\r\n            \r\n        } else {\r\n            // Manuel seçim yapıldıysa tarih alanlarını düzenlenebilir yap\r\n            startDateInput.readOnly = false;\r\n            endDateInput.readOnly = false;\r\n            \r\n            // Hızlı tarih butonlarını aktif et\r\n            const quickDateBtns = document.querySelectorAll('[onclick^=\"setDateRange\"]');\r\n            quickDateBtns.forEach(btn => btn.disabled = false);\r\n        }\r\n        \r\n        // Otomatik form submit (opsiyonel)\r\n        // document.getElementById('filterForm').submit();\r\n    });\r\n    \r\n    // Enter tuşu ile form submit\r\n    [startDateInput, endDateInput].forEach(input => {\r\n        input.addEventListener('keypress', function(e) {\r\n            if (e.key === 'Enter') {\r\n                if (validateDates()) {\r\n                    document.getElementById('filterForm').submit();\r\n                }\r\n            }\r\n        });\r\n    });\r\n});\r\n\r\n// Yazdırma için CSS\r\nconst printStyles = `\r\n    <style media=\"print\">\r\n        @page { margin: 1cm; }\r\n        .btn-group, .card-header .btn { display: none !important; }\r\n        .card { border: 1px solid #dee2e6 !important; box-shadow: none !important; }\r\n        .table { font-size: 12px; }\r\n        .navbar, .breadcrumb { display: none !important; }\r\n        .container-fluid { padding: 0 !important; }\r\n        body { background: white !important; }\r\n    </style>\r\n`;\r\ndocument.head.insertAdjacentHTML('beforeend', printStyles);\r\n</script>\r\n\r\n<?php include 'includes/footer.php'; ?>\r\n"
        }
    ]
}
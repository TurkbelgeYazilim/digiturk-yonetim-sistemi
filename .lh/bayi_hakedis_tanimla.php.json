{
    "sourceFile": "bayi_hakedis_tanimla.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 16,
            "patches": [
                {
                    "date": 1758977855765,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1759230383036,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,8 +21,50 @@\n         $conn = $db->getConnection();\r\n         \r\n         $action = $_POST['action'] ?? '';\r\n         \r\n+        // AJAX tarih kontrolü\r\n+        if ($action === 'check_date_conflict') {\r\n+            $bayiId = (int)$_POST['bayi_id'];\r\n+            $baslangicTarihi = $_POST['hakedis_baslangic_tarihi'];\r\n+            $bitisTarihi = $_POST['hakedis_bitis_tarihi'];\r\n+            $editId = isset($_POST['edit_id']) ? (int)$_POST['edit_id'] : null;\r\n+            \r\n+            // Çakışan tarih aralığı kontrolü\r\n+            $checkSql = \"SELECT COUNT(*) as count FROM hakedis_tanim \r\n+                        WHERE bayi_id = ?\";\r\n+            $params = [$bayiId];\r\n+            \r\n+            // Eğer edit işlemi ise mevcut kaydı hariç tut\r\n+            if ($editId) {\r\n+                $checkSql .= \" AND id != ?\";\r\n+                $params[] = $editId;\r\n+            }\r\n+            \r\n+            $checkSql .= \" AND (\r\n+                            (hakedis_baslangic_tarihi <= ? AND hakedis_bitis_tarihi >= ?) OR\r\n+                            (hakedis_baslangic_tarihi <= ? AND hakedis_bitis_tarihi >= ?) OR\r\n+                            (hakedis_baslangic_tarihi >= ? AND hakedis_bitis_tarihi <= ?)\r\n+                        )\";\r\n+            \r\n+            $params = array_merge($params, [\r\n+                $baslangicTarihi, $baslangicTarihi,\r\n+                $bitisTarihi, $bitisTarihi,\r\n+                $baslangicTarihi, $bitisTarihi\r\n+            ]);\r\n+            \r\n+            $checkStmt = $conn->prepare($checkSql);\r\n+            $checkStmt->execute($params);\r\n+            $existing = $checkStmt->fetch();\r\n+            \r\n+            header('Content-Type: application/json');\r\n+            echo json_encode([\r\n+                'conflict' => $existing['count'] > 0,\r\n+                'message' => $existing['count'] > 0 ? 'Bu bayi için belirtilen tarih aralığında zaten bir hakediş tanımı bulunmaktadır.' : ''\r\n+            ]);\r\n+            exit;\r\n+        }\r\n+        \r\n         switch ($action) {\r\n             case 'add':\r\n                 $bayiId = (int)$_POST['bayi_id'];\r\n                 $ispNeoFiyat = !empty($_POST['isp_neo_fiyat']) ? (float)$_POST['isp_neo_fiyat'] : null;\r\n@@ -510,9 +552,9 @@\n <!-- Yeni Hakediş Tanımı Modal -->\r\n <div class=\"modal fade\" id=\"addHakedisModal\" tabindex=\"-1\">\r\n     <div class=\"modal-dialog modal-lg\">\r\n         <div class=\"modal-content\">\r\n-            <form method=\"POST\" action=\"\">\r\n+            <form method=\"POST\" action=\"\" id=\"addHakedisForm\">\r\n                 <input type=\"hidden\" name=\"action\" value=\"add\">\r\n                 <div class=\"modal-header\">\r\n                     <h5 class=\"modal-title\">\r\n                         <i class=\"fas fa-plus me-2\"></i>Yeni Hakediş Tanımı\r\n@@ -592,12 +634,13 @@\n                     </div>\r\n                 </div>\r\n                 <div class=\"modal-footer\">\r\n                     <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n-                    <button type=\"submit\" class=\"btn btn-primary\">\r\n+                    <button type=\"submit\" class=\"btn btn-primary\" id=\"add_submit_btn\">\r\n                         <i class=\"fas fa-save me-1\"></i>Kaydet\r\n                     </button>\r\n                 </div>\r\n+                <div id=\"add_error_message\" class=\"alert alert-danger mt-3\" style=\"display: none;\"></div>\r\n             </form>\r\n         </div>\r\n     </div>\r\n </div>\r\n@@ -605,9 +648,9 @@\n <!-- Hakediş Düzenle Modal -->\r\n <div class=\"modal fade\" id=\"editHakedisModal\" tabindex=\"-1\">\r\n     <div class=\"modal-dialog modal-lg\">\r\n         <div class=\"modal-content\">\r\n-            <form method=\"POST\" action=\"\">\r\n+            <form method=\"POST\" action=\"\" id=\"editHakedisForm\">\r\n                 <input type=\"hidden\" name=\"action\" value=\"edit\">\r\n                 <input type=\"hidden\" name=\"id\" id=\"edit_id\">\r\n                 <div class=\"modal-header\">\r\n                     <h5 class=\"modal-title\">\r\n@@ -688,12 +731,13 @@\n                     </div>\r\n                 </div>\r\n                 <div class=\"modal-footer\">\r\n                     <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n-                    <button type=\"submit\" class=\"btn btn-primary\">\r\n+                    <button type=\"submit\" class=\"btn btn-primary\" id=\"edit_submit_btn\">\r\n                         <i class=\"fas fa-save me-1\"></i>Güncelle\r\n                     </button>\r\n                 </div>\r\n+                <div id=\"edit_error_message\" class=\"alert alert-danger mt-3\" style=\"display: none;\"></div>\r\n             </form>\r\n         </div>\r\n     </div>\r\n </div>\r\n@@ -707,9 +751,9 @@\n     \r\n     if (textarea && counter) {\r\n         const updateCount = () => {\r\n             const currentLength = textarea.value.length;\r\n-            const maxLength = 200;\r\n+            const maxLength = 500;\r\n             counter.textContent = `${currentLength}/${maxLength}`;\r\n             \r\n             // Limit aşıldığında renk değişimi\r\n             if (currentLength > maxLength * 0.9) {\r\n@@ -796,47 +840,107 @@\n         form.submit();\r\n     }\r\n }\r\n \r\n-// Karakter sayacı fonksiyonları\r\n-function updateCharCounter(textareaId, counterId) {\r\n-    const textarea = document.getElementById(textareaId);\r\n-    const counter = document.getElementById(counterId);\r\n-    \r\n-    if (textarea && counter) {\r\n-        const updateCount = () => {\r\n-            const currentLength = textarea.value.length;\r\n-            const maxLength = 200;\r\n-            counter.textContent = `${currentLength}/${maxLength}`;\r\n+// Form validasyonu\r\n+document.addEventListener('DOMContentLoaded', function() {\r\n+    // AJAX ile tarih çakışması kontrolü\r\n+    function checkDateConflict(bayiId, baslangicTarihi, bitisTarihi, editId = null) {\r\n+        return fetch('', {\r\n+            method: 'POST',\r\n+            headers: {\r\n+                'Content-Type': 'application/x-www-form-urlencoded',\r\n+            },\r\n+            body: new URLSearchParams({\r\n+                action: 'check_date_conflict',\r\n+                bayi_id: bayiId,\r\n+                hakedis_baslangic_tarihi: baslangicTarihi,\r\n+                hakedis_bitis_tarihi: bitisTarihi,\r\n+                ...(editId && { edit_id: editId })\r\n+            })\r\n+        })\r\n+        .then(response => response.json());\r\n+    }\r\n+\r\n+    // Form submit handler\r\n+    function handleFormSubmit(formId, errorElementId, submitBtnId, editId = null) {\r\n+        const form = document.getElementById(formId);\r\n+        const errorElement = document.getElementById(errorElementId);\r\n+        const submitBtn = document.getElementById(submitBtnId);\r\n+        \r\n+        form.addEventListener('submit', async function(e) {\r\n+            e.preventDefault();\r\n             \r\n-            // Limit aşıldığında renk değişimi\r\n-            if (currentLength > maxLength * 0.9) {\r\n-                counter.classList.add('text-warning');\r\n-            } else {\r\n-                counter.classList.remove('text-warning');\r\n+            // Error mesajını gizle\r\n+            errorElement.style.display = 'none';\r\n+            \r\n+            // Form verilerini al\r\n+            const formData = new FormData(form);\r\n+            const bayiId = formData.get('bayi_id');\r\n+            const baslangicTarihi = formData.get('hakedis_baslangic_tarihi');\r\n+            const bitisTarihi = formData.get('hakedis_bitis_tarihi');\r\n+            \r\n+            // Temel validasyonlar\r\n+            if (!bayiId || !baslangicTarihi || !bitisTarihi) {\r\n+                showError(errorElement, 'Lütfen tüm gerekli alanları doldurun.');\r\n+                return;\r\n             }\r\n             \r\n-            if (currentLength >= maxLength) {\r\n-                counter.classList.add('text-danger');\r\n-                counter.classList.remove('text-warning');\r\n-            } else {\r\n-                counter.classList.remove('text-danger');\r\n+            // Tarih validasyonu\r\n+            if (new Date(baslangicTarihi) >= new Date(bitisTarihi)) {\r\n+                showError(errorElement, 'Başlangıç tarihi, bitiş tarihinden önce olmalıdır.');\r\n+                return;\r\n             }\r\n-        };\r\n-        \r\n-        textarea.addEventListener('input', updateCount);\r\n-        textarea.addEventListener('keyup', updateCount);\r\n-        textarea.addEventListener('paste', () => {\r\n-            setTimeout(updateCount, 10); // Paste işlemi tamamlandıktan sonra güncelle\r\n+            \r\n+            // Açıklama uzunluk kontrolü\r\n+            const aciklama = formData.get('aciklama') || '';\r\n+            if (aciklama.length > 500) {\r\n+                showError(errorElement, `Açıklama metni 500 karakteri geçemez. Mevcut uzunluk: ${aciklama.length} karakter.`);\r\n+                return;\r\n+            }\r\n+            \r\n+            // Submit butonunu devre dışı bırak\r\n+            submitBtn.disabled = true;\r\n+            submitBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin me-1\"></i>Kontrol ediliyor...';\r\n+            \r\n+            try {\r\n+                // Tarih çakışması kontrolü\r\n+                const result = await checkDateConflict(bayiId, baslangicTarihi, bitisTarihi, editId);\r\n+                \r\n+                if (result.conflict) {\r\n+                    showError(errorElement, result.message);\r\n+                    submitBtn.disabled = false;\r\n+                    submitBtn.innerHTML = editId ? '<i class=\"fas fa-save me-1\"></i>Güncelle' : '<i class=\"fas fa-save me-1\"></i>Kaydet';\r\n+                    return;\r\n+                }\r\n+                \r\n+                // Eğer çakışma yoksa formu submit et\r\n+                submitBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin me-1\"></i>Kaydediliyor...';\r\n+                \r\n+                // Normal form submit\r\n+                const originalAction = formData.get('action');\r\n+                form.submit();\r\n+                \r\n+            } catch (error) {\r\n+                console.error('Error:', error);\r\n+                showError(errorElement, 'Bir hata oluştu. Lütfen tekrar deneyin.');\r\n+                submitBtn.disabled = false;\r\n+                submitBtn.innerHTML = editId ? '<i class=\"fas fa-save me-1\"></i>Güncelle' : '<i class=\"fas fa-save me-1\"></i>Kaydet';\r\n+            }\r\n         });\r\n-        \r\n-        // İlk yüklemede güncellemeleri\r\n-        updateCount();\r\n     }\r\n-}\r\n-\r\n-// Form validasyonu\r\n-document.addEventListener('DOMContentLoaded', function() {\r\n+    \r\n+    // Error mesajı gösterme fonksiyonu\r\n+    function showError(errorElement, message) {\r\n+        errorElement.textContent = message;\r\n+        errorElement.style.display = 'block';\r\n+        errorElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\r\n+    }\r\n+    \r\n+    // Form handlerları\r\n+    handleFormSubmit('addHakedisForm', 'add_error_message', 'add_submit_btn');\r\n+    handleFormSubmit('editHakedisForm', 'edit_error_message', 'edit_submit_btn', true);\r\n+    \r\n     // Başlangıç ve bitiş tarihi validasyonu\r\n     function validateDates(baslangicId, bitisId) {\r\n         const baslangic = document.getElementById(baslangicId);\r\n         const bitis = document.getElementById(bitisId);\r\n@@ -861,8 +965,21 @@\n     \r\n     // Karakter sayaçlarını başlat\r\n     updateCharCounter('add_aciklama', 'add_char_count');\r\n     updateCharCounter('edit_aciklama', 'edit_char_count');\r\n+    \r\n+    // Modal kapandığında error mesajlarını temizle\r\n+    document.getElementById('addHakedisModal').addEventListener('hidden.bs.modal', function () {\r\n+        document.getElementById('add_error_message').style.display = 'none';\r\n+        document.getElementById('add_submit_btn').disabled = false;\r\n+        document.getElementById('add_submit_btn').innerHTML = '<i class=\"fas fa-save me-1\"></i>Kaydet';\r\n+    });\r\n+    \r\n+    document.getElementById('editHakedisModal').addEventListener('hidden.bs.modal', function () {\r\n+        document.getElementById('edit_error_message').style.display = 'none';\r\n+        document.getElementById('edit_submit_btn').disabled = false;\r\n+        document.getElementById('edit_submit_btn').innerHTML = '<i class=\"fas fa-save me-1\"></i>Güncelle';\r\n+    });\r\n });\r\n </script>\r\n \r\n <?php include 'includes/footer.php'; ?>\r\n"
                },
                {
                    "date": 1759329352876,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,19 +7,42 @@\n // Auth kontrol\r\n require_once 'auth.php';\r\n $currentUser = checkAdminAuth(); // Sadece admin erişebilir\r\n \r\n-// Veritabanı bağlantısı\r\n-require_once 'MSSQLConnection.php';\r\n+// Veritabanı bağlantı fonksiyonu\r\n+function getDatabaseConnection() {\r\n+    $configFile = __DIR__ . '/config/mssql.php';\r\n+    \r\n+    if (!file_exists($configFile)) {\r\n+        throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n+    }\r\n+    \r\n+    $config = include $configFile;\r\n+    \r\n+    try {\r\n+        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n+        \r\n+        $connection = new PDO($dsn, $config['username'], $config['password'], [\r\n+            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n+            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n+            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n+            PDO::ATTR_EMULATE_PREPARES => false\r\n+        ]);\r\n+        \r\n+        return $connection;\r\n+        \r\n+    } catch (PDOException $e) {\r\n+        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n+    }\r\n+}\r\n \r\n $message = '';\r\n $messageType = '';\r\n \r\n // Hakediş tanım işlemleri\r\n if ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n     try {\r\n-        $db = new MSSQLConnection();\r\n-        $conn = $db->getConnection();\r\n+        $conn = getDatabaseConnection();\r\n         \r\n         $action = $_POST['action'] ?? '';\r\n         \r\n         // AJAX tarih kontrolü\r\n@@ -191,10 +214,9 @@\n \r\n // Bayileri al (users tablosundan bayi grubundakiler)\r\n $bayiler = [];\r\n try {\r\n-    $db = new MSSQLConnection();\r\n-    $conn = $db->getConnection();\r\n+    $conn = getDatabaseConnection();\r\n     \r\n     // Bayi gruplarını bul\r\n     $bayiGroupSql = \"SELECT id FROM user_groups WHERE group_name IN ('bayi', 'Bayi')\";\r\n     $bayiGroupStmt = $conn->prepare($bayiGroupSql);\r\n@@ -249,10 +271,9 @@\n \r\n // Hakediş tanımlarını listele\r\n $hakedisler = [];\r\n try {\r\n-    $db = new MSSQLConnection();\r\n-    $conn = $db->getConnection();\r\n+    $conn = getDatabaseConnection();\r\n     \r\n     // Base SQL query\r\n     $sql = \"SELECT ht.*, u.first_name, u.last_name, u.email\r\n             FROM hakedis_tanim ht\r\n"
                },
                {
                    "date": 1759333913605,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,19 +1,39 @@\n <?php\r\n+// Enable error logging\r\n+error_reporting(E_ALL);\r\n+ini_set('log_errors', 1);\r\n+ini_set('error_log', __DIR__ . '/debug.log');\r\n+\r\n $pageTitle = \"Bayi Hakediş Tanımlama\";\r\n $breadcrumbs = [\r\n     ['title' => 'Bayi Hakediş Tanımlama']\r\n ];\r\n \r\n-// Auth kontrol\r\n-require_once 'auth.php';\r\n-$currentUser = checkAdminAuth(); // Sadece admin erişebilir\r\n+// Auth kontrol with error handling\r\n+try {\r\n+    require_once 'auth.php';\r\n+    $currentUser = checkAdminAuth(); // Sadece admin erişebilir\r\n+} catch (Exception $e) {\r\n+    // Log the error\r\n+    error_log(\"Auth error in bayi_hakedis_tanimla.php: \" . $e->getMessage());\r\n+    \r\n+    // Redirect to login or show error\r\n+    if (strpos($e->getMessage(), 'no_permission') !== false) {\r\n+        header('Location: index.php?error=no_permission');\r\n+        exit;\r\n+    } else {\r\n+        header('Location: login.php?error=auth_failed');\r\n+        exit;\r\n+    }\r\n+}\r\n \r\n-// Veritabanı bağlantı fonksiyonu\r\n+// Veritabanı bağlantı fonksiyonu with better error handling\r\n function getDatabaseConnection() {\r\n     $configFile = __DIR__ . '/config/mssql.php';\r\n     \r\n     if (!file_exists($configFile)) {\r\n+        error_log('Config file not found: ' . $configFile);\r\n         throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n     }\r\n     \r\n     $config = include $configFile;\r\n@@ -27,15 +47,63 @@\n             PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n             PDO::ATTR_EMULATE_PREPARES => false\r\n         ]);\r\n         \r\n+        // Check and create hakedis_tanim table if it doesn't exist\r\n+        createHakedisTanimTableIfNotExists($connection);\r\n+        \r\n         return $connection;\r\n         \r\n     } catch (PDOException $e) {\r\n+        error_log('Database connection error: ' . $e->getMessage());\r\n         throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n     }\r\n }\r\n \r\n+// Create hakedis_tanim table if it doesn't exist\r\n+function createHakedisTanimTableIfNotExists($conn) {\r\n+    try {\r\n+        $sql = \"\r\n+        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='hakedis_tanim' AND xtype='U')\r\n+        CREATE TABLE hakedis_tanim (\r\n+            id INT IDENTITY(1,1) PRIMARY KEY,\r\n+            bayi_id INT NOT NULL,\r\n+            isp_neo_fiyat DECIMAL(10,2) NULL,\r\n+            isp_uydu_fiyat DECIMAL(10,2) NULL,\r\n+            neo_fiyat DECIMAL(10,2) NULL,\r\n+            uydu_fiyat DECIMAL(10,2) NULL,\r\n+            hakedis_baslangic_tarihi DATETIME2 NOT NULL,\r\n+            hakedis_bitis_tarihi DATETIME2 NOT NULL,\r\n+            aciklama NVARCHAR(200) NULL,\r\n+            created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n+            updated_at DATETIME2 NULL,\r\n+            FOREIGN KEY (bayi_id) REFERENCES users(id) ON DELETE CASCADE\r\n+        );\r\n+        \";\r\n+        \r\n+        $conn->exec($sql);\r\n+        \r\n+        // Create indexes if they don't exist\r\n+        $indexSql = \"\r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('hakedis_tanim') AND name = 'IX_hakedis_tanim_bayi_id')\r\n+        BEGIN\r\n+            CREATE INDEX IX_hakedis_tanim_bayi_id ON hakedis_tanim (bayi_id)\r\n+        END\r\n+        \r\n+        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('hakedis_tanim') AND name = 'IX_hakedis_tanim_tarih')\r\n+        BEGIN\r\n+            CREATE INDEX IX_hakedis_tanim_tarih ON hakedis_tanim (hakedis_baslangic_tarihi, hakedis_bitis_tarihi)\r\n+        END\r\n+        \";\r\n+        \r\n+        $conn->exec($indexSql);\r\n+        \r\n+    } catch (PDOException $e) {\r\n+        error_log('Error creating hakedis_tanim table: ' . $e->getMessage());\r\n+        // Don't throw exception here, let the main code handle it\r\n+    }\r\n+}\r\n+\r\n $message = '';\r\n $messageType = '';\r\n \r\n // Hakediş tanım işlemleri\r\n@@ -211,10 +279,11 @@\n         $messageType = 'danger';\r\n     }\r\n }\r\n \r\n-// Bayileri al (users tablosundan bayi grubundakiler)\r\n+// Bayileri al (users tablosundan bayi grubundakiler) with error handling\r\n $bayiler = [];\r\n+$bayilerError = '';\r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n     // Bayi gruplarını bul\r\n@@ -234,9 +303,10 @@\n         $bayiStmt->execute($bayiGroups);\r\n         $bayiler = $bayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n     }\r\n } catch (Exception $e) {\r\n-    // Hata durumunda boş array kalacak\r\n+    error_log('Error loading bayiler: ' . $e->getMessage());\r\n+    $bayilerError = 'Bayi listesi yüklenirken hata oluştu: ' . $e->getMessage();\r\n }\r\n \r\n // Filtreleri al\r\n $filterBayiId = $_GET['bayi_filter'] ?? '';\r\n@@ -268,10 +338,11 @@\n if (!in_array(strtolower($sortOrder), ['asc', 'desc'])) {\r\n     $sortOrder = 'desc';\r\n }\r\n \r\n-// Hakediş tanımlarını listele\r\n+// Hakediş tanımlarını listele with better error handling\r\n $hakedisler = [];\r\n+$hakedislerError = '';\r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n     // Base SQL query\r\n@@ -306,9 +377,10 @@\n     $stmt->execute($params);\r\n     $hakedisler = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n     \r\n } catch (Exception $e) {\r\n-    $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n+    error_log('Error loading hakedisler: ' . $e->getMessage());\r\n+    $hakedislerError = \"Veritabanı hatası: \" . $e->getMessage();\r\n }\r\n \r\n include 'includes/header.php';\r\n ?>\r\n@@ -332,16 +404,24 @@\n             <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n         </div>\r\n     <?php endif; ?>\r\n \r\n-    <?php if (isset($error)): ?>\r\n+    <?php if (isset($hakedislerError) && $hakedislerError): ?>\r\n         <div class=\"alert alert-danger alert-dismissible fade show\" role=\"alert\">\r\n             <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n-            <?php echo htmlspecialchars($error); ?>\r\n+            <?php echo htmlspecialchars($hakedislerError); ?>\r\n             <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n         </div>\r\n     <?php endif; ?>\r\n \r\n+    <?php if (isset($bayilerError) && $bayilerError): ?>\r\n+        <div class=\"alert alert-warning alert-dismissible fade show\" role=\"alert\">\r\n+            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n+            <?php echo htmlspecialchars($bayilerError); ?>\r\n+            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n+        </div>\r\n+    <?php endif; ?>\r\n+\r\n     <!-- Filtreler -->\r\n     <div class=\"card border-0 shadow-sm mb-4\">\r\n         <div class=\"card-header bg-light\">\r\n             <h6 class=\"mb-0\">\r\n@@ -646,12 +726,12 @@\n                     \r\n                     <div class=\"mb-3\">\r\n                         <label for=\"add_aciklama\" class=\"form-label\">Açıklama</label>\r\n                         <textarea class=\"form-control\" id=\"add_aciklama\" name=\"aciklama\" rows=\"3\" \r\n-                                  placeholder=\"Hakediş tanımı ile ilgili açıklama (isteğe bağlı)\" maxlength=\"500\"></textarea>\r\n+                                  placeholder=\"Hakediş tanımı ile ilgili açıklama (isteğe bağlı)\" maxlength=\"200\"></textarea>\r\n                         <div class=\"form-text d-flex justify-content-between\">\r\n-                            <span>Maksimum 500 karakter</span>\r\n-                            <span id=\"add_char_count\">0/500</span>\r\n+                            <span>Maksimum 200 karakter</span>\r\n+                            <span id=\"add_char_count\">0/200</span>\r\n                         </div>\r\n                     </div>\r\n                 </div>\r\n                 <div class=\"modal-footer\">\r\n@@ -743,12 +823,12 @@\n                     \r\n                     <div class=\"mb-3\">\r\n                         <label for=\"edit_aciklama\" class=\"form-label\">Açıklama</label>\r\n                         <textarea class=\"form-control\" id=\"edit_aciklama\" name=\"aciklama\" rows=\"3\" \r\n-                                  placeholder=\"Hakediş tanımı ile ilgili açıklama (isteğe bağlı)\" maxlength=\"500\"></textarea>\r\n+                                  placeholder=\"Hakediş tanımı ile ilgili açıklama (isteğe bağlı)\" maxlength=\"200\"></textarea>\r\n                         <div class=\"form-text d-flex justify-content-between\">\r\n-                            <span>Maksimum 500 karakter</span>\r\n-                            <span id=\"edit_char_count\">0/500</span>\r\n+                            <span>Maksimum 200 karakter</span>\r\n+                            <span id=\"edit_char_count\">0/200</span>\r\n                         </div>\r\n                     </div>\r\n                 </div>\r\n                 <div class=\"modal-footer\">\r\n@@ -772,9 +852,9 @@\n     \r\n     if (textarea && counter) {\r\n         const updateCount = () => {\r\n             const currentLength = textarea.value.length;\r\n-            const maxLength = 500;\r\n+            const maxLength = 200;\r\n             counter.textContent = `${currentLength}/${maxLength}`;\r\n             \r\n             // Limit aşıldığında renk değişimi\r\n             if (currentLength > maxLength * 0.9) {\r\n@@ -913,10 +993,10 @@\n             }\r\n             \r\n             // Açıklama uzunluk kontrolü\r\n             const aciklama = formData.get('aciklama') || '';\r\n-            if (aciklama.length > 500) {\r\n-                showError(errorElement, `Açıklama metni 500 karakteri geçemez. Mevcut uzunluk: ${aciklama.length} karakter.`);\r\n+            if (aciklama.length > 200) {\r\n+                showError(errorElement, `Açıklama metni 200 karakteri geçemez. Mevcut uzunluk: ${aciklama.length} karakter.`);\r\n                 return;\r\n             }\r\n             \r\n             // Submit butonunu devre dışı bırak\r\n"
                },
                {
                    "date": 1759334627646,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,40 +1,20 @@\n <?php\r\n-// Enable error logging\r\n-error_reporting(E_ALL);\r\n-ini_set('log_errors', 1);\r\n-ini_set('error_log', __DIR__ . '/debug.log');\r\n-\r\n $pageTitle = \"Bayi Hakediş Tanımlama\";\r\n $breadcrumbs = [\r\n     ['title' => 'Bayi Hakediş Tanımlama']\r\n ];\r\n \r\n-// Auth kontrol with error handling\r\n-try {\r\n-    require_once 'auth.php';\r\n-    $currentUser = checkAdminAuth(); // Sadece admin erişebilir\r\n-} catch (Exception $e) {\r\n-    // Log the error\r\n-    error_log(\"Auth error in bayi_hakedis_tanimla.php: \" . $e->getMessage());\r\n-    \r\n-    // Redirect to login or show error\r\n-    if (strpos($e->getMessage(), 'no_permission') !== false) {\r\n-        header('Location: index.php?error=no_permission');\r\n-        exit;\r\n-    } else {\r\n-        header('Location: login.php?error=auth_failed');\r\n-        exit;\r\n-    }\r\n-}\r\n+// Auth kontrol\r\n+require_once 'auth.php';\r\n+$currentUser = checkAdminAuth();\r\n \r\n-// Veritabanı bağlantı fonksiyonu with better error handling\r\n+// Veritabanı bağlantı fonksiyonu\r\n function getDatabaseConnection() {\r\n     $configFile = __DIR__ . '/config/mssql.php';\r\n     \r\n     if (!file_exists($configFile)) {\r\n-        error_log('Config file not found: ' . $configFile);\r\n-        throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n+        throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı');\r\n     }\r\n     \r\n     $config = include $configFile;\r\n     \r\n@@ -47,63 +27,15 @@\n             PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n             PDO::ATTR_EMULATE_PREPARES => false\r\n         ]);\r\n         \r\n-        // Check and create hakedis_tanim table if it doesn't exist\r\n-        createHakedisTanimTableIfNotExists($connection);\r\n-        \r\n         return $connection;\r\n         \r\n     } catch (PDOException $e) {\r\n-        error_log('Database connection error: ' . $e->getMessage());\r\n         throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n     }\r\n }\r\n \r\n-// Create hakedis_tanim table if it doesn't exist\r\n-function createHakedisTanimTableIfNotExists($conn) {\r\n-    try {\r\n-        $sql = \"\r\n-        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='hakedis_tanim' AND xtype='U')\r\n-        CREATE TABLE hakedis_tanim (\r\n-            id INT IDENTITY(1,1) PRIMARY KEY,\r\n-            bayi_id INT NOT NULL,\r\n-            isp_neo_fiyat DECIMAL(10,2) NULL,\r\n-            isp_uydu_fiyat DECIMAL(10,2) NULL,\r\n-            neo_fiyat DECIMAL(10,2) NULL,\r\n-            uydu_fiyat DECIMAL(10,2) NULL,\r\n-            hakedis_baslangic_tarihi DATETIME2 NOT NULL,\r\n-            hakedis_bitis_tarihi DATETIME2 NOT NULL,\r\n-            aciklama NVARCHAR(200) NULL,\r\n-            created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n-            updated_at DATETIME2 NULL,\r\n-            FOREIGN KEY (bayi_id) REFERENCES users(id) ON DELETE CASCADE\r\n-        );\r\n-        \";\r\n-        \r\n-        $conn->exec($sql);\r\n-        \r\n-        // Create indexes if they don't exist\r\n-        $indexSql = \"\r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('hakedis_tanim') AND name = 'IX_hakedis_tanim_bayi_id')\r\n-        BEGIN\r\n-            CREATE INDEX IX_hakedis_tanim_bayi_id ON hakedis_tanim (bayi_id)\r\n-        END\r\n-        \r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('hakedis_tanim') AND name = 'IX_hakedis_tanim_tarih')\r\n-        BEGIN\r\n-            CREATE INDEX IX_hakedis_tanim_tarih ON hakedis_tanim (hakedis_baslangic_tarihi, hakedis_bitis_tarihi)\r\n-        END\r\n-        \";\r\n-        \r\n-        $conn->exec($indexSql);\r\n-        \r\n-    } catch (PDOException $e) {\r\n-        error_log('Error creating hakedis_tanim table: ' . $e->getMessage());\r\n-        // Don't throw exception here, let the main code handle it\r\n-    }\r\n-}\r\n-\r\n $message = '';\r\n $messageType = '';\r\n \r\n // Hakediş tanım işlemleri\r\n@@ -112,50 +44,8 @@\n         $conn = getDatabaseConnection();\r\n         \r\n         $action = $_POST['action'] ?? '';\r\n         \r\n-        // AJAX tarih kontrolü\r\n-        if ($action === 'check_date_conflict') {\r\n-            $bayiId = (int)$_POST['bayi_id'];\r\n-            $baslangicTarihi = $_POST['hakedis_baslangic_tarihi'];\r\n-            $bitisTarihi = $_POST['hakedis_bitis_tarihi'];\r\n-            $editId = isset($_POST['edit_id']) ? (int)$_POST['edit_id'] : null;\r\n-            \r\n-            // Çakışan tarih aralığı kontrolü\r\n-            $checkSql = \"SELECT COUNT(*) as count FROM hakedis_tanim \r\n-                        WHERE bayi_id = ?\";\r\n-            $params = [$bayiId];\r\n-            \r\n-            // Eğer edit işlemi ise mevcut kaydı hariç tut\r\n-            if ($editId) {\r\n-                $checkSql .= \" AND id != ?\";\r\n-                $params[] = $editId;\r\n-            }\r\n-            \r\n-            $checkSql .= \" AND (\r\n-                            (hakedis_baslangic_tarihi <= ? AND hakedis_bitis_tarihi >= ?) OR\r\n-                            (hakedis_baslangic_tarihi <= ? AND hakedis_bitis_tarihi >= ?) OR\r\n-                            (hakedis_baslangic_tarihi >= ? AND hakedis_bitis_tarihi <= ?)\r\n-                        )\";\r\n-            \r\n-            $params = array_merge($params, [\r\n-                $baslangicTarihi, $baslangicTarihi,\r\n-                $bitisTarihi, $bitisTarihi,\r\n-                $baslangicTarihi, $bitisTarihi\r\n-            ]);\r\n-            \r\n-            $checkStmt = $conn->prepare($checkSql);\r\n-            $checkStmt->execute($params);\r\n-            $existing = $checkStmt->fetch();\r\n-            \r\n-            header('Content-Type: application/json');\r\n-            echo json_encode([\r\n-                'conflict' => $existing['count'] > 0,\r\n-                'message' => $existing['count'] > 0 ? 'Bu bayi için belirtilen tarih aralığında zaten bir hakediş tanımı bulunmaktadır.' : ''\r\n-            ]);\r\n-            exit;\r\n-        }\r\n-        \r\n         switch ($action) {\r\n             case 'add':\r\n                 $bayiId = (int)$_POST['bayi_id'];\r\n                 $ispNeoFiyat = !empty($_POST['isp_neo_fiyat']) ? (float)$_POST['isp_neo_fiyat'] : null;\r\n@@ -166,104 +56,27 @@\n                 $bitisTarihi = $_POST['hakedis_bitis_tarihi'];\r\n                 $aciklama = trim($_POST['aciklama'] ?? '');\r\n                 \r\n                 // Açıklama uzunluk kontrolü\r\n-                if (strlen($aciklama) > 500) {\r\n-                    $message = 'Açıklama metni 500 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n+                if (strlen($aciklama) > 200) {\r\n+                    $message = 'Açıklama metni 200 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n                     $messageType = 'danger';\r\n                 } \r\n                 // Tarih kontrolü\r\n                 elseif (strtotime($baslangicTarihi) >= strtotime($bitisTarihi)) {\r\n                     $message = 'Başlangıç tarihi, bitiş tarihinden önce olmalıdır.';\r\n                     $messageType = 'danger';\r\n                 } else {\r\n-                    // Çakışan tarih aralığı kontrolü\r\n-                    $checkSql = \"SELECT COUNT(*) as count FROM hakedis_tanim \r\n-                                WHERE bayi_id = ? \r\n-                                AND (\r\n-                                    (hakedis_baslangic_tarihi <= ? AND hakedis_bitis_tarihi >= ?) OR\r\n-                                    (hakedis_baslangic_tarihi <= ? AND hakedis_bitis_tarihi >= ?) OR\r\n-                                    (hakedis_baslangic_tarihi >= ? AND hakedis_bitis_tarihi <= ?)\r\n-                                )\";\r\n-                    $checkStmt = $conn->prepare($checkSql);\r\n-                    $checkStmt->execute([\r\n-                        $bayiId, \r\n-                        $baslangicTarihi, $baslangicTarihi,\r\n-                        $bitisTarihi, $bitisTarihi,\r\n-                        $baslangicTarihi, $bitisTarihi\r\n-                    ]);\r\n-                    $existing = $checkStmt->fetch();\r\n+                    $sql = \"INSERT INTO hakedis_tanim (bayi_id, isp_neo_fiyat, isp_uydu_fiyat, neo_fiyat, uydu_fiyat, hakedis_baslangic_tarihi, hakedis_bitis_tarihi, aciklama) \r\n+                            VALUES (?, ?, ?, ?, ?, ?, ?, ?)\";\r\n+                    $stmt = $conn->prepare($sql);\r\n+                    $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $baslangicTarihi, $bitisTarihi, $aciklama]);\r\n                     \r\n-                    if ($existing['count'] > 0) {\r\n-                        $message = 'Bu bayi için belirtilen tarih aralığında zaten bir hakediş tanımı bulunmaktadır.';\r\n-                        $messageType = 'danger';\r\n-                    } else {\r\n-                        $sql = \"INSERT INTO hakedis_tanim (bayi_id, isp_neo_fiyat, isp_uydu_fiyat, neo_fiyat, uydu_fiyat, hakedis_baslangic_tarihi, hakedis_bitis_tarihi, aciklama) \r\n-                                VALUES (?, ?, ?, ?, ?, ?, ?, ?)\";\r\n-                        $stmt = $conn->prepare($sql);\r\n-                        $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $baslangicTarihi, $bitisTarihi, $aciklama]);\r\n-                        \r\n-                        $message = 'Hakediş tanımı başarıyla eklendi.';\r\n-                        $messageType = 'success';\r\n-                    }\r\n+                    $message = 'Hakediş tanımı başarıyla eklendi.';\r\n+                    $messageType = 'success';\r\n                 }\r\n                 break;\r\n                 \r\n-            case 'edit':\r\n-                $id = (int)$_POST['id'];\r\n-                $bayiId = (int)$_POST['bayi_id'];\r\n-                $ispNeoFiyat = !empty($_POST['isp_neo_fiyat']) ? (float)$_POST['isp_neo_fiyat'] : null;\r\n-                $ispUyduFiyat = !empty($_POST['isp_uydu_fiyat']) ? (float)$_POST['isp_uydu_fiyat'] : null;\r\n-                $neoFiyat = !empty($_POST['neo_fiyat']) ? (float)$_POST['neo_fiyat'] : null;\r\n-                $uyduFiyat = !empty($_POST['uydu_fiyat']) ? (float)$_POST['uydu_fiyat'] : null;\r\n-                $baslangicTarihi = $_POST['hakedis_baslangic_tarihi'];\r\n-                $bitisTarihi = $_POST['hakedis_bitis_tarihi'];\r\n-                $aciklama = trim($_POST['aciklama'] ?? '');\r\n-                \r\n-                // Açıklama uzunluk kontrolü\r\n-                if (strlen($aciklama) > 500) {\r\n-                    $message = 'Açıklama metni 500 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n-                    $messageType = 'danger';\r\n-                } \r\n-                // Tarih kontrolü\r\n-                elseif (strtotime($baslangicTarihi) >= strtotime($bitisTarihi)) {\r\n-                    $message = 'Başlangıç tarihi, bitiş tarihinden önce olmalıdır.';\r\n-                    $messageType = 'danger';\r\n-                } else {\r\n-                    // Çakışan tarih aralığı kontrolü (mevcut kayıt hariç)\r\n-                    $checkSql = \"SELECT COUNT(*) as count FROM hakedis_tanim \r\n-                                WHERE bayi_id = ? AND id != ?\r\n-                                AND (\r\n-                                    (hakedis_baslangic_tarihi <= ? AND hakedis_bitis_tarihi >= ?) OR\r\n-                                    (hakedis_baslangic_tarihi <= ? AND hakedis_bitis_tarihi >= ?) OR\r\n-                                    (hakedis_baslangic_tarihi >= ? AND hakedis_bitis_tarihi <= ?)\r\n-                                )\";\r\n-                    $checkStmt = $conn->prepare($checkSql);\r\n-                    $checkStmt->execute([\r\n-                        $bayiId, $id,\r\n-                        $baslangicTarihi, $baslangicTarihi,\r\n-                        $bitisTarihi, $bitisTarihi,\r\n-                        $baslangicTarihi, $bitisTarihi\r\n-                    ]);\r\n-                    $existing = $checkStmt->fetch();\r\n-                    \r\n-                    if ($existing['count'] > 0) {\r\n-                        $message = 'Bu bayi için belirtilen tarih aralığında zaten başka bir hakediş tanımı bulunmaktadır.';\r\n-                        $messageType = 'danger';\r\n-                    } else {\r\n-                        $sql = \"UPDATE hakedis_tanim SET \r\n-                                bayi_id = ?, isp_neo_fiyat = ?, isp_uydu_fiyat = ?, neo_fiyat = ?, uydu_fiyat = ?, \r\n-                                hakedis_baslangic_tarihi = ?, hakedis_bitis_tarihi = ?, aciklama = ?, updated_at = GETDATE()\r\n-                                WHERE id = ?\";\r\n-                        $stmt = $conn->prepare($sql);\r\n-                        $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $baslangicTarihi, $bitisTarihi, $aciklama, $id]);\r\n-                        \r\n-                        $message = 'Hakediş tanımı başarıyla güncellendi.';\r\n-                        $messageType = 'success';\r\n-                    }\r\n-                }\r\n-                break;\r\n-                \r\n             case 'delete':\r\n                 $id = (int)$_POST['id'];\r\n                 \r\n                 $sql = \"DELETE FROM hakedis_tanim WHERE id = ?\";\r\n@@ -279,15 +92,13 @@\n         $messageType = 'danger';\r\n     }\r\n }\r\n \r\n-// Bayileri al (users tablosundan bayi grubundakiler) with error handling\r\n+// Bayileri al\r\n $bayiler = [];\r\n-$bayilerError = '';\r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n-    // Bayi gruplarını bul\r\n     $bayiGroupSql = \"SELECT id FROM user_groups WHERE group_name IN ('bayi', 'Bayi')\";\r\n     $bayiGroupStmt = $conn->prepare($bayiGroupSql);\r\n     $bayiGroupStmt->execute();\r\n     $bayiGroups = $bayiGroupStmt->fetchAll(PDO::FETCH_COLUMN);\r\n@@ -303,84 +114,27 @@\n         $bayiStmt->execute($bayiGroups);\r\n         $bayiler = $bayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n     }\r\n } catch (Exception $e) {\r\n-    error_log('Error loading bayiler: ' . $e->getMessage());\r\n-    $bayilerError = 'Bayi listesi yüklenirken hata oluştu: ' . $e->getMessage();\r\n+    // Hata durumunda boş array kalacak\r\n }\r\n \r\n-// Filtreleri al\r\n-$filterBayiId = $_GET['bayi_filter'] ?? '';\r\n-$filterBaslangicTarihi = $_GET['baslangic_tarihi'] ?? '';\r\n-$filterBitisTarihi = $_GET['bitis_tarihi'] ?? '';\r\n-\r\n-// Sıralama parametreleri\r\n-$sortColumn = $_GET['sort'] ?? 'hakedis_baslangic_tarihi';\r\n-$sortOrder = $_GET['order'] ?? 'desc';\r\n-\r\n-// Geçerli sıralama kolonları\r\n-$validSortColumns = [\r\n-    'id' => 'ht.id',\r\n-    'bayi' => 'u.first_name',\r\n-    'isp_neo_fiyat' => 'ht.isp_neo_fiyat',\r\n-    'isp_uydu_fiyat' => 'ht.isp_uydu_fiyat',\r\n-    'neo_fiyat' => 'ht.neo_fiyat',\r\n-    'uydu_fiyat' => 'ht.uydu_fiyat',\r\n-    'hakedis_baslangic_tarihi' => 'ht.hakedis_baslangic_tarihi',\r\n-    'hakedis_bitis_tarihi' => 'ht.hakedis_bitis_tarihi',\r\n-    'created_at' => 'ht.created_at'\r\n-];\r\n-\r\n-// Sıralama güvenlik kontrolü\r\n-if (!isset($validSortColumns[$sortColumn])) {\r\n-    $sortColumn = 'hakedis_baslangic_tarihi';\r\n-}\r\n-\r\n-if (!in_array(strtolower($sortOrder), ['asc', 'desc'])) {\r\n-    $sortOrder = 'desc';\r\n-}\r\n-\r\n-// Hakediş tanımlarını listele with better error handling\r\n+// Hakediş tanımlarını listele\r\n $hakedisler = [];\r\n-$hakedislerError = '';\r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n-    // Base SQL query\r\n     $sql = \"SELECT ht.*, u.first_name, u.last_name, u.email\r\n             FROM hakedis_tanim ht\r\n             INNER JOIN users u ON ht.bayi_id = u.id\r\n-            WHERE 1=1\";\r\n+            ORDER BY ht.created_at DESC\";\r\n     \r\n-    $params = [];\r\n-    \r\n-    // Bayi filtresi\r\n-    if (!empty($filterBayiId)) {\r\n-        $sql .= \" AND ht.bayi_id = ?\";\r\n-        $params[] = $filterBayiId;\r\n-    }\r\n-    \r\n-    // Başlangıç tarihi filtresi\r\n-    if (!empty($filterBaslangicTarihi)) {\r\n-        $sql .= \" AND ht.hakedis_baslangic_tarihi >= ?\";\r\n-        $params[] = $filterBaslangicTarihi;\r\n-    }\r\n-    \r\n-    // Bitiş tarihi filtresi\r\n-    if (!empty($filterBitisTarihi)) {\r\n-        $sql .= \" AND ht.hakedis_bitis_tarihi <= ?\";\r\n-        $params[] = $filterBitisTarihi;\r\n-    }\r\n-    \r\n-    $sql .= \" ORDER BY \" . $validSortColumns[$sortColumn] . \" \" . strtoupper($sortOrder);\r\n-    \r\n     $stmt = $conn->prepare($sql);\r\n-    $stmt->execute($params);\r\n+    $stmt->execute();\r\n     $hakedisler = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n     \r\n } catch (Exception $e) {\r\n-    error_log('Error loading hakedisler: ' . $e->getMessage());\r\n-    $hakedislerError = \"Veritabanı hatası: \" . $e->getMessage();\r\n+    $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n }\r\n \r\n include 'includes/header.php';\r\n ?>\r\n@@ -404,178 +158,37 @@\n             <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n         </div>\r\n     <?php endif; ?>\r\n \r\n-    <?php if (isset($hakedislerError) && $hakedislerError): ?>\r\n+    <?php if (isset($error)): ?>\r\n         <div class=\"alert alert-danger alert-dismissible fade show\" role=\"alert\">\r\n             <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n-            <?php echo htmlspecialchars($hakedislerError); ?>\r\n+            <?php echo htmlspecialchars($error); ?>\r\n             <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n         </div>\r\n     <?php endif; ?>\r\n \r\n-    <?php if (isset($bayilerError) && $bayilerError): ?>\r\n-        <div class=\"alert alert-warning alert-dismissible fade show\" role=\"alert\">\r\n-            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n-            <?php echo htmlspecialchars($bayilerError); ?>\r\n-            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n-        </div>\r\n-    <?php endif; ?>\r\n-\r\n-    <!-- Filtreler -->\r\n-    <div class=\"card border-0 shadow-sm mb-4\">\r\n-        <div class=\"card-header bg-light\">\r\n-            <h6 class=\"mb-0\">\r\n-                <i class=\"fas fa-filter me-2\"></i>Filtreler\r\n-            </h6>\r\n-        </div>\r\n-        <div class=\"card-body\">\r\n-            <form method=\"GET\" action=\"\">\r\n-                <!-- Sıralama parametrelerini koru -->\r\n-                <input type=\"hidden\" name=\"sort\" value=\"<?php echo htmlspecialchars($sortColumn); ?>\">\r\n-                <input type=\"hidden\" name=\"order\" value=\"<?php echo htmlspecialchars($sortOrder); ?>\">\r\n-                \r\n-                <div class=\"row g-3\">\r\n-                    <div class=\"col-md-4\">\r\n-                        <label for=\"bayi_filter\" class=\"form-label\">Bayi Adı</label>\r\n-                        <select class=\"form-select\" id=\"bayi_filter\" name=\"bayi_filter\">\r\n-                            <option value=\"\">Tüm Bayiler</option>\r\n-                            <?php foreach ($bayiler as $bayi): ?>\r\n-                                <option value=\"<?php echo $bayi['id']; ?>\" \r\n-                                        <?php echo ($filterBayiId == $bayi['id']) ? 'selected' : ''; ?>>\r\n-                                    <?php echo htmlspecialchars($bayi['first_name'] . ' ' . $bayi['last_name']); ?>\r\n-                                </option>\r\n-                            <?php endforeach; ?>\r\n-                        </select>\r\n-                    </div>\r\n-                    <div class=\"col-md-3\">\r\n-                        <label for=\"baslangic_tarihi\" class=\"form-label\">Başlangıç Tarihi (Min)</label>\r\n-                        <input type=\"date\" class=\"form-control\" id=\"baslangic_tarihi\" name=\"baslangic_tarihi\" \r\n-                               value=\"<?php echo htmlspecialchars($filterBaslangicTarihi); ?>\">\r\n-                    </div>\r\n-                    <div class=\"col-md-3\">\r\n-                        <label for=\"bitis_tarihi\" class=\"form-label\">Bitiş Tarihi (Max)</label>\r\n-                        <input type=\"date\" class=\"form-control\" id=\"bitis_tarihi\" name=\"bitis_tarihi\" \r\n-                               value=\"<?php echo htmlspecialchars($filterBitisTarihi); ?>\">\r\n-                    </div>\r\n-                    <div class=\"col-md-2 d-flex align-items-end\">\r\n-                        <div class=\"btn-group w-100\" role=\"group\">\r\n-                            <button type=\"submit\" class=\"btn btn-primary\">\r\n-                                <i class=\"fas fa-search me-1\"></i>Filtrele\r\n-                            </button>\r\n-                            <a href=\"bayi_hakedis_tanimla.php\" class=\"btn btn-outline-secondary\" title=\"Filtreleri Temizle\">\r\n-                                <i class=\"fas fa-times\"></i>\r\n-                            </a>\r\n-                        </div>\r\n-                    </div>\r\n-                </div>\r\n-            </form>\r\n-        </div>\r\n-    </div>\r\n-\r\n     <!-- Hakediş Tanımları Tablosu -->\r\n     <div class=\"card border-0 shadow-sm\">\r\n         <div class=\"card-header bg-primary text-white\">\r\n             <h5 class=\"mb-0\">\r\n-                <i class=\"fas fa-list me-2\"></i>Hakediş Tanım Listesi\r\n+                <i class=\"fas fa-list me-2\"></i>Hakediş Tanım Listesi (<?php echo count($hakedisler); ?> kayıt)\r\n             </h5>\r\n         </div>\r\n         <div class=\"card-body p-0\">\r\n             <div class=\"table-responsive\">\r\n                 <table class=\"table table-hover mb-0\">\r\n                     <thead class=\"table-light\">\r\n                         <tr>\r\n-                            <th>\r\n-                                <a href=\"javascript:void(0)\" onclick=\"sortTable('id')\" class=\"text-decoration-none text-dark\">\r\n-                                    ID\r\n-                                    <?php if ($sortColumn == 'id'): ?>\r\n-                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n-                                    <?php else: ?>\r\n-                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n-                                    <?php endif; ?>\r\n-                                </a>\r\n-                            </th>\r\n-                            <th>\r\n-                                <a href=\"javascript:void(0)\" onclick=\"sortTable('bayi')\" class=\"text-decoration-none text-dark\">\r\n-                                    Bayi\r\n-                                    <?php if ($sortColumn == 'bayi'): ?>\r\n-                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n-                                    <?php else: ?>\r\n-                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n-                                    <?php endif; ?>\r\n-                                </a>\r\n-                            </th>\r\n-                            <th>\r\n-                                <a href=\"javascript:void(0)\" onclick=\"sortTable('isp_neo_fiyat')\" class=\"text-decoration-none text-dark\">\r\n-                                    ISP Neo Fiyat\r\n-                                    <?php if ($sortColumn == 'isp_neo_fiyat'): ?>\r\n-                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n-                                    <?php else: ?>\r\n-                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n-                                    <?php endif; ?>\r\n-                                </a>\r\n-                            </th>\r\n-                            <th>\r\n-                                <a href=\"javascript:void(0)\" onclick=\"sortTable('isp_uydu_fiyat')\" class=\"text-decoration-none text-dark\">\r\n-                                    ISP Uydu Fiyat\r\n-                                    <?php if ($sortColumn == 'isp_uydu_fiyat'): ?>\r\n-                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n-                                    <?php else: ?>\r\n-                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n-                                    <?php endif; ?>\r\n-                                </a>\r\n-                            </th>\r\n-                            <th>\r\n-                                <a href=\"javascript:void(0)\" onclick=\"sortTable('neo_fiyat')\" class=\"text-decoration-none text-dark\">\r\n-                                    Neo Fiyat\r\n-                                    <?php if ($sortColumn == 'neo_fiyat'): ?>\r\n-                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n-                                    <?php else: ?>\r\n-                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n-                                    <?php endif; ?>\r\n-                                </a>\r\n-                            </th>\r\n-                            <th>\r\n-                                <a href=\"javascript:void(0)\" onclick=\"sortTable('uydu_fiyat')\" class=\"text-decoration-none text-dark\">\r\n-                                    Uydu Fiyat\r\n-                                    <?php if ($sortColumn == 'uydu_fiyat'): ?>\r\n-                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n-                                    <?php else: ?>\r\n-                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n-                                    <?php endif; ?>\r\n-                                </a>\r\n-                            </th>\r\n-                            <th>\r\n-                                <a href=\"javascript:void(0)\" onclick=\"sortTable('hakedis_baslangic_tarihi')\" class=\"text-decoration-none text-dark\">\r\n-                                    Başlangıç Tarihi\r\n-                                    <?php if ($sortColumn == 'hakedis_baslangic_tarihi'): ?>\r\n-                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n-                                    <?php else: ?>\r\n-                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n-                                    <?php endif; ?>\r\n-                                </a>\r\n-                            </th>\r\n-                            <th>\r\n-                                <a href=\"javascript:void(0)\" onclick=\"sortTable('hakedis_bitis_tarihi')\" class=\"text-decoration-none text-dark\">\r\n-                                    Bitiş Tarihi\r\n-                                    <?php if ($sortColumn == 'hakedis_bitis_tarihi'): ?>\r\n-                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n-                                    <?php else: ?>\r\n-                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n-                                    <?php endif; ?>\r\n-                                </a>\r\n-                            </th>\r\n+                            <th>ID</th>\r\n+                            <th>Bayi</th>\r\n+                            <th>ISP Neo Fiyat</th>\r\n+                            <th>ISP Uydu Fiyat</th>\r\n+                            <th>Neo Fiyat</th>\r\n+                            <th>Uydu Fiyat</th>\r\n+                            <th>Başlangıç Tarihi</th>\r\n+                            <th>Bitiş Tarihi</th>\r\n                             <th>Açıklama</th>\r\n-                            <th>\r\n-                                <a href=\"javascript:void(0)\" onclick=\"sortTable('created_at')\" class=\"text-decoration-none text-dark\">\r\n-                                    Oluşturulma\r\n-                                    <?php if ($sortColumn == 'created_at'): ?>\r\n-                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n-                                    <?php else: ?>\r\n-                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n-                                    <?php endif; ?>\r\n-                                </a>\r\n-                            </th>\r\n                             <th>İşlemler</th>\r\n                         </tr>\r\n                     </thead>\r\n                     <tbody>\r\n@@ -617,27 +230,18 @@\n                                             ?>\r\n                                         </span>\r\n                                     </td>\r\n                                     <td>\r\n-                                        <?php echo date('d.m.Y H:i', strtotime($hakedis['created_at'])); ?>\r\n+                                        <button type=\"button\" class=\"btn btn-sm btn-outline-danger\" \r\n+                                                onclick=\"deleteHakedis(<?php echo $hakedis['id']; ?>, '<?php echo htmlspecialchars($hakedis['first_name'] . ' ' . $hakedis['last_name']); ?>')\">\r\n+                                            <i class=\"fas fa-trash\"></i>\r\n+                                        </button>\r\n                                     </td>\r\n-                                    <td>\r\n-                                        <div class=\"btn-group\" role=\"group\">\r\n-                                            <button type=\"button\" class=\"btn btn-sm btn-outline-primary\" \r\n-                                                    onclick=\"editHakedis(<?php echo htmlspecialchars(json_encode($hakedis)); ?>)\">\r\n-                                                <i class=\"fas fa-edit\"></i>\r\n-                                            </button>\r\n-                                            <button type=\"button\" class=\"btn btn-sm btn-outline-danger\" \r\n-                                                    onclick=\"deleteHakedis(<?php echo $hakedis['id']; ?>, '<?php echo htmlspecialchars($hakedis['first_name'] . ' ' . $hakedis['last_name']); ?>')\">\r\n-                                                <i class=\"fas fa-trash\"></i>\r\n-                                            </button>\r\n-                                        </div>\r\n-                                    </td>\r\n                                 </tr>\r\n                             <?php endforeach; ?>\r\n                         <?php else: ?>\r\n                             <tr>\r\n-                                <td colspan=\"11\" class=\"text-center py-5 text-muted\">\r\n+                                <td colspan=\"10\" class=\"text-center py-5 text-muted\">\r\n                                     <i class=\"fas fa-calculator fa-3x mb-3 d-block\"></i>\r\n                                     <h5>Henüz hakediş tanımı bulunmuyor</h5>\r\n                                     <p>İlk hakediş tanımını eklemek için \"Yeni Hakediş Tanımı\" butonuna tıklayın.</p>\r\n                                 </td>\r\n@@ -653,9 +257,9 @@\n <!-- Yeni Hakediş Tanımı Modal -->\r\n <div class=\"modal fade\" id=\"addHakedisModal\" tabindex=\"-1\">\r\n     <div class=\"modal-dialog modal-lg\">\r\n         <div class=\"modal-content\">\r\n-            <form method=\"POST\" action=\"\" id=\"addHakedisForm\">\r\n+            <form method=\"POST\" action=\"\">\r\n                 <input type=\"hidden\" name=\"action\" value=\"add\">\r\n                 <div class=\"modal-header\">\r\n                     <h5 class=\"modal-title\">\r\n                         <i class=\"fas fa-plus me-2\"></i>Yeni Hakediş Tanımı\r\n@@ -663,10 +267,10 @@\n                     <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                 </div>\r\n                 <div class=\"modal-body\">\r\n                     <div class=\"mb-3\">\r\n-                        <label for=\"add_bayi_id\" class=\"form-label\">Bayi <span class=\"text-danger\">*</span></label>\r\n-                        <select class=\"form-select\" id=\"add_bayi_id\" name=\"bayi_id\" required>\r\n+                        <label for=\"bayi_id\" class=\"form-label\">Bayi <span class=\"text-danger\">*</span></label>\r\n+                        <select class=\"form-select\" id=\"bayi_id\" name=\"bayi_id\" required>\r\n                             <option value=\"\">Bayi Seçin</option>\r\n                             <?php foreach ($bayiler as $bayi): ?>\r\n                                 <option value=\"<?php echo $bayi['id']; ?>\">\r\n                                     <?php echo htmlspecialchars($bayi['first_name'] . ' ' . $bayi['last_name'] . ' (' . $bayi['email'] . ')'); ?>\r\n@@ -676,260 +280,74 @@\n                     </div>\r\n                     \r\n                     <div class=\"row\">\r\n                         <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"add_isp_neo_fiyat\" class=\"form-label\">ISP Neo Fiyat</label>\r\n+                            <label for=\"isp_neo_fiyat\" class=\"form-label\">ISP Neo Fiyat</label>\r\n                             <div class=\"input-group\">\r\n-                                <input type=\"number\" class=\"form-control\" id=\"add_isp_neo_fiyat\" name=\"isp_neo_fiyat\" \r\n+                                <input type=\"number\" class=\"form-control\" id=\"isp_neo_fiyat\" name=\"isp_neo_fiyat\" \r\n                                        step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                 <span class=\"input-group-text\">₺</span>\r\n                             </div>\r\n                         </div>\r\n                         <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"add_isp_uydu_fiyat\" class=\"form-label\">ISP Uydu Fiyat</label>\r\n+                            <label for=\"isp_uydu_fiyat\" class=\"form-label\">ISP Uydu Fiyat</label>\r\n                             <div class=\"input-group\">\r\n-                                <input type=\"number\" class=\"form-control\" id=\"add_isp_uydu_fiyat\" name=\"isp_uydu_fiyat\" \r\n+                                <input type=\"number\" class=\"form-control\" id=\"isp_uydu_fiyat\" name=\"isp_uydu_fiyat\" \r\n                                        step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                 <span class=\"input-group-text\">₺</span>\r\n                             </div>\r\n                         </div>\r\n                     </div>\r\n                     \r\n                     <div class=\"row\">\r\n                         <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"add_neo_fiyat\" class=\"form-label\">Neo Fiyat</label>\r\n+                            <label for=\"neo_fiyat\" class=\"form-label\">Neo Fiyat</label>\r\n                             <div class=\"input-group\">\r\n-                                <input type=\"number\" class=\"form-control\" id=\"add_neo_fiyat\" name=\"neo_fiyat\" \r\n+                                <input type=\"number\" class=\"form-control\" id=\"neo_fiyat\" name=\"neo_fiyat\" \r\n                                        step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                 <span class=\"input-group-text\">₺</span>\r\n                             </div>\r\n                         </div>\r\n                         <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"add_uydu_fiyat\" class=\"form-label\">Uydu Fiyat</label>\r\n+                            <label for=\"uydu_fiyat\" class=\"form-label\">Uydu Fiyat</label>\r\n                             <div class=\"input-group\">\r\n-                                <input type=\"number\" class=\"form-control\" id=\"add_uydu_fiyat\" name=\"uydu_fiyat\" \r\n+                                <input type=\"number\" class=\"form-control\" id=\"uydu_fiyat\" name=\"uydu_fiyat\" \r\n                                        step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                 <span class=\"input-group-text\">₺</span>\r\n                             </div>\r\n                         </div>\r\n                     </div>\r\n                     \r\n                     <div class=\"row\">\r\n                         <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"add_baslangic_tarihi\" class=\"form-label\">Hakediş Başlangıç Tarihi <span class=\"text-danger\">*</span></label>\r\n-                            <input type=\"date\" class=\"form-control\" id=\"add_baslangic_tarihi\" name=\"hakedis_baslangic_tarihi\" required>\r\n+                            <label for=\"hakedis_baslangic_tarihi\" class=\"form-label\">Hakediş Başlangıç Tarihi <span class=\"text-danger\">*</span></label>\r\n+                            <input type=\"date\" class=\"form-control\" id=\"hakedis_baslangic_tarihi\" name=\"hakedis_baslangic_tarihi\" required>\r\n                         </div>\r\n                         <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"add_bitis_tarihi\" class=\"form-label\">Hakediş Bitiş Tarihi <span class=\"text-danger\">*</span></label>\r\n-                            <input type=\"date\" class=\"form-control\" id=\"add_bitis_tarihi\" name=\"hakedis_bitis_tarihi\" required>\r\n+                            <label for=\"hakedis_bitis_tarihi\" class=\"form-label\">Hakediş Bitiş Tarihi <span class=\"text-danger\">*</span></label>\r\n+                            <input type=\"date\" class=\"form-control\" id=\"hakedis_bitis_tarihi\" name=\"hakedis_bitis_tarihi\" required>\r\n                         </div>\r\n                     </div>\r\n                     \r\n                     <div class=\"mb-3\">\r\n-                        <label for=\"add_aciklama\" class=\"form-label\">Açıklama</label>\r\n-                        <textarea class=\"form-control\" id=\"add_aciklama\" name=\"aciklama\" rows=\"3\" \r\n+                        <label for=\"aciklama\" class=\"form-label\">Açıklama</label>\r\n+                        <textarea class=\"form-control\" id=\"aciklama\" name=\"aciklama\" rows=\"3\" \r\n                                   placeholder=\"Hakediş tanımı ile ilgili açıklama (isteğe bağlı)\" maxlength=\"200\"></textarea>\r\n-                        <div class=\"form-text d-flex justify-content-between\">\r\n-                            <span>Maksimum 200 karakter</span>\r\n-                            <span id=\"add_char_count\">0/200</span>\r\n-                        </div>\r\n+                        <div class=\"form-text\">Maksimum 200 karakter</div>\r\n                     </div>\r\n                 </div>\r\n                 <div class=\"modal-footer\">\r\n                     <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n-                    <button type=\"submit\" class=\"btn btn-primary\" id=\"add_submit_btn\">\r\n+                    <button type=\"submit\" class=\"btn btn-primary\">\r\n                         <i class=\"fas fa-save me-1\"></i>Kaydet\r\n                     </button>\r\n                 </div>\r\n-                <div id=\"add_error_message\" class=\"alert alert-danger mt-3\" style=\"display: none;\"></div>\r\n             </form>\r\n         </div>\r\n     </div>\r\n </div>\r\n \r\n-<!-- Hakediş Düzenle Modal -->\r\n-<div class=\"modal fade\" id=\"editHakedisModal\" tabindex=\"-1\">\r\n-    <div class=\"modal-dialog modal-lg\">\r\n-        <div class=\"modal-content\">\r\n-            <form method=\"POST\" action=\"\" id=\"editHakedisForm\">\r\n-                <input type=\"hidden\" name=\"action\" value=\"edit\">\r\n-                <input type=\"hidden\" name=\"id\" id=\"edit_id\">\r\n-                <div class=\"modal-header\">\r\n-                    <h5 class=\"modal-title\">\r\n-                        <i class=\"fas fa-edit me-2\"></i>Hakediş Tanımı Düzenle\r\n-                    </h5>\r\n-                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n-                </div>\r\n-                <div class=\"modal-body\">\r\n-                    <div class=\"mb-3\">\r\n-                        <label for=\"edit_bayi_id\" class=\"form-label\">Bayi <span class=\"text-danger\">*</span></label>\r\n-                        <select class=\"form-select\" id=\"edit_bayi_id\" name=\"bayi_id\" required>\r\n-                            <option value=\"\">Bayi Seçin</option>\r\n-                            <?php foreach ($bayiler as $bayi): ?>\r\n-                                <option value=\"<?php echo $bayi['id']; ?>\">\r\n-                                    <?php echo htmlspecialchars($bayi['first_name'] . ' ' . $bayi['last_name'] . ' (' . $bayi['email'] . ')'); ?>\r\n-                                </option>\r\n-                            <?php endforeach; ?>\r\n-                        </select>\r\n-                    </div>\r\n-                    \r\n-                    <div class=\"row\">\r\n-                        <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"edit_isp_neo_fiyat\" class=\"form-label\">ISP Neo Fiyat</label>\r\n-                            <div class=\"input-group\">\r\n-                                <input type=\"number\" class=\"form-control\" id=\"edit_isp_neo_fiyat\" name=\"isp_neo_fiyat\" \r\n-                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n-                                <span class=\"input-group-text\">₺</span>\r\n-                            </div>\r\n-                        </div>\r\n-                        <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"edit_isp_uydu_fiyat\" class=\"form-label\">ISP Uydu Fiyat</label>\r\n-                            <div class=\"input-group\">\r\n-                                <input type=\"number\" class=\"form-control\" id=\"edit_isp_uydu_fiyat\" name=\"isp_uydu_fiyat\" \r\n-                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n-                                <span class=\"input-group-text\">₺</span>\r\n-                            </div>\r\n-                        </div>\r\n-                    </div>\r\n-                    \r\n-                    <div class=\"row\">\r\n-                        <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"edit_neo_fiyat\" class=\"form-label\">Neo Fiyat</label>\r\n-                            <div class=\"input-group\">\r\n-                                <input type=\"number\" class=\"form-control\" id=\"edit_neo_fiyat\" name=\"neo_fiyat\" \r\n-                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n-                                <span class=\"input-group-text\">₺</span>\r\n-                            </div>\r\n-                        </div>\r\n-                        <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"edit_uydu_fiyat\" class=\"form-label\">Uydu Fiyat</label>\r\n-                            <div class=\"input-group\">\r\n-                                <input type=\"number\" class=\"form-control\" id=\"edit_uydu_fiyat\" name=\"uydu_fiyat\" \r\n-                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n-                                <span class=\"input-group-text\">₺</span>\r\n-                            </div>\r\n-                        </div>\r\n-                    </div>\r\n-                    \r\n-                    <div class=\"row\">\r\n-                        <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"edit_baslangic_tarihi\" class=\"form-label\">Hakediş Başlangıç Tarihi <span class=\"text-danger\">*</span></label>\r\n-                            <input type=\"date\" class=\"form-control\" id=\"edit_baslangic_tarihi\" name=\"hakedis_baslangic_tarihi\" required>\r\n-                        </div>\r\n-                        <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"edit_bitis_tarihi\" class=\"form-label\">Hakediş Bitiş Tarihi <span class=\"text-danger\">*</span></label>\r\n-                            <input type=\"date\" class=\"form-control\" id=\"edit_bitis_tarihi\" name=\"hakedis_bitis_tarihi\" required>\r\n-                        </div>\r\n-                    </div>\r\n-                    \r\n-                    <div class=\"mb-3\">\r\n-                        <label for=\"edit_aciklama\" class=\"form-label\">Açıklama</label>\r\n-                        <textarea class=\"form-control\" id=\"edit_aciklama\" name=\"aciklama\" rows=\"3\" \r\n-                                  placeholder=\"Hakediş tanımı ile ilgili açıklama (isteğe bağlı)\" maxlength=\"200\"></textarea>\r\n-                        <div class=\"form-text d-flex justify-content-between\">\r\n-                            <span>Maksimum 200 karakter</span>\r\n-                            <span id=\"edit_char_count\">0/200</span>\r\n-                        </div>\r\n-                    </div>\r\n-                </div>\r\n-                <div class=\"modal-footer\">\r\n-                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n-                    <button type=\"submit\" class=\"btn btn-primary\" id=\"edit_submit_btn\">\r\n-                        <i class=\"fas fa-save me-1\"></i>Güncelle\r\n-                    </button>\r\n-                </div>\r\n-                <div id=\"edit_error_message\" class=\"alert alert-danger mt-3\" style=\"display: none;\"></div>\r\n-            </form>\r\n-        </div>\r\n-    </div>\r\n-</div>\r\n-\r\n-<script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\r\n <script>\r\n-// Karakter sayacı fonksiyonları\r\n-function updateCharCounter(textareaId, counterId) {\r\n-    const textarea = document.getElementById(textareaId);\r\n-    const counter = document.getElementById(counterId);\r\n-    \r\n-    if (textarea && counter) {\r\n-        const updateCount = () => {\r\n-            const currentLength = textarea.value.length;\r\n-            const maxLength = 200;\r\n-            counter.textContent = `${currentLength}/${maxLength}`;\r\n-            \r\n-            // Limit aşıldığında renk değişimi\r\n-            if (currentLength > maxLength * 0.9) {\r\n-                counter.classList.add('text-warning');\r\n-            } else {\r\n-                counter.classList.remove('text-warning');\r\n-            }\r\n-            \r\n-            if (currentLength >= maxLength) {\r\n-                counter.classList.add('text-danger');\r\n-                counter.classList.remove('text-warning');\r\n-            } else {\r\n-                counter.classList.remove('text-danger');\r\n-            }\r\n-        };\r\n-        \r\n-        textarea.addEventListener('input', updateCount);\r\n-        textarea.addEventListener('keyup', updateCount);\r\n-        textarea.addEventListener('paste', () => {\r\n-            setTimeout(updateCount, 10); // Paste işlemi tamamlandıktan sonra güncelle\r\n-        });\r\n-        \r\n-        // İlk yüklemede güncellemeleri\r\n-        updateCount();\r\n-    }\r\n-}\r\n-\r\n-function sortTable(column) {\r\n-    const currentSort = '<?php echo $sortColumn; ?>';\r\n-    const currentOrder = '<?php echo $sortOrder; ?>';\r\n-    \r\n-    // Eğer aynı kolona tıklanırsa sıralamayı ters çevir\r\n-    let newOrder = 'asc';\r\n-    if (column === currentSort && currentOrder === 'asc') {\r\n-        newOrder = 'desc';\r\n-    }\r\n-    \r\n-    // Mevcut URL parametrelerini al\r\n-    const urlParams = new URLSearchParams(window.location.search);\r\n-    \r\n-    // Sıralama parametrelerini güncelle\r\n-    urlParams.set('sort', column);\r\n-    urlParams.set('order', newOrder);\r\n-    \r\n-    // Sayfayı yenile\r\n-    window.location.search = urlParams.toString();\r\n-}\r\n-\r\n-function editHakedis(hakedis) {\r\n-    document.getElementById('edit_id').value = hakedis.id;\r\n-    document.getElementById('edit_bayi_id').value = hakedis.bayi_id;\r\n-    document.getElementById('edit_isp_neo_fiyat').value = hakedis.isp_neo_fiyat || '';\r\n-    document.getElementById('edit_isp_uydu_fiyat').value = hakedis.isp_uydu_fiyat || '';\r\n-    document.getElementById('edit_neo_fiyat').value = hakedis.neo_fiyat || '';\r\n-    document.getElementById('edit_uydu_fiyat').value = hakedis.uydu_fiyat || '';\r\n-    document.getElementById('edit_aciklama').value = hakedis.aciklama || '';\r\n-    \r\n-    // Karakter sayacını güncelle\r\n-    updateCharCounter('edit_aciklama', 'edit_char_count');\r\n-    \r\n-    // Tarihleri formatla (YYYY-MM-DD)\r\n-    if (hakedis.hakedis_baslangic_tarihi) {\r\n-        const baslangic = new Date(hakedis.hakedis_baslangic_tarihi);\r\n-        document.getElementById('edit_baslangic_tarihi').value = baslangic.toISOString().split('T')[0];\r\n-    }\r\n-    \r\n-    if (hakedis.hakedis_bitis_tarihi) {\r\n-        const bitis = new Date(hakedis.hakedis_bitis_tarihi);\r\n-        document.getElementById('edit_bitis_tarihi').value = bitis.toISOString().split('T')[0];\r\n-    }\r\n-    \r\n-    new bootstrap.Modal(document.getElementById('editHakedisModal')).show();\r\n-}\r\n-\r\n function deleteHakedis(hakedisId, bayiName) {\r\n     if (confirm(bayiName + ' için hakediş tanımını silmek istediğinizden emin misiniz?\\n\\nBu işlem geri alınamaz.')) {\r\n         const form = document.createElement('form');\r\n         form.method = 'POST';\r\n@@ -940,147 +358,7 @@\n         document.body.appendChild(form);\r\n         form.submit();\r\n     }\r\n }\r\n-\r\n-// Form validasyonu\r\n-document.addEventListener('DOMContentLoaded', function() {\r\n-    // AJAX ile tarih çakışması kontrolü\r\n-    function checkDateConflict(bayiId, baslangicTarihi, bitisTarihi, editId = null) {\r\n-        return fetch('', {\r\n-            method: 'POST',\r\n-            headers: {\r\n-                'Content-Type': 'application/x-www-form-urlencoded',\r\n-            },\r\n-            body: new URLSearchParams({\r\n-                action: 'check_date_conflict',\r\n-                bayi_id: bayiId,\r\n-                hakedis_baslangic_tarihi: baslangicTarihi,\r\n-                hakedis_bitis_tarihi: bitisTarihi,\r\n-                ...(editId && { edit_id: editId })\r\n-            })\r\n-        })\r\n-        .then(response => response.json());\r\n-    }\r\n-\r\n-    // Form submit handler\r\n-    function handleFormSubmit(formId, errorElementId, submitBtnId, editId = null) {\r\n-        const form = document.getElementById(formId);\r\n-        const errorElement = document.getElementById(errorElementId);\r\n-        const submitBtn = document.getElementById(submitBtnId);\r\n-        \r\n-        form.addEventListener('submit', async function(e) {\r\n-            e.preventDefault();\r\n-            \r\n-            // Error mesajını gizle\r\n-            errorElement.style.display = 'none';\r\n-            \r\n-            // Form verilerini al\r\n-            const formData = new FormData(form);\r\n-            const bayiId = formData.get('bayi_id');\r\n-            const baslangicTarihi = formData.get('hakedis_baslangic_tarihi');\r\n-            const bitisTarihi = formData.get('hakedis_bitis_tarihi');\r\n-            \r\n-            // Temel validasyonlar\r\n-            if (!bayiId || !baslangicTarihi || !bitisTarihi) {\r\n-                showError(errorElement, 'Lütfen tüm gerekli alanları doldurun.');\r\n-                return;\r\n-            }\r\n-            \r\n-            // Tarih validasyonu\r\n-            if (new Date(baslangicTarihi) >= new Date(bitisTarihi)) {\r\n-                showError(errorElement, 'Başlangıç tarihi, bitiş tarihinden önce olmalıdır.');\r\n-                return;\r\n-            }\r\n-            \r\n-            // Açıklama uzunluk kontrolü\r\n-            const aciklama = formData.get('aciklama') || '';\r\n-            if (aciklama.length > 200) {\r\n-                showError(errorElement, `Açıklama metni 200 karakteri geçemez. Mevcut uzunluk: ${aciklama.length} karakter.`);\r\n-                return;\r\n-            }\r\n-            \r\n-            // Submit butonunu devre dışı bırak\r\n-            submitBtn.disabled = true;\r\n-            submitBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin me-1\"></i>Kontrol ediliyor...';\r\n-            \r\n-            try {\r\n-                // Tarih çakışması kontrolü\r\n-                const result = await checkDateConflict(bayiId, baslangicTarihi, bitisTarihi, editId);\r\n-                \r\n-                if (result.conflict) {\r\n-                    showError(errorElement, result.message);\r\n-                    submitBtn.disabled = false;\r\n-                    submitBtn.innerHTML = editId ? '<i class=\"fas fa-save me-1\"></i>Güncelle' : '<i class=\"fas fa-save me-1\"></i>Kaydet';\r\n-                    return;\r\n-                }\r\n-                \r\n-                // Eğer çakışma yoksa formu submit et\r\n-                submitBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin me-1\"></i>Kaydediliyor...';\r\n-                \r\n-                // Normal form submit\r\n-                const originalAction = formData.get('action');\r\n-                form.submit();\r\n-                \r\n-            } catch (error) {\r\n-                console.error('Error:', error);\r\n-                showError(errorElement, 'Bir hata oluştu. Lütfen tekrar deneyin.');\r\n-                submitBtn.disabled = false;\r\n-                submitBtn.innerHTML = editId ? '<i class=\"fas fa-save me-1\"></i>Güncelle' : '<i class=\"fas fa-save me-1\"></i>Kaydet';\r\n-            }\r\n-        });\r\n-    }\r\n-    \r\n-    // Error mesajı gösterme fonksiyonu\r\n-    function showError(errorElement, message) {\r\n-        errorElement.textContent = message;\r\n-        errorElement.style.display = 'block';\r\n-        errorElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\r\n-    }\r\n-    \r\n-    // Form handlerları\r\n-    handleFormSubmit('addHakedisForm', 'add_error_message', 'add_submit_btn');\r\n-    handleFormSubmit('editHakedisForm', 'edit_error_message', 'edit_submit_btn', true);\r\n-    \r\n-    // Başlangıç ve bitiş tarihi validasyonu\r\n-    function validateDates(baslangicId, bitisId) {\r\n-        const baslangic = document.getElementById(baslangicId);\r\n-        const bitis = document.getElementById(bitisId);\r\n-        \r\n-        function checkDates() {\r\n-            if (baslangic.value && bitis.value) {\r\n-                if (new Date(baslangic.value) >= new Date(bitis.value)) {\r\n-                    bitis.setCustomValidity('Bitiş tarihi başlangıç tarihinden sonra olmalıdır');\r\n-                } else {\r\n-                    bitis.setCustomValidity('');\r\n-                }\r\n-            }\r\n-        }\r\n-        \r\n-        baslangic.addEventListener('change', checkDates);\r\n-        bitis.addEventListener('change', checkDates);\r\n-    }\r\n-    \r\n-    // Her iki modal için tarih validasyonu\r\n-    validateDates('add_baslangic_tarihi', 'add_bitis_tarihi');\r\n-    validateDates('edit_baslangic_tarihi', 'edit_bitis_tarihi');\r\n-    \r\n-    // Karakter sayaçlarını başlat\r\n-    updateCharCounter('add_aciklama', 'add_char_count');\r\n-    updateCharCounter('edit_aciklama', 'edit_char_count');\r\n-    \r\n-    // Modal kapandığında error mesajlarını temizle\r\n-    document.getElementById('addHakedisModal').addEventListener('hidden.bs.modal', function () {\r\n-        document.getElementById('add_error_message').style.display = 'none';\r\n-        document.getElementById('add_submit_btn').disabled = false;\r\n-        document.getElementById('add_submit_btn').innerHTML = '<i class=\"fas fa-save me-1\"></i>Kaydet';\r\n-    });\r\n-    \r\n-    document.getElementById('editHakedisModal').addEventListener('hidden.bs.modal', function () {\r\n-        document.getElementById('edit_error_message').style.display = 'none';\r\n-        document.getElementById('edit_submit_btn').disabled = false;\r\n-        document.getElementById('edit_submit_btn').innerHTML = '<i class=\"fas fa-save me-1\"></i>Güncelle';\r\n-    });\r\n-});\r\n </script>\r\n \r\n-<?php include 'includes/footer.php'; ?>\r\n+<?php include 'includes/footer.php'; ?>\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759334984642,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,35 +7,8 @@\n // Auth kontrol\r\n require_once 'auth.php';\r\n $currentUser = checkAdminAuth();\r\n \r\n-// Veritabanı bağlantı fonksiyonu\r\n-function getDatabaseConnection() {\r\n-    $configFile = __DIR__ . '/config/mssql.php';\r\n-    \r\n-    if (!file_exists($configFile)) {\r\n-        throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı');\r\n-    }\r\n-    \r\n-    $config = include $configFile;\r\n-    \r\n-    try {\r\n-        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n-        \r\n-        $connection = new PDO($dsn, $config['username'], $config['password'], [\r\n-            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n-            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n-            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n-            PDO::ATTR_EMULATE_PREPARES => false\r\n-        ]);\r\n-        \r\n-        return $connection;\r\n-        \r\n-    } catch (PDOException $e) {\r\n-        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n-    }\r\n-}\r\n-\r\n $message = '';\r\n $messageType = '';\r\n \r\n // Hakediş tanım işlemleri\r\n"
                },
                {
                    "date": 1759417793848,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -48,8 +48,68 @@\n                     $messageType = 'success';\r\n                 }\r\n                 break;\r\n                 \r\n+            case 'edit':\r\n+                $id = (int)$_POST['id'];\r\n+                $bayiId = (int)$_POST['bayi_id'];\r\n+                $ispNeoFiyat = !empty($_POST['isp_neo_fiyat']) ? (float)$_POST['isp_neo_fiyat'] : null;\r\n+                $ispUyduFiyat = !empty($_POST['isp_uydu_fiyat']) ? (float)$_POST['isp_uydu_fiyat'] : null;\r\n+                $neoFiyat = !empty($_POST['neo_fiyat']) ? (float)$_POST['neo_fiyat'] : null;\r\n+                $uyduFiyat = !empty($_POST['uydu_fiyat']) ? (float)$_POST['uydu_fiyat'] : null;\r\n+                $baslangicTarihi = $_POST['hakedis_baslangic_tarihi'];\r\n+                $bitisTarihi = $_POST['hakedis_bitis_tarihi'];\r\n+                $aciklama = trim($_POST['aciklama'] ?? '');\r\n+                \r\n+                // Açıklama uzunluk kontrolü\r\n+                if (strlen($aciklama) > 200) {\r\n+                    $message = 'Açıklama metni 200 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n+                    $messageType = 'danger';\r\n+                } \r\n+                // Tarih kontrolü\r\n+                elseif (strtotime($baslangicTarihi) >= strtotime($bitisTarihi)) {\r\n+                    $message = 'Başlangıç tarihi, bitiş tarihinden önce olmalıdır.';\r\n+                    $messageType = 'danger';\r\n+                } else {\r\n+                    $sql = \"UPDATE hakedis_tanim SET bayi_id = ?, isp_neo_fiyat = ?, isp_uydu_fiyat = ?, neo_fiyat = ?, uydu_fiyat = ?, hakedis_baslangic_tarihi = ?, hakedis_bitis_tarihi = ?, aciklama = ? WHERE id = ?\";\r\n+                    $stmt = $conn->prepare($sql);\r\n+                    $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $baslangicTarihi, $bitisTarihi, $aciklama, $id]);\r\n+                    \r\n+                    $message = 'Hakediş tanımı başarıyla güncellendi.';\r\n+                    $messageType = 'success';\r\n+                }\r\n+                break;\r\n+                \r\n+            case 'edit':\r\n+                $id = (int)$_POST['id'];\r\n+                $bayiId = (int)$_POST['bayi_id'];\r\n+                $ispNeoFiyat = !empty($_POST['isp_neo_fiyat']) ? (float)$_POST['isp_neo_fiyat'] : null;\r\n+                $ispUyduFiyat = !empty($_POST['isp_uydu_fiyat']) ? (float)$_POST['isp_uydu_fiyat'] : null;\r\n+                $neoFiyat = !empty($_POST['neo_fiyat']) ? (float)$_POST['neo_fiyat'] : null;\r\n+                $uyduFiyat = !empty($_POST['uydu_fiyat']) ? (float)$_POST['uydu_fiyat'] : null;\r\n+                $baslangicTarihi = $_POST['hakedis_baslangic_tarihi'];\r\n+                $bitisTarihi = $_POST['hakedis_bitis_tarihi'];\r\n+                $aciklama = trim($_POST['aciklama'] ?? '');\r\n+                \r\n+                // Açıklama uzunluk kontrolü\r\n+                if (strlen($aciklama) > 200) {\r\n+                    $message = 'Açıklama metni 200 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n+                    $messageType = 'danger';\r\n+                } \r\n+                // Tarih kontrolü\r\n+                elseif (strtotime($baslangicTarihi) >= strtotime($bitisTarihi)) {\r\n+                    $message = 'Başlangıç tarihi, bitiş tarihinden önce olmalıdır.';\r\n+                    $messageType = 'danger';\r\n+                } else {\r\n+                    $sql = \"UPDATE hakedis_tanim SET bayi_id = ?, isp_neo_fiyat = ?, isp_uydu_fiyat = ?, neo_fiyat = ?, uydu_fiyat = ?, hakedis_baslangic_tarihi = ?, hakedis_bitis_tarihi = ?, aciklama = ? WHERE id = ?\";\r\n+                    $stmt = $conn->prepare($sql);\r\n+                    $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $baslangicTarihi, $bitisTarihi, $aciklama, $id]);\r\n+                    \r\n+                    $message = 'Hakediş tanımı başarıyla güncellendi.';\r\n+                    $messageType = 'success';\r\n+                }\r\n+                break;\r\n+                \r\n             case 'delete':\r\n                 $id = (int)$_POST['id'];\r\n                 \r\n                 $sql = \"DELETE FROM hakedis_tanim WHERE id = ?\";\r\n@@ -203,12 +263,18 @@\n                                             ?>\r\n                                         </span>\r\n                                     </td>\r\n                                     <td>\r\n-                                        <button type=\"button\" class=\"btn btn-sm btn-outline-danger\" \r\n-                                                onclick=\"deleteHakedis(<?php echo $hakedis['id']; ?>, '<?php echo htmlspecialchars($hakedis['first_name'] . ' ' . $hakedis['last_name']); ?>')\">\r\n-                                            <i class=\"fas fa-trash\"></i>\r\n-                                        </button>\r\n+                                        <div class=\"btn-group\" role=\"group\">\r\n+                                            <button type=\"button\" class=\"btn btn-sm btn-outline-primary\" \r\n+                                                    onclick=\"editHakedis(<?php echo htmlspecialchars(json_encode($hakedis)); ?>)\">\r\n+                                                <i class=\"fas fa-edit\"></i>\r\n+                                            </button>\r\n+                                            <button type=\"button\" class=\"btn btn-sm btn-outline-danger\" \r\n+                                                    onclick=\"deleteHakedis(<?php echo $hakedis['id']; ?>, '<?php echo htmlspecialchars($hakedis['first_name'] . ' ' . $hakedis['last_name']); ?>')\">\r\n+                                                <i class=\"fas fa-trash\"></i>\r\n+                                            </button>\r\n+                                        </div>\r\n                                     </td>\r\n                                 </tr>\r\n                             <?php endforeach; ?>\r\n                         <?php else: ?>\r\n@@ -226,17 +292,18 @@\n         </div>\r\n     </div>\r\n </div>\r\n \r\n-<!-- Yeni Hakediş Tanımı Modal -->\r\n+<!-- Hakediş Tanımı Modal (Ekleme/Düzenleme) -->\r\n <div class=\"modal fade\" id=\"addHakedisModal\" tabindex=\"-1\">\r\n     <div class=\"modal-dialog modal-lg\">\r\n         <div class=\"modal-content\">\r\n             <form method=\"POST\" action=\"\">\r\n-                <input type=\"hidden\" name=\"action\" value=\"add\">\r\n+                <input type=\"hidden\" name=\"action\" id=\"modal_action\" value=\"add\">\r\n+                <input type=\"hidden\" name=\"id\" id=\"modal_id\">\r\n                 <div class=\"modal-header\">\r\n-                    <h5 class=\"modal-title\">\r\n-                        <i class=\"fas fa-plus me-2\"></i>Yeni Hakediş Tanımı\r\n+                    <h5 class=\"modal-title\" id=\"modal_title\">\r\n+                        <i class=\"fas fa-plus me-2\" id=\"modal_icon\"></i><span id=\"modal_title_text\">Yeni Hakediş Tanımı</span>\r\n                     </h5>\r\n                     <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                 </div>\r\n                 <div class=\"modal-body\">\r\n@@ -309,18 +376,61 @@\n                     </div>\r\n                 </div>\r\n                 <div class=\"modal-footer\">\r\n                     <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n-                    <button type=\"submit\" class=\"btn btn-primary\">\r\n-                        <i class=\"fas fa-save me-1\"></i>Kaydet\r\n+                    <button type=\"submit\" class=\"btn btn-primary\" id=\"modal_submit_btn\">\r\n+                        <i class=\"fas fa-save me-1\"></i><span id=\"modal_submit_text\">Kaydet</span>\r\n                     </button>\r\n                 </div>\r\n             </form>\r\n         </div>\r\n     </div>\r\n </div>\r\n \r\n <script>\r\n+// Modal temizleme fonksiyonu\r\n+function clearModal() {\r\n+    document.getElementById('modal_action').value = 'add';\r\n+    document.getElementById('modal_id').value = '';\r\n+    document.getElementById('modal_title_text').textContent = 'Yeni Hakediş Tanımı';\r\n+    document.getElementById('modal_icon').className = 'fas fa-plus me-2';\r\n+    document.getElementById('modal_submit_text').textContent = 'Kaydet';\r\n+    \r\n+    // Formu temizle\r\n+    document.getElementById('bayi_id').value = '';\r\n+    document.getElementById('isp_neo_fiyat').value = '';\r\n+    document.getElementById('isp_uydu_fiyat').value = '';\r\n+    document.getElementById('neo_fiyat').value = '';\r\n+    document.getElementById('uydu_fiyat').value = '';\r\n+    document.getElementById('hakedis_baslangic_tarihi').value = '';\r\n+    document.getElementById('hakedis_bitis_tarihi').value = '';\r\n+    document.getElementById('aciklama').value = '';\r\n+}\r\n+\r\n+// Düzenleme fonksiyonu\r\n+function editHakedis(hakedis) {\r\n+    // Modal başlığını güncelle\r\n+    document.getElementById('modal_action').value = 'edit';\r\n+    document.getElementById('modal_id').value = hakedis.id;\r\n+    document.getElementById('modal_title_text').textContent = 'Hakediş Tanımını Düzenle';\r\n+    document.getElementById('modal_icon').className = 'fas fa-edit me-2';\r\n+    document.getElementById('modal_submit_text').textContent = 'Güncelle';\r\n+    \r\n+    // Modal alanlarını doldur\r\n+    document.getElementById('bayi_id').value = hakedis.bayi_id;\r\n+    document.getElementById('isp_neo_fiyat').value = hakedis.isp_neo_fiyat || '';\r\n+    document.getElementById('isp_uydu_fiyat').value = hakedis.isp_uydu_fiyat || '';\r\n+    document.getElementById('neo_fiyat').value = hakedis.neo_fiyat || '';\r\n+    document.getElementById('uydu_fiyat').value = hakedis.uydu_fiyat || '';\r\n+    document.getElementById('hakedis_baslangic_tarihi').value = hakedis.hakedis_baslangic_tarihi;\r\n+    document.getElementById('hakedis_bitis_tarihi').value = hakedis.hakedis_bitis_tarihi;\r\n+    document.getElementById('aciklama').value = hakedis.aciklama || '';\r\n+    \r\n+    // Modalı aç\r\n+    var modal = new bootstrap.Modal(document.getElementById('addHakedisModal'));\r\n+    modal.show();\r\n+}\r\n+\r\n function deleteHakedis(hakedisId, bayiName) {\r\n     if (confirm(bayiName + ' için hakediş tanımını silmek istediğinizden emin misiniz?\\n\\nBu işlem geri alınamaz.')) {\r\n         const form = document.createElement('form');\r\n         form.method = 'POST';\r\n@@ -331,7 +441,15 @@\n         document.body.appendChild(form);\r\n         form.submit();\r\n     }\r\n }\r\n+\r\n+// Modal açıldığında temizle (Yeni butonuna basıldığında)\r\n+document.getElementById('addHakedisModal').addEventListener('show.bs.modal', function(event) {\r\n+    // Eğer modal düzenleme için açılmıyorsa temizle\r\n+    if (event.relatedTarget && event.relatedTarget.getAttribute('data-bs-target') === '#addHakedisModal') {\r\n+        clearModal();\r\n+    }\r\n+});\r\n </script>\r\n \r\n <?php include 'includes/footer.php'; ?>\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759418386909,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -24,29 +24,43 @@\n                 $ispNeoFiyat = !empty($_POST['isp_neo_fiyat']) ? (float)$_POST['isp_neo_fiyat'] : null;\r\n                 $ispUyduFiyat = !empty($_POST['isp_uydu_fiyat']) ? (float)$_POST['isp_uydu_fiyat'] : null;\r\n                 $neoFiyat = !empty($_POST['neo_fiyat']) ? (float)$_POST['neo_fiyat'] : null;\r\n                 $uyduFiyat = !empty($_POST['uydu_fiyat']) ? (float)$_POST['uydu_fiyat'] : null;\r\n-                $baslangicTarihi = $_POST['hakedis_baslangic_tarihi'];\r\n-                $bitisTarihi = $_POST['hakedis_bitis_tarihi'];\r\n+                $donemIds = $_POST['bayi_hakedis_prim_donem_id'] ?? [];\r\n                 $aciklama = trim($_POST['aciklama'] ?? '');\r\n                 \r\n                 // Açıklama uzunluk kontrolü\r\n                 if (strlen($aciklama) > 200) {\r\n                     $message = 'Açıklama metni 200 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n                     $messageType = 'danger';\r\n                 } \r\n-                // Tarih kontrolü\r\n-                elseif (strtotime($baslangicTarihi) >= strtotime($bitisTarihi)) {\r\n-                    $message = 'Başlangıç tarihi, bitiş tarihinden önce olmalıdır.';\r\n+                // Dönem seçimi kontrolü\r\n+                elseif (empty($donemIds)) {\r\n+                    $message = 'En az bir dönem seçmelisiniz.';\r\n                     $messageType = 'danger';\r\n                 } else {\r\n-                    $sql = \"INSERT INTO hakedis_tanim (bayi_id, isp_neo_fiyat, isp_uydu_fiyat, neo_fiyat, uydu_fiyat, hakedis_baslangic_tarihi, hakedis_bitis_tarihi, aciklama) \r\n-                            VALUES (?, ?, ?, ?, ?, ?, ?, ?)\";\r\n-                    $stmt = $conn->prepare($sql);\r\n-                    $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $baslangicTarihi, $bitisTarihi, $aciklama]);\r\n+                    // Her dönem için ayrı kayıt ekle\r\n+                    $conn->beginTransaction();\r\n+                    $successCount = 0;\r\n                     \r\n-                    $message = 'Hakediş tanımı başarıyla eklendi.';\r\n-                    $messageType = 'success';\r\n+                    try {\r\n+                        $sql = \"INSERT INTO hakedis_tanim (bayi_id, isp_neo_fiyat, isp_uydu_fiyat, neo_fiyat, uydu_fiyat, bayi_hakedis_prim_donem_id, aciklama) \r\n+                                VALUES (?, ?, ?, ?, ?, ?, ?)\";\r\n+                        $stmt = $conn->prepare($sql);\r\n+                        \r\n+                        foreach ($donemIds as $donemId) {\r\n+                            $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, (int)$donemId, $aciklama]);\r\n+                            $successCount++;\r\n+                        }\r\n+                        \r\n+                        $conn->commit();\r\n+                        $message = $successCount . ' adet hakediş tanımı başarıyla eklendi.';\r\n+                        $messageType = 'success';\r\n+                    } catch (Exception $e) {\r\n+                        $conn->rollBack();\r\n+                        $message = 'Hata: ' . $e->getMessage();\r\n+                        $messageType = 'danger';\r\n+                    }\r\n                 }\r\n                 break;\r\n                 \r\n             case 'edit':\r\n@@ -127,11 +141,13 @@\n }\r\n \r\n // Bayileri al\r\n $bayiler = [];\r\n+$donemler = [];\r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n+    // Bayiler\r\n     $bayiGroupSql = \"SELECT id FROM user_groups WHERE group_name IN ('bayi', 'Bayi')\";\r\n     $bayiGroupStmt = $conn->prepare($bayiGroupSql);\r\n     $bayiGroupStmt->execute();\r\n     $bayiGroups = $bayiGroupStmt->fetchAll(PDO::FETCH_COLUMN);\r\n@@ -146,8 +162,15 @@\n         $bayiStmt = $conn->prepare($bayiSql);\r\n         $bayiStmt->execute($bayiGroups);\r\n         $bayiler = $bayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n     }\r\n+    \r\n+    // Dönemleri al\r\n+    $donemSql = \"SELECT id, donem_adi FROM bayi_hakedis_prim_donem WHERE durum = 'AKTIF' ORDER BY id DESC\";\r\n+    $donemStmt = $conn->prepare($donemSql);\r\n+    $donemStmt->execute();\r\n+    $donemler = $donemStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+    \r\n } catch (Exception $e) {\r\n     // Hata durumunda boş array kalacak\r\n }\r\n \r\n@@ -155,11 +178,12 @@\n $hakedisler = [];\r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n-    $sql = \"SELECT ht.*, u.first_name, u.last_name, u.email\r\n+    $sql = \"SELECT ht.*, u.first_name, u.last_name, u.email, bhpd.donem_adi\r\n             FROM hakedis_tanim ht\r\n             INNER JOIN users u ON ht.bayi_id = u.id\r\n+            LEFT JOIN bayi_hakedis_prim_donem bhpd ON ht.bayi_hakedis_prim_donem_id = bhpd.id\r\n             ORDER BY ht.created_at DESC\";\r\n     \r\n     $stmt = $conn->prepare($sql);\r\n     $stmt->execute();\r\n@@ -217,10 +241,9 @@\n                             <th>ISP Neo Fiyat</th>\r\n                             <th>ISP Uydu Fiyat</th>\r\n                             <th>Neo Fiyat</th>\r\n                             <th>Uydu Fiyat</th>\r\n-                            <th>Başlangıç Tarihi</th>\r\n-                            <th>Bitiş Tarihi</th>\r\n+                            <th>Dönem</th>\r\n                             <th>Açıklama</th>\r\n                             <th>İşlemler</th>\r\n                         </tr>\r\n                     </thead>\r\n@@ -245,14 +268,13 @@\n                                     <td>\r\n                                         <?php echo $hakedis['uydu_fiyat'] ? number_format($hakedis['uydu_fiyat'], 2) . ' ₺' : '-'; ?>\r\n                                     </td>\r\n                                     <td>\r\n-                                        <?php echo date('d.m.Y', strtotime($hakedis['hakedis_baslangic_tarihi'])); ?>\r\n+                                        <span class=\"badge bg-info\">\r\n+                                            <?php echo htmlspecialchars($hakedis['donem_adi'] ?? 'Dönem Tanımlanmamış'); ?>\r\n+                                        </span>\r\n                                     </td>\r\n                                     <td>\r\n-                                        <?php echo date('d.m.Y', strtotime($hakedis['hakedis_bitis_tarihi'])); ?>\r\n-                                    </td>\r\n-                                    <td>\r\n                                         <span class=\"text-muted\" title=\"<?php echo htmlspecialchars($hakedis['aciklama'] ?? ''); ?>\">\r\n                                             <?php \r\n                                             $aciklama = $hakedis['aciklama'] ?? '';\r\n                                             if (strlen($aciklama) > 30) {\r\n@@ -278,9 +300,9 @@\n                                 </tr>\r\n                             <?php endforeach; ?>\r\n                         <?php else: ?>\r\n                             <tr>\r\n-                                <td colspan=\"10\" class=\"text-center py-5 text-muted\">\r\n+                                <td colspan=\"9\" class=\"text-center py-5 text-muted\">\r\n                                     <i class=\"fas fa-calculator fa-3x mb-3 d-block\"></i>\r\n                                     <h5>Henüz hakediş tanımı bulunmuyor</h5>\r\n                                     <p>İlk hakediş tanımını eklemek için \"Yeni Hakediş Tanımı\" butonuna tıklayın.</p>\r\n                                 </td>\r\n@@ -356,17 +378,21 @@\n                             </div>\r\n                         </div>\r\n                     </div>\r\n                     \r\n-                    <div class=\"row\">\r\n-                        <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"hakedis_baslangic_tarihi\" class=\"form-label\">Hakediş Başlangıç Tarihi <span class=\"text-danger\">*</span></label>\r\n-                            <input type=\"date\" class=\"form-control\" id=\"hakedis_baslangic_tarihi\" name=\"hakedis_baslangic_tarihi\" required>\r\n+                    <div class=\"mb-3\">\r\n+                        <label for=\"bayi_hakedis_prim_donem_id\" class=\"form-label\">Dönem Seçimi <span class=\"text-danger\">*</span></label>\r\n+                        <select class=\"form-select\" id=\"bayi_hakedis_prim_donem_id\" name=\"bayi_hakedis_prim_donem_id[]\" multiple size=\"5\" required>\r\n+                            <?php foreach ($donemler as $donem): ?>\r\n+                                <option value=\"<?php echo $donem['id']; ?>\">\r\n+                                    <?php echo htmlspecialchars($donem['donem_adi']); ?>\r\n+                                </option>\r\n+                            <?php endforeach; ?>\r\n+                        </select>\r\n+                        <div class=\"form-text\">\r\n+                            <i class=\"fas fa-info-circle me-1\"></i>\r\n+                            Birden fazla dönem seçmek için Ctrl+Click kullanın. Düzenlemede tek dönem seçebilirsiniz.\r\n                         </div>\r\n-                        <div class=\"col-md-6 mb-3\">\r\n-                            <label for=\"hakedis_bitis_tarihi\" class=\"form-label\">Hakediş Bitiş Tarihi <span class=\"text-danger\">*</span></label>\r\n-                            <input type=\"date\" class=\"form-control\" id=\"hakedis_bitis_tarihi\" name=\"hakedis_bitis_tarihi\" required>\r\n-                        </div>\r\n                     </div>\r\n                     \r\n                     <div class=\"mb-3\">\r\n                         <label for=\"aciklama\" class=\"form-label\">Açıklama</label>\r\n@@ -400,11 +426,17 @@\n     document.getElementById('isp_neo_fiyat').value = '';\r\n     document.getElementById('isp_uydu_fiyat').value = '';\r\n     document.getElementById('neo_fiyat').value = '';\r\n     document.getElementById('uydu_fiyat').value = '';\r\n-    document.getElementById('hakedis_baslangic_tarihi').value = '';\r\n-    document.getElementById('hakedis_bitis_tarihi').value = '';\r\n     document.getElementById('aciklama').value = '';\r\n+    \r\n+    // Dönem seçimini temizle ve çoklu seçimi aktif et\r\n+    const donemSelect = document.getElementById('bayi_hakedis_prim_donem_id');\r\n+    donemSelect.multiple = true;\r\n+    donemSelect.size = 5;\r\n+    for (let option of donemSelect.options) {\r\n+        option.selected = false;\r\n+    }\r\n }\r\n \r\n // Düzenleme fonksiyonu\r\n function editHakedis(hakedis) {\r\n@@ -420,12 +452,16 @@\n     document.getElementById('isp_neo_fiyat').value = hakedis.isp_neo_fiyat || '';\r\n     document.getElementById('isp_uydu_fiyat').value = hakedis.isp_uydu_fiyat || '';\r\n     document.getElementById('neo_fiyat').value = hakedis.neo_fiyat || '';\r\n     document.getElementById('uydu_fiyat').value = hakedis.uydu_fiyat || '';\r\n-    document.getElementById('hakedis_baslangic_tarihi').value = hakedis.hakedis_baslangic_tarihi;\r\n-    document.getElementById('hakedis_bitis_tarihi').value = hakedis.hakedis_bitis_tarihi;\r\n     document.getElementById('aciklama').value = hakedis.aciklama || '';\r\n     \r\n+    // Dönem seçimini tek seçim yap ve mevcut dönemi seç\r\n+    const donemSelect = document.getElementById('bayi_hakedis_prim_donem_id');\r\n+    donemSelect.multiple = false;\r\n+    donemSelect.size = 1;\r\n+    donemSelect.value = hakedis.bayi_hakedis_prim_donem_id || '';\r\n+    \r\n     // Modalı aç\r\n     var modal = new bootstrap.Modal(document.getElementById('addHakedisModal'));\r\n     modal.show();\r\n }\r\n"
                },
                {
                    "date": 1759419354074,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -27,8 +27,12 @@\n                 $uyduFiyat = !empty($_POST['uydu_fiyat']) ? (float)$_POST['uydu_fiyat'] : null;\r\n                 $donemIds = $_POST['bayi_hakedis_prim_donem_id'] ?? [];\r\n                 $aciklama = trim($_POST['aciklama'] ?? '');\r\n                 \r\n+                // Debug için log\r\n+                error_log(\"ADD - Gelen dönem IDs: \" . print_r($donemIds, true));\r\n+                error_log(\"ADD - POST data: \" . print_r($_POST, true));\r\n+                \r\n                 // Açıklama uzunluk kontrolü\r\n                 if (strlen($aciklama) > 200) {\r\n                     $message = 'Açıklama metni 200 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n                     $messageType = 'danger';\r\n@@ -69,55 +73,30 @@\n                 $ispNeoFiyat = !empty($_POST['isp_neo_fiyat']) ? (float)$_POST['isp_neo_fiyat'] : null;\r\n                 $ispUyduFiyat = !empty($_POST['isp_uydu_fiyat']) ? (float)$_POST['isp_uydu_fiyat'] : null;\r\n                 $neoFiyat = !empty($_POST['neo_fiyat']) ? (float)$_POST['neo_fiyat'] : null;\r\n                 $uyduFiyat = !empty($_POST['uydu_fiyat']) ? (float)$_POST['uydu_fiyat'] : null;\r\n-                $baslangicTarihi = $_POST['hakedis_baslangic_tarihi'];\r\n-                $bitisTarihi = $_POST['hakedis_bitis_tarihi'];\r\n+                $donemIds = $_POST['bayi_hakedis_prim_donem_id'] ?? [];\r\n                 $aciklama = trim($_POST['aciklama'] ?? '');\r\n                 \r\n-                // Açıklama uzunluk kontrolü\r\n-                if (strlen($aciklama) > 200) {\r\n-                    $message = 'Açıklama metni 200 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n-                    $messageType = 'danger';\r\n-                } \r\n-                // Tarih kontrolü\r\n-                elseif (strtotime($baslangicTarihi) >= strtotime($bitisTarihi)) {\r\n-                    $message = 'Başlangıç tarihi, bitiş tarihinden önce olmalıdır.';\r\n-                    $messageType = 'danger';\r\n-                } else {\r\n-                    $sql = \"UPDATE hakedis_tanim SET bayi_id = ?, isp_neo_fiyat = ?, isp_uydu_fiyat = ?, neo_fiyat = ?, uydu_fiyat = ?, hakedis_baslangic_tarihi = ?, hakedis_bitis_tarihi = ?, aciklama = ? WHERE id = ?\";\r\n-                    $stmt = $conn->prepare($sql);\r\n-                    $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $baslangicTarihi, $bitisTarihi, $aciklama, $id]);\r\n-                    \r\n-                    $message = 'Hakediş tanımı başarıyla güncellendi.';\r\n-                    $messageType = 'success';\r\n-                }\r\n-                break;\r\n+                // Debug için log\r\n+                error_log(\"EDIT CASE 1 - POST data: \" . print_r($_POST, true));\r\n+                error_log(\"EDIT CASE 1 - Dönem IDs: \" . print_r($donemIds, true));\r\n                 \r\n-            case 'edit':\r\n-                $id = (int)$_POST['id'];\r\n-                $bayiId = (int)$_POST['bayi_id'];\r\n-                $ispNeoFiyat = !empty($_POST['isp_neo_fiyat']) ? (float)$_POST['isp_neo_fiyat'] : null;\r\n-                $ispUyduFiyat = !empty($_POST['isp_uydu_fiyat']) ? (float)$_POST['isp_uydu_fiyat'] : null;\r\n-                $neoFiyat = !empty($_POST['neo_fiyat']) ? (float)$_POST['neo_fiyat'] : null;\r\n-                $uyduFiyat = !empty($_POST['uydu_fiyat']) ? (float)$_POST['uydu_fiyat'] : null;\r\n-                $baslangicTarihi = $_POST['hakedis_baslangic_tarihi'];\r\n-                $bitisTarihi = $_POST['hakedis_bitis_tarihi'];\r\n-                $aciklama = trim($_POST['aciklama'] ?? '');\r\n-                \r\n                 // Açıklama uzunluk kontrolü\r\n                 if (strlen($aciklama) > 200) {\r\n                     $message = 'Açıklama metni 200 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n                     $messageType = 'danger';\r\n                 } \r\n-                // Tarih kontrolü\r\n-                elseif (strtotime($baslangicTarihi) >= strtotime($bitisTarihi)) {\r\n-                    $message = 'Başlangıç tarihi, bitiş tarihinden önce olmalıdır.';\r\n+                // Dönem seçimi kontrolü\r\n+                elseif (empty($donemIds)) {\r\n+                    $message = 'En az bir dönem seçmelisiniz. (Case 1)';\r\n                     $messageType = 'danger';\r\n                 } else {\r\n-                    $sql = \"UPDATE hakedis_tanim SET bayi_id = ?, isp_neo_fiyat = ?, isp_uydu_fiyat = ?, neo_fiyat = ?, uydu_fiyat = ?, hakedis_baslangic_tarihi = ?, hakedis_bitis_tarihi = ?, aciklama = ? WHERE id = ?\";\r\n+                    // İlk seçilen dönemi kullan\r\n+                    $donemId = (int)$donemIds[0];\r\n+                    $sql = \"UPDATE hakedis_tanim SET bayi_id = ?, isp_neo_fiyat = ?, isp_uydu_fiyat = ?, neo_fiyat = ?, uydu_fiyat = ?, bayi_hakedis_prim_donem_id = ?, aciklama = ? WHERE id = ?\";\r\n                     $stmt = $conn->prepare($sql);\r\n-                    $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $baslangicTarihi, $bitisTarihi, $aciklama, $id]);\r\n+                    $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $donemId, $aciklama, $id]);\r\n                     \r\n                     $message = 'Hakediş tanımı başarıyla güncellendi.';\r\n                     $messageType = 'success';\r\n                 }\r\n@@ -380,19 +359,29 @@\n                     </div>\r\n                     \r\n                     <div class=\"mb-3\">\r\n                         <label for=\"bayi_hakedis_prim_donem_id\" class=\"form-label\">Dönem Seçimi <span class=\"text-danger\">*</span></label>\r\n-                        <select class=\"form-select\" id=\"bayi_hakedis_prim_donem_id\" name=\"bayi_hakedis_prim_donem_id[]\" multiple size=\"5\" required>\r\n+                        <div class=\"border rounded p-2\" style=\"max-height: 200px; overflow-y: auto;\">\r\n                             <?php foreach ($donemler as $donem): ?>\r\n-                                <option value=\"<?php echo $donem['id']; ?>\">\r\n-                                    <?php echo htmlspecialchars($donem['donem_adi']); ?>\r\n-                                </option>\r\n+                                <div class=\"form-check\">\r\n+                                    <input class=\"form-check-input donem-checkbox\" type=\"checkbox\" \r\n+                                           name=\"bayi_hakedis_prim_donem_id[]\" \r\n+                                           value=\"<?php echo $donem['id']; ?>\" \r\n+                                           id=\"donem_<?php echo $donem['id']; ?>\">\r\n+                                    <label class=\"form-check-label\" for=\"donem_<?php echo $donem['id']; ?>\">\r\n+                                        <?php echo htmlspecialchars($donem['donem_adi']); ?>\r\n+                                    </label>\r\n+                                </div>\r\n                             <?php endforeach; ?>\r\n-                        </select>\r\n+                        </div>\r\n                         <div class=\"form-text\">\r\n                             <i class=\"fas fa-info-circle me-1\"></i>\r\n-                            Birden fazla dönem seçmek için Ctrl+Click kullanın. Düzenlemede tek dönem seçebilirsiniz.\r\n+                            Birden fazla dönem seçebilirsiniz. En az bir dönem seçimi gereklidir.\r\n                         </div>\r\n+                        <div class=\"mt-2\">\r\n+                            <button type=\"button\" class=\"btn btn-sm btn-outline-primary\" onclick=\"selectAllPeriods()\">Tümünü Seç</button>\r\n+                            <button type=\"button\" class=\"btn btn-sm btn-outline-secondary\" onclick=\"clearAllPeriods()\">Tümünü Temizle</button>\r\n+                        </div>\r\n                     </div>\r\n                     \r\n                     <div class=\"mb-3\">\r\n                         <label for=\"aciklama\" class=\"form-label\">Açıklama</label>\r\n@@ -402,9 +391,9 @@\n                     </div>\r\n                 </div>\r\n                 <div class=\"modal-footer\">\r\n                     <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n-                    <button type=\"submit\" class=\"btn btn-primary\" id=\"modal_submit_btn\">\r\n+                    <button type=\"submit\" class=\"btn btn-primary\" id=\"modal_submit_btn\" onclick=\"return validateForm()\">\r\n                         <i class=\"fas fa-save me-1\"></i><span id=\"modal_submit_text\">Kaydet</span>\r\n                     </button>\r\n                 </div>\r\n             </form>\r\n@@ -412,8 +401,36 @@\n     </div>\r\n </div>\r\n \r\n <script>\r\n+// Form validation fonksiyonu\r\n+function validateForm() {\r\n+    // Bayi seçimi kontrolü\r\n+    const bayiId = document.getElementById('bayi_id').value;\r\n+    if (!bayiId) {\r\n+        alert('Lütfen bir bayi seçin.');\r\n+        return false;\r\n+    }\r\n+    \r\n+    // Dönem seçimi kontrolü\r\n+    const checkedDonems = document.querySelectorAll('.donem-checkbox:checked');\r\n+    console.log('Seçili dönem sayısı:', checkedDonems.length);\r\n+    console.log('Modal action:', document.getElementById('modal_action').value);\r\n+    \r\n+    if (checkedDonems.length === 0) {\r\n+        alert('Lütfen en az bir dönem seçin.');\r\n+        console.log('Hata: Hiç dönem seçili değil');\r\n+        return false;\r\n+    }\r\n+    \r\n+    // Debug: Seçili dönemleri göster\r\n+    checkedDonems.forEach(checkbox => {\r\n+        console.log('Seçili dönem ID:', checkbox.value, 'Name:', checkbox.name);\r\n+    });\r\n+    \r\n+    return true;\r\n+}\r\n+\r\n // Modal temizleme fonksiyonu\r\n function clearModal() {\r\n     document.getElementById('modal_action').value = 'add';\r\n     document.getElementById('modal_id').value = '';\r\n@@ -428,19 +445,27 @@\n     document.getElementById('neo_fiyat').value = '';\r\n     document.getElementById('uydu_fiyat').value = '';\r\n     document.getElementById('aciklama').value = '';\r\n     \r\n-    // Dönem seçimini temizle ve çoklu seçimi aktif et\r\n-    const donemSelect = document.getElementById('bayi_hakedis_prim_donem_id');\r\n-    donemSelect.multiple = true;\r\n-    donemSelect.size = 5;\r\n-    for (let option of donemSelect.options) {\r\n-        option.selected = false;\r\n-    }\r\n+    // Dönem checkbox'larını temizle\r\n+    clearAllPeriods();\r\n }\r\n \r\n+// Dönem seçim fonksiyonları\r\n+function selectAllPeriods() {\r\n+    const checkboxes = document.querySelectorAll('.donem-checkbox');\r\n+    checkboxes.forEach(checkbox => checkbox.checked = true);\r\n+}\r\n+\r\n+function clearAllPeriods() {\r\n+    const checkboxes = document.querySelectorAll('.donem-checkbox');\r\n+    checkboxes.forEach(checkbox => checkbox.checked = false);\r\n+}\r\n+\r\n // Düzenleme fonksiyonu\r\n function editHakedis(hakedis) {\r\n+    console.log('Edit başlatıldı, hakedis data:', hakedis);\r\n+    \r\n     // Modal başlığını güncelle\r\n     document.getElementById('modal_action').value = 'edit';\r\n     document.getElementById('modal_id').value = hakedis.id;\r\n     document.getElementById('modal_title_text').textContent = 'Hakediş Tanımını Düzenle';\r\n@@ -454,17 +479,34 @@\n     document.getElementById('neo_fiyat').value = hakedis.neo_fiyat || '';\r\n     document.getElementById('uydu_fiyat').value = hakedis.uydu_fiyat || '';\r\n     document.getElementById('aciklama').value = hakedis.aciklama || '';\r\n     \r\n-    // Dönem seçimini tek seçim yap ve mevcut dönemi seç\r\n-    const donemSelect = document.getElementById('bayi_hakedis_prim_donem_id');\r\n-    donemSelect.multiple = false;\r\n-    donemSelect.size = 1;\r\n-    donemSelect.value = hakedis.bayi_hakedis_prim_donem_id || '';\r\n+    // Önce tüm checkbox'ları temizle\r\n+    clearAllPeriods();\r\n     \r\n-    // Modalı aç\r\n-    var modal = new bootstrap.Modal(document.getElementById('addHakedisModal'));\r\n-    modal.show();\r\n+    // Mevcut dönemi seç\r\n+    console.log('Seçilecek dönem ID:', hakedis.bayi_hakedis_prim_donem_id);\r\n+    if (hakedis.bayi_hakedis_prim_donem_id) {\r\n+        const checkbox = document.getElementById('donem_' + hakedis.bayi_hakedis_prim_donem_id);\r\n+        if (checkbox) {\r\n+            checkbox.checked = true;\r\n+            console.log('Dönem seçildi:', checkbox.value);\r\n+        } else {\r\n+            console.log('Checkbox bulunamadı: donem_' + hakedis.bayi_hakedis_prim_donem_id);\r\n+        }\r\n+    }\r\n+    \r\n+    // Modal açılmadan önce kısa bir bekle\r\n+    setTimeout(() => {\r\n+        var modal = new bootstrap.Modal(document.getElementById('addHakedisModal'));\r\n+        modal.show();\r\n+        \r\n+        // Modal açıldıktan sonra seçili dönemleri kontrol et\r\n+        setTimeout(() => {\r\n+            const checkedAfterOpen = document.querySelectorAll('.donem-checkbox:checked');\r\n+            console.log('Modal açıldıktan sonra seçili dönem sayısı:', checkedAfterOpen.length);\r\n+        }, 500);\r\n+    }, 100);\r\n }\r\n \r\n function deleteHakedis(hakedisId, bayiName) {\r\n     if (confirm(bayiName + ' için hakediş tanımını silmek istediğinizden emin misiniz?\\n\\nBu işlem geri alınamaz.')) {\r\n@@ -485,7 +527,51 @@\n     if (event.relatedTarget && event.relatedTarget.getAttribute('data-bs-target') === '#addHakedisModal') {\r\n         clearModal();\r\n     }\r\n });\r\n+\r\n+// Form submit olayını dinle\r\n+document.addEventListener('DOMContentLoaded', function() {\r\n+    const form = document.querySelector('#addHakedisModal form');\r\n+    if (form) {\r\n+        form.addEventListener('submit', function(e) {\r\n+            console.log('Form submit edildi');\r\n+            const checkedDonems = document.querySelectorAll('.donem-checkbox:checked');\r\n+            console.log('Submit sırasında seçili dönem sayısı:', checkedDonems.length);\r\n+            \r\n+            if (checkedDonems.length === 0) {\r\n+                console.log('Hiç dönem seçili değil, form submit engellendi');\r\n+                e.preventDefault();\r\n+                alert('Lütfen en az bir dönem seçin.');\r\n+                return false;\r\n+            }\r\n+            \r\n+            // Seçili dönemleri listele\r\n+            checkedDonems.forEach((checkbox, index) => {\r\n+                console.log(`Seçili dönem ${index + 1}: ID=${checkbox.value}, Name=${checkbox.name}`);\r\n+            });\r\n+        });\r\n+    }\r\n+});\r\n </script>\r\n \r\n+<style>\r\n+.donem-checkbox:checked + .form-check-label {\r\n+    font-weight: bold;\r\n+    color: #0d6efd;\r\n+}\r\n+\r\n+.form-check {\r\n+    padding: 0.25rem 0;\r\n+}\r\n+\r\n+.form-check:hover {\r\n+    background-color: #f8f9fa;\r\n+    border-radius: 0.25rem;\r\n+}\r\n+\r\n+.border.rounded {\r\n+    border-color: #dee2e6 !important;\r\n+}\r\n+</style>\r\n+\r\n <?php include 'includes/footer.php'; ?>\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759473163693,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -90,15 +90,16 @@\n                 elseif (empty($donemIds)) {\r\n                     $message = 'En az bir dönem seçmelisiniz. (Case 1)';\r\n                     $messageType = 'danger';\r\n                 } else {\r\n-                    // İlk seçilen dönemi kullan\r\n-                    $donemId = (int)$donemIds[0];\r\n+                    // Dönem IDs'leri virgülle ayrılmış string olarak güncelle\r\n+                    $donemIdsString = implode(',', array_map('intval', $donemIds));\r\n+                    \r\n                     $sql = \"UPDATE hakedis_tanim SET bayi_id = ?, isp_neo_fiyat = ?, isp_uydu_fiyat = ?, neo_fiyat = ?, uydu_fiyat = ?, bayi_hakedis_prim_donem_id = ?, aciklama = ? WHERE id = ?\";\r\n                     $stmt = $conn->prepare($sql);\r\n-                    $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $donemId, $aciklama, $id]);\r\n+                    $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $donemIdsString, $aciklama, $id]);\r\n                     \r\n-                    $message = 'Hakediş tanımı başarıyla güncellendi.';\r\n+                    $message = 'Hakediş tanımı başarıyla güncellendi. Dönemler: ' . $donemIdsString;\r\n                     $messageType = 'success';\r\n                 }\r\n                 break;\r\n                 \r\n@@ -157,18 +158,37 @@\n $hakedisler = [];\r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n-    $sql = \"SELECT ht.*, u.first_name, u.last_name, u.email, bhpd.donem_adi\r\n+    $sql = \"SELECT ht.*, u.first_name, u.last_name, u.email\r\n             FROM hakedis_tanim ht\r\n             INNER JOIN users u ON ht.bayi_id = u.id\r\n-            LEFT JOIN bayi_hakedis_prim_donem bhpd ON ht.bayi_hakedis_prim_donem_id = bhpd.id\r\n             ORDER BY ht.created_at DESC\";\r\n     \r\n     $stmt = $conn->prepare($sql);\r\n     $stmt->execute();\r\n     $hakedisler = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n     \r\n+    // Her hakediş için dönem isimlerini al\r\n+    foreach ($hakedisler as &$hakedis) {\r\n+        if (!empty($hakedis['bayi_hakedis_prim_donem_id'])) {\r\n+            $donemIds = explode(',', $hakedis['bayi_hakedis_prim_donem_id']);\r\n+            $donemIds = array_map('intval', $donemIds);\r\n+            $placeholders = str_repeat('?,', count($donemIds) - 1) . '?';\r\n+            \r\n+            $donemSql = \"SELECT donem_adi FROM bayi_hakedis_prim_donem WHERE id IN ($placeholders)\";\r\n+            $donemStmt = $conn->prepare($donemSql);\r\n+            $donemStmt->execute($donemIds);\r\n+            $donemler = $donemStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+            \r\n+            $hakedis['donem_adi'] = implode(', ', $donemler);\r\n+            $hakedis['donemIds'] = $donemIds;\r\n+        } else {\r\n+            $hakedis['donem_adi'] = 'Dönem Seçilmemiş';\r\n+            $hakedis['donemIds'] = [];\r\n+        }\r\n+    }\r\n+    \r\n } catch (Exception $e) {\r\n     $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n }\r\n \r\n@@ -482,18 +502,26 @@\n     \r\n     // Önce tüm checkbox'ları temizle\r\n     clearAllPeriods();\r\n     \r\n-    // Mevcut dönemi seç\r\n-    console.log('Seçilecek dönem ID:', hakedis.bayi_hakedis_prim_donem_id);\r\n+    // Dönem ID'lerini seç (virgülle ayrılmış string'i parse et)\r\n+    console.log('Seçilecek dönem ID string:', hakedis.bayi_hakedis_prim_donem_id);\r\n     if (hakedis.bayi_hakedis_prim_donem_id) {\r\n-        const checkbox = document.getElementById('donem_' + hakedis.bayi_hakedis_prim_donem_id);\r\n-        if (checkbox) {\r\n-            checkbox.checked = true;\r\n-            console.log('Dönem seçildi:', checkbox.value);\r\n-        } else {\r\n-            console.log('Checkbox bulunamadı: donem_' + hakedis.bayi_hakedis_prim_donem_id);\r\n-        }\r\n+        // Virgülle ayrılmış string'i array'e çevir\r\n+        const donemIds = hakedis.bayi_hakedis_prim_donem_id.toString().split(',').map(id => id.trim());\r\n+        console.log('Parse edilen dönem IDs:', donemIds);\r\n+        \r\n+        donemIds.forEach(donemId => {\r\n+            if (donemId) {\r\n+                const checkbox = document.getElementById('donem_' + donemId);\r\n+                if (checkbox) {\r\n+                    checkbox.checked = true;\r\n+                    console.log('Dönem seçildi:', checkbox.value);\r\n+                } else {\r\n+                    console.log('Checkbox bulunamadı: donem_' + donemId);\r\n+                }\r\n+            }\r\n+        });\r\n     }\r\n     \r\n     // Modal açılmadan önce kısa bir bekle\r\n     setTimeout(() => {\r\n"
                },
                {
                    "date": 1759480584536,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,12 +3,30 @@\n $breadcrumbs = [\r\n     ['title' => 'Bayi Hakediş Tanımlama']\r\n ];\r\n \r\n-// Auth kontrol\r\n-require_once 'auth.php';\r\n-$currentUser = checkAdminAuth();\r\n+// Auth kontrol - GEÇİCİ OLARAK DEVRE DIŞI\r\n+// require_once 'auth.php';\r\n+// $currentUser = checkAdminAuth();\r\n \r\n+// Geçici veritabanı bağlantısı için\r\n+require_once 'config/mssql.php';\r\n+function getDatabaseConnection() {\r\n+    $config = include 'config/mssql.php';\r\n+    try {\r\n+        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n+        $connection = new PDO($dsn, $config['username'], $config['password'], [\r\n+            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n+            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n+            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n+            PDO::ATTR_EMULATE_PREPARES => false\r\n+        ]);\r\n+        return $connection;\r\n+    } catch (PDOException $e) {\r\n+        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n+    }\r\n+}\r\n+\r\n $message = '';\r\n $messageType = '';\r\n \r\n // Hakediş tanım işlemleri\r\n@@ -194,14 +212,287 @@\n \r\n include 'includes/header.php';\r\n ?>\r\n \r\n+<script>\r\n+// JavaScript fonksiyonlarını sayfanın başında tanımla\r\n+function editHakedisFromButton(button) {\r\n+    console.log('editHakedisFromButton çağrıldı');\r\n+    try {\r\n+        const hakedisData = button.getAttribute('data-hakedis');\r\n+        if (!hakedisData) {\r\n+            console.error('Hakedis data bulunamadı');\r\n+            alert('Veri yükleme hatası. Sayfayı yenileyin ve tekrar deneyin.');\r\n+            return;\r\n+        }\r\n+        \r\n+        const hakedis = JSON.parse(hakedisData);\r\n+        editHakedis(hakedis);\r\n+    } catch (error) {\r\n+        console.error('JSON parse hatası:', error);\r\n+        console.error('Data:', button.getAttribute('data-hakedis'));\r\n+        alert('Veri okuma hatası. Sayfayı yenileyin ve tekrar deneyin.');\r\n+    }\r\n+}\r\n+\r\n+function validateForm() {\r\n+    // Bayi seçimi kontrolü\r\n+    const bayiId = document.getElementById('bayi_id') ? document.getElementById('bayi_id').value : '';\r\n+    if (!bayiId) {\r\n+        alert('Lütfen bir bayi seçin.');\r\n+        return false;\r\n+    }\r\n+    \r\n+    // Dönem seçimi kontrolü\r\n+    const checkedDonems = document.querySelectorAll('.donem-checkbox:checked');\r\n+    console.log('Seçili dönem sayısı:', checkedDonems.length);\r\n+    \r\n+    if (checkedDonems.length === 0) {\r\n+        alert('Lütfen en az bir dönem seçin.');\r\n+        console.log('Hata: Hiç dönem seçili değil');\r\n+        return false;\r\n+    }\r\n+    \r\n+    return true;\r\n+}\r\n+\r\n+function selectAllPeriods() {\r\n+    const checkboxes = document.querySelectorAll('.donem-checkbox');\r\n+    checkboxes.forEach(checkbox => checkbox.checked = true);\r\n+}\r\n+\r\n+function clearAllPeriods() {\r\n+    const checkboxes = document.querySelectorAll('.donem-checkbox');\r\n+    checkboxes.forEach(checkbox => checkbox.checked = false);\r\n+}\r\n+\r\n+function deleteHakedis(hakedisId, bayiName) {\r\n+    if (confirm(bayiName + ' için hakediş tanımını silmek istediğinizden emin misiniz?\\n\\nBu işlem geri alınamaz.')) {\r\n+        const form = document.createElement('form');\r\n+        form.method = 'POST';\r\n+        form.innerHTML = `\r\n+            <input type=\"hidden\" name=\"action\" value=\"delete\">\r\n+            <input type=\"hidden\" name=\"id\" value=\"${hakedisId}\">\r\n+        `;\r\n+        document.body.appendChild(form);\r\n+        form.submit();\r\n+    }\r\n+}\r\n+\r\n+function openNewModal() {\r\n+    console.log('Yeni modal açılıyor...');\r\n+    const modal = document.getElementById('addHakedisModal');\r\n+    \r\n+    if (!modal) {\r\n+        console.error('Modal bulunamadı!');\r\n+        alert('Modal bulunamadı. Sayfayı yenileyin.');\r\n+        return;\r\n+    }\r\n+    \r\n+    // Modal'ı temizle\r\n+    clearModal();\r\n+    \r\n+    // Modal'ı aç\r\n+    try {\r\n+        if (typeof bootstrap !== 'undefined') {\r\n+            const bootstrapModal = new bootstrap.Modal(modal);\r\n+            bootstrapModal.show();\r\n+            console.log('Yeni modal Bootstrap ile açıldı');\r\n+        } else {\r\n+            // Vanilla JavaScript ile aç\r\n+            console.log('Bootstrap bulunamadı, vanilla JavaScript ile açılıyor...');\r\n+            modal.style.display = 'block';\r\n+            modal.classList.add('show');\r\n+            document.body.classList.add('modal-open');\r\n+            \r\n+            // Backdrop ekle\r\n+            const backdrop = document.createElement('div');\r\n+            backdrop.className = 'modal-backdrop fade show';\r\n+            backdrop.id = 'temp-backdrop';\r\n+            document.body.appendChild(backdrop);\r\n+            \r\n+            // Close events\r\n+            const closeButtons = modal.querySelectorAll('[data-bs-dismiss=\"modal\"]');\r\n+            closeButtons.forEach(button => {\r\n+                button.addEventListener('click', function() {\r\n+                    modal.style.display = 'none';\r\n+                    modal.classList.remove('show');\r\n+                    document.body.classList.remove('modal-open');\r\n+                    const tempBackdrop = document.getElementById('temp-backdrop');\r\n+                    if (tempBackdrop) tempBackdrop.remove();\r\n+                });\r\n+            });\r\n+            \r\n+            backdrop.addEventListener('click', function() {\r\n+                modal.style.display = 'none';\r\n+                modal.classList.remove('show');\r\n+                document.body.classList.remove('modal-open');\r\n+                backdrop.remove();\r\n+            });\r\n+            \r\n+            console.log('Yeni modal vanilla JavaScript ile açıldı');\r\n+        }\r\n+    } catch (error) {\r\n+        console.error('Modal açılırken hata:', error);\r\n+        alert('Modal açılırken bir hata oluştu.');\r\n+    }\r\n+}\r\n+\r\n+function clearModal() {\r\n+    if (document.getElementById('modal_action')) {\r\n+        document.getElementById('modal_action').value = 'add';\r\n+        document.getElementById('modal_id').value = '';\r\n+        document.getElementById('modal_title_text').textContent = 'Yeni Hakediş Tanımı';\r\n+        document.getElementById('modal_icon').className = 'fas fa-plus me-2';\r\n+        document.getElementById('modal_submit_text').textContent = 'Kaydet';\r\n+        \r\n+        // Formu temizle\r\n+        document.getElementById('bayi_id').value = '';\r\n+        document.getElementById('isp_neo_fiyat').value = '';\r\n+        document.getElementById('isp_uydu_fiyat').value = '';\r\n+        document.getElementById('neo_fiyat').value = '';\r\n+        document.getElementById('uydu_fiyat').value = '';\r\n+        document.getElementById('aciklama').value = '';\r\n+        \r\n+        // Dönem checkbox'larını temizle\r\n+        clearAllPeriods();\r\n+    }\r\n+}\r\n+\r\n+function editHakedis(hakedis) {\r\n+    console.log('Edit başlatıldı, hakedis data:', hakedis);\r\n+    \r\n+    // DOM elementlerinin varlığını kontrol et\r\n+    const modalAction = document.getElementById('modal_action');\r\n+    const modalId = document.getElementById('modal_id');\r\n+    const modalTitleText = document.getElementById('modal_title_text');\r\n+    const modalIcon = document.getElementById('modal_icon');\r\n+    const modalSubmitText = document.getElementById('modal_submit_text');\r\n+    const bayiIdSelect = document.getElementById('bayi_id');\r\n+    const ispNeoFiyat = document.getElementById('isp_neo_fiyat');\r\n+    const ispUyduFiyat = document.getElementById('isp_uydu_fiyat');\r\n+    const neoFiyat = document.getElementById('neo_fiyat');\r\n+    const uyduFiyat = document.getElementById('uydu_fiyat');\r\n+    const aciklama = document.getElementById('aciklama');\r\n+    const modal = document.getElementById('addHakedisModal');\r\n+    \r\n+    // Eğer modal elementleri henüz yüklenmemişse, bekle ve tekrar dene\r\n+    if (!modalAction || !modalId || !modalTitleText || !modal) {\r\n+        console.log('Modal elementleri henüz yüklenmemiş, 500ms sonra tekrar denenecek...');\r\n+        setTimeout(() => editHakedis(hakedis), 500);\r\n+        return;\r\n+    }\r\n+    \r\n+    // Modal başlığını güncelle\r\n+    modalAction.value = 'edit';\r\n+    modalId.value = hakedis.id;\r\n+    modalTitleText.textContent = 'Hakediş Tanımını Düzenle';\r\n+    if (modalIcon) modalIcon.className = 'fas fa-edit me-2';\r\n+    if (modalSubmitText) modalSubmitText.textContent = 'Güncelle';\r\n+    \r\n+    // Modal alanlarını doldur\r\n+    if (bayiIdSelect) bayiIdSelect.value = hakedis.bayi_id;\r\n+    if (ispNeoFiyat) ispNeoFiyat.value = hakedis.isp_neo_fiyat || '';\r\n+    if (ispUyduFiyat) ispUyduFiyat.value = hakedis.isp_uydu_fiyat || '';\r\n+    if (neoFiyat) neoFiyat.value = hakedis.neo_fiyat || '';\r\n+    if (uyduFiyat) uyduFiyat.value = hakedis.uydu_fiyat || '';\r\n+    if (aciklama) aciklama.value = hakedis.aciklama || '';\r\n+    \r\n+    // Önce tüm checkbox'ları temizle\r\n+    clearAllPeriods();\r\n+    \r\n+    // Dönem ID'lerini seç\r\n+    if (hakedis.bayi_hakedis_prim_donem_id) {\r\n+        const donemIds = hakedis.bayi_hakedis_prim_donem_id.toString().split(',').map(id => id.trim());\r\n+        console.log('Parse edilen dönem IDs:', donemIds);\r\n+        \r\n+        donemIds.forEach(donemId => {\r\n+            if (donemId) {\r\n+                const checkbox = document.getElementById('donem_' + donemId);\r\n+                if (checkbox) {\r\n+                    checkbox.checked = true;\r\n+                    console.log('Dönem seçildi:', checkbox.value);\r\n+                } else {\r\n+                    console.log('Checkbox bulunamadı: donem_' + donemId);\r\n+                }\r\n+            }\r\n+        });\r\n+    }\r\n+    \r\n+    // Modal'ı aç - Bootstrap yerine vanilla JavaScript kullan\r\n+    try {\r\n+        // Bootstrap kontrolü\r\n+        if (typeof bootstrap !== 'undefined') {\r\n+            const bootstrapModal = new bootstrap.Modal(modal);\r\n+            bootstrapModal.show();\r\n+            console.log('Modal Bootstrap ile açıldı');\r\n+        } else {\r\n+            // Fallback: Modal'ı manuel olarak aç\r\n+            console.log('Bootstrap bulunamadı, vanilla JavaScript ile açılıyor...');\r\n+            modal.style.display = 'block';\r\n+            modal.classList.add('show');\r\n+            document.body.classList.add('modal-open');\r\n+            \r\n+            // Backdrop ekle\r\n+            const backdrop = document.createElement('div');\r\n+            backdrop.className = 'modal-backdrop fade show';\r\n+            backdrop.id = 'temp-backdrop';\r\n+            document.body.appendChild(backdrop);\r\n+            \r\n+            console.log('Modal vanilla JavaScript ile açıldı');\r\n+            \r\n+            // Modal kapat butonu için event listener\r\n+            const closeButtons = modal.querySelectorAll('[data-bs-dismiss=\"modal\"]');\r\n+            closeButtons.forEach(button => {\r\n+                button.addEventListener('click', function() {\r\n+                    modal.style.display = 'none';\r\n+                    modal.classList.remove('show');\r\n+                    document.body.classList.remove('modal-open');\r\n+                    const tempBackdrop = document.getElementById('temp-backdrop');\r\n+                    if (tempBackdrop) tempBackdrop.remove();\r\n+                });\r\n+            });\r\n+            \r\n+            // Backdrop tıklama ile kapatma\r\n+            backdrop.addEventListener('click', function() {\r\n+                modal.style.display = 'none';\r\n+                modal.classList.remove('show');\r\n+                document.body.classList.remove('modal-open');\r\n+                backdrop.remove();\r\n+            });\r\n+        }\r\n+    } catch (error) {\r\n+        console.error('Modal açılırken hata:', error);\r\n+        alert('Modal açılırken bir hata oluştu. Sayfa yenilenecek.');\r\n+        location.reload();\r\n+    }\r\n+}\r\n+\r\n+// Global error handler\r\n+window.addEventListener('error', function(event) {\r\n+    console.error('JavaScript hatası:', event.error);\r\n+    console.error('Hata mesajı:', event.message);\r\n+    console.error('Dosya:', event.filename);\r\n+    console.error('Satır:', event.lineno);\r\n+});\r\n+\r\n+// Bootstrap kontrolü\r\n+console.log('Bootstrap kontrolü:');\r\n+console.log('- typeof bootstrap:', typeof bootstrap);\r\n+console.log('- Bootstrap version:', typeof bootstrap !== 'undefined' ? bootstrap.Tooltip.VERSION : 'Bootstrap yüklenmemiş');\r\n+\r\n+console.log('JavaScript fonksiyonları yüklendi!');\r\n+console.log('editHakedisFromButton:', typeof editHakedisFromButton);\r\n+console.log('editHakedis:', typeof editHakedis);\r\n+console.log('validateForm:', typeof validateForm);\r\n+</script>\r\n+\r\n <div class=\"container-fluid mt-4\">\r\n     <div class=\"row\">\r\n         <div class=\"col-12\">\r\n             <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n                 <h2><i class=\"fas fa-calculator me-2\"></i>Bayi Hakediş Tanımlama</h2>\r\n-                <button class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#addHakedisModal\">\r\n+                <button class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#addHakedisModal\" onclick=\"openNewModal()\">\r\n                     <i class=\"fas fa-plus me-1\"></i>Yeni Hakediş Tanımı\r\n                 </button>\r\n             </div>\r\n         </div>\r\n@@ -286,9 +577,10 @@\n                                     </td>\r\n                                     <td>\r\n                                         <div class=\"btn-group\" role=\"group\">\r\n                                             <button type=\"button\" class=\"btn btn-sm btn-outline-primary\" \r\n-                                                    onclick=\"editHakedis(<?php echo htmlspecialchars(json_encode($hakedis)); ?>)\">\r\n+                                                    data-hakedis='<?php echo json_encode($hakedis, JSON_HEX_APOS | JSON_HEX_QUOT); ?>'\r\n+                                                    onclick=\"editHakedisFromButton(this)\">\r\n                                                 <i class=\"fas fa-edit\"></i>\r\n                                             </button>\r\n                                             <button type=\"button\" class=\"btn btn-sm btn-outline-danger\" \r\n                                                     onclick=\"deleteHakedis(<?php echo $hakedis['id']; ?>, '<?php echo htmlspecialchars($hakedis['first_name'] . ' ' . $hakedis['last_name']); ?>')\">\r\n@@ -420,186 +712,55 @@\n         </div>\r\n     </div>\r\n </div>\r\n \r\n-<script>\r\n-// Form validation fonksiyonu\r\n-function validateForm() {\r\n-    // Bayi seçimi kontrolü\r\n-    const bayiId = document.getElementById('bayi_id').value;\r\n-    if (!bayiId) {\r\n-        alert('Lütfen bir bayi seçin.');\r\n-        return false;\r\n-    }\r\n-    \r\n-    // Dönem seçimi kontrolü\r\n-    const checkedDonems = document.querySelectorAll('.donem-checkbox:checked');\r\n-    console.log('Seçili dönem sayısı:', checkedDonems.length);\r\n-    console.log('Modal action:', document.getElementById('modal_action').value);\r\n-    \r\n-    if (checkedDonems.length === 0) {\r\n-        alert('Lütfen en az bir dönem seçin.');\r\n-        console.log('Hata: Hiç dönem seçili değil');\r\n-        return false;\r\n-    }\r\n-    \r\n-    // Debug: Seçili dönemleri göster\r\n-    checkedDonems.forEach(checkbox => {\r\n-        console.log('Seçili dönem ID:', checkbox.value, 'Name:', checkbox.name);\r\n-    });\r\n-    \r\n-    return true;\r\n+<style>\r\n+.donem-checkbox:checked + .form-check-label {\r\n+    font-weight: bold;\r\n+    color: #0d6efd;\r\n }\r\n \r\n-// Modal temizleme fonksiyonu\r\n-function clearModal() {\r\n-    document.getElementById('modal_action').value = 'add';\r\n-    document.getElementById('modal_id').value = '';\r\n-    document.getElementById('modal_title_text').textContent = 'Yeni Hakediş Tanımı';\r\n-    document.getElementById('modal_icon').className = 'fas fa-plus me-2';\r\n-    document.getElementById('modal_submit_text').textContent = 'Kaydet';\r\n-    \r\n-    // Formu temizle\r\n-    document.getElementById('bayi_id').value = '';\r\n-    document.getElementById('isp_neo_fiyat').value = '';\r\n-    document.getElementById('isp_uydu_fiyat').value = '';\r\n-    document.getElementById('neo_fiyat').value = '';\r\n-    document.getElementById('uydu_fiyat').value = '';\r\n-    document.getElementById('aciklama').value = '';\r\n-    \r\n-    // Dönem checkbox'larını temizle\r\n-    clearAllPeriods();\r\n+.form-check {\r\n+    padding: 0.25rem 0;\r\n }\r\n \r\n-// Dönem seçim fonksiyonları\r\n-function selectAllPeriods() {\r\n-    const checkboxes = document.querySelectorAll('.donem-checkbox');\r\n-    checkboxes.forEach(checkbox => checkbox.checked = true);\r\n+.form-check:hover {\r\n+    background-color: #f8f9fa;\r\n+    border-radius: 0.25rem;\r\n }\r\n \r\n-function clearAllPeriods() {\r\n-    const checkboxes = document.querySelectorAll('.donem-checkbox');\r\n-    checkboxes.forEach(checkbox => checkbox.checked = false);\r\n+.border.rounded {\r\n+    border-color: #dee2e6 !important;\r\n }\r\n+</style>\r\n \r\n-// Düzenleme fonksiyonu\r\n-function editHakedis(hakedis) {\r\n-    console.log('Edit başlatıldı, hakedis data:', hakedis);\r\n+<script>\r\n+// DOM yüklendikten sonra çalışacak\r\n+document.addEventListener('DOMContentLoaded', function() {\r\n+    console.log('DOM yüklendi. Event listener\\'lar ekleniyor...');\r\n     \r\n-    // Modal başlığını güncelle\r\n-    document.getElementById('modal_action').value = 'edit';\r\n-    document.getElementById('modal_id').value = hakedis.id;\r\n-    document.getElementById('modal_title_text').textContent = 'Hakediş Tanımını Düzenle';\r\n-    document.getElementById('modal_icon').className = 'fas fa-edit me-2';\r\n-    document.getElementById('modal_submit_text').textContent = 'Güncelle';\r\n-    \r\n-    // Modal alanlarını doldur\r\n-    document.getElementById('bayi_id').value = hakedis.bayi_id;\r\n-    document.getElementById('isp_neo_fiyat').value = hakedis.isp_neo_fiyat || '';\r\n-    document.getElementById('isp_uydu_fiyat').value = hakedis.isp_uydu_fiyat || '';\r\n-    document.getElementById('neo_fiyat').value = hakedis.neo_fiyat || '';\r\n-    document.getElementById('uydu_fiyat').value = hakedis.uydu_fiyat || '';\r\n-    document.getElementById('aciklama').value = hakedis.aciklama || '';\r\n-    \r\n-    // Önce tüm checkbox'ları temizle\r\n-    clearAllPeriods();\r\n-    \r\n-    // Dönem ID'lerini seç (virgülle ayrılmış string'i parse et)\r\n-    console.log('Seçilecek dönem ID string:', hakedis.bayi_hakedis_prim_donem_id);\r\n-    if (hakedis.bayi_hakedis_prim_donem_id) {\r\n-        // Virgülle ayrılmış string'i array'e çevir\r\n-        const donemIds = hakedis.bayi_hakedis_prim_donem_id.toString().split(',').map(id => id.trim());\r\n-        console.log('Parse edilen dönem IDs:', donemIds);\r\n-        \r\n-        donemIds.forEach(donemId => {\r\n-            if (donemId) {\r\n-                const checkbox = document.getElementById('donem_' + donemId);\r\n-                if (checkbox) {\r\n-                    checkbox.checked = true;\r\n-                    console.log('Dönem seçildi:', checkbox.value);\r\n-                } else {\r\n-                    console.log('Checkbox bulunamadı: donem_' + donemId);\r\n-                }\r\n+    // Modal event listener\r\n+    const modal = document.getElementById('addHakedisModal');\r\n+    if (modal) {\r\n+        modal.addEventListener('show.bs.modal', function(event) {\r\n+            // Eğer modal düzenleme için açılmıyorsa temizle\r\n+            if (event.relatedTarget && event.relatedTarget.getAttribute('data-bs-target') === '#addHakedisModal') {\r\n+                clearModal();\r\n             }\r\n         });\r\n     }\r\n     \r\n-    // Modal açılmadan önce kısa bir bekle\r\n-    setTimeout(() => {\r\n-        var modal = new bootstrap.Modal(document.getElementById('addHakedisModal'));\r\n-        modal.show();\r\n-        \r\n-        // Modal açıldıktan sonra seçili dönemleri kontrol et\r\n-        setTimeout(() => {\r\n-            const checkedAfterOpen = document.querySelectorAll('.donem-checkbox:checked');\r\n-            console.log('Modal açıldıktan sonra seçili dönem sayısı:', checkedAfterOpen.length);\r\n-        }, 500);\r\n-    }, 100);\r\n-}\r\n-\r\n-function deleteHakedis(hakedisId, bayiName) {\r\n-    if (confirm(bayiName + ' için hakediş tanımını silmek istediğinizden emin misiniz?\\n\\nBu işlem geri alınamaz.')) {\r\n-        const form = document.createElement('form');\r\n-        form.method = 'POST';\r\n-        form.innerHTML = `\r\n-            <input type=\"hidden\" name=\"action\" value=\"delete\">\r\n-            <input type=\"hidden\" name=\"id\" value=\"${hakedisId}\">\r\n-        `;\r\n-        document.body.appendChild(form);\r\n-        form.submit();\r\n-    }\r\n-}\r\n-\r\n-// Modal açıldığında temizle (Yeni butonuna basıldığında)\r\n-document.getElementById('addHakedisModal').addEventListener('show.bs.modal', function(event) {\r\n-    // Eğer modal düzenleme için açılmıyorsa temizle\r\n-    if (event.relatedTarget && event.relatedTarget.getAttribute('data-bs-target') === '#addHakedisModal') {\r\n-        clearModal();\r\n-    }\r\n-});\r\n-\r\n-// Form submit olayını dinle\r\n-document.addEventListener('DOMContentLoaded', function() {\r\n+    // Form submit listener\r\n     const form = document.querySelector('#addHakedisModal form');\r\n     if (form) {\r\n         form.addEventListener('submit', function(e) {\r\n             console.log('Form submit edildi');\r\n-            const checkedDonems = document.querySelectorAll('.donem-checkbox:checked');\r\n-            console.log('Submit sırasında seçili dönem sayısı:', checkedDonems.length);\r\n-            \r\n-            if (checkedDonems.length === 0) {\r\n-                console.log('Hiç dönem seçili değil, form submit engellendi');\r\n+            if (!validateForm()) {\r\n                 e.preventDefault();\r\n-                alert('Lütfen en az bir dönem seçin.');\r\n                 return false;\r\n             }\r\n-            \r\n-            // Seçili dönemleri listele\r\n-            checkedDonems.forEach((checkbox, index) => {\r\n-                console.log(`Seçili dönem ${index + 1}: ID=${checkbox.value}, Name=${checkbox.name}`);\r\n-            });\r\n         });\r\n     }\r\n });\r\n </script>\r\n \r\n-<style>\r\n-.donem-checkbox:checked + .form-check-label {\r\n-    font-weight: bold;\r\n-    color: #0d6efd;\r\n-}\r\n-\r\n-.form-check {\r\n-    padding: 0.25rem 0;\r\n-}\r\n-\r\n-.form-check:hover {\r\n-    background-color: #f8f9fa;\r\n-    border-radius: 0.25rem;\r\n-}\r\n-\r\n-.border.rounded {\r\n-    border-color: #dee2e6 !important;\r\n-}\r\n-</style>\r\n-\r\n <?php include 'includes/footer.php'; ?>\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759480961300,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,9 @@\n <?php\r\n+// Debug için hata raporlamasını aç\r\n+error_reporting(E_ALL);\r\n+ini_set('display_errors', 1);\r\n+\r\n $pageTitle = \"Bayi Hakediş Tanımlama\";\r\n $breadcrumbs = [\r\n     ['title' => 'Bayi Hakediş Tanımlama']\r\n ];\r\n@@ -140,11 +144,20 @@\n \r\n // Bayileri al\r\n $bayiler = [];\r\n $donemler = [];\r\n+// Veritabanı sorgularında schema prefix'ini ekle - test için\r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n+    // Test: Dönem tablosunu kontrol et\r\n+    $testSql = \"SELECT COUNT(*) as count FROM digiturk.bayi_hakedis_prim_donem\";\r\n+    $testStmt = $conn->prepare($testSql);\r\n+    $testStmt->execute();\r\n+    $count = $testStmt->fetch(PDO::FETCH_ASSOC);\r\n+    echo \"<!-- DEBUG: digiturk.bayi_hakedis_prim_donem tablosunda toplam kayıt: \" . $count['count'] . \" -->\\n\";\r\n+    error_log(\"digiturk.bayi_hakedis_prim_donem tablosunda toplam kayıt: \" . $count['count']);\r\n+    \r\n     // Bayiler\r\n     $bayiGroupSql = \"SELECT id FROM user_groups WHERE group_name IN ('bayi', 'Bayi')\";\r\n     $bayiGroupStmt = $conn->prepare($bayiGroupSql);\r\n     $bayiGroupStmt->execute();\r\n@@ -162,13 +175,24 @@\n         $bayiler = $bayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n     }\r\n     \r\n     // Dönemleri al\r\n-    $donemSql = \"SELECT id, donem_adi FROM bayi_hakedis_prim_donem WHERE durum = 'AKTIF' ORDER BY id DESC\";\r\n+    $donemSql = \"SELECT id, donem_adi FROM digiturk.bayi_hakedis_prim_donem WHERE durum = 'AKTIF' ORDER BY id DESC\";\r\n     $donemStmt = $conn->prepare($donemSql);\r\n     $donemStmt->execute();\r\n     $donemler = $donemStmt->fetchAll(PDO::FETCH_ASSOC);\r\n     \r\n+    // Debug: Dönem sayısını kontrol et\r\n+    echo \"<!-- DEBUG: Dönem sayısı: \" . count($donemler) . \" -->\\n\";\r\n+    error_log(\"Dönem sayısı: \" . count($donemler));\r\n+    if (count($donemler) > 0) {\r\n+        echo \"<!-- DEBUG: İlk dönem: \" . print_r($donemler[0], true) . \" -->\\n\";\r\n+        error_log(\"İlk dönem: \" . print_r($donemler[0], true));\r\n+    } else {\r\n+        echo \"<!-- DEBUG: Hiç dönem bulunamadı! -->\\n\";\r\n+        error_log(\"HATA: Hiç dönem bulunamadı!\");\r\n+    }\r\n+    \r\n } catch (Exception $e) {\r\n     // Hata durumunda boş array kalacak\r\n }\r\n \r\n@@ -192,15 +216,19 @@\n             $donemIds = explode(',', $hakedis['bayi_hakedis_prim_donem_id']);\r\n             $donemIds = array_map('intval', $donemIds);\r\n             $placeholders = str_repeat('?,', count($donemIds) - 1) . '?';\r\n             \r\n-            $donemSql = \"SELECT donem_adi FROM bayi_hakedis_prim_donem WHERE id IN ($placeholders)\";\r\n+            $donemSql = \"SELECT donem_adi FROM digiturk.bayi_hakedis_prim_donem WHERE id IN ($placeholders)\";\r\n             $donemStmt = $conn->prepare($donemSql);\r\n             $donemStmt->execute($donemIds);\r\n-            $donemler = $donemStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+            $donemAdilar = $donemStmt->fetchAll(PDO::FETCH_COLUMN);\r\n             \r\n-            $hakedis['donem_adi'] = implode(', ', $donemler);\r\n+            $hakedis['donem_adi'] = implode(', ', $donemAdilar);\r\n             $hakedis['donemIds'] = $donemIds;\r\n+            \r\n+            // Debug log\r\n+            error_log(\"Hakediş ID {$hakedis['id']} - Dönem IDs: \" . $hakedis['bayi_hakedis_prim_donem_id']);\r\n+            error_log(\"Parse edilen IDs: \" . print_r($donemIds, true));\r\n         } else {\r\n             $hakedis['donem_adi'] = 'Dönem Seçilmemiş';\r\n             $hakedis['donemIds'] = [];\r\n         }\r\n@@ -402,21 +430,28 @@\n     \r\n     // Dönem ID'lerini seç\r\n     if (hakedis.bayi_hakedis_prim_donem_id) {\r\n         const donemIds = hakedis.bayi_hakedis_prim_donem_id.toString().split(',').map(id => id.trim());\r\n-        console.log('Parse edilen dönem IDs:', donemIds);\r\n+        console.log('Seçilecek dönem IDs:', donemIds);\r\n+        console.log('Mevcut checkbox sayısı:', document.querySelectorAll('.donem-checkbox').length);\r\n         \r\n         donemIds.forEach(donemId => {\r\n             if (donemId) {\r\n                 const checkbox = document.getElementById('donem_' + donemId);\r\n                 if (checkbox) {\r\n                     checkbox.checked = true;\r\n-                    console.log('Dönem seçildi:', checkbox.value);\r\n+                    console.log('Dönem seçildi:', donemId, checkbox.value);\r\n                 } else {\r\n-                    console.log('Checkbox bulunamadı: donem_' + donemId);\r\n+                    console.warn('Checkbox bulunamadı: donem_' + donemId);\r\n+                    // Tüm mevcut checkbox'ları listele\r\n+                    const allCheckboxes = document.querySelectorAll('.donem-checkbox');\r\n+                    console.log('Mevcut checkbox ID\\'leri:');\r\n+                    allCheckboxes.forEach(cb => console.log('- ' + cb.id));\r\n                 }\r\n             }\r\n         });\r\n+    } else {\r\n+        console.log('Hakediş için dönem ID bulunamadı:', hakedis.bayi_hakedis_prim_donem_id);\r\n     }\r\n     \r\n     // Modal'ı aç - Bootstrap yerine vanilla JavaScript kullan\r\n     try {\r\n@@ -483,8 +518,23 @@\n console.log('JavaScript fonksiyonları yüklendi!');\r\n console.log('editHakedisFromButton:', typeof editHakedisFromButton);\r\n console.log('editHakedis:', typeof editHakedis);\r\n console.log('validateForm:', typeof validateForm);\r\n+\r\n+// DOM yüklendikten sonra dönem checkbox'larını kontrol et\r\n+document.addEventListener('DOMContentLoaded', function() {\r\n+    const donemCheckboxes = document.querySelectorAll('.donem-checkbox');\r\n+    console.log('Sayfada bulunan dönem checkbox sayısı:', donemCheckboxes.length);\r\n+    \r\n+    if (donemCheckboxes.length === 0) {\r\n+        console.warn('Hiç dönem checkbox bulunamadı! Dönem verileri yüklenmemiş olabilir.');\r\n+    } else {\r\n+        console.log('Bulunan dönem checkbox\\'ları:');\r\n+        donemCheckboxes.forEach((checkbox, index) => {\r\n+            console.log(`${index + 1}. ${checkbox.id} = ${checkbox.value} (${checkbox.nextElementSibling.textContent})`);\r\n+        });\r\n+    }\r\n+});\r\n </script>\r\n \r\n <div class=\"container-fluid mt-4\">\r\n     <div class=\"row\">\r\n@@ -671,17 +721,27 @@\n                     </div>\r\n                     \r\n                     <div class=\"mb-3\">\r\n                         <label for=\"bayi_hakedis_prim_donem_id\" class=\"form-label\">Dönem Seçimi <span class=\"text-danger\">*</span></label>\r\n+                        <?php if (empty($donemler)): ?>\r\n+                            <div class=\"alert alert-warning\">\r\n+                                <i class=\"fas fa-exclamation-triangle me-1\"></i>\r\n+                                Hiç aktif dönem bulunamadı! Veritabanını kontrol edin.\r\n+                            </div>\r\n+                        <?php else: ?>\r\n+                            <div class=\"alert alert-info mb-2\">\r\n+                                <small><i class=\"fas fa-info-circle me-1\"></i>Toplam <?php echo count($donemler); ?> dönem mevcut</small>\r\n+                            </div>\r\n+                        <?php endif; ?>\r\n                         <div class=\"border rounded p-2\" style=\"max-height: 200px; overflow-y: auto;\">\r\n                             <?php foreach ($donemler as $donem): ?>\r\n                                 <div class=\"form-check\">\r\n                                     <input class=\"form-check-input donem-checkbox\" type=\"checkbox\" \r\n                                            name=\"bayi_hakedis_prim_donem_id[]\" \r\n                                            value=\"<?php echo $donem['id']; ?>\" \r\n                                            id=\"donem_<?php echo $donem['id']; ?>\">\r\n                                     <label class=\"form-check-label\" for=\"donem_<?php echo $donem['id']; ?>\">\r\n-                                        <?php echo htmlspecialchars($donem['donem_adi']); ?>\r\n+                                        <?php echo htmlspecialchars($donem['donem_adi']); ?> (ID: <?php echo $donem['id']; ?>)\r\n                                     </label>\r\n                                 </div>\r\n                             <?php endforeach; ?>\r\n                         </div>\r\n"
                },
                {
                    "date": 1759561113052,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -195,46 +195,66 @@\n } catch (Exception $e) {\r\n     // Hata durumunda boş array kalacak\r\n }\r\n \r\n-// Hakediş tanımlarını listele\r\n+// Hakediş tanımlarını listele - CLEAN VERSION\r\n $hakedisler = [];\r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n-    $sql = \"SELECT ht.*, u.first_name, u.last_name, u.email\r\n+    $sql = \"SELECT DISTINCT ht.*, u.first_name, u.last_name, u.email\r\n             FROM hakedis_tanim ht\r\n             INNER JOIN users u ON ht.bayi_id = u.id\r\n             ORDER BY ht.created_at DESC\";\r\n     \r\n     $stmt = $conn->prepare($sql);\r\n     $stmt->execute();\r\n-    $hakedisler = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n+    $hakedislerRaw = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n     \r\n+    // İlk duplikasyon temizleme - ID'ye göre benzersiz kayıtlar\r\n+    $uniqueHakedisler = [];\r\n+    foreach ($hakedislerRaw as $hakedis) {\r\n+        $uniqueHakedisler[$hakedis['id']] = $hakedis;\r\n+    }\r\n+    \r\n+    // Array'e çevir ve sıralama yap\r\n+    $hakedisler = array_values($uniqueHakedisler);\r\n+    usort($hakedisler, function($a, $b) {\r\n+        return strtotime($b['created_at']) - strtotime($a['created_at']);\r\n+    });\r\n+    \r\n     // Her hakediş için dönem isimlerini al\r\n-    foreach ($hakedisler as &$hakedis) {\r\n-        if (!empty($hakedis['bayi_hakedis_prim_donem_id'])) {\r\n-            $donemIds = explode(',', $hakedis['bayi_hakedis_prim_donem_id']);\r\n-            $donemIds = array_map('intval', $donemIds);\r\n-            $placeholders = str_repeat('?,', count($donemIds) - 1) . '?';\r\n+    for ($i = 0; $i < count($hakedisler); $i++) {\r\n+        if (!empty($hakedisler[$i]['bayi_hakedis_prim_donem_id'])) {\r\n+            $donemIds = explode(',', $hakedisler[$i]['bayi_hakedis_prim_donem_id']);\r\n+            $donemIds = array_filter(array_map('intval', $donemIds));\r\n             \r\n-            $donemSql = \"SELECT donem_adi FROM digiturk.bayi_hakedis_prim_donem WHERE id IN ($placeholders)\";\r\n-            $donemStmt = $conn->prepare($donemSql);\r\n-            $donemStmt->execute($donemIds);\r\n-            $donemAdilar = $donemStmt->fetchAll(PDO::FETCH_COLUMN);\r\n-            \r\n-            $hakedis['donem_adi'] = implode(', ', $donemAdilar);\r\n-            $hakedis['donemIds'] = $donemIds;\r\n-            \r\n-            // Debug log\r\n-            error_log(\"Hakediş ID {$hakedis['id']} - Dönem IDs: \" . $hakedis['bayi_hakedis_prim_donem_id']);\r\n-            error_log(\"Parse edilen IDs: \" . print_r($donemIds, true));\r\n+            if (!empty($donemIds)) {\r\n+                $placeholders = str_repeat('?,', count($donemIds) - 1) . '?';\r\n+                $donemSql = \"SELECT donem_adi FROM digiturk.bayi_hakedis_prim_donem WHERE id IN ($placeholders)\";\r\n+                $donemStmt = $conn->prepare($donemSql);\r\n+                $donemStmt->execute($donemIds);\r\n+                $donemAdilar = $donemStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+                \r\n+                $hakedisler[$i]['donem_adi'] = implode(', ', $donemAdilar);\r\n+                $hakedisler[$i]['donemIds'] = $donemIds;\r\n+            } else {\r\n+                $hakedisler[$i]['donem_adi'] = 'Dönem Seçilmemiş';\r\n+                $hakedisler[$i]['donemIds'] = [];\r\n+            }\r\n         } else {\r\n-            $hakedis['donem_adi'] = 'Dönem Seçilmemiş';\r\n-            $hakedis['donemIds'] = [];\r\n+            $hakedisler[$i]['donem_adi'] = 'Dönem Seçilmemiş';\r\n+            $hakedisler[$i]['donemIds'] = [];\r\n         }\r\n     }\r\n     \r\n+    // FINAL: Son duplikasyon kontrolü\r\n+    $finalUnique = [];\r\n+    foreach ($hakedisler as $hakedis) {\r\n+        $finalUnique[$hakedis['id']] = $hakedis;\r\n+    }\r\n+    $hakedisler = array_values($finalUnique);\r\n+    \r\n } catch (Exception $e) {\r\n     $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n }\r\n \r\n@@ -588,12 +608,16 @@\n                         </tr>\r\n                     </thead>\r\n                     <tbody>\r\n                         <?php if (!empty($hakedisler)): ?>\r\n+                            <?php $siraNo = 1; ?>\r\n                             <?php foreach ($hakedisler as $hakedis): ?>\r\n                                 <tr>\r\n-                                    <td><?php echo $hakedis['id']; ?></td>\r\n                                     <td>\r\n+                                        <?php echo $hakedis['id']; ?>\r\n+                                        <br><small class=\"text-muted\">Sıra: <?php echo $siraNo; ?></small>\r\n+                                    </td>\r\n+                                    <td>\r\n                                         <strong><?php echo htmlspecialchars($hakedis['first_name'] . ' ' . $hakedis['last_name']); ?></strong>\r\n                                         <br><small class=\"text-muted\"><?php echo htmlspecialchars($hakedis['email']); ?></small>\r\n                                     </td>\r\n                                     <td>\r\n@@ -638,8 +662,9 @@\n                                             </button>\r\n                                         </div>\r\n                                     </td>\r\n                                 </tr>\r\n+                                <?php $siraNo++; ?>\r\n                             <?php endforeach; ?>\r\n                         <?php else: ?>\r\n                             <tr>\r\n                                 <td colspan=\"9\" class=\"text-center py-5 text-muted\">\r\n"
                },
                {
                    "date": 1760533073255,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -592,19 +592,35 @@\n             </h5>\r\n         </div>\r\n         <div class=\"card-body p-0\">\r\n             <div class=\"table-responsive\">\r\n-                <table class=\"table table-hover mb-0\">\r\n+                <table class=\"table table-hover mb-0\" id=\"hakedisTable\">\r\n                     <thead class=\"table-light\">\r\n                         <tr>\r\n-                            <th>ID</th>\r\n-                            <th>Bayi</th>\r\n-                            <th>ISP Neo Fiyat</th>\r\n-                            <th>ISP Uydu Fiyat</th>\r\n-                            <th>Neo Fiyat</th>\r\n-                            <th>Uydu Fiyat</th>\r\n-                            <th>Dönem</th>\r\n-                            <th>Açıklama</th>\r\n+                            <th class=\"sortable\" data-column=\"0\">\r\n+                                ID <i class=\"fas fa-sort ms-1\"></i>\r\n+                            </th>\r\n+                            <th class=\"sortable\" data-column=\"1\">\r\n+                                Bayi <i class=\"fas fa-sort ms-1\"></i>\r\n+                            </th>\r\n+                            <th class=\"sortable\" data-column=\"2\">\r\n+                                ISP Neo Fiyat <i class=\"fas fa-sort ms-1\"></i>\r\n+                            </th>\r\n+                            <th class=\"sortable\" data-column=\"3\">\r\n+                                ISP Uydu Fiyat <i class=\"fas fa-sort ms-1\"></i>\r\n+                            </th>\r\n+                            <th class=\"sortable\" data-column=\"4\">\r\n+                                Neo Fiyat <i class=\"fas fa-sort ms-1\"></i>\r\n+                            </th>\r\n+                            <th class=\"sortable\" data-column=\"5\">\r\n+                                Uydu Fiyat <i class=\"fas fa-sort ms-1\"></i>\r\n+                            </th>\r\n+                            <th class=\"sortable\" data-column=\"6\">\r\n+                                Dönem <i class=\"fas fa-sort ms-1\"></i>\r\n+                            </th>\r\n+                            <th class=\"sortable\" data-column=\"7\">\r\n+                                Açıklama <i class=\"fas fa-sort ms-1\"></i>\r\n+                            </th>\r\n                             <th>İşlemler</th>\r\n                         </tr>\r\n                     </thead>\r\n                     <tbody>\r\n@@ -631,12 +647,17 @@\n                                     </td>\r\n                                     <td>\r\n                                         <?php echo $hakedis['uydu_fiyat'] ? number_format($hakedis['uydu_fiyat'], 2) . ' ₺' : '-'; ?>\r\n                                     </td>\r\n-                                    <td>\r\n-                                        <span class=\"badge bg-info\">\r\n-                                            <?php echo htmlspecialchars($hakedis['donem_adi'] ?? 'Dönem Tanımlanmamış'); ?>\r\n-                                        </span>\r\n+                                    <td style=\"max-width: 200px;\">\r\n+                                        <div class=\"donem-content\" \r\n+                                             data-bs-toggle=\"tooltip\" \r\n+                                             data-bs-placement=\"top\" \r\n+                                             title=\"<?php echo htmlspecialchars($hakedis['donem_adi'] ?? 'Dönem Tanımlanmamış'); ?>\">\r\n+                                            <span class=\"badge bg-info text-truncate d-inline-block\" style=\"max-width: 180px;\">\r\n+                                                <?php echo htmlspecialchars($hakedis['donem_adi'] ?? 'Dönem Tanımlanmamış'); ?>\r\n+                                            </span>\r\n+                                        </div>\r\n                                     </td>\r\n                                     <td>\r\n                                         <span class=\"text-muted\" title=\"<?php echo htmlspecialchars($hakedis['aciklama'] ?? ''); ?>\">\r\n                                             <?php \r\n@@ -815,8 +836,66 @@\n \r\n .border.rounded {\r\n     border-color: #dee2e6 !important;\r\n }\r\n+\r\n+/* Tablo sıralama stilleri */\r\n+.sortable {\r\n+    cursor: pointer;\r\n+    user-select: none;\r\n+    position: relative;\r\n+    transition: background-color 0.2s ease;\r\n+}\r\n+\r\n+.sortable:hover {\r\n+    background-color: #e9ecef !important;\r\n+}\r\n+\r\n+.sortable i {\r\n+    opacity: 0.5;\r\n+    transition: opacity 0.2s ease;\r\n+}\r\n+\r\n+.sortable:hover i {\r\n+    opacity: 1;\r\n+}\r\n+\r\n+.sortable.asc i:before {\r\n+    content: \"\\f0de\"; /* fa-sort-up */\r\n+    color: #0d6efd;\r\n+    opacity: 1;\r\n+}\r\n+\r\n+.sortable.desc i:before {\r\n+    content: \"\\f0dd\"; /* fa-sort-down */\r\n+    color: #0d6efd;\r\n+    opacity: 1;\r\n+}\r\n+\r\n+/* Dönem sütunu için özel stil */\r\n+.donem-content {\r\n+    white-space: nowrap;\r\n+    overflow: hidden;\r\n+}\r\n+\r\n+.text-truncate {\r\n+    text-overflow: ellipsis;\r\n+}\r\n+\r\n+/* Responsive tablo için mobil görünüm */\r\n+@media (max-width: 768px) {\r\n+    .table-responsive {\r\n+        font-size: 0.85rem;\r\n+    }\r\n+    \r\n+    .table th, .table td {\r\n+        padding: 0.5rem 0.25rem;\r\n+    }\r\n+    \r\n+    .btn-group .btn {\r\n+        padding: 0.25rem 0.5rem;\r\n+    }\r\n+}\r\n </style>\r\n \r\n <script>\r\n // DOM yüklendikten sonra çalışacak\r\n@@ -844,8 +923,92 @@\n                 return false;\r\n             }\r\n         });\r\n     }\r\n+    \r\n+    // Tooltip'leri etkinleştir\r\n+    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle=\"tooltip\"]'));\r\n+    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {\r\n+        return new bootstrap.Tooltip(tooltipTriggerEl);\r\n+    });\r\n+    \r\n+    // Tablo sıralama özelliği\r\n+    initTableSorting();\r\n });\r\n+\r\n+// Tablo sıralama fonksiyonları\r\n+function initTableSorting() {\r\n+    const table = document.querySelector('#hakedisTable');\r\n+    const headers = table.querySelectorAll('.sortable');\r\n+    \r\n+    headers.forEach(header => {\r\n+        header.addEventListener('click', function() {\r\n+            const column = parseInt(this.dataset.column);\r\n+            const currentSort = this.classList.contains('asc') ? 'asc' : this.classList.contains('desc') ? 'desc' : 'none';\r\n+            \r\n+            // Tüm header'lardan sıralama classlarını kaldır\r\n+            headers.forEach(h => h.classList.remove('asc', 'desc'));\r\n+            \r\n+            // Yeni sıralama yönünü belirle\r\n+            let newSort;\r\n+            if (currentSort === 'none' || currentSort === 'desc') {\r\n+                newSort = 'asc';\r\n+            } else {\r\n+                newSort = 'desc';\r\n+            }\r\n+            \r\n+            this.classList.add(newSort);\r\n+            sortTable(column, newSort);\r\n+        });\r\n+    });\r\n+}\r\n+\r\n+function sortTable(column, direction) {\r\n+    const table = document.querySelector('#hakedisTable tbody');\r\n+    const rows = Array.from(table.querySelectorAll('tr'));\r\n+    \r\n+    // Boş satır kontrolü (henüz veri yoksa)\r\n+    if (rows.length === 1 && rows[0].querySelector('td[colspan]')) {\r\n+        return;\r\n+    }\r\n+    \r\n+    rows.sort((a, b) => {\r\n+        const aCell = a.children[column];\r\n+        const bCell = b.children[column];\r\n+        \r\n+        let aValue = '';\r\n+        let bValue = '';\r\n+        \r\n+        // Hücre içeriğini al\r\n+        if (column === 0) { // ID sütunu\r\n+            aValue = parseInt(aCell.textContent.trim()) || 0;\r\n+            bValue = parseInt(bCell.textContent.trim()) || 0;\r\n+        } else if (column >= 2 && column <= 5) { // Fiyat sütunları\r\n+            // Fiyat değerini al (₺ işaretini kaldır)\r\n+            const aText = aCell.textContent.replace(/[₺,\\s]/g, '').replace('-', '0');\r\n+            const bText = bCell.textContent.replace(/[₺,\\s]/g, '').replace('-', '0');\r\n+            aValue = parseFloat(aText) || 0;\r\n+            bValue = parseFloat(bText) || 0;\r\n+        } else {\r\n+            // Metin sütunları\r\n+            aValue = aCell.textContent.trim().toLowerCase();\r\n+            bValue = bCell.textContent.trim().toLowerCase();\r\n+        }\r\n+        \r\n+        // Sıralama karşılaştırması\r\n+        if (typeof aValue === 'number' && typeof bValue === 'number') {\r\n+            return direction === 'asc' ? aValue - bValue : bValue - aValue;\r\n+        } else {\r\n+            if (direction === 'asc') {\r\n+                return aValue.localeCompare(bValue, 'tr');\r\n+            } else {\r\n+                return bValue.localeCompare(aValue, 'tr');\r\n+            }\r\n+        }\r\n+    });\r\n+    \r\n+    // Sıralanmış satırları tabloya ekle\r\n+    rows.forEach(row => table.appendChild(row));\r\n+}\r\n </script>\r\n \r\n <?php include 'includes/footer.php'; ?>\n\\ No newline at end of file\n"
                },
                {
                    "date": 1760537244918,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -257,8 +257,48 @@\n } catch (Exception $e) {\r\n     $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n }\r\n \r\n+// Filtre dropdown'ları için benzersiz değerleri topla\r\n+$filterData = [\r\n+    'bayiler' => [],\r\n+    'donemler' => [],\r\n+    'fiyat_araliklari' => [\r\n+        '0-100' => '0 - 100 ₺',\r\n+        '100-500' => '100 - 500 ₺', \r\n+        '500-1000' => '500 - 1000 ₺',\r\n+        '1000-5000' => '1000 - 5000 ₺',\r\n+        '5000+' => '5000+ ₺'\r\n+    ]\r\n+];\r\n+\r\n+// Benzersiz bayi isimlerini topla\r\n+foreach ($hakedisler as $hakedis) {\r\n+    $bayiKey = $hakedis['bayi_id'];\r\n+    $bayiName = $hakedis['first_name'] . ' ' . $hakedis['last_name'];\r\n+    if (!isset($filterData['bayiler'][$bayiKey])) {\r\n+        $filterData['bayiler'][$bayiKey] = $bayiName;\r\n+    }\r\n+}\r\n+\r\n+// Benzersiz dönem isimlerini topla\r\n+foreach ($hakedisler as $hakedis) {\r\n+    if (!empty($hakedis['donem_adi'])) {\r\n+        $donemIds = explode(',', $hakedis['bayi_hakedis_prim_donem_id']);\r\n+        $donemAdilar = explode(', ', $hakedis['donem_adi']);\r\n+        \r\n+        for ($i = 0; $i < count($donemIds); $i++) {\r\n+            if (isset($donemAdilar[$i])) {\r\n+                $donemKey = trim($donemIds[$i]);\r\n+                $donemAdi = trim($donemAdilar[$i]);\r\n+                if (!isset($filterData['donemler'][$donemKey])) {\r\n+                    $filterData['donemler'][$donemKey] = $donemAdi;\r\n+                }\r\n+            }\r\n+        }\r\n+    }\r\n+}\r\n+\r\n include 'includes/header.php';\r\n ?>\r\n \r\n <script>\r\n@@ -585,12 +625,20 @@\n     <?php endif; ?>\r\n \r\n     <!-- Hakediş Tanımları Tablosu -->\r\n     <div class=\"card border-0 shadow-sm\">\r\n-        <div class=\"card-header bg-primary text-white\">\r\n+        <div class=\"card-header bg-primary text-white d-flex justify-content-between align-items-center\">\r\n             <h5 class=\"mb-0\">\r\n                 <i class=\"fas fa-list me-2\"></i>Hakediş Tanım Listesi (<?php echo count($hakedisler); ?> kayıt)\r\n             </h5>\r\n+            <div class=\"d-flex align-items-center\">\r\n+                <small class=\"me-3\">\r\n+                    <i class=\"fas fa-filter me-1\"></i>Filtreler aktif\r\n+                </small>\r\n+                <button type=\"button\" class=\"btn btn-sm btn-light\" onclick=\"clearAllFilters()\" title=\"Tüm Filtreleri Temizle\">\r\n+                    <i class=\"fas fa-times me-1\"></i>Temizle\r\n+                </button>\r\n+            </div>\r\n         </div>\r\n         <div class=\"card-body p-0\">\r\n             <div class=\"table-responsive\">\r\n                 <table class=\"table table-hover mb-0\" id=\"hakedisTable\">\r\n@@ -621,8 +669,97 @@\n                                 Açıklama <i class=\"fas fa-sort ms-1\"></i>\r\n                             </th>\r\n                             <th>İşlemler</th>\r\n                         </tr>\r\n+                        <tr class=\"filter-row\">\r\n+                            <th>\r\n+                                <select class=\"form-select form-select-sm table-filter\" data-column=\"0\">\r\n+                                    <option value=\"\">Tüm ID'ler</option>\r\n+                                    <?php \r\n+                                    $uniqueIds = array_unique(array_column($hakedisler, 'id'));\r\n+                                    sort($uniqueIds);\r\n+                                    foreach ($uniqueIds as $id): \r\n+                                    ?>\r\n+                                        <option value=\"<?php echo $id; ?>\">\r\n+                                            ID: <?php echo $id; ?>\r\n+                                        </option>\r\n+                                    <?php endforeach; ?>\r\n+                                </select>\r\n+                            </th>\r\n+                            <th>\r\n+                                <select class=\"form-select form-select-sm table-filter\" data-column=\"1\">\r\n+                                    <option value=\"\">Tüm Bayiler</option>\r\n+                                    <?php foreach ($filterData['bayiler'] as $bayiId => $bayiName): ?>\r\n+                                        <option value=\"<?php echo $bayiId; ?>\">\r\n+                                            <?php echo htmlspecialchars($bayiName); ?>\r\n+                                        </option>\r\n+                                    <?php endforeach; ?>\r\n+                                </select>\r\n+                            </th>\r\n+                            <th>\r\n+                                <select class=\"form-select form-select-sm table-filter\" data-column=\"2\">\r\n+                                    <option value=\"\">Tüm Fiyatlar</option>\r\n+                                    <?php foreach ($filterData['fiyat_araliklari'] as $range => $label): ?>\r\n+                                        <option value=\"<?php echo $range; ?>\">\r\n+                                            <?php echo $label; ?>\r\n+                                        </option>\r\n+                                    <?php endforeach; ?>\r\n+                                </select>\r\n+                            </th>\r\n+                            <th>\r\n+                                <select class=\"form-select form-select-sm table-filter\" data-column=\"3\">\r\n+                                    <option value=\"\">Tüm Fiyatlar</option>\r\n+                                    <?php foreach ($filterData['fiyat_araliklari'] as $range => $label): ?>\r\n+                                        <option value=\"<?php echo $range; ?>\">\r\n+                                            <?php echo $label; ?>\r\n+                                        </option>\r\n+                                    <?php endforeach; ?>\r\n+                                </select>\r\n+                            </th>\r\n+                            <th>\r\n+                                <select class=\"form-select form-select-sm table-filter\" data-column=\"4\">\r\n+                                    <option value=\"\">Tüm Fiyatlar</option>\r\n+                                    <?php foreach ($filterData['fiyat_araliklari'] as $range => $label): ?>\r\n+                                        <option value=\"<?php echo $range; ?>\">\r\n+                                            <?php echo $label; ?>\r\n+                                        </option>\r\n+                                    <?php endforeach; ?>\r\n+                                </select>\r\n+                            </th>\r\n+                            <th>\r\n+                                <select class=\"form-select form-select-sm table-filter\" data-column=\"5\">\r\n+                                    <option value=\"\">Tüm Fiyatlar</option>\r\n+                                    <?php foreach ($filterData['fiyat_araliklari'] as $range => $label): ?>\r\n+                                        <option value=\"<?php echo $range; ?>\">\r\n+                                            <?php echo $label; ?>\r\n+                                        </option>\r\n+                                    <?php endforeach; ?>\r\n+                                </select>\r\n+                            </th>\r\n+                            <th>\r\n+                                <select class=\"form-select form-select-sm table-filter\" data-column=\"6\">\r\n+                                    <option value=\"\">Tüm Dönemler</option>\r\n+                                    <?php foreach ($filterData['donemler'] as $donemId => $donemAdi): ?>\r\n+                                        <option value=\"<?php echo $donemId; ?>\">\r\n+                                            <?php echo htmlspecialchars($donemAdi); ?>\r\n+                                        </option>\r\n+                                    <?php endforeach; ?>\r\n+                                </select>\r\n+                            </th>\r\n+                            <th>\r\n+                                <select class=\"form-select form-select-sm table-filter\" data-column=\"7\">\r\n+                                    <option value=\"\">Tüm Açıklamalar</option>\r\n+                                    <option value=\"has_description\">Açıklaması Var</option>\r\n+                                    <option value=\"no_description\">Açıklaması Yok</option>\r\n+                                </select>\r\n+                            </th>\r\n+                            <th>\r\n+                                <button type=\"button\" class=\"btn btn-sm btn-outline-secondary\" \r\n+                                        onclick=\"clearAllFilters()\" title=\"Filtreleri Temizle\">\r\n+                                    <i class=\"fas fa-times\"></i>\r\n+                                </button>\r\n+                            </th>\r\n+                        </tr>\r\n                     </thead>\r\n                     <tbody>\r\n                         <?php if (!empty($hakedisler)): ?>\r\n                             <?php $siraNo = 1; ?>\r\n@@ -880,8 +1017,51 @@\n .text-truncate {\r\n     text-overflow: ellipsis;\r\n }\r\n \r\n+/* Filtre satırı stilleri */\r\n+.filter-row th {\r\n+    padding: 0.5rem;\r\n+    background-color: #f8f9fa !important;\r\n+    border-top: 1px solid #dee2e6;\r\n+}\r\n+\r\n+.table-filter {\r\n+    font-size: 0.8rem;\r\n+    border: 1px solid #ced4da;\r\n+    height: 32px;\r\n+}\r\n+\r\n+.table-filter:focus {\r\n+    border-color: #0d6efd;\r\n+    box-shadow: 0 0 0 0.1rem rgba(13, 110, 253, 0.25);\r\n+}\r\n+\r\n+/* Aktif filtre göstergesi */\r\n+.table-filter.has-value {\r\n+    background-color: #e7f3ff;\r\n+    border-color: #0d6efd;\r\n+    font-weight: 500;\r\n+}\r\n+\r\n+.table-filter.has-value option:first-child {\r\n+    font-weight: bold;\r\n+    color: #0d6efd;\r\n+}\r\n+\r\n+/* Dropdown ok işareti özelleştirme */\r\n+.table-filter {\r\n+    background-image: url(\"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e\");\r\n+    background-repeat: no-repeat;\r\n+    background-position: right 0.75rem center;\r\n+    background-size: 16px 12px;\r\n+}\r\n+\r\n+/* Gizli satır sınıfı */\r\n+.filtered-hidden {\r\n+    display: none !important;\r\n+}\r\n+\r\n /* Responsive tablo için mobil görünüm */\r\n @media (max-width: 768px) {\r\n     .table-responsive {\r\n         font-size: 0.85rem;\r\n@@ -893,8 +1073,16 @@\n     \r\n     .btn-group .btn {\r\n         padding: 0.25rem 0.5rem;\r\n     }\r\n+    \r\n+    .filter-row th {\r\n+        padding: 0.25rem;\r\n+    }\r\n+    \r\n+    .table-filter {\r\n+        font-size: 0.75rem;\r\n+    }\r\n }\r\n </style>\r\n \r\n <script>\r\n@@ -932,10 +1120,216 @@\n     });\r\n     \r\n     // Tablo sıralama özelliği\r\n     initTableSorting();\r\n+    \r\n+    // Tablo filtreleme özelliği\r\n+    initTableFiltering();\r\n });\r\n \r\n+// Tablo filtreleme fonksiyonları\r\n+function initTableFiltering() {\r\n+    const filterSelects = document.querySelectorAll('.table-filter');\r\n+    \r\n+    filterSelects.forEach(select => {\r\n+        select.addEventListener('change', function() {\r\n+            // Aktif filtre göstergesi\r\n+            if (this.value) {\r\n+                this.classList.add('has-value');\r\n+            } else {\r\n+                this.classList.remove('has-value');\r\n+            }\r\n+            \r\n+            // Filtreleme işlemini gerçekleştir\r\n+            applyTableFilters();\r\n+        });\r\n+    });\r\n+}\r\n+\r\n+function applyTableFilters() {\r\n+    const table = document.querySelector('#hakedisTable tbody');\r\n+    const rows = table.querySelectorAll('tr');\r\n+    const filterSelects = document.querySelectorAll('.table-filter');\r\n+    \r\n+    // Filtre değerlerini al\r\n+    const filters = {};\r\n+    filterSelects.forEach(select => {\r\n+        const column = parseInt(select.dataset.column);\r\n+        const value = select.value.trim();\r\n+        if (value) {\r\n+            filters[column] = value;\r\n+        }\r\n+    });\r\n+    \r\n+    let visibleRowCount = 0;\r\n+    \r\n+    rows.forEach(row => {\r\n+        // Boş satır kontrolü (veri yoksa)\r\n+        if (row.querySelector('td[colspan]')) {\r\n+            return;\r\n+        }\r\n+        \r\n+        let shouldShow = true;\r\n+        \r\n+        // Her filtre için kontrol et\r\n+        Object.keys(filters).forEach(columnIndex => {\r\n+            const filterValue = filters[columnIndex];\r\n+            const cell = row.children[columnIndex];\r\n+            const column = parseInt(columnIndex);\r\n+            \r\n+            if (!cell) return;\r\n+            \r\n+            if (column === 0) { // ID sütunu\r\n+                const cellId = cell.textContent.trim().split('\\n')[0]; // Sadece ID'yi al\r\n+                if (cellId !== filterValue) {\r\n+                    shouldShow = false;\r\n+                }\r\n+            } else if (column === 1) { // Bayi sütunu\r\n+                // Bayi ID'sini row data'sından al\r\n+                const editButton = row.querySelector('button[data-hakedis]');\r\n+                if (editButton) {\r\n+                    try {\r\n+                        const hakedisData = JSON.parse(editButton.getAttribute('data-hakedis'));\r\n+                        if (hakedisData.bayi_id != filterValue) {\r\n+                            shouldShow = false;\r\n+                        }\r\n+                    } catch (e) {\r\n+                        shouldShow = false;\r\n+                    }\r\n+                } else {\r\n+                    shouldShow = false;\r\n+                }\r\n+            } else if (column >= 2 && column <= 5) { // Fiyat sütunları\r\n+                const priceText = cell.textContent.replace(/[₺,\\s-]/g, '');\r\n+                const price = parseFloat(priceText) || 0;\r\n+                \r\n+                // Fiyat aralığı kontrolü\r\n+                if (!checkPriceRange(price, filterValue)) {\r\n+                    shouldShow = false;\r\n+                }\r\n+            } else if (column === 6) { // Dönem sütunu\r\n+                // Dönem ID'lerini kontrol et\r\n+                const editButton = row.querySelector('button[data-hakedis]');\r\n+                if (editButton) {\r\n+                    try {\r\n+                        const hakedisData = JSON.parse(editButton.getAttribute('data-hakedis'));\r\n+                        const donemIds = hakedisData.bayi_hakedis_prim_donem_id ? \r\n+                            hakedisData.bayi_hakedis_prim_donem_id.toString().split(',') : [];\r\n+                        \r\n+                        if (!donemIds.some(id => id.trim() === filterValue)) {\r\n+                            shouldShow = false;\r\n+                        }\r\n+                    } catch (e) {\r\n+                        shouldShow = false;\r\n+                    }\r\n+                } else {\r\n+                    shouldShow = false;\r\n+                }\r\n+            } else if (column === 7) { // Açıklama sütunu\r\n+                const span = cell.querySelector('span[title]');\r\n+                const aciklama = span ? span.getAttribute('title') : cell.textContent.trim();\r\n+                \r\n+                if (filterValue === 'has_description' && (!aciklama || aciklama === '-')) {\r\n+                    shouldShow = false;\r\n+                } else if (filterValue === 'no_description' && aciklama && aciklama !== '-') {\r\n+                    shouldShow = false;\r\n+                }\r\n+            }\r\n+        });\r\n+        \r\n+        // Satırı göster/gizle\r\n+        if (shouldShow) {\r\n+            row.classList.remove('filtered-hidden');\r\n+            visibleRowCount++;\r\n+        } else {\r\n+            row.classList.add('filtered-hidden');\r\n+        }\r\n+    });\r\n+    \r\n+    // Sonuç sayısını güncelle\r\n+    updateFilterResultsInfo(visibleRowCount, rows.length);\r\n+}\r\n+\r\n+function checkPriceRange(price, range) {\r\n+    switch (range) {\r\n+        case '0-100':\r\n+            return price >= 0 && price <= 100;\r\n+        case '100-500':\r\n+            return price > 100 && price <= 500;\r\n+        case '500-1000':\r\n+            return price > 500 && price <= 1000;\r\n+        case '1000-5000':\r\n+            return price > 1000 && price <= 5000;\r\n+        case '5000+':\r\n+            return price > 5000;\r\n+        default:\r\n+            return true;\r\n+    }\r\n+}\r\n+\r\n+function clearAllFilters() {\r\n+    const filterSelects = document.querySelectorAll('.table-filter');\r\n+    const rows = document.querySelectorAll('#hakedisTable tbody tr');\r\n+    \r\n+    // Tüm dropdown'ları temizle\r\n+    filterSelects.forEach(select => {\r\n+        select.value = '';\r\n+        select.classList.remove('has-value');\r\n+    });\r\n+    \r\n+    // Tüm satırları göster\r\n+    rows.forEach(row => {\r\n+        row.classList.remove('filtered-hidden');\r\n+    });\r\n+    \r\n+    // Sonuç sayısını güncelle\r\n+    const visibleRows = rows.length;\r\n+    updateFilterResultsInfo(visibleRows, visibleRows);\r\n+}\r\n+\r\n+function updateFilterResultsInfo(visibleCount, totalCount) {\r\n+    // Kart başlığındaki kayıt sayısını güncelle\r\n+    const cardHeader = document.querySelector('.card-header h5');\r\n+    if (cardHeader) {\r\n+        const baseText = 'Hakediş Tanım Listesi';\r\n+        if (visibleCount === totalCount) {\r\n+            cardHeader.innerHTML = `<i class=\"fas fa-list me-2\"></i>${baseText} (${totalCount} kayıt)`;\r\n+        } else {\r\n+            cardHeader.innerHTML = `<i class=\"fas fa-list me-2\"></i>${baseText} (${visibleCount}/${totalCount} kayıt)`;\r\n+        }\r\n+    }\r\n+    \r\n+    // Eğer hiç sonuç yoksa bilgi mesajı göster\r\n+    showNoResultsMessage(visibleCount, totalCount);\r\n+}\r\n+\r\n+function showNoResultsMessage(visibleCount, totalCount) {\r\n+    const tbody = document.querySelector('#hakedisTable tbody');\r\n+    let noResultsRow = tbody.querySelector('.no-results-row');\r\n+    \r\n+    // Mevcut \"sonuç yok\" satırını kaldır\r\n+    if (noResultsRow) {\r\n+        noResultsRow.remove();\r\n+    }\r\n+    \r\n+    // Eğer filtre sonucu hiç kayıt yoksa mesaj göster\r\n+    if (visibleCount === 0 && totalCount > 0) {\r\n+        const row = document.createElement('tr');\r\n+        row.className = 'no-results-row';\r\n+        row.innerHTML = `\r\n+            <td colspan=\"9\" class=\"text-center py-4 text-muted\">\r\n+                <i class=\"fas fa-search fa-2x mb-2 d-block\"></i>\r\n+                <h6>Filtreleme sonucu kayıt bulunamadı</h6>\r\n+                <p class=\"mb-2\">Arama kriterlerinizi değiştirerek tekrar deneyin.</p>\r\n+                <button type=\"button\" class=\"btn btn-sm btn-outline-primary\" onclick=\"clearAllFilters()\">\r\n+                    <i class=\"fas fa-times me-1\"></i>Filtreleri Temizle\r\n+                </button>\r\n+            </td>\r\n+        `;\r\n+        tbody.appendChild(row);\r\n+    }\r\n+}\r\n+\r\n // Tablo sıralama fonksiyonları\r\n function initTableSorting() {\r\n     const table = document.querySelector('#hakedisTable');\r\n     const headers = table.querySelectorAll('.sortable');\r\n"
                },
                {
                    "date": 1760977719086,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,30 +7,12 @@\n $breadcrumbs = [\r\n     ['title' => 'Bayi Hakediş Tanımlama']\r\n ];\r\n \r\n-// Auth kontrol - GEÇİCİ OLARAK DEVRE DIŞI\r\n-// require_once 'auth.php';\r\n-// $currentUser = checkAdminAuth();\r\n+// Auth kontrol\r\n+require_once 'auth.php';\r\n+$currentUser = checkAdminAuth();\r\n \r\n-// Geçici veritabanı bağlantısı için\r\n-require_once 'config/mssql.php';\r\n-function getDatabaseConnection() {\r\n-    $config = include 'config/mssql.php';\r\n-    try {\r\n-        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n-        $connection = new PDO($dsn, $config['username'], $config['password'], [\r\n-            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n-            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n-            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n-            PDO::ATTR_EMULATE_PREPARES => false\r\n-        ]);\r\n-        return $connection;\r\n-    } catch (PDOException $e) {\r\n-        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n-    }\r\n-}\r\n-\r\n $message = '';\r\n $messageType = '';\r\n \r\n // Hakediş tanım işlemleri\r\n@@ -49,12 +31,8 @@\n                 $uyduFiyat = !empty($_POST['uydu_fiyat']) ? (float)$_POST['uydu_fiyat'] : null;\r\n                 $donemIds = $_POST['bayi_hakedis_prim_donem_id'] ?? [];\r\n                 $aciklama = trim($_POST['aciklama'] ?? '');\r\n                 \r\n-                // Debug için log\r\n-                error_log(\"ADD - Gelen dönem IDs: \" . print_r($donemIds, true));\r\n-                error_log(\"ADD - POST data: \" . print_r($_POST, true));\r\n-                \r\n                 // Açıklama uzunluk kontrolü\r\n                 if (strlen($aciklama) > 200) {\r\n                     $message = 'Açıklama metni 200 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n                     $messageType = 'danger';\r\n@@ -98,12 +76,8 @@\n                 $uyduFiyat = !empty($_POST['uydu_fiyat']) ? (float)$_POST['uydu_fiyat'] : null;\r\n                 $donemIds = $_POST['bayi_hakedis_prim_donem_id'] ?? [];\r\n                 $aciklama = trim($_POST['aciklama'] ?? '');\r\n                 \r\n-                // Debug için log\r\n-                error_log(\"EDIT CASE 1 - POST data: \" . print_r($_POST, true));\r\n-                error_log(\"EDIT CASE 1 - Dönem IDs: \" . print_r($donemIds, true));\r\n-                \r\n                 // Açıklama uzunluk kontrolü\r\n                 if (strlen($aciklama) > 200) {\r\n                     $message = 'Açıklama metni 200 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n                     $messageType = 'danger';\r\n@@ -144,55 +118,52 @@\n \r\n // Bayileri al\r\n $bayiler = [];\r\n $donemler = [];\r\n-// Veritabanı sorgularında schema prefix'ini ekle - test için\r\n+$isBayiUser = false; // Kullanıcı bayi grubu mu kontrolü\r\n+$bayiUserRestricted = false; // Kullanıcı kısıtlı mı (sadece kendi kaydını görsün)\r\n+\r\n+// Veritabanı sorgularında schema prefix'ini ekle\r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n-    // Test: Dönem tablosunu kontrol et\r\n-    $testSql = \"SELECT COUNT(*) as count FROM digiturk.bayi_hakedis_prim_donem\";\r\n-    $testStmt = $conn->prepare($testSql);\r\n-    $testStmt->execute();\r\n-    $count = $testStmt->fetch(PDO::FETCH_ASSOC);\r\n-    echo \"<!-- DEBUG: digiturk.bayi_hakedis_prim_donem tablosunda toplam kayıt: \" . $count['count'] . \" -->\\n\";\r\n-    error_log(\"digiturk.bayi_hakedis_prim_donem tablosunda toplam kayıt: \" . $count['count']);\r\n-    \r\n-    // Bayiler\r\n-    $bayiGroupSql = \"SELECT id FROM user_groups WHERE group_name IN ('bayi', 'Bayi')\";\r\n-    $bayiGroupStmt = $conn->prepare($bayiGroupSql);\r\n-    $bayiGroupStmt->execute();\r\n-    $bayiGroups = $bayiGroupStmt->fetchAll(PDO::FETCH_COLUMN);\r\n-    \r\n-    if (!empty($bayiGroups)) {\r\n-        $placeholders = str_repeat('?,', count($bayiGroups) - 1) . '?';\r\n+    // Kullanıcı grup kontrolü - user_group_id = 3 olanlar için kısıtlama\r\n+    if (isset($currentUser['group_id']) && $currentUser['group_id'] == 3) {\r\n+        $bayiUserRestricted = true;\r\n+        \r\n+        // Sadece kendi kaydını çek\r\n         $bayiSql = \"SELECT id, first_name, last_name, email \r\n                    FROM users \r\n-                   WHERE user_group_id IN ($placeholders) \r\n-                   AND status = 'AKTIF'\r\n-                   ORDER BY first_name, last_name\";\r\n+                   WHERE id = ? AND status = 'AKTIF'\";\r\n         $bayiStmt = $conn->prepare($bayiSql);\r\n-        $bayiStmt->execute($bayiGroups);\r\n+        $bayiStmt->execute([$currentUser['id']]);\r\n         $bayiler = $bayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+    } else {\r\n+        // Diğer kullanıcılar için tüm bayileri göster\r\n+        $bayiGroupSql = \"SELECT id FROM user_groups WHERE group_name IN ('bayi', 'Bayi')\";\r\n+        $bayiGroupStmt = $conn->prepare($bayiGroupSql);\r\n+        $bayiGroupStmt->execute();\r\n+        $bayiGroups = $bayiGroupStmt->fetchAll(PDO::FETCH_COLUMN);\r\n+        \r\n+        if (!empty($bayiGroups)) {\r\n+            $placeholders = str_repeat('?,', count($bayiGroups) - 1) . '?';\r\n+            $bayiSql = \"SELECT id, first_name, last_name, email \r\n+                       FROM users \r\n+                       WHERE user_group_id IN ($placeholders) \r\n+                       AND status = 'AKTIF'\r\n+                       ORDER BY first_name, last_name\";\r\n+            $bayiStmt = $conn->prepare($bayiSql);\r\n+            $bayiStmt->execute($bayiGroups);\r\n+            $bayiler = $bayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n+        }\r\n     }\r\n     \r\n     // Dönemleri al\r\n     $donemSql = \"SELECT id, donem_adi FROM digiturk.bayi_hakedis_prim_donem WHERE durum = 'AKTIF' ORDER BY id DESC\";\r\n     $donemStmt = $conn->prepare($donemSql);\r\n     $donemStmt->execute();\r\n     $donemler = $donemStmt->fetchAll(PDO::FETCH_ASSOC);\r\n     \r\n-    // Debug: Dönem sayısını kontrol et\r\n-    echo \"<!-- DEBUG: Dönem sayısı: \" . count($donemler) . \" -->\\n\";\r\n-    error_log(\"Dönem sayısı: \" . count($donemler));\r\n-    if (count($donemler) > 0) {\r\n-        echo \"<!-- DEBUG: İlk dönem: \" . print_r($donemler[0], true) . \" -->\\n\";\r\n-        error_log(\"İlk dönem: \" . print_r($donemler[0], true));\r\n-    } else {\r\n-        echo \"<!-- DEBUG: Hiç dönem bulunamadı! -->\\n\";\r\n-        error_log(\"HATA: Hiç dönem bulunamadı!\");\r\n-    }\r\n-    \r\n } catch (Exception $e) {\r\n     // Hata durumunda boş array kalacak\r\n }\r\n \r\n@@ -200,15 +171,26 @@\n $hakedisler = [];\r\n try {\r\n     $conn = getDatabaseConnection();\r\n     \r\n-    $sql = \"SELECT DISTINCT ht.*, u.first_name, u.last_name, u.email\r\n-            FROM hakedis_tanim ht\r\n-            INNER JOIN users u ON ht.bayi_id = u.id\r\n-            ORDER BY ht.created_at DESC\";\r\n+    // User group ID:3 ise sadece kendi kayıtlarını getir\r\n+    if ($bayiUserRestricted) {\r\n+        $sql = \"SELECT DISTINCT ht.*, u.first_name, u.last_name, u.email\r\n+                FROM hakedis_tanim ht\r\n+                INNER JOIN users u ON ht.bayi_id = u.id\r\n+                WHERE ht.bayi_id = ?\r\n+                ORDER BY ht.created_at DESC\";\r\n+        $stmt = $conn->prepare($sql);\r\n+        $stmt->execute([$currentUser['id']]);\r\n+    } else {\r\n+        $sql = \"SELECT DISTINCT ht.*, u.first_name, u.last_name, u.email\r\n+                FROM hakedis_tanim ht\r\n+                INNER JOIN users u ON ht.bayi_id = u.id\r\n+                ORDER BY ht.created_at DESC\";\r\n+        $stmt = $conn->prepare($sql);\r\n+        $stmt->execute();\r\n+    }\r\n     \r\n-    $stmt = $conn->prepare($sql);\r\n-    $stmt->execute();\r\n     $hakedislerRaw = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n     \r\n     // İlk duplikasyon temizleme - ID'ye göre benzersiz kayıtlar\r\n     $uniqueHakedisler = [];\r\n@@ -274,10 +256,18 @@\n // Benzersiz bayi isimlerini topla\r\n foreach ($hakedisler as $hakedis) {\r\n     $bayiKey = $hakedis['bayi_id'];\r\n     $bayiName = $hakedis['first_name'] . ' ' . $hakedis['last_name'];\r\n-    if (!isset($filterData['bayiler'][$bayiKey])) {\r\n-        $filterData['bayiler'][$bayiKey] = $bayiName;\r\n+    \r\n+    // Eğer kullanıcı kısıtlı ise sadece kendi kaydını ekle\r\n+    if ($bayiUserRestricted) {\r\n+        if ($bayiKey == $currentUser['id']) {\r\n+            $filterData['bayiler'][$bayiKey] = $bayiName;\r\n+        }\r\n+    } else {\r\n+        if (!isset($filterData['bayiler'][$bayiKey])) {\r\n+            $filterData['bayiler'][$bayiKey] = $bayiName;\r\n+        }\r\n     }\r\n }\r\n \r\n // Benzersiz dönem isimlerini topla\r\n@@ -303,9 +293,8 @@\n \r\n <script>\r\n // JavaScript fonksiyonlarını sayfanın başında tanımla\r\n function editHakedisFromButton(button) {\r\n-    console.log('editHakedisFromButton çağrıldı');\r\n     try {\r\n         const hakedisData = button.getAttribute('data-hakedis');\r\n         if (!hakedisData) {\r\n             console.error('Hakedis data bulunamadı');\r\n@@ -316,28 +305,34 @@\n         const hakedis = JSON.parse(hakedisData);\r\n         editHakedis(hakedis);\r\n     } catch (error) {\r\n         console.error('JSON parse hatası:', error);\r\n-        console.error('Data:', button.getAttribute('data-hakedis'));\r\n         alert('Veri okuma hatası. Sayfayı yenileyin ve tekrar deneyin.');\r\n     }\r\n }\r\n \r\n function validateForm() {\r\n     // Bayi seçimi kontrolü\r\n-    const bayiId = document.getElementById('bayi_id') ? document.getElementById('bayi_id').value : '';\r\n+    let bayiId = document.getElementById('bayi_id') ? document.getElementById('bayi_id').value : '';\r\n+    \r\n+    // Eğer dropdown disabled ise hidden input'tan değeri al\r\n     if (!bayiId) {\r\n+        const hiddenBayiId = document.querySelector('input[type=\"hidden\"][name=\"bayi_id\"]');\r\n+        if (hiddenBayiId) {\r\n+            bayiId = hiddenBayiId.value;\r\n+        }\r\n+    }\r\n+    \r\n+    if (!bayiId) {\r\n         alert('Lütfen bir bayi seçin.');\r\n         return false;\r\n     }\r\n     \r\n     // Dönem seçimi kontrolü\r\n     const checkedDonems = document.querySelectorAll('.donem-checkbox:checked');\r\n-    console.log('Seçili dönem sayısı:', checkedDonems.length);\r\n     \r\n     if (checkedDonems.length === 0) {\r\n         alert('Lütfen en az bir dönem seçin.');\r\n-        console.log('Hata: Hiç dönem seçili değil');\r\n         return false;\r\n     }\r\n     \r\n     return true;\r\n@@ -366,9 +361,8 @@\n     }\r\n }\r\n \r\n function openNewModal() {\r\n-    console.log('Yeni modal açılıyor...');\r\n     const modal = document.getElementById('addHakedisModal');\r\n     \r\n     if (!modal) {\r\n         console.error('Modal bulunamadı!');\r\n@@ -383,12 +377,10 @@\n     try {\r\n         if (typeof bootstrap !== 'undefined') {\r\n             const bootstrapModal = new bootstrap.Modal(modal);\r\n             bootstrapModal.show();\r\n-            console.log('Yeni modal Bootstrap ile açıldı');\r\n         } else {\r\n             // Vanilla JavaScript ile aç\r\n-            console.log('Bootstrap bulunamadı, vanilla JavaScript ile açılıyor...');\r\n             modal.style.display = 'block';\r\n             modal.classList.add('show');\r\n             document.body.classList.add('modal-open');\r\n             \r\n@@ -415,10 +407,8 @@\n                 modal.classList.remove('show');\r\n                 document.body.classList.remove('modal-open');\r\n                 backdrop.remove();\r\n             });\r\n-            \r\n-            console.log('Yeni modal vanilla JavaScript ile açıldı');\r\n         }\r\n     } catch (error) {\r\n         console.error('Modal açılırken hata:', error);\r\n         alert('Modal açılırken bir hata oluştu.');\r\n@@ -433,9 +423,14 @@\n         document.getElementById('modal_icon').className = 'fas fa-plus me-2';\r\n         document.getElementById('modal_submit_text').textContent = 'Kaydet';\r\n         \r\n         // Formu temizle\r\n-        document.getElementById('bayi_id').value = '';\r\n+        const bayiSelect = document.getElementById('bayi_id');\r\n+        if (bayiSelect && !bayiSelect.disabled) {\r\n+            bayiSelect.value = '';\r\n+        }\r\n+        // Hidden input varsa onu temizleme (zaten disabled durumda sabit kalmalı)\r\n+        \r\n         document.getElementById('isp_neo_fiyat').value = '';\r\n         document.getElementById('isp_uydu_fiyat').value = '';\r\n         document.getElementById('neo_fiyat').value = '';\r\n         document.getElementById('uydu_fiyat').value = '';\r\n@@ -477,9 +472,16 @@\n     if (modalIcon) modalIcon.className = 'fas fa-edit me-2';\r\n     if (modalSubmitText) modalSubmitText.textContent = 'Güncelle';\r\n     \r\n     // Modal alanlarını doldur\r\n-    if (bayiIdSelect) bayiIdSelect.value = hakedis.bayi_id;\r\n+    if (bayiIdSelect) {\r\n+        bayiIdSelect.value = hakedis.bayi_id;\r\n+        // Eğer dropdown disabled ise hidden input'u da güncelle\r\n+        const hiddenBayiId = document.querySelector('input[type=\"hidden\"][name=\"bayi_id\"]');\r\n+        if (hiddenBayiId) {\r\n+            hiddenBayiId.value = hakedis.bayi_id;\r\n+        }\r\n+    }\r\n     if (ispNeoFiyat) ispNeoFiyat.value = hakedis.isp_neo_fiyat || '';\r\n     if (ispUyduFiyat) ispUyduFiyat.value = hakedis.isp_uydu_fiyat || '';\r\n     if (neoFiyat) neoFiyat.value = hakedis.neo_fiyat || '';\r\n     if (uyduFiyat) uyduFiyat.value = hakedis.uydu_fiyat || '';\r\n@@ -685,15 +687,21 @@\n                                     <?php endforeach; ?>\r\n                                 </select>\r\n                             </th>\r\n                             <th>\r\n-                                <select class=\"form-select form-select-sm table-filter\" data-column=\"1\">\r\n-                                    <option value=\"\">Tüm Bayiler</option>\r\n-                                    <?php foreach ($filterData['bayiler'] as $bayiId => $bayiName): ?>\r\n-                                        <option value=\"<?php echo $bayiId; ?>\">\r\n-                                            <?php echo htmlspecialchars($bayiName); ?>\r\n+                                <select class=\"form-select form-select-sm table-filter\" data-column=\"1\" <?php echo $bayiUserRestricted ? 'disabled' : ''; ?>>\r\n+                                    <?php if ($bayiUserRestricted && !empty($bayiler)): ?>\r\n+                                        <option value=\"<?php echo $bayiler[0]['id']; ?>\" selected>\r\n+                                            <?php echo htmlspecialchars($bayiler[0]['first_name'] . ' ' . $bayiler[0]['last_name']); ?>\r\n                                         </option>\r\n-                                    <?php endforeach; ?>\r\n+                                    <?php else: ?>\r\n+                                        <option value=\"\">Tüm Bayiler</option>\r\n+                                        <?php foreach ($filterData['bayiler'] as $bayiId => $bayiName): ?>\r\n+                                            <option value=\"<?php echo $bayiId; ?>\">\r\n+                                                <?php echo htmlspecialchars($bayiName); ?>\r\n+                                            </option>\r\n+                                        <?php endforeach; ?>\r\n+                                    <?php endif; ?>\r\n                                 </select>\r\n                             </th>\r\n                             <th>\r\n                                 <select class=\"form-select form-select-sm table-filter\" data-column=\"2\">\r\n@@ -853,17 +861,26 @@\n                     <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                 </div>\r\n                 <div class=\"modal-body\">\r\n                     <div class=\"mb-3\">\r\n-                        <label for=\"bayi_id\" class=\"form-label\">Bayi <span class=\"text-danger\">*</span></label>\r\n-                        <select class=\"form-select\" id=\"bayi_id\" name=\"bayi_id\" required>\r\n-                            <option value=\"\">Bayi Seçin</option>\r\n+                        <label for=\"bayi_id\" class=\"form-label\">Bayi Ad Soyad <span class=\"text-danger\">*</span></label>\r\n+                        <select class=\"form-select\" id=\"bayi_id\" name=\"bayi_id\" required <?php echo $bayiUserRestricted ? 'disabled' : ''; ?>>\r\n+                            <?php if (!$bayiUserRestricted): ?>\r\n+                                <option value=\"\">Bayi Seçin</option>\r\n+                            <?php endif; ?>\r\n                             <?php foreach ($bayiler as $bayi): ?>\r\n-                                <option value=\"<?php echo $bayi['id']; ?>\">\r\n+                                <option value=\"<?php echo $bayi['id']; ?>\" <?php echo $bayiUserRestricted ? 'selected' : ''; ?>>\r\n                                     <?php echo htmlspecialchars($bayi['first_name'] . ' ' . $bayi['last_name'] . ' (' . $bayi['email'] . ')'); ?>\r\n                                 </option>\r\n                             <?php endforeach; ?>\r\n                         </select>\r\n+                        <?php if ($bayiUserRestricted): ?>\r\n+                            <input type=\"hidden\" name=\"bayi_id\" value=\"<?php echo $bayiler[0]['id'] ?? ''; ?>\">\r\n+                            <div class=\"form-text text-info\">\r\n+                                <i class=\"fas fa-info-circle me-1\"></i>\r\n+                                Sadece kendi kayıtlarınızı yönetebilirsiniz.\r\n+                            </div>\r\n+                        <?php endif; ?>\r\n                     </div>\r\n                     \r\n                     <div class=\"row\">\r\n                         <div class=\"col-md-6 mb-3\">\r\n"
                },
                {
                    "date": 1761030997503,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -441,10 +441,8 @@\n     }\r\n }\r\n \r\n function editHakedis(hakedis) {\r\n-    console.log('Edit başlatıldı, hakedis data:', hakedis);\r\n-    \r\n     // DOM elementlerinin varlığını kontrol et\r\n     const modalAction = document.getElementById('modal_action');\r\n     const modalId = document.getElementById('modal_id');\r\n     const modalTitleText = document.getElementById('modal_title_text');\r\n@@ -459,9 +457,8 @@\n     const modal = document.getElementById('addHakedisModal');\r\n     \r\n     // Eğer modal elementleri henüz yüklenmemişse, bekle ve tekrar dene\r\n     if (!modalAction || !modalId || !modalTitleText || !modal) {\r\n-        console.log('Modal elementleri henüz yüklenmemiş, 500ms sonra tekrar denenecek...');\r\n         setTimeout(() => editHakedis(hakedis), 500);\r\n         return;\r\n     }\r\n     \r\n@@ -492,40 +489,27 @@\n     \r\n     // Dönem ID'lerini seç\r\n     if (hakedis.bayi_hakedis_prim_donem_id) {\r\n         const donemIds = hakedis.bayi_hakedis_prim_donem_id.toString().split(',').map(id => id.trim());\r\n-        console.log('Seçilecek dönem IDs:', donemIds);\r\n-        console.log('Mevcut checkbox sayısı:', document.querySelectorAll('.donem-checkbox').length);\r\n         \r\n         donemIds.forEach(donemId => {\r\n             if (donemId) {\r\n                 const checkbox = document.getElementById('donem_' + donemId);\r\n                 if (checkbox) {\r\n                     checkbox.checked = true;\r\n-                    console.log('Dönem seçildi:', donemId, checkbox.value);\r\n-                } else {\r\n-                    console.warn('Checkbox bulunamadı: donem_' + donemId);\r\n-                    // Tüm mevcut checkbox'ları listele\r\n-                    const allCheckboxes = document.querySelectorAll('.donem-checkbox');\r\n-                    console.log('Mevcut checkbox ID\\'leri:');\r\n-                    allCheckboxes.forEach(cb => console.log('- ' + cb.id));\r\n                 }\r\n             }\r\n         });\r\n-    } else {\r\n-        console.log('Hakediş için dönem ID bulunamadı:', hakedis.bayi_hakedis_prim_donem_id);\r\n     }\r\n     \r\n-    // Modal'ı aç - Bootstrap yerine vanilla JavaScript kullan\r\n+    // Modal'ı aç\r\n     try {\r\n         // Bootstrap kontrolü\r\n         if (typeof bootstrap !== 'undefined') {\r\n             const bootstrapModal = new bootstrap.Modal(modal);\r\n             bootstrapModal.show();\r\n-            console.log('Modal Bootstrap ile açıldı');\r\n         } else {\r\n             // Fallback: Modal'ı manuel olarak aç\r\n-            console.log('Bootstrap bulunamadı, vanilla JavaScript ile açılıyor...');\r\n             modal.style.display = 'block';\r\n             modal.classList.add('show');\r\n             document.body.classList.add('modal-open');\r\n             \r\n@@ -534,10 +518,8 @@\n             backdrop.className = 'modal-backdrop fade show';\r\n             backdrop.id = 'temp-backdrop';\r\n             document.body.appendChild(backdrop);\r\n             \r\n-            console.log('Modal vanilla JavaScript ile açıldı');\r\n-            \r\n             // Modal kapat butonu için event listener\r\n             const closeButtons = modal.querySelectorAll('[data-bs-dismiss=\"modal\"]');\r\n             closeButtons.forEach(button => {\r\n                 button.addEventListener('click', function() {\r\n@@ -566,35 +548,18 @@\n \r\n // Global error handler\r\n window.addEventListener('error', function(event) {\r\n     console.error('JavaScript hatası:', event.error);\r\n-    console.error('Hata mesajı:', event.message);\r\n-    console.error('Dosya:', event.filename);\r\n-    console.error('Satır:', event.lineno);\r\n });\r\n \r\n-// Bootstrap kontrolü\r\n-console.log('Bootstrap kontrolü:');\r\n-console.log('- typeof bootstrap:', typeof bootstrap);\r\n-console.log('- Bootstrap version:', typeof bootstrap !== 'undefined' ? bootstrap.Tooltip.VERSION : 'Bootstrap yüklenmemiş');\r\n-\r\n console.log('JavaScript fonksiyonları yüklendi!');\r\n-console.log('editHakedisFromButton:', typeof editHakedisFromButton);\r\n-console.log('editHakedis:', typeof editHakedis);\r\n-console.log('validateForm:', typeof validateForm);\r\n \r\n // DOM yüklendikten sonra dönem checkbox'larını kontrol et\r\n document.addEventListener('DOMContentLoaded', function() {\r\n     const donemCheckboxes = document.querySelectorAll('.donem-checkbox');\r\n-    console.log('Sayfada bulunan dönem checkbox sayısı:', donemCheckboxes.length);\r\n     \r\n     if (donemCheckboxes.length === 0) {\r\n         console.warn('Hiç dönem checkbox bulunamadı! Dönem verileri yüklenmemiş olabilir.');\r\n-    } else {\r\n-        console.log('Bulunan dönem checkbox\\'ları:');\r\n-        donemCheckboxes.forEach((checkbox, index) => {\r\n-            console.log(`${index + 1}. ${checkbox.id} = ${checkbox.value} (${checkbox.nextElementSibling.textContent})`);\r\n-        });\r\n     }\r\n });\r\n </script>\r\n \r\n"
                }
            ],
            "date": 1758977855765,
            "name": "Commit-0",
            "content": "<?php\r\n$pageTitle = \"Bayi Hakediş Tanımlama\";\r\n$breadcrumbs = [\r\n    ['title' => 'Bayi Hakediş Tanımlama']\r\n];\r\n\r\n// Auth kontrol\r\nrequire_once 'auth.php';\r\n$currentUser = checkAdminAuth(); // Sadece admin erişebilir\r\n\r\n// Veritabanı bağlantısı\r\nrequire_once 'MSSQLConnection.php';\r\n\r\n$message = '';\r\n$messageType = '';\r\n\r\n// Hakediş tanım işlemleri\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    try {\r\n        $db = new MSSQLConnection();\r\n        $conn = $db->getConnection();\r\n        \r\n        $action = $_POST['action'] ?? '';\r\n        \r\n        switch ($action) {\r\n            case 'add':\r\n                $bayiId = (int)$_POST['bayi_id'];\r\n                $ispNeoFiyat = !empty($_POST['isp_neo_fiyat']) ? (float)$_POST['isp_neo_fiyat'] : null;\r\n                $ispUyduFiyat = !empty($_POST['isp_uydu_fiyat']) ? (float)$_POST['isp_uydu_fiyat'] : null;\r\n                $neoFiyat = !empty($_POST['neo_fiyat']) ? (float)$_POST['neo_fiyat'] : null;\r\n                $uyduFiyat = !empty($_POST['uydu_fiyat']) ? (float)$_POST['uydu_fiyat'] : null;\r\n                $baslangicTarihi = $_POST['hakedis_baslangic_tarihi'];\r\n                $bitisTarihi = $_POST['hakedis_bitis_tarihi'];\r\n                $aciklama = trim($_POST['aciklama'] ?? '');\r\n                \r\n                // Açıklama uzunluk kontrolü\r\n                if (strlen($aciklama) > 500) {\r\n                    $message = 'Açıklama metni 500 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n                    $messageType = 'danger';\r\n                } \r\n                // Tarih kontrolü\r\n                elseif (strtotime($baslangicTarihi) >= strtotime($bitisTarihi)) {\r\n                    $message = 'Başlangıç tarihi, bitiş tarihinden önce olmalıdır.';\r\n                    $messageType = 'danger';\r\n                } else {\r\n                    // Çakışan tarih aralığı kontrolü\r\n                    $checkSql = \"SELECT COUNT(*) as count FROM hakedis_tanim \r\n                                WHERE bayi_id = ? \r\n                                AND (\r\n                                    (hakedis_baslangic_tarihi <= ? AND hakedis_bitis_tarihi >= ?) OR\r\n                                    (hakedis_baslangic_tarihi <= ? AND hakedis_bitis_tarihi >= ?) OR\r\n                                    (hakedis_baslangic_tarihi >= ? AND hakedis_bitis_tarihi <= ?)\r\n                                )\";\r\n                    $checkStmt = $conn->prepare($checkSql);\r\n                    $checkStmt->execute([\r\n                        $bayiId, \r\n                        $baslangicTarihi, $baslangicTarihi,\r\n                        $bitisTarihi, $bitisTarihi,\r\n                        $baslangicTarihi, $bitisTarihi\r\n                    ]);\r\n                    $existing = $checkStmt->fetch();\r\n                    \r\n                    if ($existing['count'] > 0) {\r\n                        $message = 'Bu bayi için belirtilen tarih aralığında zaten bir hakediş tanımı bulunmaktadır.';\r\n                        $messageType = 'danger';\r\n                    } else {\r\n                        $sql = \"INSERT INTO hakedis_tanim (bayi_id, isp_neo_fiyat, isp_uydu_fiyat, neo_fiyat, uydu_fiyat, hakedis_baslangic_tarihi, hakedis_bitis_tarihi, aciklama) \r\n                                VALUES (?, ?, ?, ?, ?, ?, ?, ?)\";\r\n                        $stmt = $conn->prepare($sql);\r\n                        $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $baslangicTarihi, $bitisTarihi, $aciklama]);\r\n                        \r\n                        $message = 'Hakediş tanımı başarıyla eklendi.';\r\n                        $messageType = 'success';\r\n                    }\r\n                }\r\n                break;\r\n                \r\n            case 'edit':\r\n                $id = (int)$_POST['id'];\r\n                $bayiId = (int)$_POST['bayi_id'];\r\n                $ispNeoFiyat = !empty($_POST['isp_neo_fiyat']) ? (float)$_POST['isp_neo_fiyat'] : null;\r\n                $ispUyduFiyat = !empty($_POST['isp_uydu_fiyat']) ? (float)$_POST['isp_uydu_fiyat'] : null;\r\n                $neoFiyat = !empty($_POST['neo_fiyat']) ? (float)$_POST['neo_fiyat'] : null;\r\n                $uyduFiyat = !empty($_POST['uydu_fiyat']) ? (float)$_POST['uydu_fiyat'] : null;\r\n                $baslangicTarihi = $_POST['hakedis_baslangic_tarihi'];\r\n                $bitisTarihi = $_POST['hakedis_bitis_tarihi'];\r\n                $aciklama = trim($_POST['aciklama'] ?? '');\r\n                \r\n                // Açıklama uzunluk kontrolü\r\n                if (strlen($aciklama) > 500) {\r\n                    $message = 'Açıklama metni 500 karakteri geçemez. Mevcut uzunluk: ' . strlen($aciklama) . ' karakter.';\r\n                    $messageType = 'danger';\r\n                } \r\n                // Tarih kontrolü\r\n                elseif (strtotime($baslangicTarihi) >= strtotime($bitisTarihi)) {\r\n                    $message = 'Başlangıç tarihi, bitiş tarihinden önce olmalıdır.';\r\n                    $messageType = 'danger';\r\n                } else {\r\n                    // Çakışan tarih aralığı kontrolü (mevcut kayıt hariç)\r\n                    $checkSql = \"SELECT COUNT(*) as count FROM hakedis_tanim \r\n                                WHERE bayi_id = ? AND id != ?\r\n                                AND (\r\n                                    (hakedis_baslangic_tarihi <= ? AND hakedis_bitis_tarihi >= ?) OR\r\n                                    (hakedis_baslangic_tarihi <= ? AND hakedis_bitis_tarihi >= ?) OR\r\n                                    (hakedis_baslangic_tarihi >= ? AND hakedis_bitis_tarihi <= ?)\r\n                                )\";\r\n                    $checkStmt = $conn->prepare($checkSql);\r\n                    $checkStmt->execute([\r\n                        $bayiId, $id,\r\n                        $baslangicTarihi, $baslangicTarihi,\r\n                        $bitisTarihi, $bitisTarihi,\r\n                        $baslangicTarihi, $bitisTarihi\r\n                    ]);\r\n                    $existing = $checkStmt->fetch();\r\n                    \r\n                    if ($existing['count'] > 0) {\r\n                        $message = 'Bu bayi için belirtilen tarih aralığında zaten başka bir hakediş tanımı bulunmaktadır.';\r\n                        $messageType = 'danger';\r\n                    } else {\r\n                        $sql = \"UPDATE hakedis_tanim SET \r\n                                bayi_id = ?, isp_neo_fiyat = ?, isp_uydu_fiyat = ?, neo_fiyat = ?, uydu_fiyat = ?, \r\n                                hakedis_baslangic_tarihi = ?, hakedis_bitis_tarihi = ?, aciklama = ?, updated_at = GETDATE()\r\n                                WHERE id = ?\";\r\n                        $stmt = $conn->prepare($sql);\r\n                        $stmt->execute([$bayiId, $ispNeoFiyat, $ispUyduFiyat, $neoFiyat, $uyduFiyat, $baslangicTarihi, $bitisTarihi, $aciklama, $id]);\r\n                        \r\n                        $message = 'Hakediş tanımı başarıyla güncellendi.';\r\n                        $messageType = 'success';\r\n                    }\r\n                }\r\n                break;\r\n                \r\n            case 'delete':\r\n                $id = (int)$_POST['id'];\r\n                \r\n                $sql = \"DELETE FROM hakedis_tanim WHERE id = ?\";\r\n                $stmt = $conn->prepare($sql);\r\n                $stmt->execute([$id]);\r\n                \r\n                $message = 'Hakediş tanımı başarıyla silindi.';\r\n                $messageType = 'success';\r\n                break;\r\n        }\r\n    } catch (Exception $e) {\r\n        $message = 'Hata: ' . $e->getMessage();\r\n        $messageType = 'danger';\r\n    }\r\n}\r\n\r\n// Bayileri al (users tablosundan bayi grubundakiler)\r\n$bayiler = [];\r\ntry {\r\n    $db = new MSSQLConnection();\r\n    $conn = $db->getConnection();\r\n    \r\n    // Bayi gruplarını bul\r\n    $bayiGroupSql = \"SELECT id FROM user_groups WHERE group_name IN ('bayi', 'Bayi')\";\r\n    $bayiGroupStmt = $conn->prepare($bayiGroupSql);\r\n    $bayiGroupStmt->execute();\r\n    $bayiGroups = $bayiGroupStmt->fetchAll(PDO::FETCH_COLUMN);\r\n    \r\n    if (!empty($bayiGroups)) {\r\n        $placeholders = str_repeat('?,', count($bayiGroups) - 1) . '?';\r\n        $bayiSql = \"SELECT id, first_name, last_name, email \r\n                   FROM users \r\n                   WHERE user_group_id IN ($placeholders) \r\n                   AND status = 'AKTIF'\r\n                   ORDER BY first_name, last_name\";\r\n        $bayiStmt = $conn->prepare($bayiSql);\r\n        $bayiStmt->execute($bayiGroups);\r\n        $bayiler = $bayiStmt->fetchAll(PDO::FETCH_ASSOC);\r\n    }\r\n} catch (Exception $e) {\r\n    // Hata durumunda boş array kalacak\r\n}\r\n\r\n// Filtreleri al\r\n$filterBayiId = $_GET['bayi_filter'] ?? '';\r\n$filterBaslangicTarihi = $_GET['baslangic_tarihi'] ?? '';\r\n$filterBitisTarihi = $_GET['bitis_tarihi'] ?? '';\r\n\r\n// Sıralama parametreleri\r\n$sortColumn = $_GET['sort'] ?? 'hakedis_baslangic_tarihi';\r\n$sortOrder = $_GET['order'] ?? 'desc';\r\n\r\n// Geçerli sıralama kolonları\r\n$validSortColumns = [\r\n    'id' => 'ht.id',\r\n    'bayi' => 'u.first_name',\r\n    'isp_neo_fiyat' => 'ht.isp_neo_fiyat',\r\n    'isp_uydu_fiyat' => 'ht.isp_uydu_fiyat',\r\n    'neo_fiyat' => 'ht.neo_fiyat',\r\n    'uydu_fiyat' => 'ht.uydu_fiyat',\r\n    'hakedis_baslangic_tarihi' => 'ht.hakedis_baslangic_tarihi',\r\n    'hakedis_bitis_tarihi' => 'ht.hakedis_bitis_tarihi',\r\n    'created_at' => 'ht.created_at'\r\n];\r\n\r\n// Sıralama güvenlik kontrolü\r\nif (!isset($validSortColumns[$sortColumn])) {\r\n    $sortColumn = 'hakedis_baslangic_tarihi';\r\n}\r\n\r\nif (!in_array(strtolower($sortOrder), ['asc', 'desc'])) {\r\n    $sortOrder = 'desc';\r\n}\r\n\r\n// Hakediş tanımlarını listele\r\n$hakedisler = [];\r\ntry {\r\n    $db = new MSSQLConnection();\r\n    $conn = $db->getConnection();\r\n    \r\n    // Base SQL query\r\n    $sql = \"SELECT ht.*, u.first_name, u.last_name, u.email\r\n            FROM hakedis_tanim ht\r\n            INNER JOIN users u ON ht.bayi_id = u.id\r\n            WHERE 1=1\";\r\n    \r\n    $params = [];\r\n    \r\n    // Bayi filtresi\r\n    if (!empty($filterBayiId)) {\r\n        $sql .= \" AND ht.bayi_id = ?\";\r\n        $params[] = $filterBayiId;\r\n    }\r\n    \r\n    // Başlangıç tarihi filtresi\r\n    if (!empty($filterBaslangicTarihi)) {\r\n        $sql .= \" AND ht.hakedis_baslangic_tarihi >= ?\";\r\n        $params[] = $filterBaslangicTarihi;\r\n    }\r\n    \r\n    // Bitiş tarihi filtresi\r\n    if (!empty($filterBitisTarihi)) {\r\n        $sql .= \" AND ht.hakedis_bitis_tarihi <= ?\";\r\n        $params[] = $filterBitisTarihi;\r\n    }\r\n    \r\n    $sql .= \" ORDER BY \" . $validSortColumns[$sortColumn] . \" \" . strtoupper($sortOrder);\r\n    \r\n    $stmt = $conn->prepare($sql);\r\n    $stmt->execute($params);\r\n    $hakedisler = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n} catch (Exception $e) {\r\n    $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n}\r\n\r\ninclude 'includes/header.php';\r\n?>\r\n\r\n<div class=\"container-fluid mt-4\">\r\n    <div class=\"row\">\r\n        <div class=\"col-12\">\r\n            <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n                <h2><i class=\"fas fa-calculator me-2\"></i>Bayi Hakediş Tanımlama</h2>\r\n                <button class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#addHakedisModal\">\r\n                    <i class=\"fas fa-plus me-1\"></i>Yeni Hakediş Tanımı\r\n                </button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <?php if ($message): ?>\r\n        <div class=\"alert alert-<?php echo $messageType; ?> alert-dismissible fade show\" role=\"alert\">\r\n            <i class=\"fas fa-<?php echo $messageType === 'success' ? 'check-circle' : 'exclamation-triangle'; ?> me-2\"></i>\r\n            <?php echo htmlspecialchars($message); ?>\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n        </div>\r\n    <?php endif; ?>\r\n\r\n    <?php if (isset($error)): ?>\r\n        <div class=\"alert alert-danger alert-dismissible fade show\" role=\"alert\">\r\n            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n            <?php echo htmlspecialchars($error); ?>\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n        </div>\r\n    <?php endif; ?>\r\n\r\n    <!-- Filtreler -->\r\n    <div class=\"card border-0 shadow-sm mb-4\">\r\n        <div class=\"card-header bg-light\">\r\n            <h6 class=\"mb-0\">\r\n                <i class=\"fas fa-filter me-2\"></i>Filtreler\r\n            </h6>\r\n        </div>\r\n        <div class=\"card-body\">\r\n            <form method=\"GET\" action=\"\">\r\n                <!-- Sıralama parametrelerini koru -->\r\n                <input type=\"hidden\" name=\"sort\" value=\"<?php echo htmlspecialchars($sortColumn); ?>\">\r\n                <input type=\"hidden\" name=\"order\" value=\"<?php echo htmlspecialchars($sortOrder); ?>\">\r\n                \r\n                <div class=\"row g-3\">\r\n                    <div class=\"col-md-4\">\r\n                        <label for=\"bayi_filter\" class=\"form-label\">Bayi Adı</label>\r\n                        <select class=\"form-select\" id=\"bayi_filter\" name=\"bayi_filter\">\r\n                            <option value=\"\">Tüm Bayiler</option>\r\n                            <?php foreach ($bayiler as $bayi): ?>\r\n                                <option value=\"<?php echo $bayi['id']; ?>\" \r\n                                        <?php echo ($filterBayiId == $bayi['id']) ? 'selected' : ''; ?>>\r\n                                    <?php echo htmlspecialchars($bayi['first_name'] . ' ' . $bayi['last_name']); ?>\r\n                                </option>\r\n                            <?php endforeach; ?>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"col-md-3\">\r\n                        <label for=\"baslangic_tarihi\" class=\"form-label\">Başlangıç Tarihi (Min)</label>\r\n                        <input type=\"date\" class=\"form-control\" id=\"baslangic_tarihi\" name=\"baslangic_tarihi\" \r\n                               value=\"<?php echo htmlspecialchars($filterBaslangicTarihi); ?>\">\r\n                    </div>\r\n                    <div class=\"col-md-3\">\r\n                        <label for=\"bitis_tarihi\" class=\"form-label\">Bitiş Tarihi (Max)</label>\r\n                        <input type=\"date\" class=\"form-control\" id=\"bitis_tarihi\" name=\"bitis_tarihi\" \r\n                               value=\"<?php echo htmlspecialchars($filterBitisTarihi); ?>\">\r\n                    </div>\r\n                    <div class=\"col-md-2 d-flex align-items-end\">\r\n                        <div class=\"btn-group w-100\" role=\"group\">\r\n                            <button type=\"submit\" class=\"btn btn-primary\">\r\n                                <i class=\"fas fa-search me-1\"></i>Filtrele\r\n                            </button>\r\n                            <a href=\"bayi_hakedis_tanimla.php\" class=\"btn btn-outline-secondary\" title=\"Filtreleri Temizle\">\r\n                                <i class=\"fas fa-times\"></i>\r\n                            </a>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Hakediş Tanımları Tablosu -->\r\n    <div class=\"card border-0 shadow-sm\">\r\n        <div class=\"card-header bg-primary text-white\">\r\n            <h5 class=\"mb-0\">\r\n                <i class=\"fas fa-list me-2\"></i>Hakediş Tanım Listesi\r\n            </h5>\r\n        </div>\r\n        <div class=\"card-body p-0\">\r\n            <div class=\"table-responsive\">\r\n                <table class=\"table table-hover mb-0\">\r\n                    <thead class=\"table-light\">\r\n                        <tr>\r\n                            <th>\r\n                                <a href=\"javascript:void(0)\" onclick=\"sortTable('id')\" class=\"text-decoration-none text-dark\">\r\n                                    ID\r\n                                    <?php if ($sortColumn == 'id'): ?>\r\n                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n                                    <?php else: ?>\r\n                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n                                    <?php endif; ?>\r\n                                </a>\r\n                            </th>\r\n                            <th>\r\n                                <a href=\"javascript:void(0)\" onclick=\"sortTable('bayi')\" class=\"text-decoration-none text-dark\">\r\n                                    Bayi\r\n                                    <?php if ($sortColumn == 'bayi'): ?>\r\n                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n                                    <?php else: ?>\r\n                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n                                    <?php endif; ?>\r\n                                </a>\r\n                            </th>\r\n                            <th>\r\n                                <a href=\"javascript:void(0)\" onclick=\"sortTable('isp_neo_fiyat')\" class=\"text-decoration-none text-dark\">\r\n                                    ISP Neo Fiyat\r\n                                    <?php if ($sortColumn == 'isp_neo_fiyat'): ?>\r\n                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n                                    <?php else: ?>\r\n                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n                                    <?php endif; ?>\r\n                                </a>\r\n                            </th>\r\n                            <th>\r\n                                <a href=\"javascript:void(0)\" onclick=\"sortTable('isp_uydu_fiyat')\" class=\"text-decoration-none text-dark\">\r\n                                    ISP Uydu Fiyat\r\n                                    <?php if ($sortColumn == 'isp_uydu_fiyat'): ?>\r\n                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n                                    <?php else: ?>\r\n                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n                                    <?php endif; ?>\r\n                                </a>\r\n                            </th>\r\n                            <th>\r\n                                <a href=\"javascript:void(0)\" onclick=\"sortTable('neo_fiyat')\" class=\"text-decoration-none text-dark\">\r\n                                    Neo Fiyat\r\n                                    <?php if ($sortColumn == 'neo_fiyat'): ?>\r\n                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n                                    <?php else: ?>\r\n                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n                                    <?php endif; ?>\r\n                                </a>\r\n                            </th>\r\n                            <th>\r\n                                <a href=\"javascript:void(0)\" onclick=\"sortTable('uydu_fiyat')\" class=\"text-decoration-none text-dark\">\r\n                                    Uydu Fiyat\r\n                                    <?php if ($sortColumn == 'uydu_fiyat'): ?>\r\n                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n                                    <?php else: ?>\r\n                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n                                    <?php endif; ?>\r\n                                </a>\r\n                            </th>\r\n                            <th>\r\n                                <a href=\"javascript:void(0)\" onclick=\"sortTable('hakedis_baslangic_tarihi')\" class=\"text-decoration-none text-dark\">\r\n                                    Başlangıç Tarihi\r\n                                    <?php if ($sortColumn == 'hakedis_baslangic_tarihi'): ?>\r\n                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n                                    <?php else: ?>\r\n                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n                                    <?php endif; ?>\r\n                                </a>\r\n                            </th>\r\n                            <th>\r\n                                <a href=\"javascript:void(0)\" onclick=\"sortTable('hakedis_bitis_tarihi')\" class=\"text-decoration-none text-dark\">\r\n                                    Bitiş Tarihi\r\n                                    <?php if ($sortColumn == 'hakedis_bitis_tarihi'): ?>\r\n                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n                                    <?php else: ?>\r\n                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n                                    <?php endif; ?>\r\n                                </a>\r\n                            </th>\r\n                            <th>Açıklama</th>\r\n                            <th>\r\n                                <a href=\"javascript:void(0)\" onclick=\"sortTable('created_at')\" class=\"text-decoration-none text-dark\">\r\n                                    Oluşturulma\r\n                                    <?php if ($sortColumn == 'created_at'): ?>\r\n                                        <i class=\"fas fa-sort-<?php echo $sortOrder == 'asc' ? 'up' : 'down'; ?> ms-1\"></i>\r\n                                    <?php else: ?>\r\n                                        <i class=\"fas fa-sort ms-1 text-muted\"></i>\r\n                                    <?php endif; ?>\r\n                                </a>\r\n                            </th>\r\n                            <th>İşlemler</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        <?php if (!empty($hakedisler)): ?>\r\n                            <?php foreach ($hakedisler as $hakedis): ?>\r\n                                <tr>\r\n                                    <td><?php echo $hakedis['id']; ?></td>\r\n                                    <td>\r\n                                        <strong><?php echo htmlspecialchars($hakedis['first_name'] . ' ' . $hakedis['last_name']); ?></strong>\r\n                                        <br><small class=\"text-muted\"><?php echo htmlspecialchars($hakedis['email']); ?></small>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo $hakedis['isp_neo_fiyat'] ? number_format($hakedis['isp_neo_fiyat'], 2) . ' ₺' : '-'; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo $hakedis['isp_uydu_fiyat'] ? number_format($hakedis['isp_uydu_fiyat'], 2) . ' ₺' : '-'; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo $hakedis['neo_fiyat'] ? number_format($hakedis['neo_fiyat'], 2) . ' ₺' : '-'; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo $hakedis['uydu_fiyat'] ? number_format($hakedis['uydu_fiyat'], 2) . ' ₺' : '-'; ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo date('d.m.Y', strtotime($hakedis['hakedis_baslangic_tarihi'])); ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo date('d.m.Y', strtotime($hakedis['hakedis_bitis_tarihi'])); ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <span class=\"text-muted\" title=\"<?php echo htmlspecialchars($hakedis['aciklama'] ?? ''); ?>\">\r\n                                            <?php \r\n                                            $aciklama = $hakedis['aciklama'] ?? '';\r\n                                            if (strlen($aciklama) > 30) {\r\n                                                echo htmlspecialchars(substr($aciklama, 0, 30)) . '...';\r\n                                            } else {\r\n                                                echo htmlspecialchars($aciklama) ?: '-';\r\n                                            }\r\n                                            ?>\r\n                                        </span>\r\n                                    </td>\r\n                                    <td>\r\n                                        <?php echo date('d.m.Y H:i', strtotime($hakedis['created_at'])); ?>\r\n                                    </td>\r\n                                    <td>\r\n                                        <div class=\"btn-group\" role=\"group\">\r\n                                            <button type=\"button\" class=\"btn btn-sm btn-outline-primary\" \r\n                                                    onclick=\"editHakedis(<?php echo htmlspecialchars(json_encode($hakedis)); ?>)\">\r\n                                                <i class=\"fas fa-edit\"></i>\r\n                                            </button>\r\n                                            <button type=\"button\" class=\"btn btn-sm btn-outline-danger\" \r\n                                                    onclick=\"deleteHakedis(<?php echo $hakedis['id']; ?>, '<?php echo htmlspecialchars($hakedis['first_name'] . ' ' . $hakedis['last_name']); ?>')\">\r\n                                                <i class=\"fas fa-trash\"></i>\r\n                                            </button>\r\n                                        </div>\r\n                                    </td>\r\n                                </tr>\r\n                            <?php endforeach; ?>\r\n                        <?php else: ?>\r\n                            <tr>\r\n                                <td colspan=\"11\" class=\"text-center py-5 text-muted\">\r\n                                    <i class=\"fas fa-calculator fa-3x mb-3 d-block\"></i>\r\n                                    <h5>Henüz hakediş tanımı bulunmuyor</h5>\r\n                                    <p>İlk hakediş tanımını eklemek için \"Yeni Hakediş Tanımı\" butonuna tıklayın.</p>\r\n                                </td>\r\n                            </tr>\r\n                        <?php endif; ?>\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Yeni Hakediş Tanımı Modal -->\r\n<div class=\"modal fade\" id=\"addHakedisModal\" tabindex=\"-1\">\r\n    <div class=\"modal-dialog modal-lg\">\r\n        <div class=\"modal-content\">\r\n            <form method=\"POST\" action=\"\">\r\n                <input type=\"hidden\" name=\"action\" value=\"add\">\r\n                <div class=\"modal-header\">\r\n                    <h5 class=\"modal-title\">\r\n                        <i class=\"fas fa-plus me-2\"></i>Yeni Hakediş Tanımı\r\n                    </h5>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"add_bayi_id\" class=\"form-label\">Bayi <span class=\"text-danger\">*</span></label>\r\n                        <select class=\"form-select\" id=\"add_bayi_id\" name=\"bayi_id\" required>\r\n                            <option value=\"\">Bayi Seçin</option>\r\n                            <?php foreach ($bayiler as $bayi): ?>\r\n                                <option value=\"<?php echo $bayi['id']; ?>\">\r\n                                    <?php echo htmlspecialchars($bayi['first_name'] . ' ' . $bayi['last_name'] . ' (' . $bayi['email'] . ')'); ?>\r\n                                </option>\r\n                            <?php endforeach; ?>\r\n                        </select>\r\n                    </div>\r\n                    \r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"add_isp_neo_fiyat\" class=\"form-label\">ISP Neo Fiyat</label>\r\n                            <div class=\"input-group\">\r\n                                <input type=\"number\" class=\"form-control\" id=\"add_isp_neo_fiyat\" name=\"isp_neo_fiyat\" \r\n                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                <span class=\"input-group-text\">₺</span>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"add_isp_uydu_fiyat\" class=\"form-label\">ISP Uydu Fiyat</label>\r\n                            <div class=\"input-group\">\r\n                                <input type=\"number\" class=\"form-control\" id=\"add_isp_uydu_fiyat\" name=\"isp_uydu_fiyat\" \r\n                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                <span class=\"input-group-text\">₺</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"add_neo_fiyat\" class=\"form-label\">Neo Fiyat</label>\r\n                            <div class=\"input-group\">\r\n                                <input type=\"number\" class=\"form-control\" id=\"add_neo_fiyat\" name=\"neo_fiyat\" \r\n                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                <span class=\"input-group-text\">₺</span>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"add_uydu_fiyat\" class=\"form-label\">Uydu Fiyat</label>\r\n                            <div class=\"input-group\">\r\n                                <input type=\"number\" class=\"form-control\" id=\"add_uydu_fiyat\" name=\"uydu_fiyat\" \r\n                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                <span class=\"input-group-text\">₺</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"add_baslangic_tarihi\" class=\"form-label\">Hakediş Başlangıç Tarihi <span class=\"text-danger\">*</span></label>\r\n                            <input type=\"date\" class=\"form-control\" id=\"add_baslangic_tarihi\" name=\"hakedis_baslangic_tarihi\" required>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"add_bitis_tarihi\" class=\"form-label\">Hakediş Bitiş Tarihi <span class=\"text-danger\">*</span></label>\r\n                            <input type=\"date\" class=\"form-control\" id=\"add_bitis_tarihi\" name=\"hakedis_bitis_tarihi\" required>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"add_aciklama\" class=\"form-label\">Açıklama</label>\r\n                        <textarea class=\"form-control\" id=\"add_aciklama\" name=\"aciklama\" rows=\"3\" \r\n                                  placeholder=\"Hakediş tanımı ile ilgili açıklama (isteğe bağlı)\" maxlength=\"500\"></textarea>\r\n                        <div class=\"form-text d-flex justify-content-between\">\r\n                            <span>Maksimum 500 karakter</span>\r\n                            <span id=\"add_char_count\">0/500</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-primary\">\r\n                        <i class=\"fas fa-save me-1\"></i>Kaydet\r\n                    </button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Hakediş Düzenle Modal -->\r\n<div class=\"modal fade\" id=\"editHakedisModal\" tabindex=\"-1\">\r\n    <div class=\"modal-dialog modal-lg\">\r\n        <div class=\"modal-content\">\r\n            <form method=\"POST\" action=\"\">\r\n                <input type=\"hidden\" name=\"action\" value=\"edit\">\r\n                <input type=\"hidden\" name=\"id\" id=\"edit_id\">\r\n                <div class=\"modal-header\">\r\n                    <h5 class=\"modal-title\">\r\n                        <i class=\"fas fa-edit me-2\"></i>Hakediş Tanımı Düzenle\r\n                    </h5>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <div class=\"mb-3\">\r\n                        <label for=\"edit_bayi_id\" class=\"form-label\">Bayi <span class=\"text-danger\">*</span></label>\r\n                        <select class=\"form-select\" id=\"edit_bayi_id\" name=\"bayi_id\" required>\r\n                            <option value=\"\">Bayi Seçin</option>\r\n                            <?php foreach ($bayiler as $bayi): ?>\r\n                                <option value=\"<?php echo $bayi['id']; ?>\">\r\n                                    <?php echo htmlspecialchars($bayi['first_name'] . ' ' . $bayi['last_name'] . ' (' . $bayi['email'] . ')'); ?>\r\n                                </option>\r\n                            <?php endforeach; ?>\r\n                        </select>\r\n                    </div>\r\n                    \r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"edit_isp_neo_fiyat\" class=\"form-label\">ISP Neo Fiyat</label>\r\n                            <div class=\"input-group\">\r\n                                <input type=\"number\" class=\"form-control\" id=\"edit_isp_neo_fiyat\" name=\"isp_neo_fiyat\" \r\n                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                <span class=\"input-group-text\">₺</span>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"edit_isp_uydu_fiyat\" class=\"form-label\">ISP Uydu Fiyat</label>\r\n                            <div class=\"input-group\">\r\n                                <input type=\"number\" class=\"form-control\" id=\"edit_isp_uydu_fiyat\" name=\"isp_uydu_fiyat\" \r\n                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                <span class=\"input-group-text\">₺</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"edit_neo_fiyat\" class=\"form-label\">Neo Fiyat</label>\r\n                            <div class=\"input-group\">\r\n                                <input type=\"number\" class=\"form-control\" id=\"edit_neo_fiyat\" name=\"neo_fiyat\" \r\n                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                <span class=\"input-group-text\">₺</span>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"edit_uydu_fiyat\" class=\"form-label\">Uydu Fiyat</label>\r\n                            <div class=\"input-group\">\r\n                                <input type=\"number\" class=\"form-control\" id=\"edit_uydu_fiyat\" name=\"uydu_fiyat\" \r\n                                       step=\"0.01\" min=\"0\" placeholder=\"0.00\">\r\n                                <span class=\"input-group-text\">₺</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"row\">\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"edit_baslangic_tarihi\" class=\"form-label\">Hakediş Başlangıç Tarihi <span class=\"text-danger\">*</span></label>\r\n                            <input type=\"date\" class=\"form-control\" id=\"edit_baslangic_tarihi\" name=\"hakedis_baslangic_tarihi\" required>\r\n                        </div>\r\n                        <div class=\"col-md-6 mb-3\">\r\n                            <label for=\"edit_bitis_tarihi\" class=\"form-label\">Hakediş Bitiş Tarihi <span class=\"text-danger\">*</span></label>\r\n                            <input type=\"date\" class=\"form-control\" id=\"edit_bitis_tarihi\" name=\"hakedis_bitis_tarihi\" required>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label for=\"edit_aciklama\" class=\"form-label\">Açıklama</label>\r\n                        <textarea class=\"form-control\" id=\"edit_aciklama\" name=\"aciklama\" rows=\"3\" \r\n                                  placeholder=\"Hakediş tanımı ile ilgili açıklama (isteğe bağlı)\" maxlength=\"500\"></textarea>\r\n                        <div class=\"form-text d-flex justify-content-between\">\r\n                            <span>Maksimum 500 karakter</span>\r\n                            <span id=\"edit_char_count\">0/500</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-primary\">\r\n                        <i class=\"fas fa-save me-1\"></i>Güncelle\r\n                    </button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\r\n<script>\r\n// Karakter sayacı fonksiyonları\r\nfunction updateCharCounter(textareaId, counterId) {\r\n    const textarea = document.getElementById(textareaId);\r\n    const counter = document.getElementById(counterId);\r\n    \r\n    if (textarea && counter) {\r\n        const updateCount = () => {\r\n            const currentLength = textarea.value.length;\r\n            const maxLength = 200;\r\n            counter.textContent = `${currentLength}/${maxLength}`;\r\n            \r\n            // Limit aşıldığında renk değişimi\r\n            if (currentLength > maxLength * 0.9) {\r\n                counter.classList.add('text-warning');\r\n            } else {\r\n                counter.classList.remove('text-warning');\r\n            }\r\n            \r\n            if (currentLength >= maxLength) {\r\n                counter.classList.add('text-danger');\r\n                counter.classList.remove('text-warning');\r\n            } else {\r\n                counter.classList.remove('text-danger');\r\n            }\r\n        };\r\n        \r\n        textarea.addEventListener('input', updateCount);\r\n        textarea.addEventListener('keyup', updateCount);\r\n        textarea.addEventListener('paste', () => {\r\n            setTimeout(updateCount, 10); // Paste işlemi tamamlandıktan sonra güncelle\r\n        });\r\n        \r\n        // İlk yüklemede güncellemeleri\r\n        updateCount();\r\n    }\r\n}\r\n\r\nfunction sortTable(column) {\r\n    const currentSort = '<?php echo $sortColumn; ?>';\r\n    const currentOrder = '<?php echo $sortOrder; ?>';\r\n    \r\n    // Eğer aynı kolona tıklanırsa sıralamayı ters çevir\r\n    let newOrder = 'asc';\r\n    if (column === currentSort && currentOrder === 'asc') {\r\n        newOrder = 'desc';\r\n    }\r\n    \r\n    // Mevcut URL parametrelerini al\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    \r\n    // Sıralama parametrelerini güncelle\r\n    urlParams.set('sort', column);\r\n    urlParams.set('order', newOrder);\r\n    \r\n    // Sayfayı yenile\r\n    window.location.search = urlParams.toString();\r\n}\r\n\r\nfunction editHakedis(hakedis) {\r\n    document.getElementById('edit_id').value = hakedis.id;\r\n    document.getElementById('edit_bayi_id').value = hakedis.bayi_id;\r\n    document.getElementById('edit_isp_neo_fiyat').value = hakedis.isp_neo_fiyat || '';\r\n    document.getElementById('edit_isp_uydu_fiyat').value = hakedis.isp_uydu_fiyat || '';\r\n    document.getElementById('edit_neo_fiyat').value = hakedis.neo_fiyat || '';\r\n    document.getElementById('edit_uydu_fiyat').value = hakedis.uydu_fiyat || '';\r\n    document.getElementById('edit_aciklama').value = hakedis.aciklama || '';\r\n    \r\n    // Karakter sayacını güncelle\r\n    updateCharCounter('edit_aciklama', 'edit_char_count');\r\n    \r\n    // Tarihleri formatla (YYYY-MM-DD)\r\n    if (hakedis.hakedis_baslangic_tarihi) {\r\n        const baslangic = new Date(hakedis.hakedis_baslangic_tarihi);\r\n        document.getElementById('edit_baslangic_tarihi').value = baslangic.toISOString().split('T')[0];\r\n    }\r\n    \r\n    if (hakedis.hakedis_bitis_tarihi) {\r\n        const bitis = new Date(hakedis.hakedis_bitis_tarihi);\r\n        document.getElementById('edit_bitis_tarihi').value = bitis.toISOString().split('T')[0];\r\n    }\r\n    \r\n    new bootstrap.Modal(document.getElementById('editHakedisModal')).show();\r\n}\r\n\r\nfunction deleteHakedis(hakedisId, bayiName) {\r\n    if (confirm(bayiName + ' için hakediş tanımını silmek istediğinizden emin misiniz?\\n\\nBu işlem geri alınamaz.')) {\r\n        const form = document.createElement('form');\r\n        form.method = 'POST';\r\n        form.innerHTML = `\r\n            <input type=\"hidden\" name=\"action\" value=\"delete\">\r\n            <input type=\"hidden\" name=\"id\" value=\"${hakedisId}\">\r\n        `;\r\n        document.body.appendChild(form);\r\n        form.submit();\r\n    }\r\n}\r\n\r\n// Karakter sayacı fonksiyonları\r\nfunction updateCharCounter(textareaId, counterId) {\r\n    const textarea = document.getElementById(textareaId);\r\n    const counter = document.getElementById(counterId);\r\n    \r\n    if (textarea && counter) {\r\n        const updateCount = () => {\r\n            const currentLength = textarea.value.length;\r\n            const maxLength = 200;\r\n            counter.textContent = `${currentLength}/${maxLength}`;\r\n            \r\n            // Limit aşıldığında renk değişimi\r\n            if (currentLength > maxLength * 0.9) {\r\n                counter.classList.add('text-warning');\r\n            } else {\r\n                counter.classList.remove('text-warning');\r\n            }\r\n            \r\n            if (currentLength >= maxLength) {\r\n                counter.classList.add('text-danger');\r\n                counter.classList.remove('text-warning');\r\n            } else {\r\n                counter.classList.remove('text-danger');\r\n            }\r\n        };\r\n        \r\n        textarea.addEventListener('input', updateCount);\r\n        textarea.addEventListener('keyup', updateCount);\r\n        textarea.addEventListener('paste', () => {\r\n            setTimeout(updateCount, 10); // Paste işlemi tamamlandıktan sonra güncelle\r\n        });\r\n        \r\n        // İlk yüklemede güncellemeleri\r\n        updateCount();\r\n    }\r\n}\r\n\r\n// Form validasyonu\r\ndocument.addEventListener('DOMContentLoaded', function() {\r\n    // Başlangıç ve bitiş tarihi validasyonu\r\n    function validateDates(baslangicId, bitisId) {\r\n        const baslangic = document.getElementById(baslangicId);\r\n        const bitis = document.getElementById(bitisId);\r\n        \r\n        function checkDates() {\r\n            if (baslangic.value && bitis.value) {\r\n                if (new Date(baslangic.value) >= new Date(bitis.value)) {\r\n                    bitis.setCustomValidity('Bitiş tarihi başlangıç tarihinden sonra olmalıdır');\r\n                } else {\r\n                    bitis.setCustomValidity('');\r\n                }\r\n            }\r\n        }\r\n        \r\n        baslangic.addEventListener('change', checkDates);\r\n        bitis.addEventListener('change', checkDates);\r\n    }\r\n    \r\n    // Her iki modal için tarih validasyonu\r\n    validateDates('add_baslangic_tarihi', 'add_bitis_tarihi');\r\n    validateDates('edit_baslangic_tarihi', 'edit_bitis_tarihi');\r\n    \r\n    // Karakter sayaçlarını başlat\r\n    updateCharCounter('add_aciklama', 'add_char_count');\r\n    updateCharCounter('edit_aciklama', 'edit_char_count');\r\n});\r\n</script>\r\n\r\n<?php include 'includes/footer.php'; ?>\r\n"
        }
    ]
}
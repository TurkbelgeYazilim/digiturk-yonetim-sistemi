{
    "sourceFile": "test_iris_simple.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1759332348257,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1759332348257,
            "name": "Commit-0",
            "content": "<?php\r\n// Simplified test for iris_karsilastirma.php core functionality\r\n\r\n// Enable error reporting for debugging\r\nerror_reporting(E_ALL);\r\nini_set('display_errors', 1);\r\nini_set('log_errors', 1);\r\n\r\necho \"<!DOCTYPE html>\";\r\necho \"<html><head><title>Test Iris Karsilastirma</title></head><body>\";\r\necho \"<h1>Testing Iris Karsilastirma Functionality</h1>\";\r\n\r\n// Start session\r\nif (session_status() == PHP_SESSION_NONE) {\r\n    session_start();\r\n}\r\n\r\n// Mock auth for testing (skip actual auth check)\r\necho \"<p>1. Session started</p>\";\r\n\r\n// Test database configuration\r\ntry {\r\n    $configFile = __DIR__ . '/config/mssql.php';\r\n    \r\n    if (!file_exists($configFile)) {\r\n        throw new Exception('Database config file not found: ' . $configFile);\r\n    }\r\n    \r\n    $config = include $configFile;\r\n    echo \"<p>2. Database config loaded</p>\";\r\n    \r\n    // Test database connection\r\n    $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n    \r\n    $conn = new PDO($dsn, $config['username'], $config['password'], [\r\n        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n        PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n        PDO::ATTR_EMULATE_PREPARES => false\r\n    ]);\r\n    \r\n    echo \"<p>3. Database connection successful</p>\";\r\n    \r\n    // Test if table exists\r\n    $sql = \"SELECT COUNT(*) as count FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'iris_rapor'\";\r\n    $stmt = $conn->prepare($sql);\r\n    $stmt->execute();\r\n    $result = $stmt->fetch();\r\n    \r\n    if ($result['count'] == 0) {\r\n        echo \"<p style='color: red;'>ERROR: iris_rapor table does not exist!</p>\";\r\n    } else {\r\n        echo \"<p>4. iris_rapor table exists</p>\";\r\n        \r\n        // Test basic query\r\n        $sql = \"SELECT COUNT(*) as total FROM iris_rapor\";\r\n        $stmt = $conn->prepare($sql);\r\n        $stmt->execute();\r\n        $result = $stmt->fetch();\r\n        echo \"<p>5. Total records in iris_rapor: \" . $result['total'] . \"</p>\";\r\n        \r\n        // Test the problematic query\r\n        try {\r\n            $sql = \"\r\n                WITH DuplicateMemos AS (\r\n                    SELECT MEMO_ID, COUNT(*) as kayit_sayisi\r\n                    FROM iris_rapor \r\n                    WHERE MEMO_ID IS NOT NULL\r\n                    GROUP BY MEMO_ID\r\n                    HAVING COUNT(*) > 1\r\n                )\r\n                SELECT COUNT(*) as duplicate_count\r\n                FROM DuplicateMemos\r\n            \";\r\n            \r\n            $stmt = $conn->prepare($sql);\r\n            $stmt->execute();\r\n            $result = $stmt->fetch();\r\n            echo \"<p>6. Duplicate MEMO_ID groups found: \" . $result['duplicate_count'] . \"</p>\";\r\n            \r\n            // If there are duplicates, show sample data\r\n            if ($result['duplicate_count'] > 0) {\r\n                $sql = \"\r\n                    WITH DuplicateMemos AS (\r\n                        SELECT MEMO_ID, COUNT(*) as kayit_sayisi\r\n                        FROM iris_rapor \r\n                        WHERE MEMO_ID IS NOT NULL\r\n                        GROUP BY MEMO_ID\r\n                        HAVING COUNT(*) > 1\r\n                    )\r\n                    SELECT TOP 5\r\n                        ir.dosya_adi,\r\n                        ir.MEMO_ID,\r\n                        ir.GUNCEL_OUTLET_DURUM,\r\n                        ir.TEYIT_DURUM,\r\n                        ir.eklenme_tarihi,\r\n                        dm.kayit_sayisi\r\n                    FROM iris_rapor ir\r\n                    INNER JOIN DuplicateMemos dm ON ir.MEMO_ID = dm.MEMO_ID\r\n                    ORDER BY ir.MEMO_ID, ir.eklenme_tarihi DESC\r\n                \";\r\n                \r\n                $stmt = $conn->prepare($sql);\r\n                $stmt->execute();\r\n                $samples = $stmt->fetchAll();\r\n                \r\n                echo \"<p>7. Sample duplicate records:</p>\";\r\n                echo \"<table border='1' style='border-collapse: collapse;'>\";\r\n                echo \"<tr><th>Dosya Adı</th><th>MEMO_ID</th><th>Güncel Outlet</th><th>Teyit Durumu</th><th>Eklenme Tarihi</th><th>Kayıt Sayısı</th></tr>\";\r\n                \r\n                foreach ($samples as $row) {\r\n                    echo \"<tr>\";\r\n                    echo \"<td>\" . htmlspecialchars($row['dosya_adi'] ?? '') . \"</td>\";\r\n                    echo \"<td>\" . htmlspecialchars($row['MEMO_ID'] ?? '') . \"</td>\";\r\n                    echo \"<td>\" . htmlspecialchars($row['GUNCEL_OUTLET_DURUM'] ?? '') . \"</td>\";\r\n                    echo \"<td>\" . htmlspecialchars($row['TEYIT_DURUM'] ?? '') . \"</td>\";\r\n                    echo \"<td>\" . htmlspecialchars($row['eklenme_tarihi'] ?? '') . \"</td>\";\r\n                    echo \"<td>\" . htmlspecialchars($row['kayit_sayisi'] ?? '') . \"</td>\";\r\n                    echo \"</tr>\";\r\n                }\r\n                echo \"</table>\";\r\n            }\r\n            \r\n            echo \"<p style='color: green;'>✓ Core functionality working correctly!</p>\";\r\n            \r\n        } catch (Exception $e) {\r\n            echo \"<p style='color: red;'>ERROR in duplicate query: \" . htmlspecialchars($e->getMessage()) . \"</p>\";\r\n        }\r\n    }\r\n    \r\n} catch (Exception $e) {\r\n    echo \"<p style='color: red;'>ERROR: \" . htmlspecialchars($e->getMessage()) . \"</p>\";\r\n    echo \"<p>Error details: \" . htmlspecialchars($e->getFile() . \" line \" . $e->getLine()) . \"</p>\";\r\n}\r\n\r\necho \"</body></html>\";\r\n?>"
        }
    ]
}
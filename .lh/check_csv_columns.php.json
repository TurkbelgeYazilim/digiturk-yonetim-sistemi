{
    "sourceFile": "check_csv_columns.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1760454892715,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1760454892715,
            "name": "Commit-0",
            "content": "<?php\r\nheader('Content-Type: application/json');\r\n\r\ntry {\r\n    $filename = $_GET['file'] ?? '';\r\n    if (empty($filename)) {\r\n        throw new Exception('Dosya adı belirtilmedi');\r\n    }\r\n    \r\n    $uploadDir = 'uploads/';\r\n    $filePath = $uploadDir . $filename;\r\n    \r\n    // Dosya varlığını kontrol et\r\n    if (!file_exists($filePath)) {\r\n        throw new Exception('Dosya bulunamadı: ' . $filename);\r\n    }\r\n    \r\n    // CSV dosyasının ilk satırını oku (başlıklar)\r\n    $handle = fopen($filePath, 'r');\r\n    if (!$handle) {\r\n        throw new Exception('Dosya açılamadı');\r\n    }\r\n    \r\n    $firstLine = fgets($handle);\r\n    fclose($handle);\r\n    \r\n    if (!$firstLine) {\r\n        throw new Exception('Dosya boş veya okunamadı');\r\n    }\r\n    \r\n    // CSV başlıklarını ayır (noktalı virgül ile ayrılmış)\r\n    $csvHeaders = array_map('trim', explode(';', trim($firstLine)));\r\n    \r\n    // Beklenen SQL sütunları (iris_rapor tablosundan)\r\n    $expectedColumns = [\r\n        'TALEP_ID',\r\n        'TALEP_TURU',\r\n        'UYDU_BASVURU_POTANSIYEL_NO',\r\n        'UYDU_BASVURU_UYE_NO',\r\n        'DT_MUSTERI_NO',\r\n        'MEMO_ID',\r\n        'MEMO_KAYIT_TIPI',\r\n        'MEMO_ID_TIP',\r\n        'MEMO_KODU',\r\n        'MEMO_KAPANIS_TARIHI',\r\n        'MEMO_YONLENEN_BAYI_KODU',\r\n        'MEMO_YONLENEN_BAYI_ADI',\r\n        'MEMO_YONLENEN_BAYI_YONETICISI',\r\n        'MEMO_YONLENEN_BAYI_BOLGE',\r\n        'MEMO_YONLENEN_BAYI_TEKNIK_YNTC',\r\n        'TALEP_GIRIS_TARIHI',\r\n        'TALEBI_GIREN_BAYI_KODU',\r\n        'TALEBI_GIREN_BAYI_ADI',\r\n        'TALEBI_GIREN_PERSONEL',\r\n        'TALEBI_GIREN_PERSONELNO',\r\n        'TALEBI_GIREN_PERSONELKODU',\r\n        'TALEBI_GIREN_PERSONEL_ALTBAYI',\r\n        'TALEP_KAYNAK',\r\n        'SATIS_DURUMU',\r\n        'INTERNET_SUREC_DURUMU',\r\n        'AKTIVE_EDILEN_UYENO',\r\n        'AKTIVE_EDILEN_OUTLETNO',\r\n        'AKTIVE_EDILEN_SOZLESMENO',\r\n        'AKTIVE_EDILEN_SOZLESMEKMP',\r\n        'AKTIVE_EDILEN_SOZLESMEDURUM',\r\n        'TALEP_TAKIP_NOTU',\r\n        'GUNCEL_OUTLET_DURUM',\r\n        'TEYIT_DURUM',\r\n        'TEYIT_ARAMA_DURUM',\r\n        'RANDEVU_TARIHI',\r\n        'MEMO_SON_DURUM',\r\n        'MEMO_SON_CEVAP',\r\n        'MEMO_SON_ACIKLAMA'\r\n    ];\r\n    \r\n    // Karşılaştırma yap\r\n    $csvHeadersCount = count($csvHeaders);\r\n    $expectedCount = count($expectedColumns);\r\n    \r\n    // Eşleşen sütunları bul\r\n    $matchingColumns = array_intersect($csvHeaders, $expectedColumns);\r\n    $matchingCount = count($matchingColumns);\r\n    \r\n    // CSV'de eksik olan sütunlar\r\n    $missingInCsv = array_diff($expectedColumns, $csvHeaders);\r\n    \r\n    // CSV'de fazla olan sütunlar\r\n    $extraInCsv = array_diff($csvHeaders, $expectedColumns);\r\n    \r\n    // Sıralama uyumsuzlukları\r\n    $orderMismatch = [];\r\n    for ($i = 0; $i < min($csvHeadersCount, $expectedCount); $i++) {\r\n        if (isset($csvHeaders[$i]) && isset($expectedColumns[$i]) && $csvHeaders[$i] !== $expectedColumns[$i]) {\r\n            $orderMismatch[] = [\r\n                'position' => $i + 1,\r\n                'expected' => $expectedColumns[$i],\r\n                'found' => $csvHeaders[$i]\r\n            ];\r\n        }\r\n    }\r\n    \r\n    // Uyumluluk kontrolü - Esnek yaklaşım\r\n    // Eğer CSV'deki tüm sütunlar beklenen sütunlar arasındaysa uyumlu sayalım\r\n    $isCompatible = (count($extraInCsv) == 0 && $matchingCount > 0);\r\n    \r\n    // Alternatif: Daha esnek kontrol - en az %80 eşleşme varsa uyumlu sayalım\r\n    $matchPercentage = $expectedCount > 0 ? ($matchingCount / $expectedCount) * 100 : 0;\r\n    if ($matchPercentage >= 80) {\r\n        $isCompatible = true;\r\n    }\r\n    \r\n    // Uyumluluk mesajı\r\n    $compatibilityMessage = $isCompatible \r\n        ? 'CSV dosyası SQL tablosu ile uyumlu' \r\n        : 'CSV dosyası SQL tablosu ile uyumlu değil';\r\n    \r\n    if (!$isCompatible && count($missingInCsv) > 0) {\r\n        $compatibilityMessage .= ' - Eksik sütunlar var';\r\n    }\r\n    \r\n    if (!$isCompatible && count($extraInCsv) > 0) {\r\n        $compatibilityMessage .= ' - Fazla sütunlar var';\r\n    }\r\n    \r\n    echo json_encode([\r\n        'success' => true,\r\n        'is_compatible' => $isCompatible,\r\n        'compatibility_message' => $compatibilityMessage,\r\n        'total_csv_columns' => $csvHeadersCount,\r\n        'total_expected_columns' => $expectedCount,\r\n        'matching_columns' => $matchingCount,\r\n        'match_percentage' => round($matchPercentage, 1),\r\n        'missing_in_csv' => array_values($missingInCsv),\r\n        'extra_in_csv' => array_values($extraInCsv),\r\n        'order_mismatch' => $orderMismatch,\r\n        'csv_headers' => $csvHeaders,\r\n        'expected_headers' => $expectedColumns\r\n    ]);\r\n    \r\n} catch (Exception $e) {\r\n    http_response_code(500);\r\n    echo json_encode([\r\n        'success' => false,\r\n        'message' => $e->getMessage(),\r\n        'is_compatible' => false\r\n    ]);\r\n}\r\n?>"
        }
    ]
}
{
    "sourceFile": "primebaz_rapor_yukle.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 9,
            "patches": [
                {
                    "date": 1759242376083,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1759246380265,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,23 +1,23 @@\n <?php\r\n-error_reporting(E_ALL);\r\n-ini_set('display_errors', 1);\r\n-\r\n session_start();\r\n \r\n-// Yetki kontrolü - GEÇİCİ OLARAK KAPALI\r\n-/*\r\n+// Kullanıcı giriş kontrolü\r\n if (!isset($_SESSION['user_id'])) {\r\n-    header('Location: login.php');\r\n-    exit;\r\n+    header(\"Location: login.php\");\r\n+    exit();\r\n }\r\n-*/\r\n \r\n-// Excel okuma için COM nesnesi kullanacağız\r\n-// require_once 'vendor/autoload.php'; // PhpSpreadsheet için\r\n-// use PhpOffice\\PhpSpreadsheet\\IOFactory;\r\n+// Hata raporlamayı aç (geliştirme aşamasında)\r\n+error_reporting(E_ALL);\r\n+ini_set('display_errors', 1);\r\n \r\n-class PrimebazMSSQLConnection {\r\n+include 'includes/header.php';\r\n+\r\n+/**\r\n+ * Primebaz Database Connection Class\r\n+ */\r\n+class PrimebazConnection {\r\n     private $connection;\r\n     private $config;\r\n     \r\n     public function __construct() {\r\n@@ -50,8 +50,11 @@\n     public function getConnection() {\r\n         return $this->connection;\r\n     }\r\n     \r\n+    /**\r\n+     * Primebaz rapor tablosunu oluştur (eğer yoksa)\r\n+     */\r\n     public function createPrimebazTable() {\r\n         $sql = \"\r\n         IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='primebaz_rapor' AND xtype='U')\r\n         CREATE TABLE primebaz_rapor (\r\n@@ -91,826 +94,331 @@\n             eklenme_tarihi DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n             guncellenme_tarihi DATETIME2,\r\n             dosya_adi NVARCHAR(255)\r\n         );\r\n-        \r\n-        -- İndeksler\r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_bayi_kodu')\r\n-        BEGIN\r\n-            CREATE INDEX IX_primebaz_rapor_bayi_kodu ON primebaz_rapor (bayi_kodu)\r\n-        END\r\n-        \r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_musteri_no')\r\n-        BEGIN\r\n-            CREATE INDEX IX_primebaz_rapor_musteri_no ON primebaz_rapor (musteri_no)\r\n-        END\r\n-        \r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_donem')\r\n-        BEGIN\r\n-            CREATE INDEX IX_primebaz_rapor_donem ON primebaz_rapor (yil, ay, donem)\r\n-        END\r\n-        \r\n-        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_tarih')\r\n-        BEGIN\r\n-            CREATE INDEX IX_primebaz_rapor_tarih ON primebaz_rapor (islem_tarihi)\r\n-        END\r\n         \";\r\n         \r\n         try {\r\n             $this->connection->exec($sql);\r\n         } catch (PDOException $e) {\r\n-            throw new Exception('Tablo oluşturma hatası: ' . $e->getMessage());\r\n+            throw new Exception('Primebaz tablosu oluşturma hatası: ' . $e->getMessage());\r\n         }\r\n     }\r\n     \r\n-    public function truncateTable() {\r\n-        $sql = \"TRUNCATE TABLE primebaz_rapor\";\r\n-        $this->connection->exec($sql);\r\n-    }\r\n-    \r\n-    public function convertDateFormat($dateString) {\r\n-        if (empty($dateString)) {\r\n-            return null;\r\n-        }\r\n-        \r\n-        // Excel tarih seri numarası ise\r\n-        if (is_numeric($dateString)) {\r\n-            try {\r\n-                $baseDate = new DateTime('1900-01-01');\r\n-                $days = intval($dateString) - 2; // Excel leap year bug adjustment\r\n-                $baseDate->add(new DateInterval('P' . $days . 'D'));\r\n-                return $baseDate->format('Y-m-d H:i:s');\r\n-            } catch (Exception $e) {\r\n-                // Fallback to text parsing\r\n-            }\r\n-        }\r\n-        \r\n-        $formats = [\r\n-            'd.m.Y H:i:s',\r\n-            'd.m.Y H:i',\r\n-            'd.m.Y',\r\n-            'd/m/Y H:i:s',\r\n-            'd/m/Y H:i',\r\n-            'd/m/Y',\r\n-            'Y-m-d H:i:s',\r\n-            'Y-m-d H:i',\r\n-            'Y-m-d',\r\n-            'm/d/Y H:i:s',\r\n-            'm/d/Y H:i',\r\n-            'm/d/Y'\r\n-        ];\r\n-        \r\n-        foreach ($formats as $format) {\r\n-            $date = DateTime::createFromFormat($format, $dateString);\r\n-            if ($date !== false) {\r\n-                return $date->format('Y-m-d H:i:s');\r\n-            }\r\n-        }\r\n-        \r\n-        return null;\r\n-    }\r\n-    \r\n-    public function parsePeriodFromFilename($filename) {\r\n-        // Dosya adından ay ve yıl bilgisini çıkar\r\n-        $aylar = [\r\n-            'OCAK' => 1, 'ŞUBAT' => 2, 'MART' => 3, 'NİSAN' => 4,\r\n-            'MAYIS' => 5, 'HAZİRAN' => 6, 'TEMMUZ' => 7, 'AĞUSTOS' => 8,\r\n-            'EYLUL' => 9, 'EKİM' => 10, 'KASIM' => 11, 'ARALIK' => 12\r\n-        ];\r\n-        \r\n-        $filename = strtoupper(str_replace('.xlsx', '', $filename));\r\n-        \r\n-        foreach ($aylar as $ay => $ayNo) {\r\n-            if (strpos($filename, $ay) !== false) {\r\n-                // Yıl bilgisini çıkar\r\n-                if (preg_match(\"/'(\\d{2})/\", $filename, $matches)) {\r\n-                    $yil = 2000 + intval($matches[1]);\r\n-                    return [\r\n-                        'ay' => $ayNo,\r\n-                        'yil' => $yil,\r\n-                        'donem' => $ay . ' ' . $yil\r\n-                    ];\r\n-                }\r\n-            }\r\n-        }\r\n-        \r\n-        return [\r\n-            'ay' => null,\r\n-            'yil' => null,\r\n-            'donem' => pathinfo($filename, PATHINFO_FILENAME)\r\n-        ];\r\n-    }\r\n-    \r\n-    public function insertBatchFromExcel($filePath, $fileName, $batchSize = 1000) {\r\n-        ini_set('memory_limit', '1024M');\r\n-        set_time_limit(3600);\r\n-        \r\n+    /**\r\n+     * Tablo kayıt sayısını al\r\n+     */\r\n+    public function getRecordCount() {\r\n         try {\r\n-            // COM nesnesi ile Excel dosyasını oku\r\n-            if (class_exists('COM')) {\r\n-                return $this->insertBatchFromExcelCOM($filePath, $fileName, $batchSize);\r\n-            } else {\r\n-                throw new Exception('COM desteği yok. Excel dosyalarını okumak için COM desteği gereklidir.');\r\n-            }\r\n-            \r\n+            $stmt = $this->connection->query(\"SELECT COUNT(*) as count FROM primebaz_rapor\");\r\n+            $result = $stmt->fetch();\r\n+            return $result['count'];\r\n         } catch (Exception $e) {\r\n-            throw new Exception('Excel okuma hatası: ' . $e->getMessage());\r\n+            return 0;\r\n         }\r\n     }\r\n     \r\n-    private function insertBatchFromExcelCOM($filePath, $fileName, $batchSize = 1000) {\r\n+    /**\r\n+     * Dönem bazında kayıt sayısını al\r\n+     */\r\n+    public function getRecordCountByDonem() {\r\n         try {\r\n-            $excel = new COM(\"Excel.Application\");\r\n-            $excel->Visible = false;\r\n-            $excel->DisplayAlerts = false;\r\n-            \r\n-            $workbook = $excel->Workbooks->Open($filePath);\r\n-            $worksheet = $workbook->Worksheets(1);\r\n-            $usedRange = $worksheet->UsedRange;\r\n-            \r\n-            $highestRow = $usedRange->Rows->Count;\r\n-            $highestColumn = $usedRange->Columns->Count;\r\n-            \r\n-            // Dosya adından dönem bilgisini çıkar\r\n-            $periodInfo = $this->parsePeriodFromFilename($fileName);\r\n-            \r\n-            // İlk satırı başlık olarak oku\r\n-            $headers = [];\r\n-            for ($col = 1; $col <= $highestColumn; $col++) {\r\n-                $headers[] = trim($worksheet->Cells(1, $col)->Text);\r\n-            }\r\n-            \r\n-            $this->connection->beginTransaction();\r\n-            \r\n-            // Prepared statement - sütun sayısını dinamik olarak ayarla\r\n-            $placeholders = str_repeat('?,', 32) . '?'; // 33 parametre\r\n-            $insertSql = \"INSERT INTO primebaz_rapor (\r\n-                bayi_kodu, bayi_adi, bolge, il, ilce, mahalle, alan_kodu,\r\n-                musteri_no, musteri_adi, musteri_soyadi, telefon, adres,\r\n-                urun_kodu, urun_adi, paket_kodu, paket_adi,\r\n-                baslangic_tarihi, bitis_tarihi, islem_tarihi, islem_tipi,\r\n-                tutar, komisyon_orani, komisyon_tutari, kdv_orani, kdv_tutari, toplam_tutar,\r\n-                odeme_tarihi, odeme_durumu, aciklama,\r\n-                ay, yil, donem, dosya_adi\r\n-            ) VALUES ($placeholders)\";\r\n-            \r\n-            $insertStmt = $this->connection->prepare($insertSql);\r\n-            \r\n-            $successCount = 0;\r\n-            $errorCount = 0;\r\n-            $errors = [];\r\n-            $batchCount = 0;\r\n-            \r\n-            // Veri satırlarını işle (başlık satırını atla)\r\n-            for ($row = 2; $row <= $highestRow; $row++) {\r\n-                try {\r\n-                    $rowData = [];\r\n-                    for ($col = 1; $col <= min($highestColumn, 30); $col++) { // Max 30 sütun oku\r\n-                        $rowData[] = $worksheet->Cells($row, $col)->Text;\r\n-                    }\r\n-                    \r\n-                    // Boş satırları atla\r\n-                    $hasData = false;\r\n-                    foreach ($rowData as $cell) {\r\n-                        if (!empty(trim($cell))) {\r\n-                            $hasData = true;\r\n-                            break;\r\n-                        }\r\n-                    }\r\n-                    if (!$hasData) continue;\r\n-                    \r\n-                    // Veriyi hazırla - Excel yapısına göre ayarlanmalı\r\n-                    $processedRow = [];\r\n-                    \r\n-                    // Sabit 29 alan + 4 sistem alanı = 33 toplam\r\n-                    for ($i = 0; $i < 29; $i++) {\r\n-                        if ($i >= 16 && $i <= 18) {\r\n-                            // Tarih alanları (16,17,18)\r\n-                            $processedRow[] = $this->convertDateFormat($this->getValueFromArray($rowData, $i));\r\n-                        } elseif ($i >= 20 && $i <= 25) {\r\n-                            // Sayısal alanlar (20-25)\r\n-                            $processedRow[] = $this->getNumericValueFromArray($rowData, $i);\r\n-                        } elseif ($i == 26) {\r\n-                            // Ödeme tarihi\r\n-                            $processedRow[] = $this->convertDateFormat($this->getValueFromArray($rowData, $i));\r\n-                        } else {\r\n-                            // Text alanlar\r\n-                            $processedRow[] = $this->getValueFromArray($rowData, $i);\r\n-                        }\r\n-                    }\r\n-                    \r\n-                    // Dönem bilgileri\r\n-                    $processedRow[] = $periodInfo['ay'];\r\n-                    $processedRow[] = $periodInfo['yil'];\r\n-                    $processedRow[] = $periodInfo['donem'];\r\n-                    $processedRow[] = $fileName;\r\n-                    \r\n-                    $insertStmt->execute($processedRow);\r\n-                    $successCount++;\r\n-                    \r\n-                } catch (PDOException $e) {\r\n-                    $errorCount++;\r\n-                    $errors[] = \"Satır $row: \" . $e->getMessage();\r\n-                    \r\n-                    if ($errorCount <= 5) {\r\n-                        error_log(\"Error on row $row: \" . $e->getMessage());\r\n-                    }\r\n-                }\r\n-                \r\n-                $batchCount++;\r\n-                if ($batchCount >= $batchSize) {\r\n-                    $this->connection->commit();\r\n-                    $this->connection->beginTransaction();\r\n-                    $batchCount = 0;\r\n-                    error_log(\"Processed $successCount rows from $fileName\");\r\n-                }\r\n-            }\r\n-            \r\n-            $this->connection->commit();\r\n-            \r\n-            // Excel nesnelerini temizle\r\n-            $workbook->Close();\r\n-            $excel->Quit();\r\n-            $excel = null;\r\n-            \r\n-            return [\r\n-                'success' => true,\r\n-                'successful' => $successCount,\r\n-                'errors' => $errorCount,\r\n-                'totalProcessed' => $successCount + $errorCount,\r\n-                'error_details' => $errors,\r\n-                'filename' => $fileName,\r\n-                'period' => $periodInfo\r\n-            ];\r\n-            \r\n+            $sql = \"SELECT donem, COUNT(*) as count FROM primebaz_rapor GROUP BY donem ORDER BY yil DESC, ay DESC\";\r\n+            $stmt = $this->connection->query($sql);\r\n+            return $stmt->fetchAll();\r\n         } catch (Exception $e) {\r\n-            $this->connection->rollback();\r\n-            \r\n-            // Excel nesnelerini temizle\r\n-            if (isset($workbook)) $workbook->Close();\r\n-            if (isset($excel)) {\r\n-                $excel->Quit();\r\n-                $excel = null;\r\n-            }\r\n-            \r\n-            throw $e;\r\n+            return [];\r\n         }\r\n     }\r\n     \r\n-    private function getValue($rowData, $index) {\r\n-        return isset($rowData[$index]) ? trim($rowData[$index]) : null;\r\n+    /**\r\n+     * Tabloyu temizle\r\n+     */\r\n+    public function truncateTable() {\r\n+        $sql = \"TRUNCATE TABLE primebaz_rapor\";\r\n+        $this->connection->exec($sql);\r\n     }\r\n     \r\n-    private function getValueFromArray($rowData, $index) {\r\n-        return isset($rowData[$index]) ? trim($rowData[$index]) : null;\r\n-    }\r\n-    \r\n-    private function getNumericValue($rowData, $index) {\r\n-        $value = $this->getValue($rowData, $index);\r\n-        if (empty($value)) return null;\r\n+    /**\r\n+     * Test verisi ekle\r\n+     */\r\n+    public function insertTestData() {\r\n+        $testData = [\r\n+            ['BAY001', 'Test Bayi 1', 'İstanbul', 'İstanbul', 'Kadıköy', 'Acıbadem', 'ALAN001', 'MUS001', 'Test', 'Müşteri', '05551234567', 'Test Adres', 'URN001', 'Test Ürün', 'PAK001', 'Test Paket', '2024-01-01', '2024-12-31', '2024-06-15', 'YENİ', 100.00, 5.5, 5.50, 18, 18.00, 123.50, '2024-06-20', 'ÖDENDİ', 'Test açıklama', 6, 2024, 'HAZİRAN\\'24', 'TEST.xlsx'],\r\n+            ['BAY002', 'Test Bayi 2', 'Ankara', 'Ankara', 'Çankaya', 'Kızılay', 'ALAN002', 'MUS002', 'Test2', 'Müşteri2', '05559876543', 'Test Adres 2', 'URN002', 'Test Ürün 2', 'PAK002', 'Test Paket 2', '2024-02-01', '2024-12-31', '2024-07-15', 'YENİ', 200.00, 6.0, 12.00, 18, 36.00, 248.00, '2024-07-20', 'ÖDENDİ', 'Test açıklama 2', 7, 2024, 'TEMMUZ\\'24', 'TEST.xlsx']\r\n+        ];\r\n         \r\n-        // Türkçe sayı formatını düzelt\r\n-        $value = str_replace('.', '', $value); // Binlik ayırıcı\r\n-        $value = str_replace(',', '.', $value); // Ondalık ayırıcı\r\n+        $sql = \"INSERT INTO primebaz_rapor (\r\n+            bayi_kodu, bayi_adi, bolge, il, ilce, mahalle, alan_kodu,\r\n+            musteri_no, musteri_adi, musteri_soyadi, telefon, adres,\r\n+            urun_kodu, urun_adi, paket_kodu, paket_adi,\r\n+            baslangic_tarihi, bitis_tarihi, islem_tarihi, islem_tipi,\r\n+            tutar, komisyon_orani, komisyon_tutari, kdv_orani, kdv_tutari, toplam_tutar,\r\n+            odeme_tarihi, odeme_durumu, aciklama,\r\n+            ay, yil, donem, dosya_adi\r\n+        ) VALUES (\r\n+            ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,\r\n+            ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,\r\n+            ?, ?, ?, ?\r\n+        )\";\r\n         \r\n-        return is_numeric($value) ? floatval($value) : null;\r\n-    }\r\n-    \r\n-    private function getNumericValueFromArray($rowData, $index) {\r\n-        $value = $this->getValueFromArray($rowData, $index);\r\n-        if (empty($value)) return null;\r\n+        $stmt = $this->connection->prepare($sql);\r\n         \r\n-        // Türkçe sayı formatını düzelt\r\n-        $value = str_replace('.', '', $value); // Binlik ayırıcı\r\n-        $value = str_replace(',', '.', $value); // Ondalık ayırıcı\r\n+        foreach ($testData as $row) {\r\n+            $stmt->execute($row);\r\n+        }\r\n         \r\n-        return is_numeric($value) ? floatval($value) : null;\r\n+        return count($testData);\r\n     }\r\n+    \r\n+    public function __destruct() {\r\n+        $this->connection = null;\r\n+    }\r\n }\r\n \r\n-$pageTitle = 'Primebaz Rapor Yükleme';\r\n-$breadcrumbs = [\r\n-    ['title' => 'Primebaz Rapor Yükleme']\r\n-];\r\n-\r\n+// İşlem kontrolü\r\n $message = '';\r\n $messageType = '';\r\n-$excelFiles = [];\r\n-$uploadResult = null;\r\n \r\n-// Excel dosyalarını listele\r\n-$uploadsDir = __DIR__ . '/uploads/primebaz';\r\n-if (is_dir($uploadsDir)) {\r\n-    $files = scandir($uploadsDir);\r\n-    foreach ($files as $file) {\r\n-        if (pathinfo($file, PATHINFO_EXTENSION) === 'xlsx') {\r\n-            $excelFiles[] = $file;\r\n+if ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n+    try {\r\n+        $db = new PrimebazConnection();\r\n+        \r\n+        if (isset($_POST['create_table'])) {\r\n+            $db->createPrimebazTable();\r\n+            $message = 'Primebaz tablosu başarıyla oluşturuldu!';\r\n+            $messageType = 'success';\r\n         }\r\n+        \r\n+        if (isset($_POST['add_test_data'])) {\r\n+            $db->createPrimebazTable(); // Tablo varsa hiçbir şey yapmaz\r\n+            $count = $db->insertTestData();\r\n+            $message = $count . ' adet test verisi başarıyla eklendi!';\r\n+            $messageType = 'success';\r\n+        }\r\n+        \r\n+        if (isset($_POST['truncate_table'])) {\r\n+            $db->truncateTable();\r\n+            $message = 'Primebaz tablosu başarıyla temizlendi!';\r\n+            $messageType = 'success';\r\n+        }\r\n+        \r\n+    } catch (Exception $e) {\r\n+        $message = 'Hata: ' . $e->getMessage();\r\n+        $messageType = 'danger';\r\n     }\r\n }\r\n \r\n-// AJAX istekleri için\r\n-if ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n-    if (isset($_POST['action'])) {\r\n-        header('Content-Type: application/json');\r\n-        \r\n-        if ($_POST['action'] === 'get_file_info') {\r\n-            $selectedFile = $_POST['file'] ?? '';\r\n-            if (empty($selectedFile) || !in_array($selectedFile, $excelFiles)) {\r\n-                echo json_encode(['success' => false, 'error' => 'Geçersiz dosya seçimi']);\r\n-                exit;\r\n-            }\r\n-            \r\n-            $filePath = $uploadsDir . '/' . $selectedFile;\r\n-            \r\n-            try {\r\n-                $db = new PrimebazMSSQLConnection();\r\n-                $periodInfo = $db->parsePeriodFromFilename($selectedFile);\r\n-                $fileSize = filesize($filePath);\r\n-                \r\n-                // COM nesnesi ile Excel dosyasını hızlıca oku\r\n-                try {\r\n-                    if (class_exists('COM')) {\r\n-                        $excel = new COM(\"Excel.Application\");\r\n-                        $excel->Visible = false;\r\n-                        $excel->DisplayAlerts = false;\r\n-                        \r\n-                        $workbook = $excel->Workbooks->Open($filePath);\r\n-                        $worksheet = $workbook->Worksheets(1);\r\n-                        $usedRange = $worksheet->UsedRange;\r\n-                        \r\n-                        $highestRow = $usedRange->Rows->Count;\r\n-                        $highestColumn = $usedRange->Columns->Count;\r\n-                        \r\n-                        // İlk satırı başlık olarak oku\r\n-                        $headers = [];\r\n-                        for ($col = 1; $col <= min($highestColumn, 20); $col++) { // Max 20 başlık oku\r\n-                            $headers[] = trim($worksheet->Cells(1, $col)->Text);\r\n-                        }\r\n-                        \r\n-                        $workbook->Close();\r\n-                        $excel->Quit();\r\n-                        $excel = null;\r\n-                    } else {\r\n-                        throw new Exception('COM desteği yok');\r\n-                    }\r\n-                    \r\n-                } catch (Exception $e) {\r\n-                    // COM hatası durumunda varsayılan değerler\r\n-                    $highestRow = 1000; // Tahmini değer\r\n-                    $highestColumn = 30;\r\n-                    $headers = [\r\n-                        'COM desteği bulunamadı',\r\n-                        'Excel dosyası analiz edilemedi',\r\n-                        'Yükleme işlemi deneyebilirsiniz'\r\n-                    ];\r\n-                }\r\n-                \r\n-                echo json_encode([\r\n-                    'success' => true,\r\n-                    'filename' => $selectedFile,\r\n-                    'fileSize' => $fileSize,\r\n-                    'totalRows' => $highestRow - 1, // Başlık satırını çıkar\r\n-                    'totalColumns' => $highestColumn,\r\n-                    'headers' => $headers,\r\n-                    'period' => $periodInfo,\r\n-                    'isCompatible' => true // Excel dosyası olduğu için uyumlu kabul et\r\n-                ]);\r\n-                \r\n-            } catch (Exception $e) {\r\n-                echo json_encode(['success' => false, 'error' => 'Dosya analiz hatası: ' . $e->getMessage()]);\r\n-            }\r\n-            exit;\r\n-        }\r\n-        \r\n-        if ($_POST['action'] === 'upload') {\r\n-            $selectedFile = $_POST['file'] ?? '';\r\n-            $truncate = isset($_POST['truncate']) && $_POST['truncate'] === '1';\r\n-            \r\n-            if (empty($selectedFile) || !in_array($selectedFile, $excelFiles)) {\r\n-                echo json_encode(['success' => false, 'error' => 'Geçersiz dosya seçimi']);\r\n-                exit;\r\n-            }\r\n-            \r\n-            try {\r\n-                $db = new PrimebazMSSQLConnection();\r\n-                $db->createPrimebazTable();\r\n-                \r\n-                if ($truncate) {\r\n-                    $db->truncateTable();\r\n-                }\r\n-                \r\n-                $result = $db->insertBatchFromExcel($uploadsDir . '/' . $selectedFile, $selectedFile);\r\n-                echo json_encode($result);\r\n-                \r\n-            } catch (Exception $e) {\r\n-                $errorDetails = [\r\n-                    'success' => false,\r\n-                    'error' => $e->getMessage(),\r\n-                    'file' => $e->getFile(),\r\n-                    'line' => $e->getLine()\r\n+// Mevcut dosyaları listele\r\n+$uploadDir = __DIR__ . '/uploads/primebaz/';\r\n+$files = [];\r\n+if (is_dir($uploadDir)) {\r\n+    $fileList = scandir($uploadDir);\r\n+    foreach ($fileList as $file) {\r\n+        if ($file != '.' && $file != '..' && (stripos($file, '.xlsx') !== false || stripos($file, '.xls') !== false)) {\r\n+            if (strpos($file, '~$') !== 0) { // Geçici dosyaları atla\r\n+                $filePath = $uploadDir . $file;\r\n+                $files[] = [\r\n+                    'name' => $file,\r\n+                    'size' => filesize($filePath),\r\n+                    'date' => date('d.m.Y H:i:s', filemtime($filePath))\r\n                 ];\r\n-                error_log(\"Upload hatası: \" . json_encode($errorDetails));\r\n-                echo json_encode($errorDetails);\r\n             }\r\n-            exit;\r\n         }\r\n     }\r\n }\r\n \r\n-include 'includes/header.php';\r\n+// Mevcut kayıt sayısını al\r\n+try {\r\n+    $db = new PrimebazConnection();\r\n+    $recordCount = $db->getRecordCount();\r\n+    $donemStats = $db->getRecordCountByDonem();\r\n+} catch (Exception $e) {\r\n+    $recordCount = 0;\r\n+    $donemStats = [];\r\n+}\r\n ?>\r\n \r\n-<div class=\"row\">\r\n-    <div class=\"col-12\">\r\n-        <div class=\"card\">\r\n-            <div class=\"card-header bg-success text-white\">\r\n-                <h4 class=\"card-title mb-0\">\r\n-                    <i class=\"fas fa-file-excel me-2\"></i>\r\n-                    Primebaz Rapor Yükleme\r\n-                </h4>\r\n-            </div>\r\n-            <div class=\"card-body\">\r\n-                <?php if (empty($excelFiles)): ?>\r\n-                    <div class=\"alert alert-warning\">\r\n-                        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n-                        Uploads/primebaz klasöründe Excel dosyası bulunamadı.\r\n-                    </div>\r\n-                <?php else: ?>\r\n-                    <div class=\"alert alert-info\">\r\n-                        <i class=\"fas fa-info-circle me-2\"></i>\r\n-                        <strong>Bilgi:</strong> Bu sayfa Primebaz Excel dosyalarını veritabanına yüklemek için kullanılır. \r\n-                        Excel dosyaları uploads/primebaz klasöründen otomatik olarak listelenir.\r\n-                    </div>\r\n-                    \r\n-                    <form id=\"uploadForm\">\r\n-                        <div class=\"row\">\r\n-                            <div class=\"col-md-6\">\r\n-                                <div class=\"mb-3\">\r\n-                                    <label for=\"excelFile\" class=\"form-label\">Excel Dosyası Seçin</label>\r\n-                                    <select class=\"form-select\" id=\"excelFile\" name=\"excelFile\" required>\r\n-                                        <option value=\"\">-- Dosya Seçin --</option>\r\n-                                        <?php foreach ($excelFiles as $file): ?>\r\n-                                            <option value=\"<?php echo htmlspecialchars($file); ?>\"><?php echo htmlspecialchars($file); ?></option>\r\n-                                        <?php endforeach; ?>\r\n-                                    </select>\r\n+<div class=\"container-fluid\">\r\n+    <div class=\"row\">\r\n+        <div class=\"col-12\">\r\n+            <h1 class=\"h3 mb-4 text-gray-800\">Primebaz Rapor Yükleme (Test Sürümü)</h1>\r\n+            \r\n+            <?php if ($message): ?>\r\n+                <div class=\"alert alert-<?php echo $messageType; ?> alert-dismissible fade show\" role=\"alert\">\r\n+                    <?php echo htmlspecialchars($message); ?>\r\n+                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n+                </div>\r\n+            <?php endif; ?>\r\n+            \r\n+            <!-- İstatistikler -->\r\n+            <div class=\"row mb-4\">\r\n+                <div class=\"col-xl-3 col-md-6 mb-4\">\r\n+                    <div class=\"card border-start border-primary border-4 shadow h-100 py-2\">\r\n+                        <div class=\"card-body\">\r\n+                            <div class=\"row no-gutters align-items-center\">\r\n+                                <div class=\"col me-2\">\r\n+                                    <div class=\"text-xs fw-bold text-primary text-uppercase mb-1\">\r\n+                                        Toplam Kayıt</div>\r\n+                                    <div class=\"h5 mb-0 fw-bold text-gray-800\"><?php echo number_format($recordCount); ?></div>\r\n                                 </div>\r\n-                            </div>\r\n-                            <div class=\"col-md-6\">\r\n-                                <div class=\"mb-3\">\r\n-                                    <label class=\"form-label\">Yükleme Seçenekleri</label>\r\n-                                    <div class=\"form-check\">\r\n-                                        <input class=\"form-check-input\" type=\"checkbox\" id=\"truncateTable\" name=\"truncateTable\" value=\"1\">\r\n-                                        <label class=\"form-check-label text-danger\" for=\"truncateTable\">\r\n-                                            <i class=\"fas fa-exclamation-triangle me-1\"></i>\r\n-                                            Mevcut verileri temizle (Dikkat: Tüm veriler silinir!)\r\n-                                        </label>\r\n-                                    </div>\r\n+                                <div class=\"col-auto\">\r\n+                                    <i class=\"fas fa-database fa-2x text-gray-300\"></i>\r\n                                 </div>\r\n                             </div>\r\n                         </div>\r\n-                        \r\n-                        <div id=\"fileAnalysis\" class=\"mb-4\" style=\"display: none;\">\r\n-                            <div class=\"card\">\r\n-                                <div class=\"card-header bg-info text-white\">\r\n-                                    <h6 class=\"mb-0\">\r\n-                                        <i class=\"fas fa-analytics me-2\"></i>\r\n-                                        Dosya Analizi\r\n-                                    </h6>\r\n+                    </div>\r\n+                </div>\r\n+                \r\n+                <div class=\"col-xl-3 col-md-6 mb-4\">\r\n+                    <div class=\"card border-start border-success border-4 shadow h-100 py-2\">\r\n+                        <div class=\"card-body\">\r\n+                            <div class=\"row no-gutters align-items-center\">\r\n+                                <div class=\"col me-2\">\r\n+                                    <div class=\"text-xs fw-bold text-success text-uppercase mb-1\">\r\n+                                        Excel Dosyası</div>\r\n+                                    <div class=\"h5 mb-0 fw-bold text-gray-800\"><?php echo count($files); ?></div>\r\n                                 </div>\r\n-                                <div class=\"card-body\">\r\n-                                    <div id=\"analysisContent\">\r\n-                                        <!-- Analysis content will be loaded here -->\r\n-                                    </div>\r\n+                                <div class=\"col-auto\">\r\n+                                    <i class=\"fas fa-file-excel fa-2x text-gray-300\"></i>\r\n                                 </div>\r\n                             </div>\r\n                         </div>\r\n-                        \r\n-                        <div class=\"d-flex gap-2\">\r\n-                            <button type=\"button\" id=\"analyzeBtn\" class=\"btn btn-info\" disabled>\r\n-                                <i class=\"fas fa-search me-2\"></i>\r\n-                                Dosyayı Analiz Et\r\n-                            </button>\r\n-                            <button type=\"submit\" id=\"uploadBtn\" class=\"btn btn-success\" disabled>\r\n-                                <i class=\"fas fa-upload me-2\"></i>\r\n-                                Yüklemeyi Başlat\r\n-                            </button>\r\n-                        </div>\r\n-                    </form>\r\n-                    \r\n-                    <div id=\"progressContainer\" class=\"mt-4\" style=\"display: none;\">\r\n-                        <div class=\"card\">\r\n-                            <div class=\"card-body\">\r\n-                                <h6>Yükleme Durumu:</h6>\r\n-                                <div class=\"progress mb-3\">\r\n-                                    <div id=\"progressBar\" class=\"progress-bar progress-bar-striped progress-bar-animated bg-success\" \r\n-                                         role=\"progressbar\" style=\"width: 0%\"></div>\r\n+                    </div>\r\n+                </div>\r\n+                \r\n+                <div class=\"col-xl-3 col-md-6 mb-4\">\r\n+                    <div class=\"card border-start border-info border-4 shadow h-100 py-2\">\r\n+                        <div class=\"card-body\">\r\n+                            <div class=\"row no-gutters align-items-center\">\r\n+                                <div class=\"col me-2\">\r\n+                                    <div class=\"text-xs fw-bold text-info text-uppercase mb-1\">\r\n+                                        Dönem Sayısı</div>\r\n+                                    <div class=\"h5 mb-0 fw-bold text-gray-800\"><?php echo count($donemStats); ?></div>\r\n                                 </div>\r\n-                                <div id=\"progressText\">Hazırlanıyor...</div>\r\n+                                <div class=\"col-auto\">\r\n+                                    <i class=\"fas fa-calendar fa-2x text-gray-300\"></i>\r\n+                                </div>\r\n                             </div>\r\n                         </div>\r\n                     </div>\r\n-                    \r\n-                    <div id=\"resultContainer\" class=\"mt-4\" style=\"display: none;\">\r\n-                        <div class=\"card\">\r\n-                            <div class=\"card-header bg-success text-white\">\r\n-                                <h6 class=\"mb-0\">\r\n-                                    <i class=\"fas fa-check-circle me-2\"></i>\r\n-                                    Yükleme Sonucu\r\n-                                </h6>\r\n-                            </div>\r\n-                            <div class=\"card-body\">\r\n-                                <div id=\"resultContent\">\r\n-                                    <!-- Result content will be loaded here -->\r\n+                </div>\r\n+                \r\n+                <div class=\"col-xl-3 col-md-6 mb-4\">\r\n+                    <div class=\"card border-start border-warning border-4 shadow h-100 py-2\">\r\n+                        <div class=\"card-body\">\r\n+                            <div class=\"row no-gutters align-items-center\">\r\n+                                <div class=\"col me-2\">\r\n+                                    <div class=\"text-xs fw-bold text-warning text-uppercase mb-1\">\r\n+                                        Dosya Boyutu</div>\r\n+                                    <div class=\"h5 mb-0 fw-bold text-gray-800\">\r\n+                                        <?php \r\n+                                        $totalSize = array_sum(array_column($files, 'size'));\r\n+                                        echo number_format($totalSize / 1024 / 1024, 1) . ' MB';\r\n+                                        ?>\r\n+                                    </div>\r\n                                 </div>\r\n+                                <div class=\"col-auto\">\r\n+                                    <i class=\"fas fa-hdd fa-2x text-gray-300\"></i>\r\n+                                </div>\r\n                             </div>\r\n                         </div>\r\n                     </div>\r\n-                <?php endif; ?>\r\n+                </div>\r\n             </div>\r\n-        </div>\r\n-    </div>\r\n-</div>\r\n-\r\n-<script>\r\n-$(document).ready(function() {\r\n-    let analysisData = null;\r\n-    \r\n-    // Dosya seçimi değiştiğinde\r\n-    $('#excelFile').change(function() {\r\n-        const selectedFile = $(this).val();\r\n-        if (selectedFile) {\r\n-            $('#analyzeBtn').prop('disabled', false);\r\n-            $('#fileAnalysis').hide();\r\n-            $('#uploadBtn').prop('disabled', true);\r\n-            analysisData = null;\r\n-        } else {\r\n-            $('#analyzeBtn').prop('disabled', true);\r\n-            $('#fileAnalysis').hide();\r\n-            $('#uploadBtn').prop('disabled', true);\r\n-        }\r\n-    });\r\n-    \r\n-    // Analiz butonu\r\n-    $('#analyzeBtn').click(function() {\r\n-        const selectedFile = $('#excelFile').val();\r\n-        if (!selectedFile) return;\r\n-        \r\n-        $(this).prop('disabled', true).html('<i class=\"fas fa-spinner fa-spin me-2\"></i>Analiz Ediliyor...');\r\n-        \r\n-        $.post('', {\r\n-            action: 'get_file_info',\r\n-            file: selectedFile\r\n-        })\r\n-        .done(function(response) {\r\n-            if (response.success) {\r\n-                analysisData = response;\r\n-                displayAnalysis(response);\r\n-                $('#fileAnalysis').show();\r\n-                $('#uploadBtn').prop('disabled', !response.isCompatible);\r\n-            } else {\r\n-                alert('Hata: ' + response.error);\r\n-            }\r\n-        })\r\n-        .fail(function() {\r\n-            alert('Sunucu hatası oluştu');\r\n-        })\r\n-        .always(function() {\r\n-            $('#analyzeBtn').prop('disabled', false).html('<i class=\"fas fa-search me-2\"></i>Dosyayı Analiz Et');\r\n-        });\r\n-    });\r\n-    \r\n-    // Upload form\r\n-    $('#uploadForm').submit(function(e) {\r\n-        e.preventDefault();\r\n-        \r\n-        if (!analysisData || !analysisData.isCompatible) {\r\n-            alert('Önce dosya analizi yapın');\r\n-            return;\r\n-        }\r\n-        \r\n-        const truncate = $('#truncateTable').is(':checked');\r\n-        if (truncate) {\r\n-            if (!confirm('UYARI: Bu işlem mevcut tüm Primebaz rapor verilerini silecektir. Devam etmek istediğinizden emin misiniz?')) {\r\n-                return;\r\n-            }\r\n-        }\r\n-        \r\n-        // Büyük dosya için ek uyarı\r\n-        if (analysisData.totalRows > 10000) {\r\n-            if (!confirm(`Bu dosyada ${analysisData.totalRows.toLocaleString()} kayıt bulunuyor. Yükleme işlemi uzun sürebilir ve sayfayı kapatmamanız gerekir. Devam etmek istiyor musunuz?`)) {\r\n-                return;\r\n-            }\r\n-        }\r\n-        \r\n-        startUpload();\r\n-    });\r\n-    \r\n-    function displayAnalysis(data) {\r\n-        let html = `\r\n-            <div class=\"row\">\r\n-                <div class=\"col-md-3\">\r\n-                    <div class=\"text-center\">\r\n-                        <div class=\"display-6 text-primary\">${data.totalColumns}</div>\r\n-                        <div class=\"text-muted\">Sütun Sayısı</div>\r\n-                    </div>\r\n+            \r\n+            <!-- İşlem Butonları -->\r\n+            <div class=\"card shadow mb-4\">\r\n+                <div class=\"card-header py-3\">\r\n+                    <h6 class=\"m-0 fw-bold text-primary\">İşlemler</h6>\r\n                 </div>\r\n-                <div class=\"col-md-3\">\r\n-                    <div class=\"text-center\">\r\n-                        <div class=\"display-6 text-info\">${data.totalRows.toLocaleString()}</div>\r\n-                        <div class=\"text-muted\">Kayıt Sayısı</div>\r\n-                    </div>\r\n+                <div class=\"card-body\">\r\n+                    <form method=\"post\" class=\"d-inline\">\r\n+                        <button type=\"submit\" name=\"create_table\" class=\"btn btn-primary btn-sm\">\r\n+                            <i class=\"fas fa-plus\"></i> Tablo Oluştur\r\n+                        </button>\r\n+                    </form>\r\n+                    \r\n+                    <form method=\"post\" class=\"d-inline ms-2\">\r\n+                        <button type=\"submit\" name=\"add_test_data\" class=\"btn btn-success btn-sm\">\r\n+                            <i class=\"fas fa-plus-circle\"></i> Test Verisi Ekle\r\n+                        </button>\r\n+                    </form>\r\n+                    \r\n+                    <form method=\"post\" class=\"d-inline ms-2\">\r\n+                        <button type=\"submit\" name=\"truncate_table\" class=\"btn btn-danger btn-sm\" \r\n+                                onclick=\"return confirm('Tüm veriler silinecek! Emin misiniz?')\">\r\n+                            <i class=\"fas fa-trash\"></i> Tabloyu Temizle\r\n+                        </button>\r\n+                    </form>\r\n                 </div>\r\n-                <div class=\"col-md-3\">\r\n-                    <div class=\"text-center\">\r\n-                        <div class=\"display-6 text-success\">${data.period.ay || 'N/A'}</div>\r\n-                        <div class=\"text-muted\">Ay</div>\r\n-                    </div>\r\n-                </div>\r\n-                <div class=\"col-md-3\">\r\n-                    <div class=\"text-center\">\r\n-                        <div class=\"display-6 text-warning\">${data.period.yil || 'N/A'}</div>\r\n-                        <div class=\"text-muted\">Yıl</div>\r\n-                    </div>\r\n-                </div>\r\n             </div>\r\n-            <hr>\r\n-        `;\r\n-        \r\n-        if (data.isCompatible) {\r\n-            html += `\r\n-                <div class=\"alert alert-success\">\r\n-                    <i class=\"fas fa-check-circle me-2\"></i>\r\n-                    <strong>Hazır!</strong> Excel dosyası yüklenmeye hazır.\r\n-                    <br><strong>Dönem:</strong> ${data.period.donem}\r\n-                    <br><strong>Dosya Boyutu:</strong> ${(data.fileSize / 1024 / 1024).toFixed(2)} MB\r\n-                </div>\r\n-            `;\r\n             \r\n-            // Büyük dosya uyarısı\r\n-            if (data.totalRows > 5000) {\r\n-                html += `\r\n-                    <div class=\"alert alert-info\">\r\n-                        <i class=\"fas fa-info-circle me-2\"></i>\r\n-                        <strong>Büyük Dosya:</strong> ${data.totalRows.toLocaleString()} kayıt tespit edildi. \r\n-                        Yükleme işlemi uzun sürebilir. Lütfen sayfayı kapatmayın.\r\n+            <!-- Dönem İstatistikleri -->\r\n+            <?php if (!empty($donemStats)): ?>\r\n+                <div class=\"card shadow mb-4\">\r\n+                    <div class=\"card-header py-3\">\r\n+                        <h6 class=\"m-0 fw-bold text-primary\">Dönem İstatistikleri</h6>\r\n                     </div>\r\n-                `;\r\n-            }\r\n-        } else {\r\n-            html += `\r\n-                <div class=\"alert alert-danger\">\r\n-                    <i class=\"fas fa-times-circle me-2\"></i>\r\n-                    <strong>Uyumsuz!</strong> Dosya yüklenemez.\r\n-                </div>\r\n-            `;\r\n-        }\r\n-        \r\n-        // Sütun listesi\r\n-        if (data.headers && data.headers.length > 0) {\r\n-            html += `\r\n-                <div class=\"mt-3\">\r\n-                    <h6>Dosyada Bulunan Sütunlar:</h6>\r\n-                    <div class=\"row\">\r\n-            `;\r\n-            \r\n-            data.headers.forEach(function(header, index) {\r\n-                if (index % 3 === 0) html += '<div class=\"col-md-4\">';\r\n-                html += `<small class=\"badge bg-light text-dark me-1 mb-1\">${header}</small><br>`;\r\n-                if ((index + 1) % 3 === 0 || index === data.headers.length - 1) html += '</div>';\r\n-            });\r\n-            \r\n-            html += `\r\n+                    <div class=\"card-body\">\r\n+                        <div class=\"table-responsive\">\r\n+                            <table class=\"table table-bordered\">\r\n+                                <thead>\r\n+                                    <tr>\r\n+                                        <th>Dönem</th>\r\n+                                        <th>Kayıt Sayısı</th>\r\n+                                    </tr>\r\n+                                </thead>\r\n+                                <tbody>\r\n+                                    <?php foreach ($donemStats as $stat): ?>\r\n+                                        <tr>\r\n+                                            <td><?php echo htmlspecialchars($stat['donem'] ?? 'Belirtilmemiş'); ?></td>\r\n+                                            <td><?php echo number_format($stat['count']); ?></td>\r\n+                                        </tr>\r\n+                                    <?php endforeach; ?>\r\n+                                </tbody>\r\n+                            </table>\r\n+                        </div>\r\n                     </div>\r\n                 </div>\r\n-            `;\r\n-        }\r\n-        \r\n-        $('#analysisContent').html(html);\r\n-    }\r\n-    \r\n-    function startUpload() {\r\n-        $('#uploadBtn').prop('disabled', true);\r\n-        $('#progressContainer').show();\r\n-        $('#resultContainer').hide();\r\n-        \r\n-        updateProgress(0, 'Yükleme başlatılıyor...');\r\n-        \r\n-        const selectedFile = $('#excelFile').val();\r\n-        const truncate = $('#truncateTable').is(':checked') ? '1' : '0';\r\n-        \r\n-        // Progress simulation for large files\r\n-        let progressInterval;\r\n-        let currentProgress = 0;\r\n-        \r\n-        if (analysisData && analysisData.totalRows > 2000) {\r\n-            progressInterval = setInterval(function() {\r\n-                if (currentProgress < 90) {\r\n-                    currentProgress += Math.random() * 2;\r\n-                    updateProgress(Math.min(currentProgress, 90), 'Veriler işleniyor... (' + Math.floor(currentProgress) + '%)');\r\n-                }\r\n-            }, 1500);\r\n-        }\r\n-        \r\n-        $.post('', {\r\n-            action: 'upload',\r\n-            file: selectedFile,\r\n-            truncate: truncate\r\n-        })\r\n-        .done(function(response) {\r\n-            if (progressInterval) {\r\n-                clearInterval(progressInterval);\r\n-            }\r\n-            updateProgress(100, 'Tamamlandı!');\r\n+            <?php endif; ?>\r\n             \r\n-            setTimeout(function() {\r\n-                $('#progressContainer').hide();\r\n-                displayResult(response);\r\n-            }, 1000);\r\n-        })\r\n-        .fail(function(xhr, status, error) {\r\n-            if (progressInterval) {\r\n-                clearInterval(progressInterval);\r\n-            }\r\n-            \r\n-            let errorMessage = 'Hata oluştu!';\r\n-            try {\r\n-                if (xhr.responseText) {\r\n-                    const response = JSON.parse(xhr.responseText);\r\n-                    errorMessage = response.error || errorMessage;\r\n-                    console.error('Upload Error Details:', response);\r\n-                }\r\n-            } catch (e) {\r\n-                errorMessage = xhr.responseText || error || 'Bilinmeyen hata';\r\n-            }\r\n-            \r\n-            updateProgress(100, errorMessage);\r\n-            $('#progressBar').removeClass('bg-success').addClass('bg-danger');\r\n-        })\r\n-        .always(function() {\r\n-            $('#uploadBtn').prop('disabled', false);\r\n-        });\r\n-    }\r\n-    \r\n-    function updateProgress(percent, text) {\r\n-        $('#progressBar').css('width', percent + '%');\r\n-        $('#progressText').text(text);\r\n-        \r\n-        if (percent === 100) {\r\n-            $('#progressBar').removeClass('progress-bar-animated');\r\n-        }\r\n-    }\r\n-    \r\n-    function displayResult(result) {\r\n-        let html = '';\r\n-        \r\n-        if (result.success) {\r\n-            html = `\r\n-                <div class=\"row text-center mb-3\">\r\n-                    <div class=\"col-md-4\">\r\n-                        <div class=\"display-6 text-success\">${result.successful || 0}</div>\r\n-                        <div class=\"text-muted\">Başarılı Kayıt</div>\r\n-                    </div>\r\n-                    <div class=\"col-md-4\">\r\n-                        <div class=\"display-6 text-danger\">${result.errors || 0}</div>\r\n-                        <div class=\"text-muted\">Hatalı Kayıt</div>\r\n-                    </div>\r\n-                    <div class=\"col-md-4\">\r\n-                        <div class=\"display-6 text-info\">${result.totalProcessed || 0}</div>\r\n-                        <div class=\"text-muted\">Toplam İşlenen</div>\r\n-                    </div>\r\n+            <!-- Dosya Listesi -->\r\n+            <div class=\"card shadow mb-4\">\r\n+                <div class=\"card-header py-3\">\r\n+                    <h6 class=\"m-0 fw-bold text-primary\">Primebaz Klasörü - Excel Dosyaları</h6>\r\n                 </div>\r\n-                \r\n-                <div class=\"alert alert-success\">\r\n-                    <i class=\"fas fa-check-circle me-2\"></i>\r\n-                    <strong>Başarılı!</strong> <code>${result.filename}</code> dosyası başarıyla işlendi.\r\n-                    <br><strong>Dönem:</strong> ${result.period ? result.period.donem : 'Bilinmiyor'}\r\n+                <div class=\"card-body\">\r\n+                    <?php if (empty($files)): ?>\r\n+                        <div class=\"alert alert-info\">\r\n+                            Primebaz klasöründe Excel dosyası bulunamadı.\r\n+                            <br><small class=\"text-muted\">Aranılan klasör: <?php echo htmlspecialchars($uploadDir); ?></small>\r\n+                        </div>\r\n+                    <?php else: ?>\r\n+                        <div class=\"table-responsive\">\r\n+                            <table class=\"table table-bordered\">\r\n+                                <thead>\r\n+                                    <tr>\r\n+                                        <th>Dosya Adı</th>\r\n+                                        <th>Boyut</th>\r\n+                                        <th>Değiştirilme Tarihi</th>\r\n+                                    </tr>\r\n+                                </thead>\r\n+                                <tbody>\r\n+                                    <?php foreach ($files as $file): ?>\r\n+                                        <tr>\r\n+                                            <td><?php echo htmlspecialchars($file['name']); ?></td>\r\n+                                            <td><?php echo number_format($file['size'] / 1024, 1); ?> KB</td>\r\n+                                            <td><?php echo $file['date']; ?></td>\r\n+                                        </tr>\r\n+                                    <?php endforeach; ?>\r\n+                                </tbody>\r\n+                            </table>\r\n+                        </div>\r\n+                    <?php endif; ?>\r\n                 </div>\r\n-            `;\r\n-            \r\n-            if (result.error_details && result.error_details.length > 0) {\r\n-                html += `\r\n-                    <div class=\"alert alert-warning\">\r\n-                        <strong>Hatalar:</strong>\r\n-                        <ul class=\"mb-0 mt-2\">\r\n-                            ${result.error_details.slice(0, 5).map(error => `<li><small>${error}</small></li>`).join('')}\r\n-                        </ul>\r\n-                        ${result.error_details.length > 5 ? `<small class=\"text-muted\">... ve ${result.error_details.length - 5} hata daha</small>` : ''}\r\n-                    </div>\r\n-                `;\r\n-            }\r\n-        } else {\r\n-            html = `\r\n-                <div class=\"alert alert-danger\">\r\n-                    <i class=\"fas fa-times-circle me-2\"></i>\r\n-                    <strong>Hata!</strong> ${result.error}\r\n-                </div>\r\n-            `;\r\n-        }\r\n-        \r\n-        $('#resultContent').html(html);\r\n-        $('#resultContainer').show();\r\n-    }\r\n-});\r\n-</script>\r\n+            </div>\r\n+        </div>\r\n+    </div>\r\n+</div>\r\n \r\n <?php include 'includes/footer.php'; ?>\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759249069078,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,23 +1,19 @@\n <?php\r\n+error_reporting(E_ALL);\r\n+ini_set('display_errors', 1);\r\n+\r\n session_start();\r\n \r\n-// Kullanıcı giriş kontrolü\r\n+// Yetki kontrolü - GEÇİCİ OLARAK KAPALI\r\n+/*\r\n if (!isset($_SESSION['user_id'])) {\r\n-    header(\"Location: login.php\");\r\n-    exit();\r\n+    header('Location: login.php');\r\n+    exit;\r\n }\r\n+*/\r\n \r\n-// Hata raporlamayı aç (geliştirme aşamasında)\r\n-error_reporting(E_ALL);\r\n-ini_set('display_errors', 1);\r\n-\r\n-include 'includes/header.php';\r\n-\r\n-/**\r\n- * Primebaz Database Connection Class\r\n- */\r\n-class PrimebazConnection {\r\n+class PrimebazMSSQLConnection {\r\n     private $connection;\r\n     private $config;\r\n     \r\n     public function __construct() {\r\n@@ -50,375 +46,1017 @@\n     public function getConnection() {\r\n         return $this->connection;\r\n     }\r\n     \r\n-    /**\r\n-     * Primebaz rapor tablosunu oluştur (eğer yoksa)\r\n-     */\r\n-    public function createPrimebazTable() {\r\n+    public function createPrimebazRaporTable() {\r\n         $sql = \"\r\n         IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='primebaz_rapor' AND xtype='U')\r\n         CREATE TABLE primebaz_rapor (\r\n-            id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n-            bayi_kodu NVARCHAR(50),\r\n-            bayi_adi NVARCHAR(200),\r\n-            bolge NVARCHAR(100),\r\n-            il NVARCHAR(50),\r\n-            ilce NVARCHAR(100),\r\n-            mahalle NVARCHAR(200),\r\n-            alan_kodu NVARCHAR(50),\r\n-            musteri_no NVARCHAR(50),\r\n-            musteri_adi NVARCHAR(200),\r\n-            musteri_soyadi NVARCHAR(200),\r\n-            telefon NVARCHAR(20),\r\n-            adres NVARCHAR(500),\r\n-            urun_kodu NVARCHAR(50),\r\n-            urun_adi NVARCHAR(200),\r\n-            paket_kodu NVARCHAR(50),\r\n-            paket_adi NVARCHAR(200),\r\n-            baslangic_tarihi DATETIME2,\r\n-            bitis_tarihi DATETIME2,\r\n-            islem_tarihi DATETIME2,\r\n-            islem_tipi NVARCHAR(50),\r\n-            tutar DECIMAL(10,2),\r\n-            komisyon_orani DECIMAL(5,2),\r\n-            komisyon_tutari DECIMAL(10,2),\r\n-            kdv_orani DECIMAL(5,2),\r\n-            kdv_tutari DECIMAL(10,2),\r\n-            toplam_tutar DECIMAL(10,2),\r\n-            odeme_tarihi DATETIME2,\r\n-            odeme_durumu NVARCHAR(50),\r\n-            aciklama NVARCHAR(500),\r\n-            ay INT,\r\n-            yil INT,\r\n-            donem NVARCHAR(20),\r\n-            eklenme_tarihi DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n-            guncellenme_tarihi DATETIME2,\r\n-            dosya_adi NVARCHAR(255)\r\n+            id INT IDENTITY(1,1) PRIMARY KEY,\r\n+            prim_detay NVARCHAR(400) NULL,\r\n+            prim_donem NVARCHAR(100) NULL,\r\n+            memo_acan_personel_kimlik NVARCHAR(100) NULL,\r\n+            bolge NVARCHAR(200) NULL,\r\n+            bayi_yoneticisi NVARCHAR(200) NULL,\r\n+            bayi_tip NVARCHAR(100) NULL,\r\n+            bayi_kodu INT NULL,\r\n+            bayi_adi NVARCHAR(300) NULL,\r\n+            sozlesme_no NVARCHAR(100) NULL,\r\n+            account_no INT NULL,\r\n+            outlet_no INT NULL,\r\n+            potansiyel_no INT NULL,\r\n+            kampanya_kodu NVARCHAR(200) NULL,\r\n+            sozlesme_durumu INT NULL,\r\n+            uye_durumu NVARCHAR(200) NULL,\r\n+            odeme_durum INT NULL,\r\n+            odeme_tarihi DATE NULL,\r\n+            prim_ust_urun_grubu NVARCHAR(200) NULL,\r\n+            basic_basari_skala NVARCHAR(40) NULL,\r\n+            cinema_basari_skala NVARCHAR(40) NULL,\r\n+            sport_basari_skala NVARCHAR(40) NULL,\r\n+            genel_basari_skala NVARCHAR(40) NULL,\r\n+            isp_basari_skala NVARCHAR(40) NULL,\r\n+            uyelik_turu NVARCHAR(100) NULL,\r\n+            kurulum_ziyaret_tipi NVARCHAR(200) NULL,\r\n+            kurulum_tipi_aciklama NVARCHAR(400) NULL,\r\n+            eski_ref_prim DECIMAL(12,2) NULL,\r\n+            odenecek_prim DECIMAL(12,2) NULL,\r\n+            mahsup_tutari_odeme_durumu DECIMAL(12,2) NULL,\r\n+            yonlendirme NVARCHAR(300) NULL,\r\n+            prim_durum_aciklama NVARCHAR(1000) NULL,\r\n+            dosya_adi NVARCHAR(510) NULL,\r\n+            olusturma_tarihi DATETIME NOT NULL DEFAULT GETDATE()\r\n         );\r\n         \";\r\n         \r\n         try {\r\n             $this->connection->exec($sql);\r\n         } catch (PDOException $e) {\r\n-            throw new Exception('Primebaz tablosu oluşturma hatası: ' . $e->getMessage());\r\n+            throw new Exception('Tablo oluşturma hatası: ' . $e->getMessage());\r\n         }\r\n     }\r\n     \r\n-    /**\r\n-     * Tablo kayıt sayısını al\r\n-     */\r\n-    public function getRecordCount() {\r\n-        try {\r\n-            $stmt = $this->connection->query(\"SELECT COUNT(*) as count FROM primebaz_rapor\");\r\n-            $result = $stmt->fetch();\r\n-            return $result['count'];\r\n-        } catch (Exception $e) {\r\n-            return 0;\r\n+    public function truncateTable() {\r\n+        $sql = \"TRUNCATE TABLE primebaz_rapor\";\r\n+        $this->connection->exec($sql);\r\n+    }\r\n+    \r\n+    public function convertDateFormat($dateString) {\r\n+        if (empty($dateString)) {\r\n+            return null;\r\n         }\r\n+        \r\n+        // Excel'den gelen tarih formatları\r\n+        $formats = [\r\n+            'd.m.Y',\r\n+            'd/m/Y',\r\n+            'm/d/Y',\r\n+            'Y-m-d',\r\n+            'd-m-Y',\r\n+            'Y/m/d',\r\n+            'd.m.Y H:i:s',\r\n+            'd/m/Y H:i:s',\r\n+            'Y-m-d H:i:s'\r\n+        ];\r\n+        \r\n+        foreach ($formats as $format) {\r\n+            $date = DateTime::createFromFormat($format, $dateString);\r\n+            if ($date !== false) {\r\n+                return $date->format('Y-m-d');\r\n+            }\r\n+        }\r\n+        \r\n+        // Excel serial date kontrolü (örn: 44927)\r\n+        if (is_numeric($dateString) && $dateString > 1 && $dateString < 100000) {\r\n+            try {\r\n+                $unixTimestamp = ($dateString - 25569) * 86400;\r\n+                $date = new DateTime('@' . $unixTimestamp);\r\n+                return $date->format('Y-m-d');\r\n+            } catch (Exception $e) {\r\n+                return null;\r\n+            }\r\n+        }\r\n+        \r\n+        return null;\r\n     }\r\n     \r\n-    /**\r\n-     * Dönem bazında kayıt sayısını al\r\n-     */\r\n-    public function getRecordCountByDonem() {\r\n-        try {\r\n-            $sql = \"SELECT donem, COUNT(*) as count FROM primebaz_rapor GROUP BY donem ORDER BY yil DESC, ay DESC\";\r\n-            $stmt = $this->connection->query($sql);\r\n-            return $stmt->fetchAll();\r\n-        } catch (Exception $e) {\r\n-            return [];\r\n+    public function convertDecimal($value) {\r\n+        if (empty($value) || !is_numeric($value)) {\r\n+            return null;\r\n         }\r\n+        return floatval($value);\r\n     }\r\n     \r\n-    /**\r\n-     * Tabloyu temizle\r\n-     */\r\n-    public function truncateTable() {\r\n-        $sql = \"TRUNCATE TABLE primebaz_rapor\";\r\n-        $this->connection->exec($sql);\r\n+    public function convertInteger($value) {\r\n+        if (empty($value) || !is_numeric($value)) {\r\n+            return null;\r\n+        }\r\n+        return intval($value);\r\n     }\r\n     \r\n-    /**\r\n-     * Test verisi ekle\r\n-     */\r\n-    public function insertTestData() {\r\n-        $testData = [\r\n-            ['BAY001', 'Test Bayi 1', 'İstanbul', 'İstanbul', 'Kadıköy', 'Acıbadem', 'ALAN001', 'MUS001', 'Test', 'Müşteri', '05551234567', 'Test Adres', 'URN001', 'Test Ürün', 'PAK001', 'Test Paket', '2024-01-01', '2024-12-31', '2024-06-15', 'YENİ', 100.00, 5.5, 5.50, 18, 18.00, 123.50, '2024-06-20', 'ÖDENDİ', 'Test açıklama', 6, 2024, 'HAZİRAN\\'24', 'TEST.xlsx'],\r\n-            ['BAY002', 'Test Bayi 2', 'Ankara', 'Ankara', 'Çankaya', 'Kızılay', 'ALAN002', 'MUS002', 'Test2', 'Müşteri2', '05559876543', 'Test Adres 2', 'URN002', 'Test Ürün 2', 'PAK002', 'Test Paket 2', '2024-02-01', '2024-12-31', '2024-07-15', 'YENİ', 200.00, 6.0, 12.00, 18, 36.00, 248.00, '2024-07-20', 'ÖDENDİ', 'Test açıklama 2', 7, 2024, 'TEMMUZ\\'24', 'TEST.xlsx']\r\n-        ];\r\n+    public function convertExcelToCsv($excelFilePath) {\r\n+        // Excel dosyasını CSV'ye dönüştürmek için COM kullan (Windows ortamında)\r\n+        $csvFilePath = str_replace(['.xlsx', '.xls'], '.csv', $excelFilePath);\r\n         \r\n-        $sql = \"INSERT INTO primebaz_rapor (\r\n-            bayi_kodu, bayi_adi, bolge, il, ilce, mahalle, alan_kodu,\r\n-            musteri_no, musteri_adi, musteri_soyadi, telefon, adres,\r\n-            urun_kodu, urun_adi, paket_kodu, paket_adi,\r\n-            baslangic_tarihi, bitis_tarihi, islem_tarihi, islem_tipi,\r\n-            tutar, komisyon_orani, komisyon_tutari, kdv_orani, kdv_tutari, toplam_tutar,\r\n-            odeme_tarihi, odeme_durumu, aciklama,\r\n-            ay, yil, donem, dosya_adi\r\n-        ) VALUES (\r\n-            ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,\r\n-            ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,\r\n-            ?, ?, ?, ?\r\n-        )\";\r\n+        // Eğer aynı isimde CSV dosyası varsa onu kullan\r\n+        if (file_exists($csvFilePath)) {\r\n+            return $csvFilePath;\r\n+        }\r\n         \r\n-        $stmt = $this->connection->prepare($sql);\r\n-        \r\n-        foreach ($testData as $row) {\r\n-            $stmt->execute($row);\r\n+        try {\r\n+            // COM kullanarak Excel'i aç\r\n+            if (class_exists('COM')) {\r\n+                $excel = new COM(\"Excel.Application\");\r\n+                $excel->Visible = false;\r\n+                $excel->DisplayAlerts = false;\r\n+                \r\n+                $workbook = $excel->Workbooks->Open($excelFilePath);\r\n+                $worksheet = $workbook->Worksheets(1);\r\n+                \r\n+                // CSV olarak kaydet\r\n+                $workbook->SaveAs($csvFilePath, 6); // 6 = CSV format\r\n+                \r\n+                $workbook->Close();\r\n+                $excel->Quit();\r\n+                \r\n+                // Bellek temizliği\r\n+                unset($worksheet);\r\n+                unset($workbook);\r\n+                unset($excel);\r\n+                \r\n+                return $csvFilePath;\r\n+            } else {\r\n+                throw new Exception('COM extension not available');\r\n+            }\r\n+            \r\n+        } catch (Exception $e) {\r\n+            // COM başarısız olursa kullanıcıya bilgi ver\r\n+            throw new Exception('Excel dosyası otomatik olarak CSV\\'ye dönüştürülemedi. Lütfen dosyayı Excel\\'de açıp \"Farklı Kaydet\" ile CSV formatında kaydedin veya aynı klasöre aynı isimde .csv dosyası yükleyin. Hata: ' . $e->getMessage());\r\n         }\r\n-        \r\n-        return count($testData);\r\n     }\r\n     \r\n-    public function __destruct() {\r\n-        $this->connection = null;\r\n+    public function processExcelFile($filePath, $fileName, $batchSize = 1000) {\r\n+        // Excel dosyasını CSV'ye dönüştür\r\n+        $csvFilePath = $this->convertExcelToCsv($filePath);\r\n+        \r\n+        try {\r\n+            $handle = fopen($csvFilePath, 'r');\r\n+            if (!$handle) {\r\n+                throw new Exception('Dönüştürülen CSV dosyası açılamadı');\r\n+            }\r\n+            \r\n+            // BOM kontrolü\r\n+            $bom = fread($handle, 4);\r\n+            if (substr($bom, 0, 3) === \"\\xEF\\xBB\\xBF\") {\r\n+                fseek($handle, 3);\r\n+            } else {\r\n+                rewind($handle);\r\n+            }\r\n+            \r\n+            // Başlık satırını oku\r\n+            $headers = null;\r\n+            $currentPos = ftell($handle);\r\n+            $headers = fgetcsv($handle, 0, ';', '\"', '\\\\');\r\n+            if (!$headers || count($headers) <= 1) {\r\n+                fseek($handle, $currentPos);\r\n+                $headers = fgetcsv($handle, 0, ',', '\"', '\\\\');\r\n+                if (!$headers || count($headers) <= 1) {\r\n+                    fseek($handle, $currentPos);\r\n+                    $headers = fgetcsv($handle, 0, \"\\t\", '\"', '\\\\');\r\n+                }\r\n+            }\r\n+            \r\n+            if (!$headers || count($headers) <= 1) {\r\n+                fclose($handle);\r\n+                throw new Exception('CSV başlıkları okunamadı');\r\n+            }\r\n+            \r\n+            $headers = array_map('trim', $headers);\r\n+            \r\n+            // Sütun eşleştirmesi (büyük/küçük harf duyarsız)\r\n+            $expectedColumns = [\r\n+                'prim_detay', 'prim_donem', 'memo_acan_personel_kimlik', 'bolge', 'bayi_yoneticisi',\r\n+                'bayi_tip', 'bayi_kodu', 'bayi_adi', 'sozlesme_no', 'account_no', 'outlet_no',\r\n+                'potansiyel_no', 'kampanya_kodu', 'sozlesme_durumu', 'uye_durumu', 'odeme_durum',\r\n+                'odeme_tarihi', 'prim_ust_urun_grubu', 'basic_basari_skala', 'cinema_basari_skala',\r\n+                'sport_basari_skala', 'genel_basari_skala', 'isp_basari_skala', 'uyelik_turu',\r\n+                'kurulum_ziyaret_tipi', 'kurulum_tipi_aciklama', 'eski_ref_prim', 'odenecek_prim',\r\n+                'mahsup_tutari_odeme_durumu', 'yonlendirme', 'prim_durum_aciklama'\r\n+            ];\r\n+            \r\n+            $columnMapping = [];\r\n+            foreach ($expectedColumns as $expected) {\r\n+                foreach ($headers as $index => $header) {\r\n+                    if (strtolower(trim($header)) === strtolower($expected)) {\r\n+                        $columnMapping[$expected] = $index;\r\n+                        break;\r\n+                    }\r\n+                }\r\n+            }\r\n+            \r\n+            // Delimiter tespiti\r\n+            $delimiter = ';';\r\n+            $currentPos = ftell($handle);\r\n+            $testLine = fgets($handle);\r\n+            if (substr_count($testLine, ';') < substr_count($testLine, ',')) {\r\n+                $delimiter = ',';\r\n+            }\r\n+            fseek($handle, $currentPos);\r\n+            \r\n+            // INSERT statement hazırla\r\n+            $insertSql = \"INSERT INTO primebaz_rapor (\r\n+                prim_detay, prim_donem, memo_acan_personel_kimlik, bolge, bayi_yoneticisi,\r\n+                bayi_tip, bayi_kodu, bayi_adi, sozlesme_no, account_no, outlet_no,\r\n+                potansiyel_no, kampanya_kodu, sozlesme_durumu, uye_durumu, odeme_durum,\r\n+                odeme_tarihi, prim_ust_urun_grubu, basic_basari_skala, cinema_basari_skala,\r\n+                sport_basari_skala, genel_basari_skala, isp_basari_skala, uyelik_turu,\r\n+                kurulum_ziyaret_tipi, kurulum_tipi_aciklama, eski_ref_prim, odenecek_prim,\r\n+                mahsup_tutari_odeme_durumu, yonlendirme, prim_durum_aciklama, dosya_adi\r\n+            ) VALUES (\" . str_repeat('?,', 31) . \"?)\";\r\n+            \r\n+            $insertStmt = $this->connection->prepare($insertSql);\r\n+            \r\n+            $this->connection->beginTransaction();\r\n+            \r\n+            $successCount = 0;\r\n+            $errorCount = 0;\r\n+            $skippedRows = 0;\r\n+            $errors = [];\r\n+            $batchCount = 0;\r\n+            $rowCount = 0;\r\n+            \r\n+            // Satır satır işle\r\n+            while (($row = fgetcsv($handle, 0, $delimiter, '\"', '\\\\')) !== false) {\r\n+                $rowCount++;\r\n+                \r\n+                // Boş satırları atla\r\n+                $hasData = false;\r\n+                foreach ($row as $cell) {\r\n+                    if (!empty(trim($cell))) {\r\n+                        $hasData = true;\r\n+                        break;\r\n+                    }\r\n+                }\r\n+                if (!$hasData) {\r\n+                    $skippedRows++;\r\n+                    continue;\r\n+                }\r\n+                \r\n+                // Sütun sayısı kontrolü\r\n+                if (count($row) < count($expectedColumns)) {\r\n+                    $skippedRows++;\r\n+                    continue;\r\n+                }\r\n+                if (count($row) > count($expectedColumns)) {\r\n+                    $row = array_slice($row, 0, count($expectedColumns));\r\n+                }\r\n+                \r\n+                // Verileri hazırla\r\n+                $processedRow = [];\r\n+                foreach ($expectedColumns as $column) {\r\n+                    $index = $columnMapping[$column] ?? null;\r\n+                    $value = ($index !== null && isset($row[$index])) ? trim($row[$index]) : null;\r\n+                    \r\n+                    if ($value === '') {\r\n+                        $value = null;\r\n+                    }\r\n+                    \r\n+                    // Veri tipine göre dönüşüm\r\n+                    if ($column === 'odeme_tarihi') {\r\n+                        $value = $this->convertDateFormat($value);\r\n+                    } elseif (in_array($column, ['bayi_kodu', 'account_no', 'outlet_no', 'potansiyel_no', 'sozlesme_durumu', 'odeme_durum'])) {\r\n+                        $value = $this->convertInteger($value);\r\n+                    } elseif (in_array($column, ['eski_ref_prim', 'odenecek_prim', 'mahsup_tutari_odeme_durumu'])) {\r\n+                        $value = $this->convertDecimal($value);\r\n+                    }\r\n+                    \r\n+                    $processedRow[] = $value;\r\n+                }\r\n+                $processedRow[] = $fileName; // dosya_adi\r\n+                \r\n+                try {\r\n+                    $insertStmt->execute($processedRow);\r\n+                    $successCount++;\r\n+                } catch (PDOException $e) {\r\n+                    $errorCount++;\r\n+                    $errors[] = \"Satır \" . ($rowCount + 1) . \": \" . $e->getMessage();\r\n+                    \r\n+                    if ($errorCount <= 5) {\r\n+                        error_log(\"Error on row \" . ($rowCount + 1) . \": \" . $e->getMessage());\r\n+                    }\r\n+                }\r\n+                \r\n+                $batchCount++;\r\n+                \r\n+                if ($batchCount >= $batchSize) {\r\n+                    $this->connection->commit();\r\n+                    $this->connection->beginTransaction();\r\n+                    $batchCount = 0;\r\n+                    error_log(\"Processed $rowCount rows from $fileName\");\r\n+                }\r\n+            }\r\n+            \r\n+            $this->connection->commit();\r\n+            fclose($handle);\r\n+            \r\n+            // Geçici CSV dosyasını sil\r\n+            if ($csvFilePath !== $filePath && file_exists($csvFilePath)) {\r\n+                unlink($csvFilePath);\r\n+            }\r\n+            \r\n+            return [\r\n+                'success' => true,\r\n+                'successful' => $successCount,\r\n+                'errors' => $errorCount,\r\n+                'totalProcessed' => $successCount + $errorCount,\r\n+                'skippedRows' => $skippedRows,\r\n+                'error_details' => $errors,\r\n+                'filename' => $fileName\r\n+            ];\r\n+            \r\n+        } catch (Exception $e) {\r\n+            if ($this->connection->inTransaction()) {\r\n+                $this->connection->rollBack();\r\n+            }\r\n+            fclose($handle);\r\n+            throw new Exception('CSV dosyası işleme hatası: ' . $e->getMessage());\r\n+        }\r\n     }\r\n }\r\n \r\n-// İşlem kontrolü\r\n+$pageTitle = 'Primebaz Rapor Yükleme';\r\n+$breadcrumbs = [\r\n+    ['title' => 'Primebaz Rapor Yükleme']\r\n+];\r\n+\r\n $message = '';\r\n $messageType = '';\r\n+$excelFiles = [];\r\n+$uploadResult = null;\r\n \r\n-if ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n-    try {\r\n-        $db = new PrimebazConnection();\r\n-        \r\n-        if (isset($_POST['create_table'])) {\r\n-            $db->createPrimebazTable();\r\n-            $message = 'Primebaz tablosu başarıyla oluşturuldu!';\r\n-            $messageType = 'success';\r\n+// Excel dosyalarını listele\r\n+$uploadsDir = __DIR__ . '/uploads/primebaz';\r\n+if (is_dir($uploadsDir)) {\r\n+    $files = scandir($uploadsDir);\r\n+    foreach ($files as $file) {\r\n+        $extension = strtolower(pathinfo($file, PATHINFO_EXTENSION));\r\n+        if (in_array($extension, ['xlsx', 'xls'])) {\r\n+            $excelFiles[] = $file;\r\n         }\r\n-        \r\n-        if (isset($_POST['add_test_data'])) {\r\n-            $db->createPrimebazTable(); // Tablo varsa hiçbir şey yapmaz\r\n-            $count = $db->insertTestData();\r\n-            $message = $count . ' adet test verisi başarıyla eklendi!';\r\n-            $messageType = 'success';\r\n-        }\r\n-        \r\n-        if (isset($_POST['truncate_table'])) {\r\n-            $db->truncateTable();\r\n-            $message = 'Primebaz tablosu başarıyla temizlendi!';\r\n-            $messageType = 'success';\r\n-        }\r\n-        \r\n-    } catch (Exception $e) {\r\n-        $message = 'Hata: ' . $e->getMessage();\r\n-        $messageType = 'danger';\r\n     }\r\n }\r\n \r\n-// Mevcut dosyaları listele\r\n-$uploadDir = __DIR__ . '/uploads/primebaz/';\r\n-$files = [];\r\n-if (is_dir($uploadDir)) {\r\n-    $fileList = scandir($uploadDir);\r\n-    foreach ($fileList as $file) {\r\n-        if ($file != '.' && $file != '..' && (stripos($file, '.xlsx') !== false || stripos($file, '.xls') !== false)) {\r\n-            if (strpos($file, '~$') !== 0) { // Geçici dosyaları atla\r\n-                $filePath = $uploadDir . $file;\r\n-                $files[] = [\r\n-                    'name' => $file,\r\n-                    'size' => filesize($filePath),\r\n-                    'date' => date('d.m.Y H:i:s', filemtime($filePath))\r\n+// AJAX istekleri için\r\n+if ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n+    if (isset($_POST['action'])) {\r\n+        header('Content-Type: application/json');\r\n+        \r\n+        if ($_POST['action'] === 'get_file_info') {\r\n+            $selectedFile = $_POST['file'] ?? '';\r\n+            if (empty($selectedFile) || !in_array($selectedFile, $excelFiles)) {\r\n+                echo json_encode(['success' => false, 'error' => 'Geçersiz dosya seçimi']);\r\n+                exit;\r\n+            }\r\n+            \r\n+            $filePath = $uploadsDir . '/' . $selectedFile;\r\n+            \r\n+            try {\r\n+                // Excel dosyasını CSV'ye dönüştür\r\n+                $db = new PrimebazMSSQLConnection();\r\n+                $csvFilePath = $db->convertExcelToCsv($filePath);\r\n+                \r\n+                $handle = fopen($csvFilePath, 'r');\r\n+                if (!$handle) {\r\n+                    throw new Exception('CSV dosyası açılamadı');\r\n+                }\r\n+                \r\n+                // BOM kontrolü\r\n+                $bom = fread($handle, 4);\r\n+                if (substr($bom, 0, 3) === \"\\xEF\\xBB\\xBF\") {\r\n+                    fseek($handle, 3);\r\n+                } else {\r\n+                    rewind($handle);\r\n+                }\r\n+                \r\n+                // Başlık satırını oku\r\n+                $headers = null;\r\n+                $currentPos = ftell($handle);\r\n+                $headers = fgetcsv($handle, 0, ';', '\"', '\\\\');\r\n+                if (!$headers || count($headers) <= 1) {\r\n+                    fseek($handle, $currentPos);\r\n+                    $headers = fgetcsv($handle, 0, ',', '\"', '\\\\');\r\n+                    if (!$headers || count($headers) <= 1) {\r\n+                        fseek($handle, $currentPos);\r\n+                        $headers = fgetcsv($handle, 0, \"\\t\", '\"', '\\\\');\r\n+                    }\r\n+                }\r\n+                \r\n+                if (!$headers || count($headers) <= 1) {\r\n+                    fclose($handle);\r\n+                    throw new Exception('CSV başlıkları okunamadı');\r\n+                }\r\n+                \r\n+                $headers = array_map('trim', $headers);\r\n+                \r\n+                // Toplam satır sayısını hesapla\r\n+                $totalRows = 0;\r\n+                $delimiter = ';';\r\n+                $testLine = fgets($handle);\r\n+                if (substr_count($testLine, ';') < substr_count($testLine, ',')) {\r\n+                    $delimiter = ',';\r\n+                }\r\n+                rewind($handle);\r\n+                fgetcsv($handle, 0, $delimiter); // Skip header\r\n+                \r\n+                while (($row = fgetcsv($handle, 0, $delimiter, '\"', '\\\\')) !== false) {\r\n+                    $hasData = false;\r\n+                    foreach ($row as $cell) {\r\n+                        if (!empty(trim($cell))) {\r\n+                            $hasData = true;\r\n+                            break;\r\n+                        }\r\n+                    }\r\n+                    if ($hasData) {\r\n+                        $totalRows++;\r\n+                    }\r\n+                }\r\n+                \r\n+                fclose($handle);\r\n+                \r\n+                // Geçici CSV dosyasını temizle\r\n+                if ($csvFilePath !== $filePath && file_exists($csvFilePath)) {\r\n+                    unlink($csvFilePath);\r\n+                }\r\n+                \r\n+                // Beklenen sütunlarla karşılaştır\r\n+                $expectedColumns = [\r\n+                    'prim_detay', 'prim_donem', 'memo_acan_personel_kimlik', 'bolge', 'bayi_yoneticisi',\r\n+                    'bayi_tip', 'bayi_kodu', 'bayi_adi', 'sozlesme_no', 'account_no', 'outlet_no',\r\n+                    'potansiyel_no', 'kampanya_kodu', 'sozlesme_durumu', 'uye_durumu', 'odeme_durum',\r\n+                    'odeme_tarihi', 'prim_ust_urun_grubu', 'basic_basari_skala', 'cinema_basari_skala',\r\n+                    'sport_basari_skala', 'genel_basari_skala', 'isp_basari_skala', 'uyelik_turu',\r\n+                    'kurulum_ziyaret_tipi', 'kurulum_tipi_aciklama', 'eski_ref_prim', 'odenecek_prim',\r\n+                    'mahsup_tutari_odeme_durumu', 'yonlendirme', 'prim_durum_aciklama'\r\n                 ];\r\n+                \r\n+                $matches = [];\r\n+                $missingColumns = [];\r\n+                $extraColumns = [];\r\n+                \r\n+                // Sütun eşleştirmeleri (büyük/küçük harf duyarsız)\r\n+                foreach ($expectedColumns as $expected) {\r\n+                    $found = false;\r\n+                    foreach ($headers as $index => $header) {\r\n+                        if (strtolower(trim($header)) === strtolower($expected)) {\r\n+                            $matches[$expected] = $index;\r\n+                            $found = true;\r\n+                            break;\r\n+                        }\r\n+                    }\r\n+                    if (!$found) {\r\n+                        $missingColumns[] = $expected;\r\n+                    }\r\n+                }\r\n+                \r\n+                foreach ($headers as $header) {\r\n+                    $found = false;\r\n+                    foreach ($expectedColumns as $expected) {\r\n+                        if (strtolower(trim($header)) === strtolower($expected)) {\r\n+                            $found = true;\r\n+                            break;\r\n+                        }\r\n+                    }\r\n+                    if (!$found && !empty(trim($header))) {\r\n+                        $extraColumns[] = $header;\r\n+                    }\r\n+                }\r\n+                \r\n+                $isCompatible = empty($missingColumns);\r\n+                \r\n+                echo json_encode([\r\n+                    'success' => true,\r\n+                    'headers' => $headers,\r\n+                    'expectedColumns' => $expectedColumns,\r\n+                    'matches' => $matches,\r\n+                    'missingColumns' => $missingColumns,\r\n+                    'extraColumns' => $extraColumns,\r\n+                    'isCompatible' => $isCompatible,\r\n+                    'totalRows' => $totalRows,\r\n+                    'fileSize' => round(filesize($filePath) / 1024 / 1024, 2) . ' MB'\r\n+                ]);\r\n+                \r\n+            } catch (Exception $e) {\r\n+                echo json_encode(['success' => false, 'error' => 'Dosya okuma hatası: ' . $e->getMessage()]);\r\n             }\r\n+            exit;\r\n         }\r\n+        \r\n+        if ($_POST['action'] === 'upload') {\r\n+            $selectedFile = $_POST['file'] ?? '';\r\n+            $truncate = isset($_POST['truncate']) && $_POST['truncate'] === '1';\r\n+            \r\n+            if (empty($selectedFile) || !in_array($selectedFile, $excelFiles)) {\r\n+                echo json_encode(['success' => false, 'error' => 'Geçersiz dosya seçimi']);\r\n+                exit;\r\n+            }\r\n+            \r\n+            try {\r\n+                $db = new PrimebazMSSQLConnection();\r\n+                $db->createPrimebazRaporTable();\r\n+                \r\n+                if ($truncate) {\r\n+                    $db->truncateTable();\r\n+                }\r\n+                \r\n+                $result = $db->processExcelFile($uploadsDir . '/' . $selectedFile, $selectedFile);\r\n+                echo json_encode($result);\r\n+            } catch (Exception $e) {\r\n+                $errorDetails = [\r\n+                    'success' => false,\r\n+                    'error' => $e->getMessage(),\r\n+                    'file' => $e->getFile(),\r\n+                    'line' => $e->getLine()\r\n+                ];\r\n+                error_log(\"Upload hatası: \" . json_encode($errorDetails));\r\n+                echo json_encode($errorDetails);\r\n+            }\r\n+            exit;\r\n+        }\r\n     }\r\n }\r\n \r\n-// Mevcut kayıt sayısını al\r\n-try {\r\n-    $db = new PrimebazConnection();\r\n-    $recordCount = $db->getRecordCount();\r\n-    $donemStats = $db->getRecordCountByDonem();\r\n-} catch (Exception $e) {\r\n-    $recordCount = 0;\r\n-    $donemStats = [];\r\n-}\r\n+include 'includes/header.php';\r\n ?>\r\n \r\n-<div class=\"container-fluid\">\r\n-    <div class=\"row\">\r\n-        <div class=\"col-12\">\r\n-            <h1 class=\"h3 mb-4 text-gray-800\">Primebaz Rapor Yükleme (Test Sürümü)</h1>\r\n-            \r\n-            <?php if ($message): ?>\r\n-                <div class=\"alert alert-<?php echo $messageType; ?> alert-dismissible fade show\" role=\"alert\">\r\n-                    <?php echo htmlspecialchars($message); ?>\r\n-                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n-                </div>\r\n-            <?php endif; ?>\r\n-            \r\n-            <!-- İstatistikler -->\r\n-            <div class=\"row mb-4\">\r\n-                <div class=\"col-xl-3 col-md-6 mb-4\">\r\n-                    <div class=\"card border-start border-primary border-4 shadow h-100 py-2\">\r\n-                        <div class=\"card-body\">\r\n-                            <div class=\"row no-gutters align-items-center\">\r\n-                                <div class=\"col me-2\">\r\n-                                    <div class=\"text-xs fw-bold text-primary text-uppercase mb-1\">\r\n-                                        Toplam Kayıt</div>\r\n-                                    <div class=\"h5 mb-0 fw-bold text-gray-800\"><?php echo number_format($recordCount); ?></div>\r\n+<div class=\"row\">\r\n+    <div class=\"col-12\">\r\n+        <div class=\"card\">\r\n+            <div class=\"card-header bg-success text-white\">\r\n+                <h4 class=\"card-title mb-0\">\r\n+                    <i class=\"fas fa-file-excel me-2\"></i>\r\n+                    Primebaz Rapor Yükleme\r\n+                </h4>\r\n+            </div>\r\n+            <div class=\"card-body\">\r\n+                <?php if (empty($excelFiles)): ?>\r\n+                    <div class=\"alert alert-warning\">\r\n+                        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n+                        Uploads/primebaz klasöründe Excel dosyası bulunamadı.\r\n+                    </div>\r\n+                <?php else: ?>\r\n+                    <form id=\"uploadForm\">\r\n+                        <div class=\"row\">\r\n+                            <div class=\"col-md-6\">\r\n+                                <div class=\"mb-3\">\r\n+                                    <label for=\"excelFile\" class=\"form-label\">Excel Dosyası Seçin</label>\r\n+                                    <select class=\"form-select\" id=\"excelFile\" name=\"excelFile\" required>\r\n+                                        <option value=\"\">-- Dosya Seçin --</option>\r\n+                                        <?php foreach ($excelFiles as $file): ?>\r\n+                                            <option value=\"<?php echo htmlspecialchars($file); ?>\"><?php echo htmlspecialchars($file); ?></option>\r\n+                                        <?php endforeach; ?>\r\n+                                    </select>\r\n                                 </div>\r\n-                                <div class=\"col-auto\">\r\n-                                    <i class=\"fas fa-database fa-2x text-gray-300\"></i>\r\n+                            </div>\r\n+                            <div class=\"col-md-6\">\r\n+                                <div class=\"mb-3\">\r\n+                                    <label class=\"form-label\">Yükleme Seçenekleri</label>\r\n+                                    <div class=\"form-check\">\r\n+                                        <input class=\"form-check-input\" type=\"checkbox\" id=\"truncateTable\" name=\"truncateTable\" value=\"1\">\r\n+                                        <label class=\"form-check-label text-danger\" for=\"truncateTable\">\r\n+                                            <i class=\"fas fa-exclamation-triangle me-1\"></i>\r\n+                                            Mevcut verileri temizle (Dikkat: Tüm veriler silinir!)\r\n+                                        </label>\r\n+                                    </div>\r\n                                 </div>\r\n                             </div>\r\n                         </div>\r\n-                    </div>\r\n-                </div>\r\n-                \r\n-                <div class=\"col-xl-3 col-md-6 mb-4\">\r\n-                    <div class=\"card border-start border-success border-4 shadow h-100 py-2\">\r\n-                        <div class=\"card-body\">\r\n-                            <div class=\"row no-gutters align-items-center\">\r\n-                                <div class=\"col me-2\">\r\n-                                    <div class=\"text-xs fw-bold text-success text-uppercase mb-1\">\r\n-                                        Excel Dosyası</div>\r\n-                                    <div class=\"h5 mb-0 fw-bold text-gray-800\"><?php echo count($files); ?></div>\r\n+                        \r\n+                        <div id=\"fileAnalysis\" class=\"mb-4\" style=\"display: none;\">\r\n+                            <div class=\"card\">\r\n+                                <div class=\"card-header bg-info text-white\">\r\n+                                    <h6 class=\"mb-0\">\r\n+                                        <i class=\"fas fa-analytics me-2\"></i>\r\n+                                        Dosya Analizi\r\n+                                    </h6>\r\n                                 </div>\r\n-                                <div class=\"col-auto\">\r\n-                                    <i class=\"fas fa-file-excel fa-2x text-gray-300\"></i>\r\n+                                <div class=\"card-body\">\r\n+                                    <div id=\"analysisContent\">\r\n+                                        <!-- Analysis content will be loaded here -->\r\n+                                    </div>\r\n                                 </div>\r\n                             </div>\r\n                         </div>\r\n+                        \r\n+                        <div class=\"d-flex gap-2\">\r\n+                            <button type=\"button\" id=\"analyzeBtn\" class=\"btn btn-info\" disabled>\r\n+                                <i class=\"fas fa-search me-2\"></i>\r\n+                                Dosyayı Analiz Et\r\n+                            </button>\r\n+                            <button type=\"submit\" id=\"uploadBtn\" class=\"btn btn-success\" disabled>\r\n+                                <i class=\"fas fa-upload me-2\"></i>\r\n+                                Yüklemeyi Başlat\r\n+                            </button>\r\n+                        </div>\r\n+                    </form>\r\n+                    \r\n+                    <div id=\"progressContainer\" class=\"mt-4\" style=\"display: none;\">\r\n+                        <div class=\"card\">\r\n+                            <div class=\"card-body\">\r\n+                                <h6>Yükleme Durumu:</h6>\r\n+                                <div class=\"progress mb-3\">\r\n+                                    <div id=\"progressBar\" class=\"progress-bar progress-bar-striped progress-bar-animated\" \r\n+                                         role=\"progressbar\" style=\"width: 0%\"></div>\r\n+                                </div>\r\n+                                <div id=\"progressText\">Hazırlanıyor...</div>\r\n+                            </div>\r\n+                        </div>\r\n                     </div>\r\n-                </div>\r\n-                \r\n-                <div class=\"col-xl-3 col-md-6 mb-4\">\r\n-                    <div class=\"card border-start border-info border-4 shadow h-100 py-2\">\r\n-                        <div class=\"card-body\">\r\n-                            <div class=\"row no-gutters align-items-center\">\r\n-                                <div class=\"col me-2\">\r\n-                                    <div class=\"text-xs fw-bold text-info text-uppercase mb-1\">\r\n-                                        Dönem Sayısı</div>\r\n-                                    <div class=\"h5 mb-0 fw-bold text-gray-800\"><?php echo count($donemStats); ?></div>\r\n+                    \r\n+                    <div id=\"resultContainer\" class=\"mt-4\" style=\"display: none;\">\r\n+                        <div class=\"card\">\r\n+                            <div class=\"card-header bg-success text-white\">\r\n+                                <h6 class=\"mb-0\">\r\n+                                    <i class=\"fas fa-check-circle me-2\"></i>\r\n+                                    Yükleme Sonucu\r\n+                                </h6>\r\n+                            </div>\r\n+                            <div class=\"card-body\">\r\n+                                <div id=\"resultContent\">\r\n+                                    <!-- Result content will be loaded here -->\r\n                                 </div>\r\n-                                <div class=\"col-auto\">\r\n-                                    <i class=\"fas fa-calendar fa-2x text-gray-300\"></i>\r\n-                                </div>\r\n                             </div>\r\n                         </div>\r\n                     </div>\r\n-                </div>\r\n-                \r\n-                <div class=\"col-xl-3 col-md-6 mb-4\">\r\n-                    <div class=\"card border-start border-warning border-4 shadow h-100 py-2\">\r\n-                        <div class=\"card-body\">\r\n-                            <div class=\"row no-gutters align-items-center\">\r\n-                                <div class=\"col me-2\">\r\n-                                    <div class=\"text-xs fw-bold text-warning text-uppercase mb-1\">\r\n-                                        Dosya Boyutu</div>\r\n-                                    <div class=\"h5 mb-0 fw-bold text-gray-800\">\r\n-                                        <?php \r\n-                                        $totalSize = array_sum(array_column($files, 'size'));\r\n-                                        echo number_format($totalSize / 1024 / 1024, 1) . ' MB';\r\n-                                        ?>\r\n+                    \r\n+                    <!-- Kullanım Rehberi -->\r\n+                    <div class=\"mt-4\">\r\n+                        <div class=\"card\">\r\n+                            <div class=\"card-header bg-light\">\r\n+                                <h6 class=\"mb-0\">\r\n+                                    <i class=\"fas fa-info-circle me-2\"></i>\r\n+                                    Kullanım Rehberi\r\n+                                </h6>\r\n+                            </div>\r\n+                            <div class=\"card-body\">\r\n+                                <div class=\"row\">\r\n+                                    <div class=\"col-md-6\">\r\n+                                        <h6>Excel Dosyası Gereksinimleri:</h6>\r\n+                                        <ul class=\"small\">\r\n+                                            <li>Desteklenen formatlar: .xlsx, .xls</li>\r\n+                                            <li>İlk satır sütun başlıkları olmalı</li>\r\n+                                            <li>Zorunlu sütunlar: prim_detay, prim_donem, bolge, bayi_adi vb.</li>\r\n+                                            <li>Tarih formatı: GG.AA.YYYY veya GG/AA/YYYY</li>\r\n+                                            <li>Sayısal değerler virgül veya nokta ile olabilir</li>\r\n+                                        </ul>\r\n                                     </div>\r\n+                                    <div class=\"col-md-6\">\r\n+                                        <h6>Yükleme Adımları:</h6>\r\n+                                        <ol class=\"small\">\r\n+                                            <li>Excel dosyasını uploads/primebaz klasörüne yükleyin</li>\r\n+                                            <li>Dosyayı seçin ve \"Dosyayı Analiz Et\" tıklayın</li>\r\n+                                            <li>Sütun uyumluluğunu kontrol edin</li>\r\n+                                            <li>\"Yüklemeyi Başlat\" ile işlemi tamamlayın</li>\r\n+                                        </ol>\r\n+                                        \r\n+                                        <div class=\"alert alert-info small mt-3\">\r\n+                                            <strong>Not:</strong> Excel dosyası otomatik CSV'ye dönüştürülemezse, \r\n+                                            dosyayı Excel'de açıp \"Farklı Kaydet > CSV\" ile aynı klasöre kaydedin.\r\n+                                        </div>\r\n+                                    </div>\r\n                                 </div>\r\n-                                <div class=\"col-auto\">\r\n-                                    <i class=\"fas fa-hdd fa-2x text-gray-300\"></i>\r\n-                                </div>\r\n                             </div>\r\n                         </div>\r\n                     </div>\r\n+                <?php endif; ?>\r\n+            </div>\r\n+        </div>\r\n+    </div>\r\n+</div>\r\n+\r\n+<script>\r\n+$(document).ready(function() {\r\n+    let analysisData = null;\r\n+    \r\n+    // Dosya seçimi değiştiğinde\r\n+    $('#excelFile').change(function() {\r\n+        const selectedFile = $(this).val();\r\n+        if (selectedFile) {\r\n+            $('#analyzeBtn').prop('disabled', false);\r\n+            $('#fileAnalysis').hide();\r\n+            $('#uploadBtn').prop('disabled', true);\r\n+            analysisData = null;\r\n+        } else {\r\n+            $('#analyzeBtn').prop('disabled', true);\r\n+            $('#fileAnalysis').hide();\r\n+            $('#uploadBtn').prop('disabled', true);\r\n+        }\r\n+    });\r\n+    \r\n+    // Analiz butonu\r\n+    $('#analyzeBtn').click(function() {\r\n+        const selectedFile = $('#excelFile').val();\r\n+        if (!selectedFile) return;\r\n+        \r\n+        $(this).prop('disabled', true).html('<i class=\"fas fa-spinner fa-spin me-2\"></i>Analiz Ediliyor...');\r\n+        \r\n+        $.post('', {\r\n+            action: 'get_file_info',\r\n+            file: selectedFile\r\n+        })\r\n+        .done(function(response) {\r\n+            if (response.success) {\r\n+                analysisData = response;\r\n+                displayAnalysis(response);\r\n+                $('#fileAnalysis').show();\r\n+                $('#uploadBtn').prop('disabled', !response.isCompatible);\r\n+            } else {\r\n+                alert('Hata: ' + response.error);\r\n+            }\r\n+        })\r\n+        .fail(function() {\r\n+            alert('Sunucu hatası oluştu');\r\n+        })\r\n+        .always(function() {\r\n+            $('#analyzeBtn').prop('disabled', false).html('<i class=\"fas fa-search me-2\"></i>Dosyayı Analiz Et');\r\n+        });\r\n+    });\r\n+    \r\n+    // Upload form\r\n+    $('#uploadForm').submit(function(e) {\r\n+        e.preventDefault();\r\n+        \r\n+        if (!analysisData || !analysisData.isCompatible) {\r\n+            alert('Önce dosya analizi yapın ve uyumluluğu kontrol edin');\r\n+            return;\r\n+        }\r\n+        \r\n+        const truncate = $('#truncateTable').is(':checked');\r\n+        if (truncate) {\r\n+            if (!confirm('UYARI: Bu işlem mevcut tüm Primebaz rapor verilerini silecektir. Devam etmek istediğinizden emin misiniz?')) {\r\n+                return;\r\n+            }\r\n+        }\r\n+        \r\n+        // Büyük dosya için ek uyarı\r\n+        if (analysisData.totalRows > 10000) {\r\n+            if (!confirm(`Bu dosyada ${analysisData.totalRows.toLocaleString()} kayıt bulunuyor. Yükleme işlemi birkaç dakika sürebilir ve sayfayı kapatmamanız gerekir. Devam etmek istiyor musunuz?`)) {\r\n+                return;\r\n+            }\r\n+        }\r\n+        \r\n+        startUpload();\r\n+    });\r\n+    \r\n+    function displayAnalysis(data) {\r\n+        let html = `\r\n+            <div class=\"row\">\r\n+                <div class=\"col-md-3\">\r\n+                    <div class=\"text-center\">\r\n+                        <div class=\"display-6 text-primary\">${data.headers.length}</div>\r\n+                        <div class=\"text-muted\">Excel Sütun Sayısı</div>\r\n+                    </div>\r\n                 </div>\r\n+                <div class=\"col-md-3\">\r\n+                    <div class=\"text-center\">\r\n+                        <div class=\"display-6 text-success\">${Object.keys(data.matches).length}</div>\r\n+                        <div class=\"text-muted\">Eşleşen Sütun</div>\r\n+                    </div>\r\n+                </div>\r\n+                <div class=\"col-md-3\">\r\n+                    <div class=\"text-center\">\r\n+                        <div class=\"display-6 text-info\">${data.totalRows || 'N/A'}</div>\r\n+                        <div class=\"text-muted\">Toplam Kayıt</div>\r\n+                    </div>\r\n+                </div>\r\n+                <div class=\"col-md-3\">\r\n+                    <div class=\"text-center\">\r\n+                        <div class=\"display-6 text-secondary\">${data.fileSize || 'N/A'}</div>\r\n+                        <div class=\"text-muted\">Dosya Boyutu</div>\r\n+                    </div>\r\n+                </div>\r\n             </div>\r\n+            <hr>\r\n+        `;\r\n+        \r\n+        if (data.isCompatible) {\r\n+            html += `\r\n+                <div class=\"alert alert-success\">\r\n+                    <i class=\"fas fa-check-circle me-2\"></i>\r\n+                    <strong>Uyumlu!</strong> Excel dosyası veritabanı yapısıyla uyumlu. Yükleme işlemi başlatılabilir.\r\n+                </div>\r\n+            `;\r\n             \r\n-            <!-- İşlem Butonları -->\r\n-            <div class=\"card shadow mb-4\">\r\n-                <div class=\"card-header py-3\">\r\n-                    <h6 class=\"m-0 fw-bold text-primary\">İşlemler</h6>\r\n+            // Büyük dosya uyarısı\r\n+            if (data.totalRows > 5000) {\r\n+                html += `\r\n+                    <div class=\"alert alert-info\">\r\n+                        <i class=\"fas fa-info-circle me-2\"></i>\r\n+                        <strong>Büyük Dosya:</strong> ${data.totalRows.toLocaleString()} kayıt tespit edildi. \r\n+                        Yükleme işlemi birkaç dakika sürebilir. Lütfen sayfayı kapatmayın.\r\n+                    </div>\r\n+                `;\r\n+            }\r\n+        } else {\r\n+            html += `\r\n+                <div class=\"alert alert-danger\">\r\n+                    <i class=\"fas fa-times-circle me-2\"></i>\r\n+                    <strong>Uyumsuz!</strong> Excel dosyasında bazı zorunlu sütunlar eksik.\r\n                 </div>\r\n-                <div class=\"card-body\">\r\n-                    <form method=\"post\" class=\"d-inline\">\r\n-                        <button type=\"submit\" name=\"create_table\" class=\"btn btn-primary btn-sm\">\r\n-                            <i class=\"fas fa-plus\"></i> Tablo Oluştur\r\n-                        </button>\r\n-                    </form>\r\n-                    \r\n-                    <form method=\"post\" class=\"d-inline ms-2\">\r\n-                        <button type=\"submit\" name=\"add_test_data\" class=\"btn btn-success btn-sm\">\r\n-                            <i class=\"fas fa-plus-circle\"></i> Test Verisi Ekle\r\n-                        </button>\r\n-                    </form>\r\n-                    \r\n-                    <form method=\"post\" class=\"d-inline ms-2\">\r\n-                        <button type=\"submit\" name=\"truncate_table\" class=\"btn btn-danger btn-sm\" \r\n-                                onclick=\"return confirm('Tüm veriler silinecek! Emin misiniz?')\">\r\n-                            <i class=\"fas fa-trash\"></i> Tabloyu Temizle\r\n-                        </button>\r\n-                    </form>\r\n+            `;\r\n+        }\r\n+        \r\n+        if (data.missingColumns.length > 0) {\r\n+            html += `\r\n+                <div class=\"alert alert-warning\">\r\n+                    <strong>Eksik Sütunlar:</strong><br>\r\n+                    ${data.missingColumns.map(col => `<span class=\"badge bg-warning text-dark me-1\">${col}</span>`).join('')}\r\n                 </div>\r\n+            `;\r\n+        }\r\n+        \r\n+        if (data.extraColumns.length > 0) {\r\n+            html += `\r\n+                <div class=\"alert alert-info\">\r\n+                    <strong>Fazladan Sütunlar (göz ardı edilecek):</strong><br>\r\n+                    ${data.extraColumns.map(col => `<span class=\"badge bg-info me-1\">${col}</span>`).join('')}\r\n+                </div>\r\n+            `;\r\n+        }\r\n+        \r\n+        // Sütun eşleştirmesi tablosu (sadece ilk 10 tanesi)\r\n+        html += `\r\n+            <div class=\"table-responsive mt-3\">\r\n+                <table class=\"table table-sm\">\r\n+                    <thead class=\"table-dark\">\r\n+                        <tr>\r\n+                            <th>Beklenen Sütun</th>\r\n+                            <th>Excel Sütunu</th>\r\n+                            <th>Durum</th>\r\n+                        </tr>\r\n+                    </thead>\r\n+                    <tbody>\r\n+        `;\r\n+        \r\n+        const columnsToShow = data.expectedColumns.slice(0, 10);\r\n+        columnsToShow.forEach(function(expected) {\r\n+            const excelColumn = data.headers[data.matches[expected]] || 'Bulunamadı';\r\n+            const status = data.matches[expected] !== undefined ? \r\n+                '<span class=\"badge bg-success\">✓ Eşleşti</span>' : \r\n+                '<span class=\"badge bg-danger\">✗ Eksik</span>';\r\n+            \r\n+            html += `\r\n+                <tr>\r\n+                    <td><code>${expected}</code></td>\r\n+                    <td>${excelColumn !== 'Bulunamadı' ? excelColumn : '<em>Bulunamadı</em>'}</td>\r\n+                    <td>${status}</td>\r\n+                </tr>\r\n+            `;\r\n+        });\r\n+        \r\n+        if (data.expectedColumns.length > 10) {\r\n+            html += `\r\n+                <tr>\r\n+                    <td colspan=\"3\" class=\"text-center text-muted\">\r\n+                        <em>... ve ${data.expectedColumns.length - 10} sütun daha</em>\r\n+                    </td>\r\n+                </tr>\r\n+            `;\r\n+        }\r\n+        \r\n+        html += `\r\n+                    </tbody>\r\n+                </table>\r\n             </div>\r\n+        `;\r\n+        \r\n+        $('#analysisContent').html(html);\r\n+    }\r\n+    \r\n+    function startUpload() {\r\n+        $('#uploadBtn').prop('disabled', true);\r\n+        $('#progressContainer').show();\r\n+        $('#resultContainer').hide();\r\n+        \r\n+        updateProgress(0, 'Yükleme başlatılıyor...');\r\n+        \r\n+        const selectedFile = $('#excelFile').val();\r\n+        const truncate = $('#truncateTable').is(':checked') ? '1' : '0';\r\n+        \r\n+        // Büyük dosyalar için progress simulation\r\n+        let progressInterval;\r\n+        let currentProgress = 0;\r\n+        \r\n+        if (analysisData && analysisData.totalRows > 1000) {\r\n+            progressInterval = setInterval(function() {\r\n+                if (currentProgress < 90) {\r\n+                    currentProgress += Math.random() * 2;\r\n+                    updateProgress(Math.min(currentProgress, 90), 'Excel dosyası işleniyor... (' + Math.floor(currentProgress) + '%)');\r\n+                }\r\n+            }, 1500);\r\n+        }\r\n+        \r\n+        $.post('', {\r\n+            action: 'upload',\r\n+            file: selectedFile,\r\n+            truncate: truncate\r\n+        })\r\n+        .done(function(response) {\r\n+            if (progressInterval) {\r\n+                clearInterval(progressInterval);\r\n+            }\r\n+            updateProgress(100, 'Tamamlandı!');\r\n             \r\n-            <!-- Dönem İstatistikleri -->\r\n-            <?php if (!empty($donemStats)): ?>\r\n-                <div class=\"card shadow mb-4\">\r\n-                    <div class=\"card-header py-3\">\r\n-                        <h6 class=\"m-0 fw-bold text-primary\">Dönem İstatistikleri</h6>\r\n+            setTimeout(function() {\r\n+                $('#progressContainer').hide();\r\n+                displayResult(response);\r\n+            }, 1000);\r\n+        })\r\n+        .fail(function(xhr, status, error) {\r\n+            if (progressInterval) {\r\n+                clearInterval(progressInterval);\r\n+            }\r\n+            \r\n+            let errorMessage = 'Hata oluştu!';\r\n+            try {\r\n+                if (xhr.responseText) {\r\n+                    const response = JSON.parse(xhr.responseText);\r\n+                    errorMessage = response.error || errorMessage;\r\n+                    console.error('Upload Error Details:', response);\r\n+                }\r\n+            } catch (e) {\r\n+                errorMessage = xhr.responseText || error || 'Bilinmeyen hata';\r\n+            }\r\n+            \r\n+            updateProgress(100, errorMessage);\r\n+            $('#progressBar').removeClass('bg-success').addClass('bg-danger');\r\n+        })\r\n+        .always(function() {\r\n+            $('#uploadBtn').prop('disabled', false);\r\n+        });\r\n+    }\r\n+    \r\n+    function updateProgress(percent, text) {\r\n+        $('#progressBar').css('width', percent + '%');\r\n+        $('#progressText').text(text);\r\n+        \r\n+        if (percent === 100) {\r\n+            $('#progressBar').removeClass('progress-bar-animated');\r\n+        }\r\n+    }\r\n+    \r\n+    function displayResult(result) {\r\n+        let html = '';\r\n+        \r\n+        if (result.success) {\r\n+            html = `\r\n+                <div class=\"row text-center mb-3\">\r\n+                    <div class=\"col-md-3\">\r\n+                        <div class=\"display-6 text-primary\">${result.totalProcessed || 0}</div>\r\n+                        <div class=\"text-muted\">İşlenen Kayıt</div>\r\n                     </div>\r\n-                    <div class=\"card-body\">\r\n-                        <div class=\"table-responsive\">\r\n-                            <table class=\"table table-bordered\">\r\n-                                <thead>\r\n-                                    <tr>\r\n-                                        <th>Dönem</th>\r\n-                                        <th>Kayıt Sayısı</th>\r\n-                                    </tr>\r\n-                                </thead>\r\n-                                <tbody>\r\n-                                    <?php foreach ($donemStats as $stat): ?>\r\n-                                        <tr>\r\n-                                            <td><?php echo htmlspecialchars($stat['donem'] ?? 'Belirtilmemiş'); ?></td>\r\n-                                            <td><?php echo number_format($stat['count']); ?></td>\r\n-                                        </tr>\r\n-                                    <?php endforeach; ?>\r\n-                                </tbody>\r\n-                            </table>\r\n-                        </div>\r\n+                    <div class=\"col-md-3\">\r\n+                        <div class=\"display-6 text-success\">${result.successful || 0}</div>\r\n+                        <div class=\"text-muted\">Başarılı</div>\r\n                     </div>\r\n+                    <div class=\"col-md-3\">\r\n+                        <div class=\"display-6 text-danger\">${result.errors || 0}</div>\r\n+                        <div class=\"text-muted\">Hata</div>\r\n+                    </div>\r\n+                    <div class=\"col-md-3\">\r\n+                        <div class=\"display-6 text-info\">${result.skippedRows || 0}</div>\r\n+                        <div class=\"text-muted\">Atlanan</div>\r\n+                    </div>\r\n                 </div>\r\n-            <?php endif; ?>\r\n+                \r\n+                <div class=\"alert alert-success\">\r\n+                    <i class=\"fas fa-check-circle me-2\"></i>\r\n+                    <strong>Başarılı!</strong> <code>${result.filename}</code> dosyası başarıyla işlendi.\r\n+                </div>\r\n+            `;\r\n             \r\n-            <!-- Dosya Listesi -->\r\n-            <div class=\"card shadow mb-4\">\r\n-                <div class=\"card-header py-3\">\r\n-                    <h6 class=\"m-0 fw-bold text-primary\">Primebaz Klasörü - Excel Dosyaları</h6>\r\n+            if (result.error_details && result.error_details.length > 0) {\r\n+                html += `\r\n+                    <div class=\"alert alert-warning\">\r\n+                        <strong>Hatalar:</strong>\r\n+                        <ul class=\"mb-0 mt-2\">\r\n+                            ${result.error_details.slice(0, 10).map(error => `<li><small>${error}</small></li>`).join('')}\r\n+                        </ul>\r\n+                        ${result.error_details.length > 10 ? `<small class=\"text-muted\">... ve ${result.error_details.length - 10} hata daha</small>` : ''}\r\n+                    </div>\r\n+                `;\r\n+            }\r\n+        } else {\r\n+            html = `\r\n+                <div class=\"alert alert-danger\">\r\n+                    <i class=\"fas fa-times-circle me-2\"></i>\r\n+                    <strong>Hata!</strong> ${result.error}\r\n                 </div>\r\n-                <div class=\"card-body\">\r\n-                    <?php if (empty($files)): ?>\r\n-                        <div class=\"alert alert-info\">\r\n-                            Primebaz klasöründe Excel dosyası bulunamadı.\r\n-                            <br><small class=\"text-muted\">Aranılan klasör: <?php echo htmlspecialchars($uploadDir); ?></small>\r\n-                        </div>\r\n-                    <?php else: ?>\r\n-                        <div class=\"table-responsive\">\r\n-                            <table class=\"table table-bordered\">\r\n-                                <thead>\r\n-                                    <tr>\r\n-                                        <th>Dosya Adı</th>\r\n-                                        <th>Boyut</th>\r\n-                                        <th>Değiştirilme Tarihi</th>\r\n-                                    </tr>\r\n-                                </thead>\r\n-                                <tbody>\r\n-                                    <?php foreach ($files as $file): ?>\r\n-                                        <tr>\r\n-                                            <td><?php echo htmlspecialchars($file['name']); ?></td>\r\n-                                            <td><?php echo number_format($file['size'] / 1024, 1); ?> KB</td>\r\n-                                            <td><?php echo $file['date']; ?></td>\r\n-                                        </tr>\r\n-                                    <?php endforeach; ?>\r\n-                                </tbody>\r\n-                            </table>\r\n-                        </div>\r\n-                    <?php endif; ?>\r\n-                </div>\r\n-            </div>\r\n-        </div>\r\n-    </div>\r\n-</div>\r\n+            `;\r\n+        }\r\n+        \r\n+        $('#resultContent').html(html);\r\n+        $('#resultContainer').show();\r\n+    }\r\n+});\r\n+</script>\r\n \r\n <?php include 'includes/footer.php'; ?>\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759306632252,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -152,53 +152,112 @@\n         }\r\n         return intval($value);\r\n     }\r\n     \r\n+    public function readExcelAsXML($excelFilePath) {\r\n+        // .xlsx dosyalarını ZIP olarak aç ve XML'den oku\r\n+        if (pathinfo($excelFilePath, PATHINFO_EXTENSION) !== 'xlsx') {\r\n+            throw new Exception('Sadece .xlsx formatı destekleniyor. Lütfen dosyayı .xlsx formatında kaydedin.');\r\n+        }\r\n+        \r\n+        $zip = new ZipArchive();\r\n+        if ($zip->open($excelFilePath) !== TRUE) {\r\n+            throw new Exception('Excel dosyası açılamadı');\r\n+        }\r\n+        \r\n+        // Shared strings oku\r\n+        $sharedStrings = [];\r\n+        $sharedStringsXML = $zip->getFromName('xl/sharedStrings.xml');\r\n+        if ($sharedStringsXML) {\r\n+            $xml = simplexml_load_string($sharedStringsXML);\r\n+            foreach ($xml->si as $si) {\r\n+                $sharedStrings[] = (string)$si->t;\r\n+            }\r\n+        }\r\n+        \r\n+        // İlk worksheet'i oku\r\n+        $worksheetXML = $zip->getFromName('xl/worksheets/sheet1.xml');\r\n+        if (!$worksheetXML) {\r\n+            throw new Exception('Worksheet bulunamadı');\r\n+        }\r\n+        \r\n+        $xml = simplexml_load_string($worksheetXML);\r\n+        $rows = [];\r\n+        \r\n+        foreach ($xml->sheetData->row as $row) {\r\n+            $rowData = [];\r\n+            $cellIndex = 0;\r\n+            \r\n+            foreach ($row->c as $cell) {\r\n+                $cellValue = '';\r\n+                \r\n+                // Cell type kontrolü\r\n+                $cellType = (string)$cell['t'];\r\n+                if ($cellType === 's') {\r\n+                    // Shared string\r\n+                    $stringIndex = (int)$cell->v;\r\n+                    $cellValue = isset($sharedStrings[$stringIndex]) ? $sharedStrings[$stringIndex] : '';\r\n+                } else {\r\n+                    // Normal değer\r\n+                    $cellValue = (string)$cell->v;\r\n+                }\r\n+                \r\n+                $rowData[] = $cellValue;\r\n+                $cellIndex++;\r\n+            }\r\n+            \r\n+            $rows[] = $rowData;\r\n+        }\r\n+        \r\n+        $zip->close();\r\n+        return $rows;\r\n+    }\r\n+    \r\n     public function convertExcelToCsv($excelFilePath) {\r\n-        // Excel dosyasını CSV'ye dönüştürmek için COM kullan (Windows ortamında)\r\n         $csvFilePath = str_replace(['.xlsx', '.xls'], '.csv', $excelFilePath);\r\n         \r\n         // Eğer aynı isimde CSV dosyası varsa onu kullan\r\n         if (file_exists($csvFilePath)) {\r\n             return $csvFilePath;\r\n         }\r\n         \r\n         try {\r\n-            // COM kullanarak Excel'i aç\r\n-            if (class_exists('COM')) {\r\n-                $excel = new COM(\"Excel.Application\");\r\n-                $excel->Visible = false;\r\n-                $excel->DisplayAlerts = false;\r\n+            // .xlsx dosyalarını XML olarak oku\r\n+            if (pathinfo($excelFilePath, PATHINFO_EXTENSION) === 'xlsx') {\r\n+                $rows = $this->readExcelAsXML($excelFilePath);\r\n                 \r\n-                $workbook = $excel->Workbooks->Open($excelFilePath);\r\n-                $worksheet = $workbook->Worksheets(1);\r\n+                // CSV dosyası oluştur\r\n+                $handle = fopen($csvFilePath, 'w');\r\n+                if (!$handle) {\r\n+                    throw new Exception('CSV dosyası oluşturulamadı');\r\n+                }\r\n                 \r\n-                // CSV olarak kaydet\r\n-                $workbook->SaveAs($csvFilePath, 6); // 6 = CSV format\r\n+                foreach ($rows as $row) {\r\n+                    fputcsv($handle, $row, ';');\r\n+                }\r\n                 \r\n-                $workbook->Close();\r\n-                $excel->Quit();\r\n-                \r\n-                // Bellek temizliği\r\n-                unset($worksheet);\r\n-                unset($workbook);\r\n-                unset($excel);\r\n-                \r\n+                fclose($handle);\r\n                 return $csvFilePath;\r\n             } else {\r\n-                throw new Exception('COM extension not available');\r\n+                throw new Exception('.xls formatı desteklenmiyor. Lütfen dosyayı .xlsx formatında kaydedin.');\r\n             }\r\n             \r\n         } catch (Exception $e) {\r\n-            // COM başarısız olursa kullanıcıya bilgi ver\r\n-            throw new Exception('Excel dosyası otomatik olarak CSV\\'ye dönüştürülemedi. Lütfen dosyayı Excel\\'de açıp \"Farklı Kaydet\" ile CSV formatında kaydedin veya aynı klasöre aynı isimde .csv dosyası yükleyin. Hata: ' . $e->getMessage());\r\n+            throw new Exception('Excel dosyası okunamadı: ' . $e->getMessage() . '. Lütfen dosyayı Excel\\'de açıp CSV formatında (\".csv\") kaydedin.');\r\n         }\r\n     }\r\n     \r\n     public function processExcelFile($filePath, $fileName, $batchSize = 1000) {\r\n-        // Excel dosyasını CSV'ye dönüştür\r\n-        $csvFilePath = $this->convertExcelToCsv($filePath);\r\n+        // Dosya türüne göre işlem yap\r\n+        $extension = strtolower(pathinfo($filePath, PATHINFO_EXTENSION));\r\n         \r\n+        if ($extension === 'csv') {\r\n+            $csvFilePath = $filePath; // Zaten CSV\r\n+        } else {\r\n+            // Excel dosyasını CSV'ye dönüştür\r\n+            $csvFilePath = $this->convertExcelToCsv($filePath);\r\n+        }\r\n+        \r\n         try {\r\n             $handle = fopen($csvFilePath, 'r');\r\n             if (!$handle) {\r\n                 throw new Exception('Dönüştürülen CSV dosyası açılamadı');\r\n@@ -232,8 +291,9 @@\n             \r\n             $headers = array_map('trim', $headers);\r\n             \r\n             // Sütun eşleştirmesi (büyük/küçük harf duyarsız)\r\n+            // Internal column names (veritabanı sütunları)\r\n             $expectedColumns = [\r\n                 'prim_detay', 'prim_donem', 'memo_acan_personel_kimlik', 'bolge', 'bayi_yoneticisi',\r\n                 'bayi_tip', 'bayi_kodu', 'bayi_adi', 'sozlesme_no', 'account_no', 'outlet_no',\r\n                 'potansiyel_no', 'kampanya_kodu', 'sozlesme_durumu', 'uye_durumu', 'odeme_durum',\r\n@@ -242,12 +302,26 @@\n                 'kurulum_ziyaret_tipi', 'kurulum_tipi_aciklama', 'eski_ref_prim', 'odenecek_prim',\r\n                 'mahsup_tutari_odeme_durumu', 'yonlendirme', 'prim_durum_aciklama'\r\n             ];\r\n             \r\n+            // Display names (kullanıcıya gösterilen başlıklar)\r\n+            $expectedDisplayColumns = [\r\n+                'PRİM DETAY', 'PRİM DÖNEM', 'MEMO_ACAN_PERSONEL_KIMLIK', 'BÖLGE', 'BAYİ YÖNETİCİSİ',\r\n+                'BAYİ TİP', 'BAYİ KODU', 'BAYİ ADI', 'SOZLESME_NO', 'ACCOUNT_NO', 'OUTLET NO',\r\n+                'POTANSİYEL_NO', 'KAMPANYA KODU', 'SÖZLEŞME DURUMU', 'ÜYE DURUMU', 'ODEME_DURUM',\r\n+                'ODEME_TARIHI', 'PRIM_UST_URUN_GRUBU', 'BASIC_BASARI_SKALA', 'CINEMA_BASARI_SKALA',\r\n+                'SPORT_BASARI_SKALA', 'GENEL_BASARI_SKALA', 'ISP_BASARI_SKALA', 'UYELIK_TURU',\r\n+                'KURULUM_ZIYARET_TIPI', 'KURULUM_TIPI_ACIKLAMA', 'ESKI_REF_PRIM', 'ODENECEK_PRIM',\r\n+                'MAHSUP TUTARI-ÖDEME DURUMU', 'Yönlendirme', 'PRİM DURUM AÇIKLAMA'\r\n+            ];\r\n+            \r\n             $columnMapping = [];\r\n-            foreach ($expectedColumns as $expected) {\r\n+            foreach ($expectedColumns as $i => $expected) {\r\n+                $displayName = $expectedDisplayColumns[$i];\r\n                 foreach ($headers as $index => $header) {\r\n-                    if (strtolower(trim($header)) === strtolower($expected)) {\r\n+                    $headerClean = strtolower(trim($header));\r\n+                    // Hem internal hem display names ile eşleştir\r\n+                    if ($headerClean === strtolower($expected) || $headerClean === strtolower($displayName)) {\r\n                         $columnMapping[$expected] = $index;\r\n                         break;\r\n                     }\r\n                 }\r\n@@ -357,10 +431,10 @@\n             \r\n             $this->connection->commit();\r\n             fclose($handle);\r\n             \r\n-            // Geçici CSV dosyasını sil\r\n-            if ($csvFilePath !== $filePath && file_exists($csvFilePath)) {\r\n+            // Geçici CSV dosyasını sil (sadece Excel'den dönüştürülmüşse)\r\n+            if ($extension !== 'csv' && $csvFilePath !== $filePath && file_exists($csvFilePath)) {\r\n                 unlink($csvFilePath);\r\n             }\r\n             \r\n             return [\r\n@@ -392,15 +466,15 @@\n $messageType = '';\r\n $excelFiles = [];\r\n $uploadResult = null;\r\n \r\n-// Excel dosyalarını listele\r\n+// Excel ve CSV dosyalarını listele\r\n $uploadsDir = __DIR__ . '/uploads/primebaz';\r\n if (is_dir($uploadsDir)) {\r\n     $files = scandir($uploadsDir);\r\n     foreach ($files as $file) {\r\n         $extension = strtolower(pathinfo($file, PATHINFO_EXTENSION));\r\n-        if (in_array($extension, ['xlsx', 'xls'])) {\r\n+        if (in_array($extension, ['xlsx', 'xls', 'csv'])) {\r\n             $excelFiles[] = $file;\r\n         }\r\n     }\r\n }\r\n@@ -419,12 +493,19 @@\n             \r\n             $filePath = $uploadsDir . '/' . $selectedFile;\r\n             \r\n             try {\r\n-                // Excel dosyasını CSV'ye dönüştür\r\n-                $db = new PrimebazMSSQLConnection();\r\n-                $csvFilePath = $db->convertExcelToCsv($filePath);\r\n+                // Dosya türüne göre işlem yap\r\n+                $extension = strtolower(pathinfo($filePath, PATHINFO_EXTENSION));\r\n                 \r\n+                if ($extension === 'csv') {\r\n+                    $csvFilePath = $filePath; // Zaten CSV\r\n+                } else {\r\n+                    // Excel dosyasını CSV'ye dönüştür\r\n+                    $db = new PrimebazMSSQLConnection();\r\n+                    $csvFilePath = $db->convertExcelToCsv($filePath);\r\n+                }\r\n+                \r\n                 $handle = fopen($csvFilePath, 'r');\r\n                 if (!$handle) {\r\n                     throw new Exception('CSV dosyası açılamadı');\r\n                 }\r\n@@ -481,14 +562,15 @@\n                 }\r\n                 \r\n                 fclose($handle);\r\n                 \r\n-                // Geçici CSV dosyasını temizle\r\n-                if ($csvFilePath !== $filePath && file_exists($csvFilePath)) {\r\n+                // Geçici CSV dosyasını temizle (sadece Excel'den dönüştürülmüşse)\r\n+                if ($extension !== 'csv' && $csvFilePath !== $filePath && file_exists($csvFilePath)) {\r\n                     unlink($csvFilePath);\r\n                 }\r\n                 \r\n                 // Beklenen sütunlarla karşılaştır\r\n+                // Internal column names (veritabanı sütunları)\r\n                 $expectedColumns = [\r\n                     'prim_detay', 'prim_donem', 'memo_acan_personel_kimlik', 'bolge', 'bayi_yoneticisi',\r\n                     'bayi_tip', 'bayi_kodu', 'bayi_adi', 'sozlesme_no', 'account_no', 'outlet_no',\r\n                     'potansiyel_no', 'kampanya_kodu', 'sozlesme_durumu', 'uye_durumu', 'odeme_durum',\r\n@@ -497,31 +579,47 @@\n                     'kurulum_ziyaret_tipi', 'kurulum_tipi_aciklama', 'eski_ref_prim', 'odenecek_prim',\r\n                     'mahsup_tutari_odeme_durumu', 'yonlendirme', 'prim_durum_aciklama'\r\n                 ];\r\n                 \r\n+                // Display names (kullanıcıya gösterilen başlıklar)\r\n+                $expectedDisplayColumns = [\r\n+                    'PRİM DETAY', 'PRİM DÖNEM', 'MEMO_ACAN_PERSONEL_KIMLIK', 'BÖLGE', 'BAYİ YÖNETİCİSİ',\r\n+                    'BAYİ TİP', 'BAYİ KODU', 'BAYİ ADI', 'SOZLESME_NO', 'ACCOUNT_NO', 'OUTLET NO',\r\n+                    'POTANSİYEL_NO', 'KAMPANYA KODU', 'SÖZLEŞME DURUMU', 'ÜYE DURUMU', 'ODEME_DURUM',\r\n+                    'ODEME_TARIHI', 'PRIM_UST_URUN_GRUBU', 'BASIC_BASARI_SKALA', 'CINEMA_BASARI_SKALA',\r\n+                    'SPORT_BASARI_SKALA', 'GENEL_BASARI_SKALA', 'ISP_BASARI_SKALA', 'UYELIK_TURU',\r\n+                    'KURULUM_ZIYARET_TIPI', 'KURULUM_TIPI_ACIKLAMA', 'ESKI_REF_PRIM', 'ODENECEK_PRIM',\r\n+                    'MAHSUP TUTARI-ÖDEME DURUMU', 'Yönlendirme', 'PRİM DURUM AÇIKLAMA'\r\n+                ];\r\n+                \r\n                 $matches = [];\r\n                 $missingColumns = [];\r\n                 $extraColumns = [];\r\n                 \r\n                 // Sütun eşleştirmeleri (büyük/küçük harf duyarsız)\r\n-                foreach ($expectedColumns as $expected) {\r\n+                foreach ($expectedColumns as $i => $expected) {\r\n+                    $displayName = $expectedDisplayColumns[$i];\r\n                     $found = false;\r\n                     foreach ($headers as $index => $header) {\r\n-                        if (strtolower(trim($header)) === strtolower($expected)) {\r\n+                        $headerClean = strtolower(trim($header));\r\n+                        // Hem internal hem display names ile eşleştir\r\n+                        if ($headerClean === strtolower($expected) || $headerClean === strtolower($displayName)) {\r\n                             $matches[$expected] = $index;\r\n                             $found = true;\r\n                             break;\r\n                         }\r\n                     }\r\n                     if (!$found) {\r\n-                        $missingColumns[] = $expected;\r\n+                        $missingColumns[] = $displayName; // Display name göster\r\n                     }\r\n                 }\r\n                 \r\n                 foreach ($headers as $header) {\r\n                     $found = false;\r\n-                    foreach ($expectedColumns as $expected) {\r\n-                        if (strtolower(trim($header)) === strtolower($expected)) {\r\n+                    $headerClean = strtolower(trim($header));\r\n+                    foreach ($expectedColumns as $i => $expected) {\r\n+                        $displayName = $expectedDisplayColumns[$i];\r\n+                        if ($headerClean === strtolower($expected) || $headerClean === strtolower($displayName)) {\r\n                             $found = true;\r\n                             break;\r\n                         }\r\n                     }\r\n@@ -534,9 +632,9 @@\n                 \r\n                 echo json_encode([\r\n                     'success' => true,\r\n                     'headers' => $headers,\r\n-                    'expectedColumns' => $expectedColumns,\r\n+                    'expectedColumns' => $expectedDisplayColumns, // Display names gönder\r\n                     'matches' => $matches,\r\n                     'missingColumns' => $missingColumns,\r\n                     'extraColumns' => $extraColumns,\r\n                     'isCompatible' => $isCompatible,\r\n@@ -599,22 +697,33 @@\n             <div class=\"card-body\">\r\n                 <?php if (empty($excelFiles)): ?>\r\n                     <div class=\"alert alert-warning\">\r\n                         <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n-                        Uploads/primebaz klasöründe Excel dosyası bulunamadı.\r\n+                        Uploads/primebaz klasöründe Excel (.xlsx) veya CSV dosyası bulunamadı.\r\n+                        <hr>\r\n+                        <small>\r\n+                            <strong>Dosya yükleme adımları:</strong><br>\r\n+                            1. Excel dosyanızı .xlsx formatında kaydedin<br>\r\n+                            2. Dosyayı <code>uploads/primebaz/</code> klasörüne kopyalayın<br>\r\n+                            3. Sayfayı yenileyin\r\n+                        </small>\r\n                     </div>\r\n                 <?php else: ?>\r\n                     <form id=\"uploadForm\">\r\n                         <div class=\"row\">\r\n                             <div class=\"col-md-6\">\r\n                                 <div class=\"mb-3\">\r\n-                                    <label for=\"excelFile\" class=\"form-label\">Excel Dosyası Seçin</label>\r\n+                                    <label for=\"excelFile\" class=\"form-label\">Excel/CSV Dosyası Seçin</label>\r\n                                     <select class=\"form-select\" id=\"excelFile\" name=\"excelFile\" required>\r\n                                         <option value=\"\">-- Dosya Seçin --</option>\r\n                                         <?php foreach ($excelFiles as $file): ?>\r\n-                                            <option value=\"<?php echo htmlspecialchars($file); ?>\"><?php echo htmlspecialchars($file); ?></option>\r\n+                                            <option value=\"<?php echo htmlspecialchars($file); ?>\">\r\n+                                                <?php echo htmlspecialchars($file); ?>\r\n+                                                <span class=\"text-muted\">(<?php echo strtoupper(pathinfo($file, PATHINFO_EXTENSION)); ?>)</span>\r\n+                                            </option>\r\n                                         <?php endforeach; ?>\r\n                                     </select>\r\n+                                    <div class=\"form-text\">Desteklenen formatlar: .xlsx, .csv</div>\r\n                                 </div>\r\n                             </div>\r\n                             <div class=\"col-md-6\">\r\n                                 <div class=\"mb-3\">\r\n@@ -698,29 +807,31 @@\n                             </div>\r\n                             <div class=\"card-body\">\r\n                                 <div class=\"row\">\r\n                                     <div class=\"col-md-6\">\r\n-                                        <h6>Excel Dosyası Gereksinimleri:</h6>\r\n+                                        <h6>Dosya Gereksinimleri:</h6>\r\n                                         <ul class=\"small\">\r\n-                                            <li>Desteklenen formatlar: .xlsx, .xls</li>\r\n+                                            <li>Desteklenen formatlar: .xlsx, .csv</li>\r\n                                             <li>İlk satır sütun başlıkları olmalı</li>\r\n-                                            <li>Zorunlu sütunlar: prim_detay, prim_donem, bolge, bayi_adi vb.</li>\r\n+                                            <li>Zorunlu sütunlar: PRİM DETAY, PRİM DÖNEM, BÖLGE, BAYİ ADI vb.</li>\r\n                                             <li>Tarih formatı: GG.AA.YYYY veya GG/AA/YYYY</li>\r\n                                             <li>Sayısal değerler virgül veya nokta ile olabilir</li>\r\n+                                            <li>CSV dosyaları noktalı virgül (;) ile ayrılmalı</li>\r\n                                         </ul>\r\n                                     </div>\r\n                                     <div class=\"col-md-6\">\r\n                                         <h6>Yükleme Adımları:</h6>\r\n                                         <ol class=\"small\">\r\n-                                            <li>Excel dosyasını uploads/primebaz klasörüne yükleyin</li>\r\n+                                            <li>Excel (.xlsx) veya CSV dosyasını uploads/primebaz klasörüne yükleyin</li>\r\n                                             <li>Dosyayı seçin ve \"Dosyayı Analiz Et\" tıklayın</li>\r\n                                             <li>Sütun uyumluluğunu kontrol edin</li>\r\n                                             <li>\"Yüklemeyi Başlat\" ile işlemi tamamlayın</li>\r\n                                         </ol>\r\n                                         \r\n-                                        <div class=\"alert alert-info small mt-3\">\r\n-                                            <strong>Not:</strong> Excel dosyası otomatik CSV'ye dönüştürülemezse, \r\n-                                            dosyayı Excel'de açıp \"Farklı Kaydet > CSV\" ile aynı klasöre kaydedin.\r\n+                                        <div class=\"alert alert-warning small mt-3\">\r\n+                                            <strong>Önemli:</strong> .xls dosyaları desteklenmez. Excel'de dosyayı \r\n+                                            \"Farklı Kaydet > Excel Çalışma Kitabı (.xlsx)\" veya \"CSV (Noktalı virgülle ayrılmış)\" \r\n+                                            formatında kaydedin.\r\n                                         </div>\r\n                                     </div>\r\n                                 </div>\r\n                             </div>\r\n@@ -811,9 +922,9 @@\n             <div class=\"row\">\r\n                 <div class=\"col-md-3\">\r\n                     <div class=\"text-center\">\r\n                         <div class=\"display-6 text-primary\">${data.headers.length}</div>\r\n-                        <div class=\"text-muted\">Excel Sütun Sayısı</div>\r\n+                        <div class=\"text-muted\">Dosya Sütun Sayısı</div>\r\n                     </div>\r\n                 </div>\r\n                 <div class=\"col-md-3\">\r\n                     <div class=\"text-center\">\r\n@@ -948,9 +1059,9 @@\n         if (analysisData && analysisData.totalRows > 1000) {\r\n             progressInterval = setInterval(function() {\r\n                 if (currentProgress < 90) {\r\n                     currentProgress += Math.random() * 2;\r\n-                    updateProgress(Math.min(currentProgress, 90), 'Excel dosyası işleniyor... (' + Math.floor(currentProgress) + '%)');\r\n+                                                updateProgress(Math.min(currentProgress, 90), 'Excel/CSV dosyası işleniyor... (' + Math.floor(currentProgress) + '%)');\r\n                 }\r\n             }, 1500);\r\n         }\r\n         \r\n"
                },
                {
                    "date": 1759306708134,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -992,54 +992,8 @@\n                 </div>\r\n             `;\r\n         }\r\n         \r\n-        // Sütun eşleştirmesi tablosu (sadece ilk 10 tanesi)\r\n-        html += `\r\n-            <div class=\"table-responsive mt-3\">\r\n-                <table class=\"table table-sm\">\r\n-                    <thead class=\"table-dark\">\r\n-                        <tr>\r\n-                            <th>Beklenen Sütun</th>\r\n-                            <th>Excel Sütunu</th>\r\n-                            <th>Durum</th>\r\n-                        </tr>\r\n-                    </thead>\r\n-                    <tbody>\r\n-        `;\r\n-        \r\n-        const columnsToShow = data.expectedColumns.slice(0, 10);\r\n-        columnsToShow.forEach(function(expected) {\r\n-            const excelColumn = data.headers[data.matches[expected]] || 'Bulunamadı';\r\n-            const status = data.matches[expected] !== undefined ? \r\n-                '<span class=\"badge bg-success\">✓ Eşleşti</span>' : \r\n-                '<span class=\"badge bg-danger\">✗ Eksik</span>';\r\n-            \r\n-            html += `\r\n-                <tr>\r\n-                    <td><code>${expected}</code></td>\r\n-                    <td>${excelColumn !== 'Bulunamadı' ? excelColumn : '<em>Bulunamadı</em>'}</td>\r\n-                    <td>${status}</td>\r\n-                </tr>\r\n-            `;\r\n-        });\r\n-        \r\n-        if (data.expectedColumns.length > 10) {\r\n-            html += `\r\n-                <tr>\r\n-                    <td colspan=\"3\" class=\"text-center text-muted\">\r\n-                        <em>... ve ${data.expectedColumns.length - 10} sütun daha</em>\r\n-                    </td>\r\n-                </tr>\r\n-            `;\r\n-        }\r\n-        \r\n-        html += `\r\n-                    </tbody>\r\n-                </table>\r\n-            </div>\r\n-        `;\r\n-        \r\n         $('#analysisContent').html(html);\r\n     }\r\n     \r\n     function startUpload() {\r\n"
                },
                {
                    "date": 1759306899358,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -627,9 +627,9 @@\n                         $extraColumns[] = $header;\r\n                     }\r\n                 }\r\n                 \r\n-                $isCompatible = empty($missingColumns);\r\n+                $isCompatible = true; // Eksik sütunlar olsa bile yüklemeye izin ver\r\n                 \r\n                 echo json_encode([\r\n                     'success' => true,\r\n                     'headers' => $headers,\r\n@@ -877,9 +877,9 @@\n             if (response.success) {\r\n                 analysisData = response;\r\n                 displayAnalysis(response);\r\n                 $('#fileAnalysis').show();\r\n-                $('#uploadBtn').prop('disabled', !response.isCompatible);\r\n+                $('#uploadBtn').prop('disabled', false); // Her zaman aktif et\r\n             } else {\r\n                 alert('Hata: ' + response.error);\r\n             }\r\n         })\r\n@@ -894,10 +894,10 @@\n     // Upload form\r\n     $('#uploadForm').submit(function(e) {\r\n         e.preventDefault();\r\n         \r\n-        if (!analysisData || !analysisData.isCompatible) {\r\n-            alert('Önce dosya analizi yapın ve uyumluluğu kontrol edin');\r\n+        if (!analysisData) {\r\n+            alert('Önce dosya analizi yapın');\r\n             return;\r\n         }\r\n         \r\n         const truncate = $('#truncateTable').is(':checked');\r\n@@ -947,40 +947,41 @@\n             </div>\r\n             <hr>\r\n         `;\r\n         \r\n-        if (data.isCompatible) {\r\n+        if (data.isCompatible || data.missingColumns.length === 0) {\r\n             html += `\r\n                 <div class=\"alert alert-success\">\r\n                     <i class=\"fas fa-check-circle me-2\"></i>\r\n-                    <strong>Uyumlu!</strong> Excel dosyası veritabanı yapısıyla uyumlu. Yükleme işlemi başlatılabilir.\r\n+                    <strong>Tam Uyumlu!</strong> Excel dosyası veritabanı yapısıyla tam uyumlu. Yükleme işlemi başlatılabilir.\r\n                 </div>\r\n             `;\r\n-            \r\n-            // Büyük dosya uyarısı\r\n-            if (data.totalRows > 5000) {\r\n-                html += `\r\n-                    <div class=\"alert alert-info\">\r\n-                        <i class=\"fas fa-info-circle me-2\"></i>\r\n-                        <strong>Büyük Dosya:</strong> ${data.totalRows.toLocaleString()} kayıt tespit edildi. \r\n-                        Yükleme işlemi birkaç dakika sürebilir. Lütfen sayfayı kapatmayın.\r\n-                    </div>\r\n-                `;\r\n-            }\r\n         } else {\r\n             html += `\r\n-                <div class=\"alert alert-danger\">\r\n-                    <i class=\"fas fa-times-circle me-2\"></i>\r\n-                    <strong>Uyumsuz!</strong> Excel dosyasında bazı zorunlu sütunlar eksik.\r\n+                <div class=\"alert alert-warning\">\r\n+                    <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n+                    <strong>Kısmi Uyumlu!</strong> Bazı sütunlar eksik ama yükleme yapılabilir. \r\n+                    Sadece eşleşen sütunlar yüklenecek.\r\n                 </div>\r\n             `;\r\n         }\r\n         \r\n+        // Büyük dosya uyarısı\r\n+        if (data.totalRows > 5000) {\r\n+            html += `\r\n+                <div class=\"alert alert-info\">\r\n+                    <i class=\"fas fa-info-circle me-2\"></i>\r\n+                    <strong>Büyük Dosya:</strong> ${data.totalRows.toLocaleString()} kayıt tespit edildi. \r\n+                    Yükleme işlemi birkaç dakika sürebilir. Lütfen sayfayı kapatmayın.\r\n+                </div>\r\n+            `;\r\n+        }\r\n+        \r\n         if (data.missingColumns.length > 0) {\r\n             html += `\r\n-                <div class=\"alert alert-warning\">\r\n-                    <strong>Eksik Sütunlar:</strong><br>\r\n-                    ${data.missingColumns.map(col => `<span class=\"badge bg-warning text-dark me-1\">${col}</span>`).join('')}\r\n+                <div class=\"alert alert-info\">\r\n+                    <strong>Eksik Sütunlar (boş olarak kaydedilecek):</strong><br>\r\n+                    ${data.missingColumns.map(col => `<span class=\"badge bg-secondary me-1\">${col}</span>`).join('')}\r\n                 </div>\r\n             `;\r\n         }\r\n         \r\n"
                },
                {
                    "date": 1759307125734,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -794,50 +794,8 @@\n                                 </div>\r\n                             </div>\r\n                         </div>\r\n                     </div>\r\n-                    \r\n-                    <!-- Kullanım Rehberi -->\r\n-                    <div class=\"mt-4\">\r\n-                        <div class=\"card\">\r\n-                            <div class=\"card-header bg-light\">\r\n-                                <h6 class=\"mb-0\">\r\n-                                    <i class=\"fas fa-info-circle me-2\"></i>\r\n-                                    Kullanım Rehberi\r\n-                                </h6>\r\n-                            </div>\r\n-                            <div class=\"card-body\">\r\n-                                <div class=\"row\">\r\n-                                    <div class=\"col-md-6\">\r\n-                                        <h6>Dosya Gereksinimleri:</h6>\r\n-                                        <ul class=\"small\">\r\n-                                            <li>Desteklenen formatlar: .xlsx, .csv</li>\r\n-                                            <li>İlk satır sütun başlıkları olmalı</li>\r\n-                                            <li>Zorunlu sütunlar: PRİM DETAY, PRİM DÖNEM, BÖLGE, BAYİ ADI vb.</li>\r\n-                                            <li>Tarih formatı: GG.AA.YYYY veya GG/AA/YYYY</li>\r\n-                                            <li>Sayısal değerler virgül veya nokta ile olabilir</li>\r\n-                                            <li>CSV dosyaları noktalı virgül (;) ile ayrılmalı</li>\r\n-                                        </ul>\r\n-                                    </div>\r\n-                                    <div class=\"col-md-6\">\r\n-                                        <h6>Yükleme Adımları:</h6>\r\n-                                        <ol class=\"small\">\r\n-                                            <li>Excel (.xlsx) veya CSV dosyasını uploads/primebaz klasörüne yükleyin</li>\r\n-                                            <li>Dosyayı seçin ve \"Dosyayı Analiz Et\" tıklayın</li>\r\n-                                            <li>Sütun uyumluluğunu kontrol edin</li>\r\n-                                            <li>\"Yüklemeyi Başlat\" ile işlemi tamamlayın</li>\r\n-                                        </ol>\r\n-                                        \r\n-                                        <div class=\"alert alert-warning small mt-3\">\r\n-                                            <strong>Önemli:</strong> .xls dosyaları desteklenmez. Excel'de dosyayı \r\n-                                            \"Farklı Kaydet > Excel Çalışma Kitabı (.xlsx)\" veya \"CSV (Noktalı virgülle ayrılmış)\" \r\n-                                            formatında kaydedin.\r\n-                                        </div>\r\n-                                    </div>\r\n-                                </div>\r\n-                            </div>\r\n-                        </div>\r\n-                    </div>\r\n                 <?php endif; ?>\r\n             </div>\r\n         </div>\r\n     </div>\r\n"
                },
                {
                    "date": 1759315823376,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -27,21 +27,64 @@\n         $this->connect();\r\n     }\r\n     \r\n     private function connect() {\r\n-        try {\r\n-            $dsn = \"sqlsrv:Server={$this->config['host']};Database={$this->config['database']};TrustServerCertificate=yes\";\r\n-            \r\n-            $this->connection = new PDO($dsn, $this->config['username'], $this->config['password'], [\r\n-                PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n-                PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n-                PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n-                PDO::ATTR_EMULATE_PREPARES => false\r\n-            ]);\r\n-            \r\n-        } catch (PDOException $e) {\r\n-            throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n+        // Farklı bağlantı string'lerini ve authentication yöntemlerini dene\r\n+        $connectionAttempts = [\r\n+            // Windows Authentication denemesi\r\n+            [\r\n+                'dsn' => \"sqlsrv:Server=localhost\\\\SQLEXPRESS;Database={$this->config['database']};TrustServerCertificate=yes\",\r\n+                'username' => null,\r\n+                'password' => null\r\n+            ],\r\n+            // SQL Server Authentication denemesi\r\n+            [\r\n+                'dsn' => \"sqlsrv:Server={$this->config['host']};Database={$this->config['database']};TrustServerCertificate=yes\",\r\n+                'username' => $this->config['username'],\r\n+                'password' => $this->config['password']\r\n+            ],\r\n+            // Alternatif Windows Authentication\r\n+            [\r\n+                'dsn' => \"sqlsrv:Server=(local)\\\\SQLEXPRESS;Database={$this->config['database']};TrustServerCertificate=yes\",\r\n+                'username' => null,\r\n+                'password' => null\r\n+            ],\r\n+            // Alternatif SQL Server Authentication\r\n+            [\r\n+                'dsn' => \"sqlsrv:Server=.\\\\SQLEXPRESS;Database={$this->config['database']};TrustServerCertificate=yes\",\r\n+                'username' => $this->config['username'],\r\n+                'password' => $this->config['password']\r\n+            ]\r\n+        ];\r\n+        \r\n+        $lastError = '';\r\n+        \r\n+        foreach ($connectionAttempts as $attempt) {\r\n+            try {\r\n+                $this->connection = new PDO(\r\n+                    $attempt['dsn'], \r\n+                    $attempt['username'], \r\n+                    $attempt['password'], \r\n+                    [\r\n+                        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n+                        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n+                        PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n+                        PDO::ATTR_EMULATE_PREPARES => false\r\n+                    ]\r\n+                );\r\n+                \r\n+                // Bağlantı başarılı, test sorgusu çalıştır\r\n+                $this->connection->query(\"SELECT 1\");\r\n+                return; // Başarılı, döngüden çık\r\n+                \r\n+            } catch (PDOException $e) {\r\n+                $lastError = $e->getMessage();\r\n+                continue; // Sonraki bağlantı yöntemini dene\r\n+            }\r\n         }\r\n+        \r\n+        // Tüm denemeler başarısız\r\n+        throw new Exception('Veritabanı bağlantı hatası - Tüm denemeler başarısız. Son hata: ' . $lastError);\r\n     }\r\n     \r\n     public function getConnection() {\r\n         return $this->connection;\r\n@@ -158,52 +201,117 @@\n         if (pathinfo($excelFilePath, PATHINFO_EXTENSION) !== 'xlsx') {\r\n             throw new Exception('Sadece .xlsx formatı destekleniyor. Lütfen dosyayı .xlsx formatında kaydedin.');\r\n         }\r\n         \r\n+        if (!file_exists($excelFilePath)) {\r\n+            throw new Exception('Excel dosyası bulunamadı: ' . $excelFilePath);\r\n+        }\r\n+        \r\n+        if (!is_readable($excelFilePath)) {\r\n+            throw new Exception('Excel dosyası okunamıyor: ' . $excelFilePath);\r\n+        }\r\n+        \r\n         $zip = new ZipArchive();\r\n-        if ($zip->open($excelFilePath) !== TRUE) {\r\n-            throw new Exception('Excel dosyası açılamadı');\r\n+        $result = $zip->open($excelFilePath);\r\n+        if ($result !== TRUE) {\r\n+            $errorMessages = [\r\n+                ZipArchive::ER_OK => 'No error',\r\n+                ZipArchive::ER_MULTIDISK => 'Multi-disk zip archives not supported',\r\n+                ZipArchive::ER_RENAME => 'Renaming temporary file failed',\r\n+                ZipArchive::ER_CLOSE => 'Closing zip archive failed',\r\n+                ZipArchive::ER_SEEK => 'Seek error',\r\n+                ZipArchive::ER_READ => 'Read error',\r\n+                ZipArchive::ER_WRITE => 'Write error',\r\n+                ZipArchive::ER_CRC => 'CRC error',\r\n+                ZipArchive::ER_ZIPCLOSED => 'Containing zip archive was closed',\r\n+                ZipArchive::ER_NOENT => 'No such file',\r\n+                ZipArchive::ER_EXISTS => 'File already exists',\r\n+                ZipArchive::ER_OPEN => 'Can not open file',\r\n+                ZipArchive::ER_TMPOPEN => 'Failure to create temporary file',\r\n+                ZipArchive::ER_ZLIB => 'Zlib error',\r\n+                ZipArchive::ER_MEMORY => 'Memory allocation failure',\r\n+                ZipArchive::ER_CHANGED => 'Entry has been changed',\r\n+                ZipArchive::ER_COMPNOTSUPP => 'Compression method not supported',\r\n+                ZipArchive::ER_EOF => 'Premature EOF',\r\n+                ZipArchive::ER_INVAL => 'Invalid argument',\r\n+                ZipArchive::ER_NOZIP => 'Not a zip archive',\r\n+                ZipArchive::ER_INTERNAL => 'Internal error',\r\n+                ZipArchive::ER_INCONS => 'Zip archive inconsistent',\r\n+                ZipArchive::ER_REMOVE => 'Can not remove file',\r\n+                ZipArchive::ER_DELETED => 'Entry has been deleted'\r\n+            ];\r\n+            \r\n+            $errorMsg = isset($errorMessages[$result]) ? $errorMessages[$result] : 'Unknown error';\r\n+            throw new Exception('Excel dosyası açılamadı. Hata kodu: ' . $result . ' (' . $errorMsg . '). Dosya bozuk olabilir.');\r\n         }\r\n         \r\n         // Shared strings oku\r\n         $sharedStrings = [];\r\n         $sharedStringsXML = $zip->getFromName('xl/sharedStrings.xml');\r\n         if ($sharedStringsXML) {\r\n-            $xml = simplexml_load_string($sharedStringsXML);\r\n-            foreach ($xml->si as $si) {\r\n-                $sharedStrings[] = (string)$si->t;\r\n+            $xml = @simplexml_load_string($sharedStringsXML);\r\n+            if ($xml === false) {\r\n+                error_log('PRIMEBAZ: SharedStrings XML parse hatası');\r\n+            } else {\r\n+                foreach ($xml->si as $si) {\r\n+                    $sharedStrings[] = (string)$si->t;\r\n+                }\r\n             }\r\n         }\r\n         \r\n         // İlk worksheet'i oku\r\n         $worksheetXML = $zip->getFromName('xl/worksheets/sheet1.xml');\r\n         if (!$worksheetXML) {\r\n-            throw new Exception('Worksheet bulunamadı');\r\n+            // Alternatif worksheet isimlerini dene\r\n+            $worksheetXML = $zip->getFromName('xl/worksheets/sheet.xml');\r\n+            if (!$worksheetXML) {\r\n+                throw new Exception('Worksheet bulunamadı. Dosyada geçerli bir çalışma sayfası yok.');\r\n+            }\r\n         }\r\n         \r\n-        $xml = simplexml_load_string($worksheetXML);\r\n+        $xml = @simplexml_load_string($worksheetXML);\r\n+        if ($xml === false) {\r\n+            throw new Exception('Worksheet XML parse edilemedi. Dosya bozuk olabilir.');\r\n+        }\r\n+        \r\n+        if (!isset($xml->sheetData)) {\r\n+            throw new Exception('Worksheet\\'te veri bulunamadı.');\r\n+        }\r\n         $rows = [];\r\n+        $rowIndex = 0;\r\n         \r\n         foreach ($xml->sheetData->row as $row) {\r\n             $rowData = [];\r\n             $cellIndex = 0;\r\n+            $rowIndex++;\r\n             \r\n-            foreach ($row->c as $cell) {\r\n-                $cellValue = '';\r\n-                \r\n-                // Cell type kontrolü\r\n-                $cellType = (string)$cell['t'];\r\n-                if ($cellType === 's') {\r\n-                    // Shared string\r\n-                    $stringIndex = (int)$cell->v;\r\n-                    $cellValue = isset($sharedStrings[$stringIndex]) ? $sharedStrings[$stringIndex] : '';\r\n-                } else {\r\n-                    // Normal değer\r\n-                    $cellValue = (string)$cell->v;\r\n+            try {\r\n+                foreach ($row->c as $cell) {\r\n+                    $cellValue = '';\r\n+                    \r\n+                    try {\r\n+                        // Cell type kontrolü\r\n+                        $cellType = (string)$cell['t'];\r\n+                        if ($cellType === 's') {\r\n+                            // Shared string\r\n+                            $stringIndex = (int)$cell->v;\r\n+                            $cellValue = isset($sharedStrings[$stringIndex]) ? $sharedStrings[$stringIndex] : '';\r\n+                        } else {\r\n+                            // Normal değer\r\n+                            $cellValue = (string)$cell->v;\r\n+                        }\r\n+                    } catch (Exception $e) {\r\n+                        error_log(\"PRIMEBAZ: Cell okuma hatası - Row $rowIndex, Cell $cellIndex: \" . $e->getMessage());\r\n+                        $cellValue = ''; // Hatalı cell'i boş bırak\r\n+                    }\r\n+                    \r\n+                    $rowData[] = $cellValue;\r\n+                    $cellIndex++;\r\n                 }\r\n-                \r\n-                $rowData[] = $cellValue;\r\n-                $cellIndex++;\r\n+            } catch (Exception $e) {\r\n+                error_log(\"PRIMEBAZ: Row okuma hatası - Row $rowIndex: \" . $e->getMessage());\r\n+                // Hatalı satırı atla\r\n+                continue;\r\n             }\r\n             \r\n             $rows[] = $rowData;\r\n         }\r\n@@ -411,13 +519,28 @@\n                     $insertStmt->execute($processedRow);\r\n                     $successCount++;\r\n                 } catch (PDOException $e) {\r\n                     $errorCount++;\r\n+                    $errorDetails = [\r\n+                        'row' => $rowCount + 1,\r\n+                        'data' => $processedRow,\r\n+                        'error' => $e->getMessage(),\r\n+                        'code' => $e->getCode()\r\n+                    ];\r\n                     $errors[] = \"Satır \" . ($rowCount + 1) . \": \" . $e->getMessage();\r\n                     \r\n+                    // Detaylı hata loglama\r\n+                    error_log(\"PRIMEBAZ UPLOAD ERROR - Row \" . ($rowCount + 1) . \": \" . $e->getMessage());\r\n+                    error_log(\"PRIMEBAZ UPLOAD ERROR - Data: \" . json_encode($processedRow));\r\n+                    \r\n                     if ($errorCount <= 5) {\r\n                         error_log(\"Error on row \" . ($rowCount + 1) . \": \" . $e->getMessage());\r\n                     }\r\n+                    \r\n+                    // İlk 10 hatada işlemi durdur\r\n+                    if ($errorCount >= 10) {\r\n+                        throw new Exception(\"Fazla hata oluştu. İşlem durduruldu. Son hata: \" . $e->getMessage());\r\n+                    }\r\n                 }\r\n                 \r\n                 $batchCount++;\r\n                 \r\n@@ -671,11 +794,18 @@\n                 $errorDetails = [\r\n                     'success' => false,\r\n                     'error' => $e->getMessage(),\r\n                     'file' => $e->getFile(),\r\n-                    'line' => $e->getLine()\r\n+                    'line' => $e->getLine(),\r\n+                    'selectedFile' => $selectedFile,\r\n+                    'truncate' => $truncate,\r\n+                    'timestamp' => date('Y-m-d H:i:s')\r\n                 ];\r\n+                \r\n+                // Detaylı hata loglama\r\n+                error_log(\"PRIMEBAZ UPLOAD FAILED: \" . json_encode($errorDetails));\r\n                 error_log(\"Upload hatası: \" . json_encode($errorDetails));\r\n+                \r\n                 echo json_encode($errorDetails);\r\n             }\r\n             exit;\r\n         }\r\n@@ -802,8 +932,11 @@\n </div>\r\n \r\n <script>\r\n $(document).ready(function() {\r\n+    console.log('=== Primebaz Upload System Initialized ===');\r\n+    console.log('Page loaded successfully, event handlers being attached...');\r\n+    \r\n     let analysisData = null;\r\n     \r\n     // Dosya seçimi değiştiğinde\r\n     $('#excelFile').change(function() {\r\n@@ -822,27 +955,38 @@\n     \r\n     // Analiz butonu\r\n     $('#analyzeBtn').click(function() {\r\n         const selectedFile = $('#excelFile').val();\r\n-        if (!selectedFile) return;\r\n+        console.log('=== File Analysis Started ===');\r\n+        console.log('Selected file:', selectedFile);\r\n         \r\n+        if (!selectedFile) {\r\n+            console.warn('No file selected for analysis');\r\n+            return;\r\n+        }\r\n+        \r\n         $(this).prop('disabled', true).html('<i class=\"fas fa-spinner fa-spin me-2\"></i>Analiz Ediliyor...');\r\n         \r\n+        console.log('Sending analysis request...');\r\n         $.post('', {\r\n             action: 'get_file_info',\r\n             file: selectedFile\r\n         })\r\n         .done(function(response) {\r\n+            console.log('Analysis response received:', response);\r\n             if (response.success) {\r\n+                console.log('Analysis successful - Rows:', response.total_rows, 'Columns:', response.column_count);\r\n                 analysisData = response;\r\n                 displayAnalysis(response);\r\n                 $('#fileAnalysis').show();\r\n                 $('#uploadBtn').prop('disabled', false); // Her zaman aktif et\r\n             } else {\r\n+                console.error('Analysis failed:', response.error);\r\n                 alert('Hata: ' + response.error);\r\n             }\r\n         })\r\n-        .fail(function() {\r\n+        .fail(function(xhr, status, error) {\r\n+            console.error('Analysis request failed:', {xhr, status, error});\r\n             alert('Sunucu hatası oluştu');\r\n         })\r\n         .always(function() {\r\n             $('#analyzeBtn').prop('disabled', false).html('<i class=\"fas fa-search me-2\"></i>Dosyayı Analiz Et');\r\n@@ -852,18 +996,27 @@\n     // Upload form\r\n     $('#uploadForm').submit(function(e) {\r\n         e.preventDefault();\r\n         \r\n+        console.log('=== Upload Process Started ===');\r\n+        console.log('Analysis data:', analysisData);\r\n+        \r\n         if (!analysisData) {\r\n+            console.warn('No analysis data available');\r\n             alert('Önce dosya analizi yapın');\r\n             return;\r\n         }\r\n         \r\n         const truncate = $('#truncateTable').is(':checked');\r\n+        console.log('Truncate table option:', truncate);\r\n+        \r\n         if (truncate) {\r\n+            console.log('Requesting confirmation for table truncation...');\r\n             if (!confirm('UYARI: Bu işlem mevcut tüm Primebaz rapor verilerini silecektir. Devam etmek istediğinizden emin misiniz?')) {\r\n+                console.log('User cancelled truncation');\r\n                 return;\r\n             }\r\n+            console.log('User confirmed truncation');\r\n         }\r\n         \r\n         // Büyük dosya için ek uyarı\r\n         if (analysisData.totalRows > 10000) {\r\n@@ -955,17 +1108,24 @@\n         $('#analysisContent').html(html);\r\n     }\r\n     \r\n     function startUpload() {\r\n+        console.log('=== Starting Upload Function ===');\r\n+        const selectedFile = $('#excelFile').val();\r\n+        const truncate = $('#truncateTable').is(':checked') ? '1' : '0';\r\n+        \r\n+        console.log('Upload parameters:', {\r\n+            file: selectedFile,\r\n+            truncate: truncate,\r\n+            totalRows: analysisData?.totalRows || 'unknown'\r\n+        });\r\n+        \r\n         $('#uploadBtn').prop('disabled', true);\r\n         $('#progressContainer').show();\r\n         $('#resultContainer').hide();\r\n         \r\n         updateProgress(0, 'Yükleme başlatılıyor...');\r\n         \r\n-        const selectedFile = $('#excelFile').val();\r\n-        const truncate = $('#truncateTable').is(':checked') ? '1' : '0';\r\n-        \r\n         // Büyük dosyalar için progress simulation\r\n         let progressInterval;\r\n         let currentProgress = 0;\r\n         \r\n@@ -977,14 +1137,16 @@\n                 }\r\n             }, 1500);\r\n         }\r\n         \r\n+        console.log('Sending upload request...');\r\n         $.post('', {\r\n             action: 'upload',\r\n             file: selectedFile,\r\n             truncate: truncate\r\n         })\r\n         .done(function(response) {\r\n+            console.log('Upload completed successfully:', response);\r\n             if (progressInterval) {\r\n                 clearInterval(progressInterval);\r\n             }\r\n             updateProgress(100, 'Tamamlandı!');\r\n@@ -999,15 +1161,28 @@\n                 clearInterval(progressInterval);\r\n             }\r\n             \r\n             let errorMessage = 'Hata oluştu!';\r\n+            console.error('Upload Failed - Full Error Details:', {\r\n+                status: status,\r\n+                error: error,\r\n+                responseText: xhr.responseText,\r\n+                statusCode: xhr.status\r\n+            });\r\n+            \r\n             try {\r\n                 if (xhr.responseText) {\r\n                     const response = JSON.parse(xhr.responseText);\r\n                     errorMessage = response.error || errorMessage;\r\n-                    console.error('Upload Error Details:', response);\r\n+                    console.error('Parsed Error Response:', response);\r\n+                    \r\n+                    // Display detailed error if available\r\n+                    if (response.detailed_error) {\r\n+                        errorMessage += '\\n\\nDetay: ' + response.detailed_error;\r\n+                    }\r\n                 }\r\n             } catch (e) {\r\n+                console.error('Failed to parse error response:', e);\r\n                 errorMessage = xhr.responseText || error || 'Bilinmeyen hata';\r\n             }\r\n             \r\n             updateProgress(100, errorMessage);\r\n@@ -1019,10 +1194,19 @@\n     }\r\n     \r\n     function updateProgress(percent, text) {\r\n         $('#progressBar').css('width', percent + '%');\r\n-        $('#progressText').text(text);\r\n         \r\n+        // Handle multi-line error messages\r\n+        if (text.includes('\\n')) {\r\n+            const lines = text.split('\\n');\r\n+            $('#progressText').html(lines.map(line => \r\n+                line.trim() ? '<div>' + $('<div>').text(line.trim()).html() + '</div>' : ''\r\n+            ).join(''));\r\n+        } else {\r\n+            $('#progressText').text(text);\r\n+        }\r\n+        \r\n         if (percent === 100) {\r\n             $('#progressBar').removeClass('progress-bar-animated');\r\n         }\r\n     }\r\n"
                },
                {
                    "date": 1759320149547,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -482,13 +482,10 @@\n                     $skippedRows++;\r\n                     continue;\r\n                 }\r\n                 \r\n-                // Sütun sayısı kontrolü\r\n-                if (count($row) < count($expectedColumns)) {\r\n-                    $skippedRows++;\r\n-                    continue;\r\n-                }\r\n+                // Sütun sayısı kontrolü - Eksik sütunlar olsa bile işleme devam et\r\n+                // Sadece fazla sütunları kırp\r\n                 if (count($row) > count($expectedColumns)) {\r\n                     $row = array_slice($row, 0, count($expectedColumns));\r\n                 }\r\n                 \r\n@@ -1067,12 +1064,12 @@\n                 </div>\r\n             `;\r\n         } else {\r\n             html += `\r\n-                <div class=\"alert alert-warning\">\r\n-                    <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n-                    <strong>Kısmi Uyumlu!</strong> Bazı sütunlar eksik ama yükleme yapılabilir. \r\n-                    Sadece eşleşen sütunlar yüklenecek.\r\n+                <div class=\"alert alert-info\">\r\n+                    <i class=\"fas fa-info-circle me-2\"></i>\r\n+                    <strong>Uyumlu - Eksik Sütunlar Var!</strong> Bazı sütunlar eksik ama yükleme yapılabilir. \r\n+                    Eksik sütunlar NULL olarak kaydedilecek, eşleşen sütunlar normal şekilde yüklenecektir.\r\n                 </div>\r\n             `;\r\n         }\r\n         \r\n@@ -1088,10 +1085,12 @@\n         }\r\n         \r\n         if (data.missingColumns.length > 0) {\r\n             html += `\r\n-                <div class=\"alert alert-info\">\r\n-                    <strong>Eksik Sütunlar (boş olarak kaydedilecek):</strong><br>\r\n+                <div class=\"alert alert-warning\">\r\n+                    <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n+                    <strong>Eksik Sütunlar (NULL olarak kaydedilecek):</strong><br>\r\n+                    Bu sütunlar veritabanında NULL değeri alacaktır.<br>\r\n                     ${data.missingColumns.map(col => `<span class=\"badge bg-secondary me-1\">${col}</span>`).join('')}\r\n                 </div>\r\n             `;\r\n         }\r\n"
                },
                {
                    "date": 1759320240603,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -126,9 +126,9 @@\n             mahsup_tutari_odeme_durumu DECIMAL(12,2) NULL,\r\n             yonlendirme NVARCHAR(300) NULL,\r\n             prim_durum_aciklama NVARCHAR(1000) NULL,\r\n             dosya_adi NVARCHAR(510) NULL,\r\n-            olusturma_tarihi DATETIME NOT NULL DEFAULT GETDATE()\r\n+            yuklenme_tarihi DATETIME NOT NULL DEFAULT GETDATE()\r\n         );\r\n         \";\r\n         \r\n         try {\r\n"
                }
            ],
            "date": 1759242376083,
            "name": "Commit-0",
            "content": "<?php\r\nerror_reporting(E_ALL);\r\nini_set('display_errors', 1);\r\n\r\nsession_start();\r\n\r\n// Yetki kontrolü - GEÇİCİ OLARAK KAPALI\r\n/*\r\nif (!isset($_SESSION['user_id'])) {\r\n    header('Location: login.php');\r\n    exit;\r\n}\r\n*/\r\n\r\n// Excel okuma için COM nesnesi kullanacağız\r\n// require_once 'vendor/autoload.php'; // PhpSpreadsheet için\r\n// use PhpOffice\\PhpSpreadsheet\\IOFactory;\r\n\r\nclass PrimebazMSSQLConnection {\r\n    private $connection;\r\n    private $config;\r\n    \r\n    public function __construct() {\r\n        $configFile = __DIR__ . '/config/mssql.php';\r\n        \r\n        if (!file_exists($configFile)) {\r\n            throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n        }\r\n        \r\n        $this->config = include $configFile;\r\n        $this->connect();\r\n    }\r\n    \r\n    private function connect() {\r\n        try {\r\n            $dsn = \"sqlsrv:Server={$this->config['host']};Database={$this->config['database']};TrustServerCertificate=yes\";\r\n            \r\n            $this->connection = new PDO($dsn, $this->config['username'], $this->config['password'], [\r\n                PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n                PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n                PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n                PDO::ATTR_EMULATE_PREPARES => false\r\n            ]);\r\n            \r\n        } catch (PDOException $e) {\r\n            throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n        }\r\n    }\r\n    \r\n    public function getConnection() {\r\n        return $this->connection;\r\n    }\r\n    \r\n    public function createPrimebazTable() {\r\n        $sql = \"\r\n        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='primebaz_rapor' AND xtype='U')\r\n        CREATE TABLE primebaz_rapor (\r\n            id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n            bayi_kodu NVARCHAR(50),\r\n            bayi_adi NVARCHAR(200),\r\n            bolge NVARCHAR(100),\r\n            il NVARCHAR(50),\r\n            ilce NVARCHAR(100),\r\n            mahalle NVARCHAR(200),\r\n            alan_kodu NVARCHAR(50),\r\n            musteri_no NVARCHAR(50),\r\n            musteri_adi NVARCHAR(200),\r\n            musteri_soyadi NVARCHAR(200),\r\n            telefon NVARCHAR(20),\r\n            adres NVARCHAR(500),\r\n            urun_kodu NVARCHAR(50),\r\n            urun_adi NVARCHAR(200),\r\n            paket_kodu NVARCHAR(50),\r\n            paket_adi NVARCHAR(200),\r\n            baslangic_tarihi DATETIME2,\r\n            bitis_tarihi DATETIME2,\r\n            islem_tarihi DATETIME2,\r\n            islem_tipi NVARCHAR(50),\r\n            tutar DECIMAL(10,2),\r\n            komisyon_orani DECIMAL(5,2),\r\n            komisyon_tutari DECIMAL(10,2),\r\n            kdv_orani DECIMAL(5,2),\r\n            kdv_tutari DECIMAL(10,2),\r\n            toplam_tutar DECIMAL(10,2),\r\n            odeme_tarihi DATETIME2,\r\n            odeme_durumu NVARCHAR(50),\r\n            aciklama NVARCHAR(500),\r\n            ay INT,\r\n            yil INT,\r\n            donem NVARCHAR(20),\r\n            eklenme_tarihi DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n            guncellenme_tarihi DATETIME2,\r\n            dosya_adi NVARCHAR(255)\r\n        );\r\n        \r\n        -- İndeksler\r\n        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_bayi_kodu')\r\n        BEGIN\r\n            CREATE INDEX IX_primebaz_rapor_bayi_kodu ON primebaz_rapor (bayi_kodu)\r\n        END\r\n        \r\n        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_musteri_no')\r\n        BEGIN\r\n            CREATE INDEX IX_primebaz_rapor_musteri_no ON primebaz_rapor (musteri_no)\r\n        END\r\n        \r\n        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_donem')\r\n        BEGIN\r\n            CREATE INDEX IX_primebaz_rapor_donem ON primebaz_rapor (yil, ay, donem)\r\n        END\r\n        \r\n        IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('primebaz_rapor') AND name = 'IX_primebaz_rapor_tarih')\r\n        BEGIN\r\n            CREATE INDEX IX_primebaz_rapor_tarih ON primebaz_rapor (islem_tarihi)\r\n        END\r\n        \";\r\n        \r\n        try {\r\n            $this->connection->exec($sql);\r\n        } catch (PDOException $e) {\r\n            throw new Exception('Tablo oluşturma hatası: ' . $e->getMessage());\r\n        }\r\n    }\r\n    \r\n    public function truncateTable() {\r\n        $sql = \"TRUNCATE TABLE primebaz_rapor\";\r\n        $this->connection->exec($sql);\r\n    }\r\n    \r\n    public function convertDateFormat($dateString) {\r\n        if (empty($dateString)) {\r\n            return null;\r\n        }\r\n        \r\n        // Excel tarih seri numarası ise\r\n        if (is_numeric($dateString)) {\r\n            try {\r\n                $baseDate = new DateTime('1900-01-01');\r\n                $days = intval($dateString) - 2; // Excel leap year bug adjustment\r\n                $baseDate->add(new DateInterval('P' . $days . 'D'));\r\n                return $baseDate->format('Y-m-d H:i:s');\r\n            } catch (Exception $e) {\r\n                // Fallback to text parsing\r\n            }\r\n        }\r\n        \r\n        $formats = [\r\n            'd.m.Y H:i:s',\r\n            'd.m.Y H:i',\r\n            'd.m.Y',\r\n            'd/m/Y H:i:s',\r\n            'd/m/Y H:i',\r\n            'd/m/Y',\r\n            'Y-m-d H:i:s',\r\n            'Y-m-d H:i',\r\n            'Y-m-d',\r\n            'm/d/Y H:i:s',\r\n            'm/d/Y H:i',\r\n            'm/d/Y'\r\n        ];\r\n        \r\n        foreach ($formats as $format) {\r\n            $date = DateTime::createFromFormat($format, $dateString);\r\n            if ($date !== false) {\r\n                return $date->format('Y-m-d H:i:s');\r\n            }\r\n        }\r\n        \r\n        return null;\r\n    }\r\n    \r\n    public function parsePeriodFromFilename($filename) {\r\n        // Dosya adından ay ve yıl bilgisini çıkar\r\n        $aylar = [\r\n            'OCAK' => 1, 'ŞUBAT' => 2, 'MART' => 3, 'NİSAN' => 4,\r\n            'MAYIS' => 5, 'HAZİRAN' => 6, 'TEMMUZ' => 7, 'AĞUSTOS' => 8,\r\n            'EYLUL' => 9, 'EKİM' => 10, 'KASIM' => 11, 'ARALIK' => 12\r\n        ];\r\n        \r\n        $filename = strtoupper(str_replace('.xlsx', '', $filename));\r\n        \r\n        foreach ($aylar as $ay => $ayNo) {\r\n            if (strpos($filename, $ay) !== false) {\r\n                // Yıl bilgisini çıkar\r\n                if (preg_match(\"/'(\\d{2})/\", $filename, $matches)) {\r\n                    $yil = 2000 + intval($matches[1]);\r\n                    return [\r\n                        'ay' => $ayNo,\r\n                        'yil' => $yil,\r\n                        'donem' => $ay . ' ' . $yil\r\n                    ];\r\n                }\r\n            }\r\n        }\r\n        \r\n        return [\r\n            'ay' => null,\r\n            'yil' => null,\r\n            'donem' => pathinfo($filename, PATHINFO_FILENAME)\r\n        ];\r\n    }\r\n    \r\n    public function insertBatchFromExcel($filePath, $fileName, $batchSize = 1000) {\r\n        ini_set('memory_limit', '1024M');\r\n        set_time_limit(3600);\r\n        \r\n        try {\r\n            // COM nesnesi ile Excel dosyasını oku\r\n            if (class_exists('COM')) {\r\n                return $this->insertBatchFromExcelCOM($filePath, $fileName, $batchSize);\r\n            } else {\r\n                throw new Exception('COM desteği yok. Excel dosyalarını okumak için COM desteği gereklidir.');\r\n            }\r\n            \r\n        } catch (Exception $e) {\r\n            throw new Exception('Excel okuma hatası: ' . $e->getMessage());\r\n        }\r\n    }\r\n    \r\n    private function insertBatchFromExcelCOM($filePath, $fileName, $batchSize = 1000) {\r\n        try {\r\n            $excel = new COM(\"Excel.Application\");\r\n            $excel->Visible = false;\r\n            $excel->DisplayAlerts = false;\r\n            \r\n            $workbook = $excel->Workbooks->Open($filePath);\r\n            $worksheet = $workbook->Worksheets(1);\r\n            $usedRange = $worksheet->UsedRange;\r\n            \r\n            $highestRow = $usedRange->Rows->Count;\r\n            $highestColumn = $usedRange->Columns->Count;\r\n            \r\n            // Dosya adından dönem bilgisini çıkar\r\n            $periodInfo = $this->parsePeriodFromFilename($fileName);\r\n            \r\n            // İlk satırı başlık olarak oku\r\n            $headers = [];\r\n            for ($col = 1; $col <= $highestColumn; $col++) {\r\n                $headers[] = trim($worksheet->Cells(1, $col)->Text);\r\n            }\r\n            \r\n            $this->connection->beginTransaction();\r\n            \r\n            // Prepared statement - sütun sayısını dinamik olarak ayarla\r\n            $placeholders = str_repeat('?,', 32) . '?'; // 33 parametre\r\n            $insertSql = \"INSERT INTO primebaz_rapor (\r\n                bayi_kodu, bayi_adi, bolge, il, ilce, mahalle, alan_kodu,\r\n                musteri_no, musteri_adi, musteri_soyadi, telefon, adres,\r\n                urun_kodu, urun_adi, paket_kodu, paket_adi,\r\n                baslangic_tarihi, bitis_tarihi, islem_tarihi, islem_tipi,\r\n                tutar, komisyon_orani, komisyon_tutari, kdv_orani, kdv_tutari, toplam_tutar,\r\n                odeme_tarihi, odeme_durumu, aciklama,\r\n                ay, yil, donem, dosya_adi\r\n            ) VALUES ($placeholders)\";\r\n            \r\n            $insertStmt = $this->connection->prepare($insertSql);\r\n            \r\n            $successCount = 0;\r\n            $errorCount = 0;\r\n            $errors = [];\r\n            $batchCount = 0;\r\n            \r\n            // Veri satırlarını işle (başlık satırını atla)\r\n            for ($row = 2; $row <= $highestRow; $row++) {\r\n                try {\r\n                    $rowData = [];\r\n                    for ($col = 1; $col <= min($highestColumn, 30); $col++) { // Max 30 sütun oku\r\n                        $rowData[] = $worksheet->Cells($row, $col)->Text;\r\n                    }\r\n                    \r\n                    // Boş satırları atla\r\n                    $hasData = false;\r\n                    foreach ($rowData as $cell) {\r\n                        if (!empty(trim($cell))) {\r\n                            $hasData = true;\r\n                            break;\r\n                        }\r\n                    }\r\n                    if (!$hasData) continue;\r\n                    \r\n                    // Veriyi hazırla - Excel yapısına göre ayarlanmalı\r\n                    $processedRow = [];\r\n                    \r\n                    // Sabit 29 alan + 4 sistem alanı = 33 toplam\r\n                    for ($i = 0; $i < 29; $i++) {\r\n                        if ($i >= 16 && $i <= 18) {\r\n                            // Tarih alanları (16,17,18)\r\n                            $processedRow[] = $this->convertDateFormat($this->getValueFromArray($rowData, $i));\r\n                        } elseif ($i >= 20 && $i <= 25) {\r\n                            // Sayısal alanlar (20-25)\r\n                            $processedRow[] = $this->getNumericValueFromArray($rowData, $i);\r\n                        } elseif ($i == 26) {\r\n                            // Ödeme tarihi\r\n                            $processedRow[] = $this->convertDateFormat($this->getValueFromArray($rowData, $i));\r\n                        } else {\r\n                            // Text alanlar\r\n                            $processedRow[] = $this->getValueFromArray($rowData, $i);\r\n                        }\r\n                    }\r\n                    \r\n                    // Dönem bilgileri\r\n                    $processedRow[] = $periodInfo['ay'];\r\n                    $processedRow[] = $periodInfo['yil'];\r\n                    $processedRow[] = $periodInfo['donem'];\r\n                    $processedRow[] = $fileName;\r\n                    \r\n                    $insertStmt->execute($processedRow);\r\n                    $successCount++;\r\n                    \r\n                } catch (PDOException $e) {\r\n                    $errorCount++;\r\n                    $errors[] = \"Satır $row: \" . $e->getMessage();\r\n                    \r\n                    if ($errorCount <= 5) {\r\n                        error_log(\"Error on row $row: \" . $e->getMessage());\r\n                    }\r\n                }\r\n                \r\n                $batchCount++;\r\n                if ($batchCount >= $batchSize) {\r\n                    $this->connection->commit();\r\n                    $this->connection->beginTransaction();\r\n                    $batchCount = 0;\r\n                    error_log(\"Processed $successCount rows from $fileName\");\r\n                }\r\n            }\r\n            \r\n            $this->connection->commit();\r\n            \r\n            // Excel nesnelerini temizle\r\n            $workbook->Close();\r\n            $excel->Quit();\r\n            $excel = null;\r\n            \r\n            return [\r\n                'success' => true,\r\n                'successful' => $successCount,\r\n                'errors' => $errorCount,\r\n                'totalProcessed' => $successCount + $errorCount,\r\n                'error_details' => $errors,\r\n                'filename' => $fileName,\r\n                'period' => $periodInfo\r\n            ];\r\n            \r\n        } catch (Exception $e) {\r\n            $this->connection->rollback();\r\n            \r\n            // Excel nesnelerini temizle\r\n            if (isset($workbook)) $workbook->Close();\r\n            if (isset($excel)) {\r\n                $excel->Quit();\r\n                $excel = null;\r\n            }\r\n            \r\n            throw $e;\r\n        }\r\n    }\r\n    \r\n    private function getValue($rowData, $index) {\r\n        return isset($rowData[$index]) ? trim($rowData[$index]) : null;\r\n    }\r\n    \r\n    private function getValueFromArray($rowData, $index) {\r\n        return isset($rowData[$index]) ? trim($rowData[$index]) : null;\r\n    }\r\n    \r\n    private function getNumericValue($rowData, $index) {\r\n        $value = $this->getValue($rowData, $index);\r\n        if (empty($value)) return null;\r\n        \r\n        // Türkçe sayı formatını düzelt\r\n        $value = str_replace('.', '', $value); // Binlik ayırıcı\r\n        $value = str_replace(',', '.', $value); // Ondalık ayırıcı\r\n        \r\n        return is_numeric($value) ? floatval($value) : null;\r\n    }\r\n    \r\n    private function getNumericValueFromArray($rowData, $index) {\r\n        $value = $this->getValueFromArray($rowData, $index);\r\n        if (empty($value)) return null;\r\n        \r\n        // Türkçe sayı formatını düzelt\r\n        $value = str_replace('.', '', $value); // Binlik ayırıcı\r\n        $value = str_replace(',', '.', $value); // Ondalık ayırıcı\r\n        \r\n        return is_numeric($value) ? floatval($value) : null;\r\n    }\r\n}\r\n\r\n$pageTitle = 'Primebaz Rapor Yükleme';\r\n$breadcrumbs = [\r\n    ['title' => 'Primebaz Rapor Yükleme']\r\n];\r\n\r\n$message = '';\r\n$messageType = '';\r\n$excelFiles = [];\r\n$uploadResult = null;\r\n\r\n// Excel dosyalarını listele\r\n$uploadsDir = __DIR__ . '/uploads/primebaz';\r\nif (is_dir($uploadsDir)) {\r\n    $files = scandir($uploadsDir);\r\n    foreach ($files as $file) {\r\n        if (pathinfo($file, PATHINFO_EXTENSION) === 'xlsx') {\r\n            $excelFiles[] = $file;\r\n        }\r\n    }\r\n}\r\n\r\n// AJAX istekleri için\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    if (isset($_POST['action'])) {\r\n        header('Content-Type: application/json');\r\n        \r\n        if ($_POST['action'] === 'get_file_info') {\r\n            $selectedFile = $_POST['file'] ?? '';\r\n            if (empty($selectedFile) || !in_array($selectedFile, $excelFiles)) {\r\n                echo json_encode(['success' => false, 'error' => 'Geçersiz dosya seçimi']);\r\n                exit;\r\n            }\r\n            \r\n            $filePath = $uploadsDir . '/' . $selectedFile;\r\n            \r\n            try {\r\n                $db = new PrimebazMSSQLConnection();\r\n                $periodInfo = $db->parsePeriodFromFilename($selectedFile);\r\n                $fileSize = filesize($filePath);\r\n                \r\n                // COM nesnesi ile Excel dosyasını hızlıca oku\r\n                try {\r\n                    if (class_exists('COM')) {\r\n                        $excel = new COM(\"Excel.Application\");\r\n                        $excel->Visible = false;\r\n                        $excel->DisplayAlerts = false;\r\n                        \r\n                        $workbook = $excel->Workbooks->Open($filePath);\r\n                        $worksheet = $workbook->Worksheets(1);\r\n                        $usedRange = $worksheet->UsedRange;\r\n                        \r\n                        $highestRow = $usedRange->Rows->Count;\r\n                        $highestColumn = $usedRange->Columns->Count;\r\n                        \r\n                        // İlk satırı başlık olarak oku\r\n                        $headers = [];\r\n                        for ($col = 1; $col <= min($highestColumn, 20); $col++) { // Max 20 başlık oku\r\n                            $headers[] = trim($worksheet->Cells(1, $col)->Text);\r\n                        }\r\n                        \r\n                        $workbook->Close();\r\n                        $excel->Quit();\r\n                        $excel = null;\r\n                    } else {\r\n                        throw new Exception('COM desteği yok');\r\n                    }\r\n                    \r\n                } catch (Exception $e) {\r\n                    // COM hatası durumunda varsayılan değerler\r\n                    $highestRow = 1000; // Tahmini değer\r\n                    $highestColumn = 30;\r\n                    $headers = [\r\n                        'COM desteği bulunamadı',\r\n                        'Excel dosyası analiz edilemedi',\r\n                        'Yükleme işlemi deneyebilirsiniz'\r\n                    ];\r\n                }\r\n                \r\n                echo json_encode([\r\n                    'success' => true,\r\n                    'filename' => $selectedFile,\r\n                    'fileSize' => $fileSize,\r\n                    'totalRows' => $highestRow - 1, // Başlık satırını çıkar\r\n                    'totalColumns' => $highestColumn,\r\n                    'headers' => $headers,\r\n                    'period' => $periodInfo,\r\n                    'isCompatible' => true // Excel dosyası olduğu için uyumlu kabul et\r\n                ]);\r\n                \r\n            } catch (Exception $e) {\r\n                echo json_encode(['success' => false, 'error' => 'Dosya analiz hatası: ' . $e->getMessage()]);\r\n            }\r\n            exit;\r\n        }\r\n        \r\n        if ($_POST['action'] === 'upload') {\r\n            $selectedFile = $_POST['file'] ?? '';\r\n            $truncate = isset($_POST['truncate']) && $_POST['truncate'] === '1';\r\n            \r\n            if (empty($selectedFile) || !in_array($selectedFile, $excelFiles)) {\r\n                echo json_encode(['success' => false, 'error' => 'Geçersiz dosya seçimi']);\r\n                exit;\r\n            }\r\n            \r\n            try {\r\n                $db = new PrimebazMSSQLConnection();\r\n                $db->createPrimebazTable();\r\n                \r\n                if ($truncate) {\r\n                    $db->truncateTable();\r\n                }\r\n                \r\n                $result = $db->insertBatchFromExcel($uploadsDir . '/' . $selectedFile, $selectedFile);\r\n                echo json_encode($result);\r\n                \r\n            } catch (Exception $e) {\r\n                $errorDetails = [\r\n                    'success' => false,\r\n                    'error' => $e->getMessage(),\r\n                    'file' => $e->getFile(),\r\n                    'line' => $e->getLine()\r\n                ];\r\n                error_log(\"Upload hatası: \" . json_encode($errorDetails));\r\n                echo json_encode($errorDetails);\r\n            }\r\n            exit;\r\n        }\r\n    }\r\n}\r\n\r\ninclude 'includes/header.php';\r\n?>\r\n\r\n<div class=\"row\">\r\n    <div class=\"col-12\">\r\n        <div class=\"card\">\r\n            <div class=\"card-header bg-success text-white\">\r\n                <h4 class=\"card-title mb-0\">\r\n                    <i class=\"fas fa-file-excel me-2\"></i>\r\n                    Primebaz Rapor Yükleme\r\n                </h4>\r\n            </div>\r\n            <div class=\"card-body\">\r\n                <?php if (empty($excelFiles)): ?>\r\n                    <div class=\"alert alert-warning\">\r\n                        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                        Uploads/primebaz klasöründe Excel dosyası bulunamadı.\r\n                    </div>\r\n                <?php else: ?>\r\n                    <div class=\"alert alert-info\">\r\n                        <i class=\"fas fa-info-circle me-2\"></i>\r\n                        <strong>Bilgi:</strong> Bu sayfa Primebaz Excel dosyalarını veritabanına yüklemek için kullanılır. \r\n                        Excel dosyaları uploads/primebaz klasöründen otomatik olarak listelenir.\r\n                    </div>\r\n                    \r\n                    <form id=\"uploadForm\">\r\n                        <div class=\"row\">\r\n                            <div class=\"col-md-6\">\r\n                                <div class=\"mb-3\">\r\n                                    <label for=\"excelFile\" class=\"form-label\">Excel Dosyası Seçin</label>\r\n                                    <select class=\"form-select\" id=\"excelFile\" name=\"excelFile\" required>\r\n                                        <option value=\"\">-- Dosya Seçin --</option>\r\n                                        <?php foreach ($excelFiles as $file): ?>\r\n                                            <option value=\"<?php echo htmlspecialchars($file); ?>\"><?php echo htmlspecialchars($file); ?></option>\r\n                                        <?php endforeach; ?>\r\n                                    </select>\r\n                                </div>\r\n                            </div>\r\n                            <div class=\"col-md-6\">\r\n                                <div class=\"mb-3\">\r\n                                    <label class=\"form-label\">Yükleme Seçenekleri</label>\r\n                                    <div class=\"form-check\">\r\n                                        <input class=\"form-check-input\" type=\"checkbox\" id=\"truncateTable\" name=\"truncateTable\" value=\"1\">\r\n                                        <label class=\"form-check-label text-danger\" for=\"truncateTable\">\r\n                                            <i class=\"fas fa-exclamation-triangle me-1\"></i>\r\n                                            Mevcut verileri temizle (Dikkat: Tüm veriler silinir!)\r\n                                        </label>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        \r\n                        <div id=\"fileAnalysis\" class=\"mb-4\" style=\"display: none;\">\r\n                            <div class=\"card\">\r\n                                <div class=\"card-header bg-info text-white\">\r\n                                    <h6 class=\"mb-0\">\r\n                                        <i class=\"fas fa-analytics me-2\"></i>\r\n                                        Dosya Analizi\r\n                                    </h6>\r\n                                </div>\r\n                                <div class=\"card-body\">\r\n                                    <div id=\"analysisContent\">\r\n                                        <!-- Analysis content will be loaded here -->\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        \r\n                        <div class=\"d-flex gap-2\">\r\n                            <button type=\"button\" id=\"analyzeBtn\" class=\"btn btn-info\" disabled>\r\n                                <i class=\"fas fa-search me-2\"></i>\r\n                                Dosyayı Analiz Et\r\n                            </button>\r\n                            <button type=\"submit\" id=\"uploadBtn\" class=\"btn btn-success\" disabled>\r\n                                <i class=\"fas fa-upload me-2\"></i>\r\n                                Yüklemeyi Başlat\r\n                            </button>\r\n                        </div>\r\n                    </form>\r\n                    \r\n                    <div id=\"progressContainer\" class=\"mt-4\" style=\"display: none;\">\r\n                        <div class=\"card\">\r\n                            <div class=\"card-body\">\r\n                                <h6>Yükleme Durumu:</h6>\r\n                                <div class=\"progress mb-3\">\r\n                                    <div id=\"progressBar\" class=\"progress-bar progress-bar-striped progress-bar-animated bg-success\" \r\n                                         role=\"progressbar\" style=\"width: 0%\"></div>\r\n                                </div>\r\n                                <div id=\"progressText\">Hazırlanıyor...</div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div id=\"resultContainer\" class=\"mt-4\" style=\"display: none;\">\r\n                        <div class=\"card\">\r\n                            <div class=\"card-header bg-success text-white\">\r\n                                <h6 class=\"mb-0\">\r\n                                    <i class=\"fas fa-check-circle me-2\"></i>\r\n                                    Yükleme Sonucu\r\n                                </h6>\r\n                            </div>\r\n                            <div class=\"card-body\">\r\n                                <div id=\"resultContent\">\r\n                                    <!-- Result content will be loaded here -->\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                <?php endif; ?>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<script>\r\n$(document).ready(function() {\r\n    let analysisData = null;\r\n    \r\n    // Dosya seçimi değiştiğinde\r\n    $('#excelFile').change(function() {\r\n        const selectedFile = $(this).val();\r\n        if (selectedFile) {\r\n            $('#analyzeBtn').prop('disabled', false);\r\n            $('#fileAnalysis').hide();\r\n            $('#uploadBtn').prop('disabled', true);\r\n            analysisData = null;\r\n        } else {\r\n            $('#analyzeBtn').prop('disabled', true);\r\n            $('#fileAnalysis').hide();\r\n            $('#uploadBtn').prop('disabled', true);\r\n        }\r\n    });\r\n    \r\n    // Analiz butonu\r\n    $('#analyzeBtn').click(function() {\r\n        const selectedFile = $('#excelFile').val();\r\n        if (!selectedFile) return;\r\n        \r\n        $(this).prop('disabled', true).html('<i class=\"fas fa-spinner fa-spin me-2\"></i>Analiz Ediliyor...');\r\n        \r\n        $.post('', {\r\n            action: 'get_file_info',\r\n            file: selectedFile\r\n        })\r\n        .done(function(response) {\r\n            if (response.success) {\r\n                analysisData = response;\r\n                displayAnalysis(response);\r\n                $('#fileAnalysis').show();\r\n                $('#uploadBtn').prop('disabled', !response.isCompatible);\r\n            } else {\r\n                alert('Hata: ' + response.error);\r\n            }\r\n        })\r\n        .fail(function() {\r\n            alert('Sunucu hatası oluştu');\r\n        })\r\n        .always(function() {\r\n            $('#analyzeBtn').prop('disabled', false).html('<i class=\"fas fa-search me-2\"></i>Dosyayı Analiz Et');\r\n        });\r\n    });\r\n    \r\n    // Upload form\r\n    $('#uploadForm').submit(function(e) {\r\n        e.preventDefault();\r\n        \r\n        if (!analysisData || !analysisData.isCompatible) {\r\n            alert('Önce dosya analizi yapın');\r\n            return;\r\n        }\r\n        \r\n        const truncate = $('#truncateTable').is(':checked');\r\n        if (truncate) {\r\n            if (!confirm('UYARI: Bu işlem mevcut tüm Primebaz rapor verilerini silecektir. Devam etmek istediğinizden emin misiniz?')) {\r\n                return;\r\n            }\r\n        }\r\n        \r\n        // Büyük dosya için ek uyarı\r\n        if (analysisData.totalRows > 10000) {\r\n            if (!confirm(`Bu dosyada ${analysisData.totalRows.toLocaleString()} kayıt bulunuyor. Yükleme işlemi uzun sürebilir ve sayfayı kapatmamanız gerekir. Devam etmek istiyor musunuz?`)) {\r\n                return;\r\n            }\r\n        }\r\n        \r\n        startUpload();\r\n    });\r\n    \r\n    function displayAnalysis(data) {\r\n        let html = `\r\n            <div class=\"row\">\r\n                <div class=\"col-md-3\">\r\n                    <div class=\"text-center\">\r\n                        <div class=\"display-6 text-primary\">${data.totalColumns}</div>\r\n                        <div class=\"text-muted\">Sütun Sayısı</div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"col-md-3\">\r\n                    <div class=\"text-center\">\r\n                        <div class=\"display-6 text-info\">${data.totalRows.toLocaleString()}</div>\r\n                        <div class=\"text-muted\">Kayıt Sayısı</div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"col-md-3\">\r\n                    <div class=\"text-center\">\r\n                        <div class=\"display-6 text-success\">${data.period.ay || 'N/A'}</div>\r\n                        <div class=\"text-muted\">Ay</div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"col-md-3\">\r\n                    <div class=\"text-center\">\r\n                        <div class=\"display-6 text-warning\">${data.period.yil || 'N/A'}</div>\r\n                        <div class=\"text-muted\">Yıl</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <hr>\r\n        `;\r\n        \r\n        if (data.isCompatible) {\r\n            html += `\r\n                <div class=\"alert alert-success\">\r\n                    <i class=\"fas fa-check-circle me-2\"></i>\r\n                    <strong>Hazır!</strong> Excel dosyası yüklenmeye hazır.\r\n                    <br><strong>Dönem:</strong> ${data.period.donem}\r\n                    <br><strong>Dosya Boyutu:</strong> ${(data.fileSize / 1024 / 1024).toFixed(2)} MB\r\n                </div>\r\n            `;\r\n            \r\n            // Büyük dosya uyarısı\r\n            if (data.totalRows > 5000) {\r\n                html += `\r\n                    <div class=\"alert alert-info\">\r\n                        <i class=\"fas fa-info-circle me-2\"></i>\r\n                        <strong>Büyük Dosya:</strong> ${data.totalRows.toLocaleString()} kayıt tespit edildi. \r\n                        Yükleme işlemi uzun sürebilir. Lütfen sayfayı kapatmayın.\r\n                    </div>\r\n                `;\r\n            }\r\n        } else {\r\n            html += `\r\n                <div class=\"alert alert-danger\">\r\n                    <i class=\"fas fa-times-circle me-2\"></i>\r\n                    <strong>Uyumsuz!</strong> Dosya yüklenemez.\r\n                </div>\r\n            `;\r\n        }\r\n        \r\n        // Sütun listesi\r\n        if (data.headers && data.headers.length > 0) {\r\n            html += `\r\n                <div class=\"mt-3\">\r\n                    <h6>Dosyada Bulunan Sütunlar:</h6>\r\n                    <div class=\"row\">\r\n            `;\r\n            \r\n            data.headers.forEach(function(header, index) {\r\n                if (index % 3 === 0) html += '<div class=\"col-md-4\">';\r\n                html += `<small class=\"badge bg-light text-dark me-1 mb-1\">${header}</small><br>`;\r\n                if ((index + 1) % 3 === 0 || index === data.headers.length - 1) html += '</div>';\r\n            });\r\n            \r\n            html += `\r\n                    </div>\r\n                </div>\r\n            `;\r\n        }\r\n        \r\n        $('#analysisContent').html(html);\r\n    }\r\n    \r\n    function startUpload() {\r\n        $('#uploadBtn').prop('disabled', true);\r\n        $('#progressContainer').show();\r\n        $('#resultContainer').hide();\r\n        \r\n        updateProgress(0, 'Yükleme başlatılıyor...');\r\n        \r\n        const selectedFile = $('#excelFile').val();\r\n        const truncate = $('#truncateTable').is(':checked') ? '1' : '0';\r\n        \r\n        // Progress simulation for large files\r\n        let progressInterval;\r\n        let currentProgress = 0;\r\n        \r\n        if (analysisData && analysisData.totalRows > 2000) {\r\n            progressInterval = setInterval(function() {\r\n                if (currentProgress < 90) {\r\n                    currentProgress += Math.random() * 2;\r\n                    updateProgress(Math.min(currentProgress, 90), 'Veriler işleniyor... (' + Math.floor(currentProgress) + '%)');\r\n                }\r\n            }, 1500);\r\n        }\r\n        \r\n        $.post('', {\r\n            action: 'upload',\r\n            file: selectedFile,\r\n            truncate: truncate\r\n        })\r\n        .done(function(response) {\r\n            if (progressInterval) {\r\n                clearInterval(progressInterval);\r\n            }\r\n            updateProgress(100, 'Tamamlandı!');\r\n            \r\n            setTimeout(function() {\r\n                $('#progressContainer').hide();\r\n                displayResult(response);\r\n            }, 1000);\r\n        })\r\n        .fail(function(xhr, status, error) {\r\n            if (progressInterval) {\r\n                clearInterval(progressInterval);\r\n            }\r\n            \r\n            let errorMessage = 'Hata oluştu!';\r\n            try {\r\n                if (xhr.responseText) {\r\n                    const response = JSON.parse(xhr.responseText);\r\n                    errorMessage = response.error || errorMessage;\r\n                    console.error('Upload Error Details:', response);\r\n                }\r\n            } catch (e) {\r\n                errorMessage = xhr.responseText || error || 'Bilinmeyen hata';\r\n            }\r\n            \r\n            updateProgress(100, errorMessage);\r\n            $('#progressBar').removeClass('bg-success').addClass('bg-danger');\r\n        })\r\n        .always(function() {\r\n            $('#uploadBtn').prop('disabled', false);\r\n        });\r\n    }\r\n    \r\n    function updateProgress(percent, text) {\r\n        $('#progressBar').css('width', percent + '%');\r\n        $('#progressText').text(text);\r\n        \r\n        if (percent === 100) {\r\n            $('#progressBar').removeClass('progress-bar-animated');\r\n        }\r\n    }\r\n    \r\n    function displayResult(result) {\r\n        let html = '';\r\n        \r\n        if (result.success) {\r\n            html = `\r\n                <div class=\"row text-center mb-3\">\r\n                    <div class=\"col-md-4\">\r\n                        <div class=\"display-6 text-success\">${result.successful || 0}</div>\r\n                        <div class=\"text-muted\">Başarılı Kayıt</div>\r\n                    </div>\r\n                    <div class=\"col-md-4\">\r\n                        <div class=\"display-6 text-danger\">${result.errors || 0}</div>\r\n                        <div class=\"text-muted\">Hatalı Kayıt</div>\r\n                    </div>\r\n                    <div class=\"col-md-4\">\r\n                        <div class=\"display-6 text-info\">${result.totalProcessed || 0}</div>\r\n                        <div class=\"text-muted\">Toplam İşlenen</div>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div class=\"alert alert-success\">\r\n                    <i class=\"fas fa-check-circle me-2\"></i>\r\n                    <strong>Başarılı!</strong> <code>${result.filename}</code> dosyası başarıyla işlendi.\r\n                    <br><strong>Dönem:</strong> ${result.period ? result.period.donem : 'Bilinmiyor'}\r\n                </div>\r\n            `;\r\n            \r\n            if (result.error_details && result.error_details.length > 0) {\r\n                html += `\r\n                    <div class=\"alert alert-warning\">\r\n                        <strong>Hatalar:</strong>\r\n                        <ul class=\"mb-0 mt-2\">\r\n                            ${result.error_details.slice(0, 5).map(error => `<li><small>${error}</small></li>`).join('')}\r\n                        </ul>\r\n                        ${result.error_details.length > 5 ? `<small class=\"text-muted\">... ve ${result.error_details.length - 5} hata daha</small>` : ''}\r\n                    </div>\r\n                `;\r\n            }\r\n        } else {\r\n            html = `\r\n                <div class=\"alert alert-danger\">\r\n                    <i class=\"fas fa-times-circle me-2\"></i>\r\n                    <strong>Hata!</strong> ${result.error}\r\n                </div>\r\n            `;\r\n        }\r\n        \r\n        $('#resultContent').html(html);\r\n        $('#resultContainer').show();\r\n    }\r\n});\r\n</script>\r\n\r\n<?php include 'includes/footer.php'; ?>"
        }
    ]
}
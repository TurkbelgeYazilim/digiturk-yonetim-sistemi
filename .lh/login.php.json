{
    "sourceFile": "login.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 6,
            "patches": [
                {
                    "date": 1758982253562,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1758982342249,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -171,9 +171,9 @@\n             <div class=\"col-md-6 col-lg-5\">\r\n                 <div class=\"login-card\">\r\n                     <div class=\"login-header\">\r\n                         <div class=\"mb-3\">\r\n-                            <img src=\"assets/images/ileka-logo.jpg\" alt=\"İleka Logo\" style=\"height: 60px;\" class=\"mb-3\">\r\n+                            <img src=\"assets/images/logo.jpg\" alt=\"İleka Logo\" style=\"height: 60px;\" class=\"mb-3\">\r\n                         </div>\r\n                         <h3 class=\"mb-0\">Hoş Geldiniz</h3>\r\n                         <p class=\"mb-0\">Digitürk İleka Yönetim Paneli</p>\r\n                     </div>\r\n"
                },
                {
                    "date": 1758982389330,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -171,9 +171,9 @@\n             <div class=\"col-md-6 col-lg-5\">\r\n                 <div class=\"login-card\">\r\n                     <div class=\"login-header\">\r\n                         <div class=\"mb-3\">\r\n-                            <img src=\"assets/images/logo.jpg\" alt=\"İleka Logo\" style=\"height: 60px;\" class=\"mb-3\">\r\n+                            <img src=\"assets/images/logo.png\" alt=\"İleka Logo\" style=\"height: 60px;\" class=\"mb-3\">\r\n                         </div>\r\n                         <h3 class=\"mb-0\">Hoş Geldiniz</h3>\r\n                         <p class=\"mb-0\">Digitürk İleka Yönetim Paneli</p>\r\n                     </div>\r\n"
                },
                {
                    "date": 1758982418674,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -173,10 +173,8 @@\n                     <div class=\"login-header\">\r\n                         <div class=\"mb-3\">\r\n                             <img src=\"assets/images/logo.png\" alt=\"İleka Logo\" style=\"height: 60px;\" class=\"mb-3\">\r\n                         </div>\r\n-                        <h3 class=\"mb-0\">Hoş Geldiniz</h3>\r\n-                        <p class=\"mb-0\">Digitürk İleka Yönetim Paneli</p>\r\n                     </div>\r\n                     \r\n                     <div class=\"login-body\">\r\n                         <?php if ($error): ?>\r\n"
                },
                {
                    "date": 1759329797087,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,34 @@\n <?php\r\n session_start();\r\n \r\n+// Veritabanı bağlantı fonksiyonu\r\n+function getDatabaseConnection() {\r\n+    $configFile = __DIR__ . '/config/mssql.php';\r\n+    \r\n+    if (!file_exists($configFile)) {\r\n+        throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n+    }\r\n+    \r\n+    $config = include $configFile;\r\n+    \r\n+    try {\r\n+        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n+        \r\n+        $connection = new PDO($dsn, $config['username'], $config['password'], [\r\n+            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n+            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n+            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n+            PDO::ATTR_EMULATE_PREPARES => false\r\n+        ]);\r\n+        \r\n+        return $connection;\r\n+        \r\n+    } catch (PDOException $e) {\r\n+        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n+    }\r\n+}\r\n+\r\n // Zaten giriş yapmışsa ana sayfaya yönlendir\r\n if (isset($_SESSION['user_id'])) {\r\n     header('Location: index.php');\r\n     exit;\r\n@@ -10,19 +37,16 @@\n $error = '';\r\n $success = '';\r\n \r\n if ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n-    require_once 'MSSQLConnection.php';\r\n-    \r\n     $email = trim($_POST['email'] ?? '');\r\n     $password = $_POST['password'] ?? '';\r\n     \r\n     if (empty($email) || empty($password)) {\r\n         $error = 'E-posta ve şifre alanları zorunludur.';\r\n     } else {\r\n         try {\r\n-            $db = new MSSQLConnection();\r\n-            $conn = $db->getConnection();\r\n+            $conn = getDatabaseConnection();\r\n             \r\n             // Kullanıcıyı e-posta ile bul (grup bilgileri ile birlikte)\r\n             $sql = \"SELECT u.id, u.email, u.password_hash, u.first_name, u.last_name, u.phone, u.status, \r\n                            u.login_attempts, u.locked_until, u.user_group_id,\r\n"
                },
                {
                    "date": 1759385814941,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,33 +1,9 @@\n <?php\r\n session_start();\r\n \r\n-// Veritabanı bağlantı fonksiyonu\r\n-function getDatabaseConnection() {\r\n-    $configFile = __DIR__ . '/config/mssql.php';\r\n-    \r\n-    if (!file_exists($configFile)) {\r\n-        throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n-    }\r\n-    \r\n-    $config = include $configFile;\r\n-    \r\n-    try {\r\n-        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n-        \r\n-        $connection = new PDO($dsn, $config['username'], $config['password'], [\r\n-            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n-            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n-            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n-            PDO::ATTR_EMULATE_PREPARES => false\r\n-        ]);\r\n-        \r\n-        return $connection;\r\n-        \r\n-    } catch (PDOException $e) {\r\n-        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n-    }\r\n-}\r\n+// Veritabanı bağlantı fonksiyonu auth.php dosyasından include edilecek\r\n+require_once 'auth.php';\r\n \r\n // Zaten giriş yapmışsa ana sayfaya yönlendir\r\n if (isset($_SESSION['user_id'])) {\r\n     header('Location: index.php');\r\n"
                },
                {
                    "date": 1760620783462,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -25,9 +25,9 @@\n             \r\n             // Kullanıcıyı e-posta ile bul (grup bilgileri ile birlikte)\r\n             $sql = \"SELECT u.id, u.email, u.password_hash, u.first_name, u.last_name, u.phone, u.status, \r\n                            u.login_attempts, u.locked_until, u.user_group_id,\r\n-                           ug.group_name, ug.group_description, ug.permissions\r\n+                           ug.group_name, ug.group_description\r\n                     FROM users u \r\n                     LEFT JOIN user_groups ug ON u.user_group_id = ug.id\r\n                     WHERE u.email = ? AND u.status = 'AKTIF'\";\r\n             $stmt = $conn->prepare($sql);\r\n@@ -48,9 +48,9 @@\n                         $_SESSION['user_name'] = $user['first_name'] . ' ' . $user['last_name'];\r\n                         $_SESSION['user_phone'] = $user['phone'];\r\n                         $_SESSION['user_group_id'] = $user['user_group_id'];\r\n                         $_SESSION['user_group_name'] = $user['group_name'];\r\n-                        $_SESSION['user_permissions'] = $user['permissions'];\r\n+                        $_SESSION['user_permissions'] = null; // permissions alanı yok\r\n                         \r\n                         // Login attempts sıfırla ve son giriş tarihini güncelle\r\n                         $updateSql = \"UPDATE users SET login_attempts = 0, locked_until = NULL, last_login = GETDATE() WHERE id = ?\";\r\n                         $updateStmt = $conn->prepare($updateSql);\r\n"
                }
            ],
            "date": 1758982253562,
            "name": "Commit-0",
            "content": "<?php\r\nsession_start();\r\n\r\n// Zaten giriş yapmışsa ana sayfaya yönlendir\r\nif (isset($_SESSION['user_id'])) {\r\n    header('Location: index.php');\r\n    exit;\r\n}\r\n\r\n$error = '';\r\n$success = '';\r\n\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    require_once 'MSSQLConnection.php';\r\n    \r\n    $email = trim($_POST['email'] ?? '');\r\n    $password = $_POST['password'] ?? '';\r\n    \r\n    if (empty($email) || empty($password)) {\r\n        $error = 'E-posta ve şifre alanları zorunludur.';\r\n    } else {\r\n        try {\r\n            $db = new MSSQLConnection();\r\n            $conn = $db->getConnection();\r\n            \r\n            // Kullanıcıyı e-posta ile bul (grup bilgileri ile birlikte)\r\n            $sql = \"SELECT u.id, u.email, u.password_hash, u.first_name, u.last_name, u.phone, u.status, \r\n                           u.login_attempts, u.locked_until, u.user_group_id,\r\n                           ug.group_name, ug.group_description, ug.permissions\r\n                    FROM users u \r\n                    LEFT JOIN user_groups ug ON u.user_group_id = ug.id\r\n                    WHERE u.email = ? AND u.status = 'AKTIF'\";\r\n            $stmt = $conn->prepare($sql);\r\n            $stmt->execute([$email]);\r\n            $user = $stmt->fetch(PDO::FETCH_ASSOC);\r\n            \r\n            if ($user) {\r\n                // Hesap kilitli mi kontrol et\r\n                if ($user['locked_until'] && new DateTime($user['locked_until']) > new DateTime()) {\r\n                    $lockTime = new DateTime($user['locked_until']);\r\n                    $error = 'Hesabınız ' . $lockTime->format('d.m.Y H:i') . ' tarihine kadar kilitlidir.';\r\n                } else {\r\n                    // Şifre doğru mu kontrol et\r\n                    if (password_verify($password, $user['password_hash'])) {\r\n                        // Başarılı giriş\r\n                        $_SESSION['user_id'] = $user['id'];\r\n                        $_SESSION['user_email'] = $user['email'];\r\n                        $_SESSION['user_name'] = $user['first_name'] . ' ' . $user['last_name'];\r\n                        $_SESSION['user_phone'] = $user['phone'];\r\n                        $_SESSION['user_group_id'] = $user['user_group_id'];\r\n                        $_SESSION['user_group_name'] = $user['group_name'];\r\n                        $_SESSION['user_permissions'] = $user['permissions'];\r\n                        \r\n                        // Login attempts sıfırla ve son giriş tarihini güncelle\r\n                        $updateSql = \"UPDATE users SET login_attempts = 0, locked_until = NULL, last_login = GETDATE() WHERE id = ?\";\r\n                        $updateStmt = $conn->prepare($updateSql);\r\n                        $updateStmt->execute([$user['id']]);\r\n                        \r\n                        header('Location: index.php');\r\n                        exit;\r\n                    } else {\r\n                        // Yanlış şifre - giriş denemesi arttır\r\n                        $attempts = $user['login_attempts'] + 1;\r\n                        $lockUntil = null;\r\n                        \r\n                        // 5 yanlış denemeden sonra hesabı 30 dakika kilitle\r\n                        if ($attempts >= 5) {\r\n                            $lockUntil = date('Y-m-d H:i:s', strtotime('+30 minutes'));\r\n                            $error = 'Çok fazla yanlış deneme yaptınız. Hesabınız 30 dakika süreyle kilitlendi.';\r\n                        } else {\r\n                            $remaining = 5 - $attempts;\r\n                            $error = \"Yanlış şifre. Kalan deneme hakkınız: $remaining\";\r\n                        }\r\n                        \r\n                        $updateSql = \"UPDATE users SET login_attempts = ?, locked_until = ? WHERE id = ?\";\r\n                        $updateStmt = $conn->prepare($updateSql);\r\n                        $updateStmt->execute([$attempts, $lockUntil, $user['id']]);\r\n                    }\r\n                }\r\n            } else {\r\n                $error = 'Geçersiz e-posta adresi veya hesabınız aktif değil.';\r\n            }\r\n        } catch (Exception $e) {\r\n            $error = 'Sistem hatası: ' . $e->getMessage();\r\n        }\r\n    }\r\n}\r\n?>\r\n\r\n<!DOCTYPE html>\r\n<html lang=\"tr\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Giriş Yap - Digitürk İleka</title>\r\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\r\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css\" rel=\"stylesheet\">\r\n    <style>\r\n        body {\r\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n            min-height: 100vh;\r\n            display: flex;\r\n            align-items: center;\r\n        }\r\n        .login-card {\r\n            background: rgba(255, 255, 255, 0.95);\r\n            backdrop-filter: blur(10px);\r\n            border-radius: 15px;\r\n            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);\r\n            overflow: hidden;\r\n        }\r\n        .login-header {\r\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n            color: white;\r\n            padding: 2rem;\r\n            text-align: center;\r\n        }\r\n        .login-body {\r\n            padding: 2rem;\r\n        }\r\n        .form-control {\r\n            border: none;\r\n            border-bottom: 2px solid #e0e0e0;\r\n            border-radius: 0;\r\n            padding: 15px 0;\r\n            background: transparent;\r\n            transition: all 0.3s ease;\r\n        }\r\n        .form-control:focus {\r\n            border-bottom-color: #667eea;\r\n            box-shadow: none;\r\n            background: transparent;\r\n        }\r\n        .form-label {\r\n            font-weight: 600;\r\n            color: #333;\r\n            margin-bottom: 0.5rem;\r\n        }\r\n        .btn-login {\r\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n            border: none;\r\n            padding: 12px 30px;\r\n            border-radius: 25px;\r\n            font-weight: 600;\r\n            transition: all 0.3s ease;\r\n        }\r\n        .btn-login:hover {\r\n            transform: translateY(-2px);\r\n            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);\r\n        }\r\n        .input-group {\r\n            position: relative;\r\n            margin-bottom: 1.5rem;\r\n        }\r\n        .input-icon {\r\n            position: absolute;\r\n            left: 0;\r\n            top: 50%;\r\n            transform: translateY(-50%);\r\n            color: #666;\r\n            z-index: 10;\r\n        }\r\n        .form-control {\r\n            padding-left: 30px;\r\n        }\r\n    </style>\r\n</head>\r\n<body>\r\n    <div class=\"container\">\r\n        <div class=\"row justify-content-center\">\r\n            <div class=\"col-md-6 col-lg-5\">\r\n                <div class=\"login-card\">\r\n                    <div class=\"login-header\">\r\n                        <div class=\"mb-3\">\r\n                            <img src=\"assets/images/ileka-logo.jpg\" alt=\"İleka Logo\" style=\"height: 60px;\" class=\"mb-3\">\r\n                        </div>\r\n                        <h3 class=\"mb-0\">Hoş Geldiniz</h3>\r\n                        <p class=\"mb-0\">Digitürk İleka Yönetim Paneli</p>\r\n                    </div>\r\n                    \r\n                    <div class=\"login-body\">\r\n                        <?php if ($error): ?>\r\n                            <div class=\"alert alert-danger alert-dismissible fade show\" role=\"alert\">\r\n                                <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                                <?php echo htmlspecialchars($error); ?>\r\n                                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n                            </div>\r\n                        <?php endif; ?>\r\n                        \r\n                        <?php if ($success): ?>\r\n                            <div class=\"alert alert-success alert-dismissible fade show\" role=\"alert\">\r\n                                <i class=\"fas fa-check-circle me-2\"></i>\r\n                                <?php echo htmlspecialchars($success); ?>\r\n                                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n                            </div>\r\n                        <?php endif; ?>\r\n                        \r\n                        <form method=\"POST\" action=\"\" id=\"loginForm\">\r\n                            <div class=\"input-group\">\r\n                                <i class=\"fas fa-envelope input-icon\"></i>\r\n                                <input type=\"email\" \r\n                                       class=\"form-control\" \r\n                                       id=\"email\" \r\n                                       name=\"email\" \r\n                                       placeholder=\"E-posta adresiniz\"\r\n                                       value=\"<?php echo htmlspecialchars($_POST['email'] ?? ''); ?>\"\r\n                                       required>\r\n                            </div>\r\n                            \r\n                            <div class=\"input-group\">\r\n                                <i class=\"fas fa-lock input-icon\"></i>\r\n                                <input type=\"password\" \r\n                                       class=\"form-control\" \r\n                                       id=\"password\" \r\n                                       name=\"password\" \r\n                                       placeholder=\"Şifreniz\"\r\n                                       required>\r\n                                <i class=\"fas fa-eye-slash position-absolute end-0 top-50 translate-middle-y me-3\" \r\n                                   style=\"cursor: pointer; z-index: 10;\" \r\n                                   onclick=\"togglePassword()\"\r\n                                   id=\"passwordToggle\"></i>\r\n                            </div>\r\n                            \r\n                            <div class=\"row mb-3\">\r\n                                <div class=\"col-md-6\">\r\n                                    <div class=\"form-check\">\r\n                                        <input class=\"form-check-input\" type=\"checkbox\" id=\"remember_me\" name=\"remember_me\">\r\n                                        <label class=\"form-check-label text-muted\" for=\"remember_me\">\r\n                                            Beni hatırla\r\n                                        </label>\r\n                                    </div>\r\n                                </div>\r\n                                <div class=\"col-md-6 text-end\">\r\n                                    <a href=\"forgot-password.php\" class=\"text-decoration-none\">\r\n                                        <small>Şifremi unuttum</small>\r\n                                    </a>\r\n                                </div>\r\n                            </div>\r\n                            \r\n                            <div class=\"d-grid\">\r\n                                <button type=\"submit\" class=\"btn btn-primary btn-login btn-lg\">\r\n                                    <i class=\"fas fa-sign-in-alt me-2\"></i>\r\n                                    Giriş Yap\r\n                                </button>\r\n                            </div>\r\n                        </form>\r\n                        \r\n                        <hr class=\"my-4\">\r\n                        \r\n                        <div class=\"text-center\">\r\n                            <p class=\"text-muted mb-0\">\r\n                                <small>\r\n                                    <i class=\"fas fa-shield-alt me-1\"></i>\r\n                                    Güvenli bağlantı ile korunmaktadır\r\n                                </small>\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\r\n    <script>\r\n        // Şifre görünürlüğü toggle\r\n        function togglePassword() {\r\n            const passwordInput = document.getElementById('password');\r\n            const toggleIcon = document.getElementById('passwordToggle');\r\n            \r\n            if (passwordInput.type === 'password') {\r\n                passwordInput.type = 'text';\r\n                toggleIcon.classList.remove('fa-eye-slash');\r\n                toggleIcon.classList.add('fa-eye');\r\n            } else {\r\n                passwordInput.type = 'password';\r\n                toggleIcon.classList.remove('fa-eye');\r\n                toggleIcon.classList.add('fa-eye-slash');\r\n            }\r\n        }\r\n        \r\n        // Form validasyonu\r\n        document.getElementById('loginForm').addEventListener('submit', function(e) {\r\n            const email = document.getElementById('email').value.trim();\r\n            const password = document.getElementById('password').value;\r\n            \r\n            if (!email || !password) {\r\n                e.preventDefault();\r\n                alert('Lütfen tüm alanları doldurunuz.');\r\n                return false;\r\n            }\r\n            \r\n            // Email format kontrolü\r\n            const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n            if (!emailRegex.test(email)) {\r\n                e.preventDefault();\r\n                alert('Lütfen geçerli bir e-posta adresi giriniz.');\r\n                return false;\r\n            }\r\n            \r\n            // Loading göster\r\n            const submitBtn = this.querySelector('button[type=\"submit\"]');\r\n            const originalText = submitBtn.innerHTML;\r\n            submitBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin me-2\"></i>Giriş yapılıyor...';\r\n            submitBtn.disabled = true;\r\n            \r\n            // Hata durumunda loading'i geri al\r\n            setTimeout(() => {\r\n                submitBtn.innerHTML = originalText;\r\n                submitBtn.disabled = false;\r\n            }, 5000);\r\n        });\r\n        \r\n        // Enter tuşu ile form submit\r\n        document.addEventListener('keypress', function(e) {\r\n            if (e.key === 'Enter') {\r\n                document.getElementById('loginForm').submit();\r\n            }\r\n        });\r\n        \r\n        // Auto focus\r\n        document.addEventListener('DOMContentLoaded', function() {\r\n            document.getElementById('email').focus();\r\n        });\r\n    </script>\r\n</body>\r\n</html>\r\n"
        }
    ]
}
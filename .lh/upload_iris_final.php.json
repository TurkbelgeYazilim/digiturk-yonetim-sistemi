{
    "sourceFile": "upload_iris_final.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1760454118844,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1760454118844,
            "name": "Commit-0",
            "content": "<!DOCTYPE html>\r\n<html lang=\"tr\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>CSV Yükleme Sistemi - Düzeltilmiş</title>\r\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\r\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css\" rel=\"stylesheet\">\r\n    <style>\r\n        .progress-container { margin: 20px 0; }\r\n        .stats-card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; }\r\n        .error-list { max-height: 200px; overflow-y: auto; }\r\n        .file-info { background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; }\r\n        .column-check { padding: 10px; border-radius: 5px; margin: 10px 0; }\r\n        .column-check.compatible { background: #d4edda; border: 1px solid #c3e6cb; }\r\n        .column-check.incompatible { background: #f8d7da; border: 1px solid #f5c6cb; }\r\n        .column-details { margin-top: 10px; }\r\n        .column-list { max-height: 150px; overflow-y: auto; font-size: 0.9em; }\r\n    </style>\r\n</head>\r\n<body>\r\n    <?php include 'includes/header.php'; ?>\r\n    \r\n    <div class=\"container mt-4\">\r\n        <h2>CSV Dosya Yükleme Sistemi (Düzeltilmiş)</h2>\r\n        <div class=\"alert alert-info\">\r\n            <i class=\"fas fa-info-circle me-2\"></i>\r\n            <strong>Yeni Özellik:</strong> CSV dosyası seçildiğinde, dosyadaki başlıklar SQL tablo sütunları ile otomatik kontrol edilir. \r\n            Uyumsuzluk durumunda işleme başlanamaz.\r\n        </div>\r\n        \r\n        <div class=\"row\">\r\n            <div class=\"col-md-8\">\r\n                <div class=\"card\">\r\n                    <div class=\"card-body\">\r\n                        <h5>Dosya Seçimi</h5>\r\n                        \r\n                        <div class=\"file-selector mb-3\">\r\n                            <select id=\"fileSelect\" class=\"form-select\">\r\n                                <option value=\"\">Dosya seçin...</option>\r\n                            </select>\r\n                            <small class=\"text-muted\">Sunucu uploads klasöründeki CSV dosyaları</small>\r\n                        </div>\r\n                        \r\n                        <div id=\"fileInfo\" class=\"file-info\" style=\"display: none;\"></div>\r\n                        \r\n                        <div id=\"columnCheck\" class=\"column-check\" style=\"display: none;\"></div>\r\n                        \r\n                        <div class=\"d-grid gap-2\">\r\n                            <button id=\"startProcess\" class=\"btn btn-primary btn-lg\" disabled>\r\n                                İşleme Başla\r\n                            </button>\r\n                            <button id=\"pauseProcess\" class=\"btn btn-warning\" style=\"display: none;\">\r\n                                Duraklat\r\n                            </button>\r\n                        </div>\r\n                        \r\n                        <div id=\"progressContainer\" class=\"progress-container\" style=\"display: none;\">\r\n                            <div class=\"progress\">\r\n                                <div id=\"progressBar\" class=\"progress-bar\" role=\"progressbar\" style=\"width: 0%\">0%</div>\r\n                            </div>\r\n                            <div class=\"row mt-2\">\r\n                                <div class=\"col\">\r\n                                    <small>İşlenen: <span id=\"processedCount\">0</span></small>\r\n                                </div>\r\n                                <div class=\"col text-end\">\r\n                                    <small>Kalan: <span id=\"remainingCount\">0</span></small>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            \r\n            <div class=\"col-md-4\">\r\n                <div class=\"stats-card\">\r\n                    <h6>İstatistikler</h6>\r\n                    <p>Güncellenen: <span id=\"updatedCount\" class=\"badge bg-primary\">0</span></p>\r\n                    <p>Eklenen: <span id=\"insertedCount\" class=\"badge bg-success\">0</span></p>\r\n                    <p>Hata: <span id=\"errorCount\" class=\"badge bg-danger\">0</span></p>\r\n                    <p>Süre: <span id=\"processingTime\">0s</span></p>\r\n                </div>\r\n                \r\n                <div id=\"errorContainer\" style=\"display: none;\">\r\n                    <h6>Hatalar</h6>\r\n                    <div id=\"errorList\" class=\"error-list border p-2\"></div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js\"></script>\r\n    <script>\r\n        let isProcessing = false;\r\n        let isPaused = false;\r\n        let currentFile = '';\r\n        let totalLines = 0;\r\n        let currentOffset = 0;\r\n        let chunkSize = 25; // Conservative chunk size\r\n        let startTime = 0;\r\n        \r\n        // Dosya listesini yükle\r\n        async function loadFileList() {\r\n            try {\r\n                const response = await fetch('list_uploads.php');\r\n                const files = await response.json();\r\n                \r\n                const select = document.getElementById('fileSelect');\r\n                select.innerHTML = '<option value=\"\">Dosya seçin...</option>';\r\n                \r\n                files.forEach(file => {\r\n                    const option = document.createElement('option');\r\n                    option.value = file;\r\n                    option.textContent = file;\r\n                    select.appendChild(option);\r\n                });\r\n            } catch (error) {\r\n                console.error('Dosya listesi yüklenemedi:', error);\r\n            }\r\n        }\r\n        \r\n        // CSV sütun kontrolü\r\n        async function checkCsvColumns(filename) {\r\n            try {\r\n                const response = await fetch(`check_csv_columns.php?file=${encodeURIComponent(filename)}`);\r\n                const result = await response.json();\r\n                \r\n                if (result.success) {\r\n                    const checkDiv = document.getElementById('columnCheck');\r\n                    const isCompatible = result.is_compatible;\r\n                    \r\n                    checkDiv.className = `column-check ${isCompatible ? 'compatible' : 'incompatible'}`;\r\n                    \r\n                    let html = `\r\n                        <div class=\"d-flex align-items-center mb-2\">\r\n                            <i class=\"fas ${isCompatible ? 'fa-check-circle text-success' : 'fa-exclamation-triangle text-warning'} me-2\"></i>\r\n                            <strong>${result.compatibility_message}</strong>\r\n                        </div>\r\n                        <div class=\"row\">\r\n                            <div class=\"col-md-6\">\r\n                                <small><strong>CSV Sütun Sayısı:</strong> ${result.total_csv_columns}</small>\r\n                            </div>\r\n                            <div class=\"col-md-6\">\r\n                                <small><strong>SQL Tablo Sütun Sayısı:</strong> ${result.total_expected_columns}</small>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"row\">\r\n                            <div class=\"col-md-6\">\r\n                                <small><strong>Eşleşen Sütunlar:</strong> ${result.matching_columns}</small>\r\n                            </div>\r\n                        </div>\r\n                    `;\r\n                    \r\n                    if (result.missing_in_csv.length > 0) {\r\n                        html += `\r\n                            <div class=\"column-details\">\r\n                                <small><strong>CSV'de Eksik Sütunlar:</strong></small>\r\n                                <div class=\"column-list text-danger\">\r\n                                    ${result.missing_in_csv.join(', ')}\r\n                                </div>\r\n                            </div>\r\n                        `;\r\n                    }\r\n                    \r\n                    if (result.extra_in_csv.length > 0) {\r\n                        html += `\r\n                            <div class=\"column-details\">\r\n                                <small><strong>CSV'de Fazla Sütunlar:</strong></small>\r\n                                <div class=\"column-list text-warning\">\r\n                                    ${result.extra_in_csv.join(', ')}\r\n                                </div>\r\n                            </div>\r\n                        `;\r\n                    }\r\n                    \r\n                    if (result.order_mismatch.length > 0) {\r\n                        html += `\r\n                            <div class=\"column-details\">\r\n                                <small><strong>Sıralama Uyumsuzlukları:</strong></small>\r\n                                <div class=\"column-list\">\r\n                                    ${result.order_mismatch.map(item => \r\n                                        `Pozisyon ${item.position}: Beklenen \"${item.expected}\", Bulunan \"${item.found}\"`\r\n                                    ).join('<br>')}\r\n                                </div>\r\n                            </div>\r\n                        `;\r\n                    }\r\n                    \r\n                    checkDiv.innerHTML = html;\r\n                    checkDiv.style.display = 'block';\r\n                    \r\n                    // Uyumlu değilse işleme başlama butonunu devre dışı bırak\r\n                    if (!isCompatible) {\r\n                        document.getElementById('startProcess').disabled = true;\r\n                        document.getElementById('startProcess').innerHTML = 'Uyumsuz CSV - İşlem Yapılamaz';\r\n                    }\r\n                    \r\n                    return isCompatible;\r\n                } else {\r\n                    console.error('Sütun kontrolü hatası:', result.message);\r\n                    return false;\r\n                }\r\n            } catch (error) {\r\n                console.error('Sütun kontrolü alınamadı:', error);\r\n                return false;\r\n            }\r\n        }\r\n        \r\n        // Dosya bilgilerini al\r\n        async function getFileInfo(filename) {\r\n            try {\r\n                // Önce sütun kontrolü yap\r\n                const isCompatible = await checkCsvColumns(filename);\r\n                \r\n                if (!isCompatible) {\r\n                    // Uyumsuz CSV durumunda dosya bilgilerini gösterme\r\n                    return;\r\n                }\r\n                \r\n                const response = await fetch(`correct_chunked_csv.php?action=info&file=${encodeURIComponent(filename)}`);\r\n                const info = await response.json();\r\n                \r\n                if (info.success) {\r\n                    // Güvenlik kontrolleri\r\n                    const fileName = info.file || filename || 'Bilinmeyen';\r\n                    const totalLinesCount = info.total_lines || info.total_rows || 0;\r\n                    const fileSize = info.file_size || 0;\r\n                    const recommendedChunk = info.recommended_chunk_size || info.chunk_size || 25;\r\n                    \r\n                    document.getElementById('fileInfo').innerHTML = `\r\n                        <strong>Dosya:</strong> ${fileName}<br>\r\n                        <strong>Toplam Satır:</strong> ${totalLinesCount.toLocaleString()}<br>\r\n                        <strong>Dosya Boyutu:</strong> ${(fileSize / 1024 / 1024).toFixed(2)} MB<br>\r\n                        <strong>Önerilen Chunk:</strong> ${recommendedChunk} satır\r\n                    `;\r\n                    document.getElementById('fileInfo').style.display = 'block';\r\n                    \r\n                    totalLines = totalLinesCount;\r\n                    currentOffset = 0;\r\n                    chunkSize = Math.min(recommendedChunk, 25); // Max 25\r\n                    \r\n                    document.getElementById('startProcess').disabled = false;\r\n                } else {\r\n                    alert('Dosya bilgisi alınamadı: ' + (info.message || 'Bilinmeyen hata'));\r\n                }\r\n            } catch (error) {\r\n                console.error('Dosya bilgisi alınamadı:', error);\r\n            }\r\n        }\r\n        \r\n        // Chunk işle\r\n        async function processChunk() {\r\n            if (isPaused || !isProcessing) return false;\r\n            \r\n            try {\r\n                const response = await fetch(`correct_chunked_csv.php?action=process&file=${encodeURIComponent(currentFile)}&offset=${currentOffset}&chunk_size=${chunkSize}`);\r\n                \r\n                // Response'u önce text olarak al, sonra JSON parse et\r\n                const responseText = await response.text();\r\n                console.log('Response:', responseText.substring(0, 200) + '...');\r\n                \r\n                let result;\r\n                try {\r\n                    result = JSON.parse(responseText);\r\n                } catch (jsonError) {\r\n                    console.error('JSON Parse Error:', jsonError);\r\n                    console.error('Response Text:', responseText);\r\n                    throw new Error('JSON Parse Error: ' + responseText.substring(0, 100));\r\n                }\r\n                \r\n                if (result.success) {\r\n                    // İstatistikleri güncelle\r\n                    const currentUpdated = parseInt(document.getElementById('updatedCount').textContent);\r\n                    const currentInserted = parseInt(document.getElementById('insertedCount').textContent);\r\n                    const currentErrors = parseInt(document.getElementById('errorCount').textContent);\r\n                    \r\n                    document.getElementById('updatedCount').textContent = currentUpdated + result.updated;\r\n                    document.getElementById('insertedCount').textContent = currentInserted + result.inserted;\r\n                    document.getElementById('errorCount').textContent = currentErrors + result.errors.length;\r\n                    \r\n                    // Hataları göster\r\n                    if (result.errors.length > 0) {\r\n                        const errorList = document.getElementById('errorList');\r\n                        result.errors.forEach(error => {\r\n                            errorList.innerHTML += '<div class=\"text-danger small\">' + error + '</div>';\r\n                        });\r\n                        document.getElementById('errorContainer').style.display = 'block';\r\n                    }\r\n                    \r\n                    // Debug bilgisini console'a yazdır\r\n                    if (result.debug_info && result.debug_info.length > 0) {\r\n                        console.log('Debug Info:', result.debug_info);\r\n                        result.debug_info.forEach(info => {\r\n                            console.log(info);\r\n                        });\r\n                    }\r\n                    \r\n                    // Progress güncelle\r\n                    const progress = Math.round((result.next_offset / totalLines) * 100);\r\n                    document.getElementById('progressBar').style.width = progress + '%';\r\n                    document.getElementById('progressBar').textContent = progress + '%';\r\n                    document.getElementById('processedCount').textContent = result.next_offset.toLocaleString();\r\n                    document.getElementById('remainingCount').textContent = (totalLines - result.next_offset).toLocaleString();\r\n                    \r\n                    // Süre\r\n                    const elapsedTime = Math.round((Date.now() - startTime) / 1000);\r\n                    document.getElementById('processingTime').textContent = elapsedTime + 's';\r\n                    \r\n                    currentOffset = result.next_offset;\r\n                    \r\n                    // Devam var mı?\r\n                    if (result.has_more && result.processed > 0) {\r\n                        setTimeout(processChunk, 100); // 100ms gecikme\r\n                        return true;\r\n                    } else {\r\n                        // İşlem tamamlandı\r\n                        isProcessing = false;\r\n                        document.getElementById('startProcess').style.display = 'block';\r\n                        document.getElementById('pauseProcess').style.display = 'none';\r\n                        document.getElementById('startProcess').textContent = 'İşlem Tamamlandı';\r\n                        document.getElementById('startProcess').disabled = true;\r\n                        return false;\r\n                    }\r\n                } else {\r\n                    throw new Error(result.message);\r\n                }\r\n            } catch (error) {\r\n                console.error('Chunk işleme hatası:', error);\r\n                \r\n                // İşlemi durdur\r\n                isProcessing = false;\r\n                isPaused = true;\r\n                \r\n                // UI'yi güncelle\r\n                document.getElementById('startProcess').style.display = 'block';\r\n                document.getElementById('pauseProcess').style.display = 'none';\r\n                document.getElementById('startProcess').textContent = 'Hata - Tekrar Dene';\r\n                document.getElementById('startProcess').disabled = false;\r\n                \r\n                // Hata mesajını göster\r\n                const errorDiv = document.createElement('div');\r\n                errorDiv.className = 'alert alert-danger mt-3';\r\n                errorDiv.innerHTML = `<strong>İşlem Hatası:</strong> ${error.message}`;\r\n                document.querySelector('.card-body').appendChild(errorDiv);\r\n                \r\n                return false;\r\n            }\r\n        }\r\n        \r\n        // Event listeners\r\n        document.getElementById('fileSelect').addEventListener('change', function() {\r\n            const filename = this.value;\r\n            if (filename) {\r\n                currentFile = filename;\r\n                // Önceki bilgileri temizle\r\n                document.getElementById('fileInfo').style.display = 'none';\r\n                document.getElementById('columnCheck').style.display = 'none';\r\n                document.getElementById('startProcess').disabled = true;\r\n                document.getElementById('startProcess').innerHTML = 'İşleme Başla';\r\n                \r\n                getFileInfo(filename);\r\n            } else {\r\n                document.getElementById('fileInfo').style.display = 'none';\r\n                document.getElementById('columnCheck').style.display = 'none';\r\n                document.getElementById('startProcess').disabled = true;\r\n            }\r\n        });\r\n        \r\n        document.getElementById('startProcess').addEventListener('click', function() {\r\n            if (!currentFile) {\r\n                alert('Lütfen bir dosya seçin');\r\n                return;\r\n            }\r\n            \r\n            isProcessing = true;\r\n            isPaused = false;\r\n            startTime = Date.now();\r\n            \r\n            this.style.display = 'none';\r\n            document.getElementById('pauseProcess').style.display = 'block';\r\n            document.getElementById('progressContainer').style.display = 'block';\r\n            \r\n            // İstatistikleri sıfırla\r\n            document.getElementById('updatedCount').textContent = '0';\r\n            document.getElementById('insertedCount').textContent = '0';\r\n            document.getElementById('errorCount').textContent = '0';\r\n            document.getElementById('errorList').innerHTML = '';\r\n            document.getElementById('errorContainer').style.display = 'none';\r\n            \r\n            processChunk();\r\n        });\r\n        \r\n        document.getElementById('pauseProcess').addEventListener('click', function() {\r\n            isPaused = true;\r\n            isProcessing = false;\r\n            \r\n            this.style.display = 'none';\r\n            document.getElementById('startProcess').style.display = 'block';\r\n            document.getElementById('startProcess').textContent = 'Devam Et';\r\n            document.getElementById('startProcess').disabled = false;\r\n        });\r\n        \r\n        // Sayfa yüklendiğinde dosya listesini al\r\n        loadFileList();\r\n    </script>\r\n</body>\r\n</html>\r\n"
        }
    ]
}
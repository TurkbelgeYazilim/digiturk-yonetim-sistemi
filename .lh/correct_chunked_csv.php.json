{
    "sourceFile": "correct_chunked_csv.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1760454892763,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1760458018118,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,346 @@\n+<?php\r\n+header('Content-Type: application/json');\r\n+\r\n+// Veritabanı bağlantısı için config dosyasını dahil et\r\n+$config = include 'config/mssql.php';\r\n+\r\n+try {\r\n+    $action = $_GET['action'] ?? '';\r\n+    $filename = $_GET['file'] ?? '';\r\n+    \r\n+    if (empty($filename)) {\r\n+        throw new Exception('Dosya adı belirtilmedi');\r\n+    }\r\n+    \r\n+    $uploadDir = 'uploads/';\r\n+    $filePath = $uploadDir . $filename;\r\n+    \r\n+    // Dosya varlığını kontrol et\r\n+    if (!file_exists($filePath)) {\r\n+        throw new Exception('Dosya bulunamadı: ' . $filename);\r\n+    }\r\n+    \r\n+    if ($action === 'info') {\r\n+        // Dosya bilgilerini döndür\r\n+        $fileSize = filesize($filePath);\r\n+        \r\n+        // Toplam satır sayısını hesapla\r\n+        $handle = fopen($filePath, 'r');\r\n+        if (!$handle) {\r\n+            throw new Exception('Dosya açılamadı');\r\n+        }\r\n+        \r\n+        $lineCount = 0;\r\n+        while (fgets($handle) !== false) {\r\n+            $lineCount++;\r\n+        }\r\n+        fclose($handle);\r\n+        \r\n+        // İlk satır başlık olduğu için veri satır sayısı\r\n+        $dataLines = $lineCount - 1;\r\n+        \r\n+        // Önerilen chunk boyutu (dosya boyutuna göre)\r\n+        $recommendedChunkSize = 25;\r\n+        if ($fileSize < 1024 * 1024) { // 1MB'den küçükse\r\n+            $recommendedChunkSize = 50;\r\n+        } elseif ($fileSize > 10 * 1024 * 1024) { // 10MB'den büyükse\r\n+            $recommendedChunkSize = 10;\r\n+        }\r\n+        \r\n+        echo json_encode([\r\n+            'success' => true,\r\n+            'file' => $filename,\r\n+            'file_size' => $fileSize,\r\n+            'total_lines' => $dataLines,\r\n+            'total_rows' => $dataLines,\r\n+            'recommended_chunk_size' => $recommendedChunkSize,\r\n+            'chunk_size' => $recommendedChunkSize\r\n+        ]);\r\n+        \r\n+    } elseif ($action === 'process') {\r\n+        // CSV işleme\r\n+        $offset = intval($_GET['offset'] ?? 0);\r\n+        $chunkSize = intval($_GET['chunk_size'] ?? 25);\r\n+        \r\n+        // Veritabanı bağlantısı\r\n+        $connectionString = \"sqlsrv:Server={$config['host']};Database={$config['database']}\";\r\n+        $pdo = new PDO($connectionString, $config['username'], $config['password']);\r\n+        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\r\n+        \r\n+        $handle = fopen($filePath, 'r');\r\n+        if (!$handle) {\r\n+            throw new Exception('Dosya açılamadı');\r\n+        }\r\n+        \r\n+        // İlk satırı atla (başlıklar)\r\n+        $headers = fgets($handle);\r\n+        \r\n+        // Offset pozisyonuna git\r\n+        $currentLine = 0;\r\n+        while ($currentLine < $offset && fgets($handle) !== false) {\r\n+            $currentLine++;\r\n+        }\r\n+        \r\n+        $processed = 0;\r\n+        $updated = 0;\r\n+        $inserted = 0;\r\n+        $errors = [];\r\n+        $debugInfo = [];\r\n+        \r\n+        // Chunk kadar satır işle\r\n+        while ($processed < $chunkSize && ($line = fgets($handle)) !== false) {\r\n+            try {\r\n+                $data = array_map('trim', explode(';', trim($line)));\r\n+                \r\n+                // Boş satırları atla\r\n+                if (empty(trim($line)) || count($data) < 5) {\r\n+                    $processed++;\r\n+                    continue;\r\n+                }\r\n+                \r\n+                // Tüm veriyi temizle ve validate et\r\n+                for ($i = 0; $i < count($data); $i++) {\r\n+                    $data[$i] = trim($data[$i]);\r\n+                    if ($data[$i] === '' || $data[$i] === 'null' || $data[$i] === 'NULL') {\r\n+                        $data[$i] = null;\r\n+                    }\r\n+                }\r\n+                \r\n+                // MEMO_ID kontrolü (unique key) - null veya boş değerler için kontrol\r\n+                $memoIdRaw = isset($data[5]) ? $data[5] : null;\r\n+                $memoId = null;\r\n+                \r\n+                if ($memoIdRaw !== null && $memoIdRaw !== '') {\r\n+                    // Sadece numeric karakterleri kontrol et\r\n+                    if (is_numeric($memoIdRaw) && $memoIdRaw > 0) {\r\n+                        $memoId = intval($memoIdRaw);\r\n+                    } else {\r\n+                        $errors[] = \"Satır \" . ($offset + $processed + 1) . \": Geçersiz MEMO_ID değeri: '\" . $memoIdRaw . \"'\";\r\n+                        $processed++;\r\n+                        continue;\r\n+                    }\r\n+                } else {\r\n+                    $errors[] = \"Satır \" . ($offset + $processed + 1) . \": MEMO_ID boş olamaz\";\r\n+                    $processed++;\r\n+                    continue;\r\n+                }\r\n+                \r\n+                if ($memoId) {\r\n+                    // Tarih alanlarını özel olarak işle (indeks değerleri CSV sırasına göre)\r\n+                    $dateFields = [\r\n+                        10 => 'MEMO_KAPANIS_TARIHI',    // CSV'de 11. sütun (index 10)\r\n+                        16 => 'TALEP_GIRIS_TARIHI',     // CSV'de 17. sütun (index 16) \r\n+                        35 => 'RANDEVU_TARIHI'          // CSV'de 36. sütun (index 35)\r\n+                    ];\r\n+                    \r\n+                    foreach ($dateFields as $dateIndex => $fieldName) {\r\n+                        if (isset($data[$dateIndex]) && $data[$dateIndex] !== null) {\r\n+                            $dateValue = trim($data[$dateIndex]);\r\n+                            if (!empty($dateValue)) {\r\n+                                // Türkçe tarih formatlarını kontrol et\r\n+                                $dateValue = str_replace('.', '-', $dateValue); // 01.01.2024 -> 01-01-2024\r\n+                                $timestamp = strtotime($dateValue);\r\n+                                if ($timestamp === false) {\r\n+                                    // Geçersiz tarih formatı - null yap\r\n+                                    $data[$dateIndex] = null;\r\n+                                    $debugInfo[] = \"Tarih dönüştürme hatası: $fieldName = '$dateValue'\";\r\n+                                } else {\r\n+                                    // Geçerli tarih - MSSQL formatına dönüştür\r\n+                                    $data[$dateIndex] = date('Y-m-d H:i:s', $timestamp);\r\n+                                }\r\n+                            } else {\r\n+                                $data[$dateIndex] = null;\r\n+                            }\r\n+                        }\r\n+                    }\r\n+                    \r\n+                    // Mevcut kaydı kontrol et\r\n+                    $checkSql = \"SELECT COUNT(*) FROM [digiturk].[iris_rapor] WHERE [MEMO_ID] = ?\";\r\n+                    $checkStmt = $pdo->prepare($checkSql);\r\n+                    $checkStmt->execute([$memoId]);\r\n+                    $exists = $checkStmt->fetchColumn() > 0;\r\n+                    \r\n+                    if ($exists) {\r\n+                        // Güncelleme - MEMO_ID hariç tüm alanları güncelle\r\n+                        $updateSql = \"UPDATE [digiturk].[iris_rapor] SET \r\n+                            [TALEP_ID] = ?, [TALEP_TURU] = ?, [UYDU_BASVURU_POTANSIYEL_NO] = ?, \r\n+                            [UYDU_BASVURU_UYE_NO] = ?, [DT_MUSTERI_NO] = ?, [MEMO_KAYIT_TIPI] = ?, \r\n+                            [MEMO_ID_TIP] = ?, [MEMO_KODU] = ?, [MEMO_KAPANIS_TARIHI] = ?, \r\n+                            [MEMO_YONLENEN_BAYI_KODU] = ?, [MEMO_YONLENEN_BAYI_ADI] = ?, \r\n+                            [MEMO_YONLENEN_BAYI_YONETICISI] = ?, [MEMO_YONLENEN_BAYI_BOLGE] = ?, \r\n+                            [MEMO_YONLENEN_BAYI_TEKNIK_YNTC] = ?, [TALEP_GIRIS_TARIHI] = ?, \r\n+                            [TALEBI_GIREN_BAYI_KODU] = ?, [TALEBI_GIREN_BAYI_ADI] = ?, \r\n+                            [TALEBI_GIREN_PERSONEL] = ?, [TALEBI_GIREN_PERSONELNO] = ?, \r\n+                            [TALEBI_GIREN_PERSONELKODU] = ?, [TALEBI_GIREN_PERSONEL_ALTBAYI] = ?, \r\n+                            [TALEP_KAYNAK] = ?, [SATIS_DURUMU] = ?, [INTERNET_SUREC_DURUMU] = ?, \r\n+                            [AKTIVE_EDILEN_UYENO] = ?, [AKTIVE_EDILEN_OUTLETNO] = ?, \r\n+                            [AKTIVE_EDILEN_SOZLESMENO] = ?, [AKTIVE_EDILEN_SOZLESMEKMP] = ?, \r\n+                            [AKTIVE_EDILEN_SOZLESMEDURUM] = ?, [TALEP_TAKIP_NOTU] = ?, \r\n+                            [GUNCEL_OUTLET_DURUM] = ?, [TEYIT_DURUM] = ?, [TEYIT_ARAMA_DURUM] = ?, \r\n+                            [RANDEVU_TARIHI] = ?, [MEMO_SON_DURUM] = ?, [MEMO_SON_CEVAP] = ?, \r\n+                            [MEMO_SON_ACIKLAMA] = ?, [guncellenme_tarihi] = GETDATE(), [dosya_adi] = ? \r\n+                            WHERE [MEMO_ID] = ?\";\r\n+                        \r\n+                        $updateStmt = $pdo->prepare($updateSql);\r\n+                        \r\n+                        // Parametreleri doğru sırada hazırla (CSV sütun sırasına göre, MEMO_ID hariç)\r\n+                        $updateParams = [\r\n+                            $data[0],  // TALEP_ID\r\n+                            $data[1],  // TALEP_TURU\r\n+                            $data[2],  // UYDU_BASVURU_POTANSIYEL_NO\r\n+                            $data[3],  // UYDU_BASVURU_UYE_NO\r\n+                            $data[4],  // DT_MUSTERI_NO\r\n+                            $data[6],  // MEMO_KAYIT_TIPI (MEMO_ID atlandı)\r\n+                            $data[7],  // MEMO_ID_TIP\r\n+                            $data[8],  // MEMO_KODU\r\n+                            $data[10], // MEMO_KAPANIS_TARIHI\r\n+                            $data[11], // MEMO_YONLENEN_BAYI_KODU\r\n+                            $data[12], // MEMO_YONLENEN_BAYI_ADI\r\n+                            $data[13], // MEMO_YONLENEN_BAYI_YONETICISI\r\n+                            $data[14], // MEMO_YONLENEN_BAYI_BOLGE\r\n+                            $data[15], // MEMO_YONLENEN_BAYI_TEKNIK_YNTC\r\n+                            $data[16], // TALEP_GIRIS_TARIHI\r\n+                            $data[17], // TALEBI_GIREN_BAYI_KODU\r\n+                            $data[18], // TALEBI_GIREN_BAYI_ADI\r\n+                            $data[19], // TALEBI_GIREN_PERSONEL\r\n+                            $data[20], // TALEBI_GIREN_PERSONELNO\r\n+                            $data[21], // TALEBI_GIREN_PERSONELKODU\r\n+                            $data[22], // TALEBI_GIREN_PERSONEL_ALTBAYI\r\n+                            $data[23], // TALEP_KAYNAK\r\n+                            $data[24], // SATIS_DURUMU\r\n+                            $data[25], // INTERNET_SUREC_DURUMU\r\n+                            $data[26], // AKTIVE_EDILEN_UYENO\r\n+                            $data[27], // AKTIVE_EDILEN_OUTLETNO\r\n+                            $data[28], // AKTIVE_EDILEN_SOZLESMENO\r\n+                            $data[29], // AKTIVE_EDILEN_SOZLESMEKMP\r\n+                            $data[30], // AKTIVE_EDILEN_SOZLESMEDURUM\r\n+                            $data[31], // TALEP_TAKIP_NOTU\r\n+                            $data[32], // GUNCEL_OUTLET_DURUM\r\n+                            $data[33], // TEYIT_DURUM\r\n+                            $data[34], // TEYIT_ARAMA_DURUM\r\n+                            $data[35], // RANDEVU_TARIHI\r\n+                            $data[36], // MEMO_SON_DURUM\r\n+                            $data[37], // MEMO_SON_CEVAP\r\n+                            $data[38], // MEMO_SON_ACIKLAMA\r\n+                            $filename, // dosya_adi\r\n+                            $memoId    // WHERE MEMO_ID\r\n+                        ];\r\n+                        \r\n+                        $updateStmt->execute($updateParams);\r\n+                        $updated++;\r\n+                    } else {\r\n+                        // Ekleme - id alanı IDENTITY olduğu için dahil edilmez\r\n+                        $insertSql = \"INSERT INTO [digiturk].[iris_rapor] (\r\n+                            [TALEP_ID], [TALEP_TURU], [UYDU_BASVURU_POTANSIYEL_NO], \r\n+                            [UYDU_BASVURU_UYE_NO], [DT_MUSTERI_NO], [MEMO_ID], [MEMO_KAYIT_TIPI], \r\n+                            [MEMO_ID_TIP], [MEMO_KODU], [MEMO_KAPANIS_TARIHI], \r\n+                            [MEMO_YONLENEN_BAYI_KODU], [MEMO_YONLENEN_BAYI_ADI], \r\n+                            [MEMO_YONLENEN_BAYI_YONETICISI], [MEMO_YONLENEN_BAYI_BOLGE], \r\n+                            [MEMO_YONLENEN_BAYI_TEKNIK_YNTC], [TALEP_GIRIS_TARIHI], \r\n+                            [TALEBI_GIREN_BAYI_KODU], [TALEBI_GIREN_BAYI_ADI], \r\n+                            [TALEBI_GIREN_PERSONEL], [TALEBI_GIREN_PERSONELNO], \r\n+                            [TALEBI_GIREN_PERSONELKODU], [TALEBI_GIREN_PERSONEL_ALTBAYI], \r\n+                            [TALEP_KAYNAK], [SATIS_DURUMU], [INTERNET_SUREC_DURUMU], \r\n+                            [AKTIVE_EDILEN_UYENO], [AKTIVE_EDILEN_OUTLETNO], \r\n+                            [AKTIVE_EDILEN_SOZLESMENO], [AKTIVE_EDILEN_SOZLESMEKMP], \r\n+                            [AKTIVE_EDILEN_SOZLESMEDURUM], [TALEP_TAKIP_NOTU], \r\n+                            [GUNCEL_OUTLET_DURUM], [TEYIT_DURUM], [TEYIT_ARAMA_DURUM], \r\n+                            [RANDEVU_TARIHI], [MEMO_SON_DURUM], [MEMO_SON_CEVAP], \r\n+                            [MEMO_SON_ACIKLAMA], [eklenme_tarihi], [dosya_adi]\r\n+                        ) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,GETDATE(),?)\";\r\n+                        \r\n+                        $insertStmt = $pdo->prepare($insertSql);\r\n+                        \r\n+                        // Parametreleri doğru sırada hazırla\r\n+                        $insertParams = [\r\n+                            $data[0],  // TALEP_ID\r\n+                            $data[1],  // TALEP_TURU\r\n+                            $data[2],  // UYDU_BASVURU_POTANSIYEL_NO\r\n+                            $data[3],  // UYDU_BASVURU_UYE_NO\r\n+                            $data[4],  // DT_MUSTERI_NO\r\n+                            $memoId,   // MEMO_ID\r\n+                            $data[6],  // MEMO_KAYIT_TIPI\r\n+                            $data[7],  // MEMO_ID_TIP\r\n+                            $data[8],  // MEMO_KODU\r\n+                            $data[10], // MEMO_KAPANIS_TARIHI\r\n+                            $data[11], // MEMO_YONLENEN_BAYI_KODU\r\n+                            $data[12], // MEMO_YONLENEN_BAYI_ADI\r\n+                            $data[13], // MEMO_YONLENEN_BAYI_YONETICISI\r\n+                            $data[14], // MEMO_YONLENEN_BAYI_BOLGE\r\n+                            $data[15], // MEMO_YONLENEN_BAYI_TEKNIK_YNTC\r\n+                            $data[16], // TALEP_GIRIS_TARIHI\r\n+                            $data[17], // TALEBI_GIREN_BAYI_KODU\r\n+                            $data[18], // TALEBI_GIREN_BAYI_ADI\r\n+                            $data[19], // TALEBI_GIREN_PERSONEL\r\n+                            $data[20], // TALEBI_GIREN_PERSONELNO\r\n+                            $data[21], // TALEBI_GIREN_PERSONELKODU\r\n+                            $data[22], // TALEBI_GIREN_PERSONEL_ALTBAYI\r\n+                            $data[23], // TALEP_KAYNAK\r\n+                            $data[24], // SATIS_DURUMU\r\n+                            $data[25], // INTERNET_SUREC_DURUMU\r\n+                            $data[26], // AKTIVE_EDILEN_UYENO\r\n+                            $data[27], // AKTIVE_EDILEN_OUTLETNO\r\n+                            $data[28], // AKTIVE_EDILEN_SOZLESMENO\r\n+                            $data[29], // AKTIVE_EDILEN_SOZLESMEKMP\r\n+                            $data[30], // AKTIVE_EDILEN_SOZLESMEDURUM\r\n+                            $data[31], // TALEP_TAKIP_NOTU\r\n+                            $data[32], // GUNCEL_OUTLET_DURUM\r\n+                            $data[33], // TEYIT_DURUM\r\n+                            $data[34], // TEYIT_ARAMA_DURUM\r\n+                            $data[35], // RANDEVU_TARIHI\r\n+                            $data[36], // MEMO_SON_DURUM\r\n+                            $data[37], // MEMO_SON_CEVAP\r\n+                            $data[38], // MEMO_SON_ACIKLAMA\r\n+                            $filename  // dosya_adi\r\n+                        ];\r\n+                        \r\n+                        $insertStmt->execute($insertParams);\r\n+                        $inserted++;\r\n+                    }\r\n+                }\r\n+                \r\n+            } catch (Exception $e) {\r\n+                $errors[] = \"Satır \" . ($offset + $processed + 1) . \": \" . $e->getMessage();\r\n+                $debugInfo[] = \"Hata detayı: \" . $e->getFile() . \":\" . $e->getLine() . \" - \" . $e->getMessage();\r\n+                if (isset($memoId)) {\r\n+                    $debugInfo[] = \"MEMO_ID: \" . $memoId;\r\n+                }\r\n+            }\r\n+            \r\n+            $processed++;\r\n+        }\r\n+        \r\n+        $nextOffset = $offset + $processed;\r\n+        $hasMore = !feof($handle);\r\n+        \r\n+        fclose($handle);\r\n+        \r\n+        echo json_encode([\r\n+            'success' => true,\r\n+            'processed' => $processed,\r\n+            'updated' => $updated,\r\n+            'inserted' => $inserted,\r\n+            'errors' => $errors,\r\n+            'next_offset' => $nextOffset,\r\n+            'has_more' => $hasMore,\r\n+            'debug_info' => $debugInfo\r\n+        ]);\r\n+        \r\n+    } else {\r\n+        throw new Exception('Geçersiz action parametresi');\r\n+    }\r\n+    \r\n+} catch (Exception $e) {\r\n+    http_response_code(500);\r\n+    echo json_encode([\r\n+        'success' => false,\r\n+        'message' => $e->getMessage(),\r\n+        'processed' => 0,\r\n+        'updated' => 0,\r\n+        'inserted' => 0,\r\n+        'errors' => [$e->getMessage()],\r\n+        'next_offset' => 0,\r\n+        'has_more' => false\r\n+    ]);\r\n+}\r\n+?>\n\\ No newline at end of file\n"
                },
                {
                    "date": 1760458410932,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -105,28 +105,44 @@\n                         $data[$i] = null;\r\n                     }\r\n                 }\r\n                 \r\n-                // MEMO_ID kontrolü (unique key) - null veya boş değerler için kontrol\r\n+                // MEMO_ID kontrolü - boş olabilir, numeric olmayan değerleri null yap\r\n                 $memoIdRaw = isset($data[5]) ? $data[5] : null;\r\n                 $memoId = null;\r\n                 \r\n                 if ($memoIdRaw !== null && $memoIdRaw !== '') {\r\n-                    // Sadece numeric karakterleri kontrol et\r\n+                    // Sadece numeric değerleri kabul et, diğerlerini null yap\r\n                     if (is_numeric($memoIdRaw) && $memoIdRaw > 0) {\r\n                         $memoId = intval($memoIdRaw);\r\n                     } else {\r\n-                        $errors[] = \"Satır \" . ($offset + $processed + 1) . \": Geçersiz MEMO_ID değeri: '\" . $memoIdRaw . \"'\";\r\n-                        $processed++;\r\n-                        continue;\r\n+                        // İptal, Tamamlandı gibi metinler için MEMO_ID'yi null yap ve devam et\r\n+                        $memoId = null;\r\n+                        $debugInfo[] = \"Satır \" . ($offset + $processed + 1) . \": MEMO_ID non-numeric değer: '\" . $memoIdRaw . \"' - null olarak işleniyor\";\r\n                     }\r\n-                } else {\r\n-                    $errors[] = \"Satır \" . ($offset + $processed + 1) . \": MEMO_ID boş olamaz\";\r\n-                    $processed++;\r\n-                    continue;\r\n                 }\r\n+                // MEMO_ID null olabilir, bu durumda normal işleme devam et\r\n                 \r\n-                if ($memoId) {\r\n+                // Uzun metinleri kes (SQL sütun boyutlarına göre)\r\n+                $fieldLimits = [\r\n+                    29 => 100, // AKTIVE_EDILEN_SOZLESMEKMP\r\n+                    30 => 100, // AKTIVE_EDILEN_SOZLESMEDURUM\r\n+                    31 => 1000, // TALEP_TAKIP_NOTU\r\n+                    37 => 500,  // MEMO_SON_CEVAP\r\n+                    38 => 1000  // MEMO_SON_ACIKLAMA\r\n+                ];\r\n+                \r\n+                foreach ($fieldLimits as $fieldIndex => $maxLength) {\r\n+                    if (isset($data[$fieldIndex]) && $data[$fieldIndex] !== null) {\r\n+                        if (strlen($data[$fieldIndex]) > $maxLength) {\r\n+                            $originalLength = strlen($data[$fieldIndex]);\r\n+                            $data[$fieldIndex] = substr($data[$fieldIndex], 0, $maxLength);\r\n+                            $debugInfo[] = \"Satır \" . ($offset + $processed + 1) . \": Sütun $fieldIndex kesildi ($originalLength -> $maxLength karakter)\";\r\n+                        }\r\n+                    }\r\n+                }\r\n+                \r\n+                if (true) { // Her durumda işleme devam et\r\n                     // Tarih alanlarını özel olarak işle (indeks değerleri CSV sırasına göre)\r\n                     $dateFields = [\r\n                         10 => 'MEMO_KAPANIS_TARIHI',    // CSV'de 11. sütun (index 10)\r\n                         16 => 'TALEP_GIRIS_TARIHI',     // CSV'de 17. sütun (index 16) \r\n@@ -153,13 +169,19 @@\n                             }\r\n                         }\r\n                     }\r\n                     \r\n-                    // Mevcut kaydı kontrol et\r\n-                    $checkSql = \"SELECT COUNT(*) FROM [digiturk].[iris_rapor] WHERE [MEMO_ID] = ?\";\r\n-                    $checkStmt = $pdo->prepare($checkSql);\r\n-                    $checkStmt->execute([$memoId]);\r\n-                    $exists = $checkStmt->fetchColumn() > 0;\r\n+                    // Mevcut kaydı kontrol et (MEMO_ID varsa)\r\n+                    $exists = false;\r\n+                    if ($memoId !== null) {\r\n+                        $checkSql = \"SELECT COUNT(*) FROM [digiturk].[iris_rapor] WHERE [MEMO_ID] = ?\";\r\n+                        $checkStmt = $pdo->prepare($checkSql);\r\n+                        $checkStmt->execute([$memoId]);\r\n+                        $exists = $checkStmt->fetchColumn() > 0;\r\n+                    } else {\r\n+                        // MEMO_ID null ise her zaman yeni kayıt ekle (unique constraint problemi olmasın)\r\n+                        $exists = false;\r\n+                    }\r\n                     \r\n                     if ($exists) {\r\n                         // Güncelleme - MEMO_ID hariç tüm alanları güncelle\r\n                         $updateSql = \"UPDATE [digiturk].[iris_rapor] SET \r\n@@ -257,9 +279,9 @@\n                             $data[1],  // TALEP_TURU\r\n                             $data[2],  // UYDU_BASVURU_POTANSIYEL_NO\r\n                             $data[3],  // UYDU_BASVURU_UYE_NO\r\n                             $data[4],  // DT_MUSTERI_NO\r\n-                            $memoId,   // MEMO_ID\r\n+                            $memoId,   // MEMO_ID (null olabilir)\r\n                             $data[6],  // MEMO_KAYIT_TIPI\r\n                             $data[7],  // MEMO_ID_TIP\r\n                             $data[8],  // MEMO_KODU\r\n                             $data[10], // MEMO_KAPANIS_TARIHI\r\n@@ -342,214 +364,5 @@\n         'next_offset' => 0,\r\n         'has_more' => false\r\n     ]);\r\n }\r\n-?>\n-<?php\r\n-header('Content-Type: application/json');\r\n-\r\n-// Veritabanı bağlantısı için config dosyasını dahil et\r\n-$config = include 'config/mssql.php';\r\n-\r\n-try {\r\n-    $action = $_GET['action'] ?? '';\r\n-    $filename = $_GET['file'] ?? '';\r\n-    \r\n-    if (empty($filename)) {\r\n-        throw new Exception('Dosya adı belirtilmedi');\r\n-    }\r\n-    \r\n-    $uploadDir = 'uploads/';\r\n-    $filePath = $uploadDir . $filename;\r\n-    \r\n-    // Dosya varlığını kontrol et\r\n-    if (!file_exists($filePath)) {\r\n-        throw new Exception('Dosya bulunamadı: ' . $filename);\r\n-    }\r\n-    \r\n-    if ($action === 'info') {\r\n-        // Dosya bilgilerini döndür\r\n-        $fileSize = filesize($filePath);\r\n-        \r\n-        // Toplam satır sayısını hesapla\r\n-        $handle = fopen($filePath, 'r');\r\n-        if (!$handle) {\r\n-            throw new Exception('Dosya açılamadı');\r\n-        }\r\n-        \r\n-        $lineCount = 0;\r\n-        while (fgets($handle) !== false) {\r\n-            $lineCount++;\r\n-        }\r\n-        fclose($handle);\r\n-        \r\n-        // İlk satır başlık olduğu için veri satır sayısı\r\n-        $dataLines = $lineCount - 1;\r\n-        \r\n-        // Önerilen chunk boyutu (dosya boyutuna göre)\r\n-        $recommendedChunkSize = 25;\r\n-        if ($fileSize < 1024 * 1024) { // 1MB'den küçükse\r\n-            $recommendedChunkSize = 50;\r\n-        } elseif ($fileSize > 10 * 1024 * 1024) { // 10MB'den büyükse\r\n-            $recommendedChunkSize = 10;\r\n-        }\r\n-        \r\n-        echo json_encode([\r\n-            'success' => true,\r\n-            'file' => $filename,\r\n-            'file_size' => $fileSize,\r\n-            'total_lines' => $dataLines,\r\n-            'total_rows' => $dataLines,\r\n-            'recommended_chunk_size' => $recommendedChunkSize,\r\n-            'chunk_size' => $recommendedChunkSize\r\n-        ]);\r\n-        \r\n-    } elseif ($action === 'process') {\r\n-        // CSV işleme\r\n-        $offset = intval($_GET['offset'] ?? 0);\r\n-        $chunkSize = intval($_GET['chunk_size'] ?? 25);\r\n-        \r\n-        // Veritabanı bağlantısı\r\n-        $connectionString = \"sqlsrv:Server={$config['host']};Database={$config['database']}\";\r\n-        $pdo = new PDO($connectionString, $config['username'], $config['password']);\r\n-        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\r\n-        \r\n-        $handle = fopen($filePath, 'r');\r\n-        if (!$handle) {\r\n-            throw new Exception('Dosya açılamadı');\r\n-        }\r\n-        \r\n-        // İlk satırı atla (başlıklar)\r\n-        $headers = fgets($handle);\r\n-        \r\n-        // Offset pozisyonuna git\r\n-        $currentLine = 0;\r\n-        while ($currentLine < $offset && fgets($handle) !== false) {\r\n-            $currentLine++;\r\n-        }\r\n-        \r\n-        $processed = 0;\r\n-        $updated = 0;\r\n-        $inserted = 0;\r\n-        $errors = [];\r\n-        $debugInfo = [];\r\n-        \r\n-        // Chunk kadar satır işle\r\n-        while ($processed < $chunkSize && ($line = fgets($handle)) !== false) {\r\n-            try {\r\n-                $data = array_map('trim', explode(';', trim($line)));\r\n-                \r\n-                // Boş satırları atla\r\n-                if (empty(trim($line)) || count($data) < 5) {\r\n-                    $processed++;\r\n-                    continue;\r\n-                }\r\n-                \r\n-                // MEMO_ID kontrolü (unique key)\r\n-                $memoId = !empty($data[5]) ? intval($data[5]) : null;\r\n-                \r\n-                if ($memoId) {\r\n-                    // Mevcut kaydı kontrol et\r\n-                    $checkSql = \"SELECT COUNT(*) FROM [digiturk].[iris_rapor] WHERE [MEMO_ID] = ?\";\r\n-                    $checkStmt = $pdo->prepare($checkSql);\r\n-                    $checkStmt->execute([$memoId]);\r\n-                    $exists = $checkStmt->fetchColumn() > 0;\r\n-                    \r\n-                    if ($exists) {\r\n-                        // Güncelleme\r\n-                        $updateSql = \"UPDATE [digiturk].[iris_rapor] SET \r\n-                            [TALEP_ID] = ?, [TALEP_TURU] = ?, [UYDU_BASVURU_POTANSIYEL_NO] = ?, \r\n-                            [UYDU_BASVURU_UYE_NO] = ?, [DT_MUSTERI_NO] = ?, [MEMO_KAYIT_TIPI] = ?, \r\n-                            [MEMO_ID_TIP] = ?, [MEMO_KODU] = ?, [MEMO_KAPANIS_TARIHI] = ?, \r\n-                            [MEMO_YONLENEN_BAYI_KODU] = ?, [MEMO_YONLENEN_BAYI_ADI] = ?, \r\n-                            [MEMO_YONLENEN_BAYI_YONETICISI] = ?, [MEMO_YONLENEN_BAYI_BOLGE] = ?, \r\n-                            [MEMO_YONLENEN_BAYI_TEKNIK_YNTC] = ?, [TALEP_GIRIS_TARIHI] = ?, \r\n-                            [TALEBI_GIREN_BAYI_KODU] = ?, [TALEBI_GIREN_BAYI_ADI] = ?, \r\n-                            [TALEBI_GIREN_PERSONEL] = ?, [TALEBI_GIREN_PERSONELNO] = ?, \r\n-                            [TALEBI_GIREN_PERSONELKODU] = ?, [TALEBI_GIREN_PERSONEL_ALTBAYI] = ?, \r\n-                            [TALEP_KAYNAK] = ?, [SATIS_DURUMU] = ?, [INTERNET_SUREC_DURUMU] = ?, \r\n-                            [AKTIVE_EDILEN_UYENO] = ?, [AKTIVE_EDILEN_OUTLETNO] = ?, \r\n-                            [AKTIVE_EDILEN_SOZLESMENO] = ?, [AKTIVE_EDILEN_SOZLESMEKMP] = ?, \r\n-                            [AKTIVE_EDILEN_SOZLESMEDURUM] = ?, [TALEP_TAKIP_NOTU] = ?, \r\n-                            [GUNCEL_OUTLET_DURUM] = ?, [TEYIT_DURUM] = ?, [TEYIT_ARAMA_DURUM] = ?, \r\n-                            [RANDEVU_TARIHI] = ?, [MEMO_SON_DURUM] = ?, [MEMO_SON_CEVAP] = ?, \r\n-                            [MEMO_SON_ACIKLAMA] = ?, [guncellenme_tarihi] = GETDATE(), [dosya_adi] = ? \r\n-                            WHERE [MEMO_ID] = ?\";\r\n-                        \r\n-                        $updateStmt = $pdo->prepare($updateSql);\r\n-                        $params = array_slice($data, 0, 38); // İlk 38 sütun\r\n-                        $params[] = $filename; // dosya_adi\r\n-                        $params[] = $memoId; // WHERE şartı\r\n-                        \r\n-                        $updateStmt->execute($params);\r\n-                        $updated++;\r\n-                    } else {\r\n-                        // Ekleme\r\n-                        $insertSql = \"INSERT INTO [digiturk].[iris_rapor] (\r\n-                            [TALEP_ID], [TALEP_TURU], [UYDU_BASVURU_POTANSIYEL_NO], \r\n-                            [UYDU_BASVURU_UYE_NO], [DT_MUSTERI_NO], [MEMO_ID], [MEMO_KAYIT_TIPI], \r\n-                            [MEMO_ID_TIP], [MEMO_KODU], [MEMO_KAPANIS_TARIHI], \r\n-                            [MEMO_YONLENEN_BAYI_KODU], [MEMO_YONLENEN_BAYI_ADI], \r\n-                            [MEMO_YONLENEN_BAYI_YONETICISI], [MEMO_YONLENEN_BAYI_BOLGE], \r\n-                            [MEMO_YONLENEN_BAYI_TEKNIK_YNTC], [TALEP_GIRIS_TARIHI], \r\n-                            [TALEBI_GIREN_BAYI_KODU], [TALEBI_GIREN_BAYI_ADI], \r\n-                            [TALEBI_GIREN_PERSONEL], [TALEBI_GIREN_PERSONELNO], \r\n-                            [TALEBI_GIREN_PERSONELKODU], [TALEBI_GIREN_PERSONEL_ALTBAYI], \r\n-                            [TALEP_KAYNAK], [SATIS_DURUMU], [INTERNET_SUREC_DURUMU], \r\n-                            [AKTIVE_EDILEN_UYENO], [AKTIVE_EDILEN_OUTLETNO], \r\n-                            [AKTIVE_EDILEN_SOZLESMENO], [AKTIVE_EDILEN_SOZLESMEKMP], \r\n-                            [AKTIVE_EDILEN_SOZLESMEDURUM], [TALEP_TAKIP_NOTU], \r\n-                            [GUNCEL_OUTLET_DURUM], [TEYIT_DURUM], [TEYIT_ARAMA_DURUM], \r\n-                            [RANDEVU_TARIHI], [MEMO_SON_DURUM], [MEMO_SON_CEVAP], \r\n-                            [MEMO_SON_ACIKLAMA], [eklenme_tarihi], [dosya_adi]\r\n-                        ) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,GETDATE(),?)\";\r\n-                        \r\n-                        $insertStmt = $pdo->prepare($insertSql);\r\n-                        $params = array_slice($data, 0, 38); // İlk 38 sütun\r\n-                        $params[] = $filename; // dosya_adi\r\n-                        \r\n-                        $insertStmt->execute($params);\r\n-                        $inserted++;\r\n-                    }\r\n-                }\r\n-                \r\n-            } catch (Exception $e) {\r\n-                $errors[] = \"Satır \" . ($offset + $processed + 1) . \": \" . $e->getMessage();\r\n-            }\r\n-            \r\n-            $processed++;\r\n-        }\r\n-        \r\n-        $nextOffset = $offset + $processed;\r\n-        $hasMore = !feof($handle);\r\n-        \r\n-        fclose($handle);\r\n-        \r\n-        echo json_encode([\r\n-            'success' => true,\r\n-            'processed' => $processed,\r\n-            'updated' => $updated,\r\n-            'inserted' => $inserted,\r\n-            'errors' => $errors,\r\n-            'next_offset' => $nextOffset,\r\n-            'has_more' => $hasMore,\r\n-            'debug_info' => $debugInfo\r\n-        ]);\r\n-        \r\n-    } else {\r\n-        throw new Exception('Geçersiz action parametresi');\r\n-    }\r\n-    \r\n-} catch (Exception $e) {\r\n-    http_response_code(500);\r\n-    echo json_encode([\r\n-        'success' => false,\r\n-        'message' => $e->getMessage(),\r\n-        'processed' => 0,\r\n-        'updated' => 0,\r\n-        'inserted' => 0,\r\n-        'errors' => [$e->getMessage()],\r\n-        'next_offset' => 0,\r\n-        'has_more' => false\r\n-    ]);\r\n-}\r\n ?>\n\\ No newline at end of file\n"
                },
                {
                    "date": 1760509131211,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -83,8 +83,9 @@\n         \r\n         $processed = 0;\r\n         $updated = 0;\r\n         $inserted = 0;\r\n+        $skipped = 0;\r\n         $errors = [];\r\n         $debugInfo = [];\r\n         \r\n         // Chunk kadar satır işle\r\n@@ -114,14 +115,21 @@\n                     // Sadece numeric değerleri kabul et, diğerlerini null yap\r\n                     if (is_numeric($memoIdRaw) && $memoIdRaw > 0) {\r\n                         $memoId = intval($memoIdRaw);\r\n                     } else {\r\n-                        // İptal, Tamamlandı gibi metinler için MEMO_ID'yi null yap ve devam et\r\n-                        $memoId = null;\r\n-                        $debugInfo[] = \"Satır \" . ($offset + $processed + 1) . \": MEMO_ID non-numeric değer: '\" . $memoIdRaw . \"' - null olarak işleniyor\";\r\n+                        // İptal, Tamamlandı gibi metinler için bu satırı atla\r\n+                        $debugInfo[] = \"Satır \" . ($offset + $processed + 1) . \": MEMO_ID non-numeric değer: '\" . $memoIdRaw . \"' - satır atlandı\";\r\n+                        $processed++;\r\n+                        $skipped++;\r\n+                        continue;\r\n                     }\r\n+                } else {\r\n+                    // MEMO_ID boş ise bu satırı atla (unique constraint problemini önlemek için)\r\n+                    $debugInfo[] = \"Satır \" . ($offset + $processed + 1) . \": MEMO_ID boş - satır atlandı\";\r\n+                    $processed++;\r\n+                    $skipped++;\r\n+                    continue;\r\n                 }\r\n-                // MEMO_ID null olabilir, bu durumda normal işleme devam et\r\n                 \r\n                 // Uzun metinleri kes (SQL sütun boyutlarına göre)\r\n                 $fieldLimits = [\r\n                     29 => 100, // AKTIVE_EDILEN_SOZLESMEKMP\r\n@@ -169,19 +177,13 @@\n                             }\r\n                         }\r\n                     }\r\n                     \r\n-                    // Mevcut kaydı kontrol et (MEMO_ID varsa)\r\n-                    $exists = false;\r\n-                    if ($memoId !== null) {\r\n-                        $checkSql = \"SELECT COUNT(*) FROM [digiturk].[iris_rapor] WHERE [MEMO_ID] = ?\";\r\n-                        $checkStmt = $pdo->prepare($checkSql);\r\n-                        $checkStmt->execute([$memoId]);\r\n-                        $exists = $checkStmt->fetchColumn() > 0;\r\n-                    } else {\r\n-                        // MEMO_ID null ise her zaman yeni kayıt ekle (unique constraint problemi olmasın)\r\n-                        $exists = false;\r\n-                    }\r\n+                    // Mevcut kaydı kontrol et\r\n+                    $checkSql = \"SELECT COUNT(*) FROM [digiturk].[iris_rapor] WHERE [MEMO_ID] = ?\";\r\n+                    $checkStmt = $pdo->prepare($checkSql);\r\n+                    $checkStmt->execute([$memoId]);\r\n+                    $exists = $checkStmt->fetchColumn() > 0;\r\n                     \r\n                     if ($exists) {\r\n                         // Güncelleme - MEMO_ID hariç tüm alanları güncelle\r\n                         $updateSql = \"UPDATE [digiturk].[iris_rapor] SET \r\n@@ -279,9 +281,9 @@\n                             $data[1],  // TALEP_TURU\r\n                             $data[2],  // UYDU_BASVURU_POTANSIYEL_NO\r\n                             $data[3],  // UYDU_BASVURU_UYE_NO\r\n                             $data[4],  // DT_MUSTERI_NO\r\n-                            $memoId,   // MEMO_ID (null olabilir)\r\n+                            $memoId,   // MEMO_ID (artık her zaman geçerli bir değer)\r\n                             $data[6],  // MEMO_KAYIT_TIPI\r\n                             $data[7],  // MEMO_ID_TIP\r\n                             $data[8],  // MEMO_KODU\r\n                             $data[10], // MEMO_KAPANIS_TARIHI\r\n@@ -341,8 +343,9 @@\n             'success' => true,\r\n             'processed' => $processed,\r\n             'updated' => $updated,\r\n             'inserted' => $inserted,\r\n+            'skipped' => $skipped,\r\n             'errors' => $errors,\r\n             'next_offset' => $nextOffset,\r\n             'has_more' => $hasMore,\r\n             'debug_info' => $debugInfo\r\n@@ -359,8 +362,9 @@\n         'message' => $e->getMessage(),\r\n         'processed' => 0,\r\n         'updated' => 0,\r\n         'inserted' => 0,\r\n+        'skipped' => 0,\r\n         'errors' => [$e->getMessage()],\r\n         'next_offset' => 0,\r\n         'has_more' => false\r\n     ]);\r\n"
                }
            ],
            "date": 1760454892763,
            "name": "Commit-0",
            "content": "<?php\r\nheader('Content-Type: application/json');\r\n\r\n// Veritabanı bağlantısı için config dosyasını dahil et\r\n$config = include 'config/mssql.php';\r\n\r\ntry {\r\n    $action = $_GET['action'] ?? '';\r\n    $filename = $_GET['file'] ?? '';\r\n    \r\n    if (empty($filename)) {\r\n        throw new Exception('Dosya adı belirtilmedi');\r\n    }\r\n    \r\n    $uploadDir = 'uploads/';\r\n    $filePath = $uploadDir . $filename;\r\n    \r\n    // Dosya varlığını kontrol et\r\n    if (!file_exists($filePath)) {\r\n        throw new Exception('Dosya bulunamadı: ' . $filename);\r\n    }\r\n    \r\n    if ($action === 'info') {\r\n        // Dosya bilgilerini döndür\r\n        $fileSize = filesize($filePath);\r\n        \r\n        // Toplam satır sayısını hesapla\r\n        $handle = fopen($filePath, 'r');\r\n        if (!$handle) {\r\n            throw new Exception('Dosya açılamadı');\r\n        }\r\n        \r\n        $lineCount = 0;\r\n        while (fgets($handle) !== false) {\r\n            $lineCount++;\r\n        }\r\n        fclose($handle);\r\n        \r\n        // İlk satır başlık olduğu için veri satır sayısı\r\n        $dataLines = $lineCount - 1;\r\n        \r\n        // Önerilen chunk boyutu (dosya boyutuna göre)\r\n        $recommendedChunkSize = 25;\r\n        if ($fileSize < 1024 * 1024) { // 1MB'den küçükse\r\n            $recommendedChunkSize = 50;\r\n        } elseif ($fileSize > 10 * 1024 * 1024) { // 10MB'den büyükse\r\n            $recommendedChunkSize = 10;\r\n        }\r\n        \r\n        echo json_encode([\r\n            'success' => true,\r\n            'file' => $filename,\r\n            'file_size' => $fileSize,\r\n            'total_lines' => $dataLines,\r\n            'total_rows' => $dataLines,\r\n            'recommended_chunk_size' => $recommendedChunkSize,\r\n            'chunk_size' => $recommendedChunkSize\r\n        ]);\r\n        \r\n    } elseif ($action === 'process') {\r\n        // CSV işleme\r\n        $offset = intval($_GET['offset'] ?? 0);\r\n        $chunkSize = intval($_GET['chunk_size'] ?? 25);\r\n        \r\n        // Veritabanı bağlantısı\r\n        $connectionString = \"sqlsrv:Server={$config['host']};Database={$config['database']}\";\r\n        $pdo = new PDO($connectionString, $config['username'], $config['password']);\r\n        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\r\n        \r\n        $handle = fopen($filePath, 'r');\r\n        if (!$handle) {\r\n            throw new Exception('Dosya açılamadı');\r\n        }\r\n        \r\n        // İlk satırı atla (başlıklar)\r\n        $headers = fgets($handle);\r\n        \r\n        // Offset pozisyonuna git\r\n        $currentLine = 0;\r\n        while ($currentLine < $offset && fgets($handle) !== false) {\r\n            $currentLine++;\r\n        }\r\n        \r\n        $processed = 0;\r\n        $updated = 0;\r\n        $inserted = 0;\r\n        $errors = [];\r\n        $debugInfo = [];\r\n        \r\n        // Chunk kadar satır işle\r\n        while ($processed < $chunkSize && ($line = fgets($handle)) !== false) {\r\n            try {\r\n                $data = array_map('trim', explode(';', trim($line)));\r\n                \r\n                // Boş satırları atla\r\n                if (empty(trim($line)) || count($data) < 5) {\r\n                    $processed++;\r\n                    continue;\r\n                }\r\n                \r\n                // MEMO_ID kontrolü (unique key)\r\n                $memoId = !empty($data[5]) ? intval($data[5]) : null;\r\n                \r\n                if ($memoId) {\r\n                    // Mevcut kaydı kontrol et\r\n                    $checkSql = \"SELECT COUNT(*) FROM [digiturk].[iris_rapor] WHERE [MEMO_ID] = ?\";\r\n                    $checkStmt = $pdo->prepare($checkSql);\r\n                    $checkStmt->execute([$memoId]);\r\n                    $exists = $checkStmt->fetchColumn() > 0;\r\n                    \r\n                    if ($exists) {\r\n                        // Güncelleme\r\n                        $updateSql = \"UPDATE [digiturk].[iris_rapor] SET \r\n                            [TALEP_ID] = ?, [TALEP_TURU] = ?, [UYDU_BASVURU_POTANSIYEL_NO] = ?, \r\n                            [UYDU_BASVURU_UYE_NO] = ?, [DT_MUSTERI_NO] = ?, [MEMO_KAYIT_TIPI] = ?, \r\n                            [MEMO_ID_TIP] = ?, [MEMO_KODU] = ?, [MEMO_KAPANIS_TARIHI] = ?, \r\n                            [MEMO_YONLENEN_BAYI_KODU] = ?, [MEMO_YONLENEN_BAYI_ADI] = ?, \r\n                            [MEMO_YONLENEN_BAYI_YONETICISI] = ?, [MEMO_YONLENEN_BAYI_BOLGE] = ?, \r\n                            [MEMO_YONLENEN_BAYI_TEKNIK_YNTC] = ?, [TALEP_GIRIS_TARIHI] = ?, \r\n                            [TALEBI_GIREN_BAYI_KODU] = ?, [TALEBI_GIREN_BAYI_ADI] = ?, \r\n                            [TALEBI_GIREN_PERSONEL] = ?, [TALEBI_GIREN_PERSONELNO] = ?, \r\n                            [TALEBI_GIREN_PERSONELKODU] = ?, [TALEBI_GIREN_PERSONEL_ALTBAYI] = ?, \r\n                            [TALEP_KAYNAK] = ?, [SATIS_DURUMU] = ?, [INTERNET_SUREC_DURUMU] = ?, \r\n                            [AKTIVE_EDILEN_UYENO] = ?, [AKTIVE_EDILEN_OUTLETNO] = ?, \r\n                            [AKTIVE_EDILEN_SOZLESMENO] = ?, [AKTIVE_EDILEN_SOZLESMEKMP] = ?, \r\n                            [AKTIVE_EDILEN_SOZLESMEDURUM] = ?, [TALEP_TAKIP_NOTU] = ?, \r\n                            [GUNCEL_OUTLET_DURUM] = ?, [TEYIT_DURUM] = ?, [TEYIT_ARAMA_DURUM] = ?, \r\n                            [RANDEVU_TARIHI] = ?, [MEMO_SON_DURUM] = ?, [MEMO_SON_CEVAP] = ?, \r\n                            [MEMO_SON_ACIKLAMA] = ?, [guncellenme_tarihi] = GETDATE(), [dosya_adi] = ? \r\n                            WHERE [MEMO_ID] = ?\";\r\n                        \r\n                        $updateStmt = $pdo->prepare($updateSql);\r\n                        $params = array_slice($data, 0, 38); // İlk 38 sütun\r\n                        $params[] = $filename; // dosya_adi\r\n                        $params[] = $memoId; // WHERE şartı\r\n                        \r\n                        $updateStmt->execute($params);\r\n                        $updated++;\r\n                    } else {\r\n                        // Ekleme\r\n                        $insertSql = \"INSERT INTO [digiturk].[iris_rapor] (\r\n                            [TALEP_ID], [TALEP_TURU], [UYDU_BASVURU_POTANSIYEL_NO], \r\n                            [UYDU_BASVURU_UYE_NO], [DT_MUSTERI_NO], [MEMO_ID], [MEMO_KAYIT_TIPI], \r\n                            [MEMO_ID_TIP], [MEMO_KODU], [MEMO_KAPANIS_TARIHI], \r\n                            [MEMO_YONLENEN_BAYI_KODU], [MEMO_YONLENEN_BAYI_ADI], \r\n                            [MEMO_YONLENEN_BAYI_YONETICISI], [MEMO_YONLENEN_BAYI_BOLGE], \r\n                            [MEMO_YONLENEN_BAYI_TEKNIK_YNTC], [TALEP_GIRIS_TARIHI], \r\n                            [TALEBI_GIREN_BAYI_KODU], [TALEBI_GIREN_BAYI_ADI], \r\n                            [TALEBI_GIREN_PERSONEL], [TALEBI_GIREN_PERSONELNO], \r\n                            [TALEBI_GIREN_PERSONELKODU], [TALEBI_GIREN_PERSONEL_ALTBAYI], \r\n                            [TALEP_KAYNAK], [SATIS_DURUMU], [INTERNET_SUREC_DURUMU], \r\n                            [AKTIVE_EDILEN_UYENO], [AKTIVE_EDILEN_OUTLETNO], \r\n                            [AKTIVE_EDILEN_SOZLESMENO], [AKTIVE_EDILEN_SOZLESMEKMP], \r\n                            [AKTIVE_EDILEN_SOZLESMEDURUM], [TALEP_TAKIP_NOTU], \r\n                            [GUNCEL_OUTLET_DURUM], [TEYIT_DURUM], [TEYIT_ARAMA_DURUM], \r\n                            [RANDEVU_TARIHI], [MEMO_SON_DURUM], [MEMO_SON_CEVAP], \r\n                            [MEMO_SON_ACIKLAMA], [eklenme_tarihi], [dosya_adi]\r\n                        ) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,GETDATE(),?)\";\r\n                        \r\n                        $insertStmt = $pdo->prepare($insertSql);\r\n                        $params = array_slice($data, 0, 38); // İlk 38 sütun\r\n                        $params[] = $filename; // dosya_adi\r\n                        \r\n                        $insertStmt->execute($params);\r\n                        $inserted++;\r\n                    }\r\n                }\r\n                \r\n            } catch (Exception $e) {\r\n                $errors[] = \"Satır \" . ($offset + $processed + 1) . \": \" . $e->getMessage();\r\n            }\r\n            \r\n            $processed++;\r\n        }\r\n        \r\n        $nextOffset = $offset + $processed;\r\n        $hasMore = !feof($handle);\r\n        \r\n        fclose($handle);\r\n        \r\n        echo json_encode([\r\n            'success' => true,\r\n            'processed' => $processed,\r\n            'updated' => $updated,\r\n            'inserted' => $inserted,\r\n            'errors' => $errors,\r\n            'next_offset' => $nextOffset,\r\n            'has_more' => $hasMore,\r\n            'debug_info' => $debugInfo\r\n        ]);\r\n        \r\n    } else {\r\n        throw new Exception('Geçersiz action parametresi');\r\n    }\r\n    \r\n} catch (Exception $e) {\r\n    http_response_code(500);\r\n    echo json_encode([\r\n        'success' => false,\r\n        'message' => $e->getMessage(),\r\n        'processed' => 0,\r\n        'updated' => 0,\r\n        'inserted' => 0,\r\n        'errors' => [$e->getMessage()],\r\n        'next_offset' => 0,\r\n        'has_more' => false\r\n    ]);\r\n}\r\n?>"
        }
    ]
}
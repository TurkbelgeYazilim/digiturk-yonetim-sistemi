{
    "sourceFile": "auth.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1759329516016,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1759329579229,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,32 @@\n <?php\r\n+// Veritabanı bağlantı fonksiyonu\r\n+function getDatabaseConnection() {\r\n+    $configFile = __DIR__ . '/config/mssql.php';\r\n+    \r\n+    if (!file_exists($configFile)) {\r\n+        throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n+    }\r\n+    \r\n+    $config = include $configFile;\r\n+    \r\n+    try {\r\n+        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n+        \r\n+        $connection = new PDO($dsn, $config['username'], $config['password'], [\r\n+            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n+            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n+            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n+            PDO::ATTR_EMULATE_PREPARES => false\r\n+        ]);\r\n+        \r\n+        return $connection;\r\n+        \r\n+    } catch (PDOException $e) {\r\n+        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n+    }\r\n+}\r\n+\r\n // Auth kontrol fonksiyonu\r\n function checkAuth() {\r\n     if (session_status() == PHP_SESSION_NONE) {\r\n         session_start();\r\n@@ -49,11 +76,9 @@\n \r\n // Kullanıcı grup bilgilerini getir\r\n function getUserGroup($userId) {\r\n     try {\r\n-        require_once 'MSSQLConnection.php';\r\n-        $db = new MSSQLConnection();\r\n-        $conn = $db->getConnection();\r\n+        $conn = getDatabaseConnection();\r\n         \r\n         $sql = \"SELECT ug.id, ug.group_name, ug.group_description, ug.permissions \r\n                 FROM user_groups ug \r\n                 INNER JOIN users u ON u.user_group_id = ug.id \r\n@@ -74,11 +99,9 @@\n     }\r\n     \r\n     if (isset($_SESSION['user_id'])) {\r\n         try {\r\n-            require_once 'MSSQLConnection.php';\r\n-            $db = new MSSQLConnection();\r\n-            $conn = $db->getConnection();\r\n+            $conn = getDatabaseConnection();\r\n             \r\n             $sql = \"UPDATE users SET updated_at = GETDATE() WHERE id = ?\";\r\n             $stmt = $conn->prepare($sql);\r\n             $stmt->execute([$_SESSION['user_id']]);\r\n@@ -95,11 +118,9 @@\n     }\r\n     \r\n     if (isset($_SESSION['user_id'])) {\r\n         try {\r\n-            require_once 'MSSQLConnection.php';\r\n-            $db = new MSSQLConnection();\r\n-            $conn = $db->getConnection();\r\n+            $conn = getDatabaseConnection();\r\n             \r\n             $sql = \"SELECT status FROM users WHERE id = ?\";\r\n             $stmt = $conn->prepare($sql);\r\n             $stmt->execute([$_SESSION['user_id']]);\r\n"
                },
                {
                    "date": 1760620783585,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -64,23 +64,23 @@\n // Belirli yetki kontrolü fonksiyonu\r\n function checkPermission($module, $action) {\r\n     $user = checkAuth();\r\n     \r\n-    if (!$user['permissions']) {\r\n-        return false;\r\n+    // Permissions alanı olmadığı için grup adına göre kontrol yap\r\n+    if ($user['group_name'] === 'admin') {\r\n+        return true; // Admin her şeyi yapabilir\r\n     }\r\n     \r\n-    $permissions = json_decode($user['permissions'], true);\r\n-    \r\n-    return isset($permissions[$module][$action]) && $permissions[$module][$action] === true;\r\n+    // Diğer grup yetkileri burada tanımlanabilir\r\n+    return false;\r\n }\r\n \r\n // Kullanıcı grup bilgilerini getir\r\n function getUserGroup($userId) {\r\n     try {\r\n         $conn = getDatabaseConnection();\r\n         \r\n-        $sql = \"SELECT ug.id, ug.group_name, ug.group_description, ug.permissions \r\n+        $sql = \"SELECT ug.id, ug.group_name, ug.group_description \r\n                 FROM user_groups ug \r\n                 INNER JOIN users u ON u.user_group_id = ug.id \r\n                 WHERE u.id = ?\";\r\n         $stmt = $conn->prepare($sql);\r\n"
                },
                {
                    "date": 1760623797939,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -47,32 +47,25 @@\n         'permissions' => $_SESSION['user_permissions'] ?? null\r\n     ];\r\n }\r\n \r\n-// Admin yetkisi kontrol fonksiyonu\r\n+// Admin yetkisi kontrol fonksiyonu (geçici olarak tüm kullanıcılar için erişim açık)\r\n function checkAdminAuth() {\r\n     $user = checkAuth();\r\n     \r\n-    // Grup tabanlı admin kontrolü\r\n-    if ($user['group_name'] !== 'admin') {\r\n-        header('Location: index.php?error=no_permission');\r\n-        exit;\r\n-    }\r\n+    // Yetki kısıtlaması geçici olarak kaldırıldı\r\n+    // Herhangi bir login olmuş kullanıcı erişebilir\r\n     \r\n     return $user;\r\n }\r\n \r\n-// Belirli yetki kontrolü fonksiyonu\r\n+// Belirli yetki kontrolü fonksiyonu (geçici olarak tüm kullanıcılar için erişim açık)\r\n function checkPermission($module, $action) {\r\n     $user = checkAuth();\r\n     \r\n-    // Permissions alanı olmadığı için grup adına göre kontrol yap\r\n-    if ($user['group_name'] === 'admin') {\r\n-        return true; // Admin her şeyi yapabilir\r\n-    }\r\n-    \r\n-    // Diğer grup yetkileri burada tanımlanabilir\r\n-    return false;\r\n+    // Yetki kısıtlaması geçici olarak kaldırıldı\r\n+    // Herhangi bir login olmuş kullanıcı tüm işlemleri yapabilir\r\n+    return true;\r\n }\r\n \r\n // Kullanıcı grup bilgilerini getir\r\n function getUserGroup($userId) {\r\n"
                },
                {
                    "date": 1761113386132,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -32,9 +32,13 @@\n         session_start();\r\n     }\r\n     \r\n     if (!isset($_SESSION['user_id'])) {\r\n-        header('Location: login.php');\r\n+        // Root dizine göre login.php'ye yönlendir\r\n+        $rootPath = str_replace('\\\\', '/', realpath(__DIR__));\r\n+        $currentPath = str_replace('\\\\', '/', realpath($_SERVER['DOCUMENT_ROOT'] . dirname($_SERVER['PHP_SELF'])));\r\n+        $relativePath = str_repeat('../', substr_count(str_replace($rootPath, '', $currentPath), '/'));\r\n+        header('Location: ' . $relativePath . 'login.php');\r\n         exit;\r\n     }\r\n     \r\n     return [\r\n"
                }
            ],
            "date": 1759329516016,
            "name": "Commit-0",
            "content": "<?php\r\n// Auth kontrol fonksiyonu\r\nfunction checkAuth() {\r\n    if (session_status() == PHP_SESSION_NONE) {\r\n        session_start();\r\n    }\r\n    \r\n    if (!isset($_SESSION['user_id'])) {\r\n        header('Location: login.php');\r\n        exit;\r\n    }\r\n    \r\n    return [\r\n        'id' => $_SESSION['user_id'],\r\n        'email' => $_SESSION['user_email'],\r\n        'name' => $_SESSION['user_name'],\r\n        'phone' => $_SESSION['user_phone'],\r\n        'group_name' => $_SESSION['user_group_name'] ?? null,\r\n        'group_id' => $_SESSION['user_group_id'] ?? null,\r\n        'permissions' => $_SESSION['user_permissions'] ?? null\r\n    ];\r\n}\r\n\r\n// Admin yetkisi kontrol fonksiyonu\r\nfunction checkAdminAuth() {\r\n    $user = checkAuth();\r\n    \r\n    // Grup tabanlı admin kontrolü\r\n    if ($user['group_name'] !== 'admin') {\r\n        header('Location: index.php?error=no_permission');\r\n        exit;\r\n    }\r\n    \r\n    return $user;\r\n}\r\n\r\n// Belirli yetki kontrolü fonksiyonu\r\nfunction checkPermission($module, $action) {\r\n    $user = checkAuth();\r\n    \r\n    if (!$user['permissions']) {\r\n        return false;\r\n    }\r\n    \r\n    $permissions = json_decode($user['permissions'], true);\r\n    \r\n    return isset($permissions[$module][$action]) && $permissions[$module][$action] === true;\r\n}\r\n\r\n// Kullanıcı grup bilgilerini getir\r\nfunction getUserGroup($userId) {\r\n    try {\r\n        require_once 'MSSQLConnection.php';\r\n        $db = new MSSQLConnection();\r\n        $conn = $db->getConnection();\r\n        \r\n        $sql = \"SELECT ug.id, ug.group_name, ug.group_description, ug.permissions \r\n                FROM user_groups ug \r\n                INNER JOIN users u ON u.user_group_id = ug.id \r\n                WHERE u.id = ?\";\r\n        $stmt = $conn->prepare($sql);\r\n        $stmt->execute([$userId]);\r\n        \r\n        return $stmt->fetch(PDO::FETCH_ASSOC);\r\n    } catch (Exception $e) {\r\n        return null;\r\n    }\r\n}\r\n\r\n// Kullanıcı bilgilerini güncelle\r\nfunction updateLastActivity() {\r\n    if (session_status() == PHP_SESSION_NONE) {\r\n        session_start();\r\n    }\r\n    \r\n    if (isset($_SESSION['user_id'])) {\r\n        try {\r\n            require_once 'MSSQLConnection.php';\r\n            $db = new MSSQLConnection();\r\n            $conn = $db->getConnection();\r\n            \r\n            $sql = \"UPDATE users SET updated_at = GETDATE() WHERE id = ?\";\r\n            $stmt = $conn->prepare($sql);\r\n            $stmt->execute([$_SESSION['user_id']]);\r\n        } catch (Exception $e) {\r\n            // Hata loglanabilir\r\n        }\r\n    }\r\n}\r\n\r\n// Kullanıcı durumunu kontrol et\r\nfunction checkUserStatus() {\r\n    if (session_status() == PHP_SESSION_NONE) {\r\n        session_start();\r\n    }\r\n    \r\n    if (isset($_SESSION['user_id'])) {\r\n        try {\r\n            require_once 'MSSQLConnection.php';\r\n            $db = new MSSQLConnection();\r\n            $conn = $db->getConnection();\r\n            \r\n            $sql = \"SELECT status FROM users WHERE id = ?\";\r\n            $stmt = $conn->prepare($sql);\r\n            $stmt->execute([$_SESSION['user_id']]);\r\n            $user = $stmt->fetch(PDO::FETCH_ASSOC);\r\n            \r\n            if (!$user || $user['status'] !== 'AKTIF') {\r\n                // Kullanıcı pasif hale getirilmiş, oturumu sonlandır\r\n                session_destroy();\r\n                header('Location: login.php?error=account_deactivated');\r\n                exit;\r\n            }\r\n        } catch (Exception $e) {\r\n            // Hata durumunda güvenlik için çıkış yap\r\n            session_destroy();\r\n            header('Location: login.php?error=system_error');\r\n            exit;\r\n        }\r\n    }\r\n}\r\n\r\n// Session timeout kontrolü (30 dakika)\r\nfunction checkSessionTimeout() {\r\n    if (session_status() == PHP_SESSION_NONE) {\r\n        session_start();\r\n    }\r\n    \r\n    $timeout = 30 * 60; // 30 dakika\r\n    \r\n    if (isset($_SESSION['last_activity'])) {\r\n        if (time() - $_SESSION['last_activity'] > $timeout) {\r\n            session_destroy();\r\n            header('Location: login.php?error=session_timeout');\r\n            exit;\r\n        }\r\n    }\r\n    \r\n    $_SESSION['last_activity'] = time();\r\n}\r\n?>\r\n"
        }
    ]
}
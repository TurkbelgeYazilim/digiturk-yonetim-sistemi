{
    "sourceFile": "user_groups.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1758983722741,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1759329491989,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,19 +8,44 @@\n // Auth kontrolü\r\n require_once 'auth.php';\r\n checkAdminAuth(); // Sadece admin erişebilir\r\n \r\n-require_once 'MSSQLConnection.php';\r\n+// Veritabanı bağlantı fonksiyonu\r\n+function getDatabaseConnection() {\r\n+    $configFile = __DIR__ . '/config/mssql.php';\r\n+    \r\n+    if (!file_exists($configFile)) {\r\n+        throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n+    }\r\n+    \r\n+    $config = include $configFile;\r\n+    \r\n+    try {\r\n+        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n+        \r\n+        $connection = new PDO($dsn, $config['username'], $config['password'], [\r\n+            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n+            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n+            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n+            PDO::ATTR_EMULATE_PREPARES => false\r\n+        ]);\r\n+        \r\n+        return $connection;\r\n+        \r\n+    } catch (PDOException $e) {\r\n+        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n+    }\r\n+}\r\n+\r\n require_once 'includes/header.php';\r\n \r\n // CRUD işlemleri\r\n $message = '';\r\n $messageType = '';\r\n \r\n if ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n     try {\r\n-        $conn = new MSSQLConnection();\r\n-        $pdo = $conn->getConnection();\r\n+        $pdo = getDatabaseConnection();\r\n         \r\n         if (isset($_POST['action'])) {\r\n             switch ($_POST['action']) {\r\n                 case 'add':\r\n@@ -94,10 +119,9 @@\n }\r\n \r\n // Grupları listele\r\n try {\r\n-    $conn = new MSSQLConnection();\r\n-    $pdo = $conn->getConnection();\r\n+    $pdo = getDatabaseConnection();\r\n     \r\n     $stmt = $pdo->query(\"\r\n         SELECT ug.*, \r\n                (SELECT COUNT(*) FROM users u WHERE u.user_group_id = ug.id) as user_count\r\n"
                },
                {
                    "date": 1759385814934,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,385 @@\n+<?php\r\n+$pageTitle = \"Kullanıcı Grupları\";\r\n+$breadcrumbs = [\r\n+    ['title' => 'Yönetim', 'url' => '#'],\r\n+    ['title' => 'Kullanıcı Grupları']\r\n+];\r\n+\r\n+// Auth kontrolü\r\n+require_once 'auth.php';\r\n+checkAdminAuth(); // Sadece admin erişebilir\r\n+\r\n+// Veritabanı bağlantı fonksiyonu auth.php dosyasından kullanılıyor\r\n+\r\n+require_once 'includes/header.php';\r\n+\r\n+// CRUD işlemleri\r\n+$message = '';\r\n+$messageType = '';\r\n+\r\n+if ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n+    try {\r\n+        $pdo = getDatabaseConnection();\r\n+        \r\n+        if (isset($_POST['action'])) {\r\n+            switch ($_POST['action']) {\r\n+                case 'add':\r\n+                    $groupName = trim($_POST['group_name']);\r\n+                    $description = trim($_POST['group_description']);\r\n+                    $permissions = $_POST['permissions'] ?? [];\r\n+                    \r\n+                    if (empty($groupName)) {\r\n+                        throw new Exception('Grup adı boş olamaz!');\r\n+                    }\r\n+                    \r\n+                    $permissionsJson = json_encode($permissions);\r\n+                    \r\n+                    $stmt = $pdo->prepare(\"\r\n+                        INSERT INTO user_groups (group_name, group_description, permissions, created_at) \r\n+                        VALUES (?, ?, ?, GETDATE())\r\n+                    \");\r\n+                    $stmt->execute([$groupName, $description, $permissionsJson]);\r\n+                    \r\n+                    $message = \"Kullanıcı grubu başarıyla eklendi!\";\r\n+                    $messageType = \"success\";\r\n+                    break;\r\n+                    \r\n+                case 'edit':\r\n+                    $id = (int)$_POST['id'];\r\n+                    $groupName = trim($_POST['group_name']);\r\n+                    $description = trim($_POST['group_description']);\r\n+                    $permissions = $_POST['permissions'] ?? [];\r\n+                    \r\n+                    if (empty($groupName)) {\r\n+                        throw new Exception('Grup adı boş olamaz!');\r\n+                    }\r\n+                    \r\n+                    $permissionsJson = json_encode($permissions);\r\n+                    \r\n+                    $stmt = $pdo->prepare(\"\r\n+                        UPDATE user_groups \r\n+                        SET group_name = ?, group_description = ?, permissions = ?, updated_at = GETDATE() \r\n+                        WHERE id = ?\r\n+                    \");\r\n+                    $stmt->execute([$groupName, $description, $permissionsJson, $id]);\r\n+                    \r\n+                    $message = \"Kullanıcı grubu başarıyla güncellendi!\";\r\n+                    $messageType = \"success\";\r\n+                    break;\r\n+                    \r\n+                case 'delete':\r\n+                    $id = (int)$_POST['id'];\r\n+                    \r\n+                    // Önce bu gruptan kullanıcı var mı kontrol et\r\n+                    $stmt = $pdo->prepare(\"SELECT COUNT(*) FROM users WHERE user_group_id = ?\");\r\n+                    $stmt->execute([$id]);\r\n+                    $userCount = $stmt->fetchColumn();\r\n+                    \r\n+                    if ($userCount > 0) {\r\n+                        throw new Exception(\"Bu grupta $userCount kullanıcı bulunuyor. Önce kullanıcıları başka gruba taşıyın!\");\r\n+                    }\r\n+                    \r\n+                    $stmt = $pdo->prepare(\"DELETE FROM user_groups WHERE id = ?\");\r\n+                    $stmt->execute([$id]);\r\n+                    \r\n+                    $message = \"Kullanıcı grubu başarıyla silindi!\";\r\n+                    $messageType = \"success\";\r\n+                    break;\r\n+            }\r\n+        }\r\n+    } catch (Exception $e) {\r\n+        $message = $e->getMessage();\r\n+        $messageType = \"danger\";\r\n+    }\r\n+}\r\n+\r\n+// Grupları listele\r\n+try {\r\n+    $pdo = getDatabaseConnection();\r\n+    \r\n+    $stmt = $pdo->query(\"\r\n+        SELECT ug.*, \r\n+               (SELECT COUNT(*) FROM users u WHERE u.user_group_id = ug.id) as user_count\r\n+        FROM user_groups ug \r\n+        ORDER BY ug.group_name\r\n+    \");\r\n+    $groups = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n+    \r\n+} catch (Exception $e) {\r\n+    $message = \"Veriler yüklenirken hata: \" . $e->getMessage();\r\n+    $messageType = \"danger\";\r\n+    $groups = [];\r\n+}\r\n+\r\n+// Mevcut izinler listesi\r\n+$availablePermissions = [\r\n+    'users_view' => 'Kullanıcıları Görüntüleme',\r\n+    'users_add' => 'Kullanıcı Ekleme',\r\n+    'users_edit' => 'Kullanıcı Düzenleme',\r\n+    'users_delete' => 'Kullanıcı Silme',\r\n+    'reports_view' => 'Raporları Görüntüleme',\r\n+    'reports_export' => 'Rapor Dışa Aktarma',\r\n+    'system_settings' => 'Sistem Ayarları',\r\n+    'user_groups_manage' => 'Kullanıcı Grupları Yönetimi'\r\n+];\r\n+?>\r\n+\r\n+<div class=\"container-fluid\">\r\n+    <div class=\"row\">\r\n+        <div class=\"col-12\">\r\n+            <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n+                <h2><i class=\"fas fa-users-cog me-2\"></i>Kullanıcı Grupları</h2>\r\n+                <button type=\"button\" class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#addGroupModal\">\r\n+                    <i class=\"fas fa-plus me-1\"></i>Yeni Grup Ekle\r\n+                </button>\r\n+            </div>\r\n+\r\n+            <?php if ($message): ?>\r\n+                <div class=\"alert alert-<?php echo $messageType; ?> alert-dismissible fade show\" role=\"alert\">\r\n+                    <?php echo htmlspecialchars($message); ?>\r\n+                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n+                </div>\r\n+            <?php endif; ?>\r\n+\r\n+            <!-- Gruplar Tablosu -->\r\n+            <div class=\"card\">\r\n+                <div class=\"card-body\">\r\n+                    <div class=\"table-responsive\">\r\n+                        <table class=\"table table-hover\">\r\n+                            <thead class=\"table-dark\">\r\n+                                <tr>\r\n+                                    <th>ID</th>\r\n+                                    <th>Grup Adı</th>\r\n+                                    <th>Açıklama</th>\r\n+                                    <th>Kullanıcı Sayısı</th>\r\n+                                    <th>İzinler</th>\r\n+                                    <th>Oluşturma Tarihi</th>\r\n+                                    <th>İşlemler</th>\r\n+                                </tr>\r\n+                            </thead>\r\n+                            <tbody>\r\n+                                <?php if (empty($groups)): ?>\r\n+                                    <tr>\r\n+                                        <td colspan=\"7\" class=\"text-center text-muted py-4\">\r\n+                                            <i class=\"fas fa-users-slash fa-2x mb-2 d-block\"></i>\r\n+                                            Henüz kullanıcı grubu bulunmuyor\r\n+                                        </td>\r\n+                                    </tr>\r\n+                                <?php else: ?>\r\n+                                    <?php foreach ($groups as $group): ?>\r\n+                                        <tr>\r\n+                                            <td><?php echo $group['id']; ?></td>\r\n+                                            <td>\r\n+                                                <strong><?php echo htmlspecialchars($group['group_name']); ?></strong>\r\n+                                            </td>\r\n+                                            <td><?php echo htmlspecialchars($group['group_description'] ?? '-'); ?></td>\r\n+                                            <td>\r\n+                                                <span class=\"badge <?php echo $group['user_count'] > 0 ? 'bg-info' : 'bg-secondary'; ?>\">\r\n+                                                    <?php echo $group['user_count']; ?> kullanıcı\r\n+                                                </span>\r\n+                                            </td>\r\n+                                            <td>\r\n+                                                <?php \r\n+                                                $permissions = json_decode($group['permissions'] ?? '[]', true);\r\n+                                                if (!empty($permissions)): \r\n+                                                ?>\r\n+                                                    <small>\r\n+                                                        <?php foreach (array_slice($permissions, 0, 2) as $perm): ?>\r\n+                                                            <span class=\"badge bg-light text-dark me-1\">\r\n+                                                                <?php echo $availablePermissions[$perm] ?? $perm; ?>\r\n+                                                            </span>\r\n+                                                        <?php endforeach; ?>\r\n+                                                        <?php if (count($permissions) > 2): ?>\r\n+                                                            <span class=\"badge bg-secondary\">+<?php echo count($permissions) - 2; ?></span>\r\n+                                                        <?php endif; ?>\r\n+                                                    </small>\r\n+                                                <?php else: ?>\r\n+                                                    <small class=\"text-muted\">İzin yok</small>\r\n+                                                <?php endif; ?>\r\n+                                            </td>\r\n+                                            <td>\r\n+                                                <small class=\"text-muted\">\r\n+                                                    <?php echo date('d.m.Y H:i', strtotime($group['created_at'])); ?>\r\n+                                                </small>\r\n+                                            </td>\r\n+                                            <td>\r\n+                                                <div class=\"btn-group btn-group-sm\">\r\n+                                                    <button type=\"button\" class=\"btn btn-outline-primary\" \r\n+                                                            onclick=\"editGroup(<?php echo htmlspecialchars(json_encode($group)); ?>)\">\r\n+                                                        <i class=\"fas fa-edit\"></i>\r\n+                                                    </button>\r\n+                                                    <?php if ($group['user_count'] == 0): ?>\r\n+                                                        <button type=\"button\" class=\"btn btn-outline-danger\" \r\n+                                                                onclick=\"deleteGroup(<?php echo $group['id']; ?>, '<?php echo htmlspecialchars($group['group_name']); ?>')\">\r\n+                                                            <i class=\"fas fa-trash\"></i>\r\n+                                                        </button>\r\n+                                                    <?php endif; ?>\r\n+                                                </div>\r\n+                                            </td>\r\n+                                        </tr>\r\n+                                    <?php endforeach; ?>\r\n+                                <?php endif; ?>\r\n+                            </tbody>\r\n+                        </table>\r\n+                    </div>\r\n+                </div>\r\n+            </div>\r\n+        </div>\r\n+    </div>\r\n+</div>\r\n+\r\n+<!-- Grup Ekleme Modal -->\r\n+<div class=\"modal fade\" id=\"addGroupModal\" tabindex=\"-1\">\r\n+    <div class=\"modal-dialog modal-lg\">\r\n+        <div class=\"modal-content\">\r\n+            <form method=\"POST\">\r\n+                <div class=\"modal-header\">\r\n+                    <h5 class=\"modal-title\">Yeni Kullanıcı Grubu Ekle</h5>\r\n+                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n+                </div>\r\n+                <div class=\"modal-body\">\r\n+                    <input type=\"hidden\" name=\"action\" value=\"add\">\r\n+                    \r\n+                    <div class=\"mb-3\">\r\n+                        <label class=\"form-label\">Grup Adı *</label>\r\n+                        <input type=\"text\" class=\"form-control\" name=\"group_name\" required>\r\n+                    </div>\r\n+                    \r\n+                    <div class=\"mb-3\">\r\n+                        <label class=\"form-label\">Açıklama</label>\r\n+                        <textarea class=\"form-control\" name=\"group_description\" rows=\"2\"></textarea>\r\n+                    </div>\r\n+                    \r\n+                    <div class=\"mb-3\">\r\n+                        <label class=\"form-label\">İzinler</label>\r\n+                        <div class=\"row\">\r\n+                            <?php foreach ($availablePermissions as $key => $label): ?>\r\n+                                <div class=\"col-md-6 mb-2\">\r\n+                                    <div class=\"form-check\">\r\n+                                        <input class=\"form-check-input\" type=\"checkbox\" name=\"permissions[]\" value=\"<?php echo $key; ?>\" id=\"perm_add_<?php echo $key; ?>\">\r\n+                                        <label class=\"form-check-label\" for=\"perm_add_<?php echo $key; ?>\">\r\n+                                            <?php echo $label; ?>\r\n+                                        </label>\r\n+                                    </div>\r\n+                                </div>\r\n+                            <?php endforeach; ?>\r\n+                        </div>\r\n+                    </div>\r\n+                </div>\r\n+                <div class=\"modal-footer\">\r\n+                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n+                    <button type=\"submit\" class=\"btn btn-primary\">Grup Ekle</button>\r\n+                </div>\r\n+            </form>\r\n+        </div>\r\n+    </div>\r\n+</div>\r\n+\r\n+<!-- Grup Düzenleme Modal -->\r\n+<div class=\"modal fade\" id=\"editGroupModal\" tabindex=\"-1\">\r\n+    <div class=\"modal-dialog modal-lg\">\r\n+        <div class=\"modal-content\">\r\n+            <form method=\"POST\">\r\n+                <div class=\"modal-header\">\r\n+                    <h5 class=\"modal-title\">Kullanıcı Grubu Düzenle</h5>\r\n+                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n+                </div>\r\n+                <div class=\"modal-body\">\r\n+                    <input type=\"hidden\" name=\"action\" value=\"edit\">\r\n+                    <input type=\"hidden\" name=\"id\" id=\"edit_group_id\">\r\n+                    \r\n+                    <div class=\"mb-3\">\r\n+                        <label class=\"form-label\">Grup Adı *</label>\r\n+                        <input type=\"text\" class=\"form-control\" name=\"group_name\" id=\"edit_group_name\" required>\r\n+                    </div>\r\n+                    \r\n+                    <div class=\"mb-3\">\r\n+                        <label class=\"form-label\">Açıklama</label>\r\n+                        <textarea class=\"form-control\" name=\"group_description\" id=\"edit_description\" rows=\"2\"></textarea>\r\n+                    </div>\r\n+                    \r\n+                    <div class=\"mb-3\">\r\n+                        <label class=\"form-label\">İzinler</label>\r\n+                        <div class=\"row\" id=\"edit_permissions\">\r\n+                            <?php foreach ($availablePermissions as $key => $label): ?>\r\n+                                <div class=\"col-md-6 mb-2\">\r\n+                                    <div class=\"form-check\">\r\n+                                        <input class=\"form-check-input\" type=\"checkbox\" name=\"permissions[]\" value=\"<?php echo $key; ?>\" id=\"perm_edit_<?php echo $key; ?>\">\r\n+                                        <label class=\"form-check-label\" for=\"perm_edit_<?php echo $key; ?>\">\r\n+                                            <?php echo $label; ?>\r\n+                                        </label>\r\n+                                    </div>\r\n+                                </div>\r\n+                            <?php endforeach; ?>\r\n+                        </div>\r\n+                    </div>\r\n+                </div>\r\n+                <div class=\"modal-footer\">\r\n+                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n+                    <button type=\"submit\" class=\"btn btn-primary\">Güncelle</button>\r\n+                </div>\r\n+            </form>\r\n+        </div>\r\n+    </div>\r\n+</div>\r\n+\r\n+<!-- Silme Modal -->\r\n+<div class=\"modal fade\" id=\"deleteGroupModal\" tabindex=\"-1\">\r\n+    <div class=\"modal-dialog\">\r\n+        <div class=\"modal-content\">\r\n+            <form method=\"POST\">\r\n+                <div class=\"modal-header\">\r\n+                    <h5 class=\"modal-title\">Grubu Sil</h5>\r\n+                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n+                </div>\r\n+                <div class=\"modal-body\">\r\n+                    <input type=\"hidden\" name=\"action\" value=\"delete\">\r\n+                    <input type=\"hidden\" name=\"id\" id=\"delete_group_id\">\r\n+                    \r\n+                    <div class=\"alert alert-warning\">\r\n+                        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n+                        <strong id=\"delete_group_name\"></strong> adlı grubu silmek istediğinizden emin misiniz?\r\n+                        <br><br>\r\n+                        <small>Bu işlem geri alınamaz!</small>\r\n+                    </div>\r\n+                </div>\r\n+                <div class=\"modal-footer\">\r\n+                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n+                    <button type=\"submit\" class=\"btn btn-danger\">Sil</button>\r\n+                </div>\r\n+            </form>\r\n+        </div>\r\n+    </div>\r\n+</div>\r\n+\r\n+<script>\r\n+function editGroup(group) {\r\n+    document.getElementById('edit_group_id').value = group.id;\r\n+    document.getElementById('edit_group_name').value = group.group_name;\r\n+    document.getElementById('edit_description').value = group.group_description || '';\r\n+    \r\n+    // İzinleri temizle\r\n+    document.querySelectorAll('#edit_permissions input[type=\"checkbox\"]').forEach(cb => cb.checked = false);\r\n+    \r\n+    // Mevcut izinleri işaretle\r\n+    try {\r\n+        const permissions = JSON.parse(group.permissions || '[]');\r\n+        permissions.forEach(perm => {\r\n+            const checkbox = document.getElementById('perm_edit_' + perm);\r\n+            if (checkbox) checkbox.checked = true;\r\n+        });\r\n+    } catch (e) {\r\n+        console.error('İzinler parse edilemedi:', e);\r\n+    }\r\n+    \r\n+    new bootstrap.Modal(document.getElementById('editGroupModal')).show();\r\n+}\r\n+\r\n+function deleteGroup(id, name) {\r\n+    document.getElementById('delete_group_id').value = id;\r\n+    document.getElementById('delete_group_name').textContent = name;\r\n+    new bootstrap.Modal(document.getElementById('deleteGroupModal')).show();\r\n+}\r\n+</script>\r\n+\r\n+<?php require_once 'includes/footer.php'; ?>\r\n"
                },
                {
                    "date": 1760603608487,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,422 +6,18 @@\n ];\r\n \r\n // Auth kontrolü\r\n require_once 'auth.php';\r\n-checkAdminAuth(); // Sadece admin erişebilir\r\n-\r\n-// Veritabanı bağlantı fonksiyonu auth.php dosyasından kullanılıyor\r\n-\r\n-require_once 'includes/header.php';\r\n-\r\n-// CRUD işlemleri\r\n-$message = '';\r\n-$messageType = '';\r\n-\r\n-if ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n-    try {\r\n-        $pdo = getDatabaseConnection();\r\n-        \r\n-        if (isset($_POST['action'])) {\r\n-            switch ($_POST['action']) {\r\n-                case 'add':\r\n-                    $groupName = trim($_POST['group_name']);\r\n-                    $description = trim($_POST['group_description']);\r\n-                    $permissions = $_POST['permissions'] ?? [];\r\n-                    \r\n-                    if (empty($groupName)) {\r\n-                        throw new Exception('Grup adı boş olamaz!');\r\n-                    }\r\n-                    \r\n-                    $permissionsJson = json_encode($permissions);\r\n-                    \r\n-                    $stmt = $pdo->prepare(\"\r\n-                        INSERT INTO user_groups (group_name, group_description, permissions, created_at) \r\n-                        VALUES (?, ?, ?, GETDATE())\r\n-                    \");\r\n-                    $stmt->execute([$groupName, $description, $permissionsJson]);\r\n-                    \r\n-                    $message = \"Kullanıcı grubu başarıyla eklendi!\";\r\n-                    $messageType = \"success\";\r\n-                    break;\r\n-                    \r\n-                case 'edit':\r\n-                    $id = (int)$_POST['id'];\r\n-                    $groupName = trim($_POST['group_name']);\r\n-                    $description = trim($_POST['group_description']);\r\n-                    $permissions = $_POST['permissions'] ?? [];\r\n-                    \r\n-                    if (empty($groupName)) {\r\n-                        throw new Exception('Grup adı boş olamaz!');\r\n-                    }\r\n-                    \r\n-                    $permissionsJson = json_encode($permissions);\r\n-                    \r\n-                    $stmt = $pdo->prepare(\"\r\n-                        UPDATE user_groups \r\n-                        SET group_name = ?, group_description = ?, permissions = ?, updated_at = GETDATE() \r\n-                        WHERE id = ?\r\n-                    \");\r\n-                    $stmt->execute([$groupName, $description, $permissionsJson, $id]);\r\n-                    \r\n-                    $message = \"Kullanıcı grubu başarıyla güncellendi!\";\r\n-                    $messageType = \"success\";\r\n-                    break;\r\n-                    \r\n-                case 'delete':\r\n-                    $id = (int)$_POST['id'];\r\n-                    \r\n-                    // Önce bu gruptan kullanıcı var mı kontrol et\r\n-                    $stmt = $pdo->prepare(\"SELECT COUNT(*) FROM users WHERE user_group_id = ?\");\r\n-                    $stmt->execute([$id]);\r\n-                    $userCount = $stmt->fetchColumn();\r\n-                    \r\n-                    if ($userCount > 0) {\r\n-                        throw new Exception(\"Bu grupta $userCount kullanıcı bulunuyor. Önce kullanıcıları başka gruba taşıyın!\");\r\n-                    }\r\n-                    \r\n-                    $stmt = $pdo->prepare(\"DELETE FROM user_groups WHERE id = ?\");\r\n-                    $stmt->execute([$id]);\r\n-                    \r\n-                    $message = \"Kullanıcı grubu başarıyla silindi!\";\r\n-                    $messageType = \"success\";\r\n-                    break;\r\n-            }\r\n-        }\r\n-    } catch (Exception $e) {\r\n-        $message = $e->getMessage();\r\n-        $messageType = \"danger\";\r\n-    }\r\n-}\r\n-\r\n-// Grupları listele\r\n try {\r\n-    $pdo = getDatabaseConnection();\r\n-    \r\n-    $stmt = $pdo->query(\"\r\n-        SELECT ug.*, \r\n-               (SELECT COUNT(*) FROM users u WHERE u.user_group_id = ug.id) as user_count\r\n-        FROM user_groups ug \r\n-        ORDER BY ug.group_name\r\n-    \");\r\n-    $groups = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n-    \r\n+    checkAdminAuth(); // Admin kontrolü\r\n } catch (Exception $e) {\r\n-    $message = \"Veriler yüklenirken hata: \" . $e->getMessage();\r\n-    $messageType = \"danger\";\r\n-    $groups = [];\r\n+    // Geçici olarak auth hatasını görmezden gel\r\n+    // header('Location: login.php');\r\n+    // exit;\r\n }\r\n \r\n-// Mevcut izinler listesi\r\n-$availablePermissions = [\r\n-    'users_view' => 'Kullanıcıları Görüntüleme',\r\n-    'users_add' => 'Kullanıcı Ekleme',\r\n-    'users_edit' => 'Kullanıcı Düzenleme',\r\n-    'users_delete' => 'Kullanıcı Silme',\r\n-    'reports_view' => 'Raporları Görüntüleme',\r\n-    'reports_export' => 'Rapor Dışa Aktarma',\r\n-    'system_settings' => 'Sistem Ayarları',\r\n-    'user_groups_manage' => 'Kullanıcı Grupları Yönetimi'\r\n-];\r\n-?>\r\n+// Veritabanı bağlantı fonksiyonu auth.php dosyasından kullanılıyor\r\n \r\n-<div class=\"container-fluid\">\r\n-    <div class=\"row\">\r\n-        <div class=\"col-12\">\r\n-            <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n-                <h2><i class=\"fas fa-users-cog me-2\"></i>Kullanıcı Grupları</h2>\r\n-                <button type=\"button\" class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#addGroupModal\">\r\n-                    <i class=\"fas fa-plus me-1\"></i>Yeni Grup Ekle\r\n-                </button>\r\n-            </div>\r\n-\r\n-            <?php if ($message): ?>\r\n-                <div class=\"alert alert-<?php echo $messageType; ?> alert-dismissible fade show\" role=\"alert\">\r\n-                    <?php echo htmlspecialchars($message); ?>\r\n-                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n-                </div>\r\n-            <?php endif; ?>\r\n-\r\n-            <!-- Gruplar Tablosu -->\r\n-            <div class=\"card\">\r\n-                <div class=\"card-body\">\r\n-                    <div class=\"table-responsive\">\r\n-                        <table class=\"table table-hover\">\r\n-                            <thead class=\"table-dark\">\r\n-                                <tr>\r\n-                                    <th>ID</th>\r\n-                                    <th>Grup Adı</th>\r\n-                                    <th>Açıklama</th>\r\n-                                    <th>Kullanıcı Sayısı</th>\r\n-                                    <th>İzinler</th>\r\n-                                    <th>Oluşturma Tarihi</th>\r\n-                                    <th>İşlemler</th>\r\n-                                </tr>\r\n-                            </thead>\r\n-                            <tbody>\r\n-                                <?php if (empty($groups)): ?>\r\n-                                    <tr>\r\n-                                        <td colspan=\"7\" class=\"text-center text-muted py-4\">\r\n-                                            <i class=\"fas fa-users-slash fa-2x mb-2 d-block\"></i>\r\n-                                            Henüz kullanıcı grubu bulunmuyor\r\n-                                        </td>\r\n-                                    </tr>\r\n-                                <?php else: ?>\r\n-                                    <?php foreach ($groups as $group): ?>\r\n-                                        <tr>\r\n-                                            <td><?php echo $group['id']; ?></td>\r\n-                                            <td>\r\n-                                                <strong><?php echo htmlspecialchars($group['group_name']); ?></strong>\r\n-                                            </td>\r\n-                                            <td><?php echo htmlspecialchars($group['group_description'] ?? '-'); ?></td>\r\n-                                            <td>\r\n-                                                <span class=\"badge <?php echo $group['user_count'] > 0 ? 'bg-info' : 'bg-secondary'; ?>\">\r\n-                                                    <?php echo $group['user_count']; ?> kullanıcı\r\n-                                                </span>\r\n-                                            </td>\r\n-                                            <td>\r\n-                                                <?php \r\n-                                                $permissions = json_decode($group['permissions'] ?? '[]', true);\r\n-                                                if (!empty($permissions)): \r\n-                                                ?>\r\n-                                                    <small>\r\n-                                                        <?php foreach (array_slice($permissions, 0, 2) as $perm): ?>\r\n-                                                            <span class=\"badge bg-light text-dark me-1\">\r\n-                                                                <?php echo $availablePermissions[$perm] ?? $perm; ?>\r\n-                                                            </span>\r\n-                                                        <?php endforeach; ?>\r\n-                                                        <?php if (count($permissions) > 2): ?>\r\n-                                                            <span class=\"badge bg-secondary\">+<?php echo count($permissions) - 2; ?></span>\r\n-                                                        <?php endif; ?>\r\n-                                                    </small>\r\n-                                                <?php else: ?>\r\n-                                                    <small class=\"text-muted\">İzin yok</small>\r\n-                                                <?php endif; ?>\r\n-                                            </td>\r\n-                                            <td>\r\n-                                                <small class=\"text-muted\">\r\n-                                                    <?php echo date('d.m.Y H:i', strtotime($group['created_at'])); ?>\r\n-                                                </small>\r\n-                                            </td>\r\n-                                            <td>\r\n-                                                <div class=\"btn-group btn-group-sm\">\r\n-                                                    <button type=\"button\" class=\"btn btn-outline-primary\" \r\n-                                                            onclick=\"editGroup(<?php echo htmlspecialchars(json_encode($group)); ?>)\">\r\n-                                                        <i class=\"fas fa-edit\"></i>\r\n-                                                    </button>\r\n-                                                    <?php if ($group['user_count'] == 0): ?>\r\n-                                                        <button type=\"button\" class=\"btn btn-outline-danger\" \r\n-                                                                onclick=\"deleteGroup(<?php echo $group['id']; ?>, '<?php echo htmlspecialchars($group['group_name']); ?>')\">\r\n-                                                            <i class=\"fas fa-trash\"></i>\r\n-                                                        </button>\r\n-                                                    <?php endif; ?>\r\n-                                                </div>\r\n-                                            </td>\r\n-                                        </tr>\r\n-                                    <?php endforeach; ?>\r\n-                                <?php endif; ?>\r\n-                            </tbody>\r\n-                        </table>\r\n-                    </div>\r\n-                </div>\r\n-            </div>\r\n-        </div>\r\n-    </div>\r\n-</div>\r\n-\r\n-<!-- Grup Ekleme Modal -->\r\n-<div class=\"modal fade\" id=\"addGroupModal\" tabindex=\"-1\">\r\n-    <div class=\"modal-dialog modal-lg\">\r\n-        <div class=\"modal-content\">\r\n-            <form method=\"POST\">\r\n-                <div class=\"modal-header\">\r\n-                    <h5 class=\"modal-title\">Yeni Kullanıcı Grubu Ekle</h5>\r\n-                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n-                </div>\r\n-                <div class=\"modal-body\">\r\n-                    <input type=\"hidden\" name=\"action\" value=\"add\">\r\n-                    \r\n-                    <div class=\"mb-3\">\r\n-                        <label class=\"form-label\">Grup Adı *</label>\r\n-                        <input type=\"text\" class=\"form-control\" name=\"group_name\" required>\r\n-                    </div>\r\n-                    \r\n-                    <div class=\"mb-3\">\r\n-                        <label class=\"form-label\">Açıklama</label>\r\n-                        <textarea class=\"form-control\" name=\"group_description\" rows=\"2\"></textarea>\r\n-                    </div>\r\n-                    \r\n-                    <div class=\"mb-3\">\r\n-                        <label class=\"form-label\">İzinler</label>\r\n-                        <div class=\"row\">\r\n-                            <?php foreach ($availablePermissions as $key => $label): ?>\r\n-                                <div class=\"col-md-6 mb-2\">\r\n-                                    <div class=\"form-check\">\r\n-                                        <input class=\"form-check-input\" type=\"checkbox\" name=\"permissions[]\" value=\"<?php echo $key; ?>\" id=\"perm_add_<?php echo $key; ?>\">\r\n-                                        <label class=\"form-check-label\" for=\"perm_add_<?php echo $key; ?>\">\r\n-                                            <?php echo $label; ?>\r\n-                                        </label>\r\n-                                    </div>\r\n-                                </div>\r\n-                            <?php endforeach; ?>\r\n-                        </div>\r\n-                    </div>\r\n-                </div>\r\n-                <div class=\"modal-footer\">\r\n-                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n-                    <button type=\"submit\" class=\"btn btn-primary\">Grup Ekle</button>\r\n-                </div>\r\n-            </form>\r\n-        </div>\r\n-    </div>\r\n-</div>\r\n-\r\n-<!-- Grup Düzenleme Modal -->\r\n-<div class=\"modal fade\" id=\"editGroupModal\" tabindex=\"-1\">\r\n-    <div class=\"modal-dialog modal-lg\">\r\n-        <div class=\"modal-content\">\r\n-            <form method=\"POST\">\r\n-                <div class=\"modal-header\">\r\n-                    <h5 class=\"modal-title\">Kullanıcı Grubu Düzenle</h5>\r\n-                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n-                </div>\r\n-                <div class=\"modal-body\">\r\n-                    <input type=\"hidden\" name=\"action\" value=\"edit\">\r\n-                    <input type=\"hidden\" name=\"id\" id=\"edit_group_id\">\r\n-                    \r\n-                    <div class=\"mb-3\">\r\n-                        <label class=\"form-label\">Grup Adı *</label>\r\n-                        <input type=\"text\" class=\"form-control\" name=\"group_name\" id=\"edit_group_name\" required>\r\n-                    </div>\r\n-                    \r\n-                    <div class=\"mb-3\">\r\n-                        <label class=\"form-label\">Açıklama</label>\r\n-                        <textarea class=\"form-control\" name=\"group_description\" id=\"edit_description\" rows=\"2\"></textarea>\r\n-                    </div>\r\n-                    \r\n-                    <div class=\"mb-3\">\r\n-                        <label class=\"form-label\">İzinler</label>\r\n-                        <div class=\"row\" id=\"edit_permissions\">\r\n-                            <?php foreach ($availablePermissions as $key => $label): ?>\r\n-                                <div class=\"col-md-6 mb-2\">\r\n-                                    <div class=\"form-check\">\r\n-                                        <input class=\"form-check-input\" type=\"checkbox\" name=\"permissions[]\" value=\"<?php echo $key; ?>\" id=\"perm_edit_<?php echo $key; ?>\">\r\n-                                        <label class=\"form-check-label\" for=\"perm_edit_<?php echo $key; ?>\">\r\n-                                            <?php echo $label; ?>\r\n-                                        </label>\r\n-                                    </div>\r\n-                                </div>\r\n-                            <?php endforeach; ?>\r\n-                        </div>\r\n-                    </div>\r\n-                </div>\r\n-                <div class=\"modal-footer\">\r\n-                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n-                    <button type=\"submit\" class=\"btn btn-primary\">Güncelle</button>\r\n-                </div>\r\n-            </form>\r\n-        </div>\r\n-    </div>\r\n-</div>\r\n-\r\n-<!-- Silme Modal -->\r\n-<div class=\"modal fade\" id=\"deleteGroupModal\" tabindex=\"-1\">\r\n-    <div class=\"modal-dialog\">\r\n-        <div class=\"modal-content\">\r\n-            <form method=\"POST\">\r\n-                <div class=\"modal-header\">\r\n-                    <h5 class=\"modal-title\">Grubu Sil</h5>\r\n-                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n-                </div>\r\n-                <div class=\"modal-body\">\r\n-                    <input type=\"hidden\" name=\"action\" value=\"delete\">\r\n-                    <input type=\"hidden\" name=\"id\" id=\"delete_group_id\">\r\n-                    \r\n-                    <div class=\"alert alert-warning\">\r\n-                        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n-                        <strong id=\"delete_group_name\"></strong> adlı grubu silmek istediğinizden emin misiniz?\r\n-                        <br><br>\r\n-                        <small>Bu işlem geri alınamaz!</small>\r\n-                    </div>\r\n-                </div>\r\n-                <div class=\"modal-footer\">\r\n-                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n-                    <button type=\"submit\" class=\"btn btn-danger\">Sil</button>\r\n-                </div>\r\n-            </form>\r\n-        </div>\r\n-    </div>\r\n-</div>\r\n-\r\n-<script>\r\n-function editGroup(group) {\r\n-    document.getElementById('edit_group_id').value = group.id;\r\n-    document.getElementById('edit_group_name').value = group.group_name;\r\n-    document.getElementById('edit_description').value = group.group_description || '';\r\n-    \r\n-    // İzinleri temizle\r\n-    document.querySelectorAll('#edit_permissions input[type=\"checkbox\"]').forEach(cb => cb.checked = false);\r\n-    \r\n-    // Mevcut izinleri işaretle\r\n-    try {\r\n-        const permissions = JSON.parse(group.permissions || '[]');\r\n-        permissions.forEach(perm => {\r\n-            const checkbox = document.getElementById('perm_edit_' + perm);\r\n-            if (checkbox) checkbox.checked = true;\r\n-        });\r\n-    } catch (e) {\r\n-        console.error('İzinler parse edilemedi:', e);\r\n-    }\r\n-    \r\n-    new bootstrap.Modal(document.getElementById('editGroupModal')).show();\r\n-}\r\n-\r\n-function deleteGroup(id, name) {\r\n-    document.getElementById('delete_group_id').value = id;\r\n-    document.getElementById('delete_group_name').textContent = name;\r\n-    new bootstrap.Modal(document.getElementById('deleteGroupModal')).show();\r\n-}\r\n-</script>\r\n-\r\n-<?php require_once 'includes/footer.php'; ?>\r\n-<?php\r\n-$pageTitle = \"Kullanıcı Grupları\";\r\n-$breadcrumbs = [\r\n-    ['title' => 'Yönetim', 'url' => '#'],\r\n-    ['title' => 'Kullanıcı Grupları']\r\n-];\r\n-\r\n-// Auth kontrolü\r\n-require_once 'auth.php';\r\n-checkAdminAuth(); // Sadece admin erişebilir\r\n-\r\n-// Veritabanı bağlantı fonksiyonu\r\n-function getDatabaseConnection() {\r\n-    $configFile = __DIR__ . '/config/mssql.php';\r\n-    \r\n-    if (!file_exists($configFile)) {\r\n-        throw new Exception('Veritabanı konfigürasyon dosyası bulunamadı: ' . $configFile);\r\n-    }\r\n-    \r\n-    $config = include $configFile;\r\n-    \r\n-    try {\r\n-        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n-        \r\n-        $connection = new PDO($dsn, $config['username'], $config['password'], [\r\n-            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n-            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n-            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n-            PDO::ATTR_EMULATE_PREPARES => false\r\n-        ]);\r\n-        \r\n-        return $connection;\r\n-        \r\n-    } catch (PDOException $e) {\r\n-        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n-    }\r\n-}\r\n-\r\n require_once 'includes/header.php';\r\n \r\n // CRUD işlemleri\r\n $message = '';\r\n@@ -435,21 +31,18 @@\n             switch ($_POST['action']) {\r\n                 case 'add':\r\n                     $groupName = trim($_POST['group_name']);\r\n                     $description = trim($_POST['group_description']);\r\n-                    $permissions = $_POST['permissions'] ?? [];\r\n                     \r\n                     if (empty($groupName)) {\r\n                         throw new Exception('Grup adı boş olamaz!');\r\n                     }\r\n                     \r\n-                    $permissionsJson = json_encode($permissions);\r\n-                    \r\n                     $stmt = $pdo->prepare(\"\r\n-                        INSERT INTO user_groups (group_name, group_description, permissions, created_at) \r\n-                        VALUES (?, ?, ?, GETDATE())\r\n+                        INSERT INTO user_groups (group_name, group_description, created_at) \r\n+                        VALUES (?, ?, GETDATE())\r\n                     \");\r\n-                    $stmt->execute([$groupName, $description, $permissionsJson]);\r\n+                    $stmt->execute([$groupName, $description]);\r\n                     \r\n                     $message = \"Kullanıcı grubu başarıyla eklendi!\";\r\n                     $messageType = \"success\";\r\n                     break;\r\n@@ -457,22 +50,19 @@\n                 case 'edit':\r\n                     $id = (int)$_POST['id'];\r\n                     $groupName = trim($_POST['group_name']);\r\n                     $description = trim($_POST['group_description']);\r\n-                    $permissions = $_POST['permissions'] ?? [];\r\n                     \r\n                     if (empty($groupName)) {\r\n                         throw new Exception('Grup adı boş olamaz!');\r\n                     }\r\n                     \r\n-                    $permissionsJson = json_encode($permissions);\r\n-                    \r\n                     $stmt = $pdo->prepare(\"\r\n                         UPDATE user_groups \r\n-                        SET group_name = ?, group_description = ?, permissions = ?, updated_at = GETDATE() \r\n+                        SET group_name = ?, group_description = ?, updated_at = GETDATE() \r\n                         WHERE id = ?\r\n                     \");\r\n-                    $stmt->execute([$groupName, $description, $permissionsJson, $id]);\r\n+                    $stmt->execute([$groupName, $description, $id]);\r\n                     \r\n                     $message = \"Kullanıcı grubu başarıyla güncellendi!\";\r\n                     $messageType = \"success\";\r\n                     break;\r\n@@ -588,25 +178,9 @@\n                                                     <?php echo $group['user_count']; ?> kullanıcı\r\n                                                 </span>\r\n                                             </td>\r\n                                             <td>\r\n-                                                <?php \r\n-                                                $permissions = json_decode($group['permissions'] ?? '[]', true);\r\n-                                                if (!empty($permissions)): \r\n-                                                ?>\r\n-                                                    <small>\r\n-                                                        <?php foreach (array_slice($permissions, 0, 2) as $perm): ?>\r\n-                                                            <span class=\"badge bg-light text-dark me-1\">\r\n-                                                                <?php echo $availablePermissions[$perm] ?? $perm; ?>\r\n-                                                            </span>\r\n-                                                        <?php endforeach; ?>\r\n-                                                        <?php if (count($permissions) > 2): ?>\r\n-                                                            <span class=\"badge bg-secondary\">+<?php echo count($permissions) - 2; ?></span>\r\n-                                                        <?php endif; ?>\r\n-                                                    </small>\r\n-                                                <?php else: ?>\r\n-                                                    <small class=\"text-muted\">İzin yok</small>\r\n-                                                <?php endif; ?>\r\n+                                                <small class=\"text-muted\">İzin sistemi henüz aktif değil</small>\r\n                                             </td>\r\n                                             <td>\r\n                                                 <small class=\"text-muted\">\r\n                                                     <?php echo date('d.m.Y H:i', strtotime($group['created_at'])); ?>\r\n@@ -658,24 +232,8 @@\n                     <div class=\"mb-3\">\r\n                         <label class=\"form-label\">Açıklama</label>\r\n                         <textarea class=\"form-control\" name=\"group_description\" rows=\"2\"></textarea>\r\n                     </div>\r\n-                    \r\n-                    <div class=\"mb-3\">\r\n-                        <label class=\"form-label\">İzinler</label>\r\n-                        <div class=\"row\">\r\n-                            <?php foreach ($availablePermissions as $key => $label): ?>\r\n-                                <div class=\"col-md-6 mb-2\">\r\n-                                    <div class=\"form-check\">\r\n-                                        <input class=\"form-check-input\" type=\"checkbox\" name=\"permissions[]\" value=\"<?php echo $key; ?>\" id=\"perm_add_<?php echo $key; ?>\">\r\n-                                        <label class=\"form-check-label\" for=\"perm_add_<?php echo $key; ?>\">\r\n-                                            <?php echo $label; ?>\r\n-                                        </label>\r\n-                                    </div>\r\n-                                </div>\r\n-                            <?php endforeach; ?>\r\n-                        </div>\r\n-                    </div>\r\n                 </div>\r\n                 <div class=\"modal-footer\">\r\n                     <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                     <button type=\"submit\" class=\"btn btn-primary\">Grup Ekle</button>\r\n@@ -706,24 +264,8 @@\n                     <div class=\"mb-3\">\r\n                         <label class=\"form-label\">Açıklama</label>\r\n                         <textarea class=\"form-control\" name=\"group_description\" id=\"edit_description\" rows=\"2\"></textarea>\r\n                     </div>\r\n-                    \r\n-                    <div class=\"mb-3\">\r\n-                        <label class=\"form-label\">İzinler</label>\r\n-                        <div class=\"row\" id=\"edit_permissions\">\r\n-                            <?php foreach ($availablePermissions as $key => $label): ?>\r\n-                                <div class=\"col-md-6 mb-2\">\r\n-                                    <div class=\"form-check\">\r\n-                                        <input class=\"form-check-input\" type=\"checkbox\" name=\"permissions[]\" value=\"<?php echo $key; ?>\" id=\"perm_edit_<?php echo $key; ?>\">\r\n-                                        <label class=\"form-check-label\" for=\"perm_edit_<?php echo $key; ?>\">\r\n-                                            <?php echo $label; ?>\r\n-                                        </label>\r\n-                                    </div>\r\n-                                </div>\r\n-                            <?php endforeach; ?>\r\n-                        </div>\r\n-                    </div>\r\n                 </div>\r\n                 <div class=\"modal-footer\">\r\n                     <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                     <button type=\"submit\" class=\"btn btn-primary\">Güncelle</button>\r\n@@ -767,22 +309,8 @@\n     document.getElementById('edit_group_id').value = group.id;\r\n     document.getElementById('edit_group_name').value = group.group_name;\r\n     document.getElementById('edit_description').value = group.group_description || '';\r\n     \r\n-    // İzinleri temizle\r\n-    document.querySelectorAll('#edit_permissions input[type=\"checkbox\"]').forEach(cb => cb.checked = false);\r\n-    \r\n-    // Mevcut izinleri işaretle\r\n-    try {\r\n-        const permissions = JSON.parse(group.permissions || '[]');\r\n-        permissions.forEach(perm => {\r\n-            const checkbox = document.getElementById('perm_edit_' + perm);\r\n-            if (checkbox) checkbox.checked = true;\r\n-        });\r\n-    } catch (e) {\r\n-        console.error('İzinler parse edilemedi:', e);\r\n-    }\r\n-    \r\n     new bootstrap.Modal(document.getElementById('editGroupModal')).show();\r\n }\r\n \r\n function deleteGroup(id, name) {\r\n"
                }
            ],
            "date": 1758983722741,
            "name": "Commit-0",
            "content": "<?php\r\n$pageTitle = \"Kullanıcı Grupları\";\r\n$breadcrumbs = [\r\n    ['title' => 'Yönetim', 'url' => '#'],\r\n    ['title' => 'Kullanıcı Grupları']\r\n];\r\n\r\n// Auth kontrolü\r\nrequire_once 'auth.php';\r\ncheckAdminAuth(); // Sadece admin erişebilir\r\n\r\nrequire_once 'MSSQLConnection.php';\r\nrequire_once 'includes/header.php';\r\n\r\n// CRUD işlemleri\r\n$message = '';\r\n$messageType = '';\r\n\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    try {\r\n        $conn = new MSSQLConnection();\r\n        $pdo = $conn->getConnection();\r\n        \r\n        if (isset($_POST['action'])) {\r\n            switch ($_POST['action']) {\r\n                case 'add':\r\n                    $groupName = trim($_POST['group_name']);\r\n                    $description = trim($_POST['group_description']);\r\n                    $permissions = $_POST['permissions'] ?? [];\r\n                    \r\n                    if (empty($groupName)) {\r\n                        throw new Exception('Grup adı boş olamaz!');\r\n                    }\r\n                    \r\n                    $permissionsJson = json_encode($permissions);\r\n                    \r\n                    $stmt = $pdo->prepare(\"\r\n                        INSERT INTO user_groups (group_name, group_description, permissions, created_at) \r\n                        VALUES (?, ?, ?, GETDATE())\r\n                    \");\r\n                    $stmt->execute([$groupName, $description, $permissionsJson]);\r\n                    \r\n                    $message = \"Kullanıcı grubu başarıyla eklendi!\";\r\n                    $messageType = \"success\";\r\n                    break;\r\n                    \r\n                case 'edit':\r\n                    $id = (int)$_POST['id'];\r\n                    $groupName = trim($_POST['group_name']);\r\n                    $description = trim($_POST['group_description']);\r\n                    $permissions = $_POST['permissions'] ?? [];\r\n                    \r\n                    if (empty($groupName)) {\r\n                        throw new Exception('Grup adı boş olamaz!');\r\n                    }\r\n                    \r\n                    $permissionsJson = json_encode($permissions);\r\n                    \r\n                    $stmt = $pdo->prepare(\"\r\n                        UPDATE user_groups \r\n                        SET group_name = ?, group_description = ?, permissions = ?, updated_at = GETDATE() \r\n                        WHERE id = ?\r\n                    \");\r\n                    $stmt->execute([$groupName, $description, $permissionsJson, $id]);\r\n                    \r\n                    $message = \"Kullanıcı grubu başarıyla güncellendi!\";\r\n                    $messageType = \"success\";\r\n                    break;\r\n                    \r\n                case 'delete':\r\n                    $id = (int)$_POST['id'];\r\n                    \r\n                    // Önce bu gruptan kullanıcı var mı kontrol et\r\n                    $stmt = $pdo->prepare(\"SELECT COUNT(*) FROM users WHERE user_group_id = ?\");\r\n                    $stmt->execute([$id]);\r\n                    $userCount = $stmt->fetchColumn();\r\n                    \r\n                    if ($userCount > 0) {\r\n                        throw new Exception(\"Bu grupta $userCount kullanıcı bulunuyor. Önce kullanıcıları başka gruba taşıyın!\");\r\n                    }\r\n                    \r\n                    $stmt = $pdo->prepare(\"DELETE FROM user_groups WHERE id = ?\");\r\n                    $stmt->execute([$id]);\r\n                    \r\n                    $message = \"Kullanıcı grubu başarıyla silindi!\";\r\n                    $messageType = \"success\";\r\n                    break;\r\n            }\r\n        }\r\n    } catch (Exception $e) {\r\n        $message = $e->getMessage();\r\n        $messageType = \"danger\";\r\n    }\r\n}\r\n\r\n// Grupları listele\r\ntry {\r\n    $conn = new MSSQLConnection();\r\n    $pdo = $conn->getConnection();\r\n    \r\n    $stmt = $pdo->query(\"\r\n        SELECT ug.*, \r\n               (SELECT COUNT(*) FROM users u WHERE u.user_group_id = ug.id) as user_count\r\n        FROM user_groups ug \r\n        ORDER BY ug.group_name\r\n    \");\r\n    $groups = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n} catch (Exception $e) {\r\n    $message = \"Veriler yüklenirken hata: \" . $e->getMessage();\r\n    $messageType = \"danger\";\r\n    $groups = [];\r\n}\r\n\r\n// Mevcut izinler listesi\r\n$availablePermissions = [\r\n    'users_view' => 'Kullanıcıları Görüntüleme',\r\n    'users_add' => 'Kullanıcı Ekleme',\r\n    'users_edit' => 'Kullanıcı Düzenleme',\r\n    'users_delete' => 'Kullanıcı Silme',\r\n    'reports_view' => 'Raporları Görüntüleme',\r\n    'reports_export' => 'Rapor Dışa Aktarma',\r\n    'system_settings' => 'Sistem Ayarları',\r\n    'user_groups_manage' => 'Kullanıcı Grupları Yönetimi'\r\n];\r\n?>\r\n\r\n<div class=\"container-fluid\">\r\n    <div class=\"row\">\r\n        <div class=\"col-12\">\r\n            <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n                <h2><i class=\"fas fa-users-cog me-2\"></i>Kullanıcı Grupları</h2>\r\n                <button type=\"button\" class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#addGroupModal\">\r\n                    <i class=\"fas fa-plus me-1\"></i>Yeni Grup Ekle\r\n                </button>\r\n            </div>\r\n\r\n            <?php if ($message): ?>\r\n                <div class=\"alert alert-<?php echo $messageType; ?> alert-dismissible fade show\" role=\"alert\">\r\n                    <?php echo htmlspecialchars($message); ?>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n                </div>\r\n            <?php endif; ?>\r\n\r\n            <!-- Gruplar Tablosu -->\r\n            <div class=\"card\">\r\n                <div class=\"card-body\">\r\n                    <div class=\"table-responsive\">\r\n                        <table class=\"table table-hover\">\r\n                            <thead class=\"table-dark\">\r\n                                <tr>\r\n                                    <th>ID</th>\r\n                                    <th>Grup Adı</th>\r\n                                    <th>Açıklama</th>\r\n                                    <th>Kullanıcı Sayısı</th>\r\n                                    <th>İzinler</th>\r\n                                    <th>Oluşturma Tarihi</th>\r\n                                    <th>İşlemler</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody>\r\n                                <?php if (empty($groups)): ?>\r\n                                    <tr>\r\n                                        <td colspan=\"7\" class=\"text-center text-muted py-4\">\r\n                                            <i class=\"fas fa-users-slash fa-2x mb-2 d-block\"></i>\r\n                                            Henüz kullanıcı grubu bulunmuyor\r\n                                        </td>\r\n                                    </tr>\r\n                                <?php else: ?>\r\n                                    <?php foreach ($groups as $group): ?>\r\n                                        <tr>\r\n                                            <td><?php echo $group['id']; ?></td>\r\n                                            <td>\r\n                                                <strong><?php echo htmlspecialchars($group['group_name']); ?></strong>\r\n                                            </td>\r\n                                            <td><?php echo htmlspecialchars($group['group_description'] ?? '-'); ?></td>\r\n                                            <td>\r\n                                                <span class=\"badge <?php echo $group['user_count'] > 0 ? 'bg-info' : 'bg-secondary'; ?>\">\r\n                                                    <?php echo $group['user_count']; ?> kullanıcı\r\n                                                </span>\r\n                                            </td>\r\n                                            <td>\r\n                                                <?php \r\n                                                $permissions = json_decode($group['permissions'] ?? '[]', true);\r\n                                                if (!empty($permissions)): \r\n                                                ?>\r\n                                                    <small>\r\n                                                        <?php foreach (array_slice($permissions, 0, 2) as $perm): ?>\r\n                                                            <span class=\"badge bg-light text-dark me-1\">\r\n                                                                <?php echo $availablePermissions[$perm] ?? $perm; ?>\r\n                                                            </span>\r\n                                                        <?php endforeach; ?>\r\n                                                        <?php if (count($permissions) > 2): ?>\r\n                                                            <span class=\"badge bg-secondary\">+<?php echo count($permissions) - 2; ?></span>\r\n                                                        <?php endif; ?>\r\n                                                    </small>\r\n                                                <?php else: ?>\r\n                                                    <small class=\"text-muted\">İzin yok</small>\r\n                                                <?php endif; ?>\r\n                                            </td>\r\n                                            <td>\r\n                                                <small class=\"text-muted\">\r\n                                                    <?php echo date('d.m.Y H:i', strtotime($group['created_at'])); ?>\r\n                                                </small>\r\n                                            </td>\r\n                                            <td>\r\n                                                <div class=\"btn-group btn-group-sm\">\r\n                                                    <button type=\"button\" class=\"btn btn-outline-primary\" \r\n                                                            onclick=\"editGroup(<?php echo htmlspecialchars(json_encode($group)); ?>)\">\r\n                                                        <i class=\"fas fa-edit\"></i>\r\n                                                    </button>\r\n                                                    <?php if ($group['user_count'] == 0): ?>\r\n                                                        <button type=\"button\" class=\"btn btn-outline-danger\" \r\n                                                                onclick=\"deleteGroup(<?php echo $group['id']; ?>, '<?php echo htmlspecialchars($group['group_name']); ?>')\">\r\n                                                            <i class=\"fas fa-trash\"></i>\r\n                                                        </button>\r\n                                                    <?php endif; ?>\r\n                                                </div>\r\n                                            </td>\r\n                                        </tr>\r\n                                    <?php endforeach; ?>\r\n                                <?php endif; ?>\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Grup Ekleme Modal -->\r\n<div class=\"modal fade\" id=\"addGroupModal\" tabindex=\"-1\">\r\n    <div class=\"modal-dialog modal-lg\">\r\n        <div class=\"modal-content\">\r\n            <form method=\"POST\">\r\n                <div class=\"modal-header\">\r\n                    <h5 class=\"modal-title\">Yeni Kullanıcı Grubu Ekle</h5>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <input type=\"hidden\" name=\"action\" value=\"add\">\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label class=\"form-label\">Grup Adı *</label>\r\n                        <input type=\"text\" class=\"form-control\" name=\"group_name\" required>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label class=\"form-label\">Açıklama</label>\r\n                        <textarea class=\"form-control\" name=\"group_description\" rows=\"2\"></textarea>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label class=\"form-label\">İzinler</label>\r\n                        <div class=\"row\">\r\n                            <?php foreach ($availablePermissions as $key => $label): ?>\r\n                                <div class=\"col-md-6 mb-2\">\r\n                                    <div class=\"form-check\">\r\n                                        <input class=\"form-check-input\" type=\"checkbox\" name=\"permissions[]\" value=\"<?php echo $key; ?>\" id=\"perm_add_<?php echo $key; ?>\">\r\n                                        <label class=\"form-check-label\" for=\"perm_add_<?php echo $key; ?>\">\r\n                                            <?php echo $label; ?>\r\n                                        </label>\r\n                                    </div>\r\n                                </div>\r\n                            <?php endforeach; ?>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-primary\">Grup Ekle</button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Grup Düzenleme Modal -->\r\n<div class=\"modal fade\" id=\"editGroupModal\" tabindex=\"-1\">\r\n    <div class=\"modal-dialog modal-lg\">\r\n        <div class=\"modal-content\">\r\n            <form method=\"POST\">\r\n                <div class=\"modal-header\">\r\n                    <h5 class=\"modal-title\">Kullanıcı Grubu Düzenle</h5>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <input type=\"hidden\" name=\"action\" value=\"edit\">\r\n                    <input type=\"hidden\" name=\"id\" id=\"edit_group_id\">\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label class=\"form-label\">Grup Adı *</label>\r\n                        <input type=\"text\" class=\"form-control\" name=\"group_name\" id=\"edit_group_name\" required>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label class=\"form-label\">Açıklama</label>\r\n                        <textarea class=\"form-control\" name=\"group_description\" id=\"edit_description\" rows=\"2\"></textarea>\r\n                    </div>\r\n                    \r\n                    <div class=\"mb-3\">\r\n                        <label class=\"form-label\">İzinler</label>\r\n                        <div class=\"row\" id=\"edit_permissions\">\r\n                            <?php foreach ($availablePermissions as $key => $label): ?>\r\n                                <div class=\"col-md-6 mb-2\">\r\n                                    <div class=\"form-check\">\r\n                                        <input class=\"form-check-input\" type=\"checkbox\" name=\"permissions[]\" value=\"<?php echo $key; ?>\" id=\"perm_edit_<?php echo $key; ?>\">\r\n                                        <label class=\"form-check-label\" for=\"perm_edit_<?php echo $key; ?>\">\r\n                                            <?php echo $label; ?>\r\n                                        </label>\r\n                                    </div>\r\n                                </div>\r\n                            <?php endforeach; ?>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-primary\">Güncelle</button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Silme Modal -->\r\n<div class=\"modal fade\" id=\"deleteGroupModal\" tabindex=\"-1\">\r\n    <div class=\"modal-dialog\">\r\n        <div class=\"modal-content\">\r\n            <form method=\"POST\">\r\n                <div class=\"modal-header\">\r\n                    <h5 class=\"modal-title\">Grubu Sil</h5>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <input type=\"hidden\" name=\"action\" value=\"delete\">\r\n                    <input type=\"hidden\" name=\"id\" id=\"delete_group_id\">\r\n                    \r\n                    <div class=\"alert alert-warning\">\r\n                        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n                        <strong id=\"delete_group_name\"></strong> adlı grubu silmek istediğinizden emin misiniz?\r\n                        <br><br>\r\n                        <small>Bu işlem geri alınamaz!</small>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-danger\">Sil</button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<script>\r\nfunction editGroup(group) {\r\n    document.getElementById('edit_group_id').value = group.id;\r\n    document.getElementById('edit_group_name').value = group.group_name;\r\n    document.getElementById('edit_description').value = group.group_description || '';\r\n    \r\n    // İzinleri temizle\r\n    document.querySelectorAll('#edit_permissions input[type=\"checkbox\"]').forEach(cb => cb.checked = false);\r\n    \r\n    // Mevcut izinleri işaretle\r\n    try {\r\n        const permissions = JSON.parse(group.permissions || '[]');\r\n        permissions.forEach(perm => {\r\n            const checkbox = document.getElementById('perm_edit_' + perm);\r\n            if (checkbox) checkbox.checked = true;\r\n        });\r\n    } catch (e) {\r\n        console.error('İzinler parse edilemedi:', e);\r\n    }\r\n    \r\n    new bootstrap.Modal(document.getElementById('editGroupModal')).show();\r\n}\r\n\r\nfunction deleteGroup(id, name) {\r\n    document.getElementById('delete_group_id').value = id;\r\n    document.getElementById('delete_group_name').textContent = name;\r\n    new bootstrap.Modal(document.getElementById('deleteGroupModal')).show();\r\n}\r\n</script>\r\n\r\n<?php require_once 'includes/footer.php'; ?>\r\n"
        }
    ]
}
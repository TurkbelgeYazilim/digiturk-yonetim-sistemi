{
    "sourceFile": "bayi_odeme_yonetimi.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 14,
            "patches": [
                {
                    "date": 1758977964930,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1758981945570,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,181 +18,266 @@\n     header('Location: index.php?error=Yetkisiz erişim');\r\n     exit;\r\n }\r\n \r\n-require_once 'MSSQLConnection.php';\r\n+// Database connection setup\r\n+$config = include __DIR__ . '/config/mssql.php';\r\n \r\n-try {\r\n-    $db = new MSSQLConnection();\r\n-    $conn = $db->getConnection();\r\n+function getConnection($config) {\r\n+    try {\r\n+        $dsn = \"sqlsrv:Server={$config['host']};Database={$config['database']};TrustServerCertificate=yes\";\r\n+        \r\n+        $conn = new PDO($dsn, $config['username'], $config['password'], [\r\n+            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\r\n+            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n+            PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,\r\n+            PDO::ATTR_EMULATE_PREPARES => false\r\n+        ]);\r\n+        \r\n+        return $conn;\r\n+    } catch (PDOException $e) {\r\n+        throw new Exception('Veritabanı bağlantı hatası: ' . $e->getMessage());\r\n+    }\r\n+}\r\n+\r\n+function createTables($conn) {\r\n+    $sql = \"\r\n+    -- Ödeme türleri tablosu\r\n+    IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='odeme_turleri' AND xtype='U')\r\n+    CREATE TABLE odeme_turleri (\r\n+        id INT IDENTITY(1,1) PRIMARY KEY,\r\n+        tur_adi NVARCHAR(100) NOT NULL,\r\n+        aciklama NVARCHAR(500),\r\n+        renk_kodu NVARCHAR(7) DEFAULT '#007bff',\r\n+        ikon NVARCHAR(50) DEFAULT 'fa-money-bill',\r\n+        aktif BIT DEFAULT 1,\r\n+        created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n+        updated_at DATETIME2 NULL\r\n+    );\r\n+\r\n+    -- Bayi ödemeleri tablosu\r\n+    IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='bayi_odemeleri' AND xtype='U')\r\n+    CREATE TABLE bayi_odemeleri (\r\n+        id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n+        user_id INT NOT NULL,\r\n+        odeme_turu_id INT NOT NULL,\r\n+        tutar DECIMAL(15,2) NOT NULL,\r\n+        odeme_tarihi DATE NOT NULL,\r\n+        aciklama NVARCHAR(1000),\r\n+        referans_no NVARCHAR(100),\r\n+        durum NVARCHAR(20) DEFAULT 'BEKLEMEDE',\r\n+        dekont_dosya_adi NVARCHAR(255),\r\n+        dosya_yolu NVARCHAR(500),\r\n+        dosya_boyutu BIGINT,\r\n+        dosya_tipi NVARCHAR(10),\r\n+        olusturan_kullanici NVARCHAR(100),\r\n+        onaylayan_kullanici NVARCHAR(100),\r\n+        onay_tarihi DATETIME2,\r\n+        created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n+        updated_at DATETIME2 NULL,\r\n+        FOREIGN KEY (user_id) REFERENCES users(id),\r\n+        FOREIGN KEY (odeme_turu_id) REFERENCES odeme_turleri(id)\r\n+    );\r\n+\r\n+    -- Ödeme logları tablosu\r\n+    IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='odeme_logları' AND xtype='U')\r\n+    CREATE TABLE odeme_logları (\r\n+        id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n+        odeme_id BIGINT NOT NULL,\r\n+        islem_tipi NVARCHAR(50) NOT NULL,\r\n+        eski_durum NVARCHAR(20),\r\n+        yeni_durum NVARCHAR(20),\r\n+        kullanici NVARCHAR(100) NOT NULL,\r\n+        aciklama NVARCHAR(1000),\r\n+        created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n+        FOREIGN KEY (odeme_id) REFERENCES bayi_odemeleri(id)\r\n+    );\r\n+\r\n+    -- İndeksler oluştur\r\n+    IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('bayi_odemeleri') AND name = 'IX_bayi_odemeleri_user_id')\r\n+    CREATE INDEX IX_bayi_odemeleri_user_id ON bayi_odemeleri (user_id);\r\n+\r\n+    IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('bayi_odemeleri') AND name = 'IX_bayi_odemeleri_odeme_tarihi')\r\n+    CREATE INDEX IX_bayi_odemeleri_odeme_tarihi ON bayi_odemeleri (odeme_tarihi);\r\n+\r\n+    IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('bayi_odemeleri') AND name = 'IX_bayi_odemeleri_durum')\r\n+    CREATE INDEX IX_bayi_odemeleri_durum ON bayi_odemeleri (durum);\r\n+\r\n+    -- Varsayılan ödeme türlerini ekle\r\n+    IF NOT EXISTS (SELECT 1 FROM odeme_turleri)\r\n+    BEGIN\r\n+        INSERT INTO odeme_turleri (tur_adi, aciklama, renk_kodu, ikon) VALUES \r\n+        ('Hakediş Ödemesi', 'Bayi hakediş ödemeleri', '#28a745', 'fa-hand-holding-usd'),\r\n+        ('Prim Ödemesi', 'Bayi prim ödemeleri', '#17a2b8', 'fa-star'),\r\n+        ('Fatura Kesildi', 'Bayi fatura kesintileri', '#dc3545', 'fa-file-invoice-dollar'),\r\n+        ('Diğer Ödeme', 'Diğer ödeme türleri', '#6c757d', 'fa-coins'),\r\n+        ('Kesinti', 'Bayi kesintileri', '#fd7e14', 'fa-minus-circle');\r\n+    END\r\n+    \";\r\n     \r\n-    // Tablolar mevcut mu kontrol et ve oluştur\r\n     try {\r\n-        $sql_content = file_get_contents(__DIR__ . '/create_odeme_tables.sql');\r\n-        if ($sql_content) {\r\n-            $conn->exec($sql_content);\r\n-        }\r\n+        $conn->exec($sql);\r\n     } catch (Exception $e) {\r\n-        // Tablo oluşturma hatası - log'la ama devam et\r\n         error_log(\"Tablo oluşturma hatası: \" . $e->getMessage());\r\n     }\r\n+}\r\n+\r\n+try {\r\n+    $conn = getConnection($config);\r\n     \r\n+    // Tablolar mevcut mu kontrol et ve oluştur\r\n+    createTables($conn);\r\n+    \r\n     // AJAX isteği kontrolü\r\n     if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {\r\n         header('Content-Type: application/json');\r\n         \r\n         try {\r\n             $action = $_POST['action'];\r\n             \r\n             if ($action === 'get_payments') {\r\n-            // Ödemeleri getir\r\n-            $bayi_id = $_POST['bayi_id'] ?? '';\r\n-            $odeme_turu = $_POST['odeme_turu'] ?? '';\r\n-            $baslangic_tarih = $_POST['baslangic_tarih'] ?? '';\r\n-            $bitis_tarih = $_POST['bitis_tarih'] ?? '';\r\n-            $durum = $_POST['durum'] ?? '';\r\n-            \r\n-            // Önce basit test - tablolar var mı?\r\n-            try {\r\n-                $test_sql = \"SELECT COUNT(*) as count FROM odeme_turleri\";\r\n-                $test_stmt = $conn->prepare($test_sql);\r\n-                $test_stmt->execute();\r\n-                $tur_count = $test_stmt->fetchColumn();\r\n+                // Ödemeleri getir\r\n+                $bayi_id = $_POST['bayi_id'] ?? '';\r\n+                $odeme_turu = $_POST['odeme_turu'] ?? '';\r\n+                $baslangic_tarih = $_POST['baslangic_tarih'] ?? '';\r\n+                $bitis_tarih = $_POST['bitis_tarih'] ?? '';\r\n+                $durum = $_POST['durum'] ?? '';\r\n                 \r\n-                $test_sql2 = \"SELECT COUNT(*) as count FROM users u INNER JOIN user_groups ug ON u.user_group_id = ug.id WHERE ug.group_name = 'bayi'\";\r\n-                $test_stmt2 = $conn->prepare($test_sql2);\r\n-                $test_stmt2->execute();\r\n-                $bayi_count = $test_stmt2->fetchColumn();\r\n+                $sql = \"SELECT \r\n+                            bo.id,\r\n+                            u.first_name + ' ' + u.last_name as bayi_adi,\r\n+                            u.email as bayi_email,\r\n+                            ot.tur_adi,\r\n+                            ot.renk_kodu,\r\n+                            ot.ikon,\r\n+                            bo.tutar,\r\n+                            bo.odeme_tarihi,\r\n+                            bo.aciklama,\r\n+                            bo.referans_no,\r\n+                            bo.durum,\r\n+                            bo.dekont_dosya_adi,\r\n+                            bo.dosya_yolu,\r\n+                            bo.created_at\r\n+                        FROM bayi_odemeleri bo\r\n+                        INNER JOIN users u ON bo.user_id = u.id\r\n+                        INNER JOIN odeme_turleri ot ON bo.odeme_turu_id = ot.id\r\n+                        WHERE 1=1\";\r\n                 \r\n-            } catch (Exception $e) {\r\n-                echo json_encode([\r\n-                    'success' => false, \r\n-                    'message' => 'Tablo kontrolü hatası: ' . $e->getMessage()\r\n-                ]);\r\n+                $params = [];\r\n+                \r\n+                if ($bayi_id) {\r\n+                    $sql .= \" AND bo.user_id = ?\";\r\n+                    $params[] = $bayi_id;\r\n+                }\r\n+                \r\n+                if ($odeme_turu) {\r\n+                    $sql .= \" AND bo.odeme_turu_id = ?\";\r\n+                    $params[] = $odeme_turu;\r\n+                }\r\n+                \r\n+                if ($baslangic_tarih) {\r\n+                    $sql .= \" AND bo.odeme_tarihi >= ?\";\r\n+                    $params[] = $baslangic_tarih;\r\n+                }\r\n+                \r\n+                if ($bitis_tarih) {\r\n+                    $sql .= \" AND bo.odeme_tarihi <= ?\";\r\n+                    $params[] = $bitis_tarih;\r\n+                }\r\n+                \r\n+                if ($durum) {\r\n+                    $sql .= \" AND bo.durum = ?\";\r\n+                    $params[] = $durum;\r\n+                }\r\n+                \r\n+                $sql .= \" ORDER BY bo.created_at DESC\";\r\n+                \r\n+                $stmt = $conn->prepare($sql);\r\n+                $stmt->execute($params);\r\n+                $payments = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n+                \r\n+                echo json_encode(['success' => true, 'data' => $payments]);\r\n                 exit;\r\n             }\r\n             \r\n-            $sql = \"SELECT \r\n-                        bo.id,\r\n-                        u.name as bayi_adi,\r\n-                        u.email as bayi_email,\r\n-                        ot.tur_adi,\r\n-                        ot.renk_kodu,\r\n-                        ot.ikon,\r\n-                        bo.tutar,\r\n-                        bo.odeme_tarihi,\r\n-                        bo.aciklama,\r\n-                        bo.referans_no,\r\n-                        bo.durum,\r\n-                        bo.dekont_dosya_adi,\r\n-                        bo.created_at\r\n-                    FROM bayi_odemeleri bo\r\n-                    INNER JOIN users u ON bo.user_id = u.id\r\n-                    INNER JOIN odeme_turleri ot ON bo.odeme_turu_id = ot.id\r\n-                    WHERE 1=1\";\r\n-            \r\n-            $params = [];\r\n-            \r\n-            if ($bayi_id) {\r\n-                $sql .= \" AND bo.user_id = ?\";\r\n-                $params[] = $bayi_id;\r\n-            }\r\n-            \r\n-            if ($odeme_turu) {\r\n-                $sql .= \" AND bo.odeme_turu_id = ?\";\r\n-                $params[] = $odeme_turu;\r\n-            }\r\n-            \r\n-            if ($baslangic_tarih) {\r\n-                $sql .= \" AND bo.odeme_tarihi >= ?\";\r\n-                $params[] = $baslangic_tarih;\r\n-            }\r\n-            \r\n-            if ($bitis_tarih) {\r\n-                $sql .= \" AND bo.odeme_tarihi <= ?\";\r\n-                $params[] = $bitis_tarih;\r\n-            }\r\n-            \r\n-            if ($durum) {\r\n-                $sql .= \" AND bo.durum = ?\";\r\n-                $params[] = $durum;\r\n-            }\r\n-            \r\n-            $sql .= \" ORDER BY bo.created_at DESC\";\r\n-            \r\n-            $stmt = $conn->prepare($sql);\r\n-            $stmt->execute($params);\r\n-            $payments = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n-            \r\n-            echo json_encode(['success' => true, 'data' => $payments]);\r\n-            exit;\r\n-        }\r\n-        \r\n-        if ($action === 'add_payment') {\r\n-            // Yeni ödeme ekle\r\n-            $user_id = $_POST['user_id'];\r\n-            $odeme_turu_id = $_POST['odeme_turu_id'];\r\n-            $tutar = $_POST['tutar'];\r\n-            $odeme_tarihi = $_POST['odeme_tarihi'];\r\n-            $aciklama = $_POST['aciklama'] ?? '';\r\n-            $referans_no = $_POST['referans_no'] ?? '';\r\n-            \r\n-            // Dosya yükleme işlemi\r\n-            $dekont_dosya_adi = null;\r\n-            $dosya_yolu = null;\r\n-            $dosya_boyutu = null;\r\n-            $dosya_tipi = null;\r\n-            \r\n-            if (isset($_FILES['dekont_dosya']) && $_FILES['dekont_dosya']['error'] === UPLOAD_ERR_OK) {\r\n-                $upload_dir = __DIR__ . '/uploads/dekontlar/';\r\n-                if (!is_dir($upload_dir)) {\r\n-                    mkdir($upload_dir, 0755, true);\r\n-                }\r\n+            if ($action === 'add_payment') {\r\n+                // Yeni ödeme ekle\r\n+                $user_id = $_POST['user_id'];\r\n+                $odeme_turu_id = $_POST['odeme_turu_id'];\r\n+                $tutar = $_POST['tutar'];\r\n+                $odeme_tarihi = $_POST['odeme_tarihi'];\r\n+                $aciklama = $_POST['aciklama'] ?? '';\r\n+                $referans_no = $_POST['referans_no'] ?? '';\r\n                 \r\n-                $file_info = pathinfo($_FILES['dekont_dosya']['name']);\r\n-                $extension = strtolower($file_info['extension']);\r\n-                $allowed_extensions = ['pdf', 'jpg', 'jpeg', 'png', 'doc', 'docx'];\r\n+                // Dosya yükleme işlemi\r\n+                $dekont_dosya_adi = null;\r\n+                $dosya_yolu = null;\r\n+                $dosya_boyutu = null;\r\n+                $dosya_tipi = null;\r\n                 \r\n-                if (in_array($extension, $allowed_extensions)) {\r\n-                    $unique_name = 'dekont_' . date('Y-m-d_H-i-s') . '_' . uniqid() . '.' . $extension;\r\n-                    $upload_path = $upload_dir . $unique_name;\r\n+                if (isset($_FILES['dekont_dosya']) && $_FILES['dekont_dosya']['error'] === UPLOAD_ERR_OK) {\r\n+                    $upload_dir = __DIR__ . '/uploads/dekontlar/';\r\n                     \r\n-                    if (move_uploaded_file($_FILES['dekont_dosya']['tmp_name'], $upload_path)) {\r\n-                        $dekont_dosya_adi = $_FILES['dekont_dosya']['name'];\r\n-                        $dosya_yolu = 'uploads/dekontlar/' . $unique_name;\r\n-                        $dosya_boyutu = $_FILES['dekont_dosya']['size'];\r\n-                        $dosya_tipi = $extension;\r\n+                    // Upload dizinini oluştur\r\n+                    if (!is_dir($upload_dir)) {\r\n+                        if (!mkdir($upload_dir, 0755, true)) {\r\n+                            echo json_encode(['success' => false, 'message' => 'Upload dizini oluşturulamadı']);\r\n+                            exit;\r\n+                        }\r\n                     }\r\n+                    \r\n+                    $file_info = pathinfo($_FILES['dekont_dosya']['name']);\r\n+                    $extension = strtolower($file_info['extension']);\r\n+                    $allowed_extensions = ['pdf', 'jpg', 'jpeg', 'png', 'doc', 'docx'];\r\n+                    \r\n+                    if (in_array($extension, $allowed_extensions)) {\r\n+                        $unique_name = 'dekont_' . date('Y-m-d_H-i-s') . '_' . uniqid() . '.' . $extension;\r\n+                        $upload_path = $upload_dir . $unique_name;\r\n+                        \r\n+                        if (move_uploaded_file($_FILES['dekont_dosya']['tmp_name'], $upload_path)) {\r\n+                            $dekont_dosya_adi = $_FILES['dekont_dosya']['name'];\r\n+                            $dosya_yolu = 'uploads/dekontlar/' . $unique_name;\r\n+                            $dosya_boyutu = $_FILES['dekont_dosya']['size'];\r\n+                            $dosya_tipi = $extension;\r\n+                        } else {\r\n+                            echo json_encode(['success' => false, 'message' => 'Dosya yüklenemedi']);\r\n+                            exit;\r\n+                        }\r\n+                    } else {\r\n+                        echo json_encode(['success' => false, 'message' => 'Desteklenmeyen dosya türü']);\r\n+                        exit;\r\n+                    }\r\n                 }\r\n-            }\r\n-            \r\n-            $sql = \"INSERT INTO bayi_odemeleri (\r\n-                        user_id, odeme_turu_id, tutar, odeme_tarihi, aciklama, \r\n-                        referans_no, olusturan_kullanici, dekont_dosya_adi, \r\n-                        dosya_yolu, dosya_boyutu, dosya_tipi\r\n-                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\";\r\n-            \r\n-            $stmt = $conn->prepare($sql);\r\n-            $result = $stmt->execute([\r\n-                $user_id, $odeme_turu_id, $tutar, $odeme_tarihi, $aciklama,\r\n-                $referans_no, $currentUser['name'], $dekont_dosya_adi,\r\n-                $dosya_yolu, $dosya_boyutu, $dosya_tipi\r\n-            ]);\r\n-            \r\n-            if ($result) {\r\n-                // Log kaydı - SQL Server için SCOPE_IDENTITY() kullan\r\n-                $odeme_id_result = $conn->query(\"SELECT SCOPE_IDENTITY() as id\");\r\n-                $odeme_id = $odeme_id_result->fetchColumn();\r\n                 \r\n-                if ($odeme_id) {\r\n-                    $log_sql = \"INSERT INTO odeme_logları (odeme_id, islem_tipi, yeni_durum, kullanici, aciklama) \r\n-                               VALUES (?, 'OLUSTURULDU', 'BEKLEMEDE', ?, 'Ödeme kaydı oluşturuldu')\";\r\n-                    $conn->prepare($log_sql)->execute([$odeme_id, $currentUser['name']]);\r\n+                $sql = \"INSERT INTO bayi_odemeleri (\r\n+                            user_id, odeme_turu_id, tutar, odeme_tarihi, aciklama, \r\n+                            referans_no, olusturan_kullanici, dekont_dosya_adi, \r\n+                            dosya_yolu, dosya_boyutu, dosya_tipi, durum\r\n+                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'BEKLEMEDE')\";\r\n+                \r\n+                $stmt = $conn->prepare($sql);\r\n+                $result = $stmt->execute([\r\n+                    $user_id, $odeme_turu_id, $tutar, $odeme_tarihi, $aciklama,\r\n+                    $referans_no, $currentUser['name'], $dekont_dosya_adi,\r\n+                    $dosya_yolu, $dosya_boyutu, $dosya_tipi\r\n+                ]);\r\n+                \r\n+                if ($result) {\r\n+                    // Log kaydı - SQL Server için SCOPE_IDENTITY() kullan\r\n+                    $odeme_id_result = $conn->query(\"SELECT SCOPE_IDENTITY() as id\");\r\n+                    $odeme_id = $odeme_id_result->fetchColumn();\r\n+                    \r\n+                    if ($odeme_id) {\r\n+                        $log_sql = \"INSERT INTO odeme_logları (odeme_id, islem_tipi, yeni_durum, kullanici, aciklama) \r\n+                                   VALUES (?, 'OLUSTURULDU', 'BEKLEMEDE', ?, 'Ödeme kaydı oluşturuldu')\";\r\n+                        $conn->prepare($log_sql)->execute([$odeme_id, $currentUser['name']]);\r\n+                    }\r\n+                    \r\n+                    echo json_encode(['success' => true, 'message' => 'Ödeme kaydı başarıyla eklendi']);\r\n+                } else {\r\n+                    echo json_encode(['success' => false, 'message' => 'Ödeme kaydı eklenirken hata oluştu']);\r\n                 }\r\n-                \r\n-                echo json_encode(['success' => true, 'message' => 'Ödeme kaydı başarıyla eklendi']);\r\n-            } else {\r\n-                echo json_encode(['success' => false, 'message' => 'Ödeme kaydı eklenirken hata oluştu']);\r\n+                exit;\r\n             }\r\n             \r\n         } catch (Exception $e) {\r\n             echo json_encode([\r\n@@ -234,8 +319,18 @@\n     $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n }\r\n \r\n include 'includes/header.php';\r\n+\r\n+// Hata mesajını göster\r\n+if (isset($error)) {\r\n+    echo '<div class=\"container-fluid mt-3\">';\r\n+    echo '<div class=\"alert alert-danger alert-dismissible fade show\" role=\"alert\">';\r\n+    echo '<strong>Hata!</strong> ' . htmlspecialchars($error);\r\n+    echo '<button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>';\r\n+    echo '</div>';\r\n+    echo '</div>';\r\n+}\r\n ?>\r\n \r\n <div class=\"container-fluid mt-4\">\r\n     <div class=\"row\">\r\n@@ -487,8 +582,14 @@\n     // Yeni ödeme formu submit\r\n     $('#addPaymentForm').on('submit', function(e) {\r\n         e.preventDefault();\r\n         \r\n+        const submitBtn = $(this).find('button[type=\"submit\"]');\r\n+        const originalText = submitBtn.html();\r\n+        \r\n+        // Submit button'u disable et\r\n+        submitBtn.prop('disabled', true).html('<i class=\"fas fa-spinner fa-spin me-2\"></i>Kaydediliyor...');\r\n+        \r\n         const formData = new FormData(this);\r\n         formData.append('action', 'add_payment');\r\n         \r\n         $.ajax({\r\n@@ -496,22 +597,49 @@\n             type: 'POST',\r\n             data: formData,\r\n             processData: false,\r\n             contentType: false,\r\n+            timeout: 30000,\r\n             success: function(response) {\r\n-                if (response.success) {\r\n+                console.log('Add payment response:', response);\r\n+                \r\n+                // JSON parse et eğer string ise\r\n+                if (typeof response === 'string') {\r\n+                    try {\r\n+                        response = JSON.parse(response);\r\n+                    } catch (e) {\r\n+                        console.error('JSON parse error:', e);\r\n+                        showAlert('danger', 'Sunucu cevabı işlenemedi');\r\n+                        return;\r\n+                    }\r\n+                }\r\n+                \r\n+                if (response && response.success) {\r\n                     $('#addPaymentModal').modal('hide');\r\n                     $('#addPaymentForm')[0].reset();\r\n                     loadPayments();\r\n-                    \r\n-                    // Başarı mesajı göster\r\n-                    showAlert('success', response.message);\r\n+                    showAlert('success', response.message || 'İşlem başarılı');\r\n                 } else {\r\n-                    showAlert('danger', response.message);\r\n+                    showAlert('danger', response.message || 'İşlem başarısız');\r\n                 }\r\n             },\r\n-            error: function() {\r\n-                showAlert('danger', 'İşlem sırasında bir hata oluştu');\r\n+            error: function(xhr, status, error) {\r\n+                console.error('AJAX Error:', xhr.responseText, status, error);\r\n+                let errorMessage = 'İşlem sırasında hata oluştu: ';\r\n+                \r\n+                if (xhr.status === 500) {\r\n+                    errorMessage += 'Sunucu hatası (HTTP 500)';\r\n+                } else if (xhr.status === 0) {\r\n+                    errorMessage += 'Bağlantı hatası';\r\n+                } else {\r\n+                    errorMessage += error;\r\n+                }\r\n+                \r\n+                showAlert('danger', errorMessage);\r\n+            },\r\n+            complete: function() {\r\n+                // Submit button'u tekrar aktif et\r\n+                submitBtn.prop('disabled', false).html(originalText);\r\n             }\r\n         });\r\n     });\r\n     \r\n@@ -520,29 +648,50 @@\n         formData.append('action', 'get_payments');\r\n         \r\n         console.log('Loading payments...');\r\n         \r\n+        // Show loading state\r\n+        const tbody = $('#paymentsTableBody');\r\n+        tbody.html(`\r\n+            <tr>\r\n+                <td colspan=\"8\" class=\"text-center py-4\">\r\n+                    <i class=\"fas fa-spinner fa-spin fa-2x text-muted\"></i>\r\n+                    <p class=\"mt-2 text-muted\">Veriler yükleniyor...</p>\r\n+                </td>\r\n+            </tr>\r\n+        `);\r\n+        \r\n         $.ajax({\r\n             url: '',\r\n             type: 'POST',\r\n             data: formData,\r\n             processData: false,\r\n             contentType: false,\r\n             dataType: 'json',\r\n+            timeout: 30000, // 30 second timeout\r\n             success: function(response) {\r\n                 console.log('Load payments response:', response);\r\n-                if (response.success) {\r\n-                    displayPayments(response.data);\r\n+                if (response && response.success) {\r\n+                    displayPayments(response.data || []);\r\n                 } else {\r\n                     showAlert('danger', 'Veriler yüklenirken hata oluştu: ' + (response.message || 'Bilinmeyen hata'));\r\n                     console.error('Response error:', response);\r\n+                    displayPayments([]);\r\n                 }\r\n             },\r\n             error: function(xhr, status, error) {\r\n-                console.error('AJAX Error:', xhr.responseText);\r\n-                showAlert('danger', 'Veriler yüklenirken hata oluştu: ' + error);\r\n+                console.error('AJAX Error:', xhr.responseText, status, error);\r\n+                let errorMessage = 'Veriler yüklenirken hata oluştu: ';\r\n                 \r\n-                // Hata durumunda boş tablo göster\r\n+                if (xhr.status === 500) {\r\n+                    errorMessage += 'Sunucu hatası (HTTP 500)';\r\n+                } else if (xhr.status === 0) {\r\n+                    errorMessage += 'Bağlantı hatası';\r\n+                } else {\r\n+                    errorMessage += error;\r\n+                }\r\n+                \r\n+                showAlert('danger', errorMessage);\r\n                 displayPayments([]);\r\n             }\r\n         });\r\n     }\r\n@@ -550,9 +699,9 @@\n     function displayPayments(payments) {\r\n         const tbody = $('#paymentsTableBody');\r\n         tbody.empty();\r\n         \r\n-        if (payments.length === 0) {\r\n+        if (!payments || payments.length === 0) {\r\n             tbody.html(`\r\n                 <tr>\r\n                     <td colspan=\"8\" class=\"text-center py-4\">\r\n                         <i class=\"fas fa-inbox fa-3x text-muted mb-3 d-block\"></i>\r\n@@ -573,24 +722,24 @@\n             const row = `\r\n                 <tr>\r\n                     <td>\r\n                         <div>\r\n-                            <strong>${payment.bayi_adi}</strong><br>\r\n-                            <small class=\"text-muted\">${payment.bayi_email}</small>\r\n+                            <strong>${payment.bayi_adi || 'N/A'}</strong><br>\r\n+                            <small class=\"text-muted\">${payment.bayi_email || 'N/A'}</small>\r\n                         </div>\r\n                     </td>\r\n                     <td>\r\n-                        <span class=\"badge\" style=\"background-color: ${payment.renk_kodu}\">\r\n-                            <i class=\"fas ${payment.ikon} me-1\"></i>\r\n-                            ${payment.tur_adi}\r\n+                        <span class=\"badge\" style=\"background-color: ${payment.renk_kodu || '#6c757d'}\">\r\n+                            <i class=\"fas ${payment.ikon || 'fa-money-bill'} me-1\"></i>\r\n+                            ${payment.tur_adi || 'N/A'}\r\n                         </span>\r\n                     </td>\r\n                     <td>\r\n                         <strong class=\"${payment.tutar >= 0 ? 'text-success' : 'text-danger'}\">\r\n-                            ₺${parseFloat(payment.tutar).toLocaleString('tr-TR', {minimumFractionDigits: 2})}\r\n+                            ₺${parseFloat(payment.tutar || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}\r\n                         </strong>\r\n                     </td>\r\n-                    <td>${new Date(payment.odeme_tarihi).toLocaleDateString('tr-TR')}</td>\r\n+                    <td>${payment.odeme_tarihi ? new Date(payment.odeme_tarihi).toLocaleDateString('tr-TR') : 'N/A'}</td>\r\n                     <td>${payment.referans_no || '-'}</td>\r\n                     <td>${statusBadge}</td>\r\n                     <td class=\"text-center\">${dekontLink}</td>\r\n                     <td>\r\n"
                },
                {
                    "date": 1760620452627,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -198,8 +198,73 @@\n                 echo json_encode(['success' => true, 'data' => $payments]);\r\n                 exit;\r\n             }\r\n             \r\n+            if ($action === 'find_bayi_by_abone_no') {\r\n+                // Abone numarasına göre bayi bul\r\n+                $abone_no = $_POST['abone_no'] ?? '';\r\n+                \r\n+                if (empty($abone_no)) {\r\n+                    echo json_encode(['success' => false, 'message' => 'Abone numarası boş olamaz']);\r\n+                    exit;\r\n+                }\r\n+                \r\n+                // İris rapor tablosunda abone numarasını ara\r\n+                $iris_sql = \"SELECT TOP 1 TALEBI_GIREN_PERSONELNO \r\n+                            FROM digiturk.iris_rapor \r\n+                            WHERE DT_MUSTERI_NO LIKE ? \r\n+                            ORDER BY eklenme_tarihi DESC\";\r\n+                \r\n+                $iris_stmt = $conn->prepare($iris_sql);\r\n+                $iris_stmt->execute(['%' . $abone_no . '%']);\r\n+                $iris_result = $iris_stmt->fetch(PDO::FETCH_ASSOC);\r\n+                \r\n+                if (!$iris_result) {\r\n+                    echo json_encode(['success' => false, 'message' => 'Bu abone numarası için kayıt bulunamadı']);\r\n+                    exit;\r\n+                }\r\n+                \r\n+                $personel_no = $iris_result['TALEBI_GIREN_PERSONELNO'];\r\n+                \r\n+                // Users_bayi tablosunda personel kimlik numarasını ara\r\n+                $bayi_sql = \"SELECT user_id \r\n+                            FROM users_bayi \r\n+                            WHERE personel_kimlik_no = ?\";\r\n+                \r\n+                $bayi_stmt = $conn->prepare($bayi_sql);\r\n+                $bayi_stmt->execute([$personel_no]);\r\n+                $bayi_result = $bayi_stmt->fetch(PDO::FETCH_ASSOC);\r\n+                \r\n+                if (!$bayi_result) {\r\n+                    echo json_encode(['success' => false, 'message' => 'Bu personel numarası için bayi bulunamadı']);\r\n+                    exit;\r\n+                }\r\n+                \r\n+                $user_id = $bayi_result['user_id'];\r\n+                \r\n+                // Users tablosundan bayi bilgilerini getir\r\n+                $user_sql = \"SELECT u.id, u.first_name + ' ' + u.last_name as name, u.email\r\n+                            FROM users u\r\n+                            INNER JOIN user_groups ug ON u.user_group_id = ug.id\r\n+                            WHERE u.id = ? AND ug.group_name = 'bayi' AND u.status = 'AKTIF'\";\r\n+                \r\n+                $user_stmt = $conn->prepare($user_sql);\r\n+                $user_stmt->execute([$user_id]);\r\n+                $user_result = $user_stmt->fetch(PDO::FETCH_ASSOC);\r\n+                \r\n+                if (!$user_result) {\r\n+                    echo json_encode(['success' => false, 'message' => 'Bayi bulunamadı veya aktif değil']);\r\n+                    exit;\r\n+                }\r\n+                \r\n+                echo json_encode([\r\n+                    'success' => true, \r\n+                    'data' => $user_result,\r\n+                    'message' => 'Bayi bulundu: ' . $user_result['name']\r\n+                ]);\r\n+                exit;\r\n+            }\r\n+            \r\n             if ($action === 'add_payment') {\r\n                 // Yeni ödeme ekle\r\n                 $user_id = $_POST['user_id'];\r\n                 $odeme_turu_id = $_POST['odeme_turu_id'];\r\n@@ -506,12 +571,32 @@\n                 <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n             </div>\r\n             <form id=\"addPaymentForm\" enctype=\"multipart/form-data\">\r\n                 <div class=\"modal-body\">\r\n+                    <!-- Abone No ile Bayi Arama -->\r\n+                    <div class=\"card mb-3 bg-light\">\r\n+                        <div class=\"card-body\">\r\n+                            <h6 class=\"card-title text-primary\">\r\n+                                <i class=\"fas fa-search me-2\"></i>Abone No ile Bayi Bul\r\n+                            </h6>\r\n+                            <div class=\"row g-2\">\r\n+                                <div class=\"col-md-8\">\r\n+                                    <input type=\"text\" class=\"form-control\" id=\"aboneNoInput\" placeholder=\"Abone numarasını giriniz...\">\r\n+                                </div>\r\n+                                <div class=\"col-md-4\">\r\n+                                    <button type=\"button\" class=\"btn btn-outline-primary w-100\" id=\"findBayiBtn\">\r\n+                                        <i class=\"fas fa-search me-2\"></i>Bul\r\n+                                    </button>\r\n+                                </div>\r\n+                            </div>\r\n+                            <div id=\"bayiSearchResult\" class=\"mt-2\"></div>\r\n+                        </div>\r\n+                    </div>\r\n+                    \r\n                     <div class=\"row g-3\">\r\n                         <div class=\"col-md-6\">\r\n                             <label class=\"form-label\">Bayi <span class=\"text-danger\">*</span></label>\r\n-                            <select class=\"form-select\" name=\"user_id\" required>\r\n+                            <select class=\"form-select\" name=\"user_id\" id=\"bayiSelect\" required>\r\n                                 <option value=\"\">Bayi Seçin</option>\r\n                                 <?php foreach ($bayiler as $bayi): ?>\r\n                                     <option value=\"<?php echo $bayi['id']; ?>\"><?php echo htmlspecialchars($bayi['name']); ?></option>\r\n                                 <?php endforeach; ?>\r\n@@ -562,13 +647,110 @@\n         </div>\r\n     </div>\r\n </div>\r\n \r\n+<style>\r\n+.alert-sm {\r\n+    padding: 0.5rem 0.75rem;\r\n+    font-size: 0.875rem;\r\n+}\r\n+\r\n+.bg-light {\r\n+    background-color: #f8f9fa !important;\r\n+}\r\n+\r\n+#bayiSearchResult .alert {\r\n+    margin-bottom: 0;\r\n+}\r\n+\r\n+.card-title {\r\n+    margin-bottom: 0.75rem;\r\n+    font-weight: 600;\r\n+}\r\n+</style>\r\n+\r\n <script>\r\n $(document).ready(function() {\r\n+$(document).ready(function() {\r\n     // Sayfa yüklendiğinde ödemeleri getir\r\n     loadPayments();\r\n     \r\n+    // Abone No ile bayi bulma\r\n+    $('#findBayiBtn').on('click', function() {\r\n+        const aboneNo = $('#aboneNoInput').val().trim();\r\n+        const resultDiv = $('#bayiSearchResult');\r\n+        const btn = $(this);\r\n+        const originalText = btn.html();\r\n+        \r\n+        if (!aboneNo) {\r\n+            resultDiv.html('<div class=\"alert alert-warning alert-sm mb-0\">Lütfen abone numarasını giriniz</div>');\r\n+            return;\r\n+        }\r\n+        \r\n+        // Buton durumunu değiştir\r\n+        btn.prop('disabled', true).html('<i class=\"fas fa-spinner fa-spin me-2\"></i>Aranıyor...');\r\n+        resultDiv.html('');\r\n+        \r\n+        $.ajax({\r\n+            url: '',\r\n+            type: 'POST',\r\n+            data: {\r\n+                action: 'find_bayi_by_abone_no',\r\n+                abone_no: aboneNo\r\n+            },\r\n+            dataType: 'json',\r\n+            success: function(response) {\r\n+                if (response && response.success) {\r\n+                    // Bayi bulundu, dropdown'da seç\r\n+                    $('#bayiSelect').val(response.data.id);\r\n+                    \r\n+                    resultDiv.html(`\r\n+                        <div class=\"alert alert-success alert-sm mb-0\">\r\n+                            <i class=\"fas fa-check-circle me-2\"></i>\r\n+                            <strong>Bayi Bulundu:</strong> ${response.data.name}\r\n+                            <br><small class=\"text-muted\">${response.data.email}</small>\r\n+                        </div>\r\n+                    `);\r\n+                } else {\r\n+                    resultDiv.html(`\r\n+                        <div class=\"alert alert-danger alert-sm mb-0\">\r\n+                            <i class=\"fas fa-exclamation-circle me-2\"></i>\r\n+                            ${response.message || 'Bayi bulunamadı'}\r\n+                        </div>\r\n+                    `);\r\n+                }\r\n+            },\r\n+            error: function(xhr, status, error) {\r\n+                console.error('Bayi arama hatası:', xhr.responseText, status, error);\r\n+                resultDiv.html(`\r\n+                    <div class=\"alert alert-danger alert-sm mb-0\">\r\n+                        <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n+                        Arama sırasında hata oluştu: ${error}\r\n+                    </div>\r\n+                `);\r\n+            },\r\n+            complete: function() {\r\n+                // Buton durumunu eski haline getir\r\n+                btn.prop('disabled', false).html(originalText);\r\n+            }\r\n+        });\r\n+    });\r\n+    \r\n+    // Enter tuşu ile arama\r\n+    $('#aboneNoInput').on('keypress', function(e) {\r\n+        if (e.which === 13) { // Enter tuşu\r\n+            e.preventDefault();\r\n+            $('#findBayiBtn').click();\r\n+        }\r\n+    });\r\n+    \r\n+    // Modal kapanırken arama sonuçlarını temizle\r\n+    $('#addPaymentModal').on('hidden.bs.modal', function() {\r\n+        $('#aboneNoInput').val('');\r\n+        $('#bayiSearchResult').html('');\r\n+        $('#bayiSelect').val('');\r\n+    });\r\n+    \r\n     // Filtre formu submit\r\n     $('#filterForm').on('submit', function(e) {\r\n         e.preventDefault();\r\n         loadPayments();\r\n"
                },
                {
                    "date": 1760620659679,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,56 +53,8 @@\n         created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n         updated_at DATETIME2 NULL\r\n     );\r\n \r\n-    -- Bayi ödemeleri tablosu\r\n-    IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='bayi_odemeleri' AND xtype='U')\r\n-    CREATE TABLE bayi_odemeleri (\r\n-        id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n-        user_id INT NOT NULL,\r\n-        odeme_turu_id INT NOT NULL,\r\n-        tutar DECIMAL(15,2) NOT NULL,\r\n-        odeme_tarihi DATE NOT NULL,\r\n-        aciklama NVARCHAR(1000),\r\n-        referans_no NVARCHAR(100),\r\n-        durum NVARCHAR(20) DEFAULT 'BEKLEMEDE',\r\n-        dekont_dosya_adi NVARCHAR(255),\r\n-        dosya_yolu NVARCHAR(500),\r\n-        dosya_boyutu BIGINT,\r\n-        dosya_tipi NVARCHAR(10),\r\n-        olusturan_kullanici NVARCHAR(100),\r\n-        onaylayan_kullanici NVARCHAR(100),\r\n-        onay_tarihi DATETIME2,\r\n-        created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n-        updated_at DATETIME2 NULL,\r\n-        FOREIGN KEY (user_id) REFERENCES users(id),\r\n-        FOREIGN KEY (odeme_turu_id) REFERENCES odeme_turleri(id)\r\n-    );\r\n-\r\n-    -- Ödeme logları tablosu\r\n-    IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='odeme_logları' AND xtype='U')\r\n-    CREATE TABLE odeme_logları (\r\n-        id BIGINT IDENTITY(1,1) PRIMARY KEY,\r\n-        odeme_id BIGINT NOT NULL,\r\n-        islem_tipi NVARCHAR(50) NOT NULL,\r\n-        eski_durum NVARCHAR(20),\r\n-        yeni_durum NVARCHAR(20),\r\n-        kullanici NVARCHAR(100) NOT NULL,\r\n-        aciklama NVARCHAR(1000),\r\n-        created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n-        FOREIGN KEY (odeme_id) REFERENCES bayi_odemeleri(id)\r\n-    );\r\n-\r\n-    -- İndeksler oluştur\r\n-    IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('bayi_odemeleri') AND name = 'IX_bayi_odemeleri_user_id')\r\n-    CREATE INDEX IX_bayi_odemeleri_user_id ON bayi_odemeleri (user_id);\r\n-\r\n-    IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('bayi_odemeleri') AND name = 'IX_bayi_odemeleri_odeme_tarihi')\r\n-    CREATE INDEX IX_bayi_odemeleri_odeme_tarihi ON bayi_odemeleri (odeme_tarihi);\r\n-\r\n-    IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('bayi_odemeleri') AND name = 'IX_bayi_odemeleri_durum')\r\n-    CREATE INDEX IX_bayi_odemeleri_durum ON bayi_odemeleri (durum);\r\n-\r\n     -- Varsayılan ödeme türlerini ekle\r\n     IF NOT EXISTS (SELECT 1 FROM odeme_turleri)\r\n     BEGIN\r\n         INSERT INTO odeme_turleri (tur_adi, aciklama, renk_kodu, ikon) VALUES \r\n@@ -139,59 +91,52 @@\n                 $bayi_id = $_POST['bayi_id'] ?? '';\r\n                 $odeme_turu = $_POST['odeme_turu'] ?? '';\r\n                 $baslangic_tarih = $_POST['baslangic_tarih'] ?? '';\r\n                 $bitis_tarih = $_POST['bitis_tarih'] ?? '';\r\n-                $durum = $_POST['durum'] ?? '';\r\n                 \r\n                 $sql = \"SELECT \r\n-                            bo.id,\r\n+                            bho.id,\r\n                             u.first_name + ' ' + u.last_name as bayi_adi,\r\n                             u.email as bayi_email,\r\n                             ot.tur_adi,\r\n                             ot.renk_kodu,\r\n                             ot.ikon,\r\n-                            bo.tutar,\r\n-                            bo.odeme_tarihi,\r\n-                            bo.aciklama,\r\n-                            bo.referans_no,\r\n-                            bo.durum,\r\n-                            bo.dekont_dosya_adi,\r\n-                            bo.dosya_yolu,\r\n-                            bo.created_at\r\n-                        FROM bayi_odemeleri bo\r\n-                        INNER JOIN users u ON bo.user_id = u.id\r\n-                        INNER JOIN odeme_turleri ot ON bo.odeme_turu_id = ot.id\r\n+                            bho.odeme_tutari,\r\n+                            bho.odeme_tarihi,\r\n+                            bho.aciklama,\r\n+                            bho.evrak_dosya_adi,\r\n+                            bho.evrak_dosya_yolu,\r\n+                            bho.created_at,\r\n+                            bho.created_by\r\n+                        FROM bayi_hakedis_odeme bho\r\n+                        INNER JOIN users u ON bho.user_id = u.id\r\n+                        INNER JOIN odeme_turleri ot ON bho.odeme_turu_id = ot.id\r\n                         WHERE 1=1\";\r\n                 \r\n                 $params = [];\r\n                 \r\n                 if ($bayi_id) {\r\n-                    $sql .= \" AND bo.user_id = ?\";\r\n+                    $sql .= \" AND bho.user_id = ?\";\r\n                     $params[] = $bayi_id;\r\n                 }\r\n                 \r\n                 if ($odeme_turu) {\r\n-                    $sql .= \" AND bo.odeme_turu_id = ?\";\r\n+                    $sql .= \" AND bho.odeme_turu_id = ?\";\r\n                     $params[] = $odeme_turu;\r\n                 }\r\n                 \r\n                 if ($baslangic_tarih) {\r\n-                    $sql .= \" AND bo.odeme_tarihi >= ?\";\r\n+                    $sql .= \" AND bho.odeme_tarihi >= ?\";\r\n                     $params[] = $baslangic_tarih;\r\n                 }\r\n                 \r\n                 if ($bitis_tarih) {\r\n-                    $sql .= \" AND bo.odeme_tarihi <= ?\";\r\n+                    $sql .= \" AND bho.odeme_tarihi <= ?\";\r\n                     $params[] = $bitis_tarih;\r\n                 }\r\n                 \r\n-                if ($durum) {\r\n-                    $sql .= \" AND bo.durum = ?\";\r\n-                    $params[] = $durum;\r\n-                }\r\n+                $sql .= \" ORDER BY bho.created_at DESC\";\r\n                 \r\n-                $sql .= \" ORDER BY bo.created_at DESC\";\r\n-                \r\n                 $stmt = $conn->prepare($sql);\r\n                 $stmt->execute($params);\r\n                 $payments = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n                 \r\n@@ -267,18 +212,16 @@\n             if ($action === 'add_payment') {\r\n                 // Yeni ödeme ekle\r\n                 $user_id = $_POST['user_id'];\r\n                 $odeme_turu_id = $_POST['odeme_turu_id'];\r\n-                $tutar = $_POST['tutar'];\r\n+                $odeme_tutari = $_POST['tutar'];\r\n                 $odeme_tarihi = $_POST['odeme_tarihi'];\r\n                 $aciklama = $_POST['aciklama'] ?? '';\r\n-                $referans_no = $_POST['referans_no'] ?? '';\r\n                 \r\n                 // Dosya yükleme işlemi\r\n-                $dekont_dosya_adi = null;\r\n-                $dosya_yolu = null;\r\n-                $dosya_boyutu = null;\r\n-                $dosya_tipi = null;\r\n+                $evrak_dosya_adi = null;\r\n+                $evrak_dosya_yolu = null;\r\n+                $evrak_dosya_boyutu = null;\r\n                 \r\n                 if (isset($_FILES['dekont_dosya']) && $_FILES['dekont_dosya']['error'] === UPLOAD_ERR_OK) {\r\n                     $upload_dir = __DIR__ . '/uploads/dekontlar/';\r\n                     \r\n@@ -298,12 +241,11 @@\n                         $unique_name = 'dekont_' . date('Y-m-d_H-i-s') . '_' . uniqid() . '.' . $extension;\r\n                         $upload_path = $upload_dir . $unique_name;\r\n                         \r\n                         if (move_uploaded_file($_FILES['dekont_dosya']['tmp_name'], $upload_path)) {\r\n-                            $dekont_dosya_adi = $_FILES['dekont_dosya']['name'];\r\n-                            $dosya_yolu = 'uploads/dekontlar/' . $unique_name;\r\n-                            $dosya_boyutu = $_FILES['dekont_dosya']['size'];\r\n-                            $dosya_tipi = $extension;\r\n+                            $evrak_dosya_adi = $_FILES['dekont_dosya']['name'];\r\n+                            $evrak_dosya_yolu = 'uploads/dekontlar/' . $unique_name;\r\n+                            $evrak_dosya_boyutu = $_FILES['dekont_dosya']['size'];\r\n                         } else {\r\n                             echo json_encode(['success' => false, 'message' => 'Dosya yüklenemedi']);\r\n                             exit;\r\n                         }\r\n@@ -312,32 +254,20 @@\n                         exit;\r\n                     }\r\n                 }\r\n                 \r\n-                $sql = \"INSERT INTO bayi_odemeleri (\r\n-                            user_id, odeme_turu_id, tutar, odeme_tarihi, aciklama, \r\n-                            referans_no, olusturan_kullanici, dekont_dosya_adi, \r\n-                            dosya_yolu, dosya_boyutu, dosya_tipi, durum\r\n-                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'BEKLEMEDE')\";\r\n+                $sql = \"INSERT INTO bayi_hakedis_odeme (\r\n+                            user_id, odeme_turu_id, odeme_tutari, odeme_tarihi, aciklama, \r\n+                            evrak_dosya_adi, evrak_dosya_yolu, evrak_dosya_boyutu, created_by\r\n+                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\";\r\n                 \r\n                 $stmt = $conn->prepare($sql);\r\n                 $result = $stmt->execute([\r\n-                    $user_id, $odeme_turu_id, $tutar, $odeme_tarihi, $aciklama,\r\n-                    $referans_no, $currentUser['name'], $dekont_dosya_adi,\r\n-                    $dosya_yolu, $dosya_boyutu, $dosya_tipi\r\n+                    $user_id, $odeme_turu_id, $odeme_tutari, $odeme_tarihi, $aciklama,\r\n+                    $evrak_dosya_adi, $evrak_dosya_yolu, $evrak_dosya_boyutu, $currentUser['name']\r\n                 ]);\r\n                 \r\n                 if ($result) {\r\n-                    // Log kaydı - SQL Server için SCOPE_IDENTITY() kullan\r\n-                    $odeme_id_result = $conn->query(\"SELECT SCOPE_IDENTITY() as id\");\r\n-                    $odeme_id = $odeme_id_result->fetchColumn();\r\n-                    \r\n-                    if ($odeme_id) {\r\n-                        $log_sql = \"INSERT INTO odeme_logları (odeme_id, islem_tipi, yeni_durum, kullanici, aciklama) \r\n-                                   VALUES (?, 'OLUSTURULDU', 'BEKLEMEDE', ?, 'Ödeme kaydı oluşturuldu')\";\r\n-                        $conn->prepare($log_sql)->execute([$odeme_id, $currentUser['name']]);\r\n-                    }\r\n-                    \r\n                     echo json_encode(['success' => true, 'message' => 'Ödeme kaydı başarıyla eklendi']);\r\n                 } else {\r\n                     echo json_encode(['success' => false, 'message' => 'Ödeme kaydı eklenirken hata oluştu']);\r\n                 }\r\n@@ -371,12 +301,12 @@\n     \r\n     // Özet istatistikleri\r\n     $stats_sql = \"SELECT \r\n                     COUNT(*) as toplam_islem,\r\n-                    SUM(CASE WHEN tutar > 0 THEN tutar ELSE 0 END) as toplam_odeme,\r\n-                    SUM(CASE WHEN tutar < 0 THEN ABS(tutar) ELSE 0 END) as toplam_kesinti,\r\n-                    COUNT(CASE WHEN durum = 'BEKLEMEDE' THEN 1 END) as bekleyen_islem\r\n-                  FROM bayi_odemeleri\";\r\n+                    SUM(CASE WHEN odeme_tutari > 0 THEN odeme_tutari ELSE 0 END) as toplam_odeme,\r\n+                    SUM(CASE WHEN odeme_tutari < 0 THEN ABS(odeme_tutari) ELSE 0 END) as toplam_kesinti,\r\n+                    COUNT(CASE WHEN created_at >= CAST(GETDATE() AS DATE) THEN 1 END) as bugun_islem\r\n+                  FROM bayi_hakedis_odeme\";\r\n     $stats_stmt = $conn->prepare($stats_sql);\r\n     $stats_stmt->execute();\r\n     $stats = $stats_stmt->fetch(PDO::FETCH_ASSOC);\r\n     \r\n@@ -452,13 +382,13 @@\n         \r\n         <div class=\"col-md-3\">\r\n             <div class=\"card border-0 shadow-sm\">\r\n                 <div class=\"card-body text-center\">\r\n-                    <div class=\"text-warning mb-3\">\r\n-                        <i class=\"fas fa-clock fa-3x\"></i>\r\n+                    <div class=\"text-info mb-3\">\r\n+                        <i class=\"fas fa-calendar-day fa-3x\"></i>\r\n                     </div>\r\n-                    <h3 class=\"text-warning\"><?php echo number_format($stats['bekleyen_islem'] ?? 0); ?></h3>\r\n-                    <p class=\"text-muted mb-0\">Bekleyen İşlem</p>\r\n+                    <h3 class=\"text-info\"><?php echo number_format($stats['bugun_islem'] ?? 0); ?></h3>\r\n+                    <p class=\"text-muted mb-0\">Bugünkü İşlem</p>\r\n                 </div>\r\n             </div>\r\n         </div>\r\n     </div>\r\n@@ -498,18 +428,8 @@\n                     <div class=\"col-md-2\">\r\n                         <label class=\"form-label\">Bitiş Tarihi</label>\r\n                         <input type=\"date\" class=\"form-control\" name=\"bitis_tarih\">\r\n                     </div>\r\n-                    <div class=\"col-md-2\">\r\n-                        <label class=\"form-label\">Durum</label>\r\n-                        <select class=\"form-select\" name=\"durum\">\r\n-                            <option value=\"\">Tüm Durumlar</option>\r\n-                            <option value=\"BEKLEMEDE\">Beklemede</option>\r\n-                            <option value=\"ONAYLANDI\">Onaylandı</option>\r\n-                            <option value=\"ODENDI\">Ödendi</option>\r\n-                            <option value=\"IPTAL\">İptal</option>\r\n-                        </select>\r\n-                    </div>\r\n                 </div>\r\n                 <div class=\"row mt-3\">\r\n                     <div class=\"col-12\">\r\n                         <button type=\"submit\" class=\"btn btn-primary\">\r\n@@ -539,17 +459,16 @@\n                             <th>Bayi</th>\r\n                             <th>Ödeme Türü</th>\r\n                             <th>Tutar</th>\r\n                             <th>Tarih</th>\r\n-                            <th>Referans No</th>\r\n-                            <th>Durum</th>\r\n-                            <th>Dekont</th>\r\n+                            <th>Evrak</th>\r\n+                            <th>Oluşturan</th>\r\n                             <th>İşlemler</th>\r\n                         </tr>\r\n                     </thead>\r\n                     <tbody id=\"paymentsTableBody\">\r\n                         <tr>\r\n-                            <td colspan=\"8\" class=\"text-center py-4\">\r\n+                            <td colspan=\"7\" class=\"text-center py-4\">\r\n                                 <i class=\"fas fa-spinner fa-spin fa-2x text-muted\"></i>\r\n                                 <p class=\"mt-2 text-muted\">Veriler yükleniyor...</p>\r\n                             </td>\r\n                         </tr>\r\n@@ -623,9 +542,10 @@\n                             <input type=\"date\" class=\"form-control\" name=\"odeme_tarihi\" value=\"<?php echo date('Y-m-d'); ?>\" required>\r\n                         </div>\r\n                         <div class=\"col-md-6\">\r\n                             <label class=\"form-label\">Referans No</label>\r\n-                            <input type=\"text\" class=\"form-control\" name=\"referans_no\" placeholder=\"Fiş no, dekont no vb.\">\r\n+                            <input type=\"text\" class=\"form-control\" name=\"referans_no\" placeholder=\"Açıklama alanında belirtiniz\">\r\n+                            <div class=\"form-text\">Bu alan kullanılmıyor, açıklama alanını kullanın</div>\r\n                         </div>\r\n                         <div class=\"col-md-6\">\r\n                             <label class=\"form-label\">Dekont/Belge</label>\r\n                             <input type=\"file\" class=\"form-control\" name=\"dekont_dosya\" accept=\".pdf,.jpg,.jpeg,.png,.doc,.docx\">\r\n@@ -884,9 +804,9 @@\n         \r\n         if (!payments || payments.length === 0) {\r\n             tbody.html(`\r\n                 <tr>\r\n-                    <td colspan=\"8\" class=\"text-center py-4\">\r\n+                    <td colspan=\"7\" class=\"text-center py-4\">\r\n                         <i class=\"fas fa-inbox fa-3x text-muted mb-3 d-block\"></i>\r\n                         <p class=\"text-muted\">Hiç ödeme kaydı bulunamadı</p>\r\n                     </td>\r\n                 </tr>\r\n@@ -894,11 +814,10 @@\n             return;\r\n         }\r\n         \r\n         payments.forEach(function(payment) {\r\n-            const statusBadge = getStatusBadge(payment.durum);\r\n-            const dekontLink = payment.dekont_dosya_adi ? \r\n-                `<a href=\"${payment.dosya_yolu}\" target=\"_blank\" class=\"btn btn-sm btn-outline-info\">\r\n+            const evrakLink = payment.evrak_dosya_adi ? \r\n+                `<a href=\"${payment.evrak_dosya_yolu}\" target=\"_blank\" class=\"btn btn-sm btn-outline-info\">\r\n                     <i class=\"fas fa-file-alt\"></i>\r\n                 </a>` : '<span class=\"text-muted\">-</span>';\r\n             \r\n             const row = `\r\n@@ -915,17 +834,19 @@\n                             ${payment.tur_adi || 'N/A'}\r\n                         </span>\r\n                     </td>\r\n                     <td>\r\n-                        <strong class=\"${payment.tutar >= 0 ? 'text-success' : 'text-danger'}\">\r\n-                            ₺${parseFloat(payment.tutar || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}\r\n+                        <strong class=\"${payment.odeme_tutari >= 0 ? 'text-success' : 'text-danger'}\">\r\n+                            ₺${parseFloat(payment.odeme_tutari || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}\r\n                         </strong>\r\n                     </td>\r\n                     <td>${payment.odeme_tarihi ? new Date(payment.odeme_tarihi).toLocaleDateString('tr-TR') : 'N/A'}</td>\r\n-                    <td>${payment.referans_no || '-'}</td>\r\n-                    <td>${statusBadge}</td>\r\n-                    <td class=\"text-center\">${dekontLink}</td>\r\n+                    <td class=\"text-center\">${evrakLink}</td>\r\n                     <td>\r\n+                        <small class=\"text-muted\">${payment.created_by || 'N/A'}</small><br>\r\n+                        <small class=\"text-muted\">${payment.created_at ? new Date(payment.created_at).toLocaleDateString('tr-TR') : 'N/A'}</small>\r\n+                    </td>\r\n+                    <td>\r\n                         <div class=\"btn-group\" role=\"group\">\r\n                             <button class=\"btn btn-sm btn-outline-primary\" onclick=\"editPayment(${payment.id})\">\r\n                                 <i class=\"fas fa-edit\"></i>\r\n                             </button>\r\n@@ -939,18 +860,8 @@\n             tbody.append(row);\r\n         });\r\n     }\r\n     \r\n-    function getStatusBadge(status) {\r\n-        const badges = {\r\n-            'BEKLEMEDE': '<span class=\"badge bg-warning\">Beklemede</span>',\r\n-            'ONAYLANDI': '<span class=\"badge bg-info\">Onaylandı</span>',\r\n-            'ODENDI': '<span class=\"badge bg-success\">Ödendi</span>',\r\n-            'IPTAL': '<span class=\"badge bg-danger\">İptal</span>'\r\n-        };\r\n-        return badges[status] || '<span class=\"badge bg-secondary\">Bilinmeyen</span>';\r\n-    }\r\n-    \r\n     function showAlert(type, message) {\r\n         const alert = `\r\n             <div class=\"alert alert-${type} alert-dismissible fade show\" role=\"alert\">\r\n                 ${message}\r\n"
                },
                {
                    "date": 1760623798019,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,13 +12,10 @@\n require_once 'auth.php';\r\n $currentUser = checkAuth();\r\n checkUserStatus();\r\n \r\n-// Admin kontrolü\r\n-if ($currentUser['group_name'] !== 'admin') {\r\n-    header('Location: index.php?error=Yetkisiz erişim');\r\n-    exit;\r\n-}\r\n+// Yetki kontrolü geçici olarak kaldırıldı\r\n+// Herhangi bir login olmuş kullanıcı erişebilir\r\n \r\n // Database connection setup\r\n $config = include __DIR__ . '/config/mssql.php';\r\n \r\n"
                },
                {
                    "date": 1760624629342,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -37,30 +37,48 @@\n }\r\n \r\n function createTables($conn) {\r\n     $sql = \"\r\n-    -- Ödeme türleri tablosu\r\n+    -- Ödeme türleri tablosu kontrol ve düzeltme\r\n     IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='odeme_turleri' AND xtype='U')\r\n-    CREATE TABLE odeme_turleri (\r\n-        id INT IDENTITY(1,1) PRIMARY KEY,\r\n-        tur_adi NVARCHAR(100) NOT NULL,\r\n-        aciklama NVARCHAR(500),\r\n-        renk_kodu NVARCHAR(7) DEFAULT '#007bff',\r\n-        ikon NVARCHAR(50) DEFAULT 'fa-money-bill',\r\n-        aktif BIT DEFAULT 1,\r\n-        created_at DATETIME2 NOT NULL DEFAULT GETDATE(),\r\n-        updated_at DATETIME2 NULL\r\n-    );\r\n+    BEGIN\r\n+        CREATE TABLE odeme_turleri (\r\n+            id INT IDENTITY(1,1) PRIMARY KEY,\r\n+            tur_adi NVARCHAR(100) NOT NULL,\r\n+            tur_kodu NVARCHAR(20) NOT NULL UNIQUE,\r\n+            aciklama NVARCHAR(500),\r\n+            renk_kodu NVARCHAR(7) DEFAULT '#007bff',\r\n+            ikon NVARCHAR(50) DEFAULT 'fa-money-bill',\r\n+            aktif BIT DEFAULT 1,\r\n+            created_at DATETIME DEFAULT GETDATE(),\r\n+            updated_at DATETIME NULL\r\n+        );\r\n+    END\r\n+    ELSE\r\n+    BEGIN\r\n+        -- Eksik alanları kontrol et ve ekle\r\n+        IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'odeme_turleri' AND COLUMN_NAME = 'tur_kodu')\r\n+        BEGIN\r\n+            ALTER TABLE odeme_turleri ADD tur_kodu NVARCHAR(20) NULL;\r\n+            -- Mevcut kayıtlar için tur_kodu oluştur\r\n+            UPDATE odeme_turleri SET tur_kodu = 'TUR_' + CAST(id AS NVARCHAR(10)) WHERE tur_kodu IS NULL;\r\n+            -- Constraint ekle\r\n+            IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS WHERE CONSTRAINT_NAME = 'UQ_odeme_turleri_tur_kodu')\r\n+            BEGIN\r\n+                ALTER TABLE odeme_turleri ADD CONSTRAINT UQ_odeme_turleri_tur_kodu UNIQUE (tur_kodu);\r\n+            END\r\n+        END\r\n+    END\r\n \r\n-    -- Varsayılan ödeme türlerini ekle\r\n+    -- Varsayılan ödeme türlerini ekle (sadece tablo boşsa)\r\n     IF NOT EXISTS (SELECT 1 FROM odeme_turleri)\r\n     BEGIN\r\n-        INSERT INTO odeme_turleri (tur_adi, aciklama, renk_kodu, ikon) VALUES \r\n-        ('Hakediş Ödemesi', 'Bayi hakediş ödemeleri', '#28a745', 'fa-hand-holding-usd'),\r\n-        ('Prim Ödemesi', 'Bayi prim ödemeleri', '#17a2b8', 'fa-star'),\r\n-        ('Fatura Kesildi', 'Bayi fatura kesintileri', '#dc3545', 'fa-file-invoice-dollar'),\r\n-        ('Diğer Ödeme', 'Diğer ödeme türleri', '#6c757d', 'fa-coins'),\r\n-        ('Kesinti', 'Bayi kesintileri', '#fd7e14', 'fa-minus-circle');\r\n+        INSERT INTO odeme_turleri (tur_adi, tur_kodu, aciklama, renk_kodu, ikon) VALUES \r\n+        ('Hakediş Ödemesi', 'HAKEDIS', 'Bayi hakediş ödemeleri', '#28a745', 'fa-hand-holding-usd'),\r\n+        ('Prim Ödemesi', 'PRIM', 'Bayi prim ödemeleri', '#17a2b8', 'fa-star'),\r\n+        ('Fatura Kesildi', 'FATURA', 'Bayi fatura kesintileri', '#dc3545', 'fa-file-invoice-dollar'),\r\n+        ('Diğer Ödeme', 'DIGER', 'Diğer ödeme türleri', '#6c757d', 'fa-coins'),\r\n+        ('Kesinti', 'KESINTI', 'Bayi kesintileri', '#fd7e14', 'fa-minus-circle');\r\n     END\r\n     \";\r\n     \r\n     try {\r\n@@ -75,8 +93,19 @@\n     \r\n     // Tablolar mevcut mu kontrol et ve oluştur\r\n     createTables($conn);\r\n     \r\n+    // Tabloların varlığını test et\r\n+    try {\r\n+        $test_query = \"SELECT COUNT(*) as count FROM odeme_turleri\";\r\n+        $test_stmt = $conn->prepare($test_query);\r\n+        $test_stmt->execute();\r\n+        $test_result = $test_stmt->fetch();\r\n+        error_log(\"Ödeme türleri tablosu test: \" . $test_result['count'] . \" kayıt bulundu\");\r\n+    } catch (Exception $e) {\r\n+        error_log(\"Tablo test hatası: \" . $e->getMessage());\r\n+    }\r\n+    \r\n     // AJAX isteği kontrolü\r\n     if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {\r\n         header('Content-Type: application/json');\r\n         \r\n@@ -102,12 +131,13 @@\n                             bho.aciklama,\r\n                             bho.evrak_dosya_adi,\r\n                             bho.evrak_dosya_yolu,\r\n                             bho.created_at,\r\n-                            bho.created_by\r\n+                            ISNULL(cb.first_name + ' ' + cb.last_name, 'Sistem') as created_by\r\n                         FROM bayi_hakedis_odeme bho\r\n                         INNER JOIN users u ON bho.user_id = u.id\r\n                         INNER JOIN odeme_turleri ot ON bho.odeme_turu_id = ot.id\r\n+                        LEFT JOIN users cb ON bho.created_by = cb.id\r\n                         WHERE 1=1\";\r\n                 \r\n                 $params = [];\r\n                 \r\n@@ -259,9 +289,9 @@\n                 \r\n                 $stmt = $conn->prepare($sql);\r\n                 $result = $stmt->execute([\r\n                     $user_id, $odeme_turu_id, $odeme_tutari, $odeme_tarihi, $aciklama,\r\n-                    $evrak_dosya_adi, $evrak_dosya_yolu, $evrak_dosya_boyutu, $currentUser['name']\r\n+                    $evrak_dosya_adi, $evrak_dosya_yolu, $evrak_dosya_boyutu, $currentUser['id']\r\n                 ]);\r\n                 \r\n                 if ($result) {\r\n                     echo json_encode(['success' => true, 'message' => 'Ödeme kaydı başarıyla eklendi']);\r\n@@ -271,11 +301,17 @@\n                 exit;\r\n             }\r\n             \r\n         } catch (Exception $e) {\r\n+            error_log(\"AJAX Error: \" . $e->getMessage() . \" in \" . $e->getFile() . \" on line \" . $e->getLine());\r\n             echo json_encode([\r\n                 'success' => false, \r\n-                'message' => 'Hata: ' . $e->getMessage()\r\n+                'message' => 'Hata: ' . $e->getMessage(),\r\n+                'error_details' => [\r\n+                    'file' => $e->getFile(),\r\n+                    'line' => $e->getLine(),\r\n+                    'trace' => $e->getTraceAsString()\r\n+                ]\r\n             ]);\r\n         }\r\n         exit;\r\n     }\r\n@@ -584,11 +620,11 @@\n     font-weight: 600;\r\n }\r\n </style>\r\n \r\n+<script src=\"https://code.jquery.com/jquery-3.6.0.min.js\"></script>\r\n <script>\r\n $(document).ready(function() {\r\n-$(document).ready(function() {\r\n     // Sayfa yüklendiğinde ödemeleri getir\r\n     loadPayments();\r\n     \r\n     // Abone No ile bayi bulma\r\n@@ -777,17 +813,24 @@\n                     displayPayments([]);\r\n                 }\r\n             },\r\n             error: function(xhr, status, error) {\r\n-                console.error('AJAX Error:', xhr.responseText, status, error);\r\n+                console.error('AJAX Error Details:', {\r\n+                    responseText: xhr.responseText,\r\n+                    status: xhr.status,\r\n+                    statusText: xhr.statusText,\r\n+                    error: error\r\n+                });\r\n+                \r\n                 let errorMessage = 'Veriler yüklenirken hata oluştu: ';\r\n                 \r\n                 if (xhr.status === 500) {\r\n                     errorMessage += 'Sunucu hatası (HTTP 500)';\r\n+                    console.error('Server error details:', xhr.responseText);\r\n                 } else if (xhr.status === 0) {\r\n                     errorMessage += 'Bağlantı hatası';\r\n                 } else {\r\n-                    errorMessage += error;\r\n+                    errorMessage += `HTTP ${xhr.status}: ${error}`;\r\n                 }\r\n                 \r\n                 showAlert('danger', errorMessage);\r\n                 displayPayments([]);\r\n"
                },
                {
                    "date": 1760625965919,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -37,8 +37,19 @@\n }\r\n \r\n function createTables($conn) {\r\n     $sql = \"\r\n+    -- User groups tablosuna default grupları ekle\r\n+    IF NOT EXISTS (SELECT 1 FROM user_groups WHERE group_name = 'admin')\r\n+    BEGIN\r\n+        INSERT INTO user_groups (group_name, group_description) VALUES ('admin', 'Sistem Yöneticileri');\r\n+    END\r\n+    \r\n+    IF NOT EXISTS (SELECT 1 FROM user_groups WHERE group_name = 'bayi')\r\n+    BEGIN\r\n+        INSERT INTO user_groups (group_name, group_description) VALUES ('bayi', 'Bayi Kullanıcıları');\r\n+    END\r\n+    \r\n     -- Ödeme türleri tablosu kontrol ve düzeltme\r\n     IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='odeme_turleri' AND xtype='U')\r\n     BEGIN\r\n         CREATE TABLE odeme_turleri (\r\n@@ -316,17 +327,39 @@\n         exit;\r\n     }\r\n     \r\n     // Bayileri getir (users tablosundan user_groups ile)\r\n-    $bayiler_sql = \"SELECT u.id, u.first_name + ' ' + u.last_name as name, u.email \r\n+    // Önce grup kontrolü yapalım\r\n+    $group_check_sql = \"SELECT id, group_name FROM user_groups\";\r\n+    $group_check_stmt = $conn->prepare($group_check_sql);\r\n+    $group_check_stmt->execute();\r\n+    $groups = $group_check_stmt->fetchAll(PDO::FETCH_ASSOC);\r\n+    error_log(\"Mevcut gruplar: \" . json_encode($groups));\r\n+    \r\n+    $bayiler_sql = \"SELECT u.id, u.first_name + ' ' + u.last_name as name, u.email,\r\n+                           ug.group_name\r\n                     FROM users u \r\n-                    INNER JOIN user_groups ug ON u.user_group_id = ug.id \r\n-                    WHERE ug.group_name = 'bayi' AND u.status = 'AKTIF' \r\n+                    LEFT JOIN user_groups ug ON u.user_group_id = ug.id \r\n+                    WHERE u.status = 'AKTIF' \r\n                     ORDER BY u.first_name, u.last_name\";\r\n     $bayiler_stmt = $conn->prepare($bayiler_sql);\r\n     $bayiler_stmt->execute();\r\n-    $bayiler = $bayiler_stmt->fetchAll(PDO::FETCH_ASSOC);\r\n+    $all_users = $bayiler_stmt->fetchAll(PDO::FETCH_ASSOC);\r\n+    error_log(\"Tüm aktif kullanıcılar: \" . json_encode($all_users));\r\n     \r\n+    // Sadece bayi gruplu olanları filtrele\r\n+    $bayiler = array_filter($all_users, function($user) {\r\n+        return $user['group_name'] === 'bayi';\r\n+    });\r\n+    \r\n+    // Eğer bayi bulunamazsa tüm aktif kullanıcıları göster\r\n+    if (empty($bayiler)) {\r\n+        $bayiler = $all_users;\r\n+        error_log(\"Bayi grubu bulunamadı, tüm aktif kullanıcılar gösteriliyor\");\r\n+    } else {\r\n+        error_log(\"Bulunan bayiler: \" . count($bayiler));\r\n+    }\r\n+    \r\n     // Ödeme türlerini getir\r\n     $odeme_turleri_sql = \"SELECT * FROM odeme_turleri WHERE aktif = 1 ORDER BY tur_adi\";\r\n     $odeme_turleri_stmt = $conn->prepare($odeme_turleri_sql);\r\n     $odeme_turleri_stmt->execute();\r\n@@ -366,8 +399,9 @@\n             <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n                 <h2>\r\n                     <i class=\"fas fa-money-bill-wave text-success me-2\"></i>\r\n                     Bayi Ödeme Yönetimi\r\n+                    <small class=\"text-muted\">(<?php echo count($bayiler); ?> bayi bulundu)</small>\r\n                 </h2>\r\n                 <button class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#addPaymentModal\">\r\n                     <i class=\"fas fa-plus me-2\"></i>Yeni Ödeme Ekle\r\n                 </button>\r\n@@ -547,12 +581,16 @@\n                     <div class=\"row g-3\">\r\n                         <div class=\"col-md-6\">\r\n                             <label class=\"form-label\">Bayi <span class=\"text-danger\">*</span></label>\r\n                             <select class=\"form-select\" name=\"user_id\" id=\"bayiSelect\" required>\r\n-                                <option value=\"\">Bayi Seçin</option>\r\n-                                <?php foreach ($bayiler as $bayi): ?>\r\n-                                    <option value=\"<?php echo $bayi['id']; ?>\"><?php echo htmlspecialchars($bayi['name']); ?></option>\r\n-                                <?php endforeach; ?>\r\n+                                <option value=\"\">Bayi Seçin (<?php echo count($bayiler); ?> adet)</option>\r\n+                                <?php if (empty($bayiler)): ?>\r\n+                                    <option value=\"\" disabled>Hiç bayi bulunamadı</option>\r\n+                                <?php else: ?>\r\n+                                    <?php foreach ($bayiler as $bayi): ?>\r\n+                                        <option value=\"<?php echo $bayi['id']; ?>\"><?php echo htmlspecialchars($bayi['name']); ?> (Grup: <?php echo $bayi['group_name'] ?? 'Yok'; ?>)</option>\r\n+                                    <?php endforeach; ?>\r\n+                                <?php endif; ?>\r\n                             </select>\r\n                         </div>\r\n                         <div class=\"col-md-6\">\r\n                             <label class=\"form-label\">Ödeme Türü <span class=\"text-danger\">*</span></label>\r\n"
                },
                {
                    "date": 1760626168225,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -190,60 +190,118 @@\n                     echo json_encode(['success' => false, 'message' => 'Abone numarası boş olamaz']);\r\n                     exit;\r\n                 }\r\n                 \r\n-                // İris rapor tablosunda abone numarasını ara\r\n-                $iris_sql = \"SELECT TOP 1 TALEBI_GIREN_PERSONELNO \r\n+                // İris rapor tablosunda abone numarasını ara (daha geniş arama)\r\n+                $iris_sql = \"SELECT TOP 1 TALEBI_GIREN_PERSONELNO, DT_MUSTERI_NO\r\n                             FROM digiturk.iris_rapor \r\n                             WHERE DT_MUSTERI_NO LIKE ? \r\n+                               OR UYDU_BASVURU_POTANSIYEL_NO LIKE ?\r\n+                               OR UYDU_BASVURU_UYE_NO LIKE ?\r\n+                               OR AKTIVE_EDILEN_UYENO LIKE ?\r\n                             ORDER BY eklenme_tarihi DESC\";\r\n                 \r\n+                $search_pattern = '%' . $abone_no . '%';\r\n                 $iris_stmt = $conn->prepare($iris_sql);\r\n-                $iris_stmt->execute(['%' . $abone_no . '%']);\r\n+                $iris_stmt->execute([$search_pattern, $search_pattern, $search_pattern, $search_pattern]);\r\n                 $iris_result = $iris_stmt->fetch(PDO::FETCH_ASSOC);\r\n                 \r\n                 if (!$iris_result) {\r\n-                    echo json_encode(['success' => false, 'message' => 'Bu abone numarası için kayıt bulunamadı']);\r\n+                    // Debug: Toplam kayıt sayısını kontrol et\r\n+                    $count_sql = \"SELECT COUNT(*) as total FROM digiturk.iris_rapor\";\r\n+                    $count_stmt = $conn->prepare($count_sql);\r\n+                    $count_stmt->execute();\r\n+                    $count_result = $count_stmt->fetch();\r\n+                    \r\n+                    echo json_encode([\r\n+                        'success' => false, \r\n+                        'message' => 'Bu abone numarası için kayıt bulunamadı',\r\n+                        'debug' => [\r\n+                            'searched_number' => $abone_no,\r\n+                            'total_iris_records' => $count_result['total']\r\n+                        ]\r\n+                    ]);\r\n                     exit;\r\n                 }\r\n                 \r\n                 $personel_no = $iris_result['TALEBI_GIREN_PERSONELNO'];\r\n                 \r\n+                if (!$personel_no) {\r\n+                    echo json_encode([\r\n+                        'success' => false, \r\n+                        'message' => 'Personel numarası boş',\r\n+                        'debug' => [\r\n+                            'found_customer_no' => $iris_result['DT_MUSTERI_NO'] ?? 'N/A'\r\n+                        ]\r\n+                    ]);\r\n+                    exit;\r\n+                }\r\n+                \r\n                 // Users_bayi tablosunda personel kimlik numarasını ara\r\n-                $bayi_sql = \"SELECT user_id \r\n+                $bayi_sql = \"SELECT user_id, personel_kimlik_no, iris_altbayi\r\n                             FROM users_bayi \r\n                             WHERE personel_kimlik_no = ?\";\r\n                 \r\n                 $bayi_stmt = $conn->prepare($bayi_sql);\r\n                 $bayi_stmt->execute([$personel_no]);\r\n                 $bayi_result = $bayi_stmt->fetch(PDO::FETCH_ASSOC);\r\n                 \r\n                 if (!$bayi_result) {\r\n-                    echo json_encode(['success' => false, 'message' => 'Bu personel numarası için bayi bulunamadı']);\r\n+                    // Debug: Tüm personel numaralarını kontrol et\r\n+                    $all_personel_sql = \"SELECT COUNT(*) as total, \r\n+                                                MIN(personel_kimlik_no) as min_no,\r\n+                                                MAX(personel_kimlik_no) as max_no\r\n+                                         FROM users_bayi\";\r\n+                    $all_personel_stmt = $conn->prepare($all_personel_sql);\r\n+                    $all_personel_stmt->execute();\r\n+                    $all_personel_result = $all_personel_stmt->fetch();\r\n+                    \r\n+                    echo json_encode([\r\n+                        'success' => false, \r\n+                        'message' => 'Bu personel numarası için bayi bulunamadı',\r\n+                        'debug' => [\r\n+                            'searched_personel_no' => $personel_no,\r\n+                            'total_bayi_records' => $all_personel_result['total'],\r\n+                            'min_personel_no' => $all_personel_result['min_no'],\r\n+                            'max_personel_no' => $all_personel_result['max_no']\r\n+                        ]\r\n+                    ]);\r\n                     exit;\r\n                 }\r\n                 \r\n                 $user_id = $bayi_result['user_id'];\r\n                 \r\n-                // Users tablosundan bayi bilgilerini getir\r\n-                $user_sql = \"SELECT u.id, u.first_name + ' ' + u.last_name as name, u.email\r\n+                // Users tablosundan bayi bilgilerini getir (kısıtlamaları kaldırıldı)\r\n+                $user_sql = \"SELECT u.id, u.first_name + ' ' + u.last_name as name, u.email, u.status,\r\n+                                   ug.group_name\r\n                             FROM users u\r\n-                            INNER JOIN user_groups ug ON u.user_group_id = ug.id\r\n-                            WHERE u.id = ? AND ug.group_name = 'bayi' AND u.status = 'AKTIF'\";\r\n+                            LEFT JOIN user_groups ug ON u.user_group_id = ug.id\r\n+                            WHERE u.id = ?\";\r\n                 \r\n                 $user_stmt = $conn->prepare($user_sql);\r\n                 $user_stmt->execute([$user_id]);\r\n                 $user_result = $user_stmt->fetch(PDO::FETCH_ASSOC);\r\n                 \r\n                 if (!$user_result) {\r\n-                    echo json_encode(['success' => false, 'message' => 'Bayi bulunamadı veya aktif değil']);\r\n+                    echo json_encode(['success' => false, 'message' => 'Kullanıcı bulunamadı']);\r\n                     exit;\r\n                 }\r\n                 \r\n+                // Debug bilgisi ekle\r\n+                $status_info = '';\r\n+                if ($user_result['status'] !== 'AKTIF') {\r\n+                    $status_info = ' (Durum: ' . $user_result['status'] . ')';\r\n+                }\r\n+                \r\n+                $group_info = '';\r\n+                if ($user_result['group_name']) {\r\n+                    $group_info = ' (Grup: ' . $user_result['group_name'] . ')';\r\n+                }\r\n+                \r\n                 echo json_encode([\r\n                     'success' => true, \r\n                     'data' => $user_result,\r\n-                    'message' => 'Bayi bulundu: ' . $user_result['name']\r\n+                    'message' => 'Bayi bulundu: ' . $user_result['name'] . $status_info . $group_info\r\n                 ]);\r\n                 exit;\r\n             }\r\n             \r\n@@ -689,8 +747,10 @@\n                 abone_no: aboneNo\r\n             },\r\n             dataType: 'json',\r\n             success: function(response) {\r\n+                console.log('Bayi arama yanıtı:', response);\r\n+                \r\n                 if (response && response.success) {\r\n                     // Bayi bulundu, dropdown'da seç\r\n                     $('#bayiSelect').val(response.data.id);\r\n                     \r\n@@ -701,12 +761,21 @@\n                             <br><small class=\"text-muted\">${response.data.email}</small>\r\n                         </div>\r\n                     `);\r\n                 } else {\r\n+                    let errorMessage = response.message || 'Bayi bulunamadı';\r\n+                    let debugInfo = '';\r\n+                    \r\n+                    // Debug bilgisi varsa göster\r\n+                    if (response.debug) {\r\n+                        debugInfo = '<br><small class=\"text-muted\">Debug: ' + JSON.stringify(response.debug) + '</small>';\r\n+                    }\r\n+                    \r\n                     resultDiv.html(`\r\n                         <div class=\"alert alert-danger alert-sm mb-0\">\r\n                             <i class=\"fas fa-exclamation-circle me-2\"></i>\r\n-                            ${response.message || 'Bayi bulunamadı'}\r\n+                            ${errorMessage}\r\n+                            ${debugInfo}\r\n                         </div>\r\n                     `);\r\n                 }\r\n             },\r\n"
                },
                {
                    "date": 1760626599860,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -191,9 +191,9 @@\n                     exit;\r\n                 }\r\n                 \r\n                 // İris rapor tablosunda abone numarasını ara (daha geniş arama)\r\n-                $iris_sql = \"SELECT TOP 1 TALEBI_GIREN_PERSONELNO, DT_MUSTERI_NO\r\n+                $iris_sql = \"SELECT TOP 1 TALEBI_GIREN_PERSONELNO, DT_MUSTERI_NO, TALEBI_GIREN_PERSONEL_ALTBAYI\r\n                             FROM digiturk.iris_rapor \r\n                             WHERE DT_MUSTERI_NO LIKE ? \r\n                                OR UYDU_BASVURU_POTANSIYEL_NO LIKE ?\r\n                                OR UYDU_BASVURU_UYE_NO LIKE ?\r\n@@ -259,8 +259,10 @@\n                         'success' => false, \r\n                         'message' => 'Bu personel numarası için bayi bulunamadı',\r\n                         'debug' => [\r\n                             'searched_personel_no' => $personel_no,\r\n+                            'iris_personel_altbayi' => $iris_result['TALEBI_GIREN_PERSONEL_ALTBAYI'] ?? 'N/A',\r\n+                            'found_customer_no' => $iris_result['DT_MUSTERI_NO'] ?? 'N/A',\r\n                             'total_bayi_records' => $all_personel_result['total'],\r\n                             'min_personel_no' => $all_personel_result['min_no'],\r\n                             'max_personel_no' => $all_personel_result['max_no']\r\n                         ]\r\n@@ -764,11 +766,31 @@\n                 } else {\r\n                     let errorMessage = response.message || 'Bayi bulunamadı';\r\n                     let debugInfo = '';\r\n                     \r\n-                    // Debug bilgisi varsa göster\r\n+                    // Debug bilgisi varsa daha okunabilir formatta göster\r\n                     if (response.debug) {\r\n-                        debugInfo = '<br><small class=\"text-muted\">Debug: ' + JSON.stringify(response.debug) + '</small>';\r\n+                        let debugItems = [];\r\n+                        \r\n+                        if (response.debug.searched_personel_no) {\r\n+                            debugItems.push(`<strong>Aranan Personel No:</strong> ${response.debug.searched_personel_no}`);\r\n+                        }\r\n+                        \r\n+                        if (response.debug.iris_personel_altbayi) {\r\n+                            debugItems.push(`<strong>Alt Bayi:</strong> ${response.debug.iris_personel_altbayi}`);\r\n+                        }\r\n+                        \r\n+                        if (response.debug.found_customer_no) {\r\n+                            debugItems.push(`<strong>Bulunan Müşteri No:</strong> ${response.debug.found_customer_no}`);\r\n+                        }\r\n+                        \r\n+                        if (response.debug.total_bayi_records) {\r\n+                            debugItems.push(`<strong>Toplam Bayi Kayıt:</strong> ${response.debug.total_bayi_records}`);\r\n+                        }\r\n+                        \r\n+                        if (debugItems.length > 0) {\r\n+                            debugInfo = '<br><div class=\"mt-2 p-2 bg-light border rounded\"><small>' + debugItems.join('<br>') + '</small></div>';\r\n+                        }\r\n                     }\r\n                     \r\n                     resultDiv.html(`\r\n                         <div class=\"alert alert-danger alert-sm mb-0\">\r\n"
                },
                {
                    "date": 1760628399289,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -55,9 +55,9 @@\n         CREATE TABLE odeme_turleri (\r\n             id INT IDENTITY(1,1) PRIMARY KEY,\r\n             tur_adi NVARCHAR(100) NOT NULL,\r\n             tur_kodu NVARCHAR(20) NOT NULL UNIQUE,\r\n-            aciklama NVARCHAR(500),\r\n+            aciklama NVARCHAR(1500),\r\n             renk_kodu NVARCHAR(7) DEFAULT '#007bff',\r\n             ikon NVARCHAR(50) DEFAULT 'fa-money-bill',\r\n             aktif BIT DEFAULT 1,\r\n             created_at DATETIME DEFAULT GETDATE(),\r\n@@ -352,16 +352,19 @@\n                         exit;\r\n                     }\r\n                 }\r\n                 \r\n+                // Açıklama alanını 500 karakterle sınırla (veritabanı limiti)\r\n+                $aciklama_kesik = mb_substr($aciklama, 0, 1500, 'UTF-8');\r\n+                \r\n                 $sql = \"INSERT INTO bayi_hakedis_odeme (\r\n                             user_id, odeme_turu_id, odeme_tutari, odeme_tarihi, aciklama, \r\n                             evrak_dosya_adi, evrak_dosya_yolu, evrak_dosya_boyutu, created_by\r\n                         ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\";\r\n                 \r\n                 $stmt = $conn->prepare($sql);\r\n                 $result = $stmt->execute([\r\n-                    $user_id, $odeme_turu_id, $odeme_tutari, $odeme_tarihi, $aciklama,\r\n+                    $user_id, $odeme_turu_id, $odeme_tutari, $odeme_tarihi, $aciklama_kesik,\r\n                     $evrak_dosya_adi, $evrak_dosya_yolu, $evrak_dosya_boyutu, $currentUser['id']\r\n                 ]);\r\n                 \r\n                 if ($result) {\r\n@@ -683,9 +686,10 @@\n                             <div class=\"form-text\">PDF, JPG, PNG, DOC dosyaları desteklenmektedir</div>\r\n                         </div>\r\n                         <div class=\"col-12\">\r\n                             <label class=\"form-label\">Açıklama</label>\r\n-                            <textarea class=\"form-control\" name=\"aciklama\" rows=\"3\" placeholder=\"Ödeme ile ilgili açıklama...\"></textarea>\r\n+                            <textarea class=\"form-control\" name=\"aciklama\" rows=\"3\" maxlength=\"1500\" placeholder=\"Ödeme ile ilgili açıklama...\"></textarea>\r\n+                            <div class=\"form-text\">Maksimum 1500 karakter <span id=\"charCount\" class=\"text-muted\">(0/1500)</span></div>\r\n                         </div>\r\n                     </div>\r\n                 </div>\r\n                 <div class=\"modal-footer\">\r\n@@ -906,8 +910,31 @@\n             }\r\n         });\r\n     });\r\n     \r\n+    // Açıklama karakter sayacı\r\n+    $('textarea[name=\"aciklama\"]').on('input', function() {\r\n+        const currentLength = $(this).val().length;\r\n+        const maxLength = 1500;\r\n+        const remaining = maxLength - currentLength;\r\n+        \r\n+        const counter = $('#charCount');\r\n+        counter.text(`(${currentLength}/${maxLength})`);\r\n+        \r\n+        if (remaining < 50) {\r\n+            counter.removeClass('text-muted').addClass('text-warning');\r\n+        } else if (remaining < 20) {\r\n+            counter.removeClass('text-warning').addClass('text-danger');\r\n+        } else {\r\n+            counter.removeClass('text-warning text-danger').addClass('text-muted');\r\n+        }\r\n+        \r\n+        // 1500 karakteri aştıysa kes\r\n+        if (currentLength > maxLength) {\r\n+            $(this).val($(this).val().substring(0, maxLength));\r\n+        }\r\n+    });\r\n+    \r\n     function loadPayments() {\r\n         const formData = new FormData($('#filterForm')[0]);\r\n         formData.append('action', 'get_payments');\r\n         \r\n"
                },
                {
                    "date": 1760629504915,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -313,8 +313,9 @@\n                 $odeme_turu_id = $_POST['odeme_turu_id'];\r\n                 $odeme_tutari = $_POST['tutar'];\r\n                 $odeme_tarihi = $_POST['odeme_tarihi'];\r\n                 $aciklama = $_POST['aciklama'] ?? '';\r\n+                $referans_no = $_POST['referans_no'] ?? '';\r\n                 \r\n                 // Dosya yükleme işlemi\r\n                 $evrak_dosya_adi = null;\r\n                 $evrak_dosya_yolu = null;\r\n@@ -356,15 +357,15 @@\n                 // Açıklama alanını 500 karakterle sınırla (veritabanı limiti)\r\n                 $aciklama_kesik = mb_substr($aciklama, 0, 1500, 'UTF-8');\r\n                 \r\n                 $sql = \"INSERT INTO bayi_hakedis_odeme (\r\n-                            user_id, odeme_turu_id, odeme_tutari, odeme_tarihi, aciklama, \r\n+                            user_id, odeme_turu_id, odeme_tutari, odeme_tarihi, aciklama, referans_no,\r\n                             evrak_dosya_adi, evrak_dosya_yolu, evrak_dosya_boyutu, created_by\r\n-                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\";\r\n+                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\";\r\n                 \r\n                 $stmt = $conn->prepare($sql);\r\n                 $result = $stmt->execute([\r\n-                    $user_id, $odeme_turu_id, $odeme_tutari, $odeme_tarihi, $aciklama_kesik,\r\n+                    $user_id, $odeme_turu_id, $odeme_tutari, $odeme_tarihi, $aciklama_kesik, $referans_no,\r\n                     $evrak_dosya_adi, $evrak_dosya_yolu, $evrak_dosya_boyutu, $currentUser['id']\r\n                 ]);\r\n                 \r\n                 if ($result) {\r\n@@ -374,8 +375,121 @@\n                 }\r\n                 exit;\r\n             }\r\n             \r\n+            if ($action === 'get_payment_details') {\r\n+                // Ödeme detaylarını getir\r\n+                $payment_id = $_POST['payment_id'] ?? '';\r\n+                \r\n+                if (empty($payment_id)) {\r\n+                    echo json_encode(['success' => false, 'message' => 'Ödeme ID boş olamaz']);\r\n+                    exit;\r\n+                }\r\n+                \r\n+                $sql = \"SELECT \r\n+                            bho.id,\r\n+                            bho.user_id,\r\n+                            bho.odeme_turu_id,\r\n+                            bho.odeme_tutari,\r\n+                            bho.odeme_tarihi,\r\n+                            bho.aciklama,\r\n+                            bho.referans_no,\r\n+                            bho.evrak_dosya_adi,\r\n+                            bho.evrak_dosya_yolu,\r\n+                            u.first_name + ' ' + u.last_name as bayi_adi,\r\n+                            ot.tur_adi\r\n+                        FROM bayi_hakedis_odeme bho\r\n+                        INNER JOIN users u ON bho.user_id = u.id\r\n+                        INNER JOIN odeme_turleri ot ON bho.odeme_turu_id = ot.id\r\n+                        WHERE bho.id = ?\";\r\n+                \r\n+                $stmt = $conn->prepare($sql);\r\n+                $stmt->execute([$payment_id]);\r\n+                $payment = $stmt->fetch(PDO::FETCH_ASSOC);\r\n+                \r\n+                if ($payment) {\r\n+                    echo json_encode(['success' => true, 'data' => $payment]);\r\n+                } else {\r\n+                    echo json_encode(['success' => false, 'message' => 'Ödeme kaydı bulunamadı']);\r\n+                }\r\n+                exit;\r\n+            }\r\n+            \r\n+            if ($action === 'update_payment') {\r\n+                // Ödeme güncelle\r\n+                $payment_id = $_POST['payment_id'];\r\n+                $user_id = $_POST['user_id'];\r\n+                $odeme_turu_id = $_POST['odeme_turu_id'];\r\n+                $odeme_tutari = $_POST['tutar'];\r\n+                $odeme_tarihi = $_POST['odeme_tarihi'];\r\n+                $aciklama = $_POST['aciklama'] ?? '';\r\n+                $referans_no = $_POST['referans_no'] ?? '';\r\n+                \r\n+                // Dosya güncelleme işlemi\r\n+                $evrak_update_sql = \"\";\r\n+                $evrak_params = [];\r\n+                \r\n+                if (isset($_FILES['dekont_dosya']) && $_FILES['dekont_dosya']['error'] === UPLOAD_ERR_OK) {\r\n+                    $upload_dir = __DIR__ . '/uploads/dekontlar/';\r\n+                    \r\n+                    if (!is_dir($upload_dir)) {\r\n+                        if (!mkdir($upload_dir, 0755, true)) {\r\n+                            echo json_encode(['success' => false, 'message' => 'Upload dizini oluşturulamadı']);\r\n+                            exit;\r\n+                        }\r\n+                    }\r\n+                    \r\n+                    $file_info = pathinfo($_FILES['dekont_dosya']['name']);\r\n+                    $extension = strtolower($file_info['extension']);\r\n+                    $allowed_extensions = ['pdf', 'jpg', 'jpeg', 'png', 'doc', 'docx'];\r\n+                    \r\n+                    if (in_array($extension, $allowed_extensions)) {\r\n+                        $unique_name = 'dekont_' . date('Y-m-d_H-i-s') . '_' . uniqid() . '.' . $extension;\r\n+                        $upload_path = $upload_dir . $unique_name;\r\n+                        \r\n+                        if (move_uploaded_file($_FILES['dekont_dosya']['tmp_name'], $upload_path)) {\r\n+                            $evrak_update_sql = \", evrak_dosya_adi = ?, evrak_dosya_yolu = ?, evrak_dosya_boyutu = ?\";\r\n+                            $evrak_params = [\r\n+                                $_FILES['dekont_dosya']['name'],\r\n+                                'uploads/dekontlar/' . $unique_name,\r\n+                                $_FILES['dekont_dosya']['size']\r\n+                            ];\r\n+                        }\r\n+                    }\r\n+                }\r\n+                \r\n+                // Açıklama alanını 500 karakterle sınırla\r\n+                $aciklama_kesik = mb_substr($aciklama, 0, 500, 'UTF-8');\r\n+                \r\n+                $sql = \"UPDATE bayi_hakedis_odeme SET \r\n+                            user_id = ?, \r\n+                            odeme_turu_id = ?, \r\n+                            odeme_tutari = ?, \r\n+                            odeme_tarihi = ?, \r\n+                            aciklama = ?,\r\n+                            referans_no = ?,\r\n+                            updated_at = GETDATE(),\r\n+                            updated_by = ?\r\n+                            {$evrak_update_sql}\r\n+                        WHERE id = ?\";\r\n+                \r\n+                $params = [\r\n+                    $user_id, $odeme_turu_id, $odeme_tutari, $odeme_tarihi, $aciklama_kesik, $referans_no, $currentUser['id']\r\n+                ];\r\n+                $params = array_merge($params, $evrak_params);\r\n+                $params[] = $payment_id;\r\n+                \r\n+                $stmt = $conn->prepare($sql);\r\n+                $result = $stmt->execute($params);\r\n+                \r\n+                if ($result) {\r\n+                    echo json_encode(['success' => true, 'message' => 'Ödeme kaydı başarıyla güncellendi']);\r\n+                } else {\r\n+                    echo json_encode(['success' => false, 'message' => 'Ödeme kaydı güncellenirken hata oluştu']);\r\n+                }\r\n+                exit;\r\n+            }\r\n+            \r\n         } catch (Exception $e) {\r\n             error_log(\"AJAX Error: \" . $e->getMessage() . \" in \" . $e->getFile() . \" on line \" . $e->getLine());\r\n             echo json_encode([\r\n                 'success' => false, \r\n@@ -613,14 +727,15 @@\n <div class=\"modal fade\" id=\"addPaymentModal\" tabindex=\"-1\">\r\n     <div class=\"modal-dialog modal-lg\">\r\n         <div class=\"modal-content\">\r\n             <div class=\"modal-header\">\r\n-                <h5 class=\"modal-title\">\r\n+                <h5 class=\"modal-title\" id=\"paymentModalTitle\">\r\n                     <i class=\"fas fa-plus me-2\"></i>Yeni Ödeme Ekle\r\n                 </h5>\r\n                 <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n             </div>\r\n             <form id=\"addPaymentForm\" enctype=\"multipart/form-data\">\r\n+                <input type=\"hidden\" id=\"paymentId\" name=\"payment_id\" value=\"\">\r\n                 <div class=\"modal-body\">\r\n                     <!-- Abone No ile Bayi Arama -->\r\n                     <div class=\"card mb-3 bg-light\">\r\n                         <div class=\"card-body\">\r\n@@ -676,15 +791,19 @@\n                             <input type=\"date\" class=\"form-control\" name=\"odeme_tarihi\" value=\"<?php echo date('Y-m-d'); ?>\" required>\r\n                         </div>\r\n                         <div class=\"col-md-6\">\r\n                             <label class=\"form-label\">Referans No</label>\r\n-                            <input type=\"text\" class=\"form-control\" name=\"referans_no\" placeholder=\"Açıklama alanında belirtiniz\">\r\n-                            <div class=\"form-text\">Bu alan kullanılmıyor, açıklama alanını kullanın</div>\r\n+                            <input type=\"text\" class=\"form-control\" name=\"referans_no\" placeholder=\"Ödeme referans numarası\" maxlength=\"100\">\r\n+                            <div class=\"form-text\">Ödeme işleminin referans numarası (isteğe bağlı)</div>\r\n                         </div>\r\n                         <div class=\"col-md-6\">\r\n                             <label class=\"form-label\">Dekont/Belge</label>\r\n                             <input type=\"file\" class=\"form-control\" name=\"dekont_dosya\" accept=\".pdf,.jpg,.jpeg,.png,.doc,.docx\">\r\n                             <div class=\"form-text\">PDF, JPG, PNG, DOC dosyaları desteklenmektedir</div>\r\n+                            <div id=\"currentFileInfo\" class=\"mt-2\" style=\"display: none;\">\r\n+                                <small class=\"text-muted\">Mevcut dosya: </small>\r\n+                                <div id=\"currentFile\"></div>\r\n+                            </div>\r\n                         </div>\r\n                         <div class=\"col-12\">\r\n                             <label class=\"form-label\">Açıklama</label>\r\n                             <textarea class=\"form-control\" name=\"aciklama\" rows=\"3\" maxlength=\"1500\" placeholder=\"Ödeme ile ilgili açıklama...\"></textarea>\r\n@@ -693,9 +812,9 @@\n                     </div>\r\n                 </div>\r\n                 <div class=\"modal-footer\">\r\n                     <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n-                    <button type=\"submit\" class=\"btn btn-primary\">\r\n+                    <button type=\"submit\" class=\"btn btn-primary\" id=\"paymentSubmitBtn\">\r\n                         <i class=\"fas fa-save me-2\"></i>Kaydet\r\n                     </button>\r\n                 </div>\r\n             </form>\r\n@@ -846,20 +965,25 @@\n     $('#filterForm').on('reset', function() {\r\n         setTimeout(loadPayments, 100);\r\n     });\r\n     \r\n-    // Yeni ödeme formu submit\r\n+    // Yeni ödeme/Düzenleme formu submit\r\n     $('#addPaymentForm').on('submit', function(e) {\r\n         e.preventDefault();\r\n         \r\n         const submitBtn = $(this).find('button[type=\"submit\"]');\r\n         const originalText = submitBtn.html();\r\n+        const paymentId = $('#paymentId').val();\r\n+        const isEdit = paymentId !== '';\r\n         \r\n         // Submit button'u disable et\r\n-        submitBtn.prop('disabled', true).html('<i class=\"fas fa-spinner fa-spin me-2\"></i>Kaydediliyor...');\r\n+        const loadingText = isEdit ? \r\n+            '<i class=\"fas fa-spinner fa-spin me-2\"></i>Güncelleniyor...' : \r\n+            '<i class=\"fas fa-spinner fa-spin me-2\"></i>Kaydediliyor...';\r\n+        submitBtn.prop('disabled', true).html(loadingText);\r\n         \r\n         const formData = new FormData(this);\r\n-        formData.append('action', 'add_payment');\r\n+        formData.append('action', isEdit ? 'update_payment' : 'add_payment');\r\n         \r\n         $.ajax({\r\n             url: '',\r\n             type: 'POST',\r\n@@ -867,9 +991,9 @@\n             processData: false,\r\n             contentType: false,\r\n             timeout: 30000,\r\n             success: function(response) {\r\n-                console.log('Add payment response:', response);\r\n+                console.log(`${isEdit ? 'Update' : 'Add'} payment response:`, response);\r\n                 \r\n                 // JSON parse et eğer string ise\r\n                 if (typeof response === 'string') {\r\n                     try {\r\n@@ -882,18 +1006,26 @@\n                 }\r\n                 \r\n                 if (response && response.success) {\r\n                     $('#addPaymentModal').modal('hide');\r\n-                    $('#addPaymentForm')[0].reset();\r\n+                    resetPaymentModal(); // Modal'ı sıfırla\r\n                     loadPayments();\r\n-                    showAlert('success', response.message || 'İşlem başarılı');\r\n+                    const successMessage = isEdit ? \r\n+                        (response.message || 'Güncelleme başarılı') : \r\n+                        (response.message || 'İşlem başarılı');\r\n+                    showAlert('success', successMessage);\r\n                 } else {\r\n-                    showAlert('danger', response.message || 'İşlem başarısız');\r\n+                    const errorMessage = isEdit ? \r\n+                        (response.message || 'Güncelleme başarısız') : \r\n+                        (response.message || 'İşlem başarısız');\r\n+                    showAlert('danger', errorMessage);\r\n                 }\r\n             },\r\n             error: function(xhr, status, error) {\r\n                 console.error('AJAX Error:', xhr.responseText, status, error);\r\n-                let errorMessage = 'İşlem sırasında hata oluştu: ';\r\n+                let errorMessage = isEdit ? \r\n+                    'Güncelleme sırasında hata oluştu: ' : \r\n+                    'İşlem sırasında hata oluştu: ';\r\n                 \r\n                 if (xhr.status === 500) {\r\n                     errorMessage += 'Sunucu hatası (HTTP 500)';\r\n                 } else if (xhr.status === 0) {\r\n@@ -910,8 +1042,46 @@\n             }\r\n         });\r\n     });\r\n     \r\n+    // Modal reset fonksiyonu\r\n+    function resetPaymentModal() {\r\n+        // Form'u sıfırla\r\n+        $('#addPaymentForm')[0].reset();\r\n+        \r\n+        // Hidden ID'yi temizle\r\n+        $('#paymentId').val('');\r\n+        \r\n+        // Modal başlığını ve buton metnini ekleme moduna çevir\r\n+        $('#paymentModalTitle').html('<i class=\"fas fa-plus me-2\"></i>Yeni Ödeme Ekle');\r\n+        $('#paymentSubmitBtn').html('<i class=\"fas fa-save me-2\"></i>Kaydet');\r\n+        \r\n+        // Abone no arama alanını göster\r\n+        $('#addPaymentModal .bg-light').show();\r\n+        \r\n+        // Mevcut dosya bilgisini gizle\r\n+        $('#currentFileInfo').hide();\r\n+        $('#currentFile').html('');\r\n+        \r\n+        // Arama sonuçlarını temizle\r\n+        $('#aboneNoInput').val('');\r\n+        $('#bayiSearchResult').html('');\r\n+        $('#bayiSelect').val('');\r\n+        \r\n+        // Bugünün tarihini set et\r\n+        $('#addPaymentModal input[name=\"odeme_tarihi\"]').val('<?php echo date('Y-m-d'); ?>');\r\n+    }\r\n+    \r\n+    // Modal açılırken (Yeni Ödeme Ekle butonu)\r\n+    $('button[data-bs-target=\"#addPaymentModal\"]').on('click', function() {\r\n+        resetPaymentModal();\r\n+    });\r\n+    \r\n+    // Modal kapanırken temizle\r\n+    $('#addPaymentModal').on('hidden.bs.modal', function() {\r\n+        resetPaymentModal();\r\n+    });\r\n+    \r\n     // Açıklama karakter sayacı\r\n     $('textarea[name=\"aciklama\"]').on('input', function() {\r\n         const currentLength = $(this).val().length;\r\n         const maxLength = 1500;\r\n@@ -1073,10 +1243,71 @@\n     }\r\n });\r\n \r\n function editPayment(id) {\r\n-    // Düzenleme modal'ını aç\r\n+    // Mevcut modalı düzenleme için hazırla\r\n     console.log('Edit payment:', id);\r\n+    \r\n+    $.ajax({\r\n+        url: '',\r\n+        type: 'POST',\r\n+        data: {\r\n+            action: 'get_payment_details',\r\n+            payment_id: id\r\n+        },\r\n+        dataType: 'json',\r\n+        success: function(response) {\r\n+            if (response && response.success) {\r\n+                const payment = response.data;\r\n+                \r\n+                // Modal başlığını ve buton metnini düzenle moduna çevir\r\n+                $('#paymentModalTitle').html('<i class=\"fas fa-edit me-2\"></i>Ödeme Düzenle');\r\n+                $('#paymentSubmitBtn').html('<i class=\"fas fa-save me-2\"></i>Güncelle');\r\n+                \r\n+                // Hidden payment ID'yi set et\r\n+                $('#paymentId').val(payment.id);\r\n+                \r\n+                // Form alanlarını doldur\r\n+                $('#addPaymentModal select[name=\"user_id\"]').val(payment.user_id);\r\n+                $('#addPaymentModal select[name=\"odeme_turu_id\"]').val(payment.odeme_turu_id);\r\n+                $('#addPaymentModal input[name=\"tutar\"]').val(payment.odeme_tutari);\r\n+                $('#addPaymentModal input[name=\"odeme_tarihi\"]').val(payment.odeme_tarihi);\r\n+                $('#addPaymentModal input[name=\"referans_no\"]').val(payment.referans_no);\r\n+                $('#addPaymentModal textarea[name=\"aciklama\"]').val(payment.aciklama);\r\n+                \r\n+                // Abone no arama alanını gizle (düzenlemede gerek yok)\r\n+                $('#addPaymentModal .bg-light').hide();\r\n+                \r\n+                // Mevcut dosya bilgisini göster\r\n+                const currentFileDiv = $('#currentFile');\r\n+                const currentFileInfo = $('#currentFileInfo');\r\n+                \r\n+                if (payment.evrak_dosya_adi) {\r\n+                    currentFileDiv.html(`\r\n+                        <a href=\"${payment.evrak_dosya_yolu}\" target=\"_blank\" class=\"text-primary\">\r\n+                            <i class=\"fas fa-file-alt me-1\"></i>${payment.evrak_dosya_adi}\r\n+                        </a>\r\n+                        <small class=\"text-muted d-block\">Yeni dosya seçerseniz eskisi değiştirilir</small>\r\n+                    `);\r\n+                    currentFileInfo.show();\r\n+                } else {\r\n+                    currentFileInfo.hide();\r\n+                }\r\n+                \r\n+                // Karakter sayacını güncelle\r\n+                $('textarea[name=\"aciklama\"]').trigger('input');\r\n+                \r\n+                // Modal'ı aç\r\n+                $('#addPaymentModal').modal('show');\r\n+            } else {\r\n+                showAlert('danger', 'Ödeme bilgileri getirilemedi: ' + (response.message || 'Bilinmeyen hata'));\r\n+            }\r\n+        },\r\n+        error: function(xhr, status, error) {\r\n+            console.error('Get payment details error:', error);\r\n+            showAlert('danger', 'Ödeme bilgileri getirilirken hata oluştu: ' + error);\r\n+        }\r\n+    });\r\n }\r\n \r\n function deletePayment(id) {\r\n     if (confirm('Bu ödeme kaydını silmek istediğinizden emin misiniz?')) {\r\n"
                },
                {
                    "date": 1760630070935,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -389,9 +389,9 @@\n                             bho.id,\r\n                             bho.user_id,\r\n                             bho.odeme_turu_id,\r\n                             bho.odeme_tutari,\r\n-                            bho.odeme_tarihi,\r\n+                            CONVERT(varchar(10), bho.odeme_tarihi, 23) as odeme_tarihi,\r\n                             bho.aciklama,\r\n                             bho.referans_no,\r\n                             bho.evrak_dosya_adi,\r\n                             bho.evrak_dosya_yolu,\r\n@@ -1269,12 +1269,23 @@\n                 // Form alanlarını doldur\r\n                 $('#addPaymentModal select[name=\"user_id\"]').val(payment.user_id);\r\n                 $('#addPaymentModal select[name=\"odeme_turu_id\"]').val(payment.odeme_turu_id);\r\n                 $('#addPaymentModal input[name=\"tutar\"]').val(payment.odeme_tutari);\r\n-                $('#addPaymentModal input[name=\"odeme_tarihi\"]').val(payment.odeme_tarihi);\r\n-                $('#addPaymentModal input[name=\"referans_no\"]').val(payment.referans_no);\r\n-                $('#addPaymentModal textarea[name=\"aciklama\"]').val(payment.aciklama);\r\n                 \r\n+                // Ödeme tarihini doğru formatta set et\r\n+                let paymentDate = '';\r\n+                if (payment.odeme_tarihi) {\r\n+                    // SQL Server datetime formatını Y-m-d formatına çevir\r\n+                    const date = new Date(payment.odeme_tarihi);\r\n+                    if (!isNaN(date.getTime())) {\r\n+                        paymentDate = date.toISOString().split('T')[0]; // YYYY-MM-DD formatı\r\n+                    }\r\n+                }\r\n+                $('#addPaymentModal input[name=\"odeme_tarihi\"]').val(paymentDate);\r\n+                \r\n+                $('#addPaymentModal input[name=\"referans_no\"]').val(payment.referans_no || '');\r\n+                $('#addPaymentModal textarea[name=\"aciklama\"]').val(payment.aciklama || '');\r\n+                \r\n                 // Abone no arama alanını gizle (düzenlemede gerek yok)\r\n                 $('#addPaymentModal .bg-light').hide();\r\n                 \r\n                 // Mevcut dosya bilgisini göster\r\n"
                },
                {
                    "date": 1760630283756,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -191,9 +191,9 @@\n                     exit;\r\n                 }\r\n                 \r\n                 // İris rapor tablosunda abone numarasını ara (daha geniş arama)\r\n-                $iris_sql = \"SELECT TOP 1 TALEBI_GIREN_PERSONELNO, DT_MUSTERI_NO, TALEBI_GIREN_PERSONEL_ALTBAYI\r\n+                $iris_sql = \"SELECT TOP 1 TALEBI_GIREN_PERSONELNO, DT_MUSTERI_NO, TALEBI_GIREN_PERSONEL_ALTBAYI, TALEBI_GIREN_PERSONEL\r\n                             FROM digiturk.iris_rapor \r\n                             WHERE DT_MUSTERI_NO LIKE ? \r\n                                OR UYDU_BASVURU_POTANSIYEL_NO LIKE ?\r\n                                OR UYDU_BASVURU_UYE_NO LIKE ?\r\n@@ -259,8 +259,9 @@\n                         'success' => false, \r\n                         'message' => 'Bu personel numarası için bayi bulunamadı',\r\n                         'debug' => [\r\n                             'searched_personel_no' => $personel_no,\r\n+                            'talebi_giren_personel' => $iris_result['TALEBI_GIREN_PERSONEL'] ?? 'N/A',\r\n                             'iris_personel_altbayi' => $iris_result['TALEBI_GIREN_PERSONEL_ALTBAYI'] ?? 'N/A',\r\n                             'found_customer_no' => $iris_result['DT_MUSTERI_NO'] ?? 'N/A',\r\n                             'total_bayi_records' => $all_personel_result['total'],\r\n                             'min_personel_no' => $all_personel_result['min_no'],\r\n@@ -897,8 +898,12 @@\n                         if (response.debug.searched_personel_no) {\r\n                             debugItems.push(`<strong>Aranan Personel No:</strong> ${response.debug.searched_personel_no}`);\r\n                         }\r\n                         \r\n+                        if (response.debug.talebi_giren_personel) {\r\n+                            debugItems.push(`<strong>Talebi Giren Personel:</strong> ${response.debug.talebi_giren_personel}`);\r\n+                        }\r\n+                        \r\n                         if (response.debug.iris_personel_altbayi) {\r\n                             debugItems.push(`<strong>Alt Bayi:</strong> ${response.debug.iris_personel_altbayi}`);\r\n                         }\r\n                         \r\n"
                },
                {
                    "date": 1760682097593,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -139,8 +139,9 @@\n                             ot.ikon,\r\n                             bho.odeme_tutari,\r\n                             bho.odeme_tarihi,\r\n                             bho.aciklama,\r\n+                            bho.referans_no,\r\n                             bho.evrak_dosya_adi,\r\n                             bho.evrak_dosya_yolu,\r\n                             bho.created_at,\r\n                             ISNULL(cb.first_name + ' ' + cb.last_name, 'Sistem') as created_by\r\n@@ -704,16 +705,17 @@\n                             <th>Bayi</th>\r\n                             <th>Ödeme Türü</th>\r\n                             <th>Tutar</th>\r\n                             <th>Tarih</th>\r\n+                            <th>Referans No</th>\r\n                             <th>Evrak</th>\r\n                             <th>Oluşturan</th>\r\n                             <th>İşlemler</th>\r\n                         </tr>\r\n                     </thead>\r\n                     <tbody id=\"paymentsTableBody\">\r\n                         <tr>\r\n-                            <td colspan=\"7\" class=\"text-center py-4\">\r\n+                            <td colspan=\"8\" class=\"text-center py-4\">\r\n                                 <i class=\"fas fa-spinner fa-spin fa-2x text-muted\"></i>\r\n                                 <p class=\"mt-2 text-muted\">Veriler yükleniyor...</p>\r\n                             </td>\r\n                         </tr>\r\n@@ -1175,9 +1177,9 @@\n         \r\n         if (!payments || payments.length === 0) {\r\n             tbody.html(`\r\n                 <tr>\r\n-                    <td colspan=\"7\" class=\"text-center py-4\">\r\n+                    <td colspan=\"8\" class=\"text-center py-4\">\r\n                         <i class=\"fas fa-inbox fa-3x text-muted mb-3 d-block\"></i>\r\n                         <p class=\"text-muted\">Hiç ödeme kaydı bulunamadı</p>\r\n                     </td>\r\n                 </tr>\r\n@@ -1210,8 +1212,11 @@\n                             ₺${parseFloat(payment.odeme_tutari || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}\r\n                         </strong>\r\n                     </td>\r\n                     <td>${payment.odeme_tarihi ? new Date(payment.odeme_tarihi).toLocaleDateString('tr-TR') : 'N/A'}</td>\r\n+                    <td>\r\n+                        <span class=\"text-muted\">${payment.referans_no || '-'}</span>\r\n+                    </td>\r\n                     <td class=\"text-center\">${evrakLink}</td>\r\n                     <td>\r\n                         <small class=\"text-muted\">${payment.created_by || 'N/A'}</small><br>\r\n                         <small class=\"text-muted\">${payment.created_at ? new Date(payment.created_at).toLocaleDateString('tr-TR') : 'N/A'}</small>\r\n"
                },
                {
                    "date": 1760977050911,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,8 +12,12 @@\n require_once 'auth.php';\r\n $currentUser = checkAuth();\r\n checkUserStatus();\r\n \r\n+// Kullanıcının grup bilgisini al\r\n+$userGroupId = $currentUser['group_id'] ?? null;\r\n+$isRestrictedUser = ($userGroupId == 3); // Grup ID 3 olan kullanıcılar kısıtlı\r\n+\r\n // Yetki kontrolü geçici olarak kaldırıldı\r\n // Herhangi bir login olmuş kullanıcı erişebilir\r\n \r\n // Database connection setup\r\n@@ -129,8 +133,13 @@\n                 $odeme_turu = $_POST['odeme_turu'] ?? '';\r\n                 $baslangic_tarih = $_POST['baslangic_tarih'] ?? '';\r\n                 $bitis_tarih = $_POST['bitis_tarih'] ?? '';\r\n                 \r\n+                // Kısıtlı kullanıcı ise sadece kendi kayıtlarını göster\r\n+                if ($isRestrictedUser) {\r\n+                    $bayi_id = $currentUser['id'];\r\n+                }\r\n+                \r\n                 $sql = \"SELECT \r\n                             bho.id,\r\n                             u.first_name + ' ' + u.last_name as bayi_adi,\r\n                             u.email as bayi_email,\r\n@@ -513,32 +522,33 @@\n     $group_check_stmt->execute();\r\n     $groups = $group_check_stmt->fetchAll(PDO::FETCH_ASSOC);\r\n     error_log(\"Mevcut gruplar: \" . json_encode($groups));\r\n     \r\n-    $bayiler_sql = \"SELECT u.id, u.first_name + ' ' + u.last_name as name, u.email,\r\n-                           ug.group_name\r\n-                    FROM users u \r\n-                    LEFT JOIN user_groups ug ON u.user_group_id = ug.id \r\n-                    WHERE u.status = 'AKTIF' \r\n-                    ORDER BY u.first_name, u.last_name\";\r\n-    $bayiler_stmt = $conn->prepare($bayiler_sql);\r\n-    $bayiler_stmt->execute();\r\n-    $all_users = $bayiler_stmt->fetchAll(PDO::FETCH_ASSOC);\r\n-    error_log(\"Tüm aktif kullanıcılar: \" . json_encode($all_users));\r\n-    \r\n-    // Sadece bayi gruplu olanları filtrele\r\n-    $bayiler = array_filter($all_users, function($user) {\r\n-        return $user['group_name'] === 'bayi';\r\n-    });\r\n-    \r\n-    // Eğer bayi bulunamazsa tüm aktif kullanıcıları göster\r\n-    if (empty($bayiler)) {\r\n-        $bayiler = $all_users;\r\n-        error_log(\"Bayi grubu bulunamadı, tüm aktif kullanıcılar gösteriliyor\");\r\n+    // Eğer kullanıcı grup 3 ise, sadece kendi kaydını getir\r\n+    if ($isRestrictedUser) {\r\n+        $bayiler_sql = \"SELECT u.id, u.first_name + ' ' + u.last_name as name, u.email,\r\n+                               ug.group_name\r\n+                        FROM users u \r\n+                        LEFT JOIN user_groups ug ON u.user_group_id = ug.id \r\n+                        WHERE u.status = 'AKTIF' AND u.id = ?\r\n+                        ORDER BY u.first_name, u.last_name\";\r\n+        $bayiler_stmt = $conn->prepare($bayiler_sql);\r\n+        $bayiler_stmt->execute([$currentUser['id']]);\r\n+        $bayiler = $bayiler_stmt->fetchAll(PDO::FETCH_ASSOC);\r\n     } else {\r\n-        error_log(\"Bulunan bayiler: \" . count($bayiler));\r\n+        $bayiler_sql = \"SELECT u.id, u.first_name + ' ' + u.last_name as name, u.email,\r\n+                               ug.group_name\r\n+                        FROM users u \r\n+                        LEFT JOIN user_groups ug ON u.user_group_id = ug.id \r\n+                        WHERE u.status = 'AKTIF' \r\n+                        ORDER BY u.first_name, u.last_name\";\r\n+        $bayiler_stmt = $conn->prepare($bayiler_sql);\r\n+        $bayiler_stmt->execute();\r\n+        $bayiler = $bayiler_stmt->fetchAll(PDO::FETCH_ASSOC);\r\n     }\r\n     \r\n+    error_log(\"Bulunan bayiler: \" . count($bayiler));\r\n+    \r\n     // Ödeme türlerini getir\r\n     $odeme_turleri_sql = \"SELECT * FROM odeme_turleri WHERE aktif = 1 ORDER BY tur_adi\";\r\n     $odeme_turleri_stmt = $conn->prepare($odeme_turleri_sql);\r\n     $odeme_turleri_stmt->execute();\r\n@@ -650,14 +660,23 @@\n             <form id=\"filterForm\">\r\n                 <div class=\"row g-3\">\r\n                     <div class=\"col-md-3\">\r\n                         <label class=\"form-label\">Bayi</label>\r\n-                        <select class=\"form-select\" name=\"bayi_id\">\r\n+                        <select class=\"form-select\" name=\"bayi_id\" <?php echo $isRestrictedUser ? 'disabled' : ''; ?>>\r\n                             <option value=\"\">Tüm Bayiler</option>\r\n                             <?php foreach ($bayiler as $bayi): ?>\r\n-                                <option value=\"<?php echo $bayi['id']; ?>\"><?php echo htmlspecialchars($bayi['name']); ?></option>\r\n+                                <option value=\"<?php echo $bayi['id']; ?>\" <?php echo $isRestrictedUser ? 'selected' : ''; ?>>\r\n+                                    <?php echo htmlspecialchars($bayi['name']); ?>\r\n+                                </option>\r\n                             <?php endforeach; ?>\r\n                         </select>\r\n+                        <?php if ($isRestrictedUser): ?>\r\n+                            <!-- Kısıtlı kullanıcı için hidden input ile değeri gönder -->\r\n+                            <input type=\"hidden\" name=\"bayi_id\" value=\"<?php echo htmlspecialchars($currentUser['id']); ?>\">\r\n+                            <small class=\"text-muted\">\r\n+                                <i class=\"fas fa-info-circle\"></i> Sadece kendi kayıtlarınızı görüntüleyebilirsiniz\r\n+                            </small>\r\n+                        <?php endif; ?>\r\n                     </div>\r\n                     <div class=\"col-md-3\">\r\n                         <label class=\"form-label\">Ödeme Türü</label>\r\n                         <select class=\"form-select\" name=\"odeme_turu\">\r\n@@ -739,8 +758,9 @@\n             <form id=\"addPaymentForm\" enctype=\"multipart/form-data\">\r\n                 <input type=\"hidden\" id=\"paymentId\" name=\"payment_id\" value=\"\">\r\n                 <div class=\"modal-body\">\r\n                     <!-- Abone No ile Bayi Arama -->\r\n+                    <?php if (!$isRestrictedUser): ?>\r\n                     <div class=\"card mb-3 bg-light\">\r\n                         <div class=\"card-body\">\r\n                             <h6 class=\"card-title text-primary\">\r\n                                 <i class=\"fas fa-search me-2\"></i>Abone No ile Bayi Bul\r\n@@ -757,22 +777,32 @@\n                             </div>\r\n                             <div id=\"bayiSearchResult\" class=\"mt-2\"></div>\r\n                         </div>\r\n                     </div>\r\n+                    <?php endif; ?>\r\n                     \r\n                     <div class=\"row g-3\">\r\n                         <div class=\"col-md-6\">\r\n                             <label class=\"form-label\">Bayi <span class=\"text-danger\">*</span></label>\r\n-                            <select class=\"form-select\" name=\"user_id\" id=\"bayiSelect\" required>\r\n+                            <select class=\"form-select\" name=\"user_id\" id=\"bayiSelect\" required <?php echo $isRestrictedUser ? 'disabled' : ''; ?>>\r\n                                 <option value=\"\">Bayi Seçin (<?php echo count($bayiler); ?> adet)</option>\r\n                                 <?php if (empty($bayiler)): ?>\r\n                                     <option value=\"\" disabled>Hiç bayi bulunamadı</option>\r\n                                 <?php else: ?>\r\n                                     <?php foreach ($bayiler as $bayi): ?>\r\n-                                        <option value=\"<?php echo $bayi['id']; ?>\"><?php echo htmlspecialchars($bayi['name']); ?> (Grup: <?php echo $bayi['group_name'] ?? 'Yok'; ?>)</option>\r\n+                                        <option value=\"<?php echo $bayi['id']; ?>\" <?php echo $isRestrictedUser ? 'selected' : ''; ?>>\r\n+                                            <?php echo htmlspecialchars($bayi['name']); ?> (Grup: <?php echo $bayi['group_name'] ?? 'Yok'; ?>)\r\n+                                        </option>\r\n                                     <?php endforeach; ?>\r\n                                 <?php endif; ?>\r\n                             </select>\r\n+                            <?php if ($isRestrictedUser): ?>\r\n+                                <!-- Kısıtlı kullanıcı için hidden input ile değeri gönder -->\r\n+                                <input type=\"hidden\" name=\"user_id\" value=\"<?php echo htmlspecialchars($currentUser['id']); ?>\">\r\n+                                <small class=\"text-muted\">\r\n+                                    <i class=\"fas fa-info-circle\"></i> Sadece kendi kayıtlarınızı görüntüleyebilirsiniz\r\n+                                </small>\r\n+                            <?php endif; ?>\r\n                         </div>\r\n                         <div class=\"col-md-6\">\r\n                             <label class=\"form-label\">Ödeme Türü <span class=\"text-danger\">*</span></label>\r\n                             <select class=\"form-select\" name=\"odeme_turu_id\" required>\r\n"
                }
            ],
            "date": 1758977964930,
            "name": "Commit-0",
            "content": "<?php\r\nerror_reporting(E_ALL);\r\nini_set('display_errors', 1);\r\n\r\n$pageTitle = \"Bayi Ödeme Yönetimi\";\r\n$breadcrumbs = [\r\n    ['title' => 'Ana Sayfa', 'url' => 'index.php'],\r\n    ['title' => 'Bayi Ödeme Yönetimi']\r\n];\r\n\r\n// Auth kontrol\r\nrequire_once 'auth.php';\r\n$currentUser = checkAuth();\r\ncheckUserStatus();\r\n\r\n// Admin kontrolü\r\nif ($currentUser['group_name'] !== 'admin') {\r\n    header('Location: index.php?error=Yetkisiz erişim');\r\n    exit;\r\n}\r\n\r\nrequire_once 'MSSQLConnection.php';\r\n\r\ntry {\r\n    $db = new MSSQLConnection();\r\n    $conn = $db->getConnection();\r\n    \r\n    // Tablolar mevcut mu kontrol et ve oluştur\r\n    try {\r\n        $sql_content = file_get_contents(__DIR__ . '/create_odeme_tables.sql');\r\n        if ($sql_content) {\r\n            $conn->exec($sql_content);\r\n        }\r\n    } catch (Exception $e) {\r\n        // Tablo oluşturma hatası - log'la ama devam et\r\n        error_log(\"Tablo oluşturma hatası: \" . $e->getMessage());\r\n    }\r\n    \r\n    // AJAX isteği kontrolü\r\n    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {\r\n        header('Content-Type: application/json');\r\n        \r\n        try {\r\n            $action = $_POST['action'];\r\n            \r\n            if ($action === 'get_payments') {\r\n            // Ödemeleri getir\r\n            $bayi_id = $_POST['bayi_id'] ?? '';\r\n            $odeme_turu = $_POST['odeme_turu'] ?? '';\r\n            $baslangic_tarih = $_POST['baslangic_tarih'] ?? '';\r\n            $bitis_tarih = $_POST['bitis_tarih'] ?? '';\r\n            $durum = $_POST['durum'] ?? '';\r\n            \r\n            // Önce basit test - tablolar var mı?\r\n            try {\r\n                $test_sql = \"SELECT COUNT(*) as count FROM odeme_turleri\";\r\n                $test_stmt = $conn->prepare($test_sql);\r\n                $test_stmt->execute();\r\n                $tur_count = $test_stmt->fetchColumn();\r\n                \r\n                $test_sql2 = \"SELECT COUNT(*) as count FROM users u INNER JOIN user_groups ug ON u.user_group_id = ug.id WHERE ug.group_name = 'bayi'\";\r\n                $test_stmt2 = $conn->prepare($test_sql2);\r\n                $test_stmt2->execute();\r\n                $bayi_count = $test_stmt2->fetchColumn();\r\n                \r\n            } catch (Exception $e) {\r\n                echo json_encode([\r\n                    'success' => false, \r\n                    'message' => 'Tablo kontrolü hatası: ' . $e->getMessage()\r\n                ]);\r\n                exit;\r\n            }\r\n            \r\n            $sql = \"SELECT \r\n                        bo.id,\r\n                        u.name as bayi_adi,\r\n                        u.email as bayi_email,\r\n                        ot.tur_adi,\r\n                        ot.renk_kodu,\r\n                        ot.ikon,\r\n                        bo.tutar,\r\n                        bo.odeme_tarihi,\r\n                        bo.aciklama,\r\n                        bo.referans_no,\r\n                        bo.durum,\r\n                        bo.dekont_dosya_adi,\r\n                        bo.created_at\r\n                    FROM bayi_odemeleri bo\r\n                    INNER JOIN users u ON bo.user_id = u.id\r\n                    INNER JOIN odeme_turleri ot ON bo.odeme_turu_id = ot.id\r\n                    WHERE 1=1\";\r\n            \r\n            $params = [];\r\n            \r\n            if ($bayi_id) {\r\n                $sql .= \" AND bo.user_id = ?\";\r\n                $params[] = $bayi_id;\r\n            }\r\n            \r\n            if ($odeme_turu) {\r\n                $sql .= \" AND bo.odeme_turu_id = ?\";\r\n                $params[] = $odeme_turu;\r\n            }\r\n            \r\n            if ($baslangic_tarih) {\r\n                $sql .= \" AND bo.odeme_tarihi >= ?\";\r\n                $params[] = $baslangic_tarih;\r\n            }\r\n            \r\n            if ($bitis_tarih) {\r\n                $sql .= \" AND bo.odeme_tarihi <= ?\";\r\n                $params[] = $bitis_tarih;\r\n            }\r\n            \r\n            if ($durum) {\r\n                $sql .= \" AND bo.durum = ?\";\r\n                $params[] = $durum;\r\n            }\r\n            \r\n            $sql .= \" ORDER BY bo.created_at DESC\";\r\n            \r\n            $stmt = $conn->prepare($sql);\r\n            $stmt->execute($params);\r\n            $payments = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n            \r\n            echo json_encode(['success' => true, 'data' => $payments]);\r\n            exit;\r\n        }\r\n        \r\n        if ($action === 'add_payment') {\r\n            // Yeni ödeme ekle\r\n            $user_id = $_POST['user_id'];\r\n            $odeme_turu_id = $_POST['odeme_turu_id'];\r\n            $tutar = $_POST['tutar'];\r\n            $odeme_tarihi = $_POST['odeme_tarihi'];\r\n            $aciklama = $_POST['aciklama'] ?? '';\r\n            $referans_no = $_POST['referans_no'] ?? '';\r\n            \r\n            // Dosya yükleme işlemi\r\n            $dekont_dosya_adi = null;\r\n            $dosya_yolu = null;\r\n            $dosya_boyutu = null;\r\n            $dosya_tipi = null;\r\n            \r\n            if (isset($_FILES['dekont_dosya']) && $_FILES['dekont_dosya']['error'] === UPLOAD_ERR_OK) {\r\n                $upload_dir = __DIR__ . '/uploads/dekontlar/';\r\n                if (!is_dir($upload_dir)) {\r\n                    mkdir($upload_dir, 0755, true);\r\n                }\r\n                \r\n                $file_info = pathinfo($_FILES['dekont_dosya']['name']);\r\n                $extension = strtolower($file_info['extension']);\r\n                $allowed_extensions = ['pdf', 'jpg', 'jpeg', 'png', 'doc', 'docx'];\r\n                \r\n                if (in_array($extension, $allowed_extensions)) {\r\n                    $unique_name = 'dekont_' . date('Y-m-d_H-i-s') . '_' . uniqid() . '.' . $extension;\r\n                    $upload_path = $upload_dir . $unique_name;\r\n                    \r\n                    if (move_uploaded_file($_FILES['dekont_dosya']['tmp_name'], $upload_path)) {\r\n                        $dekont_dosya_adi = $_FILES['dekont_dosya']['name'];\r\n                        $dosya_yolu = 'uploads/dekontlar/' . $unique_name;\r\n                        $dosya_boyutu = $_FILES['dekont_dosya']['size'];\r\n                        $dosya_tipi = $extension;\r\n                    }\r\n                }\r\n            }\r\n            \r\n            $sql = \"INSERT INTO bayi_odemeleri (\r\n                        user_id, odeme_turu_id, tutar, odeme_tarihi, aciklama, \r\n                        referans_no, olusturan_kullanici, dekont_dosya_adi, \r\n                        dosya_yolu, dosya_boyutu, dosya_tipi\r\n                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\";\r\n            \r\n            $stmt = $conn->prepare($sql);\r\n            $result = $stmt->execute([\r\n                $user_id, $odeme_turu_id, $tutar, $odeme_tarihi, $aciklama,\r\n                $referans_no, $currentUser['name'], $dekont_dosya_adi,\r\n                $dosya_yolu, $dosya_boyutu, $dosya_tipi\r\n            ]);\r\n            \r\n            if ($result) {\r\n                // Log kaydı - SQL Server için SCOPE_IDENTITY() kullan\r\n                $odeme_id_result = $conn->query(\"SELECT SCOPE_IDENTITY() as id\");\r\n                $odeme_id = $odeme_id_result->fetchColumn();\r\n                \r\n                if ($odeme_id) {\r\n                    $log_sql = \"INSERT INTO odeme_logları (odeme_id, islem_tipi, yeni_durum, kullanici, aciklama) \r\n                               VALUES (?, 'OLUSTURULDU', 'BEKLEMEDE', ?, 'Ödeme kaydı oluşturuldu')\";\r\n                    $conn->prepare($log_sql)->execute([$odeme_id, $currentUser['name']]);\r\n                }\r\n                \r\n                echo json_encode(['success' => true, 'message' => 'Ödeme kaydı başarıyla eklendi']);\r\n            } else {\r\n                echo json_encode(['success' => false, 'message' => 'Ödeme kaydı eklenirken hata oluştu']);\r\n            }\r\n            \r\n        } catch (Exception $e) {\r\n            echo json_encode([\r\n                'success' => false, \r\n                'message' => 'Hata: ' . $e->getMessage()\r\n            ]);\r\n        }\r\n        exit;\r\n    }\r\n    \r\n    // Bayileri getir (users tablosundan user_groups ile)\r\n    $bayiler_sql = \"SELECT u.id, u.first_name + ' ' + u.last_name as name, u.email \r\n                    FROM users u \r\n                    INNER JOIN user_groups ug ON u.user_group_id = ug.id \r\n                    WHERE ug.group_name = 'bayi' AND u.status = 'AKTIF' \r\n                    ORDER BY u.first_name, u.last_name\";\r\n    $bayiler_stmt = $conn->prepare($bayiler_sql);\r\n    $bayiler_stmt->execute();\r\n    $bayiler = $bayiler_stmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    // Ödeme türlerini getir\r\n    $odeme_turleri_sql = \"SELECT * FROM odeme_turleri WHERE aktif = 1 ORDER BY tur_adi\";\r\n    $odeme_turleri_stmt = $conn->prepare($odeme_turleri_sql);\r\n    $odeme_turleri_stmt->execute();\r\n    $odeme_turleri = $odeme_turleri_stmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    // Özet istatistikleri\r\n    $stats_sql = \"SELECT \r\n                    COUNT(*) as toplam_islem,\r\n                    SUM(CASE WHEN tutar > 0 THEN tutar ELSE 0 END) as toplam_odeme,\r\n                    SUM(CASE WHEN tutar < 0 THEN ABS(tutar) ELSE 0 END) as toplam_kesinti,\r\n                    COUNT(CASE WHEN durum = 'BEKLEMEDE' THEN 1 END) as bekleyen_islem\r\n                  FROM bayi_odemeleri\";\r\n    $stats_stmt = $conn->prepare($stats_sql);\r\n    $stats_stmt->execute();\r\n    $stats = $stats_stmt->fetch(PDO::FETCH_ASSOC);\r\n    \r\n} catch (Exception $e) {\r\n    $error = \"Veritabanı hatası: \" . $e->getMessage();\r\n}\r\n\r\ninclude 'includes/header.php';\r\n?>\r\n\r\n<div class=\"container-fluid mt-4\">\r\n    <div class=\"row\">\r\n        <div class=\"col-12\">\r\n            <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n                <h2>\r\n                    <i class=\"fas fa-money-bill-wave text-success me-2\"></i>\r\n                    Bayi Ödeme Yönetimi\r\n                </h2>\r\n                <button class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#addPaymentModal\">\r\n                    <i class=\"fas fa-plus me-2\"></i>Yeni Ödeme Ekle\r\n                </button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- İstatistik Kartları -->\r\n    <div class=\"row mb-4\">\r\n        <div class=\"col-md-3\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-body text-center\">\r\n                    <div class=\"text-primary mb-3\">\r\n                        <i class=\"fas fa-list-ol fa-3x\"></i>\r\n                    </div>\r\n                    <h3 class=\"text-primary\"><?php echo number_format($stats['toplam_islem'] ?? 0); ?></h3>\r\n                    <p class=\"text-muted mb-0\">Toplam İşlem</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        \r\n        <div class=\"col-md-3\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-body text-center\">\r\n                    <div class=\"text-success mb-3\">\r\n                        <i class=\"fas fa-hand-holding-usd fa-3x\"></i>\r\n                    </div>\r\n                    <h3 class=\"text-success\">₺<?php echo number_format($stats['toplam_odeme'] ?? 0, 2); ?></h3>\r\n                    <p class=\"text-muted mb-0\">Toplam Ödeme</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        \r\n        <div class=\"col-md-3\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-body text-center\">\r\n                    <div class=\"text-danger mb-3\">\r\n                        <i class=\"fas fa-minus-circle fa-3x\"></i>\r\n                    </div>\r\n                    <h3 class=\"text-danger\">₺<?php echo number_format($stats['toplam_kesinti'] ?? 0, 2); ?></h3>\r\n                    <p class=\"text-muted mb-0\">Toplam Kesinti</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        \r\n        <div class=\"col-md-3\">\r\n            <div class=\"card border-0 shadow-sm\">\r\n                <div class=\"card-body text-center\">\r\n                    <div class=\"text-warning mb-3\">\r\n                        <i class=\"fas fa-clock fa-3x\"></i>\r\n                    </div>\r\n                    <h3 class=\"text-warning\"><?php echo number_format($stats['bekleyen_islem'] ?? 0); ?></h3>\r\n                    <p class=\"text-muted mb-0\">Bekleyen İşlem</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Filtreler -->\r\n    <div class=\"card mb-4\">\r\n        <div class=\"card-header\">\r\n            <h5 class=\"mb-0\">\r\n                <i class=\"fas fa-filter me-2\"></i>Filtreler\r\n            </h5>\r\n        </div>\r\n        <div class=\"card-body\">\r\n            <form id=\"filterForm\">\r\n                <div class=\"row g-3\">\r\n                    <div class=\"col-md-3\">\r\n                        <label class=\"form-label\">Bayi</label>\r\n                        <select class=\"form-select\" name=\"bayi_id\">\r\n                            <option value=\"\">Tüm Bayiler</option>\r\n                            <?php foreach ($bayiler as $bayi): ?>\r\n                                <option value=\"<?php echo $bayi['id']; ?>\"><?php echo htmlspecialchars($bayi['name']); ?></option>\r\n                            <?php endforeach; ?>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"col-md-3\">\r\n                        <label class=\"form-label\">Ödeme Türü</label>\r\n                        <select class=\"form-select\" name=\"odeme_turu\">\r\n                            <option value=\"\">Tüm Türler</option>\r\n                            <?php foreach ($odeme_turleri as $tur): ?>\r\n                                <option value=\"<?php echo $tur['id']; ?>\"><?php echo htmlspecialchars($tur['tur_adi']); ?></option>\r\n                            <?php endforeach; ?>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"col-md-2\">\r\n                        <label class=\"form-label\">Başlangıç Tarihi</label>\r\n                        <input type=\"date\" class=\"form-control\" name=\"baslangic_tarih\">\r\n                    </div>\r\n                    <div class=\"col-md-2\">\r\n                        <label class=\"form-label\">Bitiş Tarihi</label>\r\n                        <input type=\"date\" class=\"form-control\" name=\"bitis_tarih\">\r\n                    </div>\r\n                    <div class=\"col-md-2\">\r\n                        <label class=\"form-label\">Durum</label>\r\n                        <select class=\"form-select\" name=\"durum\">\r\n                            <option value=\"\">Tüm Durumlar</option>\r\n                            <option value=\"BEKLEMEDE\">Beklemede</option>\r\n                            <option value=\"ONAYLANDI\">Onaylandı</option>\r\n                            <option value=\"ODENDI\">Ödendi</option>\r\n                            <option value=\"IPTAL\">İptal</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n                <div class=\"row mt-3\">\r\n                    <div class=\"col-12\">\r\n                        <button type=\"submit\" class=\"btn btn-primary\">\r\n                            <i class=\"fas fa-search me-2\"></i>Filtrele\r\n                        </button>\r\n                        <button type=\"reset\" class=\"btn btn-secondary ms-2\">\r\n                            <i class=\"fas fa-times me-2\"></i>Temizle\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Ödeme Listesi -->\r\n    <div class=\"card\">\r\n        <div class=\"card-header\">\r\n            <h5 class=\"mb-0\">\r\n                <i class=\"fas fa-list me-2\"></i>Ödeme Listesi\r\n            </h5>\r\n        </div>\r\n        <div class=\"card-body\">\r\n            <div class=\"table-responsive\">\r\n                <table class=\"table table-hover\" id=\"paymentsTable\">\r\n                    <thead class=\"table-dark\">\r\n                        <tr>\r\n                            <th>Bayi</th>\r\n                            <th>Ödeme Türü</th>\r\n                            <th>Tutar</th>\r\n                            <th>Tarih</th>\r\n                            <th>Referans No</th>\r\n                            <th>Durum</th>\r\n                            <th>Dekont</th>\r\n                            <th>İşlemler</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody id=\"paymentsTableBody\">\r\n                        <tr>\r\n                            <td colspan=\"8\" class=\"text-center py-4\">\r\n                                <i class=\"fas fa-spinner fa-spin fa-2x text-muted\"></i>\r\n                                <p class=\"mt-2 text-muted\">Veriler yükleniyor...</p>\r\n                            </td>\r\n                        </tr>\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<!-- Yeni Ödeme Modal -->\r\n<div class=\"modal fade\" id=\"addPaymentModal\" tabindex=\"-1\">\r\n    <div class=\"modal-dialog modal-lg\">\r\n        <div class=\"modal-content\">\r\n            <div class=\"modal-header\">\r\n                <h5 class=\"modal-title\">\r\n                    <i class=\"fas fa-plus me-2\"></i>Yeni Ödeme Ekle\r\n                </h5>\r\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\r\n            </div>\r\n            <form id=\"addPaymentForm\" enctype=\"multipart/form-data\">\r\n                <div class=\"modal-body\">\r\n                    <div class=\"row g-3\">\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label\">Bayi <span class=\"text-danger\">*</span></label>\r\n                            <select class=\"form-select\" name=\"user_id\" required>\r\n                                <option value=\"\">Bayi Seçin</option>\r\n                                <?php foreach ($bayiler as $bayi): ?>\r\n                                    <option value=\"<?php echo $bayi['id']; ?>\"><?php echo htmlspecialchars($bayi['name']); ?></option>\r\n                                <?php endforeach; ?>\r\n                            </select>\r\n                        </div>\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label\">Ödeme Türü <span class=\"text-danger\">*</span></label>\r\n                            <select class=\"form-select\" name=\"odeme_turu_id\" required>\r\n                                <option value=\"\">Ödeme Türü Seçin</option>\r\n                                <?php foreach ($odeme_turleri as $tur): ?>\r\n                                    <option value=\"<?php echo $tur['id']; ?>\" data-color=\"<?php echo $tur['renk_kodu']; ?>\">\r\n                                        <?php echo htmlspecialchars($tur['tur_adi']); ?>\r\n                                    </option>\r\n                                <?php endforeach; ?>\r\n                            </select>\r\n                        </div>\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label\">Tutar (₺) <span class=\"text-danger\">*</span></label>\r\n                            <input type=\"number\" step=\"0.01\" class=\"form-control\" name=\"tutar\" required>\r\n                            <div class=\"form-text\">Kesinti için negatif (-) değer giriniz</div>\r\n                        </div>\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label\">Ödeme Tarihi <span class=\"text-danger\">*</span></label>\r\n                            <input type=\"date\" class=\"form-control\" name=\"odeme_tarihi\" value=\"<?php echo date('Y-m-d'); ?>\" required>\r\n                        </div>\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label\">Referans No</label>\r\n                            <input type=\"text\" class=\"form-control\" name=\"referans_no\" placeholder=\"Fiş no, dekont no vb.\">\r\n                        </div>\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label\">Dekont/Belge</label>\r\n                            <input type=\"file\" class=\"form-control\" name=\"dekont_dosya\" accept=\".pdf,.jpg,.jpeg,.png,.doc,.docx\">\r\n                            <div class=\"form-text\">PDF, JPG, PNG, DOC dosyaları desteklenmektedir</div>\r\n                        </div>\r\n                        <div class=\"col-12\">\r\n                            <label class=\"form-label\">Açıklama</label>\r\n                            <textarea class=\"form-control\" name=\"aciklama\" rows=\"3\" placeholder=\"Ödeme ile ilgili açıklama...\"></textarea>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">İptal</button>\r\n                    <button type=\"submit\" class=\"btn btn-primary\">\r\n                        <i class=\"fas fa-save me-2\"></i>Kaydet\r\n                    </button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<script>\r\n$(document).ready(function() {\r\n    // Sayfa yüklendiğinde ödemeleri getir\r\n    loadPayments();\r\n    \r\n    // Filtre formu submit\r\n    $('#filterForm').on('submit', function(e) {\r\n        e.preventDefault();\r\n        loadPayments();\r\n    });\r\n    \r\n    // Filtre sıfırlama\r\n    $('#filterForm').on('reset', function() {\r\n        setTimeout(loadPayments, 100);\r\n    });\r\n    \r\n    // Yeni ödeme formu submit\r\n    $('#addPaymentForm').on('submit', function(e) {\r\n        e.preventDefault();\r\n        \r\n        const formData = new FormData(this);\r\n        formData.append('action', 'add_payment');\r\n        \r\n        $.ajax({\r\n            url: '',\r\n            type: 'POST',\r\n            data: formData,\r\n            processData: false,\r\n            contentType: false,\r\n            success: function(response) {\r\n                if (response.success) {\r\n                    $('#addPaymentModal').modal('hide');\r\n                    $('#addPaymentForm')[0].reset();\r\n                    loadPayments();\r\n                    \r\n                    // Başarı mesajı göster\r\n                    showAlert('success', response.message);\r\n                } else {\r\n                    showAlert('danger', response.message);\r\n                }\r\n            },\r\n            error: function() {\r\n                showAlert('danger', 'İşlem sırasında bir hata oluştu');\r\n            }\r\n        });\r\n    });\r\n    \r\n    function loadPayments() {\r\n        const formData = new FormData($('#filterForm')[0]);\r\n        formData.append('action', 'get_payments');\r\n        \r\n        console.log('Loading payments...');\r\n        \r\n        $.ajax({\r\n            url: '',\r\n            type: 'POST',\r\n            data: formData,\r\n            processData: false,\r\n            contentType: false,\r\n            dataType: 'json',\r\n            success: function(response) {\r\n                console.log('Load payments response:', response);\r\n                if (response.success) {\r\n                    displayPayments(response.data);\r\n                } else {\r\n                    showAlert('danger', 'Veriler yüklenirken hata oluştu: ' + (response.message || 'Bilinmeyen hata'));\r\n                    console.error('Response error:', response);\r\n                }\r\n            },\r\n            error: function(xhr, status, error) {\r\n                console.error('AJAX Error:', xhr.responseText);\r\n                showAlert('danger', 'Veriler yüklenirken hata oluştu: ' + error);\r\n                \r\n                // Hata durumunda boş tablo göster\r\n                displayPayments([]);\r\n            }\r\n        });\r\n    }\r\n    \r\n    function displayPayments(payments) {\r\n        const tbody = $('#paymentsTableBody');\r\n        tbody.empty();\r\n        \r\n        if (payments.length === 0) {\r\n            tbody.html(`\r\n                <tr>\r\n                    <td colspan=\"8\" class=\"text-center py-4\">\r\n                        <i class=\"fas fa-inbox fa-3x text-muted mb-3 d-block\"></i>\r\n                        <p class=\"text-muted\">Hiç ödeme kaydı bulunamadı</p>\r\n                    </td>\r\n                </tr>\r\n            `);\r\n            return;\r\n        }\r\n        \r\n        payments.forEach(function(payment) {\r\n            const statusBadge = getStatusBadge(payment.durum);\r\n            const dekontLink = payment.dekont_dosya_adi ? \r\n                `<a href=\"${payment.dosya_yolu}\" target=\"_blank\" class=\"btn btn-sm btn-outline-info\">\r\n                    <i class=\"fas fa-file-alt\"></i>\r\n                </a>` : '<span class=\"text-muted\">-</span>';\r\n            \r\n            const row = `\r\n                <tr>\r\n                    <td>\r\n                        <div>\r\n                            <strong>${payment.bayi_adi}</strong><br>\r\n                            <small class=\"text-muted\">${payment.bayi_email}</small>\r\n                        </div>\r\n                    </td>\r\n                    <td>\r\n                        <span class=\"badge\" style=\"background-color: ${payment.renk_kodu}\">\r\n                            <i class=\"fas ${payment.ikon} me-1\"></i>\r\n                            ${payment.tur_adi}\r\n                        </span>\r\n                    </td>\r\n                    <td>\r\n                        <strong class=\"${payment.tutar >= 0 ? 'text-success' : 'text-danger'}\">\r\n                            ₺${parseFloat(payment.tutar).toLocaleString('tr-TR', {minimumFractionDigits: 2})}\r\n                        </strong>\r\n                    </td>\r\n                    <td>${new Date(payment.odeme_tarihi).toLocaleDateString('tr-TR')}</td>\r\n                    <td>${payment.referans_no || '-'}</td>\r\n                    <td>${statusBadge}</td>\r\n                    <td class=\"text-center\">${dekontLink}</td>\r\n                    <td>\r\n                        <div class=\"btn-group\" role=\"group\">\r\n                            <button class=\"btn btn-sm btn-outline-primary\" onclick=\"editPayment(${payment.id})\">\r\n                                <i class=\"fas fa-edit\"></i>\r\n                            </button>\r\n                            <button class=\"btn btn-sm btn-outline-danger\" onclick=\"deletePayment(${payment.id})\">\r\n                                <i class=\"fas fa-trash\"></i>\r\n                            </button>\r\n                        </div>\r\n                    </td>\r\n                </tr>\r\n            `;\r\n            tbody.append(row);\r\n        });\r\n    }\r\n    \r\n    function getStatusBadge(status) {\r\n        const badges = {\r\n            'BEKLEMEDE': '<span class=\"badge bg-warning\">Beklemede</span>',\r\n            'ONAYLANDI': '<span class=\"badge bg-info\">Onaylandı</span>',\r\n            'ODENDI': '<span class=\"badge bg-success\">Ödendi</span>',\r\n            'IPTAL': '<span class=\"badge bg-danger\">İptal</span>'\r\n        };\r\n        return badges[status] || '<span class=\"badge bg-secondary\">Bilinmeyen</span>';\r\n    }\r\n    \r\n    function showAlert(type, message) {\r\n        const alert = `\r\n            <div class=\"alert alert-${type} alert-dismissible fade show\" role=\"alert\">\r\n                ${message}\r\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\r\n            </div>\r\n        `;\r\n        $('.container-fluid').prepend(alert);\r\n        \r\n        // 5 saniye sonra otomatik kapat\r\n        setTimeout(function() {\r\n            $('.alert').fadeOut();\r\n        }, 5000);\r\n    }\r\n});\r\n\r\nfunction editPayment(id) {\r\n    // Düzenleme modal'ını aç\r\n    console.log('Edit payment:', id);\r\n}\r\n\r\nfunction deletePayment(id) {\r\n    if (confirm('Bu ödeme kaydını silmek istediğinizden emin misiniz?')) {\r\n        // Silme işlemi\r\n        console.log('Delete payment:', id);\r\n    }\r\n}\r\n</script>\r\n\r\n<?php include 'includes/footer.php'; ?>\r\n"
        }
    ]
}